---
description: Questo articolo contiene informazioni sulla gestione dei riferimenti ai thread usando le funzioni delle funzioni di utilità della shell Lightweight.
ms.assetid: d8d479fd-c45a-4dfa-b496-76abc7c09a42
title: Gestione dei riferimenti ai thread
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b629cd97c99e3b30e66810b5f54720d0dbb1c87d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "104979991"
---
# <a name="managing-thread-references"></a><span data-ttu-id="ed2e7-103">Gestione dei riferimenti ai thread</span><span class="sxs-lookup"><span data-stu-id="ed2e7-103">Managing Thread References</span></span>

<span data-ttu-id="ed2e7-104">Questo articolo contiene informazioni sulla gestione dei riferimenti ai thread usando le funzioni delle funzioni di utilità della shell Lightweight.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-104">This article contains information about the management of thread references using functions from the Shell lightweight utility functions.</span></span>


<span data-ttu-id="ed2e7-105">Si verificano situazioni in cui un thread padre deve essere mantenuto attivo per la durata di un thread figlio.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-105">Situations arise when a parent thread must be kept active for the lifetime of a child thread.</span></span> <span data-ttu-id="ed2e7-106">Se, ad esempio, un oggetto Component Object Model (COM) viene creato nel thread padre ed eseguito il marshalling al thread figlio, il thread padre non può terminare prima del thread figlio.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-106">For instance, if a Component Object Model (COM) object is created on the parent thread and marshaled to the child thread, that parent thread cannot terminate before the child thread.</span></span> <span data-ttu-id="ed2e7-107">A tale scopo, la shell fornisce queste funzioni.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-107">To accomplish this, the Shell provides these functions.</span></span>

-   [<span data-ttu-id="ed2e7-108">**SHCreateThreadRef**</span><span class="sxs-lookup"><span data-stu-id="ed2e7-108">**SHCreateThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref)
-   [<span data-ttu-id="ed2e7-109">**SHSetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="ed2e7-109">**SHSetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref)
-   [<span data-ttu-id="ed2e7-110">**SHGetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="ed2e7-110">**SHGetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref)

<span data-ttu-id="ed2e7-111">Usare queste funzioni nel thread padre come descritto di seguito.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-111">Use these functions in your parent thread as outlined here.</span></span>

1.  <span data-ttu-id="ed2e7-112">Dichiarare una routine del thread definita dall'applicazione che segue il form della funzione [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="ed2e7-112">Declare an application-defined thread procedure following the form of the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) function.</span></span>

    ``` syntax
    DWORD WINAPI ThreadProc(LPVOID lpParameter);
    ```

2.  <span data-ttu-id="ed2e7-113">In [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85))chiamare [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) per creare un riferimento al thread.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-113">In your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), call [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) to create a reference to the thread.</span></span> <span data-ttu-id="ed2e7-114">In questo modo viene fornito un puntatore a un'istanza di [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span><span class="sxs-lookup"><span data-stu-id="ed2e7-114">This provides a pointer to an instance of [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span></span> <span data-ttu-id="ed2e7-115">Questo **IUnknown** usa il valore a cui punta *pcRef* per mantenere un conteggio dei riferimenti.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-115">This **IUnknown** uses the value pointed to by *pcRef* to maintain a reference count.</span></span> <span data-ttu-id="ed2e7-116">Finché il conteggio è maggiore di 0, il thread rimane attivo.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-116">As long as this count is greater than 0, the thread remains active.</span></span>
3.  <span data-ttu-id="ed2e7-117">Usando tale puntatore a [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), chiamare [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) in [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="ed2e7-117">Using that pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), call [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) in your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span></span> <span data-ttu-id="ed2e7-118">In questo modo, il riferimento viene impostato in modo che le chiamate successive a [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) abbiano qualcosa da recuperare.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-118">This sets the reference so that subsequent calls to [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) have something to retrieve.</span></span>
4.  <span data-ttu-id="ed2e7-119">Se il [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) crea un altro thread, il *ThreadProc* del thread può chiamare [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) con il puntatore a [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) ottenuto da [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span><span class="sxs-lookup"><span data-stu-id="ed2e7-119">If your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) creates another thread, that thread's *ThreadProc* can call [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) with the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained by [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span></span> <span data-ttu-id="ed2e7-120">In questo modo si incrementa il conteggio dei riferimenti a cui punta il parametro *pcRef* in **SHCreateThreadRef**.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-120">This increments the reference count pointed to by the *pcRef* parameter in **SHCreateThreadRef**.</span></span>
5.  <span data-ttu-id="ed2e7-121">Creare il thread.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-121">Create the thread.</span></span> <span data-ttu-id="ed2e7-122">Questa operazione viene in genere eseguita chiamando [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passando un puntatore a [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) nel parametro *pfnThreadProc* .</span><span class="sxs-lookup"><span data-stu-id="ed2e7-122">This is usually done by calling [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passing a pointer to your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) in the *pfnThreadProc* parameter.</span></span> <span data-ttu-id="ed2e7-123">Passare anche il \_ \_ flag di riferimento del thread CTF nel parametro *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="ed2e7-123">Also pass the CTF\_THREAD\_REF flag in the *dwFlags* parameter.</span></span> <span data-ttu-id="ed2e7-124">Il thread è attivo fino a quando *ThreadProc* è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-124">The thread is active as long as *ThreadProc* is executing.</span></span>
6.  <span data-ttu-id="ed2e7-125">Quando viene creato un thread figlio, passa il flag **CTF \_ ref \_ conteggiato** nel parametro *DwFlags* della chiamata al relativo [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span><span class="sxs-lookup"><span data-stu-id="ed2e7-125">When a child thread is created, pass the **CTF\_REF\_COUNTED** flag in the *dwFlags* parameter in the call to its [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span></span>
7.  <span data-ttu-id="ed2e7-126">Quando i thread figlio vengono completati e vengono rilasciati, il valore a cui fa riferimento il *pcRef* del thread padre diminuisce.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-126">As child threads complete and are released, the value pointed to by the parent thread's *pcRef* decreases.</span></span> <span data-ttu-id="ed2e7-127">Una volta completati tutti i thread figlio, il [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) originale può completare e rilasciare il riferimento finale al thread, eliminando il conteggio dei riferimenti a 0.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-127">Once all child threads are complete, the original [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) can complete and release the final thread reference, dropping the reference count to 0.</span></span> <span data-ttu-id="ed2e7-128">A questo punto, il riferimento al thread originale aperto da [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) viene rilasciato e il thread viene completato.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-128">At that point, the reference to the original thread opened by [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) is released and the thread completed.</span></span>

<span data-ttu-id="ed2e7-129">Un'altra funzione correlata è [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span><span class="sxs-lookup"><span data-stu-id="ed2e7-129">Another related function is [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span></span> <span data-ttu-id="ed2e7-130">Questa funzione viene chiamata da [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) se il thread è stato creato usando [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) con il flag **di \_ \_ riferimento del thread CTF** .</span><span class="sxs-lookup"><span data-stu-id="ed2e7-130">This function is called by the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) if the thread has been created using [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) with the **CTF\_THREAD\_REF** flag.</span></span> <span data-ttu-id="ed2e7-131">Tuttavia, *ThreadProc* non è necessario eseguire questa operazione in modo implicito.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-131">However, the *ThreadProc* is not required to do so implicitly.</span></span> <span data-ttu-id="ed2e7-132">La chiamata a [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) sul puntatore a [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) ottenuta tramite [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) è tutto ciò che è necessario eseguire.</span><span class="sxs-lookup"><span data-stu-id="ed2e7-132">Calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained through [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) is all that needs to be done.</span></span>

 

 
