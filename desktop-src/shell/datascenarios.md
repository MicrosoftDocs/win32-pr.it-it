---
description: In questo documento vengono illustrati gli scenari comuni di trasferimento dei dati della shell e viene illustrato come implementare ognuno di essi nell'applicazione.
ms.assetid: 7fce555c-a93d-4414-9119-7ae9acdd4d89
title: Gestione di scenari di trasferimento dei dati shell
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 35855b66e4108580d5bac305855837563ca59785
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104977314"
---
# <a name="handling-shell-data-transfer-scenarios"></a><span data-ttu-id="1a529-103">Gestione di scenari di trasferimento dei dati shell</span><span class="sxs-lookup"><span data-stu-id="1a529-103">Handling Shell Data Transfer Scenarios</span></span>

<span data-ttu-id="1a529-104">Il documento [oggetto dati della shell](dataobject.md) ha illustrato l'approccio generale usato per trasferire i dati della shell con il trascinamento della selezione o gli Appunti.</span><span class="sxs-lookup"><span data-stu-id="1a529-104">The [Shell Data Object](dataobject.md) document discussed the general approach that is used to transfer Shell data with drag-and-drop or the Clipboard.</span></span> <span data-ttu-id="1a529-105">Tuttavia, per implementare il trasferimento dei dati della shell nell'applicazione, è necessario comprendere anche come applicare questi principi e tecniche generali alla varietà di modi in cui è possibile trasferire i dati della shell.</span><span class="sxs-lookup"><span data-stu-id="1a529-105">However, to implement Shell data transfer in your application, you must also understand how to apply these general principles and techniques to the variety of ways that Shell data can be transferred.</span></span> <span data-ttu-id="1a529-106">In questo documento vengono illustrati gli scenari comuni di trasferimento dei dati della shell e viene illustrato come implementare ognuno di essi nell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-106">This document presents common Shell data transfer scenarios and discusses how to implement each one in your application.</span></span>

-   [<span data-ttu-id="1a529-107">Linee guida generali</span><span class="sxs-lookup"><span data-stu-id="1a529-107">General Guidelines</span></span>](#general-guidelines)
-   [<span data-ttu-id="1a529-108">Copia di nomi di file dagli Appunti in un'applicazione</span><span class="sxs-lookup"><span data-stu-id="1a529-108">Copying File Names from the Clipboard to an Application</span></span>](#copying-file-names-from-the-clipboard-to-an-application)
    -   [<span data-ttu-id="1a529-109">Estrazione dei nomi di file dall'oggetto dati</span><span class="sxs-lookup"><span data-stu-id="1a529-109">Extracting the File Names from the Data Object</span></span>](#extracting-the-file-names-from-the-data-object)
-   [<span data-ttu-id="1a529-110">Copia del contenuto di un file eliminato in un'applicazione</span><span class="sxs-lookup"><span data-stu-id="1a529-110">Copying the Contents of a Dropped File into an Application</span></span>](#copying-the-contents-of-a-dropped-file-into-an-application)
    -   [<span data-ttu-id="1a529-111">Uso del \_ formato FILEcontents CFSTR per estrarre i dati da un file</span><span class="sxs-lookup"><span data-stu-id="1a529-111">Using the CFSTR\_FILECONTENTS Format to Extract Data from a File</span></span>](/windows)
-   [<span data-ttu-id="1a529-112">Gestione delle operazioni di spostamento ottimizzate</span><span class="sxs-lookup"><span data-stu-id="1a529-112">Handling Optimized Move Operations</span></span>](#handling-optimized-move-operations)
-   [<span data-ttu-id="1a529-113">Gestione delle operazioni delete-on-paste</span><span class="sxs-lookup"><span data-stu-id="1a529-113">Handling Delete-on-Paste Operations</span></span>](#handling-delete-on-paste-operations)
-   [<span data-ttu-id="1a529-114">Trasferimento di dati da e verso cartelle virtuali</span><span class="sxs-lookup"><span data-stu-id="1a529-114">Transfering Data to and from Virtual Folders</span></span>](#transfering-data-to-and-from-virtual-folders)
    -   [<span data-ttu-id="1a529-115">Accettazione di dati da una cartella virtuale</span><span class="sxs-lookup"><span data-stu-id="1a529-115">Accepting Data from a Virtual Folder</span></span>](#accepting-data-from-a-virtual-folder)
    -   [<span data-ttu-id="1a529-116">Trasferimento di dati da e verso un'estensione dello spazio dei nomi</span><span class="sxs-lookup"><span data-stu-id="1a529-116">Transferring Data to and from a NameSpace Extension</span></span>](#transferring-data-to-and-from-a-namespace-extension)
-   [<span data-ttu-id="1a529-117">Eliminazione di file nel cestino</span><span class="sxs-lookup"><span data-stu-id="1a529-117">Dropping Files on the Recycle Bin</span></span>](#dropping-files-on-the-recycle-bin)
-   [<span data-ttu-id="1a529-118">Creazione e importazione di file di scarto</span><span class="sxs-lookup"><span data-stu-id="1a529-118">Creating and Importing Scrap Files</span></span>](#creating-and-importing-scrap-files)
    -   [<span data-ttu-id="1a529-119">Supporto round trip</span><span class="sxs-lookup"><span data-stu-id="1a529-119">Round-trip Support</span></span>](#round-trip-support)
    -   [<span data-ttu-id="1a529-120">Formati di dati memorizzati nella cache</span><span class="sxs-lookup"><span data-stu-id="1a529-120">Cached Data Formats</span></span>](#cached-data-formats)
    -   [<span data-ttu-id="1a529-121">Rendering ritardato</span><span class="sxs-lookup"><span data-stu-id="1a529-121">Delayed Rendering</span></span>](#delayed-rendering)
-   [<span data-ttu-id="1a529-122">Trascinamento e rilascio di oggetti Shell in modo asincrono</span><span class="sxs-lookup"><span data-stu-id="1a529-122">Dragging and Dropping Shell Objects Asynchronously</span></span>](#dragging-and-dropping-shell-objects-asynchronously)
    -   [<span data-ttu-id="1a529-123">Uso di IASyncOperation/IDataObjectAsyncCapability</span><span class="sxs-lookup"><span data-stu-id="1a529-123">Using IASyncOperation/IDataObjectAsyncCapability</span></span>](#using-iasyncoperationidataobjectasynccapability)

> [!Note]  
> <span data-ttu-id="1a529-124">Sebbene ognuno di questi scenari discuta un'operazione di trasferimento dati specifica, molti di essi si applicano a una varietà di scenari correlati.</span><span class="sxs-lookup"><span data-stu-id="1a529-124">Although each of these scenarios discusses a specific data transfer operation, many of them apply to a variety of related scenarios.</span></span> <span data-ttu-id="1a529-125">Ad esempio, la differenza principale tra la maggior parte degli Appunti e i trasferimenti con trascinamento della selezione è il modo in cui l'oggetto dati arriva alla destinazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-125">For instance, the primary difference between most Clipboard and drag-and-drop transfers is in how the data object arrives at the target.</span></span> <span data-ttu-id="1a529-126">Quando la destinazione ha un puntatore all'interfaccia [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) dell'oggetto dati, le procedure per l'estrazione di informazioni sono in gran parte identiche per entrambi i tipi di trasferimento dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-126">Once the target has a pointer to the data object's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface, the procedures for extracting information are largely the same for both types of data transfer.</span></span> <span data-ttu-id="1a529-127">Tuttavia, alcuni scenari sono limitati a un tipo specifico di operazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-127">However, some of the scenarios are limited to a specific type of operation.</span></span> <span data-ttu-id="1a529-128">Per informazioni dettagliate, vedere il singolo scenario.</span><span class="sxs-lookup"><span data-stu-id="1a529-128">Refer to the individual scenario for details.</span></span>

 

## <a name="general-guidelines"></a><span data-ttu-id="1a529-129">Linee guida generali</span><span class="sxs-lookup"><span data-stu-id="1a529-129">General Guidelines</span></span>

<span data-ttu-id="1a529-130">Ognuna delle sezioni seguenti illustra un unico scenario di trasferimento dati piuttosto specifico.</span><span class="sxs-lookup"><span data-stu-id="1a529-130">Each of the following sections discusses a single, fairly specific data transfer scenario.</span></span> <span data-ttu-id="1a529-131">Tuttavia, i trasferimenti di dati sono spesso più complessi e potrebbero implicare aspetti di diversi scenari.</span><span class="sxs-lookup"><span data-stu-id="1a529-131">However, data transfers are often more complex and might involve aspects of several scenarios.</span></span> <span data-ttu-id="1a529-132">In genere non si sa in anticipo quale scenario è effettivamente necessario gestire.</span><span class="sxs-lookup"><span data-stu-id="1a529-132">You typically do not know, in advance, which scenario you will actually need to handle.</span></span> <span data-ttu-id="1a529-133">Di seguito sono riportate alcune linee guida generali da tenere presenti.</span><span class="sxs-lookup"><span data-stu-id="1a529-133">Here are a few general guidelines to keep in mind.</span></span>

<span data-ttu-id="1a529-134">Per le origini dati:</span><span class="sxs-lookup"><span data-stu-id="1a529-134">For data sources:</span></span>

-   <span data-ttu-id="1a529-135">I formati degli Appunti della shell, ad eccezione di [CF \_ HDROP](clipboard.md), non sono predefiniti.</span><span class="sxs-lookup"><span data-stu-id="1a529-135">The Shell Clipboard formats, with the exception of [CF\_HDROP](clipboard.md), are not predefined.</span></span> <span data-ttu-id="1a529-136">Ogni formato che si desidera utilizzare deve essere registrato chiamando [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span><span class="sxs-lookup"><span data-stu-id="1a529-136">Each format you want to use must be registered by calling [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span></span>
-   <span data-ttu-id="1a529-137">I formati negli oggetti dati vengono forniti nell'ordine di preferenza dall'origine.</span><span class="sxs-lookup"><span data-stu-id="1a529-137">The formats in the data objects are provided in the order of preference from the source.</span></span> <span data-ttu-id="1a529-138">Enumerare l'oggetto dati e selezionare il primo che è possibile utilizzare.</span><span class="sxs-lookup"><span data-stu-id="1a529-138">Enumerate the data object and pick the first one you can consume.</span></span>
-   <span data-ttu-id="1a529-139">Includere tutti i formati che è possibile supportare.</span><span class="sxs-lookup"><span data-stu-id="1a529-139">Include as many formats as you can support.</span></span> <span data-ttu-id="1a529-140">In genere non si conosce la posizione in cui verrà eliminato l'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-140">You generally do not know where the data object will be dropped.</span></span> <span data-ttu-id="1a529-141">Questa pratica migliora le probabilità che l'oggetto dati conterrà un formato che l'obiettivo di rilascio può accettare.</span><span class="sxs-lookup"><span data-stu-id="1a529-141">This practice improves the odds that the data object will contain a format that the drop target can accept.</span></span>
-   <span data-ttu-id="1a529-142">I file esistenti devono essere offerti con il formato [CF \_ HDROP](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-142">Existing files should be offered with the [CF\_HDROP](clipboard.md) format.</span></span>
-   <span data-ttu-id="1a529-143">Offrire dati simili a file con [CFSTR \_ fileContents](clipboard.md) / [CFSTR \_ FileDescriptor](clipboard.md) formats.</span><span class="sxs-lookup"><span data-stu-id="1a529-143">Offer file-like data with [CFSTR\_FILECONTENTS](clipboard.md)/[CFSTR\_FILEDESCRIPTOR](clipboard.md) formats.</span></span> <span data-ttu-id="1a529-144">Questo approccio consente alla destinazione di creare un file da un oggetto dati senza che sia necessario conoscere l'archivio dati sottostante.</span><span class="sxs-lookup"><span data-stu-id="1a529-144">This approach allows the target to create a file from a data object without needing to know anything about the underlying data storage.</span></span> <span data-ttu-id="1a529-145">È in genere necessario presentare i dati come interfaccia [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) .</span><span class="sxs-lookup"><span data-stu-id="1a529-145">You should normally present the data as an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="1a529-146">Questo meccanismo di trasferimento dei dati è più flessibile rispetto a un oggetto memoria globale e utilizza una quantità di memoria inferiore.</span><span class="sxs-lookup"><span data-stu-id="1a529-146">This data transfer mechanism is more flexible than a global memory object and uses much less memory.</span></span>
-   <span data-ttu-id="1a529-147">Le origini di trascinamento devono offrire il formato [CFSTR \_ SHELLIDLIST](clipboard.md) durante il trascinamento degli elementi della shell.</span><span class="sxs-lookup"><span data-stu-id="1a529-147">Drag sources should offer the [CFSTR\_SHELLIDLIST](clipboard.md) format when dragging Shell items.</span></span> <span data-ttu-id="1a529-148">È possibile acquisire oggetti dati per gli elementi tramite i metodi [**IShellFolder:: GetUIObjectOf**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) o [**IShellItem:: BindToHandler**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellitem-bindtohandler) .</span><span class="sxs-lookup"><span data-stu-id="1a529-148">Data objects for items can be acquired through either the [**IShellFolder::GetUIObjectOf**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-getuiobjectof) or [**IShellItem::BindToHandler**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellitem-bindtohandler) methods.</span></span> <span data-ttu-id="1a529-149">Le origini dati possono creare un'implementazione dell'oggetto dati standard che supporta il formato [CFSTR \_ SHELLIDLIST](clipboard.md) tramite [**SHCreateDataObject**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shcreatedataobject).</span><span class="sxs-lookup"><span data-stu-id="1a529-149">Data sources can create a standard data object implementation that supports the [CFSTR\_SHELLIDLIST](clipboard.md) format by using [**SHCreateDataObject**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shcreatedataobject).</span></span>
-   <span data-ttu-id="1a529-150">Gli obiettivi di rilascio che vogliono ragionare sugli elementi trascinati tramite il modello di programmazione degli elementi della shell possono convertire un IDataObject in un [**IShellItemArray**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitemarray) usando [**SHCreateShellItemArrayFromDataObject**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-shcreateshellitemarrayfromdataobject).</span><span class="sxs-lookup"><span data-stu-id="1a529-150">Drop targets that want to reason about the items being dragged using the shell item programming model can convert an IDataObject into an [**IShellItemArray**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitemarray) using [**SHCreateShellItemArrayFromDataObject**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-shcreateshellitemarrayfromdataobject).</span></span>
-   <span data-ttu-id="1a529-151">Usare i cursori di feedback standard.</span><span class="sxs-lookup"><span data-stu-id="1a529-151">Use standard feedback cursors.</span></span>
-   <span data-ttu-id="1a529-152">Supporta il trascinamento di sinistra e destra.</span><span class="sxs-lookup"><span data-stu-id="1a529-152">Support left and right drag.</span></span>
-   <span data-ttu-id="1a529-153">Utilizzare l'oggetto dati stesso da un oggetto incorporato.</span><span class="sxs-lookup"><span data-stu-id="1a529-153">Use the data object itself from an embedded object.</span></span> <span data-ttu-id="1a529-154">Questo approccio consente all'applicazione di recuperare eventuali formati aggiuntivi che l'oggetto dati deve offrire ed evitare la creazione di un ulteriore livello di contenimento.</span><span class="sxs-lookup"><span data-stu-id="1a529-154">This approach allows your application to retrieve any extra formats the data object has to offer and avoids creating an extra layer of containment.</span></span> <span data-ttu-id="1a529-155">Ad esempio, un oggetto incorporato dal server A viene trascinato dal server/contenitore B ed eliminato nel contenitore C. C deve creare un oggetto incorporato del server A, non un oggetto incorporato del server B contenente un oggetto incorporato del server A.</span><span class="sxs-lookup"><span data-stu-id="1a529-155">For instance, an embedded object from server A is dragged from server/container B and dropped on container C. C should create an embedded object of server A, not an embedded object of server B containing an embedded object of server A.</span></span>
-   <span data-ttu-id="1a529-156">Tenere presente che la shell può usare le operazioni di spostamento [ottimizzato](#handling-optimized-move-operations) o [Delete-on-paste](#handling-delete-on-paste-operations) durante lo spostamento dei file.</span><span class="sxs-lookup"><span data-stu-id="1a529-156">Remember that the Shell might use [optimized moves](#handling-optimized-move-operations) or [delete-on-paste](#handling-delete-on-paste-operations) operations when moving files.</span></span> <span data-ttu-id="1a529-157">L'applicazione deve essere in grado di riconoscere queste operazioni e rispondere in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="1a529-157">Your application should be able to recognize these operations and respond appropriately.</span></span>

<span data-ttu-id="1a529-158">Per le destinazioni dei dati:</span><span class="sxs-lookup"><span data-stu-id="1a529-158">For data targets:</span></span>

-   <span data-ttu-id="1a529-159">I formati degli Appunti della shell, ad eccezione di [CF \_ HDROP](clipboard.md), non sono predefiniti.</span><span class="sxs-lookup"><span data-stu-id="1a529-159">The Shell Clipboard formats, with the exception of [CF\_HDROP](clipboard.md), are not predefined.</span></span> <span data-ttu-id="1a529-160">Ogni formato che si desidera utilizzare deve essere registrato chiamando [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span><span class="sxs-lookup"><span data-stu-id="1a529-160">Each format you want to use must be registered by calling [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata).</span></span>
-   <span data-ttu-id="1a529-161">Implementare e registrare una destinazione di rilascio OLE.</span><span class="sxs-lookup"><span data-stu-id="1a529-161">Implement and register an OLE drop target.</span></span> <span data-ttu-id="1a529-162">Evitare di usare le destinazioni di Windows 3,1 o il messaggio [**WM \_ DropFiles**](wm-dropfiles.md) , se possibile.</span><span class="sxs-lookup"><span data-stu-id="1a529-162">Avoid using Windows 3.1 targets or the [**WM\_DROPFILES**](wm-dropfiles.md) message, if possible.</span></span>
-   <span data-ttu-id="1a529-163">I formati contenuti in un oggetto dati variano a seconda della provenienza dell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="1a529-163">The formats contained by a data object vary, depending on where the object comes from.</span></span> <span data-ttu-id="1a529-164">Poiché in genere non si conosce in anticipo la provenienza di un oggetto dati, non si presuppone che sia presente un particolare formato.</span><span class="sxs-lookup"><span data-stu-id="1a529-164">Since you generally do not know in advance where a data object comes from, do not assume that a particular format will be present.</span></span> <span data-ttu-id="1a529-165">L'oggetto dati deve enumerare i formati in ordine di qualità, a partire dal migliore.</span><span class="sxs-lookup"><span data-stu-id="1a529-165">The data object should enumerate the formats in order of quality, starting with the best.</span></span> <span data-ttu-id="1a529-166">Pertanto, per ottenere il formato migliore disponibile, le applicazioni in genere enumerano i formati disponibili e utilizzano il primo formato nell'enumerazione che possono supportare.</span><span class="sxs-lookup"><span data-stu-id="1a529-166">Thus, to get the best available format, applications normally enumerate the available formats and use the first format in the enumeration that they can support.</span></span>
-   <span data-ttu-id="1a529-167">Supporto per il trascinamento destro.</span><span class="sxs-lookup"><span data-stu-id="1a529-167">Support right-drag.</span></span> <span data-ttu-id="1a529-168">È possibile personalizzare il menu di scelta rapida del trascinamento creando un [gestore di trascinamento della selezione](context-menu-handlers.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-168">You can customize the drag shortcut menu by creating a [drag-and-drop handler](context-menu-handlers.md).</span></span>
-   <span data-ttu-id="1a529-169">Se l'applicazione accetterà i file esistenti, deve essere in grado di gestire il formato [CF \_ HDROP](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-169">If your application will accept existing files, it must be able to handle the [CF\_HDROP](clipboard.md) format.</span></span>
-   <span data-ttu-id="1a529-170">In generale, le applicazioni che accettano i file devono gestire anche i formati di FileDescriptor CFSTR di [CFSTR \_ fileContents](clipboard.md) / [ \_ ](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-170">In general, applications that accept files should also handle the [CFSTR\_FILECONTENTS](clipboard.md)/[CFSTR\_FILEDESCRIPTOR](clipboard.md) formats.</span></span> <span data-ttu-id="1a529-171">Mentre i file del file System hanno il formato [CF \_ HDROP](clipboard.md) , i file di provider, ad esempio le estensioni dello spazio dei nomi, usano in genere [CFSTR \_ fileContents](clipboard.md) / [CFSTR \_ FileDescriptor](clipboard.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-171">While files from the file system have the [CF\_HDROP](clipboard.md) format, files from providers such as namespace extensions generally use [CFSTR\_FILECONTENTS](clipboard.md)/[CFSTR\_FILEDESCRIPTOR](clipboard.md).</span></span> <span data-ttu-id="1a529-172">Gli esempi includono cartelle Windows CE, File Transfer Protocol (FTP), cartelle Web e cartelle CAB.</span><span class="sxs-lookup"><span data-stu-id="1a529-172">Examples include Windows CE folders, File Transfer Protocol (FTP) folders, web folders, and CAB folders.</span></span> <span data-ttu-id="1a529-173">L'origine implementa in genere un'interfaccia [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) per presentare i dati dalla relativa archiviazione come file.</span><span class="sxs-lookup"><span data-stu-id="1a529-173">The source normally implements an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface to present data from its storage as a file.</span></span>
-   <span data-ttu-id="1a529-174">Tenere presente che la shell può usare le operazioni di spostamento [ottimizzato](#handling-optimized-move-operations) o [Delete-on-paste](#handling-delete-on-paste-operations) durante lo spostamento dei file.</span><span class="sxs-lookup"><span data-stu-id="1a529-174">Remember that the Shell might use [optimized moves](#handling-optimized-move-operations) or [delete-on-paste](#handling-delete-on-paste-operations) operations when moving files.</span></span> <span data-ttu-id="1a529-175">L'applicazione deve essere in grado di riconoscere queste operazioni e rispondere in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="1a529-175">Your application should be able to recognize these operations and respond appropriately.</span></span>

## <a name="copying-file-names-from-the-clipboard-to-an-application"></a><span data-ttu-id="1a529-176">Copia di nomi di file dagli Appunti in un'applicazione</span><span class="sxs-lookup"><span data-stu-id="1a529-176">Copying File Names from the Clipboard to an Application</span></span>

<span data-ttu-id="1a529-177">**Scenario:** Un utente seleziona uno o più file in Esplora risorse e li copia negli Appunti.</span><span class="sxs-lookup"><span data-stu-id="1a529-177">**Scenario:** A user selects one or more files in Windows Explorer and copies them to the Clipboard.</span></span> <span data-ttu-id="1a529-178">L'applicazione estrae i nomi dei file e li incolla nel documento.</span><span class="sxs-lookup"><span data-stu-id="1a529-178">Your application extracts the file names and pastes them into the document.</span></span>

<span data-ttu-id="1a529-179">Questo scenario può essere usato, ad esempio, per consentire a un utente di creare un collegamento HTML tagliando e incollando il file nell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-179">This scenario could be used, for instance, to allow a user to create an HTML link by cutting and pasting the file to your application.</span></span> <span data-ttu-id="1a529-180">L'applicazione può quindi estrarre il nome del file dall'oggetto dati ed elaborarlo per creare un tag di ancoraggio.</span><span class="sxs-lookup"><span data-stu-id="1a529-180">Your application can then extract the file name from the data object and process it to create an anchor tag.</span></span>

<span data-ttu-id="1a529-181">Quando un utente seleziona un file in Esplora risorse e lo copia negli Appunti, la shell crea un oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-181">When a user selects a file in Windows Explorer and copies it to the Clipboard, the Shell creates a data object.</span></span> <span data-ttu-id="1a529-182">Chiama quindi [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard) per inserire un puntatore all'interfaccia [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) dell'oggetto dati negli Appunti.</span><span class="sxs-lookup"><span data-stu-id="1a529-182">It then calls [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard) to place a pointer to the data object's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface on the Clipboard.</span></span>

<span data-ttu-id="1a529-183">Quando l'utente seleziona il comando **Incolla** dal menu o dalla barra degli strumenti dell'applicazione:</span><span class="sxs-lookup"><span data-stu-id="1a529-183">When the user selects the **Paste** command from your application's menu or toolbar:</span></span>

1.  <span data-ttu-id="1a529-184">Chiamare [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard) per recuperare l'interfaccia [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) dell'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-184">Call [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard) to retrieve the data object's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface.</span></span>
2.  <span data-ttu-id="1a529-185">Chiamare [**IDataObject:: EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) per richiedere un oggetto enumeratore.</span><span class="sxs-lookup"><span data-stu-id="1a529-185">Call [**IDataObject::EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) to request an enumerator object.</span></span>
3.  <span data-ttu-id="1a529-186">Utilizzare l'interfaccia [**IEnumFORMATETC**](/windows/win32/api/objidl/nn-objidl-ienumformatetc) dell'oggetto enumeratore per enumerare i formati contenuti nell'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-186">Use the enumerator object's [**IEnumFORMATETC**](/windows/win32/api/objidl/nn-objidl-ienumformatetc) interface to enumerate the formats contained by the data object.</span></span>

> [!Note]  
> <span data-ttu-id="1a529-187">I due passaggi finali di questa procedura sono inclusi per completezza.</span><span class="sxs-lookup"><span data-stu-id="1a529-187">The final two steps in this procedure are included for completeness.</span></span> <span data-ttu-id="1a529-188">Non sono in genere necessarie per semplici trasferimenti di file.</span><span class="sxs-lookup"><span data-stu-id="1a529-188">They are typically not necessary for simple file transfers.</span></span> <span data-ttu-id="1a529-189">Tutti gli oggetti dati usati per questo tipo di trasferimento dati devono contenere il formato [CF \_ HDROP](clipboard.md) , che può essere usato per determinare i nomi dei file contenuti nell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="1a529-189">All data objects used for this type of data transfer should contain the [CF\_HDROP](clipboard.md) format, which can be used to determine the names of the files contained by the object.</span></span> <span data-ttu-id="1a529-190">Tuttavia, per i trasferimenti di dati più generali, è consigliabile enumerare i formati e selezionare quello migliore che l'applicazione è in grado di gestire.</span><span class="sxs-lookup"><span data-stu-id="1a529-190">However, for more general data transfers, you should enumerate the formats and select the best one that your application can handle.</span></span>

 

### <a name="extracting-the-file-names-from-the-data-object"></a><span data-ttu-id="1a529-191">Estrazione dei nomi di file dall'oggetto dati</span><span class="sxs-lookup"><span data-stu-id="1a529-191">Extracting the File Names from the Data Object</span></span>

<span data-ttu-id="1a529-192">Il passaggio successivo consiste nell'estrarre uno o più nomi di file dall'oggetto dati e incollarli nell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-192">The next step is to extract one or more file names from the data object and paste them into your application.</span></span> <span data-ttu-id="1a529-193">Si noti che la procedura illustrata in questa sezione per l'estrazione di un nome di file da un oggetto dati si applica ugualmente bene ai trasferimenti con trascinamento della selezione.</span><span class="sxs-lookup"><span data-stu-id="1a529-193">Note that the procedure discussed in this section for extracting a file name from a data object applies equally well to drag-and-drop transfers.</span></span>

<span data-ttu-id="1a529-194">Il modo più semplice per recuperare i nomi di file da un oggetto dati è il formato [CF \_ HDROP](clipboard.md) :</span><span class="sxs-lookup"><span data-stu-id="1a529-194">The simplest way to retrieve file names from a data object is the [CF\_HDROP](clipboard.md) format:</span></span>

1.  <span data-ttu-id="1a529-195">Chiamare [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata).</span><span class="sxs-lookup"><span data-stu-id="1a529-195">Call [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata).</span></span> <span data-ttu-id="1a529-196">Impostare il membro **cfFormat** della struttura [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) su [CF \_ HDROP](clipboard.md) e il membro **TYMED** su [TYMED \_ HGLOBAL](dataobject.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-196">Set the **cfFormat** member of the [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) structure to [CF\_HDROP](clipboard.md) and the **tymed** member to [TYMED\_HGLOBAL](dataobject.md).</span></span> <span data-ttu-id="1a529-197">Il membro **dwAspect** è in genere impostato sul \_ contenuto di DVASPECT.</span><span class="sxs-lookup"><span data-stu-id="1a529-197">The **dwAspect** member is normally set to DVASPECT\_CONTENT.</span></span> <span data-ttu-id="1a529-198">Tuttavia, se è necessario avere il percorso del file in breve (8,3), impostare **dwAspect** su DVASPECT \_ short.</span><span class="sxs-lookup"><span data-stu-id="1a529-198">However, if you need to have the file's path in short (8.3) format, set **dwAspect** to DVASPECT\_SHORT.</span></span>

    <span data-ttu-id="1a529-199">Quando [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) restituisce, il membro **HGlobal** della struttura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) punta a un oggetto memoria globale che contiene i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-199">When [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) returns, the **hGlobal** member of the [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure points to a global memory object that contains the data.</span></span>

2.  <span data-ttu-id="1a529-200">Creare una variabile HDROP e impostarla sul membro **hGlobal** della struttura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) .</span><span class="sxs-lookup"><span data-stu-id="1a529-200">Create an HDROP variable and set it to the **hGlobal** member of the [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure.</span></span> <span data-ttu-id="1a529-201">La variabile HDROP è ora un handle per una struttura [**DropFiles**](/windows/desktop/api/shlobj_core/ns-shlobj_core-dropfiles) seguito da una doppia stringa con terminazione null contenente i percorsi di file completi dei file copiati.</span><span class="sxs-lookup"><span data-stu-id="1a529-201">The HDROP variable is now a handle to a [**DROPFILES**](/windows/desktop/api/shlobj_core/ns-shlobj_core-dropfiles) structure followed by a double null-terminated string containing the fully qualified file paths of the copied files.</span></span>
3.  <span data-ttu-id="1a529-202">Determinare il numero di percorsi di file presenti nell'elenco chiamando [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) con il parametro *iFile* impostato su 0xFFFFFFFF.</span><span class="sxs-lookup"><span data-stu-id="1a529-202">Determine how many file paths are in the list by calling [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) with the *iFile* parameter set to 0xFFFFFFFF.</span></span> <span data-ttu-id="1a529-203">La funzione restituisce il numero di percorsi di file nell'elenco.</span><span class="sxs-lookup"><span data-stu-id="1a529-203">The function returns the number of file paths in the list.</span></span> <span data-ttu-id="1a529-204">L'indice in base zero del percorso del file in questo elenco viene usato nel passaggio successivo per identificare un percorso specifico.</span><span class="sxs-lookup"><span data-stu-id="1a529-204">The file path's zero-based index in this list is used in the next step to identify a particular path.</span></span>
4.  <span data-ttu-id="1a529-205">Estrarre i percorsi di file dall'oggetto memoria globale chiamando [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) una volta per ogni file, con *iFile* impostato sull'indice del file.</span><span class="sxs-lookup"><span data-stu-id="1a529-205">Extract the file paths from the global memory object by calling [**DragQueryFile**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) once for each file, with *iFile* set to the file's index.</span></span>
5.  <span data-ttu-id="1a529-206">Elaborare i percorsi di file in base alle esigenze e incollarli nell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-206">Process the file paths as needed and paste them into your application.</span></span>
6.  <span data-ttu-id="1a529-207">Chiamare [**ReleaseStgMedium**](/windows/win32/api/ole2/nf-ole2-releasestgmedium) e passare il puntatore alla struttura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) passata a [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="1a529-207">Call [**ReleaseStgMedium**](/windows/win32/api/ole2/nf-ole2-releasestgmedium) and pass in the pointer to the [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure that you passed to [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) in step 1.</span></span> <span data-ttu-id="1a529-208">Una volta rilasciata la struttura, il valore di HDROP creato nel passaggio 2 non è più valido e non deve essere utilizzato.</span><span class="sxs-lookup"><span data-stu-id="1a529-208">Once you have released the structure, the HDROP value that you created in step 2 is no longer valid and should not be used.</span></span>

## <a name="copying-the-contents-of-a-dropped-file-into-an-application"></a><span data-ttu-id="1a529-209">Copia del contenuto di un file eliminato in un'applicazione</span><span class="sxs-lookup"><span data-stu-id="1a529-209">Copying the Contents of a Dropped File into an Application</span></span>

<span data-ttu-id="1a529-210">**Scenario:** Un utente trascina uno o più file da Esplora risorse e li rilascia nella finestra dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-210">**Scenario:** A user drags one or more files from Windows Explorer and drops them on your application's window.</span></span> <span data-ttu-id="1a529-211">L'applicazione estrae il contenuto dei file e lo incolla nell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-211">Your application extracts the content of the file (s) and pastes it into the application.</span></span>

<span data-ttu-id="1a529-212">Questo scenario usa il trascinamento della selezione per trasferire i file da Esplora risorse all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-212">This scenario uses drag-and-drop to transfer the files from Windows Explorer to the application.</span></span> <span data-ttu-id="1a529-213">Prima dell'operazione, l'applicazione deve:</span><span class="sxs-lookup"><span data-stu-id="1a529-213">Prior to the operation, your application must:</span></span>

1.  <span data-ttu-id="1a529-214">Chiamare [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata) per registrare tutti i formati degli Appunti della Shell necessari.</span><span class="sxs-lookup"><span data-stu-id="1a529-214">Call [RegisterClipboardFormat](/windows/win32/api/winuser/nf-winuser-registerclipboardformata) to register any needed Shell Clipboard formats.</span></span>
2.  <span data-ttu-id="1a529-215">Chiamare [**RegisterDragDrop**](/windows/win32/api/ole2/nf-ole2-registerdragdrop) per registrare una finestra di destinazione e l'interfaccia [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-215">Call [**RegisterDragDrop**](/windows/win32/api/ole2/nf-ole2-registerdragdrop) to register a target window and your application's [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) interface.</span></span>

<span data-ttu-id="1a529-216">Dopo che l'utente ha avviato l'operazione selezionando uno o più file e iniziando a trascinarli:</span><span class="sxs-lookup"><span data-stu-id="1a529-216">After the user initiates the operation by selecting one or more files and starting to drag them:</span></span>

1.  <span data-ttu-id="1a529-217">Esplora risorse crea un oggetto dati e vi carica i formati supportati.</span><span class="sxs-lookup"><span data-stu-id="1a529-217">Windows Explorer creates a data object and loads the supported formats into it.</span></span>
2.  <span data-ttu-id="1a529-218">Esplora risorse chiama [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) per avviare il ciclo di trascinamento.</span><span class="sxs-lookup"><span data-stu-id="1a529-218">Windows Explorer calls [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) to initiate the drag loop.</span></span>
3.  <span data-ttu-id="1a529-219">Quando l'immagine di trascinamento raggiunge la finestra di destinazione, il sistema invia una notifica chiamando [**IDropTarget::D ragenter**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragenter).</span><span class="sxs-lookup"><span data-stu-id="1a529-219">When the drag image reaches your target window, the system notifies you by calling [**IDropTarget::DragEnter**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-dragenter).</span></span>
4.  <span data-ttu-id="1a529-220">Per determinare il contenuto dell'oggetto dati, chiamare il metodo [**IDataObject:: EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) dell'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-220">To determine what the data object contains, call the data object's [**IDataObject::EnumFormatEtc**](/windows/win32/api/objidl/nf-objidl-idataobject-enumformatetc) method.</span></span> <span data-ttu-id="1a529-221">Utilizzare l'oggetto enumeratore restituito dal metodo per enumerare i formati contenuti nell'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-221">Use the enumerator object returned by the method to enumerate the formats contained by the data object.</span></span> <span data-ttu-id="1a529-222">Se l'applicazione non vuole accettare uno di questi formati, restituire DROPEFFECT \_ None.</span><span class="sxs-lookup"><span data-stu-id="1a529-222">If your application does not want to accept any of these formats, return DROPEFFECT\_NONE.</span></span> <span data-ttu-id="1a529-223">Ai fini di questo scenario, l'applicazione deve ignorare tutti gli oggetti dati che non contengono formati usati per trasferire i file, ad esempio [CF \_ HDROP](clipboard.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-223">For the purposes of this scenario, your application should ignore any data objects that do not contain formats used to transfer files, such as [CF\_HDROP](clipboard.md).</span></span>
5.  <span data-ttu-id="1a529-224">Quando l'utente rilascia i dati, il sistema chiama [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop).</span><span class="sxs-lookup"><span data-stu-id="1a529-224">When the user drops the data, the system calls [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop).</span></span>
6.  <span data-ttu-id="1a529-225">Utilizzare l'interfaccia [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) per estrarre il contenuto dei file.</span><span class="sxs-lookup"><span data-stu-id="1a529-225">Use the [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface to extract the contents of the files.</span></span>

<span data-ttu-id="1a529-226">Esistono diversi modi per estrarre il contenuto di un oggetto Shell da un oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-226">There are several different ways to extract the contents of a Shell object from a data object.</span></span> <span data-ttu-id="1a529-227">In generale, utilizzare l'ordine seguente:</span><span class="sxs-lookup"><span data-stu-id="1a529-227">In general, use the following order:</span></span>

-   <span data-ttu-id="1a529-228">Se il file contiene un formato di [ \_ testo CF](clipboard.md) , i dati sono testo ANSI.</span><span class="sxs-lookup"><span data-stu-id="1a529-228">If the file contains a [CF\_TEXT](clipboard.md) format, the data is ANSI text.</span></span> <span data-ttu-id="1a529-229">È possibile utilizzare il \_ formato di testo CF per estrarre i dati, anziché aprire il file stesso.</span><span class="sxs-lookup"><span data-stu-id="1a529-229">You can use the CF\_TEXT format to extract the data, rather than opening the file itself.</span></span>
-   <span data-ttu-id="1a529-230">Se il file contiene un oggetto OLE collegato o incorporato, l'oggetto dati contiene un \_ formato CF EMBEDDEDOBJECT.</span><span class="sxs-lookup"><span data-stu-id="1a529-230">If the file contains a linked or embedded OLE object, the data object contains a CF\_EMBEDDEDOBJECT format.</span></span> <span data-ttu-id="1a529-231">Utilizzare le tecniche OLE standard per estrarre i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-231">Use standard OLE techniques to extract the data.</span></span> <span data-ttu-id="1a529-232">[I file di scarto](#creating-and-importing-scrap-files) contengono sempre un \_ formato CF EMBEDDEDOBJECT.</span><span class="sxs-lookup"><span data-stu-id="1a529-232">[Scrap files](#creating-and-importing-scrap-files) always contain a CF\_EMBEDDEDOBJECT format.</span></span>
-   <span data-ttu-id="1a529-233">Se l'oggetto Shell viene dal file system, l'oggetto dati contiene un formato [CF \_ HDROP](clipboard.md) con i nomi dei file.</span><span class="sxs-lookup"><span data-stu-id="1a529-233">If the Shell object is from the file system, the data object contains a [CF\_HDROP](clipboard.md) format with the names of the files.</span></span> <span data-ttu-id="1a529-234">Estrarre il nome file da [CF \_ HDROP](clipboard.md) e chiamare [**OleCreateFromFile**](/windows/win32/api/ole2/nf-ole2-olecreatefromfile) per creare un nuovo oggetto collegato o incorporato.</span><span class="sxs-lookup"><span data-stu-id="1a529-234">Extract the file name from [CF\_HDROP](clipboard.md) and call [**OleCreateFromFile**](/windows/win32/api/ole2/nf-ole2-olecreatefromfile) to create a new linked or embedded object.</span></span> <span data-ttu-id="1a529-235">Per informazioni su come recuperare un nome file da un formato [CF \_ HDROP](clipboard.md) , vedere [copia dei nomi di file dagli Appunti in un'applicazione](#copying-file-names-from-the-clipboard-to-an-application).</span><span class="sxs-lookup"><span data-stu-id="1a529-235">For a discussion of how to retrieve a file name from a [CF\_HDROP](clipboard.md) format, see [Copying File Names from the Clipboard to an Application](#copying-file-names-from-the-clipboard-to-an-application).</span></span>
-   <span data-ttu-id="1a529-236">Se l'oggetto dati contiene un [formato \_ FileDescriptor CFSTR](clipboard.md) , è possibile estrarre il contenuto di un file dal formato [ \_ fileContents CFSTR](clipboard.md) del file.</span><span class="sxs-lookup"><span data-stu-id="1a529-236">If the data object contains a [CFSTR\_FILEDESCRIPTOR](clipboard.md) format, you can extract a file's contents from the file's [CFSTR\_FILECONTENTS](clipboard.md) format.</span></span> <span data-ttu-id="1a529-237">Per una descrizione di questa procedura, vedere [uso del \_ formato fileContents CFSTR per estrarre i dati da un file](/windows).</span><span class="sxs-lookup"><span data-stu-id="1a529-237">For a discussion of this procedure, see [Using the CFSTR\_FILECONTENTS Format to Extract Data from a File](/windows).</span></span>
-   <span data-ttu-id="1a529-238">Prima della shell [versione 4,71](versions.md), un'applicazione indicava che era in corso il trasferimento di un tipo di file di collegamento impostando **FD \_ LINKUI** nel membro **dwFlags** della struttura [**FileDescriptor**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) .</span><span class="sxs-lookup"><span data-stu-id="1a529-238">Prior to Shell [version 4.71](versions.md), an application indicated that it was transferring a shortcut file type by setting **FD\_LINKUI** in the **dwFlags** member of the [**FILEDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) structure.</span></span> <span data-ttu-id="1a529-239">Per le versioni successive della shell, il modo migliore per indicare che i collegamenti vengono trasferiti consiste nell'usare il formato [CFSTR \_ PREFERREDDROPEFFECT](clipboard.md) impostato su DropEffect \_ collegamento.</span><span class="sxs-lookup"><span data-stu-id="1a529-239">For later versions of the Shell, the preferred way to indicate that shortcuts are being transferred is to use the [CFSTR\_PREFERREDDROPEFFECT](clipboard.md) format set to DROPEFFECT\_LINK.</span></span> <span data-ttu-id="1a529-240">Questo approccio è molto più efficiente rispetto all'estrazione della struttura **FileDescriptor** solo per la verifica di un flag.</span><span class="sxs-lookup"><span data-stu-id="1a529-240">This approach is much more efficient than extracting the **FILEDESCRIPTOR** structure just to check a flag.</span></span>

<span data-ttu-id="1a529-241">Se il processo di estrazione dei dati sarà lungo, potrebbe essere necessario eseguire l'operazione in modo asincrono in un thread in background.</span><span class="sxs-lookup"><span data-stu-id="1a529-241">If the data extraction process will be lengthy, you might want to do the operation asynchronously on a background thread.</span></span> <span data-ttu-id="1a529-242">Il thread principale può procedere senza inutili ritardi.</span><span class="sxs-lookup"><span data-stu-id="1a529-242">Your primary thread can then proceed without unnecessary delays.</span></span> <span data-ttu-id="1a529-243">Per informazioni su come gestire l'estrazione asincrona dei dati, vedere [trascinamento e rilascio di oggetti Shell in modo asincrono](#dragging-and-dropping-shell-objects-asynchronously).</span><span class="sxs-lookup"><span data-stu-id="1a529-243">For a discussion of how to handle asynchronous data extraction, see [Dragging and Dropping Shell Objects Asynchronously](#dragging-and-dropping-shell-objects-asynchronously).</span></span>

### <a name="using-the-cfstr_filecontents-format-to-extract-data-from-a-file"></a><span data-ttu-id="1a529-244">Uso del \_ formato FILEcontents CFSTR per estrarre i dati da un file</span><span class="sxs-lookup"><span data-stu-id="1a529-244">Using the CFSTR\_FILECONTENTS Format to Extract Data from a File</span></span>

<span data-ttu-id="1a529-245">Il [formato \_ fileContents di CFSTR](clipboard.md) fornisce un modo molto flessibile e potente per trasferire il contenuto di un file.</span><span class="sxs-lookup"><span data-stu-id="1a529-245">The [CFSTR\_FILECONTENTS](clipboard.md) format provides a very flexible and powerful way to transfer the contents of a file.</span></span> <span data-ttu-id="1a529-246">Non è nemmeno necessario che i dati vengano archiviati come file singolo.</span><span class="sxs-lookup"><span data-stu-id="1a529-246">It is not even necessary for the data to be stored as a single file.</span></span> <span data-ttu-id="1a529-247">Tutto ciò che è necessario per questo formato è che l'oggetto dati presenta i dati alla destinazione come se si trattasse di un file.</span><span class="sxs-lookup"><span data-stu-id="1a529-247">All that is required for this format is that the data object present the data to the target as if it were a file.</span></span> <span data-ttu-id="1a529-248">Ad esempio, i dati effettivi potrebbero essere una sezione di un documento di testo o un blocco di dati estratti da un database.</span><span class="sxs-lookup"><span data-stu-id="1a529-248">For instance, the actual data might be a section of a text document or a block of data extracted from a database.</span></span> <span data-ttu-id="1a529-249">La destinazione può trattare i dati come file e non è necessario conoscere il meccanismo di archiviazione sottostante.</span><span class="sxs-lookup"><span data-stu-id="1a529-249">The target can treat the data as a file and does not need to know anything about the underlying storage mechanism.</span></span>

<span data-ttu-id="1a529-250">Le estensioni dello spazio dei nomi usano in genere i [ \_ contenuti fileCFSTR](clipboard.md) per trasferire i dati perché questo formato non presuppone alcun meccanismo di archiviazione specifico.</span><span class="sxs-lookup"><span data-stu-id="1a529-250">Namespace extensions normally use [CFSTR\_FILECONTENTS](clipboard.md) to transfer data because this format does not assume any particular storage mechanism.</span></span> <span data-ttu-id="1a529-251">Un'estensione dello spazio dei nomi può utilizzare qualsiasi meccanismo di archiviazione pratico e utilizzare questo formato per presentare gli oggetti alle applicazioni come se si trattasse di file.</span><span class="sxs-lookup"><span data-stu-id="1a529-251">A namespace extension can use whatever storage mechanism is convenient, and use this format to present its objects to applications as if they were files.</span></span>

<span data-ttu-id="1a529-252">Il meccanismo di trasferimento dei dati per i [ \_ FileContent CFSTR](clipboard.md) è in genere [TYMED \_ IStream](dataobject.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-252">The data transfer mechanism for [CFSTR\_FILECONTENTS](clipboard.md) is normally [TYMED\_ISTREAM](dataobject.md).</span></span> <span data-ttu-id="1a529-253">Il trasferimento di un puntatore a interfaccia [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) richiede molto meno memoria rispetto al caricamento dei dati in un oggetto memoria globale e **IStream** è un modo più semplice per rappresentare i dati rispetto a [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span><span class="sxs-lookup"><span data-stu-id="1a529-253">Transferring an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface pointer requires much less memory than loading the data into a global memory object, and **IStream** is a simpler way to represent data than [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span></span>

<span data-ttu-id="1a529-254">Un [formato \_ fileContents di CFSTR](clipboard.md) è sempre accompagnato da un formato [ \_ FileDescriptor CFSTR](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-254">A [CFSTR\_FILECONTENTS](clipboard.md) format is always accompanied by a [CFSTR\_FILEDESCRIPTOR](clipboard.md) format.</span></span> <span data-ttu-id="1a529-255">Per prima cosa è necessario esaminare il contenuto di questo formato.</span><span class="sxs-lookup"><span data-stu-id="1a529-255">You must examine the contents of this format first.</span></span> <span data-ttu-id="1a529-256">Se è in corso il trasferimento di più di un file, l'oggetto dati conterrà più formati [ \_ fileContents CFSTR](clipboard.md) , uno per ogni file.</span><span class="sxs-lookup"><span data-stu-id="1a529-256">If more than one file is being transferred, the data object will actually contain multiple [CFSTR\_FILECONTENTS](clipboard.md) formats, one for each file.</span></span> <span data-ttu-id="1a529-257">Il formato di [ \_ FileDescriptor CFSTR](clipboard.md) contiene il nome e gli attributi di ogni file e fornisce un valore di indice per ogni file necessario per estrarre il formato dei file [CFSTR \_ ](clipboard.md) di un determinato file.</span><span class="sxs-lookup"><span data-stu-id="1a529-257">The [CFSTR\_FILEDESCRIPTOR](clipboard.md) format contains the name and attributes of each file, and provides an index value for each file that is needed to extract a particular file's [CFSTR\_FILECONTENTS](clipboard.md) format.</span></span>

<span data-ttu-id="1a529-258">Per estrarre un formato [CFSTR \_ fileContents](clipboard.md) :</span><span class="sxs-lookup"><span data-stu-id="1a529-258">To extract a [CFSTR\_FILECONTENTS](clipboard.md) format:</span></span>

1.  <span data-ttu-id="1a529-259">Estrarre il formato [CFSTR \_ FileDescriptor](clipboard.md) come valore [TYMED \_ HGLOBAL](dataobject.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-259">Extract the [CFSTR\_FILEDESCRIPTOR](clipboard.md) format as a [TYMED\_HGLOBAL](dataobject.md) value.</span></span>
2.  <span data-ttu-id="1a529-260">Il membro **hGlobal** della struttura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) restituita punta a un oggetto memoria globale.</span><span class="sxs-lookup"><span data-stu-id="1a529-260">The **hGlobal** member of the returned [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure points to a global memory object.</span></span> <span data-ttu-id="1a529-261">Bloccare l'oggetto passando il valore di **hGlobal** a [**funzione GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock).</span><span class="sxs-lookup"><span data-stu-id="1a529-261">Lock that object by passing the **hGlobal** value to [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock).</span></span>
3.  <span data-ttu-id="1a529-262">Eseguire il cast del puntatore restituito da [**funzione GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) a un puntatore [**FILEGROUPDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filegroupdescriptora) .</span><span class="sxs-lookup"><span data-stu-id="1a529-262">Cast the pointer returned by [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) to a [**FILEGROUPDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filegroupdescriptora) pointer.</span></span> <span data-ttu-id="1a529-263">Punterà a una struttura **FILEGROUPDESCRIPTOR** seguita da una o più strutture [**FileDescriptor**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) .</span><span class="sxs-lookup"><span data-stu-id="1a529-263">It will point to a **FILEGROUPDESCRIPTOR** structure followed by one or more [**FILEDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) structures.</span></span> <span data-ttu-id="1a529-264">Ogni struttura **FileDescriptor** contiene una descrizione di un file che è contenuto in uno dei formati [CFSTR \_ fileContents](clipboard.md) associati.</span><span class="sxs-lookup"><span data-stu-id="1a529-264">Each **FILEDESCRIPTOR** structure contains a description of a file that is contained by one of the accompanying [CFSTR\_FILECONTENTS](clipboard.md) formats.</span></span>
4.  <span data-ttu-id="1a529-265">Esaminare le strutture [**FileDescriptor**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) per determinare quale corrisponde al file che si desidera estrarre.</span><span class="sxs-lookup"><span data-stu-id="1a529-265">Examine the [**FILEDESCRIPTOR**](/windows/win32/api/shlobj_core/ns-shlobj_core-filedescriptora) structures to determine which one corresponds to the file you want to extract.</span></span> <span data-ttu-id="1a529-266">L'indice in base zero di tale struttura **FileDescriptor** viene utilizzato per identificare il formato del file [CFSTR \_ fileContents](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-266">The zero-based index of that **FILEDESCRIPTOR** structure is used to identify the file's [CFSTR\_FILECONTENTS](clipboard.md) format.</span></span> <span data-ttu-id="1a529-267">Poiché la dimensione di un blocco di memoria globale non è precisa per i byte, usare i membri **nFileSizeLow** e **nFileSizeHigh** della struttura per determinare il numero di byte che rappresentano il file nell'oggetto memoria globale.</span><span class="sxs-lookup"><span data-stu-id="1a529-267">Because the size of a global memory block is not byte-precise, use the structure's **nFileSizeLow** and **nFileSizeHigh** members to determine how many bytes represent the file in the global memory object.</span></span>
5.  <span data-ttu-id="1a529-268">Chiamare [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) con il membro **CfFormat** della struttura [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) impostata sul valore [CFSTR \_ fileContents](clipboard.md) e il membro **lIndex** impostato sull'indice determinato nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="1a529-268">Call [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) with the **cfFormat** member of the [**FORMATETC**](/windows/win32/api/objidl/ns-objidl-formatetc) structure set to the [CFSTR\_FILECONTENTS](clipboard.md) value and the **lIndex** member set to the index that you determined in the previous step.</span></span> <span data-ttu-id="1a529-269">Il membro **TYMED** è in genere impostato su [TYMED \_ HGLOBAL](dataobject.md) \| TYMED \_ IStream \| TYMED \_ ISTORAGE.</span><span class="sxs-lookup"><span data-stu-id="1a529-269">The **tymed** member is typically set to [TYMED\_HGLOBAL](dataobject.md) \| TYMED\_ISTREAM \| TYMED\_ISTORAGE.</span></span> <span data-ttu-id="1a529-270">L'oggetto dati può quindi scegliere il meccanismo di trasferimento dei dati preferito.</span><span class="sxs-lookup"><span data-stu-id="1a529-270">The data object can then choose its preferred data transfer mechanism.</span></span>
6.  <span data-ttu-id="1a529-271">La struttura [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) restituita da [**IDataObject:: GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) conterrà un puntatore ai dati del file.</span><span class="sxs-lookup"><span data-stu-id="1a529-271">The [**STGMEDIUM**](/windows/win32/api/objidl/ns-objidl-ustgmedium-r1) structure that [**IDataObject::GetData**](/windows/win32/api/objidl/nf-objidl-idataobject-getdata) returns will contain a pointer to the file's data.</span></span> <span data-ttu-id="1a529-272">Esaminare il membro **TYMED** della struttura per determinare il meccanismo di trasferimento dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-272">Examine the **tymed** member of the structure to determine the data transfer mechanism.</span></span>
7.  <span data-ttu-id="1a529-273">Se **TYMED** è impostato su [TYMED \_ IStream](dataobject.md) o TYMED \_ ISTORAGE, utilizzare l'interfaccia per estrarre i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-273">If **tymed** is set to [TYMED\_ISTREAM](dataobject.md) or TYMED\_ISTORAGE, use the interface to extract the data.</span></span> <span data-ttu-id="1a529-274">Se **TYMED** è impostato su TYMED \_ HGLOBAL, i dati sono contenuti in un oggetto memoria globale.</span><span class="sxs-lookup"><span data-stu-id="1a529-274">If **tymed** is set to TYMED\_HGLOBAL, the data is contained in a global memory object.</span></span> <span data-ttu-id="1a529-275">Per informazioni su come estrarre i dati da un oggetto memoria globale, vedere la sezione *estrazione di un oggetto memoria globale da un oggetto dati* dell' [oggetto dati della shell](dataobject.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-275">For a discussion of how to extract data from a global memory object, see the *Extracting a global memory object from a data object* section of [Shell Data Object](dataobject.md).</span></span>
8.  <span data-ttu-id="1a529-276">Chiamare [**funzione GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) per sbloccare l'oggetto memoria globale bloccato nel passaggio 2.</span><span class="sxs-lookup"><span data-stu-id="1a529-276">Call [**GlobalLock**](/windows/win32/api/winbase/nf-winbase-globallock) to unlock the global memory object that you locked in step 2.</span></span>

## <a name="handling-optimized-move-operations"></a><span data-ttu-id="1a529-277">Gestione delle operazioni di spostamento ottimizzate</span><span class="sxs-lookup"><span data-stu-id="1a529-277">Handling Optimized Move Operations</span></span>

<span data-ttu-id="1a529-278">**Scenario:** Un file viene spostato dal file system a un'estensione dello spazio dei nomi utilizzando uno spostamento ottimizzato.</span><span class="sxs-lookup"><span data-stu-id="1a529-278">**Scenario:** A file is moved from the file system to a namespace extension using an optimized move.</span></span>

<span data-ttu-id="1a529-279">In un'operazione di spostamento convenzionale, la destinazione esegue una copia dei dati e l'origine Elimina l'originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-279">In a conventional move operation, the target makes a copy of the data and the source deletes the original.</span></span> <span data-ttu-id="1a529-280">Questa procedura può risultare inefficiente perché richiede due copie dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-280">This procedure can be inefficient because it requires two copies of the data.</span></span> <span data-ttu-id="1a529-281">Con oggetti di grandi dimensioni, ad esempio i database, un'operazione di spostamento convenzionale potrebbe non essere ancora praticabile.</span><span class="sxs-lookup"><span data-stu-id="1a529-281">With large objects such as databases, a conventional move operation might not even be practical.</span></span>

<span data-ttu-id="1a529-282">Con uno spostamento ottimizzato, la destinazione usa la conoscenza della modalità di archiviazione dei dati per gestire l'intera operazione di spostamento.</span><span class="sxs-lookup"><span data-stu-id="1a529-282">With an optimized move, the target uses its understanding of how the data is stored to handle the entire move operation.</span></span> <span data-ttu-id="1a529-283">Non esiste mai una seconda copia dei dati e non è necessario che l'origine elimini i dati originali.</span><span class="sxs-lookup"><span data-stu-id="1a529-283">There is never a second copy of the data, and there is no need for the source to delete the original data.</span></span> <span data-ttu-id="1a529-284">I dati della shell sono particolarmente adatti per gli spostamenti ottimizzati perché la destinazione può gestire l'intera operazione usando l'API shell.</span><span class="sxs-lookup"><span data-stu-id="1a529-284">Shell data is well suited to optimized moves because the target can handle the entire operation using the Shell API.</span></span> <span data-ttu-id="1a529-285">Un esempio tipico è lo stato di trasferimento di file.</span><span class="sxs-lookup"><span data-stu-id="1a529-285">A typical example is moving files.</span></span> <span data-ttu-id="1a529-286">Quando la destinazione ha il percorso di un file da spostare, può usare [**SHFileOperation**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) per spostarlo.</span><span class="sxs-lookup"><span data-stu-id="1a529-286">Once the target has the path of a file to be moved, it can use [**SHFileOperation**](/windows/desktop/api/Shellapi/nf-shellapi-shfileoperationa) to move it.</span></span> <span data-ttu-id="1a529-287">Non è necessario che l'origine elimini il file originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-287">There is no need for the source to delete the original file.</span></span>

> [!Note]  
> <span data-ttu-id="1a529-288">La shell USA in genere uno spostamento ottimizzato per spostare i file.</span><span class="sxs-lookup"><span data-stu-id="1a529-288">The Shell normally uses an optimized move to move files.</span></span> <span data-ttu-id="1a529-289">Per gestire correttamente il trasferimento dei dati della shell, l'applicazione deve essere in grado di rilevare e gestire uno spostamento ottimizzato.</span><span class="sxs-lookup"><span data-stu-id="1a529-289">To handle Shell data transfer properly, your application must be capable of detecting and handling an optimized move.</span></span>

 

<span data-ttu-id="1a529-290">Lo spostamento ottimizzato viene gestito nel modo seguente:</span><span class="sxs-lookup"><span data-stu-id="1a529-290">Optimized moves are handled in the following way:</span></span>

1.  <span data-ttu-id="1a529-291">L'origine chiama [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) con il parametro *DWEFFECT* impostato su DropEffect \_ Move per indicare che è possibile spostare gli oggetti di origine.</span><span class="sxs-lookup"><span data-stu-id="1a529-291">The source calls [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) with the *dwEffect* parameter set to DROPEFFECT\_MOVE to indicate that the source objects can be moved.</span></span>
2.  <span data-ttu-id="1a529-292">La destinazione riceve il \_ valore di spostamento DropEffect tramite uno dei relativi metodi [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) , a indicare che è consentito uno spostamento.</span><span class="sxs-lookup"><span data-stu-id="1a529-292">The target receives the DROPEFFECT\_MOVE value through one of its [**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) methods, indicating that a move is allowed.</span></span>
3.  <span data-ttu-id="1a529-293">La destinazione copia l'oggetto (spostamento non ottimizzato) o sposta l'oggetto (spostamento ottimizzato).</span><span class="sxs-lookup"><span data-stu-id="1a529-293">The target either copies the object (unoptimized move) or moves the object (optimized move).</span></span>
4.  <span data-ttu-id="1a529-294">La destinazione indica quindi all'origine se è necessario eliminare i dati originali.</span><span class="sxs-lookup"><span data-stu-id="1a529-294">The target then tells the source whether it needs to delete the original data.</span></span>

    <span data-ttu-id="1a529-295">Uno spostamento ottimizzato è l'operazione predefinita, con i dati eliminati dalla destinazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-295">An optimized move is the default operation, with the data deleted by the target.</span></span> <span data-ttu-id="1a529-296">Per informare l'origine che è stato eseguito uno spostamento ottimizzato:</span><span class="sxs-lookup"><span data-stu-id="1a529-296">To inform the source that an optimized move was performed:</span></span>

    -   -   <span data-ttu-id="1a529-297">La destinazione imposta il valore *pdwEffect* ricevuto tramite il metodo [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) su un valore diverso da DROPEFFECT \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-297">The target sets the *pdwEffect* value it received through its [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) method to some value other than DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="1a529-298">Viene in genere impostato su DROPEFFECT \_ None o DropEffect \_ Copy.</span><span class="sxs-lookup"><span data-stu-id="1a529-298">It is typically set to either DROPEFFECT\_NONE or DROPEFFECT\_COPY.</span></span> <span data-ttu-id="1a529-299">Il valore verrà restituito all'origine da [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span><span class="sxs-lookup"><span data-stu-id="1a529-299">The value will be returned to the source by [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span></span>
        -   <span data-ttu-id="1a529-300">La destinazione chiama anche il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) dell'oggetto dati e lo passa a un identificatore di formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) impostato su DropEffect \_ None.</span><span class="sxs-lookup"><span data-stu-id="1a529-300">The target also calls the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method and passes it a [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format identifier set to DROPEFFECT\_NONE.</span></span> <span data-ttu-id="1a529-301">Questa chiamata al metodo è necessaria perché alcune destinazioni di rilascio potrebbero non impostare correttamente il parametro *pdwEffect* di [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) .</span><span class="sxs-lookup"><span data-stu-id="1a529-301">This method call is necessary because some drop targets might not set the *pdwEffect* parameter of [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) properly.</span></span> <span data-ttu-id="1a529-302">Il formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) è il modo affidabile per indicare che è stato effettuato uno spostamento ottimizzato.</span><span class="sxs-lookup"><span data-stu-id="1a529-302">The [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format is the reliable way to indicate that an optimized move has taken place.</span></span>

    <span data-ttu-id="1a529-303">Se la destinazione ha avuto uno spostamento non ottimizzato, i dati devono essere eliminati dall'origine.</span><span class="sxs-lookup"><span data-stu-id="1a529-303">If the target did an unoptimized move, the data must be deleted by the source.</span></span> <span data-ttu-id="1a529-304">Per informare l'origine che è stato eseguito uno spostamento non ottimizzato:</span><span class="sxs-lookup"><span data-stu-id="1a529-304">To inform the source that an unoptimized move was performed:</span></span>

    -   -   <span data-ttu-id="1a529-305">La destinazione imposta il valore *pdwEffect* ricevuto tramite il metodo [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) DropEffect \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-305">The target sets the *pdwEffect* value it received through its [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) method to DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="1a529-306">Il valore verrà restituito all'origine da [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span><span class="sxs-lookup"><span data-stu-id="1a529-306">The value will be returned to the source by [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop).</span></span>
        -   <span data-ttu-id="1a529-307">La destinazione chiama anche il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) dell'oggetto dati e lo passa a un identificatore di formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) impostato su DropEffect \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-307">The target also calls the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method and passes it a [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format identifier set to DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="1a529-308">Questa chiamata al metodo è necessaria perché alcune destinazioni di rilascio potrebbero non impostare correttamente il parametro *pdwEffect* di [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) .</span><span class="sxs-lookup"><span data-stu-id="1a529-308">This method call is necessary because some drop targets might not set the *pdwEffect* parameter of [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) properly.</span></span> <span data-ttu-id="1a529-309">Il formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) è il modo affidabile per indicare che si è verificato uno spostamento non ottimizzato.</span><span class="sxs-lookup"><span data-stu-id="1a529-309">The [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format is the reliable way to indicate that an unoptimized move has taken place.</span></span>

5.  <span data-ttu-id="1a529-310">L'origine controlla i due valori che possono essere restituiti dalla destinazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-310">The source inspects the two values that can be returned by the target.</span></span> <span data-ttu-id="1a529-311">Se entrambe le impostazioni sono impostate su DROPEFFECT \_ Move, viene completato lo spostamento non ottimizzato eliminando i dati originali.</span><span class="sxs-lookup"><span data-stu-id="1a529-311">If both are set to DROPEFFECT\_MOVE, it completes the unoptimized move by deleting the original data.</span></span> <span data-ttu-id="1a529-312">In caso contrario, la destinazione ha avuto uno spostamento ottimizzato e i dati originali sono stati eliminati.</span><span class="sxs-lookup"><span data-stu-id="1a529-312">Otherwise, the target did an optimized move and the original data has been deleted.</span></span>

## <a name="handling-delete-on-paste-operations"></a><span data-ttu-id="1a529-313">Gestione delle operazioni delete-on-paste</span><span class="sxs-lookup"><span data-stu-id="1a529-313">Handling Delete-on-Paste Operations</span></span>

<span data-ttu-id="1a529-314">**Scenario:** Uno o più file vengono tagliati da una cartella in Esplora risorse e incollati in un'estensione dello spazio dei nomi.</span><span class="sxs-lookup"><span data-stu-id="1a529-314">**Scenario:** One or more files are cut from a folder in Windows Explorer and pasted into a namespace extension.</span></span> <span data-ttu-id="1a529-315">Esplora risorse lascia i file evidenziati fino a quando non riceve commenti sul risultato dell'operazione Incolla.</span><span class="sxs-lookup"><span data-stu-id="1a529-315">Windows Explorer leaves the files highlighted until it receives feedback on the outcome of the paste operation.</span></span>

<span data-ttu-id="1a529-316">Tradizionalmente, quando un utente taglia i dati, scompare immediatamente dalla visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-316">Traditionally, when a user cuts data it immediately disappears from view.</span></span> <span data-ttu-id="1a529-317">Questo potrebbe non essere efficiente e può causare problemi di usabilità se l'utente si preoccupa di ciò che si è verificato ai dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-317">This might not be efficient, and it can lead to usability problems if the user becomes concerned about what has happened to the data.</span></span> <span data-ttu-id="1a529-318">Un approccio alternativo consiste nell'usare un'operazione Delete-on-paste.</span><span class="sxs-lookup"><span data-stu-id="1a529-318">An alternative approach is to use a delete-on-paste operation.</span></span>

<span data-ttu-id="1a529-319">Con un'operazione Delete-on-paste, i dati selezionati non vengono rimossi immediatamente dalla visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-319">With a delete-on-paste operation, the selected data is not immediately removed from view.</span></span> <span data-ttu-id="1a529-320">Al contrario, l'applicazione di origine lo contrassegna come selezionata, forse modificando il tipo di carattere o il colore di sfondo.</span><span class="sxs-lookup"><span data-stu-id="1a529-320">Instead, the source application marks it as selected, perhaps by changing the font or background color.</span></span> <span data-ttu-id="1a529-321">Dopo che l'applicazione di destinazione ha incollato i dati, notifica all'origine il risultato dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-321">After the target application has pasted the data, it notifies the source about the outcome of the operation.</span></span> <span data-ttu-id="1a529-322">Se la destinazione ha eseguito uno [spostamento ottimizzato](#handling-optimized-move-operations), l'origine può semplicemente aggiornarne la visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-322">If the target performed an [optimized move](#handling-optimized-move-operations), the source can simply update its display.</span></span> <span data-ttu-id="1a529-323">Se la destinazione ha eseguito uno spostamento normale, è necessario che l'origine elimini anche la copia dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-323">If the target performed a normal move, the source must also delete its copy of the data.</span></span> <span data-ttu-id="1a529-324">Se la copia non riesce, l'applicazione di origine Ripristina i dati selezionati nell'aspetto originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-324">If the paste fails, the source application restores the selected data to its original appearance.</span></span>

> [!Note]  
> <span data-ttu-id="1a529-325">La shell USA in genere Delete-on-paste quando viene usata un'operazione Taglia/Incolla per spostare i file.</span><span class="sxs-lookup"><span data-stu-id="1a529-325">The Shell normally uses delete-on-paste when a cut/paste operation is used to move files.</span></span> <span data-ttu-id="1a529-326">Le operazioni delete-on-paste con gli oggetti Shell usano normalmente uno [spostamento ottimizzato](#handling-optimized-move-operations) per spostare i file.</span><span class="sxs-lookup"><span data-stu-id="1a529-326">Delete-on-paste operations with Shell objects normally use an [optimized move](#handling-optimized-move-operations) to move the files.</span></span> <span data-ttu-id="1a529-327">Per gestire correttamente il trasferimento dei dati della shell, l'applicazione deve essere in grado di rilevare e gestire operazioni delete-on-paste.</span><span class="sxs-lookup"><span data-stu-id="1a529-327">To handle Shell data transfer properly, your application must be capable of detecting and handling delete-on-paste operations.</span></span>

 

<span data-ttu-id="1a529-328">Il requisito essenziale per Delete-on-paste è che la destinazione deve segnalare il risultato dell'operazione all'origine.</span><span class="sxs-lookup"><span data-stu-id="1a529-328">The essential requirement for delete-on-paste is that the target must report the outcome of the operation to the source.</span></span> <span data-ttu-id="1a529-329">Tuttavia, le tecniche degli Appunti standard non possono essere usate per implementare Delete-on-paste perché non forniscono un modo per la comunicazione della destinazione con l'origine.</span><span class="sxs-lookup"><span data-stu-id="1a529-329">However, standard Clipboard techniques cannot be used to implement delete-on-paste because they do not provide a way for the target to communicate with the source.</span></span> <span data-ttu-id="1a529-330">Al contrario, l'applicazione di destinazione usa il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) dell'oggetto dati per segnalare il risultato all'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-330">Instead, the target application uses the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method to report the outcome to the data object.</span></span> <span data-ttu-id="1a529-331">L'oggetto dati può quindi comunicare con l'origine tramite un'interfaccia privata.</span><span class="sxs-lookup"><span data-stu-id="1a529-331">The data object can then communicate with the source through a private interface.</span></span>

<span data-ttu-id="1a529-332">La procedura di base per un'operazione Delete-on-paste è la seguente:</span><span class="sxs-lookup"><span data-stu-id="1a529-332">The basic procedure for a delete-on-paste operation is as follows:</span></span>

1.  <span data-ttu-id="1a529-333">Il codice sorgente contrassegna la visualizzazione dei dati selezionati.</span><span class="sxs-lookup"><span data-stu-id="1a529-333">The source marks the screen display of the selected data.</span></span>
2.  <span data-ttu-id="1a529-334">L'origine crea un oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-334">The source creates a data object.</span></span> <span data-ttu-id="1a529-335">Indica un'operazione di taglio aggiungendo il formato [CFSTR \_ PREFERREDDROPEFFECT](clipboard.md) con un valore di dati di DropEffect \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-335">It indicates a cut operation by adding the [CFSTR\_PREFERREDDROPEFFECT](clipboard.md) format with a data value of DROPEFFECT\_MOVE.</span></span>
3.  <span data-ttu-id="1a529-336">L'origine posiziona l'oggetto dati negli appunti usando [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard).</span><span class="sxs-lookup"><span data-stu-id="1a529-336">The source places the data object on the Clipboard using [**OleSetClipboard**](/windows/win32/api/ole2/nf-ole2-olesetclipboard).</span></span>
4.  <span data-ttu-id="1a529-337">La destinazione recupera l'oggetto dati dagli appunti usando [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard).</span><span class="sxs-lookup"><span data-stu-id="1a529-337">The target retrieves the data object from the Clipboard using [**OleGetClipboard**](/windows/win32/api/ole2/nf-ole2-olegetclipboard).</span></span>
5.  <span data-ttu-id="1a529-338">La destinazione estrae i dati di [ \_ PREFERREDDROPEFFECT CFSTR](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-338">The target extracts the [CFSTR\_PREFERREDDROPEFFECT](clipboard.md) data.</span></span> <span data-ttu-id="1a529-339">Se è impostato su DROPEFFECT \_ Move, la destinazione può eseguire uno spostamento ottimizzato o semplicemente copiare i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-339">If it is set to only DROPEFFECT\_MOVE, the target can either do an optimized move or simply copy the data.</span></span>
6.  <span data-ttu-id="1a529-340">Se la destinazione non esegue uno spostamento ottimizzato, chiama il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) con il formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) impostato su DropEffect \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-340">If the target does not do an optimized move, it calls the [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method with the [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format set to DROPEFFECT\_MOVE.</span></span>
7.  <span data-ttu-id="1a529-341">Al termine della copia, la destinazione chiama il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) con il formato [CFSTR \_ PASTESUCCEEDED](clipboard.md) impostato su DropEffect \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-341">When the paste is complete, the target calls the [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method with the [CFSTR\_PASTESUCCEEDED](clipboard.md) format set to DROPEFFECT\_MOVE.</span></span>
8.  <span data-ttu-id="1a529-342">Quando il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) dell'origine viene chiamato con il formato [CFSTR \_ PASTESUCCEEDED](clipboard.md) impostato su DropEffect \_ Move, deve verificare se è stato ricevuto anche il formato [CFSTR \_ PERFORMEDDROPEFFECT](clipboard.md) impostato su DropEffect \_ Move.</span><span class="sxs-lookup"><span data-stu-id="1a529-342">When the source's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method is called with the [CFSTR\_PASTESUCCEEDED](clipboard.md) format set to DROPEFFECT\_MOVE, it must check to see if it also received the [CFSTR\_PERFORMEDDROPEFFECT](clipboard.md) format set to DROPEFFECT\_MOVE.</span></span> <span data-ttu-id="1a529-343">Se entrambi i formati vengono inviati dalla destinazione, l'origine dovrà eliminare i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-343">If both formats are sent by the target, the source will have to delete the data.</span></span> <span data-ttu-id="1a529-344">Se viene ricevuto solo il formato [CFSTR \_ PASTESUCCEEDED](clipboard.md) , l'origine può semplicemente rimuovere i dati dalla relativa visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-344">If only the [CFSTR\_PASTESUCCEEDED](clipboard.md) format is received, the source can simply remove the data from its display.</span></span> <span data-ttu-id="1a529-345">Se il trasferimento non riesce, l'origine aggiorna la visualizzazione all'aspetto originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-345">If the transfer fails, the source updates the display to its original appearance.</span></span>

## <a name="transfering-data-to-and-from-virtual-folders"></a><span data-ttu-id="1a529-346">Trasferimento di dati da e verso cartelle virtuali</span><span class="sxs-lookup"><span data-stu-id="1a529-346">Transfering Data to and from Virtual Folders</span></span>

<span data-ttu-id="1a529-347">**Scenario:** Un utente trascina un oggetto da o lo rilascia in una cartella virtuale.</span><span class="sxs-lookup"><span data-stu-id="1a529-347">**Scenario:** A user drags an object from or drops it on a virtual folder.</span></span>

<span data-ttu-id="1a529-348">Le cartelle virtuali contengono oggetti che in genere non fanno parte del file system.</span><span class="sxs-lookup"><span data-stu-id="1a529-348">Virtual folders contain objects that are generally not part of the file system.</span></span> <span data-ttu-id="1a529-349">Alcune cartelle virtuali, ad esempio il Cestino, possono rappresentare dati archiviati sul disco rigido, ma non come oggetti file system ordinari.</span><span class="sxs-lookup"><span data-stu-id="1a529-349">Some virtual folders, such as the Recycle Bin, can represent data that is stored on the hard disk but not as ordinary file system objects.</span></span> <span data-ttu-id="1a529-350">Alcuni possono rappresentare dati archiviati che si trovano in un sistema remoto, ad esempio un PC palmare o un sito FTP.</span><span class="sxs-lookup"><span data-stu-id="1a529-350">Some can represent stored data that is on a remote system, such as a handheld PC, or an FTP site.</span></span> <span data-ttu-id="1a529-351">Altri, ad esempio la cartella stampanti, contengono oggetti che non rappresentano dati archiviati.</span><span class="sxs-lookup"><span data-stu-id="1a529-351">Others, such as the Printers folder, contain objects that do not represent stored data at all.</span></span> <span data-ttu-id="1a529-352">Mentre alcune cartelle virtuali fanno parte del sistema, gli sviluppatori possono anche creare e installare cartelle virtuali personalizzate implementando un'estensione dello spazio dei nomi.</span><span class="sxs-lookup"><span data-stu-id="1a529-352">While some virtual folders are part of the system, developers can also create and install custom virtual folders by implementing a namespace extension.</span></span>

<span data-ttu-id="1a529-353">Indipendentemente dal tipo di dati o dal modo in cui vengono archiviati, la shell e gli oggetti file contenuti in una cartella virtuale vengono presentati dalla shell come se fossero file e cartelle normali.</span><span class="sxs-lookup"><span data-stu-id="1a529-353">Regardless of the type of data or how it is stored, the folder and file objects that are contained by a virtual folder are presented by the Shell as if they were normal files and folders.</span></span> <span data-ttu-id="1a529-354">È responsabilità della cartella virtuale prendere tutti i dati che contiene e presentarli in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="1a529-354">It is the responsibility of the virtual folder to take whatever data it contains and present it to the Shell appropriately.</span></span> <span data-ttu-id="1a529-355">Questo requisito significa che le cartelle virtuali normalmente supportano il trascinamento della selezione e i trasferimenti di dati degli Appunti.</span><span class="sxs-lookup"><span data-stu-id="1a529-355">This requirement means that virtual folders normally support drag-and-drop and Clipboard data transfers.</span></span>

<span data-ttu-id="1a529-356">Sono pertanto presenti due gruppi di sviluppatori che devono essere interessati al trasferimento di dati da e verso le cartelle virtuali:</span><span class="sxs-lookup"><span data-stu-id="1a529-356">There are thus two groups of developers who need to be concerned with data transfer to and from virtual folders:</span></span>

-   <span data-ttu-id="1a529-357">Sviluppatori le cui applicazioni devono accettare i dati trasferiti da una cartella virtuale.</span><span class="sxs-lookup"><span data-stu-id="1a529-357">Developers whose applications need to accept data that is transferred from a virtual folder.</span></span>
-   <span data-ttu-id="1a529-358">Sviluppatori le cui estensioni dello spazio dei nomi devono supportare correttamente il trasferimento dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-358">Developers whose namespace extensions need to properly support data transfer.</span></span>

### <a name="accepting-data-from-a-virtual-folder"></a><span data-ttu-id="1a529-359">Accettazione di dati da una cartella virtuale</span><span class="sxs-lookup"><span data-stu-id="1a529-359">Accepting Data from a Virtual Folder</span></span>

<span data-ttu-id="1a529-360">Le cartelle virtuali possono rappresentare praticamente qualsiasi tipo di dati e possono archiviare i dati nel modo scelto.</span><span class="sxs-lookup"><span data-stu-id="1a529-360">Virtual folders can represent virtually any type of data and can store that data in any way they choose.</span></span> <span data-ttu-id="1a529-361">Alcune cartelle virtuali potrebbero contenere effettivamente file e cartelle file system normali.</span><span class="sxs-lookup"><span data-stu-id="1a529-361">Some virtual folders might actually contain normal file system files and folders.</span></span> <span data-ttu-id="1a529-362">Altri potrebbero, ad esempio, comprimere tutti i relativi oggetti in un singolo documento o database.</span><span class="sxs-lookup"><span data-stu-id="1a529-362">Others might, for instance, pack all their objects into a single document or database.</span></span>

<span data-ttu-id="1a529-363">Quando un oggetto file system viene trasferito a un'applicazione, l'oggetto dati contiene normalmente un formato [CF \_ HDROP](clipboard.md) con il percorso completo dell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="1a529-363">When a file system object is transferred to an application, the data object normally contains a [CF\_HDROP](clipboard.md) format with the object's fully qualified path.</span></span> <span data-ttu-id="1a529-364">L'applicazione può estrarre questa stringa e usare le normali funzioni di file system per aprire il file ed estrarre i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-364">Your application can extract this string and use the normal file system functions to open the file and extract its data.</span></span> <span data-ttu-id="1a529-365">Tuttavia, poiché le cartelle virtuali non contengono in genere oggetti file system normali, in genere non usano [CF \_ HDROP](clipboard.md).</span><span class="sxs-lookup"><span data-stu-id="1a529-365">However, because virtual folders typically do not contain normal file system objects, they generally do not use [CF\_HDROP](clipboard.md).</span></span>

<span data-ttu-id="1a529-366">Invece di [CF \_ HDROP](clipboard.md), i dati vengono normalmente trasferiti dalle cartelle virtuali con i formati [CFSTR \_ FileDescriptor](clipboard.md) / [CFSTR \_ fileContents](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-366">Instead of [CF\_HDROP](clipboard.md), data is normally transferred from virtual folders with the [CFSTR\_FILEDESCRIPTOR](clipboard.md)/[CFSTR\_FILECONTENTS](clipboard.md) formats.</span></span> <span data-ttu-id="1a529-367">Il [formato \_ fileContents di CFSTR](clipboard.md) presenta due vantaggi rispetto a [CF \_ HDROP](clipboard.md):</span><span class="sxs-lookup"><span data-stu-id="1a529-367">The [CFSTR\_FILECONTENTS](clipboard.md) format has two advantages over [CF\_HDROP](clipboard.md):</span></span>

-   <span data-ttu-id="1a529-368">Non viene presupposto alcun metodo specifico di archiviazione dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-368">No particular method of data storage is assumed.</span></span>
-   <span data-ttu-id="1a529-369">Il formato è più flessibile.</span><span class="sxs-lookup"><span data-stu-id="1a529-369">The format is more flexible.</span></span> <span data-ttu-id="1a529-370">Supporta tre meccanismi di trasferimento dei dati: un oggetto memoria globale, un'interfaccia [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) o un'interfaccia [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) .</span><span class="sxs-lookup"><span data-stu-id="1a529-370">It supports three data transfer mechanisms: a global memory object, an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface, or an [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) interface.</span></span>

<span data-ttu-id="1a529-371">Gli oggetti memoria globale vengono utilizzati raramente per trasferire dati da o verso oggetti virtuali, in quanto i dati devono essere copiati interamente in memoria.</span><span class="sxs-lookup"><span data-stu-id="1a529-371">Global memory objects are rarely used to transfer data to or from virtual objects because the data must be copied into memory in its entirety.</span></span> <span data-ttu-id="1a529-372">Il trasferimento di un puntatore a interfaccia richiede quasi nessuna memoria ed è molto più efficiente.</span><span class="sxs-lookup"><span data-stu-id="1a529-372">Transferring an interface pointer requires almost no memory and is much more efficient.</span></span> <span data-ttu-id="1a529-373">Con file di grandi dimensioni, un puntatore di interfaccia potrebbe essere l'unico meccanismo pratico di trasferimento dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-373">With very large files, an interface pointer might be the only practical data transfer mechanism.</span></span> <span data-ttu-id="1a529-374">In genere, i dati sono rappresentati da un puntatore [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) , perché tale interfaccia è leggermente più flessibile rispetto a [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span><span class="sxs-lookup"><span data-stu-id="1a529-374">Typically, data is represented by an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) pointer, because that interface is somewhat more flexible than [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage).</span></span> <span data-ttu-id="1a529-375">La destinazione estrae il puntatore dall'oggetto dati e utilizza i metodi di interfaccia per estrarre i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-375">The target extracts the pointer from the data object and uses the interface methods to extract the data.</span></span>

<span data-ttu-id="1a529-376">Per ulteriori informazioni su come gestire i formati [CFSTR \_ FileDescriptor](clipboard.md) / [CFSTR \_ fileContents](clipboard.md) , vedere l'articolo relativo all' [utilizzo del \_ formato fileContents di CFSTR per estrarre i dati da un file](/windows).</span><span class="sxs-lookup"><span data-stu-id="1a529-376">For further discussion of how to handle the [CFSTR\_FILEDESCRIPTOR](clipboard.md)/[CFSTR\_FILECONTENTS](clipboard.md) formats, see [Using the CFSTR\_FILECONTENTS Format to Extract Data from a File](/windows).</span></span>

### <a name="transferring-data-to-and-from-a-namespace-extension"></a><span data-ttu-id="1a529-377">Trasferimento di dati da e verso un'estensione dello spazio dei nomi</span><span class="sxs-lookup"><span data-stu-id="1a529-377">Transferring Data to and from a NameSpace Extension</span></span>

<span data-ttu-id="1a529-378">Quando si implementa un'estensione dello spazio dei nomi, in genere si vogliono supportare le funzionalità di trascinamento della selezione.</span><span class="sxs-lookup"><span data-stu-id="1a529-378">When you implement a namespace extension, you will normally want to support drag-and-drop capabilities.</span></span> <span data-ttu-id="1a529-379">Seguire le indicazioni per eliminare le origini e le destinazioni descritte in [linee guida generali](#general-guidelines).</span><span class="sxs-lookup"><span data-stu-id="1a529-379">Follow the recommendations for drop sources and targets discussed in [General Guidelines](#general-guidelines).</span></span> <span data-ttu-id="1a529-380">In particolare, un'estensione dello spazio dei nomi deve:</span><span class="sxs-lookup"><span data-stu-id="1a529-380">In particular, a namespace extension must:</span></span>

-   <span data-ttu-id="1a529-381">Essere in grado di gestire i formati [CFSTR \_ FileDescriptor](clipboard.md) / [CFSTR \_ fileContents](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-381">Be able to handle the [CFSTR\_FILEDESCRIPTOR](clipboard.md)/[CFSTR\_FILECONTENTS](clipboard.md) formats.</span></span> <span data-ttu-id="1a529-382">Questi due formati vengono in genere utilizzati per trasferire oggetti da e verso le estensioni dello spazio dei nomi.</span><span class="sxs-lookup"><span data-stu-id="1a529-382">These two formats are normally used to transfer objects to and from namespace extensions.</span></span>
-   <span data-ttu-id="1a529-383">Essere in grado di gestire gli [spostamenti ottimizzati](#handling-optimized-move-operations).</span><span class="sxs-lookup"><span data-stu-id="1a529-383">Be able to handle [optimized moves](#handling-optimized-move-operations).</span></span> <span data-ttu-id="1a529-384">La shell prevede che gli oggetti Shell verranno spostati con uno spostamento ottimizzato.</span><span class="sxs-lookup"><span data-stu-id="1a529-384">The Shell expects that Shell objects will be moved with an optimized move.</span></span>
-   <span data-ttu-id="1a529-385">Essere in grado di gestire un'operazione di [eliminazione su Incolla](#handling-delete-on-paste-operations) .</span><span class="sxs-lookup"><span data-stu-id="1a529-385">Be able to handle a [delete-on-paste](#handling-delete-on-paste-operations) operation.</span></span> <span data-ttu-id="1a529-386">La shell USA Delete-on-paste quando gli oggetti vengono spostati dalla shell con un'operazione Taglia/Incolla.</span><span class="sxs-lookup"><span data-stu-id="1a529-386">The Shell uses delete-on-paste when objects are moved from the Shell with a cut/paste operation.</span></span>
-   <span data-ttu-id="1a529-387">Essere in grado di gestire il trasferimento dei dati tramite un'interfaccia [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) o [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) .</span><span class="sxs-lookup"><span data-stu-id="1a529-387">Be able to handle data transfer through an [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) or [**IStorage**](/windows/win32/api/objidl/nn-objidl-istorage) interface.</span></span> <span data-ttu-id="1a529-388">Il trasferimento dei dati da o verso una cartella virtuale viene normalmente gestito trasferendo uno di questi due puntatori di interfaccia, in genere un puntatore **IStream** .</span><span class="sxs-lookup"><span data-stu-id="1a529-388">Data transfer to or from a virtual folder is normally handled by transferring one of these two interface pointers, typically an **IStream** pointer.</span></span> <span data-ttu-id="1a529-389">La destinazione chiama quindi i metodi di interfaccia per estrarre i dati:</span><span class="sxs-lookup"><span data-stu-id="1a529-389">The target then calls the interface methods to extract the data:</span></span>
    -   -   <span data-ttu-id="1a529-390">Come origine di rilascio, l'estensione dello spazio dei nomi deve estrarre i dati dall'archivio e passarli attraverso questa interfaccia alla destinazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-390">As a drop source, the namespace extension must extract the data from storage and pass it through this interface to the target.</span></span>
        -   <span data-ttu-id="1a529-391">Come destinazione di rilascio, un'estensione dello spazio dei nomi deve accettare i dati da un'origine tramite questa interfaccia e archiviarli in modo corretto.</span><span class="sxs-lookup"><span data-stu-id="1a529-391">As a drop target, a namespace extension must accept data from a source through this interface and store it properly.</span></span>

## <a name="dropping-files-on-the-recycle-bin"></a><span data-ttu-id="1a529-392">Eliminazione di file nel cestino</span><span class="sxs-lookup"><span data-stu-id="1a529-392">Dropping Files on the Recycle Bin</span></span>

<span data-ttu-id="1a529-393">**Scenario:** L'utente rilascia un file nel **Cestino**.</span><span class="sxs-lookup"><span data-stu-id="1a529-393">**Scenario:** The user drops a file on the **Recycle Bin**.</span></span> <span data-ttu-id="1a529-394">L'estensione dell'applicazione o dello spazio dei nomi elimina il file originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-394">Your application or namespace extension deletes the original file.</span></span>

<span data-ttu-id="1a529-395">Il cestino è una cartella virtuale che viene usata come repository per i file che non sono più necessari.</span><span class="sxs-lookup"><span data-stu-id="1a529-395">The Recycle Bin is a virtual folder that is used as a repository for files that are no longer needed.</span></span> <span data-ttu-id="1a529-396">Fino a quando il cestino non è stato svuotato, l'utente può recuperare il file in un secondo momento e restituirlo alla file system.</span><span class="sxs-lookup"><span data-stu-id="1a529-396">As long as the Recycle Bin has not been emptied, the user can later recover the file and return it to the file system.</span></span>

<span data-ttu-id="1a529-397">Per la maggior parte, il trasferimento di oggetti Shell al cestino funziona in modo analogo a qualsiasi altra cartella.</span><span class="sxs-lookup"><span data-stu-id="1a529-397">For the most part, transferring Shell objects to the Recycle Bin works much like any other folder.</span></span> <span data-ttu-id="1a529-398">Tuttavia, quando un utente rilascia un file nel **Cestino**, l'origine deve eliminare l'originale, anche se il feedback della cartella indica un'operazione di copia.</span><span class="sxs-lookup"><span data-stu-id="1a529-398">However, when a user drops a file on the **Recycle Bin**, the source needs to delete the original, even if the feedback from the folder indicates a copy operation.</span></span> <span data-ttu-id="1a529-399">In genere, un'origine di rilascio non è in grado di conoscere la cartella in cui è stato rilasciato l'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-399">Normally, a drop source has no way of knowing which folder its data object has been dropped on.</span></span> <span data-ttu-id="1a529-400">Tuttavia, per i sistemi Windows 2000 e versioni successive, quando un oggetto dati viene rilasciato nel **Cestino**, la shell chiamerà il metodo [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) dell'oggetto dati con un formato [CFSTR \_ TARGETCLSID](clipboard.md) impostato sull'identificatore di classe (CLSID) del cestino (CLSID \_ RecycleBin).</span><span class="sxs-lookup"><span data-stu-id="1a529-400">However, for Windows 2000 and later systems, when a data object is dropped on the **Recycle Bin**, the Shell will call the data object's [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) method with a [CFSTR\_TARGETCLSID](clipboard.md) format set to the Recycle Bin's class identifier (CLSID) (CLSID\_RecycleBin).</span></span> <span data-ttu-id="1a529-401">Per gestire correttamente il case del cestino, l'oggetto dati deve essere in grado di riconoscere questo formato e comunicare le informazioni all'origine tramite un'interfaccia privata.</span><span class="sxs-lookup"><span data-stu-id="1a529-401">To handle the Recycle Bin case properly, your data object should be able to recognize this format and communicate the information to the source through a private interface.</span></span>

> [!Note]  
> <span data-ttu-id="1a529-402">Quando [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) viene chiamato con un formato [CFSTR \_ TARGETCLSID](clipboard.md) impostato su CLSID \_ RecycleBin, l'origine dati deve chiudere tutti gli handle aperti per gli oggetti che vengono trasferiti prima di restituire dal metodo.</span><span class="sxs-lookup"><span data-stu-id="1a529-402">When [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) is called with a [CFSTR\_TARGETCLSID](clipboard.md) format set to CLSID\_RecycleBin, the data source should close any open handles to the objects that are being transferred before returning from the method.</span></span> <span data-ttu-id="1a529-403">In caso contrario, è possibile creare violazioni di condivisione.</span><span class="sxs-lookup"><span data-stu-id="1a529-403">Otherwise, you might create sharing violations.</span></span>

 

## <a name="creating-and-importing-scrap-files"></a><span data-ttu-id="1a529-404">Creazione e importazione di file di scarto</span><span class="sxs-lookup"><span data-stu-id="1a529-404">Creating and Importing Scrap Files</span></span>

<span data-ttu-id="1a529-405">**Scenario:** Un utente trascina alcuni dati dal file di dati di un'applicazione OLE e li rilascia sul desktop o su Esplora risorse.</span><span class="sxs-lookup"><span data-stu-id="1a529-405">**Scenario:** A user drags some data from an OLE application's data file and drops it on the desktop or Windows Explorer.</span></span>

<span data-ttu-id="1a529-406">Windows consente agli utenti di trascinare un oggetto dal file di dati di un'applicazione OLE e di rilasciarlo sul desktop o in una cartella file system.</span><span class="sxs-lookup"><span data-stu-id="1a529-406">Windows allows users to drag an object from an OLE application's data file and drop it on the desktop or a file system folder.</span></span> <span data-ttu-id="1a529-407">Questa operazione crea un *file di frammento* che contiene i dati o un collegamento ai dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-407">This operation creates a *scrap file*, which contains the data or a link to the data.</span></span> <span data-ttu-id="1a529-408">Il nome del file viene tratto dal nome breve registrato per il CLSID dell'oggetto e i dati [di \_ testo CF](clipboard.md) .</span><span class="sxs-lookup"><span data-stu-id="1a529-408">The file name is taken from the short name registered for the CLSID of the object and the [CF\_TEXT](clipboard.md) data.</span></span> <span data-ttu-id="1a529-409">Per la creazione di un file di frammento contenente i dati da parte della shell, l'interfaccia [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) dell'applicazione deve supportare il \_ formato degli Appunti EMBEDSOURCE di CF.</span><span class="sxs-lookup"><span data-stu-id="1a529-409">For the Shell to create a scrap file containing data, the application's [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface must support the CF\_EMBEDSOURCE Clipboard format.</span></span> <span data-ttu-id="1a529-410">Per creare un file contenente un collegamento, **IDataObject** deve supportare il \_ formato CF LINKSOURCE.</span><span class="sxs-lookup"><span data-stu-id="1a529-410">To create a file containing a link, **IDataObject** must support the CF\_LINKSOURCE format.</span></span>

<span data-ttu-id="1a529-411">Sono inoltre disponibili tre funzionalità facoltative che un'applicazione può implementare per supportare i file di scarto:</span><span class="sxs-lookup"><span data-stu-id="1a529-411">There are also three optional features that an application can implement to support scrap files:</span></span>

-   <span data-ttu-id="1a529-412">Supporto round trip</span><span class="sxs-lookup"><span data-stu-id="1a529-412">Round-trip support</span></span>
-   <span data-ttu-id="1a529-413">Formati di dati memorizzati nella cache</span><span class="sxs-lookup"><span data-stu-id="1a529-413">Cached data formats</span></span>
-   <span data-ttu-id="1a529-414">Rendering ritardato</span><span class="sxs-lookup"><span data-stu-id="1a529-414">Delayed rendering</span></span>

### <a name="round-trip-support"></a><span data-ttu-id="1a529-415">Supporto round trip</span><span class="sxs-lookup"><span data-stu-id="1a529-415">Round-trip Support</span></span>

<span data-ttu-id="1a529-416">Un *round trip* comporta il trasferimento di un oggetto dati in un altro contenitore e quindi di nuovo al documento originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-416">A *round trip* involves transferring a data object to another container and then back to the original document.</span></span> <span data-ttu-id="1a529-417">Ad esempio, un utente può trasferire un gruppo di celle da un foglio di calcolo al desktop, creando un file di scarto con i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-417">For instance, a user could transfer a group of cells from a spreadsheet to the desktop, creating a scrap file with the data.</span></span> <span data-ttu-id="1a529-418">Se l'utente trasferisce di nuovo il frammento al foglio di calcolo, è necessario integrare i dati nel documento come prima del trasferimento originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-418">If the user then transfers the scrap back to the spreadsheet, the data needs to be integrated into the document as it was before the original transfer.</span></span>

<span data-ttu-id="1a529-419">Quando la shell crea il file di scarto, rappresenta i dati come un oggetto di incorporamento.</span><span class="sxs-lookup"><span data-stu-id="1a529-419">When the Shell creates the scrap file, it represents the data as an embedding object.</span></span> <span data-ttu-id="1a529-420">Quando lo scarto viene trasferito in un altro contenitore, viene trasferito come oggetto di incorporamento, anche se viene restituito al documento originale.</span><span class="sxs-lookup"><span data-stu-id="1a529-420">When the scrap is transferred to another container, it is transferred as an embedding object, even if it is being returned to the original document.</span></span> <span data-ttu-id="1a529-421">L'applicazione è responsabile della determinazione del formato dati contenuto nel frammento e della restituzione dei dati nel formato nativo, se necessario.</span><span class="sxs-lookup"><span data-stu-id="1a529-421">Your application is responsible for determining the data format contained in the scrap and putting the data back into its native format if necessary.</span></span>

<span data-ttu-id="1a529-422">Per stabilire il formato dell'oggetto incorporato, determinare il relativo CLSID recuperando il formato CF OBJECTDESCRIPTOR dell'oggetto \_ .</span><span class="sxs-lookup"><span data-stu-id="1a529-422">To establish the format of the embedded object, determine its CLSID by retrieving the object's CF\_OBJECTDESCRIPTOR format.</span></span> <span data-ttu-id="1a529-423">Se il CLSID indica un formato di dati appartenente all'applicazione, deve trasferire i dati nativi anziché chiamare [**OleCreateFromData**](/windows/win32/api/ole2/nf-ole2-olecreatefromdata).</span><span class="sxs-lookup"><span data-stu-id="1a529-423">If the CLSID indicates a data format that belongs to the application, it should transfer the native data instead of calling [**OleCreateFromData**](/windows/win32/api/ole2/nf-ole2-olecreatefromdata).</span></span>

### <a name="cached-data-formats"></a><span data-ttu-id="1a529-424">Formati di dati memorizzati nella cache</span><span class="sxs-lookup"><span data-stu-id="1a529-424">Cached Data Formats</span></span>

<span data-ttu-id="1a529-425">Quando la shell crea un file di scarto, verifica il registro di sistema per l'elenco dei formati disponibili.</span><span class="sxs-lookup"><span data-stu-id="1a529-425">When the Shell creates a scrap file, it checks the registry for the list of available formats.</span></span> <span data-ttu-id="1a529-426">Per impostazione predefinita, sono disponibili due formati: CF \_ EMBEDSOURCE e CF \_ LINKSOURCE.</span><span class="sxs-lookup"><span data-stu-id="1a529-426">By default, there are two formats available: CF\_EMBEDSOURCE and CF\_LINKSOURCE.</span></span> <span data-ttu-id="1a529-427">Esistono tuttavia diversi scenari in cui è possibile che le applicazioni debbano includere file di scarto in formati diversi:</span><span class="sxs-lookup"><span data-stu-id="1a529-427">However, there are a number of scenarios where applications might need to have scrap files in different formats:</span></span>

-   <span data-ttu-id="1a529-428">Per consentire il trasferimento degli sfridi a contenitori non OLE, che non possono accettare formati di oggetti incorporati.</span><span class="sxs-lookup"><span data-stu-id="1a529-428">To allow scraps to be transferred to non-OLE containers, which cannot accepted embedded object formats.</span></span>
-   <span data-ttu-id="1a529-429">Per consentire ai gruppi di applicazioni di comunicare con un formato privato.</span><span class="sxs-lookup"><span data-stu-id="1a529-429">To allow suites of applications to communicate with a private format.</span></span>
-   <span data-ttu-id="1a529-430">Per semplificare la gestione di round trip.</span><span class="sxs-lookup"><span data-stu-id="1a529-430">To make round trips easier to handle.</span></span>

<span data-ttu-id="1a529-431">Le applicazioni possono aggiungere formati al frammento tramite la memorizzazione nella cache nel registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="1a529-431">Applications can add formats to the scrap by caching them in the registry.</span></span> <span data-ttu-id="1a529-432">Esistono due tipi di formati memorizzati nella cache:</span><span class="sxs-lookup"><span data-stu-id="1a529-432">There are two types of cached formats:</span></span>

-   <span data-ttu-id="1a529-433">Formati di cache con priorità.</span><span class="sxs-lookup"><span data-stu-id="1a529-433">Priority cache formats.</span></span> <span data-ttu-id="1a529-434">Per questi formati, i dati vengono copiati integralmente nello scarto dall'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-434">For these formats, the data is copied in its entirety into the scrap from the data object.</span></span>
-   <span data-ttu-id="1a529-435">Formati con rendering ritardato.</span><span class="sxs-lookup"><span data-stu-id="1a529-435">Delay-rendered formats.</span></span> <span data-ttu-id="1a529-436">Per questi formati, l'oggetto dati non viene copiato nel frammento.</span><span class="sxs-lookup"><span data-stu-id="1a529-436">For these formats, the data object is not copied to the scrap.</span></span> <span data-ttu-id="1a529-437">Il rendering viene invece posticipato fino a quando una destinazione non richiede i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-437">Instead, rendering is delayed until a target requests the data.</span></span> <span data-ttu-id="1a529-438">Il rendering ritardato viene illustrato più dettagliatamente nella sezione successiva.</span><span class="sxs-lookup"><span data-stu-id="1a529-438">Delay-rendering is discussed in more detail in the next section.</span></span>

<span data-ttu-id="1a529-439">Per aggiungere una cache con priorità o un formato con rendering ritardato, creare una sottochiave **DataFormat** sotto la chiave **CLSID** dell'applicazione che rappresenta l'origine dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-439">To add a priority cache or delay-rendered format, create a **DataFormat** subkey under the **CLSID** key of the application that is the source of the data.</span></span> <span data-ttu-id="1a529-440">In tale sottochiave creare una sottochiave **PriorityCacheFormats** o **DelayRenderFormats** .</span><span class="sxs-lookup"><span data-stu-id="1a529-440">Under that subkey, create a **PriorityCacheFormats** or **DelayRenderFormats** subkey.</span></span> <span data-ttu-id="1a529-441">Per ogni cache con priorità o il formato con rendering ritardato, creare una sottochiave numerata a partire da zero.</span><span class="sxs-lookup"><span data-stu-id="1a529-441">For each priority cache or delay-rendered format, create a numbered subkey starting with zero.</span></span> <span data-ttu-id="1a529-442">Impostare il valore di questa chiave su una stringa con il nome registrato del formato o un \# valore x, dove x rappresenta il numero del formato degli Appunti standard.</span><span class="sxs-lookup"><span data-stu-id="1a529-442">Set the value of this key to either a string with the registered name of the format or a \#X value, where X represents the format number of a standard Clipboard format.</span></span>

<span data-ttu-id="1a529-443">Nell'esempio seguente vengono illustrati i formati memorizzati nella cache per due applicazioni.</span><span class="sxs-lookup"><span data-stu-id="1a529-443">The following sample shows cached formats for two applications.</span></span> <span data-ttu-id="1a529-444">L'applicazione MyProg1 ha il formato Rich Text come formato della cache prioritario e un formato privato "My Format" come formato con rendering ritardato.</span><span class="sxs-lookup"><span data-stu-id="1a529-444">The MyProg1 application has the rich-text format as a priority cache format, and a private format "My Format" as a delay-rendered format.</span></span> <span data-ttu-id="1a529-445">L'applicazione MyProg2 ha il \_ formato bitmap CF ( \# 8 ") come formato di cache prioritario.</span><span class="sxs-lookup"><span data-stu-id="1a529-445">The MyProg2 application has the CF\_BITMAP format (\#8") as a priority cache format.</span></span>

```
HKEY_CLASSES_ROOT
   CLSID
      {GUID}
         (Default) = MyProg1
         DataFormats
            PriorityCacheFormats
               0
                  (Default) = Rich Text Format
            DelayRenderFormats
               0
                  (Default) = My Format
      {GUID}
         (Default) = MyProg2
         DataFormats
            PriorityCacheFormats
               0
                  (Default) = #8
```

<span data-ttu-id="1a529-446">È possibile aggiungere formati aggiuntivi creando sottochiavi numerate aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="1a529-446">Additional formats can be added by creating additional numbered subkeys.</span></span>

### <a name="delayed-rendering"></a><span data-ttu-id="1a529-447">Rendering ritardato</span><span class="sxs-lookup"><span data-stu-id="1a529-447">Delayed Rendering</span></span>

<span data-ttu-id="1a529-448">Un formato di rendering ritardato consente a un'applicazione di creare un file di scarto, ma ritardare i costi di rendering dei dati fino a quando non vengono richiesti da una destinazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-448">A delayed rendering format allows an application to create a scrap file but delay the expense of rendering the data until it is requested by a target.</span></span> <span data-ttu-id="1a529-449">L'interfaccia [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) di un frammento offrirà i formati di rendering ritardati alla destinazione insieme ai dati nativi e memorizzati nella cache.</span><span class="sxs-lookup"><span data-stu-id="1a529-449">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) interface of a scrap will offer the delayed rendering formats to the target along with native and cached data.</span></span> <span data-ttu-id="1a529-450">Se la destinazione richiede un formato di rendering ritardato, la shell eseguirà l'applicazione e fornirà i dati alla destinazione dall'oggetto attivo.</span><span class="sxs-lookup"><span data-stu-id="1a529-450">If the target requests a delayed rendering format, the Shell will run the application and provide the data to the target from the active object.</span></span>

> [!Note]  
> <span data-ttu-id="1a529-451">Poiché il rendering ritardato è piuttosto rischioso, è consigliabile utilizzarlo con cautela.</span><span class="sxs-lookup"><span data-stu-id="1a529-451">Because delayed rendering is somewhat risky, it should be used with caution.</span></span> <span data-ttu-id="1a529-452">Non funzionerà se il server non è disponibile o se le applicazioni non sono abilitate per OLE.</span><span class="sxs-lookup"><span data-stu-id="1a529-452">It will not work if the server is not available, or on applications that are not OLE-enabled.</span></span>

 

## <a name="dragging-and-dropping-shell-objects-asynchronously"></a><span data-ttu-id="1a529-453">Trascinamento e rilascio di oggetti Shell in modo asincrono</span><span class="sxs-lookup"><span data-stu-id="1a529-453">Dragging and Dropping Shell Objects Asynchronously</span></span>

<span data-ttu-id="1a529-454">**Scenario:** Un utente trasferisce un blocco di dati di grandi dimensioni dall'origine alla destinazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-454">**Scenario:** A user transfers a large block of data from source to target.</span></span> <span data-ttu-id="1a529-455">Per evitare di bloccare entrambe le applicazioni per un periodo di tempo significativo, la destinazione estrae i dati in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="1a529-455">To avoid blocking both applications for a significant amount of time, the target extracts the data asynchronously.</span></span>

<span data-ttu-id="1a529-456">In genere, il trascinamento della selezione è un'operazione sincrona.</span><span class="sxs-lookup"><span data-stu-id="1a529-456">Normally, drag-and-drop is a synchronous operation.</span></span> <span data-ttu-id="1a529-457">In breve:</span><span class="sxs-lookup"><span data-stu-id="1a529-457">In brief:</span></span>

1.  <span data-ttu-id="1a529-458">L'origine di rilascio chiama [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) e blocca il thread primario finché la funzione non restituisce.</span><span class="sxs-lookup"><span data-stu-id="1a529-458">The drop source calls [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) and blocks its primary thread until the function returns.</span></span> <span data-ttu-id="1a529-459">Il blocco del thread primario normalmente blocca l'elaborazione dell'interfaccia utente.</span><span class="sxs-lookup"><span data-stu-id="1a529-459">Blocking the primary thread normally blocks UI processing.</span></span>
2.  <span data-ttu-id="1a529-460">Dopo la chiamata al metodo [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) della destinazione, la destinazione estrae i dati dall'oggetto dati nel relativo thread primario.</span><span class="sxs-lookup"><span data-stu-id="1a529-460">After the target's [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) method is called, the target extracts the data from the data object on its primary thread.</span></span> <span data-ttu-id="1a529-461">Questa procedura blocca in genere l'elaborazione dell'interfaccia utente della destinazione per la durata del processo di estrazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-461">This procedure normally blocks the target's UI processing for the duration of the extraction process.</span></span>
3.  <span data-ttu-id="1a529-462">Una volta estratti i dati, la destinazione restituisce la chiamata di [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) , il sistema restituisce [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop)ed entrambi i thread possono continuare.</span><span class="sxs-lookup"><span data-stu-id="1a529-462">Once the data has been extracted, the target returns the [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) call, the system returns [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop), and both threads can proceed.</span></span>

<span data-ttu-id="1a529-463">In breve, il trasferimento di dati sincrono può bloccare i thread primari di entrambe le applicazioni per un periodo di tempo significativo.</span><span class="sxs-lookup"><span data-stu-id="1a529-463">In short, synchronous data transfer can block the primary threads of both applications for a significant amount of time.</span></span> <span data-ttu-id="1a529-464">In particolare, entrambi i thread devono attendere mentre la destinazione estrae i dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-464">In particular, both threads must wait while the target extracts the data.</span></span> <span data-ttu-id="1a529-465">Per piccole quantità di dati, il tempo necessario per estrarre i dati è ridotto e il trasferimento dei dati sincrono funziona correttamente.</span><span class="sxs-lookup"><span data-stu-id="1a529-465">For small amounts of data, the time required to extract data is small and synchronous data transfer works quite well.</span></span> <span data-ttu-id="1a529-466">Tuttavia, l'estrazione sincrona di grandi quantità di dati può causare ritardi lunghi e interferire con l'interfaccia utente di destinazione e di origine.</span><span class="sxs-lookup"><span data-stu-id="1a529-466">However, synchronously extracting large amounts of data can cause lengthy delays and interfere with the UI of both target and source.</span></span>

<span data-ttu-id="1a529-467">L' [](/previous-versions//bb776309(v=vs.85)) / interfaccia [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) di IAsyncOperation è un'interfaccia facoltativa che può essere implementata da un oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-467">The [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) interface is an optional interface that can be implemented by a data object.</span></span> <span data-ttu-id="1a529-468">Fornisce alla destinazione di rilascio la possibilità di estrarre i dati dall'oggetto dati in modo asincrono in un thread in background.</span><span class="sxs-lookup"><span data-stu-id="1a529-468">It gives the drop target the ability to extract data from the data object asynchronously on a background thread.</span></span> <span data-ttu-id="1a529-469">Quando l'estrazione dei dati viene passata al thread in background, i thread primari di entrambe le applicazioni sono liberi di continuare.</span><span class="sxs-lookup"><span data-stu-id="1a529-469">Once data extraction is handed off to the background thread, the primary threads of both applications are free to proceed.</span></span>

### <a name="using-iasyncoperationidataobjectasynccapability"></a><span data-ttu-id="1a529-470">Uso di IASyncOperation/IDataObjectAsyncCapability</span><span class="sxs-lookup"><span data-stu-id="1a529-470">Using IASyncOperation/IDataObjectAsyncCapability</span></span>

> [!Note]  
> <span data-ttu-id="1a529-471">L'interfaccia era originariamente denominata [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)), ma in seguito è stata modificata in [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span><span class="sxs-lookup"><span data-stu-id="1a529-471">The interface was originally named [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)), but this was later changed to [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span></span> <span data-ttu-id="1a529-472">In caso contrario, le due interfacce sono identiche.</span><span class="sxs-lookup"><span data-stu-id="1a529-472">Otherwise, the two interfaces are identical.</span></span>

 

<span data-ttu-id="1a529-473">Lo scopo di [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) è consentire all'origine di rilascio e alla destinazione di rilascio di negoziare se i dati possono essere estratti in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="1a529-473">The purpose of [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) is to allow the drop source and drop target to negotiate whether data can be extracted asynchronously.</span></span> <span data-ttu-id="1a529-474">La procedura seguente illustra il modo in cui l'origine di rilascio usa l'interfaccia:</span><span class="sxs-lookup"><span data-stu-id="1a529-474">The following procedure outlines how the drop source uses the interface:</span></span>

1.  <span data-ttu-id="1a529-475">Creare un oggetto dati che espone [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span><span class="sxs-lookup"><span data-stu-id="1a529-475">Create a data object that exposes [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability).</span></span>
2.  <span data-ttu-id="1a529-476">Chiamare [**SetAsyncMode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-setasyncmode) con *FDoOpAsync* impostato su **Variant \_ true** per indicare che è supportata un'operazione asincrona.</span><span class="sxs-lookup"><span data-stu-id="1a529-476">Call [**SetAsyncMode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-setasyncmode) with *fDoOpAsync* set to **VARIANT\_TRUE** to indicate that an asynchronous operation is supported.</span></span>
3.  <span data-ttu-id="1a529-477">Dopo la restituzione di [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) , chiamare [**inOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation):</span><span class="sxs-lookup"><span data-stu-id="1a529-477">After [**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) returns, call [**InOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation):</span></span>
    -   <span data-ttu-id="1a529-478">Se l' [**inattività**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) ha esito negativo o restituisce un valore **Variant \_ false**, viene eseguito un normale trasferimento dati sincrono e il processo di estrazione dei dati è terminato.</span><span class="sxs-lookup"><span data-stu-id="1a529-478">If [**InOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) fails or returns **VARIANT\_FALSE**, a normal synchronous data transfer has taken place and the data extraction process is finished.</span></span> <span data-ttu-id="1a529-479">L'origine deve eseguire la pulizia richiesta e continuare.</span><span class="sxs-lookup"><span data-stu-id="1a529-479">The source should do any cleanup that is required, and proceed.</span></span>
    -   <span data-ttu-id="1a529-480">Se [**Inoperate**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) restituisce la **variante \_ true**, i dati vengono estratti in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="1a529-480">If [**InOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-inoperation) returns **VARIANT\_TRUE**, the data is being extracted asynchronously.</span></span> <span data-ttu-id="1a529-481">Le operazioni di pulizia devono essere gestite da [**EndOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span><span class="sxs-lookup"><span data-stu-id="1a529-481">Cleanup operations should be handled by [**EndOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span></span>
4.  <span data-ttu-id="1a529-482">Rilasciare l'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-482">Release the data object.</span></span>
5.  <span data-ttu-id="1a529-483">Al termine del trasferimento asincrono dei dati, l'oggetto dati notifica normalmente l'origine tramite un'interfaccia privata.</span><span class="sxs-lookup"><span data-stu-id="1a529-483">When the asynchronous data transfer is complete, the data object normally notifies the source through a private interface.</span></span>

<span data-ttu-id="1a529-484">La procedura seguente illustra come la destinazione di rilascio usa l'interfaccia [](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) di IAsyncOperation per estrarre i dati in modo asincrono:</span><span class="sxs-lookup"><span data-stu-id="1a529-484">The following procedure outlines how the drop target uses the [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) interface to extract data asynchronously:</span></span>

1.  <span data-ttu-id="1a529-485">Quando il sistema chiama [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop), chiamare [**IDataObject:: QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) e richiedere un'interfaccia [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85)) / [**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) (IID \_ IAsyncOperation/IID \_ IDataObjectAsyncCapability) dall'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-485">When the system calls [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop), call [**IDataObject::QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) and request an [**IAsyncOperation**](/previous-versions//bb776309(v=vs.85))/[**IDataObjectAsyncCapability**](/windows/desktop/api/Shldisp/nn-shldisp-idataobjectasynccapability) interface (IID\_IAsyncOperation/IID\_IDataObjectAsyncCapability) from the data object.</span></span>
2.  <span data-ttu-id="1a529-486">Chiamare [**GetAsyncMode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-getasyncmode).</span><span class="sxs-lookup"><span data-stu-id="1a529-486">Call [**GetAsyncMode**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-getasyncmode).</span></span> <span data-ttu-id="1a529-487">Se il metodo restituisce il valore **Variant \_ true**, l'oggetto dati supporta l'estrazione asincrona dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-487">If the method returns **VARIANT\_TRUE**, the data object supports asynchronous data extraction.</span></span>
3.  <span data-ttu-id="1a529-488">Creare un thread separato per gestire l'estrazione dei dati e chiamare [**StartOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-startoperation).</span><span class="sxs-lookup"><span data-stu-id="1a529-488">Create a separate thread to handle data extraction and call [**StartOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-startoperation).</span></span>
4.  <span data-ttu-id="1a529-489">Restituire la chiamata di [**IDropTarget::D por**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) , come per una normale operazione di trasferimento dei dati.</span><span class="sxs-lookup"><span data-stu-id="1a529-489">Return the [**IDropTarget::Drop**](/windows/win32/api/oleidl/nf-oleidl-idroptarget-drop) call, as you would for a normal data transfer operation.</span></span> <span data-ttu-id="1a529-490">[**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) restituirà e sblocca l'origine di rilascio.</span><span class="sxs-lookup"><span data-stu-id="1a529-490">[**DoDragDrop**](/windows/win32/api/ole2/nf-ole2-dodragdrop) will return and unblock the drop source.</span></span> <span data-ttu-id="1a529-491">Non chiamare [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) per indicare il risultato di un'operazione di spostamento o eliminazione su Incolla ottimizzata.</span><span class="sxs-lookup"><span data-stu-id="1a529-491">Do not call [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) to indicate the outcome of an optimized move or delete-on-paste operation.</span></span> <span data-ttu-id="1a529-492">Attendere il completamento dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="1a529-492">Wait until the operation is finished.</span></span>
5.  <span data-ttu-id="1a529-493">Estrarre i dati nel thread in background.</span><span class="sxs-lookup"><span data-stu-id="1a529-493">Extract the data on the background thread.</span></span> <span data-ttu-id="1a529-494">Il thread primario della destinazione è sbloccato e può continuare.</span><span class="sxs-lookup"><span data-stu-id="1a529-494">The target's primary thread is unblocked and free to proceed.</span></span>
6.  <span data-ttu-id="1a529-495">Se il trasferimento dei dati era un'operazione di spostamento o [eliminazione su Incolla](#handling-delete-on-paste-operations) [ottimizzata](#handling-optimized-move-operations) , chiamare [**IDataObject:: SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) per indicare il risultato.</span><span class="sxs-lookup"><span data-stu-id="1a529-495">If the data transfer was an [optimized move](#handling-optimized-move-operations) or [delete-on-paste](#handling-delete-on-paste-operations) operation, call [**IDataObject::SetData**](/windows/win32/api/objidl/nf-objidl-idataobject-setdata) to indicate the outcome.</span></span>
7.  <span data-ttu-id="1a529-496">Notificare all'oggetto dati che l'estrazione è stata completata chiamando [**EndOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span><span class="sxs-lookup"><span data-stu-id="1a529-496">Notify the data object that extraction is finished by calling [**EndOperation**](/windows/desktop/api/Shldisp/nf-shldisp-idataobjectasynccapability-endoperation).</span></span>

 

 
