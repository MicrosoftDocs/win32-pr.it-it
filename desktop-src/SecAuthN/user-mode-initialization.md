---
description: Le applicazioni distribuite (client/server) utilizzano i pacchetti di sicurezza per ottenere connessioni autenticate e scambiare messaggi.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Inizializzazione della modalità utente
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "103968084"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="6c72f-103">Inizializzazione della modalità utente</span><span class="sxs-lookup"><span data-stu-id="6c72f-103">User Mode Initialization</span></span>

<span data-ttu-id="6c72f-104">Le applicazioni distribuite (client/server) utilizzano i [*pacchetti di sicurezza*](../secgloss/s-gly.md) per ottenere connessioni autenticate e scambiare messaggi.</span><span class="sxs-lookup"><span data-stu-id="6c72f-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="6c72f-105">L'applicazione chiama le funzioni SSPI (Security Support Provider Interface) di cui è stato eseguito il mapping a [funzioni implementate da SSP/APS](authentication-functions.md)e [funzioni implementate da SSP/APS in modalità utente](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="6c72f-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="6c72f-106">Questo mapping viene eseguito dalla DLL del provider di sicurezza (Secur32.dll o Security.dll), che può essere caricata in modo dinamico nei processi client e server.</span><span class="sxs-lookup"><span data-stu-id="6c72f-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="6c72f-107">La DLL può anche essere collegata in modo statico mediante Secur32. lib.</span><span class="sxs-lookup"><span data-stu-id="6c72f-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="6c72f-108">Sia la DLL che la libreria LIB sono fornite con Microsoft Windows Software Development Kit (SDK).</span><span class="sxs-lookup"><span data-stu-id="6c72f-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="6c72f-109">Il caricamento del pacchetto di protezione nel processo del client o del server viene gestito dal sistema, se la DLL SSP/AP che contiene il pacchetto di sicurezza è registrata correttamente.</span><span class="sxs-lookup"><span data-stu-id="6c72f-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="6c72f-110">Il server avvia il processo di acquisizione di una connessione protetta con un client monitorando una porta, in attesa che un client invii un messaggio.</span><span class="sxs-lookup"><span data-stu-id="6c72f-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="6c72f-111">Il client avvia il processo di recupero di una connessione sicura al server chiamando la funzione SSPI [**InitializeSecurityContext (generale)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span><span class="sxs-lookup"><span data-stu-id="6c72f-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="6c72f-112">Questa funzione è mappata alla funzione [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) del pacchetto di sicurezza personalizzato.</span><span class="sxs-lookup"><span data-stu-id="6c72f-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="6c72f-113">**SpInitLsaModeContext** restituisce un token al client, che lo trasmette al server.</span><span class="sxs-lookup"><span data-stu-id="6c72f-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="6c72f-114">Quando riceve il token dal client, il server chiama la funzione SSPI [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), che viene inviata alla funzione [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) del pacchetto di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="6c72f-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="6c72f-115">Se la funzione **SpAcceptLsaModeContext** ha esito positivo e non è necessaria alcuna elaborazione per stabilire il contesto di sicurezza, la funzione deve restituire lo stato \_ di esito positivo al chiamante.</span><span class="sxs-lookup"><span data-stu-id="6c72f-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="6c72f-116">Se è necessaria un'elaborazione aggiuntiva, la funzione deve restituire il secondo \_ \_ e continuare a \_ essere necessario e restituire un token al server.</span><span class="sxs-lookup"><span data-stu-id="6c72f-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="6c72f-117">Il server invia il token al client, che chiama di nuovo [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) .</span><span class="sxs-lookup"><span data-stu-id="6c72f-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="6c72f-118">Il ciclo chiamante può essere ripetuto con la frequenza necessaria fino a quando non viene stabilita una connessione autenticata o ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="6c72f-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="6c72f-119">Durante questo processo, se la funzione [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) o [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) ha esito positivo e non è necessaria alcuna elaborazione per stabilire il [*contesto di sicurezza*](../secgloss/s-gly.md), la funzione deve restituire lo stato \_ di esito positivo al chiamante.</span><span class="sxs-lookup"><span data-stu-id="6c72f-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="6c72f-120">Se è necessaria un'elaborazione aggiuntiva, la funzione deve restituire il secondo \_ \_ e continuare a essere \_ necessario e restituire un token al chiamante, che è responsabile dell'invio.</span><span class="sxs-lookup"><span data-stu-id="6c72f-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="6c72f-121">Il protocollo implementato dal pacchetto di sicurezza determina il numero di volte in cui il ciclo viene ripetuto.</span><span class="sxs-lookup"><span data-stu-id="6c72f-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="6c72f-122">Ad esempio, nei pacchetti di sicurezza che supportano l'autenticazione reciproca a tre gambe, la sequenza chiamante è la seguente:</span><span class="sxs-lookup"><span data-stu-id="6c72f-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="6c72f-123">Il client ottiene un token chiamando [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)e lo invia al server.</span><span class="sxs-lookup"><span data-stu-id="6c72f-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="6c72f-124">Il server chiama [**AcceptSecurityContext (generale)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) la prima volta e restituisce un token di risposta inviato al client.</span><span class="sxs-lookup"><span data-stu-id="6c72f-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="6c72f-125">Il client usa il token ricevuto dal server in una seconda chiamata a [**InitializeSecurityContext (generale)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)e restituisce un token finale.</span><span class="sxs-lookup"><span data-stu-id="6c72f-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="6c72f-126">Il client invia questo token al server.</span><span class="sxs-lookup"><span data-stu-id="6c72f-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="6c72f-127">Il server riceve il token generato nel segmento 2 usato nella chiamata finale a [**AcceptSecurityContext (generale)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span><span class="sxs-lookup"><span data-stu-id="6c72f-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="6c72f-128">Quando le funzioni [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) e [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) hanno esito positivo e non è necessaria alcuna elaborazione per stabilire il contesto di sicurezza, le funzioni dovrebbero restituire lo stato \_ di esito positivo al chiamante.</span><span class="sxs-lookup"><span data-stu-id="6c72f-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="6c72f-129">Inoltre, se il pacchetto di sicurezza personalizzato supporta le [funzioni implementate da SSP/APS in modalità utente](authentication-functions.md), **SpAcceptLsaModeContext** e **SpInitLsaModeContext** devono restituire **true** tramite il parametro *MappedContext* .</span><span class="sxs-lookup"><span data-stu-id="6c72f-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="6c72f-130">Il valore *MappedContext* non viene restituito all'applicazione; viene intercettato dall'LSA.</span><span class="sxs-lookup"><span data-stu-id="6c72f-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="6c72f-131">Quando *MappedContext* è **true**, LSA chiama la funzione [**SPUSERMODEINITIALIZE**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) della dll SSP/AP.</span><span class="sxs-lookup"><span data-stu-id="6c72f-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="6c72f-132">Questa funzione fornisce tabelle di puntatori alle funzioni in modalità utente implementate da ogni pacchetto di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="6c72f-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="6c72f-133">Viene chiamata la funzione [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) di ogni pacchetto, usando le tabelle di funzione restituite da **SpUsermodeInitialize**.</span><span class="sxs-lookup"><span data-stu-id="6c72f-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="6c72f-134">**SpInstanceInit** riceve una tabella di puntatori alle [funzioni LSA chiamate da SSP/APS in modalità utente](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="6c72f-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
