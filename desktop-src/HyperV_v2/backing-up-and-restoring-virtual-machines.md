---
description: Hyper-V usa il Servizio Copia Shadow del volume (VSS) per eseguire il backup e il ripristino delle macchine virtuali.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Backup e ripristino di macchine virtuali
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "106312336"
---
# <a name="backing-up-and-restoring-virtual-machines"></a><span data-ttu-id="37506-103">Backup e ripristino di macchine virtuali</span><span class="sxs-lookup"><span data-stu-id="37506-103">Backing up and restoring virtual machines</span></span>

<span data-ttu-id="37506-104">Hyper-V usa il Servizio Copia Shadow del volume (VSS) per eseguire il backup e il ripristino delle macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="37506-104">Hyper-V uses the Volume Shadow Copy Service (VSS) to backup and restore virtual machines.</span></span> <span data-ttu-id="37506-105">Se i servizi di integrazione di backup (snapshot del volume) sono installati nel sistema operativo guest, viene installato un richiedente VSS che consentirà ai writer VSS nel sistema operativo guest di partecipare al backup della macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-105">If the backup (volume snapshot) integration services are installed in the guest operating system, a VSS requester is installed that will allow VSS writers in the guest operating system to participate in the backup of the virtual machine.</span></span> <span data-ttu-id="37506-106">Per informazioni dettagliate, vedere le sezioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="37506-106">For details, see the following sections:</span></span>

-   [<span data-ttu-id="37506-107">Esecuzione del backup delle macchine virtuali</span><span class="sxs-lookup"><span data-stu-id="37506-107">Backing up the virtual machines</span></span>](#backing-up-the-virtual-machines)
-   [<span data-ttu-id="37506-108">Ripristino delle macchine virtuali</span><span class="sxs-lookup"><span data-stu-id="37506-108">Restoring the virtual machines</span></span>](#restoring-the-virtual-machines)
-   [<span data-ttu-id="37506-109">Clustering di failover e VSS di Hyper-V</span><span class="sxs-lookup"><span data-stu-id="37506-109">Failover clustering and Hyper-V VSS</span></span>](#failover-clustering-and-hyper-v-vss)
-   [<span data-ttu-id="37506-110">Dettagli sul writer VSS di Hyper-V</span><span class="sxs-lookup"><span data-stu-id="37506-110">Details on the Hyper-V VSS Writer</span></span>](#details-on-the-hyper-v-vss-writer)
-   [<span data-ttu-id="37506-111">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="37506-111">Related topics</span></span>](#related-topics)

## <a name="backing-up-the-virtual-machines"></a><span data-ttu-id="37506-112">Esecuzione del backup delle macchine virtuali</span><span class="sxs-lookup"><span data-stu-id="37506-112">Backing up the virtual machines</span></span>

<span data-ttu-id="37506-113">Hyper-V usa uno dei due meccanismi per eseguire il backup di ogni macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-113">Hyper-V uses one of two mechanisms to back up each virtual machine.</span></span> <span data-ttu-id="37506-114">Il meccanismo di backup predefinito viene chiamato metodo "stato salvato", in cui la macchina virtuale viene spostata in uno stato salvato durante l'elaborazione dell'evento PrepareForSnapshot, vengono presi gli snapshot dei volumi appropriati e la macchina virtuale viene restituita allo stato precedente durante l'elaborazione dell'evento PostSnapshot.</span><span class="sxs-lookup"><span data-stu-id="37506-114">The default backup mechanism is called the "Saved State" method, where the virtual machine is put into a saved state during the processing of the PrepareForSnapshot event, snapshots are taken of the appropriate volumes, and the virtual machine is returned to the previous state during the processing of the PostSnapshot event.</span></span>

<span data-ttu-id="37506-115">L'altro meccanismo di backup è denominato "snapshot VM figlio", che utilizza VSS all'interno della macchina virtuale figlio per partecipare al backup.</span><span class="sxs-lookup"><span data-stu-id="37506-115">The other backup mechanism is called the "Child VM Snapshot" method, which uses VSS inside the child virtual machine to participate in the backup.</span></span> <span data-ttu-id="37506-116">Per poter supportare il metodo "snapshot VM figlio", è necessario che siano soddisfatte tutte le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="37506-116">For the "Child VM Snapshot" method to be supported, all of the following conditions must be met:</span></span>

-   <span data-ttu-id="37506-117">Il servizio di integrazione backup (snapshot del volume) è installato e in esecuzione nella macchina virtuale figlio.</span><span class="sxs-lookup"><span data-stu-id="37506-117">Backup (volume snapshot) Integration Service is installed and running in the child virtual machine.</span></span> <span data-ttu-id="37506-118">Il nome del servizio è "richiedente copia shadow del volume Hyper-V".</span><span class="sxs-lookup"><span data-stu-id="37506-118">The service name is "Hyper-V Volume Shadow Copy Requestor".</span></span>
-   <span data-ttu-id="37506-119">La macchina virtuale figlio deve essere nello stato in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="37506-119">The child virtual machine must be in the running state.</span></span>
-   <span data-ttu-id="37506-120">Il percorso del file di snapshot per la macchina virtuale è impostato sullo stesso volume del sistema operativo host dei file VHD della macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-120">The Snapshot File Location for the virtual machine is set to be the same volume in the host operating system as the VHD files for the virtual machine.</span></span>
-   <span data-ttu-id="37506-121">Tutti i volumi della macchina virtuale figlio sono dischi di base e non ci sono dischi dinamici.</span><span class="sxs-lookup"><span data-stu-id="37506-121">All volumes on the child virtual machine are basic disks and there are no dynamic disks.</span></span>
-   <span data-ttu-id="37506-122">Tutti i dischi della macchina virtuale figlio devono usare un file system che supporti gli snapshot, ad esempio NTFS.</span><span class="sxs-lookup"><span data-stu-id="37506-122">All disks on the child virtual machine must use a file system that supports snapshots (for example, NTFS).</span></span>

<span data-ttu-id="37506-123">In generale, il processo di backup delle macchine virtuali è identico a quello descritto in [Panoramica dell'elaborazione di un backup in VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="37506-123">In general, the process for backing up virtual machines is the same as described in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="37506-124">Il comportamento univoco si verifica quando l'VSS writer Hyper-V (parte del servizio "Virtual Machine Management" di Hyper-V) elabora l'evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="37506-124">The unique behavior happens when the Hyper-V VSS writer (part of the "Hyper-V Virtual Machine Management" service) processes the PrepareForSnapshot event.</span></span> <span data-ttu-id="37506-125">Se il backup è stato eseguito usando il metodo "snapshot VM figlio", l'elaborazione aggiuntiva è stata completata ma non è visibile alla macchina virtuale figlio.</span><span class="sxs-lookup"><span data-stu-id="37506-125">If the backup was done using the "Child VM Snapshot" method, there is additional processing done but it is not visible to the child virtual machine.</span></span>

<span data-ttu-id="37506-126">Nella procedura seguente viene descritto come eseguire il backup di macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="37506-126">The following procedure describes how to back up virtual machines.</span></span>

<span data-ttu-id="37506-127">**Per eseguire il backup di macchine virtuali**</span><span class="sxs-lookup"><span data-stu-id="37506-127">**To back up virtual machines**</span></span>

1.  <span data-ttu-id="37506-128">Per ogni macchina virtuale nei metadati del writer, se viene usato il metodo "stato salvato", la macchina virtuale viene messa in uno stato salvato.</span><span class="sxs-lookup"><span data-stu-id="37506-128">For each virtual machine in the writer metadata, if the "Saved State" method is used, the virtual machine is put into a saved state.</span></span> <span data-ttu-id="37506-129">Per le macchine virtuali che usano il metodo "snapshot VM figlio", il servizio richiedente copia shadow del volume Hyper-V nella macchina virtuale figlio elabora il backup come descritto in dettaglio in [Panoramica sull'elaborazione di un backup in VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="37506-129">For virtual machines using the "Child VM Snapshot" method, the Hyper-V Volume Shadow Copy Requestor Service in the child virtual machine processes the backup as detailed in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="37506-130">Tutti gli eventi VSS nella macchina virtuale figlio si verificano durante l'elaborazione del sistema operativo host dell'evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="37506-130">All VSS events on the child virtual machine occur during the host operating system processing of the PrepareForSnapshot event.</span></span>
2.  <span data-ttu-id="37506-131">Dopo che tutte le macchine virtuali sono state inserite nello stato salvato o hanno eseguito snapshot, l'VSS writer Hyper-V viene restituito dall'evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="37506-131">After all virtual machines have either been put in the saved state or had snapshots taken, the Hyper-V VSS writer returns from the PrepareForSnapshot event.</span></span> <span data-ttu-id="37506-132">Nessuna elaborazione viene eseguita dal VSS writer Hyper-V durante gli eventi di blocco e di sblocco.</span><span class="sxs-lookup"><span data-stu-id="37506-132">No processing is done by the Hyper-V VSS writer during the Freeze and Thaw events.</span></span>
3.  <span data-ttu-id="37506-133">Quando l'VSS writer Hyper-V elabora l'evento di post-snapshot, le macchine virtuali di cui è stato eseguito il backup con il metodo "stato salvato" e inserite in uno stato salvato dal VSS writer Hyper-V vengono restituite allo stato in cui si trovavano prima dell'avvio del backup.</span><span class="sxs-lookup"><span data-stu-id="37506-133">When the Hyper-V VSS writer processes the PostSnapshot event, virtual machines that were backed up using the "Saved State" method and were put into a saved state by the Hyper-V VSS writer are returned to the state they were in before the backup started.</span></span> <span data-ttu-id="37506-134">Per le macchine virtuali di cui è stato eseguito il backup con il metodo "snapshot VM figlio", viene eseguito il rollback dell'immagine host dei file VHD con gli snapshot eseguiti durante l'elaborazione dell'evento PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="37506-134">For the virtual machines that were backed up using the "Child VM Snapshot" method, the host image of the VHD files that had the snapshots taken are rolled back to the snapshot taken during the processing of the PrepareForSnapshot event.</span></span> <span data-ttu-id="37506-135">Questa elaborazione viene eseguita indipendentemente dai writer VSS nelle macchine virtuali figlio, in modo che gli snapshot eseguiti debbano essere ripristinabili automaticamente.</span><span class="sxs-lookup"><span data-stu-id="37506-135">This processing is done independently of the VSS writers on the child virtual machines so the snapshots taken must be auto-recoverable.</span></span> <span data-ttu-id="37506-136">(**VSS VolSnap non è impostato \_ \_ \_ alcun \_ recupero automatico** nel contesto).</span><span class="sxs-lookup"><span data-stu-id="37506-136">(**VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY** is not set in the context.)</span></span>

<span data-ttu-id="37506-137">I backup parziali non sono supportati.</span><span class="sxs-lookup"><span data-stu-id="37506-137">Partial backups are not supported.</span></span> <span data-ttu-id="37506-138">Se una macchina virtuale non riesce a creare uno snapshot, non verrà eseguito il backup di macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="37506-138">If any virtual machine fails to create a snapshot, no virtual machines will be backed up.</span></span>

> [!Note]  
> <span data-ttu-id="37506-139">I dischi pass-through e iSCSI non sono visibili al sistema operativo host e pertanto non sono supportati dal VSS writer Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="37506-139">Pass-through and iSCSI disks are not visible to the host operating system and therefore not backed up by the Hyper-V VSS writer.</span></span> <span data-ttu-id="37506-140">I backup di questi volumi devono essere eseguiti interamente nella macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-140">Backups of these volumes must be done entirely on the virtual machine.</span></span>

 

## <a name="restoring-the-virtual-machines"></a><span data-ttu-id="37506-141">Ripristino delle macchine virtuali</span><span class="sxs-lookup"><span data-stu-id="37506-141">Restoring the virtual machines</span></span>

<span data-ttu-id="37506-142">Il ripristino delle macchine virtuali viene eseguito interamente dal sistema operativo host. i writer VSS nelle macchine virtuali figlio non sono interessati.</span><span class="sxs-lookup"><span data-stu-id="37506-142">Restoring the virtual machines is done entirely by the host operating system; the VSS writers on the child virtual machines are not involved.</span></span>

<span data-ttu-id="37506-143">Nella procedura riportata di seguito viene descritto come ripristinare le macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="37506-143">The following procedure describes how to restore virtual machines.</span></span>

<span data-ttu-id="37506-144">**Per ripristinare le macchine virtuali**</span><span class="sxs-lookup"><span data-stu-id="37506-144">**To restore virtual machines**</span></span>

1.  <span data-ttu-id="37506-145">Durante l'elaborazione dell'evento di preripristino, Hyper-V VSS writer disattiva ed Elimina tutte le macchine virtuali che stanno per essere ripristinate.</span><span class="sxs-lookup"><span data-stu-id="37506-145">During the processing of the PreRestore event, the Hyper-V VSS writer turns off and deletes any virtual machines that are about to be restored.</span></span>
2.  <span data-ttu-id="37506-146">Dopo che tutti i writer VSS hanno elaborato l'evento di preripristino, i file vengono ripristinati.</span><span class="sxs-lookup"><span data-stu-id="37506-146">After all VSS writers have processed the PreRestore event, the files are restored.</span></span>
3.  <span data-ttu-id="37506-147">Durante l'elaborazione dell'evento PostRestore, l'VSS writer Hyper-V chiama il metodo [**IVssComponent:: GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) .</span><span class="sxs-lookup"><span data-stu-id="37506-147">During the processing of the PostRestore event, the Hyper-V VSS writer calls the [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) method.</span></span> <span data-ttu-id="37506-148">Se il valore restituito non **è \_ All VSS RS \_ ALL**, il VSS Writer Hyper-V chiama il metodo [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) e restituisce **false** dal metodo [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) .</span><span class="sxs-lookup"><span data-stu-id="37506-148">If the return is not **VSS\_RS\_ALL**, then the Hyper-V VSS writer calls the [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) method and returns **False** from the [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) method.</span></span>
4.  <span data-ttu-id="37506-149">Per ogni macchina virtuale ripristinata, Hyper-V VSS writer registra la macchina virtuale con il servizio di gestione Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="37506-149">For each virtual machine that was restored, the Hyper-V VSS writer registers the virtual machine with the Hyper-V management service.</span></span> <span data-ttu-id="37506-150">Se la macchina virtuale viene ripristinata in un percorso non predefinito, viene creato un collegamento simbolico nel percorso predefinito che si collega a tale posizione.</span><span class="sxs-lookup"><span data-stu-id="37506-150">If the virtual machine is restored to a nondefault location, a symbolic link is created in the default location linking to that location.</span></span>
5.  <span data-ttu-id="37506-151">Per ogni disco rigido virtuale che è stato ripristinato, il percorso viene confrontato con quello specificato per la macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-151">For each VHD that was restored, the location is compared with the one specified for that virtual machine.</span></span> <span data-ttu-id="37506-152">Se il percorso è diverso, la configurazione viene aggiornata con il percorso appropriato.</span><span class="sxs-lookup"><span data-stu-id="37506-152">If the location is different, then the configuration is updated with the proper location.</span></span>
6.  <span data-ttu-id="37506-153">La configurazione di rete viene aggiornata.</span><span class="sxs-lookup"><span data-stu-id="37506-153">The network configuration is updated.</span></span> <span data-ttu-id="37506-154">Se i commutatori virtuali a cui la macchina virtuale è stata connessa quando è stato eseguito il backup sono ancora in uscita, vengono create nuove porte e connesse alla macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-154">If the virtual switches that the virtual machine was connected to when it was backed up still exit, new ports are created and connected to the virtual machine.</span></span>

## <a name="failover-clustering-and-hyper-v-vss"></a><span data-ttu-id="37506-155">Clustering di failover e VSS di Hyper-V</span><span class="sxs-lookup"><span data-stu-id="37506-155">Failover clustering and Hyper-V VSS</span></span>

<span data-ttu-id="37506-156">Il VSS writer Hyper-V non fornisce alcuna considerazione per le macchine virtuali che fanno parte di un cluster di failover.</span><span class="sxs-lookup"><span data-stu-id="37506-156">The Hyper-V VSS writer does not give any consideration to virtual machines that are part of a failover cluster.</span></span> <span data-ttu-id="37506-157">Durante i backup del metodo "stato salvato" e tutti i ripristini, la macchina virtuale viene inserita nello stato salvato o completamente eliminata.</span><span class="sxs-lookup"><span data-stu-id="37506-157">During both the "Saved State" method backups and all restores, the virtual machine would be put into the saved state or deleted entirely.</span></span> <span data-ttu-id="37506-158">Questa situazione verrebbe considerata come un errore del servizio di clustering e causerebbe il failover delle applicazioni su tali nodi in altri nodi.</span><span class="sxs-lookup"><span data-stu-id="37506-158">This would be seen as a failure by the clustering service and cause the applications on those nodes to be failed over to other nodes.</span></span> <span data-ttu-id="37506-159">Per evitare questo problema durante i backup con stato "salvato", lo stato della macchina virtuale deve essere salvato utilizzando il servizio clustering.</span><span class="sxs-lookup"><span data-stu-id="37506-159">To avoid this during "Saved State" backups, the virtual machine state must be saved using the clustering service.</span></span> <span data-ttu-id="37506-160">Per evitare questo problema, è necessario portare offline le risorse della macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="37506-160">To avoid this during a restore, the resources on the virtual machine would need to be taken offline.</span></span>

## <a name="details-on-the-hyper-v-vss-writer"></a><span data-ttu-id="37506-161">Dettagli sul writer VSS di Hyper-V</span><span class="sxs-lookup"><span data-stu-id="37506-161">Details on the Hyper-V VSS Writer</span></span>

<span data-ttu-id="37506-162">Nome writer: Microsoft Hyper-V VSS Writer</span><span class="sxs-lookup"><span data-stu-id="37506-162">Writer Name: Microsoft Hyper-V VSS Writer</span></span>

<span data-ttu-id="37506-163">ID Writer: 66841CD4-6DED-4F4B-8F17-FD23F8DDC3DE</span><span class="sxs-lookup"><span data-stu-id="37506-163">Writer ID: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span></span>

## <a name="related-topics"></a><span data-ttu-id="37506-164">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="37506-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="37506-165">Cenni preliminari sull'elaborazione di un backup in VSS</span><span class="sxs-lookup"><span data-stu-id="37506-165">Overview of Processing a Backup Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[<span data-ttu-id="37506-166">Panoramica dell'elaborazione di un ripristino in VSS</span><span class="sxs-lookup"><span data-stu-id="37506-166">Overview of Processing a Restore Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
