---
description: Un punto di ingresso facoltativo in una libreria a collegamento dinamico (DLL). Quando il sistema avvia o termina un processo o un thread, chiama la funzione del punto di ingresso per ogni DLL caricata usando il primo thread del processo.
ms.assetid: 0c3e3083-9297-4626-b2a7-0062d1c2cf9e
title: Punto di ingresso DllMain (Process. h)
ms.topic: reference
ms.date: 07/22/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- DllMain
api_type:
- UserDefined
api_location:
- process.h
ms.openlocfilehash: ee182fd54f11909e54e98f827904f1da5e46f557
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "106313387"
---
# <a name="dllmain-entry-point"></a><span data-ttu-id="2b99d-104">Punto di ingresso DllMain</span><span class="sxs-lookup"><span data-stu-id="2b99d-104">DllMain entry point</span></span>

<span data-ttu-id="2b99d-105">Un punto di ingresso facoltativo in una libreria a collegamento dinamico (DLL).</span><span class="sxs-lookup"><span data-stu-id="2b99d-105">An optional entry point into a dynamic-link library (DLL).</span></span> <span data-ttu-id="2b99d-106">Quando il sistema avvia o termina un processo o un thread, chiama la funzione del punto di ingresso per ogni DLL caricata usando il primo thread del processo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-106">When the system starts or terminates a process or thread, it calls the entry-point function for each loaded DLL using the first thread of the process.</span></span> <span data-ttu-id="2b99d-107">Il sistema chiama anche la funzione del punto di ingresso per una DLL quando viene caricata o scaricata usando le funzioni [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) e [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="2b99d-107">The system also calls the entry-point function for a DLL when it is loaded or unloaded using the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) and [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) functions.</span></span>

## <a name="example"></a><span data-ttu-id="2b99d-108">Esempio</span><span class="sxs-lookup"><span data-stu-id="2b99d-108">Example</span></span>

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

<span data-ttu-id="2b99d-109">Questo è un esempio dalla [libreria a collegamento dinamico Entry-Point funzione](dynamic-link-library-entry-point-function.md).</span><span class="sxs-lookup"><span data-stu-id="2b99d-109">This is an example from the [Dynamic-Link Library Entry-Point Function](dynamic-link-library-entry-point-function.md).</span></span>


> [!WARNING]
> <span data-ttu-id="2b99d-110">Esistono limiti significativi sulle operazioni che è possibile eseguire in modo sicuro in un punto di ingresso della DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-110">There are significant limits on what you can safely do in a DLL entry point.</span></span> <span data-ttu-id="2b99d-111">Vedere [le procedure consigliate generali](dynamic-link-library-best-practices.md) per specifiche API di Windows che non sono sicure per la chiamata a DllMain.</span><span class="sxs-lookup"><span data-stu-id="2b99d-111">See [General Best Practices](dynamic-link-library-best-practices.md) for specific Windows APIs that are unsafe to call in DllMain.</span></span> <span data-ttu-id="2b99d-112">Se è necessario solo l'inizializzazione più semplice, eseguire questa operazione in una funzione di inizializzazione per la DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-112">If you need anything but the simplest initialization then do that in an initialization function for the DLL.</span></span> <span data-ttu-id="2b99d-113">È possibile richiedere alle applicazioni di chiamare la funzione di inizializzazione dopo l'esecuzione di DllMain e prima di chiamare qualsiasi altra funzione nella DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-113">You can require applications to call the initialization function after DllMain has run and before they call any other functions in the DLL.</span></span>

 

## <a name="syntax"></a><span data-ttu-id="2b99d-114">Sintassi</span><span class="sxs-lookup"><span data-stu-id="2b99d-114">Syntax</span></span>


```C++
BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
);
```



## <a name="parameters"></a><span data-ttu-id="2b99d-115">Parametri</span><span class="sxs-lookup"><span data-stu-id="2b99d-115">Parameters</span></span>

<dl> <dt>

<span data-ttu-id="2b99d-116">*hinstDLL* \[ in\]</span><span class="sxs-lookup"><span data-stu-id="2b99d-116">*hinstDLL* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="2b99d-117">Handle per il modulo DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-117">A handle to the DLL module.</span></span> <span data-ttu-id="2b99d-118">Il valore è l'indirizzo di base della DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-118">The value is the base address of the DLL.</span></span> <span data-ttu-id="2b99d-119">Il **HINSTANCE** di una dll è uguale a quello di **hmodule** della dll, pertanto *hinstDLL* può essere usato nelle chiamate a funzioni che richiedono un handle del modulo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-119">The **HINSTANCE** of a DLL is the same as the **HMODULE** of the DLL, so *hinstDLL* can be used in calls to functions that require a module handle.</span></span>

</dd> <dt>

<span data-ttu-id="2b99d-120">*fdwReason* \[ in\]</span><span class="sxs-lookup"><span data-stu-id="2b99d-120">*fdwReason* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="2b99d-121">Codice motivo che indica il motivo per cui viene chiamata la funzione del punto di ingresso della DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-121">The reason code that indicates why the DLL entry-point function is being called.</span></span> <span data-ttu-id="2b99d-122">Questo parametro può avere uno dei valori seguenti.</span><span class="sxs-lookup"><span data-stu-id="2b99d-122">This parameter can be one of the following values.</span></span>



| <span data-ttu-id="2b99d-123">Valore</span><span class="sxs-lookup"><span data-stu-id="2b99d-123">Value</span></span>                                                                                                                                                                                                                                | <span data-ttu-id="2b99d-124">Significato</span><span class="sxs-lookup"><span data-stu-id="2b99d-124">Meaning</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="DLL_PROCESS_ATTACH"></span><span id="dll_process_attach"></span><dl> <span data-ttu-id="2b99d-125"><dt>**Dll \_ di \_Connessione processo**</dt> <dt>1</dt></span><span class="sxs-lookup"><span data-stu-id="2b99d-125"><dt>**DLL\_PROCESS\_ATTACH**</dt> <dt>1</dt></span></span> </dl> | <span data-ttu-id="2b99d-126">La DLL viene caricata nello spazio degli indirizzi virtuali del processo corrente in seguito all'avvio del processo o a seguito di una chiamata a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span><span class="sxs-lookup"><span data-stu-id="2b99d-126">The DLL is being loaded into the virtual address space of the current process as a result of the process starting up or as a result of a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span></span> <span data-ttu-id="2b99d-127">Le dll possono utilizzare questa opportunità per inizializzare tutti i dati dell'istanza o per utilizzare la funzione [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) per allocare un indice TLS (thread local storage).</span><span class="sxs-lookup"><span data-stu-id="2b99d-127">DLLs can use this opportunity to initialize any instance data or to use the [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) function to allocate a thread local storage (TLS) index.</span></span><br/> <span data-ttu-id="2b99d-128">Il parametro *lpReserved* indica se la dll viene caricata in modo statico o dinamico.</span><span class="sxs-lookup"><span data-stu-id="2b99d-128">The *lpReserved* parameter indicates whether the DLL is being loaded statically or dynamically.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span id="DLL_PROCESS_DETACH"></span><span id="dll_process_detach"></span><dl> <span data-ttu-id="2b99d-129"><dt>**Dll \_ di \_Scollegamento processo**</dt> <dt>0</dt></span><span class="sxs-lookup"><span data-stu-id="2b99d-129"><dt>**DLL\_PROCESS\_DETACH**</dt> <dt>0</dt></span></span> </dl> | <span data-ttu-id="2b99d-130">La DLL viene scaricata dallo spazio degli indirizzi virtuali del processo chiamante perché è stata caricata senza esito positivo o il conteggio dei riferimenti ha raggiunto zero (i processi sono stati interrotti o sono stati chiamati [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) una volta per ogni chiamata a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="2b99d-130">The DLL is being unloaded from the virtual address space of the calling process because it was loaded unsuccessfully or the reference count has reached zero (the processes has either terminated or called [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) one time for each time it called [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span><br/> <span data-ttu-id="2b99d-131">Il parametro *lpReserved* indica se la dll viene scaricata in seguito a una chiamata [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , a un errore di caricamento o alla chiusura del processo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-131">The *lpReserved* parameter indicates whether the DLL is being unloaded as a result of a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) call, a failure to load, or process termination.</span></span><br/> <span data-ttu-id="2b99d-132">La DLL può usare questa opportunità per chiamare la funzione [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) per liberare tutti gli indici TLS allocati usando [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) e per liberare i dati locali dei thread.</span><span class="sxs-lookup"><span data-stu-id="2b99d-132">The DLL can use this opportunity to call the [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) function to free any TLS indices allocated by using [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) and to free any thread local data.</span></span><br/> <span data-ttu-id="2b99d-133">Si noti che il thread che riceve la notifica di **\_ \_ scollegamento del processo dll** non è necessariamente lo stesso thread che ha ricevuto la notifica di **\_ \_ collegamento del processo dll** .</span><span class="sxs-lookup"><span data-stu-id="2b99d-133">Note that the thread that receives the **DLL\_PROCESS\_DETACH** notification is not necessarily the same thread that received the **DLL\_PROCESS\_ATTACH** notification.</span></span><br/> |
| <span id="DLL_THREAD_ATTACH"></span><span id="dll_thread_attach"></span><dl> <span data-ttu-id="2b99d-134"><dt>**Dll \_ di \_Connessione thread**</dt> <dt>2</dt></span><span class="sxs-lookup"><span data-stu-id="2b99d-134"><dt>**DLL\_THREAD\_ATTACH**</dt> <dt>2</dt></span></span> </dl>    | <span data-ttu-id="2b99d-135">Il processo corrente sta creando un nuovo thread.</span><span class="sxs-lookup"><span data-stu-id="2b99d-135">The current process is creating a new thread.</span></span> <span data-ttu-id="2b99d-136">In tal caso, il sistema chiama la funzione del punto di ingresso di tutte le dll attualmente associate al processo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-136">When this occurs, the system calls the entry-point function of all DLLs currently attached to the process.</span></span> <span data-ttu-id="2b99d-137">La chiamata viene effettuata nel contesto del nuovo thread.</span><span class="sxs-lookup"><span data-stu-id="2b99d-137">The call is made in the context of the new thread.</span></span> <span data-ttu-id="2b99d-138">Le dll possono usare questa opportunità per inizializzare uno slot TLS per il thread.</span><span class="sxs-lookup"><span data-stu-id="2b99d-138">DLLs can use this opportunity to initialize a TLS slot for the thread.</span></span> <span data-ttu-id="2b99d-139">Un thread che chiama la funzione del punto di ingresso della dll con **\_ \_ connessione del processo dll** non chiama la funzione del punto di ingresso della dll con la **connessione al \_ thread \_ della dll**.</span><span class="sxs-lookup"><span data-stu-id="2b99d-139">A thread calling the DLL entry-point function with **DLL\_PROCESS\_ATTACH** does not call the DLL entry-point function with **DLL\_THREAD\_ATTACH**.</span></span> <br/> <span data-ttu-id="2b99d-140">Si noti che la funzione del punto di ingresso di una DLL viene chiamata con questo valore solo dai thread creati dopo che il processo ha caricato la DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-140">Note that a DLL's entry-point function is called with this value only by threads created after the DLL is loaded by the process.</span></span> <span data-ttu-id="2b99d-141">Quando una DLL viene caricata usando [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), i thread esistenti non chiamano la funzione del punto di ingresso della dll appena caricata.</span><span class="sxs-lookup"><span data-stu-id="2b99d-141">When a DLL is loaded using [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), existing threads do not call the entry-point function of the newly loaded DLL.</span></span><br/>                                                                                                                                                                       |
| <span id="DLL_THREAD_DETACH"></span><span id="dll_thread_detach"></span><dl> <span data-ttu-id="2b99d-142"><dt>**Dll \_ di \_Scollegamento thread**</dt> <dt>3</dt></span><span class="sxs-lookup"><span data-stu-id="2b99d-142"><dt>**DLL\_THREAD\_DETACH**</dt> <dt>3</dt></span></span> </dl>    | <span data-ttu-id="2b99d-143">Un thread è in uscita pulito.</span><span class="sxs-lookup"><span data-stu-id="2b99d-143">A thread is exiting cleanly.</span></span> <span data-ttu-id="2b99d-144">Se la DLL ha archiviato un puntatore alla memoria allocata in uno slot TLS, deve usare questa opportunità per liberare la memoria.</span><span class="sxs-lookup"><span data-stu-id="2b99d-144">If the DLL has stored a pointer to allocated memory in a TLS slot, it should use this opportunity to free the memory.</span></span> <span data-ttu-id="2b99d-145">Il sistema chiama la funzione del punto di ingresso di tutte le dll attualmente caricate con questo valore.</span><span class="sxs-lookup"><span data-stu-id="2b99d-145">The system calls the entry-point function of all currently loaded DLLs with this value.</span></span> <span data-ttu-id="2b99d-146">La chiamata viene effettuata nel contesto del thread in uscita.</span><span class="sxs-lookup"><span data-stu-id="2b99d-146">The call is made in the context of the exiting thread.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



 

</dd> <dt>

<span data-ttu-id="2b99d-147">*lpvReserved* \[ in\]</span><span class="sxs-lookup"><span data-stu-id="2b99d-147">*lpvReserved* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="2b99d-148">Se *fdwReason* è **un \_ processo \_ dll**, *lpvReserved* è **null** per i carichi dinamici e non null per i caricamenti statici.</span><span class="sxs-lookup"><span data-stu-id="2b99d-148">If *fdwReason* is **DLL\_PROCESS\_ATTACH**, *lpvReserved* is **NULL** for dynamic loads and non-NULL for static loads.</span></span>

<span data-ttu-id="2b99d-149">Se *fdwReason* è **dll \_ processo di \_ disconnessione**, *LpvReserved* è **null** se è stato chiamato [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) o il caricamento della dll non è riuscito e non **null** se il processo viene terminato.</span><span class="sxs-lookup"><span data-stu-id="2b99d-149">If *fdwReason* is **DLL\_PROCESS\_DETACH**, *lpvReserved* is **NULL** if [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) has been called or the DLL load failed and non-**NULL** if the process is terminating.</span></span>

</dd> </dl>

## <a name="return-value"></a><span data-ttu-id="2b99d-150">Valore restituito</span><span class="sxs-lookup"><span data-stu-id="2b99d-150">Return value</span></span>

<span data-ttu-id="2b99d-151">Quando il sistema chiama la funzione **DllMain** con il valore di **\_ \_ associazione processo dll** , la funzione restituisce **true** se ha esito positivo o **false** se l'inizializzazione ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-151">When the system calls the **DllMain** function with the **DLL\_PROCESS\_ATTACH** value, the function returns **TRUE** if it succeeds or **FALSE** if initialization fails.</span></span> <span data-ttu-id="2b99d-152">Se il valore restituito è **false** quando **DllMain** viene chiamato perché il processo utilizza la funzione [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , **LoadLibrary** restituisce null.</span><span class="sxs-lookup"><span data-stu-id="2b99d-152">If the return value is **FALSE** when **DllMain** is called because the process uses the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function, **LoadLibrary** returns NULL.</span></span> <span data-ttu-id="2b99d-153">Il sistema chiama immediatamente la funzione del punto di ingresso con **il \_ processo dll \_ scollegato** e Scarica la dll. Se il valore restituito è **false** quando **DllMain** viene chiamato durante l'inizializzazione del processo, il processo viene terminato con un errore.</span><span class="sxs-lookup"><span data-stu-id="2b99d-153">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) If the return value is **FALSE** when **DllMain** is called during process initialization, the process terminates with an error.</span></span> <span data-ttu-id="2b99d-154">Per informazioni dettagliate sull'errore, chiamare [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span><span class="sxs-lookup"><span data-stu-id="2b99d-154">To get extended error information, call [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span></span>

<span data-ttu-id="2b99d-155">Quando il sistema chiama la funzione **DllMain** con qualsiasi valore diverso da **dll \_ processo di \_ associazione**, il valore restituito viene ignorato.</span><span class="sxs-lookup"><span data-stu-id="2b99d-155">When the system calls the **DllMain** function with any value other than **DLL\_PROCESS\_ATTACH**, the return value is ignored.</span></span>

## <a name="remarks"></a><span data-ttu-id="2b99d-156">Commenti</span><span class="sxs-lookup"><span data-stu-id="2b99d-156">Remarks</span></span>

<span data-ttu-id="2b99d-157">**DllMain** è un segnaposto per il nome della funzione definita dalla libreria.</span><span class="sxs-lookup"><span data-stu-id="2b99d-157">**DllMain** is a placeholder for the library-defined function name.</span></span> <span data-ttu-id="2b99d-158">È necessario specificare il nome effettivo usato quando si compila la DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-158">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="2b99d-159">Per ulteriori informazioni, vedere la documentazione inclusa con gli strumenti di sviluppo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-159">For more information, see the documentation included with your development tools.</span></span>

<span data-ttu-id="2b99d-160">Durante l'avvio del processo iniziale o dopo una chiamata a [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), il sistema esegue l'analisi dell'elenco delle DLL caricate per il processo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-160">During initial process startup or after a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), the system scans the list of loaded DLLs for the process.</span></span> <span data-ttu-id="2b99d-161">Per ogni DLL che non è già stata chiamata con il valore di **\_ \_ associazione processo dll** , il sistema chiama la funzione del punto di ingresso della dll.</span><span class="sxs-lookup"><span data-stu-id="2b99d-161">For each DLL that has not already been called with the **DLL\_PROCESS\_ATTACH** value, the system calls the DLL's entry-point function.</span></span> <span data-ttu-id="2b99d-162">Questa chiamata viene eseguita nel contesto del thread che ha causato la modifica dello spazio degli indirizzi del processo, ad esempio il thread principale del processo o il thread che ha chiamato **LoadLibrary**.</span><span class="sxs-lookup"><span data-stu-id="2b99d-162">This call is made in the context of the thread that caused the process address space to change, such as the primary thread of the process or the thread that called **LoadLibrary**.</span></span> <span data-ttu-id="2b99d-163">L'accesso al punto di ingresso viene serializzato dal sistema in base a un intero processo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-163">Access to the entry point is serialized by the system on a process-wide basis.</span></span> <span data-ttu-id="2b99d-164">I thread in *DllMain* contengono il blocco del caricatore, quindi non è possibile caricare o inizializzare in modo dinamico altre dll.</span><span class="sxs-lookup"><span data-stu-id="2b99d-164">Threads in *DllMain* hold the loader lock so no additional DLLs can be dynamically loaded or initialized.</span></span>

<span data-ttu-id="2b99d-165">Se la funzione del punto di ingresso della DLL restituisce FALSE dopo una notifica di **\_ \_ collegamento del processo dll** , riceve una notifica di **\_ \_ scollegamento del processo dll** e la dll viene scaricata immediatamente.</span><span class="sxs-lookup"><span data-stu-id="2b99d-165">If the DLL's entry-point function returns FALSE following a **DLL\_PROCESS\_ATTACH** notification, it receives a **DLL\_PROCESS\_DETACH** notification and the DLL is unloaded immediately.</span></span> <span data-ttu-id="2b99d-166">Tuttavia, se il codice di **\_ \_ collegamento del processo dll** genera un'eccezione, la funzione del punto di ingresso non riceverà la notifica di **\_ \_ scollegamento del processo dll** .</span><span class="sxs-lookup"><span data-stu-id="2b99d-166">However, if the **DLL\_PROCESS\_ATTACH** code throws an exception, the entry-point function will not receive the **DLL\_PROCESS\_DETACH** notification.</span></span>

<span data-ttu-id="2b99d-167">Esistono casi in cui la funzione del punto di ingresso viene chiamata per un thread di terminazione anche se la funzione del punto di ingresso non è mai stata chiamata con la **\_ \_ connessione del thread dll** per il thread:</span><span class="sxs-lookup"><span data-stu-id="2b99d-167">There are cases in which the entry-point function is called for a terminating thread even if the entry-point function was never called with **DLL\_THREAD\_ATTACH** for the thread:</span></span>

-   <span data-ttu-id="2b99d-168">Il thread era il thread iniziale del processo, quindi il sistema ha chiamato la funzione del punto di ingresso con il valore di **\_ \_ associazione del processo dll** .</span><span class="sxs-lookup"><span data-stu-id="2b99d-168">The thread was the initial thread in the process, so the system called the entry-point function with the **DLL\_PROCESS\_ATTACH** value.</span></span>
-   <span data-ttu-id="2b99d-169">Il thread era già in esecuzione quando è stata eseguita una chiamata alla funzione [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , quindi il sistema non ha mai chiamato la funzione del punto di ingresso.</span><span class="sxs-lookup"><span data-stu-id="2b99d-169">The thread was already running when a call to the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function was made, so the system never called the entry-point function for it.</span></span>

<span data-ttu-id="2b99d-170">Quando una DLL viene scaricata da un processo in seguito a un caricamento non riuscito della DLL, alla chiusura del processo o a una chiamata a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), il sistema non chiama la funzione del punto di ingresso della dll con il valore di **\_ \_ scollegamento del thread dll** per i singoli thread del processo.</span><span class="sxs-lookup"><span data-stu-id="2b99d-170">When a DLL is unloaded from a process as a result of an unsuccessful load of the DLL, termination of the process, or a call to [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), the system does not call the DLL's entry-point function with the **DLL\_THREAD\_DETACH** value for the individual threads of the process.</span></span> <span data-ttu-id="2b99d-171">Alla DLL viene inviata solo una notifica di **\_ \_ scollegamento del processo dll** .</span><span class="sxs-lookup"><span data-stu-id="2b99d-171">The DLL is only sent a **DLL\_PROCESS\_DETACH** notification.</span></span> <span data-ttu-id="2b99d-172">Le dll possono avere questa opportunità per pulire tutte le risorse per tutti i thread noti alla DLL.</span><span class="sxs-lookup"><span data-stu-id="2b99d-172">DLLs can take this opportunity to clean up all resources for all threads known to the DLL.</span></span>

<span data-ttu-id="2b99d-173">Quando si gestisce lo **\_ \_ scollegamento del processo DLL**, una dll deve liberare risorse, ad esempio la memoria heap, solo se la dll viene scaricata dinamicamente (il parametro *lpReserved* è **null**).</span><span class="sxs-lookup"><span data-stu-id="2b99d-173">When handling **DLL\_PROCESS\_DETACH**, a DLL should free resources such as heap memory only if the DLL is being unloaded dynamically (the *lpReserved* parameter is **NULL**).</span></span> <span data-ttu-id="2b99d-174">Se il processo viene terminato (il parametro *lpvReserved* è diverso da **null**), tutti i thread nel processo eccetto il thread corrente sono già stati interrotti o sono stati terminati in modo esplicito da una chiamata alla funzione [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) , che potrebbe lasciare alcune risorse di processo, ad esempio heap in uno stato incoerente.</span><span class="sxs-lookup"><span data-stu-id="2b99d-174">If the process is terminating (the *lpvReserved* parameter is non-**NULL**), all threads in the process except the current thread either have exited already or have been explicitly terminated by a call to the [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) function, which might leave some process resources such as heaps in an inconsistent state.</span></span> <span data-ttu-id="2b99d-175">In questo caso non è sicuro che la DLL ripulisca le risorse.</span><span class="sxs-lookup"><span data-stu-id="2b99d-175">In this case, it is not safe for the DLL to clean up the resources.</span></span> <span data-ttu-id="2b99d-176">Al contrario, la DLL deve consentire al sistema operativo di recuperare la memoria.</span><span class="sxs-lookup"><span data-stu-id="2b99d-176">Instead, the DLL should allow the operating system to reclaim the memory.</span></span>

<span data-ttu-id="2b99d-177">Se si termina un processo chiamando [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) o [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), le DLL di tale processo non ricevono notifiche di **\_ \_ scollegamento dei processi dll** .</span><span class="sxs-lookup"><span data-stu-id="2b99d-177">If you terminate a process by calling [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), the DLLs of that process do not receive **DLL\_PROCESS\_DETACH** notifications.</span></span> <span data-ttu-id="2b99d-178">Se si termina un thread chiamando [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), le DLL di tale thread non ricevono notifiche di **\_ \_ scollegamento dei thread dll** .</span><span class="sxs-lookup"><span data-stu-id="2b99d-178">If you terminate a thread by calling [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), the DLLs of that thread do not receive **DLL\_THREAD\_DETACH** notifications.</span></span>

<span data-ttu-id="2b99d-179">La funzione del punto di ingresso deve eseguire solo attività di inizializzazione o terminazione semplici.</span><span class="sxs-lookup"><span data-stu-id="2b99d-179">The entry-point function should perform only simple initialization or termination tasks.</span></span> <span data-ttu-id="2b99d-180">Non deve chiamare la funzione [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) o [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (o una funzione che chiama queste funzioni), perché questo può creare cicli di dipendenza nell'ordine di caricamento della dll.</span><span class="sxs-lookup"><span data-stu-id="2b99d-180">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="2b99d-181">Questo può comportare l'uso di una DLL prima che il sistema abbia eseguito il codice di inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="2b99d-181">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="2b99d-182">Analogamente, la funzione del punto di ingresso non deve chiamare la funzione [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (o una funzione che chiama **FreeLibrary**) durante la terminazione del processo, perché questo può comportare l'uso di una dll dopo che il sistema ha eseguito il codice di terminazione.</span><span class="sxs-lookup"><span data-stu-id="2b99d-182">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="2b99d-183">Poiché è garantito il caricamento di Kernel32.dll nello spazio degli indirizzi del processo quando viene chiamata la funzione del punto di ingresso, la chiamata di funzioni in Kernel32.dll non comporta l'utilizzo della DLL prima dell'esecuzione del codice di inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="2b99d-183">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="2b99d-184">La funzione del punto di ingresso può quindi chiamare funzioni in Kernel32.dll che non caricano altre dll.</span><span class="sxs-lookup"><span data-stu-id="2b99d-184">Therefore, the entry-point function can call functions in Kernel32.dll that do not load other DLLs.</span></span> <span data-ttu-id="2b99d-185">Ad esempio, *DllMain* può creare [oggetti di sincronizzazione](/windows/desktop/Sync/synchronization-objects) come sezioni critiche e mutex e usare TLS.</span><span class="sxs-lookup"><span data-stu-id="2b99d-185">For example, *DllMain* can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS.</span></span> <span data-ttu-id="2b99d-186">Sfortunatamente, non è disponibile un elenco completo di funzioni sicure in Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="2b99d-186">Unfortunately, there is not a comprehensive list of safe functions in Kernel32.dll.</span></span>

<span data-ttu-id="2b99d-187">La chiamata di funzioni che richiedono dll diverse da Kernel32.dll può causare problemi difficili da diagnosticare.</span><span class="sxs-lookup"><span data-stu-id="2b99d-187">Calling functions that require DLLs other than Kernel32.dll may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="2b99d-188">Ad esempio, la chiamata a user, Shell e funzioni COM può causare errori di violazione dell'accesso, perché alcune funzioni caricano altri componenti di sistema.</span><span class="sxs-lookup"><span data-stu-id="2b99d-188">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions load other system components.</span></span> <span data-ttu-id="2b99d-189">Viceversa, la chiamata di funzioni come queste durante la terminazione può causare errori di violazione di accesso perché il componente corrispondente potrebbe essere già stato scaricato o non inizializzato.</span><span class="sxs-lookup"><span data-stu-id="2b99d-189">Conversely, calling functions such as these during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="2b99d-190">Poiché le notifiche DLL vengono serializzate, le funzioni del punto di ingresso non devono tentare di comunicare con altri thread o processi.</span><span class="sxs-lookup"><span data-stu-id="2b99d-190">Because DLL notifications are serialized, entry-point functions should not attempt to communicate with other threads or processes.</span></span> <span data-ttu-id="2b99d-191">Di conseguenza, possono verificarsi deadlock.</span><span class="sxs-lookup"><span data-stu-id="2b99d-191">Deadlocks may occur as a result.</span></span>

<span data-ttu-id="2b99d-192">Per informazioni sulle procedure consigliate per la scrittura di una DLL, vedere https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices .</span><span class="sxs-lookup"><span data-stu-id="2b99d-192">For information on best practices when writing a DLL, see https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices.</span></span>

<span data-ttu-id="2b99d-193">Se la DLL è collegata alla libreria di runtime C (CRT), il punto di ingresso fornito da CRT chiama i costruttori e i distruttori per gli oggetti C++ globali e statici.</span><span class="sxs-lookup"><span data-stu-id="2b99d-193">If your DLL is linked with the C run-time library (CRT), the entry point provided by the CRT calls the constructors and destructors for global and static C++ objects.</span></span> <span data-ttu-id="2b99d-194">Pertanto, queste restrizioni per *DllMain* si applicano anche a costruttori e distruttori e a qualsiasi codice chiamato da essi.</span><span class="sxs-lookup"><span data-stu-id="2b99d-194">Therefore, these restrictions for *DllMain* also apply to constructors and destructors and any code that is called from them.</span></span>

<span data-ttu-id="2b99d-195">Si consiglia di chiamare [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) quando si riceve il **\_ \_ collegamento al processo dll**, a meno che la dll non sia collegata alla libreria di runtime C statica (CRT).</span><span class="sxs-lookup"><span data-stu-id="2b99d-195">Consider calling [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) when receiving **DLL\_PROCESS\_ATTACH**, unless your DLL is linked with static C run-time library (CRT).</span></span>


## <a name="requirements"></a><span data-ttu-id="2b99d-196">Requisiti</span><span class="sxs-lookup"><span data-stu-id="2b99d-196">Requirements</span></span>



| <span data-ttu-id="2b99d-197">Requisito</span><span class="sxs-lookup"><span data-stu-id="2b99d-197">Requirement</span></span> | <span data-ttu-id="2b99d-198">Valore</span><span class="sxs-lookup"><span data-stu-id="2b99d-198">Value</span></span> |
|-------------------------------------|--------------------------------------------------------------------------------------|
| <span data-ttu-id="2b99d-199">Client minimo supportato</span><span class="sxs-lookup"><span data-stu-id="2b99d-199">Minimum supported client</span></span><br/> | <span data-ttu-id="2b99d-200">\[Solo app desktop Windows XP\]</span><span class="sxs-lookup"><span data-stu-id="2b99d-200">Windows XP \[desktop apps only\]</span></span><br/>                                          |
| <span data-ttu-id="2b99d-201">Server minimo supportato</span><span class="sxs-lookup"><span data-stu-id="2b99d-201">Minimum supported server</span></span><br/> | <span data-ttu-id="2b99d-202">\[Solo app desktop Windows Server 2003\]</span><span class="sxs-lookup"><span data-stu-id="2b99d-202">Windows Server 2003 \[desktop apps only\]</span></span><br/>                                 |
| <span data-ttu-id="2b99d-203">Intestazione</span><span class="sxs-lookup"><span data-stu-id="2b99d-203">Header</span></span><br/>                   | <dl> <span data-ttu-id="2b99d-204"><dt>Elabora. h</dt></span><span class="sxs-lookup"><span data-stu-id="2b99d-204"><dt>Process.h</dt></span></span> </dl> |



## <a name="see-also"></a><span data-ttu-id="2b99d-205">Vedi anche</span><span class="sxs-lookup"><span data-stu-id="2b99d-205">See also</span></span>

<dl> <dt>

[<span data-ttu-id="2b99d-206">Funzione Entry-Point libreria a collegamento dinamico</span><span class="sxs-lookup"><span data-stu-id="2b99d-206">Dynamic-Link Library Entry-Point Function</span></span>](dynamic-link-library-entry-point-function.md)
</dt> <dt>

[<span data-ttu-id="2b99d-207">Funzioni della libreria a collegamento dinamico</span><span class="sxs-lookup"><span data-stu-id="2b99d-207">Dynamic-Link Library Functions</span></span>](dynamic-link-library-functions.md)
</dt> <dt>

[<span data-ttu-id="2b99d-208">**FreeLibrary**</span><span class="sxs-lookup"><span data-stu-id="2b99d-208">**FreeLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)
</dt> <dt>

[<span data-ttu-id="2b99d-209">**GetModuleFileName**</span><span class="sxs-lookup"><span data-stu-id="2b99d-209">**GetModuleFileName**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)
</dt> <dt>

[<span data-ttu-id="2b99d-210">**LoadLibrary**</span><span class="sxs-lookup"><span data-stu-id="2b99d-210">**LoadLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
</dt> <dt>

[<span data-ttu-id="2b99d-211">**TlsAlloc**</span><span class="sxs-lookup"><span data-stu-id="2b99d-211">**TlsAlloc**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc)
</dt> <dt>

[<span data-ttu-id="2b99d-212">**TlsFree**</span><span class="sxs-lookup"><span data-stu-id="2b99d-212">**TlsFree**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree)
</dt> <dt>

[<span data-ttu-id="2b99d-213">**DisableThreadLibraryCalls**</span><span class="sxs-lookup"><span data-stu-id="2b99d-213">**DisableThreadLibraryCalls**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls)





</dt> </dl>
