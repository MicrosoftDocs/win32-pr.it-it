---
description: Una DLL può facoltativamente specificare una funzione del punto di ingresso.
ms.assetid: ec035fc6-0a6f-4e52-a4cc-8d7a25a94366
title: Funzione Entry-Point della libreria Dynamic-Link
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b62bff557bfa2aa792b420e8fe1856bbe0726921
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "103753775"
---
# <a name="dynamic-link-library-entry-point-function"></a><span data-ttu-id="bfa65-103">Funzione Entry-Point della libreria Dynamic-Link</span><span class="sxs-lookup"><span data-stu-id="bfa65-103">Dynamic-Link Library Entry-Point Function</span></span>

<span data-ttu-id="bfa65-104">Una DLL può facoltativamente specificare una funzione del punto di ingresso.</span><span class="sxs-lookup"><span data-stu-id="bfa65-104">A DLL can optionally specify an entry-point function.</span></span> <span data-ttu-id="bfa65-105">Se presente, il sistema chiama la funzione del punto di ingresso ogni volta che un processo o un thread carica o Scarica la DLL.</span><span class="sxs-lookup"><span data-stu-id="bfa65-105">If present, the system calls the entry-point function whenever a process or thread loads or unloads the DLL.</span></span> <span data-ttu-id="bfa65-106">Può essere utilizzato per eseguire semplici attività di inizializzazione e pulizia.</span><span class="sxs-lookup"><span data-stu-id="bfa65-106">It can be used to perform simple initialization and cleanup tasks.</span></span> <span data-ttu-id="bfa65-107">Ad esempio, è possibile configurare l'archiviazione locale di thread quando viene creato un nuovo thread e pulirla quando il thread viene terminato.</span><span class="sxs-lookup"><span data-stu-id="bfa65-107">For example, it can set up thread local storage when a new thread is created, and clean it up when the thread is terminated.</span></span>

<span data-ttu-id="bfa65-108">Se si collega la DLL con la libreria di runtime del linguaggio C, è possibile che fornisca una funzione del punto di ingresso per l'utente e consenta di fornire una funzione di inizializzazione separata.</span><span class="sxs-lookup"><span data-stu-id="bfa65-108">If you are linking your DLL with the C run-time library, it may provide an entry-point function for you, and allow you to provide a separate initialization function.</span></span> <span data-ttu-id="bfa65-109">Per ulteriori informazioni, consultare la documentazione per la libreria di Runtime.</span><span class="sxs-lookup"><span data-stu-id="bfa65-109">Check the documentation for your run-time library for more information.</span></span>

<span data-ttu-id="bfa65-110">Se si specifica un punto di ingresso personalizzato, vedere la funzione [**DllMain**](dllmain.md) .</span><span class="sxs-lookup"><span data-stu-id="bfa65-110">If you are providing your own entry-point, see the [**DllMain**](dllmain.md) function.</span></span> <span data-ttu-id="bfa65-111">Il nome **DllMain** è un segnaposto per una funzione definita dall'utente.</span><span class="sxs-lookup"><span data-stu-id="bfa65-111">The name **DllMain** is a placeholder for a user-defined function.</span></span> <span data-ttu-id="bfa65-112">È necessario specificare il nome effettivo usato quando si compila la DLL.</span><span class="sxs-lookup"><span data-stu-id="bfa65-112">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="bfa65-113">Per ulteriori informazioni, vedere la documentazione inclusa con gli strumenti di sviluppo.</span><span class="sxs-lookup"><span data-stu-id="bfa65-113">For more information, see the documentation included with your development tools.</span></span>

## <a name="calling-the-entry-point-function"></a><span data-ttu-id="bfa65-114">Chiamata della funzione Entry-Point</span><span class="sxs-lookup"><span data-stu-id="bfa65-114">Calling the Entry-Point Function</span></span>

<span data-ttu-id="bfa65-115">Il sistema chiama la funzione del punto di ingresso quando si verifica uno degli eventi seguenti:</span><span class="sxs-lookup"><span data-stu-id="bfa65-115">The system calls the entry-point function whenever any one of the following events occurs:</span></span>

-   <span data-ttu-id="bfa65-116">Un processo carica la DLL.</span><span class="sxs-lookup"><span data-stu-id="bfa65-116">A process loads the DLL.</span></span> <span data-ttu-id="bfa65-117">Per i processi che usano il collegamento dinamico in fase di caricamento, la DLL viene caricata durante l'inizializzazione del processo.</span><span class="sxs-lookup"><span data-stu-id="bfa65-117">For processes using load-time dynamic linking, the DLL is loaded during process initialization.</span></span> <span data-ttu-id="bfa65-118">Per i processi che usano il collegamento in fase di esecuzione, la DLL viene caricata prima che [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) o [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) restituisca.</span><span class="sxs-lookup"><span data-stu-id="bfa65-118">For processes using run-time linking, the DLL is loaded before [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) returns.</span></span>
-   <span data-ttu-id="bfa65-119">Un processo Scarica la DLL.</span><span class="sxs-lookup"><span data-stu-id="bfa65-119">A process unloads the DLL.</span></span> <span data-ttu-id="bfa65-120">La DLL viene scaricata quando il processo termina o chiama la funzione [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) e il conteggio dei riferimenti diventa zero.</span><span class="sxs-lookup"><span data-stu-id="bfa65-120">The DLL is unloaded when the process terminates or calls the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function and the reference count becomes zero.</span></span> <span data-ttu-id="bfa65-121">Se il processo viene terminato come risultato della funzione [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) o [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) , il sistema non chiama la funzione del punto di ingresso della dll.</span><span class="sxs-lookup"><span data-stu-id="bfa65-121">If the process terminates as a result of the [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) function, the system does not call the DLL entry-point function.</span></span>
-   <span data-ttu-id="bfa65-122">Un nuovo thread viene creato in un processo che ha caricato la DLL.</span><span class="sxs-lookup"><span data-stu-id="bfa65-122">A new thread is created in a process that has loaded the DLL.</span></span> <span data-ttu-id="bfa65-123">È possibile usare la funzione [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) per disabilitare la notifica quando vengono creati i thread.</span><span class="sxs-lookup"><span data-stu-id="bfa65-123">You can use the [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) function to disable notification when threads are created.</span></span>
-   <span data-ttu-id="bfa65-124">Un thread di un processo che ha caricato la DLL termina normalmente, non usando [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) o [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span><span class="sxs-lookup"><span data-stu-id="bfa65-124">A thread of a process that has loaded the DLL terminates normally, not using [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) or [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span></span> <span data-ttu-id="bfa65-125">Quando un processo Scarica la DLL, la funzione del punto di ingresso viene chiamata una sola volta per l'intero processo, anziché una volta per ogni thread esistente del processo.</span><span class="sxs-lookup"><span data-stu-id="bfa65-125">When a process unloads the DLL, the entry-point function is called only once for the entire process, rather than once for each existing thread of the process.</span></span> <span data-ttu-id="bfa65-126">È possibile utilizzare [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) per disabilitare la notifica quando i thread vengono terminati.</span><span class="sxs-lookup"><span data-stu-id="bfa65-126">You can use [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) to disable notification when threads are terminated.</span></span>

<span data-ttu-id="bfa65-127">Solo un thread alla volta può chiamare la funzione del punto di ingresso.</span><span class="sxs-lookup"><span data-stu-id="bfa65-127">Only one thread at a time can call the entry-point function.</span></span>

<span data-ttu-id="bfa65-128">Il sistema chiama la funzione del punto di ingresso nel contesto del processo o del thread che ha causato la chiamata della funzione.</span><span class="sxs-lookup"><span data-stu-id="bfa65-128">The system calls the entry-point function in the context of the process or thread that caused the function to be called.</span></span> <span data-ttu-id="bfa65-129">Questo consente a una DLL di usare la funzione del punto di ingresso per l'allocazione della memoria nello spazio degli indirizzi virtuali del processo chiamante o per aprire gli handle accessibili al processo.</span><span class="sxs-lookup"><span data-stu-id="bfa65-129">This allows a DLL to use its entry-point function for allocating memory in the virtual address space of the calling process or to open handles accessible to the process.</span></span> <span data-ttu-id="bfa65-130">La funzione del punto di ingresso può inoltre allocare memoria privata a un nuovo thread utilizzando l'archiviazione locale di thread (TLS).</span><span class="sxs-lookup"><span data-stu-id="bfa65-130">The entry-point function can also allocate memory that is private to a new thread by using thread local storage (TLS).</span></span> <span data-ttu-id="bfa65-131">Per altre informazioni sull'archiviazione thread-local, vedere [archiviazione locale di thread](/windows/desktop/ProcThread/thread-local-storage).</span><span class="sxs-lookup"><span data-stu-id="bfa65-131">For more information about thread local storage, see [Thread Local Storage](/windows/desktop/ProcThread/thread-local-storage).</span></span>

## <a name="entry-point-function-definition"></a><span data-ttu-id="bfa65-132">Definizione della funzione Entry-Point</span><span class="sxs-lookup"><span data-stu-id="bfa65-132">Entry-Point Function Definition</span></span>

<span data-ttu-id="bfa65-133">La funzione del punto di ingresso della DLL deve essere dichiarata con la convenzione di chiamata standard.</span><span class="sxs-lookup"><span data-stu-id="bfa65-133">The DLL entry-point function must be declared with the standard-call calling convention.</span></span> <span data-ttu-id="bfa65-134">Se il punto di ingresso della DLL non è dichiarato correttamente, la DLL non viene caricata e il sistema Visualizza un messaggio che indica che il punto di ingresso della DLL deve essere dichiarato con WINAPI.</span><span class="sxs-lookup"><span data-stu-id="bfa65-134">If the DLL entry point is not declared correctly, the DLL is not loaded, and the system displays a message indicating that the DLL entry point must be declared with WINAPI.</span></span>

<span data-ttu-id="bfa65-135">Nel corpo della funzione è possibile gestire qualsiasi combinazione degli scenari seguenti in cui è stato chiamato il punto di ingresso della DLL:</span><span class="sxs-lookup"><span data-stu-id="bfa65-135">In the body of the function, you may handle any combination of the following scenarios in which the DLL entry point has been called:</span></span>

-   <span data-ttu-id="bfa65-136">Un processo carica la DLL (**\_ \_ associazione processo dll**).</span><span class="sxs-lookup"><span data-stu-id="bfa65-136">A process loads the DLL (**DLL\_PROCESS\_ATTACH**).</span></span>
-   <span data-ttu-id="bfa65-137">Il processo corrente crea un nuovo thread (**\_ \_ connessione thread dll**).</span><span class="sxs-lookup"><span data-stu-id="bfa65-137">The current process creates a new thread (**DLL\_THREAD\_ATTACH**).</span></span>
-   <span data-ttu-id="bfa65-138">Un thread viene chiuso normalmente (**\_ \_ scollegamento del thread dll**).</span><span class="sxs-lookup"><span data-stu-id="bfa65-138">A thread exits normally (**DLL\_THREAD\_DETACH**).</span></span>
-   <span data-ttu-id="bfa65-139">Un processo Scarica la DLL (**\_ \_ scollegamento del processo dll**).</span><span class="sxs-lookup"><span data-stu-id="bfa65-139">A process unloads the DLL (**DLL\_PROCESS\_DETACH**).</span></span>

<span data-ttu-id="bfa65-140">La funzione del punto di ingresso deve eseguire solo attività di inizializzazione semplici.</span><span class="sxs-lookup"><span data-stu-id="bfa65-140">The entry-point function should perform only simple initialization tasks.</span></span> <span data-ttu-id="bfa65-141">Non deve chiamare la funzione [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) o [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (o una funzione che chiama queste funzioni), perché questo può creare cicli di dipendenza nell'ordine di caricamento della dll.</span><span class="sxs-lookup"><span data-stu-id="bfa65-141">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="bfa65-142">Questo può comportare l'uso di una DLL prima che il sistema abbia eseguito il codice di inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="bfa65-142">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="bfa65-143">Analogamente, la funzione del punto di ingresso non deve chiamare la funzione [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (o una funzione che chiama **FreeLibrary**) durante la terminazione del processo, perché questo può comportare l'uso di una dll dopo che il sistema ha eseguito il codice di terminazione.</span><span class="sxs-lookup"><span data-stu-id="bfa65-143">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="bfa65-144">Poiché è garantito il caricamento di Kernel32.dll nello spazio degli indirizzi del processo quando viene chiamata la funzione del punto di ingresso, la chiamata di funzioni in Kernel32.dll non comporta l'utilizzo della DLL prima dell'esecuzione del codice di inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="bfa65-144">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="bfa65-145">La funzione del punto di ingresso può quindi creare [oggetti di sincronizzazione](/windows/desktop/Sync/synchronization-objects) , ad esempio sezioni critiche e mutex, e usare TLS, perché queste funzioni si trovano in Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="bfa65-145">Therefore, the entry-point function can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS, because these functions are located in Kernel32.dll.</span></span> <span data-ttu-id="bfa65-146">Non è sicuro chiamare le funzioni del registro di sistema, ad esempio perché si trovano in Advapi32.dll.</span><span class="sxs-lookup"><span data-stu-id="bfa65-146">It is not safe to call the registry functions, for example, because they are located in Advapi32.dll.</span></span>

<span data-ttu-id="bfa65-147">La chiamata di altre funzioni può causare problemi difficili da diagnosticare.</span><span class="sxs-lookup"><span data-stu-id="bfa65-147">Calling other functions may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="bfa65-148">Ad esempio, la chiamata a user, Shell e funzioni COM può causare errori di violazione dell'accesso, perché alcune funzioni nelle DLL chiamano [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) per caricare altri componenti di sistema.</span><span class="sxs-lookup"><span data-stu-id="bfa65-148">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions in their DLLs call [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) to load other system components.</span></span> <span data-ttu-id="bfa65-149">Viceversa, la chiamata di tali funzioni durante la terminazione può causare errori di violazione di accesso perché il componente corrispondente potrebbe essere già stato scaricato o non inizializzato.</span><span class="sxs-lookup"><span data-stu-id="bfa65-149">Conversely, calling those functions during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="bfa65-150">Nell'esempio seguente viene illustrato come strutturare la funzione del punto di ingresso della DLL.</span><span class="sxs-lookup"><span data-stu-id="bfa65-150">The following example demonstrates how to structure the DLL entry-point function.</span></span>

``` syntax
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

## <a name="entry-point-function-return-value"></a><span data-ttu-id="bfa65-151">Valore restituito della funzione Entry-Point</span><span class="sxs-lookup"><span data-stu-id="bfa65-151">Entry-Point Function Return Value</span></span>

<span data-ttu-id="bfa65-152">Quando viene chiamata una funzione del punto di ingresso della DLL a causa del caricamento di un processo, la funzione restituisce **true** per indicare l'esito positivo.</span><span class="sxs-lookup"><span data-stu-id="bfa65-152">When a DLL entry-point function is called because a process is loading, the function returns **TRUE** to indicate success.</span></span> <span data-ttu-id="bfa65-153">Per i processi che usano il collegamento in fase di caricamento, un valore restituito di **false** causa l'esito negativo dell'inizializzazione del processo e il processo viene terminato.</span><span class="sxs-lookup"><span data-stu-id="bfa65-153">For processes using load-time linking, a return value of **FALSE** causes the process initialization to fail and the process terminates.</span></span> <span data-ttu-id="bfa65-154">Per i processi che usano il collegamento di run-time, un valore restituito di FALSE fa sì che la funzione [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) o [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) restituisca **null**, indicando un errore.</span><span class="sxs-lookup"><span data-stu-id="bfa65-154">For processes using run-time linking, a return value of FALSE causes the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function to return **NULL**, indicating failure.</span></span> <span data-ttu-id="bfa65-155">Il sistema chiama immediatamente la funzione del punto di ingresso con **il \_ processo dll \_ scollegato** e Scarica la dll. Il valore restituito della funzione del punto di ingresso viene ignorato quando la funzione viene chiamata per qualsiasi altro motivo.</span><span class="sxs-lookup"><span data-stu-id="bfa65-155">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) The return value of the entry-point function is disregarded when the function is called for any other reason.</span></span>

 

 
