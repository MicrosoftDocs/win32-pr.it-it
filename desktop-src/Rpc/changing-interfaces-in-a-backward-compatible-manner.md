---
title: Modifica delle interfacce in modo compatibile con le versioni precedenti
description: I metodi descritti nella teoria del controllo delle versioni per RPC e COM potrebbero essere inaccettabili per diversi motivi.
ms.assetid: 7dec4b67-3d50-453f-b0ef-290d091186fd
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 314daecc6b55aaf4a348411010eb578149f86921
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/20/2020
ms.locfileid: "103729802"
---
# <a name="changing-interfaces-in-a-backward-compatible-manner"></a><span data-ttu-id="b5064-103">Modifica delle interfacce in modo compatibile con le versioni precedenti</span><span class="sxs-lookup"><span data-stu-id="b5064-103">Changing Interfaces in a Backward Compatible Manner</span></span>

<span data-ttu-id="b5064-104">I metodi descritti nella [teoria del controllo delle versioni per RPC e com](the-versioning-theory-for-rpc-and-com.md) potrebbero essere inaccettabili per diversi motivi.</span><span class="sxs-lookup"><span data-stu-id="b5064-104">The methods explained in [The Versioning Theory for RPC and COM](the-versioning-theory-for-rpc-and-com.md) may be unacceptable for many reasons.</span></span> <span data-ttu-id="b5064-105">Per modificare una versione dell'interfaccia in base alle regole, è necessario che i nuovi client non comunicano con i server obsoleti.</span><span class="sxs-lookup"><span data-stu-id="b5064-105">Changing an interface version according to the rules essentially requires that new clients not communicate with old servers.</span></span> <span data-ttu-id="b5064-106">Questa operazione è spesso impossibile con il software commerciale distribuito nel campo.</span><span class="sxs-lookup"><span data-stu-id="b5064-106">This is frequently impossible with commercial software deployed in the field.</span></span> <span data-ttu-id="b5064-107">In alcuni casi, Windows ha introdotto modifiche dell'interfaccia senza GUID o versioni modificate.</span><span class="sxs-lookup"><span data-stu-id="b5064-107">Sometimes, Windows has introduced interface changes absent of changed GUIDs or versions.</span></span> <span data-ttu-id="b5064-108">Si tratta di un risultato di nuovi client che devono comunicare con i server legacy e perché la soluzione che un nuovo client supporterà sia la vecchia che la nuova interfaccia era considerata indesiderata.</span><span class="sxs-lookup"><span data-stu-id="b5064-108">This was a result of new clients needing to communicate with legacy servers, and because the solution that a new client would support both the old and new interfaces was deemed undesirable.</span></span>

## <a name="best-practice"></a><span data-ttu-id="b5064-109">Procedura consigliata</span><span class="sxs-lookup"><span data-stu-id="b5064-109">Best practice</span></span>

<span data-ttu-id="b5064-110">Questi sono i metodi ragionevoli per aggirare il problema di incompatibilità in rete quando non è possibile modificare il GUID e la versione dell'interfaccia.</span><span class="sxs-lookup"><span data-stu-id="b5064-110">These are the reasonable methods of working around the wire incompatibility issue when the interface GUID and version cannot be changed.</span></span>

1.  <span data-ttu-id="b5064-111">Assicurarsi che l'applicazione sia in grado di riconoscere le funzionalità dell'altro lato.</span><span class="sxs-lookup"><span data-stu-id="b5064-111">Have the application be aware of the other side's capabilities.</span></span>

    <span data-ttu-id="b5064-112">Il client e il server dispongono di un protocollo che consente a ognuno o almeno il nuovo client di stabilire l'identità del partner.</span><span class="sxs-lookup"><span data-stu-id="b5064-112">The client and server have a protocol that enables each (or at least the new client) to establish the identity of the partner.</span></span> <span data-ttu-id="b5064-113">In genere è sufficiente che il nuovo client sia in grado di riconoscere le funzionalità supportate dai server vecchi e nuovi.</span><span class="sxs-lookup"><span data-stu-id="b5064-113">Typically it is sufficient to have the new client be aware of features supported by old and new servers.</span></span> <span data-ttu-id="b5064-114">Questa operazione può essere eseguita facilmente quando un'applicazione viene mantenuta in un contesto di connessione ed è supportata tramite un tipo *XxxGetInfo* di chiamata di funzione eseguita dal client prima di eseguire qualsiasi operazione RPC.</span><span class="sxs-lookup"><span data-stu-id="b5064-114">This may easily be done when an application holds on to a connection context, and be supported through an *XxxGetInfo* type of function call executed by the client before performing any RPC operations.</span></span> <span data-ttu-id="b5064-115">Quando un'applicazione gestisce le funzionalità in base alle versioni per server, una chiamata con un'incompatibilità al server/client precedente non può mai verificarsi, dal momento che l'applicazione controlla quali chiamate vengono emesse al server.</span><span class="sxs-lookup"><span data-stu-id="b5064-115">When an application manages the features on a per-server release basis, a call with an incompatibility to the old server/client can never occur, since the application controls which calls are issued to which server.</span></span> <span data-ttu-id="b5064-116">La conclusione è che l'applicazione è proattiva in modo da impedire che si verifichi una mancata corrispondenza.</span><span class="sxs-lookup"><span data-stu-id="b5064-116">The bottom line is that the application is proactive in preventing a mismatch from happening.</span></span> <span data-ttu-id="b5064-117">Questa operazione può essere eseguita insieme alla seconda procedura.</span><span class="sxs-lookup"><span data-stu-id="b5064-117">This may be performed in conjunction with the second practice.</span></span>

2.  <span data-ttu-id="b5064-118">Introduce una nuova API remota.</span><span class="sxs-lookup"><span data-stu-id="b5064-118">Introduce a new remote API.</span></span>

    <span data-ttu-id="b5064-119">Un nuovo metodo remoto non è in conflitto con i metodi esistenti se viene aggiunto alla fine dell'interfaccia.</span><span class="sxs-lookup"><span data-stu-id="b5064-119">A new remote method does not collide with existing methods if it is added at the very end of the interface.</span></span> <span data-ttu-id="b5064-120">I client obsoleti possono chiamare nuovi server come hanno sempre.</span><span class="sxs-lookup"><span data-stu-id="b5064-120">Old clients can call new servers as they always have.</span></span> <span data-ttu-id="b5064-121">Il nuovo client può chiamare il nuovo metodo senza conoscere l'identità del server, purché controlla gli errori provenienti dal server chiamato.</span><span class="sxs-lookup"><span data-stu-id="b5064-121">The new client can call the new method without knowing the server's identity, provided it watches for the errors coming from the server being called.</span></span> <span data-ttu-id="b5064-122">Il runtime RPC controlla sempre il numero del metodo per ogni interfaccia prima di un dispatch per verificare che il metodo si trovi all'interno di una tabella v appropriata.</span><span class="sxs-lookup"><span data-stu-id="b5064-122">The RPC run time always checks the method number for each interface before a dispatch to ensure the method is within an appropriate v-table.</span></span> <span data-ttu-id="b5064-123">Per un metodo sconosciuto a un server, il tempo di esecuzione RPC genera l'eccezione \_ \_ PROCNUM di RPC non \_ compreso \_ nell' \_ intervallo.</span><span class="sxs-lookup"><span data-stu-id="b5064-123">For a method that is unknown to a server, the RPC run time raises the exception RPC\_S\_PROCNUM\_OUT\_OF\_RANGE.</span></span> <span data-ttu-id="b5064-124">Questa eccezione viene generata solo in questa particolare situazione.</span><span class="sxs-lookup"><span data-stu-id="b5064-124">This exception is raised only in this particular situation.</span></span> <span data-ttu-id="b5064-125">Un nuovo client può pertanto controllare l'eccezione come un segno che la chiamata è passata a un server precedente e può modificarne il comportamento normalmente.</span><span class="sxs-lookup"><span data-stu-id="b5064-125">Therefore, a new client can watch for the exception as a sign that the call went to an old server and can modify its behavior gracefully.</span></span>

3.  <span data-ttu-id="b5064-126">Introduce nuovi parametri o nuovi tipi di dati solo nei nuovi metodi.</span><span class="sxs-lookup"><span data-stu-id="b5064-126">Introduce new parameters or new data types only in the new methods.</span></span>

    <span data-ttu-id="b5064-127">Un motivo per introdurre un nuovo metodo consiste nell'evitare incompatibilità dei dati.</span><span class="sxs-lookup"><span data-stu-id="b5064-127">One reason to introduce a new method is to avoid data incompatibility.</span></span> <span data-ttu-id="b5064-128">Se viene introdotto o semplicemente modificato un nuovo tipo di dati, in principio è consigliabile utilizzarlo solo in un nuovo metodo (o metodi).</span><span class="sxs-lookup"><span data-stu-id="b5064-128">If a new data type is introduced or simply modified, in principle it should be used only in a new method (or methods).</span></span> <span data-ttu-id="b5064-129">Per esempi di modifiche incompatibili con i tipi di dati, vedere [esempi di modifiche incompatibili](examples-of-incompatible-changes.md) .</span><span class="sxs-lookup"><span data-stu-id="b5064-129">See [Examples of Incompatible Changes](examples-of-incompatible-changes.md) for examples of incompatible data type changes.</span></span> <span data-ttu-id="b5064-130">L'unica eccezione rilevante a questa regola è descritta nell'elemento quattro.</span><span class="sxs-lookup"><span data-stu-id="b5064-130">The only notable exception to this rule is described in item four.</span></span>

4.  <span data-ttu-id="b5064-131">Eseguire il mapping di nuovi parametri o nuovi tipi di dati tramite un wrapper.</span><span class="sxs-lookup"><span data-stu-id="b5064-131">Map new parameters or new data types through a wrapper.</span></span>

    <span data-ttu-id="b5064-132">Questa soluzione si applica quando un nuovo parametro o tipo di dati deve essere esposto a un utente, ma in realtà non è necessario eseguirlo separatamente oppure può essere mappato ai tipi di dati o ai parametri obsoleti.</span><span class="sxs-lookup"><span data-stu-id="b5064-132">This solution applies when a new parameter or data type must be exposed to a user, but actually does not have to be remoted separately or can be mapped to the old data types or parameters.</span></span> <span data-ttu-id="b5064-133">Molte API di sistema, ad esempio, si rivolgono ed eseguono una chiamata remota.</span><span class="sxs-lookup"><span data-stu-id="b5064-133">For example, many system APIs turn around and execute a remote call.</span></span> <span data-ttu-id="b5064-134">È possibile che non si stiano eseguendo un mapping dai tipi di dati conosciuti dall'utente ai tipi di dati effettivamente utilizzati nella chiamata RPC sottostante.</span><span class="sxs-lookup"><span data-stu-id="b5064-134">They may or may not be doing some kind of mapping from the user known data types to the data types actually used in the underlying RPC call.</span></span> <span data-ttu-id="b5064-135">È pertanto sempre opportuno esaminare se la modifica nell'interfaccia utente deve essere propagata come una modifica a un'interfaccia remota.</span><span class="sxs-lookup"><span data-stu-id="b5064-135">It is therefore always worth examining if the change in the user interface needs to propagate as a change to a remote interface.</span></span>

    <span data-ttu-id="b5064-136">Una situazione simile può verificarsi quando l'utente chiama direttamente un'API remota, ma è possibile che venga introdotto un wrapper per eseguire un nuovo mapping dei tipi o altre azioni aggiuntive che sono diventate necessarie.</span><span class="sxs-lookup"><span data-stu-id="b5064-136">A similar situation may happen when the user calls a remote API directly, but a wrapper could be introduced to do a new type mapping or some other additional actions that have become necessary.</span></span> <span data-ttu-id="b5064-137">Il linguaggio di definizione dell'interfaccia (IDL) presenta diversi modi per facilitare tale modifica, ovvero \[ [**chiamare \_ come**](/windows/desktop/Midl/call-as) \] , \[ [**trasmettere \_ come**](/windows/desktop/Midl/transmit-as) \] e il \[ [**\_ marshalling di rete**](/windows/desktop/Midl/wire-marshal) \] .</span><span class="sxs-lookup"><span data-stu-id="b5064-137">Interface Definition Language (IDL) has several ways of facilitating such remapping, namely \[[**call\_as**](/windows/desktop/Midl/call-as)\], \[[**transmit\_as**](/windows/desktop/Midl/transmit-as)\], and \[[**wire\_marshal**](/windows/desktop/Midl/wire-marshal)\].</span></span> <span data-ttu-id="b5064-138">L' \[ attributo **Call \_ As** \] introduce un wrapper di funzione nel client e nel server.</span><span class="sxs-lookup"><span data-stu-id="b5064-138">The \[**call\_as**\] attribute introduces a function wrapper on the client and server.</span></span> <span data-ttu-id="b5064-139">Entrambi sono posizionati tra il codice utente e il gestore di marshalling.</span><span class="sxs-lookup"><span data-stu-id="b5064-139">Both are placed between the user code and the marshaler.</span></span> <span data-ttu-id="b5064-140">Gli altri attributi gestiscono il mapping dei tipi diretti.</span><span class="sxs-lookup"><span data-stu-id="b5064-140">The other attributes deal with direct type mapping.</span></span> <span data-ttu-id="b5064-141">Per i problemi relativi all'estensione, \[ **chiamare \_ As** \] è il più usato ed è più facile da comprendere e manipolare senza insidie.</span><span class="sxs-lookup"><span data-stu-id="b5064-141">For extension problems, \[**call\_as**\] is the most frequently used, and is easiest to understand and manipulate without pitfalls.</span></span>

5.  <span data-ttu-id="b5064-142">Modificare i tipi di dati tramite un'unione predefinita.</span><span class="sxs-lookup"><span data-stu-id="b5064-142">Modify data types through a defaultless union.</span></span>

    <span data-ttu-id="b5064-143">La modifica di un attributo o di un tipo di dati causa in genere l'incompatibilità in transito.</span><span class="sxs-lookup"><span data-stu-id="b5064-143">Changing an attribute or data type typically leads to wire incompatibility.</span></span> <span data-ttu-id="b5064-144">Per esempi, vedere [esempi di modifiche incompatibili](examples-of-incompatible-changes.md) .</span><span class="sxs-lookup"><span data-stu-id="b5064-144">See [Examples of Incompatible Changes](examples-of-incompatible-changes.md) for examples.</span></span> <span data-ttu-id="b5064-145">Tuttavia, nel caso di un'Unione senza una clausola default, l'incompatibilità può essere gestita in modo analogo al caso di una procedura non compresa nell'intervallo, come descritto in precedenza.</span><span class="sxs-lookup"><span data-stu-id="b5064-145">However, in the case of a union without a default clause, the incompatibility may be managed in a way similar to the case of a procedure out of range, as described previously.</span></span> <span data-ttu-id="b5064-146">Questo schema è prontamente applicabile ai tipi *XxxINFO* più diffusi che usano le unioni.</span><span class="sxs-lookup"><span data-stu-id="b5064-146">This scheme is readily applicable to the popular *XxxINFO* types that use unions.</span></span>

    <span data-ttu-id="b5064-147">Ad esempio, una chiamata come questa</span><span class="sxs-lookup"><span data-stu-id="b5064-147">For example, a call like this</span></span>

    ```C++
    XxxGetInfo( [in] level, [out] XxxINFO  * pInfo );
    ```

    

    <span data-ttu-id="b5064-148">può restituire informazioni al livello 1, 2 o 3, con *XxxINFO* che è un'Unione con tre rami: 1, 2 e 3.</span><span class="sxs-lookup"><span data-stu-id="b5064-148">could return information at level 1, 2 or 3, with *XxxINFO* being a union with three branches: 1, 2 and 3.</span></span>

6.  <span data-ttu-id="b5064-149">Usare l' \[ attributo [**Range**](/windows/desktop/Midl/range) \] per specificare l'intervallo.</span><span class="sxs-lookup"><span data-stu-id="b5064-149">Use the \[[**range**](/windows/desktop/Midl/range)\] attribute to specify range.</span></span>

    <span data-ttu-id="b5064-150">È possibile specificare l' \[ [](/windows/desktop/Midl/range) \] attributo di intervallo su un tipo di scala semplice senza compromettere la compatibilità con le versioni precedenti.</span><span class="sxs-lookup"><span data-stu-id="b5064-150">You can specify the \[[**range**](/windows/desktop/Midl/range)\] attribute on a simple scale type without breaking backward compatibility.</span></span> <span data-ttu-id="b5064-151">Questo attributo non influisce sul formato wire, ma durante l'unmarshalling RPC controlla il valore in Wire per verificare che sia compreso nell'intervallo specificato nel file con estensione IDL.</span><span class="sxs-lookup"><span data-stu-id="b5064-151">This attribute does not affect wire format, but during unmarshalling RPC checks the value on wire to confirm that it is within the range specified in the .idl file.</span></span> <span data-ttu-id="b5064-152">In caso contrario, \_ \_ viene generata un'eccezione RPC X \_ con binding non valido.</span><span class="sxs-lookup"><span data-stu-id="b5064-152">If not, a RPC\_X\_INVALID\_BOUND exception is thrown.</span></span> <span data-ttu-id="b5064-153">Questa operazione è particolarmente utile se il server è in grado di riconoscere le dimensioni massime di una matrice di dimensioni.</span><span class="sxs-lookup"><span data-stu-id="b5064-153">This is especially useful if the server knows the maximum size of a sized array.</span></span>

    <span data-ttu-id="b5064-154">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="b5064-154">For example:</span></span>

    ```C++
    HRESULT Method1( [in, range(0,100)] ULONG m, [size_is(m)] ULONG *plong); 
    ```

    

<span data-ttu-id="b5064-155">Il comportamento RPC quando il livello indicato è 4 e il ARM manca, dipende dalla definizione dell'Unione.</span><span class="sxs-lookup"><span data-stu-id="b5064-155">The RPC behavior when the indicated level is 4 and the arm is missing, depends on the definition of the union.</span></span> <span data-ttu-id="b5064-156">Per un'Unione con la clausola default definita, RPC trasmette un tipo indicato nella clausola default per un valore diverso da quello delle etichette ARM note (in questo caso, ovvero qualsiasi valore diverso da 1, 2 o 3).</span><span class="sxs-lookup"><span data-stu-id="b5064-156">For a union with the default clause defined, RPC transmits a type indicated in the default clause for anything different than the known arm labels (in this case, anything other than 1, 2 or 3).</span></span> <span data-ttu-id="b5064-157">Per un'Unione senza valore predefinito, l'unmarshaller genera un'eccezione perché per definizione non esiste alcun valore predefinito di cui eseguire il fallback.</span><span class="sxs-lookup"><span data-stu-id="b5064-157">For a defaultless union, the unmarshaler raises an exception because by definition there is no default to fall back to.</span></span> <span data-ttu-id="b5064-158">L'eccezione è il \_ \_ tag RPC non valido \_ .</span><span class="sxs-lookup"><span data-stu-id="b5064-158">The exception is RPC\_S\_INVALID\_TAG.</span></span>

<span data-ttu-id="b5064-159">Anche in questo caso, un nuovo client può modificare il proprio comportamento al momento di scoprire che ha chiamato un vecchio server.</span><span class="sxs-lookup"><span data-stu-id="b5064-159">Again, a new client can adjust its behavior upon discovering that it called an old server.</span></span>

<span data-ttu-id="b5064-160">Di seguito sono riportate le procedure consigliate che se è necessario progettare un tipo di dati utilizzabile in remoto che può essere esteso in futuro, utilizzare un'Unione non predefinita nel file IDL.</span><span class="sxs-lookup"><span data-stu-id="b5064-160">What follows from these recommended practices is that if a remotable data type must be designed that can be extended in future, use a defaultless union in the IDL file.</span></span> <span data-ttu-id="b5064-161">Data una scelta, un'Unione incapsulata è leggermente più pulita.</span><span class="sxs-lookup"><span data-stu-id="b5064-161">Given a choice, an encapsulated union is slightly cleaner.</span></span>

<span data-ttu-id="b5064-162">A causa delle peculiarità della rappresentazione interna del protocollo di trasmissione NDR64, l'indicazione per l'aggiunta di armi fornite in precedenza in questa sezione deve essere qualificata come indicato di seguito: il nuovo ARM aggiunto non può modificare l'allineamento dell'Unione e, in particolare, l'allineamento più grande delle armi non deve cambiare.</span><span class="sxs-lookup"><span data-stu-id="b5064-162">Due to quirks of internal representation of the NDR64 wire protocol, the recommendation for adding arms provided earlier in this section needs to be qualified as follows: The new arm being added cannot change the alignment of the union, and in particular, the biggest alignment of the arms should not change.</span></span> <span data-ttu-id="b5064-163">Si tratta in genere di un problema, in quanto un puntatore in un ARM impone l'allineamento a 8.</span><span class="sxs-lookup"><span data-stu-id="b5064-163">This is typically not an issue, as a pointer in an arm forces alignment to 8.</span></span> <span data-ttu-id="b5064-164">Un progetto in cui ogni ARM è un puntatore a un tipo ARM è un metodo pulito per soddisfare il requisito.</span><span class="sxs-lookup"><span data-stu-id="b5064-164">A design where each arm is a pointer to an arm type is one clean way of satisfying the requirement.</span></span>

 

 