---
description: Informazioni su come creare un motore di sincronizzazione di file cloud che usa file segnaposto usando l'API file cloud.
title: Creare un motore di sincronizzazione cloud che supporti i file segnaposto
ms.topic: article
ms.date: 11/12/2020
ms.openlocfilehash: 4f1330285d0c8ef0359639f2be84162f8bc2ef3b
ms.sourcegitcommit: 3bdf30edb314e0fcd17dc4ddbc70e4ec7d3596e6
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 02/10/2021
ms.locfileid: "104554885"
---
# <a name="build-a-cloud-sync-engine-that-supports-placeholder-files"></a><span data-ttu-id="713a7-103">Creare un motore di sincronizzazione cloud che supporti i file segnaposto</span><span class="sxs-lookup"><span data-stu-id="713a7-103">Build a Cloud Sync Engine that Supports Placeholder Files</span></span>

<span data-ttu-id="713a7-104">Un motore di sincronizzazione è un servizio che sincronizza i file, in genere tra un host remoto e un client locale.</span><span class="sxs-lookup"><span data-stu-id="713a7-104">A sync engine is a service that syncs files, typically between a remote host and a local client.</span></span> <span data-ttu-id="713a7-105">I motori di sincronizzazione in Windows spesso presentano tali file all'utente tramite Windows file system ed Esplora file.</span><span class="sxs-lookup"><span data-stu-id="713a7-105">Sync engines on Windows often present those files to the user through the Windows file system and File Explorer.</span></span> <span data-ttu-id="713a7-106">Prima di Windows 10, la versione 1709, il supporto del motore di sincronizzazione in Windows era limitato a superfici ad hoc indipendenti dallo scenario, come il riquadro di spostamento di Esplora file, la barra di sistema di Windows e (per applicazioni più tecniche) file system i driver di filtro.</span><span class="sxs-lookup"><span data-stu-id="713a7-106">Before Windows 10, version 1709, sync engine support in Windows was limited to scenario-agnostic ad-hoc surfaces, such as File Explorer’s navigation pane, the Windows system tray, and (for more technical applications) file system filter drivers.</span></span>

<span data-ttu-id="713a7-107">Windows 10 versione 1709 (denominata anche Fall Creators Update) ha introdotto l' *API per i file Cloud*.</span><span class="sxs-lookup"><span data-stu-id="713a7-107">Windows 10 version 1709 (also called the Fall Creators Update) introduced the *cloud files API*.</span></span> <span data-ttu-id="713a7-108">Questa API è una nuova piattaforma che formalizza il supporto per i motori di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-108">This API is a new platform that formalizes support for sync engines.</span></span> <span data-ttu-id="713a7-109">L'API file Cloud fornisce il supporto per i motori di sincronizzazione in modo da offrire molti nuovi vantaggi agli sviluppatori e agli utenti finali.</span><span class="sxs-lookup"><span data-stu-id="713a7-109">The cloud files API provides support for sync engines in a way that offers many new benefits to developers and end users.</span></span>

<span data-ttu-id="713a7-110">L'API per i file cloud contiene le API Win32 native e Windows Runtime (WinRT) seguenti:</span><span class="sxs-lookup"><span data-stu-id="713a7-110">The cloud files API contains the following native Win32 APIs and Windows Runtime (WinRT) APIs:</span></span>

* <span data-ttu-id="713a7-111">[API di filtro cloud](cloud-filter-reference.md): questa API Win32 nativa fornisce funzionalità al limite tra la modalità utente e la file System.</span><span class="sxs-lookup"><span data-stu-id="713a7-111">[Cloud Filter API](cloud-filter-reference.md): This native Win32 API provides functionality at the boundary between the user mode and the file system.</span></span> <span data-ttu-id="713a7-112">Questa API gestisce la creazione e la gestione di file e directory segnaposto.</span><span class="sxs-lookup"><span data-stu-id="713a7-112">This API handles the creation and management of placeholder files and directories.</span></span>
* <span data-ttu-id="713a7-113">[Spazio dei nomi Windows. storage. provider](/uwp/api/windows.storage.provider): questa API WinRT consente alle applicazioni di configurare il provider di archiviazione cloud e di registrare la radice di sincronizzazione con il sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="713a7-113">[Windows.Storage.Provider namespace](/uwp/api/windows.storage.provider): This WinRT API enables applications to configure the cloud storage provider and register the sync root with the operating system.</span></span>

> [!NOTE]
> <span data-ttu-id="713a7-114">L'API file cloud attualmente non supporta l'implementazione di motori di sincronizzazione cloud nelle app UWP.</span><span class="sxs-lookup"><span data-stu-id="713a7-114">The cloud files API does not currently support implementing cloud sync engines in UWP apps.</span></span> <span data-ttu-id="713a7-115">I motori di sincronizzazione cloud devono essere implementati nelle app desktop.</span><span class="sxs-lookup"><span data-stu-id="713a7-115">Cloud sync engines must be implemented in desktop apps.</span></span>

## <a name="supported-features"></a><span data-ttu-id="713a7-116">Caratteristiche supportate</span><span class="sxs-lookup"><span data-stu-id="713a7-116">Supported features</span></span>

<span data-ttu-id="713a7-117">L'API per i file Cloud fornisce le funzionalità seguenti per la creazione di motori di sincronizzazione cloud.</span><span class="sxs-lookup"><span data-stu-id="713a7-117">The cloud files API provides the following features for building cloud sync engines.</span></span>

### <a name="placeholder-files"></a><span data-ttu-id="713a7-118">File segnaposto</span><span class="sxs-lookup"><span data-stu-id="713a7-118">Placeholder files</span></span>

* <span data-ttu-id="713a7-119">I motori di sincronizzazione possono creare file segnaposto che utilizzano solo 1 KB di spazio di archiviazione per l'intestazione filesystem e che vengono automaticamente idratati in file completi in condizioni di utilizzo normali.</span><span class="sxs-lookup"><span data-stu-id="713a7-119">Sync engines can create placeholder files that consume only 1 KB of storage for the filesystem header, and that automatically hydrate into full files under normal use conditions.</span></span> <span data-ttu-id="713a7-120">File segnaposto presenti come file tipici per le app e per gli utenti finali nella shell di Windows.</span><span class="sxs-lookup"><span data-stu-id="713a7-120">Placeholder files present as typical files to apps and to end users in the Windows Shell.</span></span>
* <span data-ttu-id="713a7-121">I file segnaposto sono integrati verticalmente dal kernel di Windows fino alla shell di Windows e la compatibilità delle app con i file segnaposto in genere non è un problema.</span><span class="sxs-lookup"><span data-stu-id="713a7-121">Placeholder files are vertically integrated from the Windows kernel up to the Windows Shell, and app compatibility with placeholder files is generally a non-issue.</span></span> <span data-ttu-id="713a7-122">Se si usano file system API, il prompt dei comandi o un desktop o un'app UWP per accedere a un file segnaposto, il file verrà idrato senza modifiche aggiuntive al codice e l'app potrà usare il file normalmente.</span><span class="sxs-lookup"><span data-stu-id="713a7-122">Whether you use file system APIs, the Command Prompt, or a desktop or a UWP app to access a placeholder file, the file will hydrate without additional code changes and that app can use the file normally.</span></span>
* <span data-ttu-id="713a7-123">I file possono esistere in tre stati:</span><span class="sxs-lookup"><span data-stu-id="713a7-123">Files can exist in three states:</span></span>
  * <span data-ttu-id="713a7-124">**File segnaposto**: rappresentazione vuota del file e disponibile solo se il servizio di sincronizzazione è disponibile.</span><span class="sxs-lookup"><span data-stu-id="713a7-124">**Placeholder file**: An empty representation of the file and only available if the sync service is available.</span></span>
  * <span data-ttu-id="713a7-125">**File completo**: il file è stato idratato in modo implicito e potrebbe essere disidratato dal sistema se è necessario spazio.</span><span class="sxs-lookup"><span data-stu-id="713a7-125">**Full file**: The file has been hydrated implicitly and could be dehydrated by the system if space is needed.</span></span>
  * <span data-ttu-id="713a7-126">**File completo bloccato**: il file è stato idratato in modo esplicito dall'utente tramite Esplora file ed è garantito che sia disponibile offline.</span><span class="sxs-lookup"><span data-stu-id="713a7-126">**Pinned full file**: The file has been hydrated explicitly by the user through File Explorer and is guaranteed to be available offline.</span></span>

<span data-ttu-id="713a7-127">Nell'immagine seguente viene illustrato il modo in cui vengono visualizzati gli Stati dei file completi segnaposto, completo e bloccato in Esplora file.</span><span class="sxs-lookup"><span data-stu-id="713a7-127">The following image demonstrates how the placeholder, full, and pinned full file states are shown in File Explorer.</span></span>

  ![Esempio di tre stati di file in Esplora file](images/cloud-file-states-file-explorer.png)

### <a name="standardized-sync-root-registration"></a><span data-ttu-id="713a7-129">Registrazione radice di sincronizzazione standardizzata</span><span class="sxs-lookup"><span data-stu-id="713a7-129">Standardized sync root registration</span></span>

* <span data-ttu-id="713a7-130">La registrazione di una radice di sincronizzazione è semplice e standardizzata.</span><span class="sxs-lookup"><span data-stu-id="713a7-130">Registering a sync root is straightforward and standardized.</span></span> <span data-ttu-id="713a7-131">Ciò include la creazione di un nodo personalizzato nel riquadro di spostamento di Esplora file, come illustrato nella schermata seguente.</span><span class="sxs-lookup"><span data-stu-id="713a7-131">This includes creation of a branded node in the navigation pane of File Explorer, as shown in the following screenshot.</span></span> <span data-ttu-id="713a7-132">È possibile creare radici come singole voci di primo livello o come elementi figlio di un raggruppamento padre.</span><span class="sxs-lookup"><span data-stu-id="713a7-132">Roots can be created either as individual top-level entries, or as children of a parent grouping.</span></span>

  ![Esempio di una voce radice di sincronizzazione in Esplora file](images/register-sync-root-file-explorer.png)

### <a name="shell-integration"></a><span data-ttu-id="713a7-134">Integrazione della shell</span><span class="sxs-lookup"><span data-stu-id="713a7-134">Shell integration</span></span>

* <span data-ttu-id="713a7-135">Icone di stato:</span><span class="sxs-lookup"><span data-stu-id="713a7-135">State icons:</span></span>
  * <span data-ttu-id="713a7-136">L'API file Cloud fornisce le icone di stato di idratazione automatiche standardizzate visualizzate in Esplora file e sul desktop di Windows.</span><span class="sxs-lookup"><span data-stu-id="713a7-136">The cloud files API provides standardized, automatic hydration state icons shown in File Explorer and on the Windows desktop.</span></span>
  * <span data-ttu-id="713a7-137">Oltre alle icone di stato standard di Windows usate per lo stato di idratazione, è possibile fornire icone di stato personalizzate per ulteriori proprietà specifiche del servizio.</span><span class="sxs-lookup"><span data-stu-id="713a7-137">In addition to the standard Windows state icons used for hydration state, you can provide custom state icons for additional service-specific properties.</span></span>
  * <span data-ttu-id="713a7-138">Sostituisce le estensioni legacy della shell di sovrapposizione delle icone.</span><span class="sxs-lookup"><span data-stu-id="713a7-138">Replaces legacy icon overlay Shell extensions.</span></span>
* <span data-ttu-id="713a7-139">Indicazione di stato:</span><span class="sxs-lookup"><span data-stu-id="713a7-139">Progress indication:</span></span>
  * <span data-ttu-id="713a7-140">L'apertura di un file segnaposto che richiede più di alcuni secondi per idratare indicherà lo stato dell'idratazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-140">Opening a placeholder file that takes more than a few seconds to hydrate will show hydration progress.</span></span> <span data-ttu-id="713a7-141">Lo stato di avanzamento viene visualizzato in alcune posizioni a seconda del contesto:</span><span class="sxs-lookup"><span data-stu-id="713a7-141">Progress is shown in a few locations depending on context:</span></span>
    * <span data-ttu-id="713a7-142">In una finestra di dialogo del motore di copia.</span><span class="sxs-lookup"><span data-stu-id="713a7-142">In a copy engine dialog window.</span></span>
    * <span data-ttu-id="713a7-143">Lo stato di avanzamento inline viene visualizzato accanto al file in Esplora file.</span><span class="sxs-lookup"><span data-stu-id="713a7-143">Inline progress is shown next to the file in File Explorer.</span></span>
    * <span data-ttu-id="713a7-144">Se il file non viene aperto con l'istruzione specifica dell'utente, viene visualizzata una notifica di tipo avviso popup che informa l'utente e fornisce un modo per controllare l'attività di idratazione imprevista.</span><span class="sxs-lookup"><span data-stu-id="713a7-144">If the file is not opened at the user’s specific instruction, a toast notification is shown to inform the user and provide a way to control unintended hydration activity.</span></span>
* <span data-ttu-id="713a7-145">Anteprime e metadati:</span><span class="sxs-lookup"><span data-stu-id="713a7-145">Thumbnails and metadata:</span></span>
  * <span data-ttu-id="713a7-146">I file segnaposto possono avere anteprime avanzate fornite dal servizio e metadati di file estesi per offrire all'utente un'esperienza di esplorazione di file semplice.</span><span class="sxs-lookup"><span data-stu-id="713a7-146">Placeholder files can have rich service-provided thumbnails and extended file metadata to provide the user with a seamless File Explorer experience.</span></span>
* <span data-ttu-id="713a7-147">Riquadro di spostamento di Esplora file:</span><span class="sxs-lookup"><span data-stu-id="713a7-147">File Explorer navigation pane:</span></span>
  * <span data-ttu-id="713a7-148">La registrazione di una radice di sincronizzazione con l'API dei file Cloud causa la visualizzazione della radice di sincronizzazione (con un'icona e un nome personalizzato) nel riquadro di spostamento di Esplora file.</span><span class="sxs-lookup"><span data-stu-id="713a7-148">Registering a sync root with the cloud files API causes that sync root (with an icon and custom name) to appear in File Explorer’s navigation pane.</span></span>
* <span data-ttu-id="713a7-149">Menu di scelta rapida di Esplora file:</span><span class="sxs-lookup"><span data-stu-id="713a7-149">File Explorer context menus:</span></span>
  * <span data-ttu-id="713a7-150">La registrazione di una radice di sincronizzazione con l'API file Cloud fornisce automaticamente diversi verbi (voci di menu) nel menu di scelta rapida di Esplora file che consentono all'utente di controllare lo stato di idratazione del file.</span><span class="sxs-lookup"><span data-stu-id="713a7-150">Registering a sync root with the cloud files API automatically provides several verbs (menu entries) in File Explorer’s context menu that let the user control the hydration state of their file.</span></span>
  * <span data-ttu-id="713a7-151">È possibile aggiungere verbi aggiuntivi a questa sezione del menu di scelta rapida usando le API compatibili con i desktop Bridge.</span><span class="sxs-lookup"><span data-stu-id="713a7-151">Additional verbs can be added to this section of the context menu using Desktop Bridge-compatible APIs.</span></span>
* <span data-ttu-id="713a7-152">Controllo utente dell'idratazione dei file:</span><span class="sxs-lookup"><span data-stu-id="713a7-152">User control of file hydration:</span></span>
  * <span data-ttu-id="713a7-153">Gli utenti hanno sempre il controllo dell'idratazione dei file, anche quando i file non vengono idratati in modo esplicito dall'utente.</span><span class="sxs-lookup"><span data-stu-id="713a7-153">Users are always in control of file hydration, even when the files are not hydrated explicitly by the user.</span></span> <span data-ttu-id="713a7-154">Viene visualizzato un avviso popup interattivo per l'idratazione in background per avvisare l'utente e fornire opzioni.</span><span class="sxs-lookup"><span data-stu-id="713a7-154">An interactive toast is shown for background hydration to alert the user and provide options.</span></span> <span data-ttu-id="713a7-155">Nell'immagine seguente viene illustrata una notifica di tipo avviso popup per un file idratante.</span><span class="sxs-lookup"><span data-stu-id="713a7-155">The following image demonstrates a toast notification for a hydrating file.</span></span>
    <span data-ttu-id="713a7-156">![Esempio di un avviso popup interattivo visualizzato per l'idratazione dei file in background](images/file-hydration-interactive-toast.png)</span><span class="sxs-lookup"><span data-stu-id="713a7-156">![Example of an interactive toast shown for background file hydration](images/file-hydration-interactive-toast.png)</span></span>
  * <span data-ttu-id="713a7-157">Se un utente blocca un'app da file idratanti tramite un avviso popup interattivo, può sbloccare l'app nella pagina di **download automatico dei file** in **Impostazioni**.</span><span class="sxs-lookup"><span data-stu-id="713a7-157">If a user blocks an app from hydrating files through an interactive toast, they can unblock the app in the **Automatic file downloads** page in **Settings**.</span></span>
    <span data-ttu-id="713a7-158">![Screenshot dell'impostazione di download automatico dei file](images/allow-automatic-file-downloads-setting.png)</span><span class="sxs-lookup"><span data-stu-id="713a7-158">![Screenshot of the automatic file downloads setting](images/allow-automatic-file-downloads-setting.png)</span></span>
* <span data-ttu-id="713a7-159">Associazione delle operazioni del motore di copia (supportata in Windows 10 Insider Preview Build 19624 e versioni successive):</span><span class="sxs-lookup"><span data-stu-id="713a7-159">Hooking copy engine operations (supported in Windows 10 Insider Preview Build 19624 and later versions):</span></span>
  * <span data-ttu-id="713a7-160">I provider di archiviazione cloud possono registrare un hook di copia della Shell per il monitoraggio delle operazioni sui file all'interno della radice di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-160">Cloud storage providers can register a shell copy hook for monitoring file operations within their sync root.</span></span>
  * <span data-ttu-id="713a7-161">Il provider registra l'hook di copia impostando il valore del registro di sistema **CopyHook** nella chiave del registro di sistema radice di sincronizzazione su un CLSID dell'oggetto server locale com.</span><span class="sxs-lookup"><span data-stu-id="713a7-161">The provider registers their copy hook by setting the **CopyHook** registry value under their sync root registry key to a the CLSID of their COM local server object.</span></span> <span data-ttu-id="713a7-162">Questo oggetto server locale implementa l'interfaccia [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) .</span><span class="sxs-lookup"><span data-stu-id="713a7-162">This local server object implements the [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) interface.</span></span>

### <a name="desktop-bridge"></a><span data-ttu-id="713a7-163">Desktop Bridge</span><span class="sxs-lookup"><span data-stu-id="713a7-163">Desktop Bridge</span></span>

* <span data-ttu-id="713a7-164">I motori di sincronizzazione che usano le API per i file cloud sono progettati per usare [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) come requisito di implementazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-164">Sync engines using the cloud files APIs are designed to use the [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) as an implementation requirement.</span></span>

## <a name="cloud-mirror-sample"></a><span data-ttu-id="713a7-165">Esempio di mirroring cloud</span><span class="sxs-lookup"><span data-stu-id="713a7-165">Cloud Mirror sample</span></span>

<span data-ttu-id="713a7-166">L' [esempio cloud mirror](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustra come compilare una soluzione che usa l'API per i file cloud.</span><span class="sxs-lookup"><span data-stu-id="713a7-166">The [Cloud Mirror sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustrates how to build a solution that uses the cloud files API.</span></span> <span data-ttu-id="713a7-167">Non può essere usato come codice di produzione.</span><span class="sxs-lookup"><span data-stu-id="713a7-167">It is not intended to be used as production code.</span></span> <span data-ttu-id="713a7-168">La gestione degli errori non è affidabile e viene scritta nel modo più semplice possibile.</span><span class="sxs-lookup"><span data-stu-id="713a7-168">It lacks robust error handling and it is written to be as easily understood as possible.</span></span> <span data-ttu-id="713a7-169">Questo metodo è denominato mirroring cloud perché riflette semplicemente una cartella locale nel disco locale.</span><span class="sxs-lookup"><span data-stu-id="713a7-169">It's called Cloud Mirror because it simply mirrors a local folder on your local disk.</span></span> <span data-ttu-id="713a7-170">Specificare una cartella del server destinata a rappresentare il file server cloud e una cartella client destinata a specificare il percorso radice di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-170">You specify a server folder that is meant to represent your cloud file server and a client folder that is meant to specify the sync root path.</span></span> <span data-ttu-id="713a7-171">Un nodo di primo livello viene visualizzato nel riquadro di spostamento in Esplora file denominato **TestStorageProviderDisplayName** e il nodo viene mappato alla cartella client specificata.</span><span class="sxs-lookup"><span data-stu-id="713a7-171">A top-level node appears in the navigation pane in File Explorer called **TestStorageProviderDisplayName**, and this node maps to the specified client folder.</span></span>

<span data-ttu-id="713a7-172">Per quanto riguarda la sincronizzazione, questi sono gli elementi che devono essere implementati da un provider di sincronizzazione dei file cloud completamente sviluppato:</span><span class="sxs-lookup"><span data-stu-id="713a7-172">When it comes to syncing, these are the things that a fully-developed cloud files sync provider must implement:</span></span>

* <span data-ttu-id="713a7-173">Quando il file radice di sincronizzazione è semplicemente un segnaposto, il servizio è responsabile della copia del contenuto del file per l'idratazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-173">When the sync root file is just a placeholder, the service is responsible for copying down the contents of the file for hydration.</span></span> <span data-ttu-id="713a7-174">Questa operazione è implementata nell'esempio.</span><span class="sxs-lookup"><span data-stu-id="713a7-174">This is implemented in the sample.</span></span>
* <span data-ttu-id="713a7-175">Quando il file radice di sincronizzazione è un file completo e il contenuto del file nel servizio cloud viene modificato, il servizio è responsabile della notifica al client di sincronizzazione locale della modifica e il client di sincronizzazione locale deve gestire le unioni in base alle specifiche.</span><span class="sxs-lookup"><span data-stu-id="713a7-175">When the sync root file is a full file and the contents of the file in the cloud service change, the service is responsible of notifying the local sync client of the change and the local sync client must handle merges according to their own specifications.</span></span> <span data-ttu-id="713a7-176">Questa operazione non è implementata nell'esempio.</span><span class="sxs-lookup"><span data-stu-id="713a7-176">This is not implemented in the sample.</span></span>
* <span data-ttu-id="713a7-177">Quando il file radice di sincronizzazione è un file completo e il contenuto del file nel percorso radice di sincronizzazione (client locale) cambia, il client di sincronizzazione locale deve inviare una notifica al servizio cloud e gestire le unioni in base alle specifiche.</span><span class="sxs-lookup"><span data-stu-id="713a7-177">When the sync root file is a full file and the contents of the file in the sync root path (the local client) change, the local sync client must notify the cloud service and handle merges according to their own specifications.</span></span> <span data-ttu-id="713a7-178">La notifica della modifica del file locale è implementata nell'esempio, ma non esegue alcuna operazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-178">The local file change notification is implemented in the sample, but it does not do anything.</span></span>

### <a name="use-the-sample"></a><span data-ttu-id="713a7-179">Usare l'esempio</span><span class="sxs-lookup"><span data-stu-id="713a7-179">Use the sample</span></span>

1. <span data-ttu-id="713a7-180">Creare due cartelle sul disco rigido locale.</span><span class="sxs-lookup"><span data-stu-id="713a7-180">Create two folders on your local hard drive.</span></span> <span data-ttu-id="713a7-181">Uno di essi fungerà da server e dall'altro come client.</span><span class="sxs-lookup"><span data-stu-id="713a7-181">One of them will act as the server and the other as the client.</span></span>
2. <span data-ttu-id="713a7-182">Aggiungere alcuni file alla cartella del server.</span><span class="sxs-lookup"><span data-stu-id="713a7-182">Add some files to the server folder.</span></span> <span data-ttu-id="713a7-183">Verificare che la cartella client sia vuota.</span><span class="sxs-lookup"><span data-stu-id="713a7-183">Make sure the client folder is empty.</span></span>
3. <span data-ttu-id="713a7-184">Aprire l'esempio cloud mirror in Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="713a7-184">Open the Cloud Mirror sample in Visual Studio.</span></span> <span data-ttu-id="713a7-185">Impostare il progetto **CloudMirrorPackage** come progetto di avvio e quindi compilare ed eseguire l'esempio.</span><span class="sxs-lookup"><span data-stu-id="713a7-185">Set the **CloudMirrorPackage** project as your startup project and then build and run the sample.</span></span> <span data-ttu-id="713a7-186">Quando richiesto dall'esempio, immettere i due percorsi per le cartelle server e client.</span><span class="sxs-lookup"><span data-stu-id="713a7-186">When prompted by the sample, enter the two paths to your server and client folders.</span></span> <span data-ttu-id="713a7-187">Al termine, verrà visualizzata una finestra della console con le informazioni di diagnostica.</span><span class="sxs-lookup"><span data-stu-id="713a7-187">After this you will see a console window with diagnostic information.</span></span>
4. <span data-ttu-id="713a7-188">Aprire Esplora file e verificare che siano visualizzati il nodo **TestStorageProviderDisplayName** e i segnaposto per tutti i file copiati nella cartella del server.</span><span class="sxs-lookup"><span data-stu-id="713a7-188">Open File Explorer and confirm that you see the **TestStorageProviderDisplayName** node and the placeholders for all the files that you copied into the server folder.</span></span> <span data-ttu-id="713a7-189">Per simulare un'applicazione che tenti di aprire i file senza utilizzare il selettore, copiare diverse immagini nella cartella del server.</span><span class="sxs-lookup"><span data-stu-id="713a7-189">To simulate an application that tries to open files without using the picker, copy several images to the server folder.</span></span> <span data-ttu-id="713a7-190">Fare doppio clic su uno di essi nella cartella radice di sincronizzazione e verificare che venga idratata.</span><span class="sxs-lookup"><span data-stu-id="713a7-190">Double-click one of them in your sync root folder and confirm that it hydrates.</span></span> <span data-ttu-id="713a7-191">Quindi, aprire l'app Photos.</span><span class="sxs-lookup"><span data-stu-id="713a7-191">Then, open the Photos app.</span></span> <span data-ttu-id="713a7-192">L'app effettuerà il pre-caricamento dei file adiacenti in background per rendere più probabile che l'utente non ritardi la ricerca nelle altre immagini.</span><span class="sxs-lookup"><span data-stu-id="713a7-192">The app will pre-load adjacent files in the background to make it more likely the user does not experience delays when looking through the other pictures.</span></span> <span data-ttu-id="713a7-193">È possibile osservare la disidratazione in background tramite popup o in Esplora file.</span><span class="sxs-lookup"><span data-stu-id="713a7-193">You can observe the background dehydration happen via toasts or in File Explorer.</span></span>
5. <span data-ttu-id="713a7-194">Fare clic con il pulsante destro del mouse su un file in Esplora file per visualizzare un menu di scelta rapida e verificare che sia visualizzata la voce di menu **TestCommand** .</span><span class="sxs-lookup"><span data-stu-id="713a7-194">Right-click a file in File Explorer to bring up a context menu, and confirm that you see the **TestCommand** menu item.</span></span> <span data-ttu-id="713a7-195">Quando si fa clic su questa voce di menu, viene visualizzata una finestra di messaggio.</span><span class="sxs-lookup"><span data-stu-id="713a7-195">Clicking this menu item will display a message box.</span></span>
6. <span data-ttu-id="713a7-196">Per arrestare l'esempio, impostare lo stato attivo sull'output della console e premere **CTRL-C**.</span><span class="sxs-lookup"><span data-stu-id="713a7-196">To stop the sample, set focus to the console output and press **Ctrl-C**.</span></span> <span data-ttu-id="713a7-197">Questa operazione consente di pulire la registrazione radice di sincronizzazione in modo che il provider venga disinstallato.</span><span class="sxs-lookup"><span data-stu-id="713a7-197">This will cleanup the sync root registration so that the provider is uninstalled.</span></span> <span data-ttu-id="713a7-198">Se l'esempio si arresta in modo anomalo, è possibile che la radice di sincronizzazione rimanga registrata.</span><span class="sxs-lookup"><span data-stu-id="713a7-198">If the sample crashes, it’s possible that the sync root will remain registered.</span></span> <span data-ttu-id="713a7-199">In questo modo verrà eseguito il riavviamento di Esplora file ogni volta che si fa clic su qualsiasi elemento e vengono richiesti i percorsi del client e del server fittizi.</span><span class="sxs-lookup"><span data-stu-id="713a7-199">This will cause File Explorer to relaunch every time you click on anything, and you would get prompted for the fake client and server locations.</span></span> <span data-ttu-id="713a7-200">In tal caso, disinstallare l'applicazione di esempio **CloudMirrorPackage** dal computer.</span><span class="sxs-lookup"><span data-stu-id="713a7-200">If this occurs, uninstall the **CloudMirrorPackage** sample application from your computer.</span></span>

### <a name="sample-architecture"></a><span data-ttu-id="713a7-201">Architettura di esempio</span><span class="sxs-lookup"><span data-stu-id="713a7-201">Sample architecture</span></span>

<span data-ttu-id="713a7-202">L'esempio è volutamente semplice.</span><span class="sxs-lookup"><span data-stu-id="713a7-202">The sample is deliberately simple.</span></span> <span data-ttu-id="713a7-203">USA classi statiche per rendere superfluo il passaggio di puntatori di istanza.</span><span class="sxs-lookup"><span data-stu-id="713a7-203">It uses static classes to make it unnecessary to pass instance pointers.</span></span> <span data-ttu-id="713a7-204">Di seguito sono riportate le classi principali dell'esempio:</span><span class="sxs-lookup"><span data-stu-id="713a7-204">Here are the main classes in the sample:</span></span>

* <span data-ttu-id="713a7-205">**FakeCloudProvider**: questa classe di primo livello controlla le classi di lavoro seguenti:</span><span class="sxs-lookup"><span data-stu-id="713a7-205">**FakeCloudProvider**: This top-level class controls the following worker classes:</span></span>
  * <span data-ttu-id="713a7-206">**CloudProviderRegistrar**: registra le informazioni della radice di sincronizzazione con la shell di Windows.</span><span class="sxs-lookup"><span data-stu-id="713a7-206">**CloudProviderRegistrar**: Registers the sync root information with the Windows Shell.</span></span>
  * <span data-ttu-id="713a7-207">**Segnaposto**: genera i file segnaposto nel percorso radice di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-207">**Placeholders**: Generates the placeholder files in the sync root path.</span></span>
  * <span data-ttu-id="713a7-208">**ShellServices**: crea i provider della shell di Windows per il menu di scelta rapida, le anteprime e altri servizi.</span><span class="sxs-lookup"><span data-stu-id="713a7-208">**ShellServices**: Constructs the Windows Shell providers for the context menu, thumbnails, and other services.</span></span>
  * <span data-ttu-id="713a7-209">**CloudProviderSyncRootWatcher**: crea un'istanza di un DirectoryWatcher per monitorare le modifiche al percorso radice di sincronizzazione e agire sulle modifiche.</span><span class="sxs-lookup"><span data-stu-id="713a7-209">**CloudProviderSyncRootWatcher**: Instantiates a DirectoryWatcher to monitor changes to the sync root path and act on changes.</span></span>
  * <span data-ttu-id="713a7-210">**FileCopierWithProgress**: copia i file dalla cartella del server alla cartella client lentamente in blocchi per simularne il download da un server cloud reale.</span><span class="sxs-lookup"><span data-stu-id="713a7-210">**FileCopierWithProgress**: Copies files from the server folder to the client folder slowly in chunks to simulate downloading them from a real cloud server.</span></span> <span data-ttu-id="713a7-211">Fornisce indicazioni sullo stato di avanzamento, in modo che i popup e l'interfaccia utente di Esplora file visualizzino l'utente.</span><span class="sxs-lookup"><span data-stu-id="713a7-211">Provides progress indication so that toasts and File Explorer UI shows the user something informative.</span></span>

<span data-ttu-id="713a7-212">Oltre alle classi precedenti, l'esempio fornisce anche diverse classi helper per richiedere all'utente le cartelle e alcune utilità.</span><span class="sxs-lookup"><span data-stu-id="713a7-212">In addition to the classes above, the sample also provides several helper classes to prompt the user for folders and some utilities.</span></span> <span data-ttu-id="713a7-213">**TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider** e **UriSource** sono tutti esempi di provider di servizi Shell.</span><span class="sxs-lookup"><span data-stu-id="713a7-213">The **TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider**, and **UriSource** are all examples of Shell service providers.</span></span>

## <a name="cloud-files-api-architecture"></a><span data-ttu-id="713a7-214">Architettura API dei file Cloud</span><span class="sxs-lookup"><span data-stu-id="713a7-214">Cloud files API architecture</span></span>

<span data-ttu-id="713a7-215">Alla base dello stack di archiviazione nell'API per i file Cloud è presente un driver file system mini denominato cldflt.sys.</span><span class="sxs-lookup"><span data-stu-id="713a7-215">At the core of the storage stack in the cloud files API is a file system minifilter driver called cldflt.sys.</span></span> <span data-ttu-id="713a7-216">Questo driver funge da proxy tra le applicazioni dell'utente e il motore di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-216">This driver acts as a proxy between the user’s applications and your sync engine.</span></span> <span data-ttu-id="713a7-217">Il motore di sincronizzazione sa come scaricare e caricare i dati su richiesta, mentre è responsabilità del cldflt.sys usare la Shell per presentare i file come se i dati del cloud fossero disponibili localmente.</span><span class="sxs-lookup"><span data-stu-id="713a7-217">Your sync engine knows how to download and upload the data on demand while it is responsibility of cldflt.sys to work with the Shell to present files as if the cloud data were locally available.</span></span>

<span data-ttu-id="713a7-218">Cldflt.sys attualmente supporta solo i volumi NTFS perché dipende da alcune funzionalità univoche per NTFS.</span><span class="sxs-lookup"><span data-stu-id="713a7-218">Cldflt.sys currently only supports NTFS volumes because it depends on some features unique to NTFS.</span></span>

<span data-ttu-id="713a7-219">Sono disponibili molti file system driver mini in un sistema e possono essere attivi contemporaneamente in un determinato volume.</span><span class="sxs-lookup"><span data-stu-id="713a7-219">There are many file system minifilter drivers in a system and they can be active on a given volume at the same time.</span></span> <span data-ttu-id="713a7-220">I driver di maggiore interesse per l'API per i file cloud sono i filtri file system antivirus.</span><span class="sxs-lookup"><span data-stu-id="713a7-220">The drivers that are of most interest to the cloud files API are the anti-virus file system filters.</span></span>

<span data-ttu-id="713a7-221">I driver mini del file System sono gestiti e supportati da un particolare componente in modalità kernel denominato gestione filtri.</span><span class="sxs-lookup"><span data-stu-id="713a7-221">File system minifilter drivers are managed and supported by a special kernel-mode component called the filter manager.</span></span> <span data-ttu-id="713a7-222">Tra molti altri compiti, gestione filtri facilita la comunicazione non filtrata tra i filtri e i componenti in modalità utente tramite un costrutto noto come porta filtro messaggio.</span><span class="sxs-lookup"><span data-stu-id="713a7-222">Among many other duties, the filter manager facilitates unfiltered communication between filters and user mode components via a construct known as filter message port.</span></span>

## <a name="hydration-policies"></a><span data-ttu-id="713a7-223">Criteri di idratazione</span><span class="sxs-lookup"><span data-stu-id="713a7-223">Hydration Policies</span></span>

<span data-ttu-id="713a7-224">Windows supporta un'ampia gamma di [criteri di idratazione primari](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) e modificatori di [criteri di idratazione secondari](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) .</span><span class="sxs-lookup"><span data-stu-id="713a7-224">Windows supports a variety of [primary hydration policies](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) and [secondary hydration policy](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) modifiers.</span></span> <span data-ttu-id="713a7-225">I criteri di idratazione primari hanno questo ordine:</span><span class="sxs-lookup"><span data-stu-id="713a7-225">Primary hydration policies have this order:</span></span>

  <span data-ttu-id="713a7-226">**Sempre pieno > > progressivo completo > parziale**</span><span class="sxs-lookup"><span data-stu-id="713a7-226">**Always full > Full > Progressive > Partial**</span></span>

<span data-ttu-id="713a7-227">Sia le applicazioni che i motori di sincronizzazione possono definire i criteri di idratazione primari preferiti.</span><span class="sxs-lookup"><span data-stu-id="713a7-227">Both applications and sync engines can define their preferred primary hydration policy.</span></span> <span data-ttu-id="713a7-228">Se non specificato, i criteri di idratazione predefiniti sono progressivi per le applicazioni e i motori di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="713a7-228">If not specified, the default hydration policy is progressive for both applications and sync engines.</span></span>

<span data-ttu-id="713a7-229">I criteri di idratazione di un file cloud vengono determinati in base all'ora di apertura del file da questa formula:</span><span class="sxs-lookup"><span data-stu-id="713a7-229">The hydration policy of a cloud file is determined at the file open time by this formula:</span></span>

  ```File hydration policy = max(app hydration policy, provider hydration policy)```

<span data-ttu-id="713a7-230">Si immagini, ad esempio, che l'utente stia tentando di aprire un file PDF archiviato nell'unità cloud Fabrikam usando contoso PDF Viewer, che non specifica i criteri di idratazione preferiti.</span><span class="sxs-lookup"><span data-stu-id="713a7-230">For example, let’s say the user is trying to open a PDF file stored on Fabrikam Cloud Drive using Contoso PDF Viewer, which doesn’t specify a preferred hydration policy.</span></span> <span data-ttu-id="713a7-231">I criteri di idratazione dell'applicazione sono quindi un'idratazione progressiva, in questo caso per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="713a7-231">The application hydration policy is therefore progressive hydration, in this case by default.</span></span> <span data-ttu-id="713a7-232">Tuttavia, poiché Fabrikam Cloud Drive è un motore di sincronizzazione dell'idratazione completa, i criteri di idratazione finali per il file diventano un'idratazione completa, pertanto il file verrà completamente idratato al primo accesso.</span><span class="sxs-lookup"><span data-stu-id="713a7-232">However, because Fabrikam Cloud Drive is a full hydration sync engine, the final hydration policy on the file becomes full hydration, which will result in the file being fully hydrated on first access.</span></span> <span data-ttu-id="713a7-233">Lo stesso risultato si verifica nei casi in cui il motore di sincronizzazione supporta l'idratazione progressiva, ma la preferenza dell'app è l'idratazione completa.</span><span class="sxs-lookup"><span data-stu-id="713a7-233">The same outcome happens in cases where the sync engine supports progressive hydration, but the app’s preference is full hydration.</span></span>

<span data-ttu-id="713a7-234">Si noti che i criteri di idratazione dei file non possono essere modificati dopo l'apertura del file.</span><span class="sxs-lookup"><span data-stu-id="713a7-234">Note that the file hydration policy cannot be changed after the file is opened.</span></span>

## <a name="compatibility-with-applications-that-use-reparse-points"></a><span data-ttu-id="713a7-235">Compatibilità con le applicazioni che usano i reparse point</span><span class="sxs-lookup"><span data-stu-id="713a7-235">Compatibility with applications that use reparse points</span></span>

<span data-ttu-id="713a7-236">L'API dei file Cloud implementa il sistema segnaposto usando i [reparse point](/windows/desktop/FileIO/reparse-points).</span><span class="sxs-lookup"><span data-stu-id="713a7-236">The cloud files API implements the placeholder system using [reparse points](/windows/desktop/FileIO/reparse-points).</span></span> <span data-ttu-id="713a7-237">Un malinteso comune sui reparse point è che corrispondono ai collegamenti simbolici.</span><span class="sxs-lookup"><span data-stu-id="713a7-237">A common misconception about reparse points is that they are the same as symbolic links.</span></span> <span data-ttu-id="713a7-238">Questo malinteso viene occasionalmente riflesso nelle implementazioni delle applicazioni e, di conseguenza, molte applicazioni esistenti rilevano errori quando si verifica un reparse point.</span><span class="sxs-lookup"><span data-stu-id="713a7-238">This misconception is occasionally reflected in application implementations, and as a result, many existing applications hit errors when encountering any reparse point.</span></span>

<span data-ttu-id="713a7-239">Per attenuare questo problema di compatibilità, l'API dei file Cloud nasconde sempre i reparse point da tutte le applicazioni, ad eccezione dei motori di sincronizzazione e dei processi la cui immagine principale risiede in **% systemroot%**.</span><span class="sxs-lookup"><span data-stu-id="713a7-239">To mitigate this compatibility issue, the cloud files API always hides its reparse points from all applications except for sync engines and processes whose main image resides under **%systemroot%**.</span></span> <span data-ttu-id="713a7-240">Le applicazioni che comunicano correttamente i reparse point possono forzare la piattaforma a esporre i reparse point API dei file cloud tramite [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) o [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span><span class="sxs-lookup"><span data-stu-id="713a7-240">Applications that understand reparse points correctly can force the platform to expose cloud files API reparse points using [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) or [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span></span>