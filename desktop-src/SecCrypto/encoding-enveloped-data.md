---
description: La sintassi del messaggio crittografico può essere usata per codificare i messaggi in busta digitale.
ms.assetid: f35aacda-6827-42e9-b7ac-58dc007fc697
title: Codifica dei dati in busta
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53dc20fc7483ba1ef364d8b59824d26bd14d458d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104555548"
---
# <a name="encoding-enveloped-data"></a><span data-ttu-id="7ed2c-103">Codifica dei dati in busta</span><span class="sxs-lookup"><span data-stu-id="7ed2c-103">Encoding Enveloped Data</span></span>

<span data-ttu-id="7ed2c-104">I dati in busta sono costituiti da contenuto crittografato di qualsiasi tipo e chiavi della sessione di crittografia del contenuto crittografate per uno o più destinatari.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-104">Enveloped data consists of encrypted content of any type and encrypted content-encryption session keys for one or more recipients.</span></span> <span data-ttu-id="7ed2c-105">I messaggi in busta digitale mantengono il contenuto del segreto del messaggio e consentono solo a persone o entità specifiche di recuperare il contenuto.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-105">Enveloped messages keep the contents of the message secret and allow only specified persons or entities to retrieve the contents.</span></span>

<span data-ttu-id="7ed2c-106">La sintassi del messaggio crittografico (CMS) può essere usata per codificare i messaggi in busta digitale.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-106">Cryptographic message syntax (CMS) can be used to encode enveloped messages.</span></span> <span data-ttu-id="7ed2c-107">CMS supporta tre tecniche di gestione delle chiavi: il trasporto chiavi, il contratto chiave e le chiavi di crittografia chiavi simmetriche distribuite in precedenza.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-107">CMS supports three key management techniques: key transport, key agreement, and previously distributed symmetric key-encryption keys (KEK).</span></span> <span data-ttu-id="7ed2c-108">La crittografia KEK simmetrica precedentemente distribuita è nota anche come distribuzione della chiave della lista di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-108">Previously distributed symmetric KEK are also known as mailing list key distribution.</span></span>

<span data-ttu-id="7ed2c-109">In ognuna di queste tre tecniche viene generata una singola chiave di sessione per crittografare il messaggio in busta digitale.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-109">In each of these three techniques, a single session key is generated to encrypt the enveloped message.</span></span> <span data-ttu-id="7ed2c-110">I problemi di gestione delle chiavi riguardano il modo in cui la chiave di sessione viene crittografata dal mittente e decrittografata da un ricevitore.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-110">Key management issues deal with the way that session key is encrypted by the sender and decrypted by a receiver.</span></span> <span data-ttu-id="7ed2c-111">Un singolo messaggio crittografato può essere distribuito a molti destinatari usando una combinazione delle tecniche di gestione delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-111">A single encrypted message can be distributed to many recipients using a mixture of the key management techniques.</span></span>

<span data-ttu-id="7ed2c-112">Per la crittografia della chiave della sessione, la gestione delle chiavi del trasporto chiave usa la chiave pubblica di un destinatario previsto.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-112">Key transport key management uses an intended receiver's public key to encrypt the session key.</span></span> <span data-ttu-id="7ed2c-113">Il ricevitore decrittografa la chiave della sessione utilizzando la chiave privata associata alla chiave pubblica utilizzata per la crittografia.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-113">The receiver decrypts the session key using the private key associated with the public key that was used to encrypt.</span></span> <span data-ttu-id="7ed2c-114">Il ricevitore usa quindi la chiave della sessione decrittografata per decrittografare i dati in busta.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-114">The receiver then uses the decrypted session key to decrypt the enveloped data.</span></span> <span data-ttu-id="7ed2c-115">Quando si utilizza il trasporto delle chiavi, il destinatario non ha confermato le informazioni sull'identità del mittente.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-115">When key transport is used, the receiver has not confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="7ed2c-116">Per la gestione dei contratti chiave, viene generata una chiave privata temporanea Diffie-Hellman temporanea che viene usata per crittografare la chiave della sessione.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-116">In key agreement management, a temporary, ephemeral Diffie-Hellman private key is generated and used to encrypt the session key.</span></span> <span data-ttu-id="7ed2c-117">La chiave pubblica corrispondente alla chiave privata temporanea è inclusa come parte delle informazioni sul destinatario del messaggio.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-117">The public key corresponding to the ephemeral private key is included as part of the message's recipient information.</span></span> <span data-ttu-id="7ed2c-118">Il destinatario decrittografa la chiave della sessione utilizzando la chiave temporanea ricevuta e utilizza la chiave della sessione decrittografata per decrittografare il messaggio in busta digitale.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-118">The recipient decrypts the session key using the received ephemeral key and uses this decrypted session key to decrypt the enveloped message.</span></span> <span data-ttu-id="7ed2c-119">Utilizzando il contratto di chiave temporanea insieme alla chiave privata del ricevitore, il destinatario del messaggio ha confermato le informazioni sull'identità del mittente.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-119">Using ephemeral key agreement in conjunction with the receiver's private key, the message receiver does have confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="7ed2c-120">Per la gestione delle chiavi con [*chiavi simmetriche*](../secgloss/s-gly.md)distribuite in precedenza, ogni messaggio include la chiave di crittografia del contenuto crittografata con una chiave di crittografia della chiave distribuita in precedenza.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-120">For key management using previously distributed [*symmetric keys*](../secgloss/s-gly.md), each message includes the content-encryption key that has been encrypted with a previously distributed key-encryption key.</span></span> <span data-ttu-id="7ed2c-121">I ricevitori usano la chiave di crittografia della chiave distribuita in precedenza per decrittografare la chiave di crittografia del contenuto e quindi usare la chiave di crittografia del contenuto decrittografata per decrittografare il messaggio in busta digitale.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-121">Receivers use the previously distributed key-encryption key to decrypt the content encryption key, then use the decrypted content-encryption key to decrypt the enveloped message.</span></span>

<span data-ttu-id="7ed2c-122">Nella figura seguente è illustrata una tipica sequenza di eventi CMS per la codifica dei dati in busta.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-122">A typical CMS sequence of events for encoding enveloped data, is shown in the following illustration.</span></span>

![codifica dei dati in busta](images/envelmsg.png)

-   <span data-ttu-id="7ed2c-124">Viene recuperato un puntatore al messaggio in [*testo non crittografato*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="7ed2c-124">A pointer to the [*plaintext*](../secgloss/p-gly.md) message is retrieved.</span></span>
-   <span data-ttu-id="7ed2c-125">Viene generata una chiave simmetrica ([*sessione*](../secgloss/s-gly.md)).</span><span class="sxs-lookup"><span data-stu-id="7ed2c-125">A symmetric ([*session*](../secgloss/s-gly.md)) key is generated.</span></span>
-   <span data-ttu-id="7ed2c-126">La [*chiave simmetrica*](../secgloss/s-gly.md) e l'algoritmo di crittografia specificato vengono utilizzati per crittografare i dati del messaggio.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-126">The [*symmetric key*](../secgloss/s-gly.md) and specified encryption algorithm are used to encrypt the message data.</span></span>
-   <span data-ttu-id="7ed2c-127">Viene aperto un [*archivio certificati*](../secgloss/c-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="7ed2c-127">A [*certificate store*](../secgloss/c-gly.md) is opened.</span></span>
-   <span data-ttu-id="7ed2c-128">Il certificato del destinatario viene recuperato dall'archivio.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-128">The recipient's certificate is retrieved from the store.</span></span>
-   <span data-ttu-id="7ed2c-129">La [*chiave pubblica*](../secgloss/p-gly.md) viene recuperata dal certificato del destinatario.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-129">The [*public key*](../secgloss/p-gly.md) is retrieved from the recipient's certificate.</span></span>
-   <span data-ttu-id="7ed2c-130">Utilizzando la chiave pubblica del destinatario, la chiave simmetrica viene crittografata.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-130">Using the recipient's public key, the symmetric key is encrypted.</span></span>
-   <span data-ttu-id="7ed2c-131">Dal certificato del destinatario viene recuperato l'ID del destinatario.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-131">From the recipient's certificate, the recipient's ID is retrieved.</span></span>
-   <span data-ttu-id="7ed2c-132">Le informazioni seguenti sono incluse nel messaggio in busta digitale: l'algoritmo di crittografia dei dati, i dati crittografati, la chiave simmetrica crittografata e la struttura delle informazioni sul destinatario.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-132">The following information is included in the digitally enveloped message: the data encryption algorithm, the encrypted data, the encrypted symmetric key, and the recipient information structure.</span></span>

<span data-ttu-id="7ed2c-133">Per utilizzare le funzioni di messaggio di basso livello per eseguire le attività tipiche elencate, attenersi alla procedura riportata di seguito.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-133">To use low-level message functions to accomplish the typical tasks just listed, use the following procedure.</span></span>

<span data-ttu-id="7ed2c-134">**Per codificare un messaggio in busta digitale**</span><span class="sxs-lookup"><span data-stu-id="7ed2c-134">**To encode an enveloped message**</span></span>

1.  <span data-ttu-id="7ed2c-135">Creare o recuperare il contenuto.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-135">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="7ed2c-136">Ottenere un provider di crittografia.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-136">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="7ed2c-137">Ottenere un certificato del destinatario.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-137">Get a recipient certificate.</span></span>
4.  <span data-ttu-id="7ed2c-138">Inizializza la struttura delle [**\_ informazioni di \_ codifica \_ in busta CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="7ed2c-138">Initialize the [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) structure.</span></span>
5.  <span data-ttu-id="7ed2c-139">Chiamare [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) per ottenere la dimensione del BLOB del messaggio codificato.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-139">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="7ed2c-140">Allocare memoria per l'it.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-140">Allocate memory for it.</span></span>
6.  <span data-ttu-id="7ed2c-141">Chiamare [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passando CMSG in \_ busta per *dwMsgType* e un puntatore a [**CMSG le \_ informazioni di \_ codifica \_ in busta**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) digitale per *pvMsgEncodeInfo*.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-141">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_ENVELOPED for *dwMsgType* and a pointer to [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvMsgEncodeInfo*.</span></span> <span data-ttu-id="7ed2c-142">In seguito a questa chiamata, verrà visualizzato un handle per il messaggio aperto.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-142">As a result of this call, you will get a handle to the opened message.</span></span>
7.  <span data-ttu-id="7ed2c-143">Chiamare [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passando l'handle recuperato nel passaggio 6 e un puntatore ai dati che devono essere crittografati, in busta e codificati.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-143">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 6 and a pointer to the data that is to be encrypted, enveloped, and encoded.</span></span> <span data-ttu-id="7ed2c-144">Questa funzione può essere chiamata il numero di volte necessario per completare il processo di codifica.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-144">This function can be called as many times as necessary to complete the encoding process.</span></span>
8.  <span data-ttu-id="7ed2c-145">Chiamare [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passando l'handle recuperato nel passaggio 6 e i tipi di parametro appropriati per accedere ai dati codificati desiderati.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-145">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 6 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="7ed2c-146">Ad esempio, passare CMSG \_ Content \_ param per ottenere un puntatore all'intero \# messaggio PKCS 7.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-146">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire PKCS \#7 message.</span></span>

    <span data-ttu-id="7ed2c-147">Se il risultato di questa codifica deve essere usato come [*dati interni*](../secgloss/i-gly.md) per un altro messaggio codificato, ad esempio un messaggio in busta, è \_ \_ necessario passare il parametro CMSG bare Content \_ param.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-147">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="7ed2c-148">Per un esempio, vedere [codice alternativo per la codifica di un messaggio in busta](alternate-code-for-encoding-an-enveloped-message.md)digitale.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-148">For an example, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

9.  <span data-ttu-id="7ed2c-149">Chiudere il messaggio chiamando [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="7ed2c-149">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="7ed2c-150">Il risultato di questa procedura è un messaggio codificato che contiene i dati crittografati, la [*chiave simmetrica*](../secgloss/s-gly.md) crittografata con le chiavi pubbliche del destinatario e le strutture dei dati delle informazioni sul destinatario.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-150">The result of this procedure is an encoded message that contains the encrypted data, the [*symmetric key*](../secgloss/s-gly.md) that is encrypted with the recipient's public keys, and the recipient information data structures.</span></span> <span data-ttu-id="7ed2c-151">La combinazione di contenuto crittografato e chiave simmetrica crittografata per un destinatario è una [*busta digitale*](../secgloss/d-gly.md) per tale destinatario.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-151">The combination of encrypted content and an encrypted symmetric key for a recipient is a [*digital envelope*](../secgloss/d-gly.md) for that recipient.</span></span> <span data-ttu-id="7ed2c-152">Qualsiasi tipo di contenuto può essere bustato per più destinatari.</span><span class="sxs-lookup"><span data-stu-id="7ed2c-152">Any type of content can be enveloped for multiple recipients.</span></span>

## <a name="related-topics"></a><span data-ttu-id="7ed2c-153">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="7ed2c-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="7ed2c-154">Esempio di programma C: codifica di un messaggio firmato in busta</span><span class="sxs-lookup"><span data-stu-id="7ed2c-154">Example C Program: Encoding an Enveloped, Signed Message</span></span>](example-c-program-encoding-an-enveloped-signed-message.md)
</dt> </dl>

 

 
