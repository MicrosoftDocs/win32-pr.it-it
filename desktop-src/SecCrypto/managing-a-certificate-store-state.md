---
description: Diverse funzioni forniscono servizi per la gestione dello stato di un archivio certificati.
ms.assetid: bae3d693-31b3-4c1d-9a8f-0dafa8bb6897
title: Gestione dello stato di un archivio certificati
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53d66e40817f0f92f48e8841455998eff4dbffd6
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/05/2021
ms.locfileid: "103968992"
---
# <a name="managing-a-certificate-store-state"></a><span data-ttu-id="bbbee-103">Gestione dello stato di un archivio certificati</span><span class="sxs-lookup"><span data-stu-id="bbbee-103">Managing a Certificate Store State</span></span>

<span data-ttu-id="bbbee-104">Diverse funzioni forniscono servizi per la gestione [*dello stato*](../secgloss/s-gly.md)di un [*archivio certificati*](../secgloss/c-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="bbbee-104">Several functions provide services for managing a [*certificate store*](../secgloss/c-gly.md) [*state*](../secgloss/s-gly.md).</span></span>

<span data-ttu-id="bbbee-105">Per ottenere l'accesso ai certificati, è necessario aprire l'archivio certificati in cui sono archiviati tramite una chiamata a [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) o [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span><span class="sxs-lookup"><span data-stu-id="bbbee-105">To gain access to certificates, the certificate store in which they are stored must be opened through a call to [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) or [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span></span>

<span data-ttu-id="bbbee-106">Un archivio certificati viene in genere aperto nella memoria memorizzata nella cache.</span><span class="sxs-lookup"><span data-stu-id="bbbee-106">Usually a certificate store is opened in cached memory.</span></span> <span data-ttu-id="bbbee-107">Può essere un nuovo archivio o il relativo contenuto può essere caricato dal registro di sistema locale, dal registro di sistema in un computer remoto, da un file su disco, da un \# messaggio PKCS 7 o da un'altra origine.</span><span class="sxs-lookup"><span data-stu-id="bbbee-107">It can be a new store or its contents can be loaded from the local registry, the registry on a remote computer, a disk file, a PKCS \#7 message, or some other source.</span></span>

<span data-ttu-id="bbbee-108">Le funzioni dell'archivio certificati CryptoAPI consentono inoltre a un archivio di mantenere certificati al di fuori della memoria memorizzata nella cache, ad esempio, un database esterno di certificati come quello fornito dal database del server di certificazione Microsoft.</span><span class="sxs-lookup"><span data-stu-id="bbbee-108">CryptoAPI certificate store functions also allow a store to maintain certificates outside cached memory in, for example, an external database of certificates such as the one provided by the Microsoft Certificate Server Database.</span></span>

<span data-ttu-id="bbbee-109">Uno dei parametri della funzione [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) , *lpszStoreProvider,* determina il tipo di archivio aperto e il provider utilizzato per aprire tale archivio.</span><span class="sxs-lookup"><span data-stu-id="bbbee-109">One of the parameters of the [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) function, *lpszStoreProvider,* determines the type of store opened and the provider used to open that store.</span></span> <span data-ttu-id="bbbee-110">Per esempi di apertura di archivi certificati con diversi provider, vedere [codice C di esempio per l'apertura di archivi certificati](example-c-code-for-opening-certificate-stores.md).</span><span class="sxs-lookup"><span data-stu-id="bbbee-110">For examples of opening certificate stores using various providers, see [Example C Code for Opening Certificate Stores](example-c-code-for-opening-certificate-stores.md).</span></span>

<span data-ttu-id="bbbee-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) chiude un archivio certificati.</span><span class="sxs-lookup"><span data-stu-id="bbbee-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes a certificate store.</span></span> <span data-ttu-id="bbbee-112">Quando un archivio certificati viene chiuso, ogni contesti di certificato in tale archivio ha un [*conteggio dei riferimenti*](../secgloss/r-gly.md) ridotto di uno.</span><span class="sxs-lookup"><span data-stu-id="bbbee-112">When a certificate store is closed, each of the certificate contexts in that store has its [*reference count*](../secgloss/r-gly.md) reduced by one.</span></span> <span data-ttu-id="bbbee-113">La memoria viene liberata per i certificati il cui conteggio dei riferimenti va a zero.</span><span class="sxs-lookup"><span data-stu-id="bbbee-113">Memory is freed for certificates whose reference count goes to zero.</span></span>

<span data-ttu-id="bbbee-114">L'impostazione \_ \_ del flag di chiusura \_ dell'archivio del certificato \_ con [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) chiude l'archivio certificati e libera la memoria per tutti i contesti di certificato indipendentemente dal conteggio dei riferimenti.</span><span class="sxs-lookup"><span data-stu-id="bbbee-114">Setting CERT\_CLOSE\_STORE\_FORCE\_FLAG with [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes the certificate store and frees memory for all of its certificate contexts regardless of their reference count.</span></span> <span data-ttu-id="bbbee-115">In alcuni casi, ad esempio nei programmi multithread, questa operazione non può essere utile.</span><span class="sxs-lookup"><span data-stu-id="bbbee-115">In some cases, such as in multithreaded programs, this cannot be desirable.</span></span> <span data-ttu-id="bbbee-116">Se \_ \_ \_ è impostato il flag di controllo CERT Close Store \_ , l'archivio viene chiuso, ma un valore di avviso viene restituito dalla funzione se la memoria è ancora allocata per i certificati i cui conteggi dei riferimenti non sono stati ridotti a zero.</span><span class="sxs-lookup"><span data-stu-id="bbbee-116">If CERT\_CLOSE\_STORE\_CHECK\_FLAG is set, the store is closed, but a warning value is returned by the function if memory is still allocated for certificates whose reference counts have not been reduced to zero.</span></span> <span data-ttu-id="bbbee-117">Se il conteggio dei riferimenti di un certificato è maggiore di zero, non è stato liberato un duplicato del contesto del certificato.</span><span class="sxs-lookup"><span data-stu-id="bbbee-117">If a certificate's reference count is greater than zero, a duplicate of that certificate context has not been freed.</span></span> <span data-ttu-id="bbbee-118">Usare [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext)e [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) per liberare tutti i certificati rimasti aperti.</span><span class="sxs-lookup"><span data-stu-id="bbbee-118">Use [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext), and [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) to free any certificates left open.</span></span>

> [!Note]
> <span data-ttu-id="bbbee-119">Un [*contesto del certificato*](../secgloss/c-gly.md) è una struttura di [**tipo \_ contesto**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) del certificato che include, tra gli altri membri, un puntatore al [*BLOB di certificati*](../secgloss/c-gly.md) codificati e un puntatore a una struttura di [**\_ informazioni**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) sul certificato.</span><span class="sxs-lookup"><span data-stu-id="bbbee-119">A [*certificate context*](../secgloss/c-gly.md) is a structure of type [**CERT\_CONTEXT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) that has, among other members, a pointer to the encoded [*certificate BLOB*](../secgloss/c-gly.md) and a pointer to a [**CERT\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) structure.</span></span> <span data-ttu-id="bbbee-120">La struttura delle **\_ informazioni** del certificato contiene i dati del certificato più significativi.</span><span class="sxs-lookup"><span data-stu-id="bbbee-120">The **CERT\_INFO** structure contains the most significant certificate data.</span></span> <span data-ttu-id="bbbee-121">Per ulteriori informazioni sulle strutture di [*contesto di certificato*](../secgloss/c-gly.md), elenco di [*revoche di certificati*](../secgloss/c-gly.md) (CRL) e [*elenco certificati attendibili*](../secgloss/c-gly.md) (CTL), vedere [codifica e decodifica di un contesto del certificato](encoding-and-decoding-a-certificate-context.md).</span><span class="sxs-lookup"><span data-stu-id="bbbee-121">For more information about [*certificate*](../secgloss/c-gly.md), [*certificate revocation list*](../secgloss/c-gly.md) (CRL), and [*certificate trust list*](../secgloss/c-gly.md) (CTL) context structures, see [Encoding and Decoding a Certificate Context](encoding-and-decoding-a-certificate-context.md).</span></span>
> 
> <span data-ttu-id="bbbee-122">Ogni contesto del certificato contiene anche un [*conteggio dei riferimenti*](../secgloss/r-gly.md) che indica il numero di copie dell'indirizzo del contesto che sono state assegnate.</span><span class="sxs-lookup"><span data-stu-id="bbbee-122">Each certificate context also contains a [*reference count*](../secgloss/r-gly.md) indicating the number of copies of the context's address that have been assigned.</span></span> <span data-ttu-id="bbbee-123">Ogni volta che un contesto del certificato viene duplicato in qualsiasi modo, il conteggio dei riferimenti viene incrementato di uno.</span><span class="sxs-lookup"><span data-stu-id="bbbee-123">Each time a certificate context is duplicated in any way, its reference count is incremented by one.</span></span> <span data-ttu-id="bbbee-124">Ogni volta che viene liberato un puntatore a un contesto di certificato, il conteggio dei riferimenti nel contesto del certificato viene decrementato di uno.</span><span class="sxs-lookup"><span data-stu-id="bbbee-124">Each time a pointer to a certificate context is freed, the reference count in the certificate context is decremented by one.</span></span> <span data-ttu-id="bbbee-125">Quando il conteggio dei riferimenti in un contesto di certificato raggiunge lo zero, la memoria che contiene il contesto viene deallocata.</span><span class="sxs-lookup"><span data-stu-id="bbbee-125">When the reference count on a certificate context reaches zero, the memory holding the context is de-allocated.</span></span> <span data-ttu-id="bbbee-126">La memoria allocata per un contesto di certificato viene anche deallocata quando tale contesto si trova in un archivio e l'archivio viene chiuso utilizzando il \_ flag di chiusura dell' \_ Archivio CERT \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="bbbee-126">Memory allocated for a certificate context is also de-allocated when that context is in a store and the store is closed using CERT\_CLOSE\_STORE\_FORCE\_FLAG.</span></span> <span data-ttu-id="bbbee-127">Se la memoria per un contesto è deallocata e i puntatori a tale contesto sono ancora in uso, tali puntatori non saranno più validi.</span><span class="sxs-lookup"><span data-stu-id="bbbee-127">If the memory for a context is de-allocated and pointers to that context are still in use, those pointers are no longer valid.</span></span>

 

<span data-ttu-id="bbbee-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) aumenta il [*conteggio dei riferimenti*](../secgloss/r-gly.md) nell'archivio.</span><span class="sxs-lookup"><span data-stu-id="bbbee-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) increases the [*reference count*](../secgloss/r-gly.md) on the store.</span></span>

<span data-ttu-id="bbbee-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) Salva il contenuto di un archivio in un file su disco o in una posizione di memoria e</span><span class="sxs-lookup"><span data-stu-id="bbbee-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) saves the contents of a store to a disk file or a memory location, and</span></span>

<span data-ttu-id="bbbee-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) gestisce un archivio mentre è aperto.</span><span class="sxs-lookup"><span data-stu-id="bbbee-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) manages a store while it is open.</span></span> <span data-ttu-id="bbbee-131">Un'applicazione con un archivio aperto può ricevere una notifica quando lo stato permanente di tale archivio è stato modificato da un altro processo.</span><span class="sxs-lookup"><span data-stu-id="bbbee-131">An application with an open store can be notified when the persisted state of that store has changed by some other process.</span></span> <span data-ttu-id="bbbee-132">Questo problema può verificarsi se i nuovi certificati sono stati copiati nell'archivio del computer locale da un computer di controllo del dominio.</span><span class="sxs-lookup"><span data-stu-id="bbbee-132">This could happen if new certificates were copied to the local computer store from a domain control computer.</span></span>

<span data-ttu-id="bbbee-133">Quando vengono individuate le modifiche, l'archivio memorizzato nella cache può sincronizzare nuovamente l'archivio memorizzato nella cache in modo che corrisponda allo stato permanente dell'archivio.</span><span class="sxs-lookup"><span data-stu-id="bbbee-133">When changes are discovered, the cached store can re-synchronize its cached store to match the persisted state of the store.</span></span> <span data-ttu-id="bbbee-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) supporta anche un processo che copia le modifiche dell'archivio memorizzato nella cache in un archivio permanente quando queste modifiche nell'archivio memorizzato nella cache non vengono salvate automaticamente.</span><span class="sxs-lookup"><span data-stu-id="bbbee-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) also supports a process that copies cached store changes to permanent storage when these changes in the cached store are not automatically saved.</span></span>

<span data-ttu-id="bbbee-135">I contesti di certificato di tipo archivio certificati possono avere proprietà estese.</span><span class="sxs-lookup"><span data-stu-id="bbbee-135">Certificate store-like certificate contexts can have extended properties.</span></span> <span data-ttu-id="bbbee-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) aggiunge le proprietà estese a un archivio certificati.</span><span class="sxs-lookup"><span data-stu-id="bbbee-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) adds extended properties to a certificate store.</span></span> <span data-ttu-id="bbbee-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) recupera tutte le proprietà impostate in un archivio certificati.</span><span class="sxs-lookup"><span data-stu-id="bbbee-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) retrieves any properties set on a certificate store.</span></span> <span data-ttu-id="bbbee-138">Attualmente, l'unica proprietà dell'archivio certificati predefinita è il nome localizzato di un archivio.</span><span class="sxs-lookup"><span data-stu-id="bbbee-138">Currently, the only predefined certificate store property is a store's localized name.</span></span>

 

 
