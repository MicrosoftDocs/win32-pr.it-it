---
description: Mostra come è possibile usare le funzioni di backup di Servizi certificati per ripristinare e recuperare un database di Servizi certificati e i file associati.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Ripristino di Servizi certificati da backup
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "106317699"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="161d4-103">Ripristino di Servizi certificati da backup</span><span class="sxs-lookup"><span data-stu-id="161d4-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="161d4-104">Nello scenario seguente viene illustrato il modo in cui è possibile utilizzare le funzioni di backup di Servizi certificati per ripristinare e recuperare un database di Servizi certificati e i file associati.</span><span class="sxs-lookup"><span data-stu-id="161d4-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="161d4-105">Il processo di ripristino prevede la scrittura dei file contenuti in un set di backup su disco.</span><span class="sxs-lookup"><span data-stu-id="161d4-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="161d4-106">È possibile ripristinare più set di backup (un backup completo più zero o più backup incrementali), ma tutti i ripristini devono essere completati prima di iniziare il processo di ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="161d4-107">Il processo di ripristino prevede la riproduzione dei file di log da parte di Servizi certificati per garantire la coerenza del database e del file di registro, garantendo così l'integrità del database</span><span class="sxs-lookup"><span data-stu-id="161d4-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="161d4-108">In questo scenario vengono illustrate le chiamate di funzione per ripristinare i set di backup e informare i servizi certificati dei parametri di ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="161d4-109">Prima di implementare questo scenario, deve esistere un backup completo esistente del database di Servizi certificati.</span><span class="sxs-lookup"><span data-stu-id="161d4-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="161d4-110">Caricare la libreria Certadm.dll in memoria (chiamando [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="161d4-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="161d4-111">Recuperare l'indirizzo di ognuna delle funzioni necessarie in Certadm.dll (tramite [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="161d4-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="161d4-112">Usare questi indirizzi quando si chiamano le funzioni nei passaggi rimanenti.</span><span class="sxs-lookup"><span data-stu-id="161d4-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="161d4-113">Chiamare [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) per determinare se Servizi certificati è online.</span><span class="sxs-lookup"><span data-stu-id="161d4-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="161d4-114">Se Servizi certificati è in esecuzione, arrestarlo prima di procedere.</span><span class="sxs-lookup"><span data-stu-id="161d4-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="161d4-115">Per il corretto funzionamento delle operazioni di ripristino, i servizi certificati non devono essere online.</span><span class="sxs-lookup"><span data-stu-id="161d4-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="161d4-116">Chiamare [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) per avviare una sessione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="161d4-117">L'handle del contesto di backup di Servizi certificati risultante verrà utilizzato da diverse altre funzioni.</span><span class="sxs-lookup"><span data-stu-id="161d4-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="161d4-118">Determinare il percorso per il percorso del database.</span><span class="sxs-lookup"><span data-stu-id="161d4-118">Determine the path for the database location.</span></span> <span data-ttu-id="161d4-119">Durante uno scenario di backup, questo valore sarebbe stato disponibile da una chiamata a [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); Questo valore deve essere stato archiviato come parte del backup.</span><span class="sxs-lookup"><span data-stu-id="161d4-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="161d4-120">Creare una mappa di ripristino che specifichi il nome del database ripristinato.</span><span class="sxs-lookup"><span data-stu-id="161d4-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="161d4-121">Una struttura della mappa di ripristino del database di Servizi certificati (CSEDB \_ RSTMAPW) viene utilizzata per specificare una mappa di ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="161d4-122">Impostare il \_ membro **pwszDatabaseName** di RSTMAPW di CSEDB e il \_ membro **RSTMAPW** di CSEDB pwszNewDatabaseName sul percorso del database determinato nel passaggio 5.</span><span class="sxs-lookup"><span data-stu-id="161d4-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="161d4-123">Facoltativamente, se il database ripristinato ha un nome diverso da quello del database di backup, impostare il \_ membro **pwszNewDatabaseName** di RSTMAPW CSEDB sul nuovo nome del database.</span><span class="sxs-lookup"><span data-stu-id="161d4-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="161d4-124">Se si desidera assicurarsi che le modifiche apportate al database dopo l'esecuzione del backup non vengano riapplicate dopo il completamento del ripristino del database (come parte del ripristino del database eseguito durante il successivo avvio dei servizi certificati), eliminare i file dal database attivo e dalle directory di log del server di destinazione.</span><span class="sxs-lookup"><span data-stu-id="161d4-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="161d4-125">Copiare i file contenuti nel backup completo nel database attivo e nelle directory di log del server di destinazione.</span><span class="sxs-lookup"><span data-stu-id="161d4-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="161d4-126">Chiamare [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) per registrare un'operazione di ripristino per il backup completo.</span><span class="sxs-lookup"><span data-stu-id="161d4-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="161d4-127">**CertSrvRestoreRegister** usa la mappa di ripristino specificata nel passaggio 6.</span><span class="sxs-lookup"><span data-stu-id="161d4-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="161d4-128">**CertSrvRestoreRegister** specifica anche il percorso del database di backup e dei log.</span><span class="sxs-lookup"><span data-stu-id="161d4-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="161d4-129">La chiamata di **CertSrvRestoreRegister** forza i servizi certificati a tentare un'operazione di ripristino al successivo avvio.</span><span class="sxs-lookup"><span data-stu-id="161d4-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="161d4-130">Impedisce inoltre ai Servizi certificati di elaborare le richieste di certificato fino al completamento del ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="161d4-131">Chiamare [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), completando così l'attività di registrazione iniziata nel passaggio 8.</span><span class="sxs-lookup"><span data-stu-id="161d4-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="161d4-132">Si noti che la registrazione di un'operazione di ripristino è un'istruzione per i servizi certificati da seguire all'avvio; il ripristino effettivo verrà eseguito solo dopo l'avvio di Servizi certificati.</span><span class="sxs-lookup"><span data-stu-id="161d4-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="161d4-133">Per eseguire il ripristino di ogni backup incrementale, copiare i file contenuti nel backup incrementale nella directory di log Active del server di destinazione, quindi chiamare [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), seguito da una chiamata a [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span><span class="sxs-lookup"><span data-stu-id="161d4-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="161d4-134">La registrazione dei backup incrementali per il ripristino può essere eseguita in qualsiasi ordine, ma solo il set di file per un backup incrementale deve essere copiato nel server prima di ogni chiamata a **CertSrvRestoreRegister**.</span><span class="sxs-lookup"><span data-stu-id="161d4-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="161d4-135">Copiare i file dinamici di Servizi certificati nel server di destinazione.</span><span class="sxs-lookup"><span data-stu-id="161d4-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="161d4-136">I file dinamici sono stati identificati durante il backup quando è stato chiamato [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) .</span><span class="sxs-lookup"><span data-stu-id="161d4-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="161d4-137">Potrebbe essere necessario arrestare il servizio di pubblicazione World Wide Web per consentire la sovrascrittura dei file dinamici.</span><span class="sxs-lookup"><span data-stu-id="161d4-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="161d4-138">Chiamare [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) per terminare la sessione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="161d4-139">Avviare l'applicazione Servizi certificati manualmente (o attendere il riavvio successivo per avviarla automaticamente).</span><span class="sxs-lookup"><span data-stu-id="161d4-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="161d4-140">All'avvio di Servizi certificati, verrà determinato se un'operazione di ripristino è stata registrata. Se un'operazione di ripristino è stata registrata, i servizi certificati inizieranno il ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="161d4-141">Servizi certificati non elaborerà alcuna richiesta di certificato fino al completamento dell'operazione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="161d4-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="161d4-142">Una volta completato il ripristino, è importante eseguire un nuovo backup completo del database di Servizi certificati.</span><span class="sxs-lookup"><span data-stu-id="161d4-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="161d4-143">Questa operazione è necessaria per troncare i file di log ripristinati e per stabilire un set di backup di base per i ripristini futuri.</span><span class="sxs-lookup"><span data-stu-id="161d4-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="161d4-144">I backup eseguiti dopo un'operazione di ripristino non possono essere combinati con i backup (completi o incrementali) eseguiti prima del ripristino. ovvero, dopo il ripristino di un database di Servizi certificati e l'avanzamento a uno stato successivo, non è possibile utilizzare i backup di pre-ripristino per ripristinare lo stato successivo del database.</span><span class="sxs-lookup"><span data-stu-id="161d4-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
