---
description: Descrive la procedura per la codifica di un messaggio firmato.
ms.assetid: 40d1c417-6d88-4421-920f-8b40d88d28ce
title: Codifica dei dati firmati
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: be4a542fe0890a6ee9d51ebc1a5ee6b98bab4242
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "104232937"
---
# <a name="encoding-signed-data"></a><span data-ttu-id="cde4e-103">Codifica dei dati firmati</span><span class="sxs-lookup"><span data-stu-id="cde4e-103">Encoding Signed Data</span></span>

<span data-ttu-id="cde4e-104">[*I dati firmati*](../secgloss/s-gly.md) sono costituiti da contenuto di qualsiasi tipo e [*hash*](../secgloss/h-gly.md) di messaggi crittografati del contenuto per zero o più firmatari.</span><span class="sxs-lookup"><span data-stu-id="cde4e-104">[*Signed data*](../secgloss/s-gly.md) consists of content of any type and encrypted message [*hashes*](../secgloss/h-gly.md) of the content by zero or more signers.</span></span> <span data-ttu-id="cde4e-105">L'hash risultante può confermare che il messaggio originale non è stato modificato dopo la firma e che le persone o entità specifiche hanno firmato i dati.</span><span class="sxs-lookup"><span data-stu-id="cde4e-105">The resulting hash can confirm that the original message has not been modified since signing and that particular persons or entities signed the data.</span></span>

<span data-ttu-id="cde4e-106">Nella figura seguente viene illustrata la procedura per la codifica di un messaggio firmato.</span><span class="sxs-lookup"><span data-stu-id="cde4e-106">The following illustration depicts the procedure for encoding a signed message.</span></span> <span data-ttu-id="cde4e-107">L'elenco seguente illustra i passaggi.</span><span class="sxs-lookup"><span data-stu-id="cde4e-107">The list following the illustration describes the steps.</span></span>

<span data-ttu-id="cde4e-108">Un messaggio può avere più firmatari, algoritmi di hashing e certificati.</span><span class="sxs-lookup"><span data-stu-id="cde4e-108">A message may have multiple signers, hashing algorithms, and certificates.</span></span> <span data-ttu-id="cde4e-109">Mentre nell'illustrazione vengono mostrati solo i certificati, i [*CRL*](../secgloss/c-gly.md)e [*scopi consentiti*](../secgloss/c-gly.md) possono utilizzare lo stesso processo.</span><span class="sxs-lookup"><span data-stu-id="cde4e-109">While the illustration shows only certificates, [*CRLs*](../secgloss/c-gly.md), and [*CTLs*](../secgloss/c-gly.md) can use the same process.</span></span> <span data-ttu-id="cde4e-110">Si adattano all'illustrazione quando vengono visualizzati i certificati.</span><span class="sxs-lookup"><span data-stu-id="cde4e-110">They would fit into the illustration wherever certificates are shown.</span></span>

![codifica di un messaggio firmato](images/signmsg2.png)

<span data-ttu-id="cde4e-112">Il processo generale per la codifica [*dei dati firmati*](../secgloss/s-gly.md) è il seguente.</span><span class="sxs-lookup"><span data-stu-id="cde4e-112">The general process for encoding [*Signed data*](../secgloss/s-gly.md) is as follows.</span></span>

<span data-ttu-id="cde4e-113">**Per codificare i dati firmati**</span><span class="sxs-lookup"><span data-stu-id="cde4e-113">**To encode signed data**</span></span>

1.  <span data-ttu-id="cde4e-114">I dati vengono creati (se necessario) e viene recuperato un puntatore a tale oggetto.</span><span class="sxs-lookup"><span data-stu-id="cde4e-114">The data is created (if necessary), and a pointer to it is retrieved.</span></span>
2.  <span data-ttu-id="cde4e-115">Viene aperto un [*archivio certificati*](../secgloss/c-gly.md) che contiene il certificato del firmatario.</span><span class="sxs-lookup"><span data-stu-id="cde4e-115">A [*certificate store*](../secgloss/c-gly.md) is opened that contains the signer's certificate.</span></span>
3.  <span data-ttu-id="cde4e-116">Viene recuperata la chiave privata per il certificato.</span><span class="sxs-lookup"><span data-stu-id="cde4e-116">The private key for the certificate is retrieved.</span></span> <span data-ttu-id="cde4e-117">È necessario impostare due proprietà sul certificato prima di utilizzarlo.</span><span class="sxs-lookup"><span data-stu-id="cde4e-117">There are two properties that must be set on the certificate before using it.</span></span> <span data-ttu-id="cde4e-118">Una viene utilizzata per associare un certificato a un particolare CSP e, all'interno di tale CSP, a un [*contenitore di chiavi*](../secgloss/k-gly.md)private specifico.</span><span class="sxs-lookup"><span data-stu-id="cde4e-118">One is used to tie a certificate to a particular CSP and, within that CSP, to a particular private [*key container*](../secgloss/k-gly.md).</span></span> <span data-ttu-id="cde4e-119">L'altro viene usato per indicare quale algoritmo di hash deve essere usato quando viene chiamata un'operazione [*hash*](../secgloss/h-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="cde4e-119">The other is used to indicate which hashing algorithm is to be used when a [*hash*](../secgloss/h-gly.md) operation is called.</span></span> <span data-ttu-id="cde4e-120">Questi devono essere impostati solo una volta.</span><span class="sxs-lookup"><span data-stu-id="cde4e-120">These need only be set once.</span></span>
4.  <span data-ttu-id="cde4e-121">La proprietà di un certificato determina l'algoritmo hash.</span><span class="sxs-lookup"><span data-stu-id="cde4e-121">A certificate's property determines the hash algorithm.</span></span>
5.  <span data-ttu-id="cde4e-122">Un hash dei dati viene creato inviando i dati tramite la funzione hash.</span><span class="sxs-lookup"><span data-stu-id="cde4e-122">A hash of the data is created by sending the data through the hashing function.</span></span>
6.  <span data-ttu-id="cde4e-123">La firma viene creata crittografando l'hash usando la chiave privata, ottenuta tramite una proprietà nel certificato.</span><span class="sxs-lookup"><span data-stu-id="cde4e-123">The signature is created by encrypting the hash using the private key, obtained through a property on the certificate.</span></span>
7.  <span data-ttu-id="cde4e-124">I dati seguenti sono inclusi nel messaggio firmato completato:</span><span class="sxs-lookup"><span data-stu-id="cde4e-124">The following data is included in the finished, signed message:</span></span>
    -   <span data-ttu-id="cde4e-125">Dati originali da firmare</span><span class="sxs-lookup"><span data-stu-id="cde4e-125">The original data to be signed</span></span>
    -   <span data-ttu-id="cde4e-126">Algoritmi hash</span><span class="sxs-lookup"><span data-stu-id="cde4e-126">The hash algorithms</span></span>
    -   <span data-ttu-id="cde4e-127">Firme</span><span class="sxs-lookup"><span data-stu-id="cde4e-127">The signatures</span></span>
    -   <span data-ttu-id="cde4e-128">Strutture di informazioni sul firmatario, che include l'identificatore del firmatario (autorità emittente del certificato e numero di serie)</span><span class="sxs-lookup"><span data-stu-id="cde4e-128">The signer info structures, which includes the signer identifier (certificate issuer and serial number)</span></span>
    -   <span data-ttu-id="cde4e-129">Certificati del firmatario (facoltativo)</span><span class="sxs-lookup"><span data-stu-id="cde4e-129">The signer's certificates (optional)</span></span>

<span data-ttu-id="cde4e-130">In questa procedura viene illustrato un caso semplice.</span><span class="sxs-lookup"><span data-stu-id="cde4e-130">This procedure illustrates a simple case.</span></span> <span data-ttu-id="cde4e-131">Casi più complessi coinvolgono gli attributi autenticati inclusi nel messaggio.</span><span class="sxs-lookup"><span data-stu-id="cde4e-131">More complex cases involve authenticated attributes included in the message.</span></span> <span data-ttu-id="cde4e-132">Quando il tipo di contenuto è qualsiasi ma una stringa di **byte** oppure esiste almeno un attributo autenticato insieme a qualsiasi tipo di dati, sono necessari due attributi autenticati standard: il tipo di contenuto (dati) e l'hash del contenuto.</span><span class="sxs-lookup"><span data-stu-id="cde4e-132">When the content type is anything but a **BYTE** string, or there is at least one authenticated attribute along with any data type, there are two standard authenticated attributes required: the content (data) type, and the hash of the content.</span></span> <span data-ttu-id="cde4e-133">In queste circostanze, [*CryptoAPI*](../secgloss/c-gly.md) fornisce automaticamente questi due attributi obbligatori.</span><span class="sxs-lookup"><span data-stu-id="cde4e-133">Under these circumstances, the [*CryptoAPI*](../secgloss/c-gly.md) automatically provides these two required attributes.</span></span> <span data-ttu-id="cde4e-134">Le funzioni di messaggio di basso livello eseguono l'hashing degli attributi autenticati, crittografano l'hash con la chiave privata e lo forniscono come firma.</span><span class="sxs-lookup"><span data-stu-id="cde4e-134">The low-level message functions hash the authenticated attributes, encrypt the hash with the private key, and provide this as the signature.</span></span>

<span data-ttu-id="cde4e-135">Usare le funzioni di messaggio di basso livello per eseguire le attività elencate, usando la procedura seguente.</span><span class="sxs-lookup"><span data-stu-id="cde4e-135">Use the low-level message functions to accomplish the tasks just listed, by using the following procedure.</span></span>

<span data-ttu-id="cde4e-136">**Per codificare un messaggio firmato**</span><span class="sxs-lookup"><span data-stu-id="cde4e-136">**To encode a signed message**</span></span>

1.  <span data-ttu-id="cde4e-137">Creare o recuperare il contenuto.</span><span class="sxs-lookup"><span data-stu-id="cde4e-137">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="cde4e-138">Ottenere un provider di crittografia.</span><span class="sxs-lookup"><span data-stu-id="cde4e-138">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="cde4e-139">Ottenere i certificati del firmatario.</span><span class="sxs-lookup"><span data-stu-id="cde4e-139">Get the signer certificates.</span></span>
4.  <span data-ttu-id="cde4e-140">Inizializza la struttura delle [**\_ informazioni di \_ codifica \_ del firmatario CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="cde4e-140">Initialize the [**CMSG\_SIGNER\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) structure.</span></span>
5.  <span data-ttu-id="cde4e-141">Inizializza la struttura delle [**\_ informazioni di \_ codifica \_ CMSG firmate**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="cde4e-141">Initialize the [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) structure.</span></span>
6.  <span data-ttu-id="cde4e-142">Chiamare [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) per ottenere la dimensione del BLOB del messaggio codificato.</span><span class="sxs-lookup"><span data-stu-id="cde4e-142">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="cde4e-143">Allocare memoria per l'it.</span><span class="sxs-lookup"><span data-stu-id="cde4e-143">Allocate memory for it.</span></span>
7.  <span data-ttu-id="cde4e-144">Chiamare [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passando CMSG \_ firmato per *dwMsgType* e un puntatore a [**CMSG \_ informazioni di \_ codifica \_ firmate**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) per *pvMsgEncodeInfo* per ottenere un handle per il messaggio aperto.</span><span class="sxs-lookup"><span data-stu-id="cde4e-144">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_SIGNED for *dwMsgType* and a pointer to [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) for *pvMsgEncodeInfo* to get a handle to the opened message.</span></span>
8.  <span data-ttu-id="cde4e-145">Chiamare [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passando l'handle recuperato nel passaggio 7 e un puntatore ai dati che devono essere firmati e codificati.</span><span class="sxs-lookup"><span data-stu-id="cde4e-145">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 7, and a pointer to the data that is to be signed and encoded.</span></span> <span data-ttu-id="cde4e-146">Questa funzione può essere chiamata il numero di volte necessario per completare il processo di codifica.</span><span class="sxs-lookup"><span data-stu-id="cde4e-146">This function can be called as many times as necessary to complete the encoding process.</span></span>
9.  <span data-ttu-id="cde4e-147">Chiamare [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passando l'handle recuperato nel passaggio 7 e i tipi di parametro appropriati per accedere ai dati codificati desiderati.</span><span class="sxs-lookup"><span data-stu-id="cde4e-147">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 7 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="cde4e-148">Ad esempio, passare CMSG \_ Content \_ param per ottenere un puntatore all'intero messaggio [*PKCS \# 7*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="cde4e-148">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire [*PKCS \#7*](../secgloss/p-gly.md) message.</span></span>

    <span data-ttu-id="cde4e-149">Se il risultato di questa codifica deve essere usato come [*dati interni*](../secgloss/i-gly.md) per un altro messaggio codificato, ad esempio un messaggio in busta, è \_ \_ necessario passare il parametro CMSG bare Content \_ param.</span><span class="sxs-lookup"><span data-stu-id="cde4e-149">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="cde4e-150">Per un esempio che illustra questo problema, vedere [codice alternativo per la codifica di un messaggio in busta](alternate-code-for-encoding-an-enveloped-message.md)digitale.</span><span class="sxs-lookup"><span data-stu-id="cde4e-150">For an example showing this, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

10. <span data-ttu-id="cde4e-151">Chiudere il messaggio chiamando [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="cde4e-151">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="cde4e-152">Il risultato di questa procedura è un messaggio codificato che contiene i dati originali, l'hash crittografato dei dati (firma) e le informazioni sul firmatario.</span><span class="sxs-lookup"><span data-stu-id="cde4e-152">The result of this procedure is an encoded message that contains the original data, the encrypted hash of that data (signature), and the signer information.</span></span> <span data-ttu-id="cde4e-153">È anche presente un puntatore al BLOB codificato desiderato.</span><span class="sxs-lookup"><span data-stu-id="cde4e-153">There is also a pointer to the desired, encoded BLOB.</span></span>

<span data-ttu-id="cde4e-154">Per informazioni sul codice C, vedere [esempio di programma c: firma, codifica, decodifica e verifica di un messaggio](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span><span class="sxs-lookup"><span data-stu-id="cde4e-154">For C coding details, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
