---
description: Dopo qualsiasi tipo di errore che interrompe la normale elaborazione delle transazioni, KTM e ogni Resource Manager devono eseguire operazioni di ripristino. Il ripristino è il processo mediante il quale i partecipanti alle transazioni arrivano a una visualizzazione coerente di ogni stato delle transazioni.
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: Elaborazione del ripristino
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a8e74d4f8bff3e56af03b017522212e7a02e232
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "106311134"
---
# <a name="recovery-processing"></a><span data-ttu-id="711f8-104">Elaborazione del ripristino</span><span class="sxs-lookup"><span data-stu-id="711f8-104">Recovery Processing</span></span>

<span data-ttu-id="711f8-105">Dopo qualsiasi tipo di errore che interrompe la normale elaborazione delle transazioni, KTM e ogni Resource Manager devono eseguire operazioni di *ripristino* .</span><span class="sxs-lookup"><span data-stu-id="711f8-105">After any type of failure that disrupts normal transaction processing, KTM and each resource manager must perform *recovery* operations.</span></span> <span data-ttu-id="711f8-106">Il ripristino è il processo mediante il quale i partecipanti alle transazioni arrivano a una visualizzazione coerente dello stato di ogni transazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-106">Recovery is the process by which transaction participants arrive at a consistent view of each transaction's state.</span></span>

<span data-ttu-id="711f8-107">I gestori di risorse potrebbero non essere *in dubbio* sul risultato di una transazione, vale a dire che, al momento dell'errore, hanno ricevuto una \_ \_ notifica di preparazione alla transazione per la notifica, si è preparata per l'archiviazione durevole, ma non ha ricevuto (o ricevuto ma non registrato) un risultato finale per la transazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-107">Resource managers may be *in-doubt* about a transaction's outcome, meaning that at the time of failure, they had received a TRANSACTION\_NOTIFY\_PREPARE notification, had prepared to durable storage, but had not received (or received but not logged) a final outcome for the transaction.</span></span> <span data-ttu-id="711f8-108">Analogamente, è possibile che KTM sia in dubbio su una transazione se è stata preparata, ma non ha ricevuto (o ricevuto ma non registrato) un risultato.</span><span class="sxs-lookup"><span data-stu-id="711f8-108">Similarly, KTM can be in-doubt about a transaction if it had been prepared but had not received (or received but not logged) an outcome.</span></span> <span data-ttu-id="711f8-109">Al momento del ripristino, è necessario inviare nuovamente tutti i risultati inviati ma non riconosciuti.</span><span class="sxs-lookup"><span data-stu-id="711f8-109">At recovery time, all outcomes that have been sent but not acknowledged must be re-sent.</span></span> <span data-ttu-id="711f8-110">Se, ad esempio, un gestore di risorse ha ricevuto una \_ notifica di commit Transaction Notify \_ e ha chiamato la funzione [**COMMITCOMPLETE**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) , il RM potrebbe ancora ricevere una notifica di commit delle transazioni duplicata \_ \_ al momento del ripristino.</span><span class="sxs-lookup"><span data-stu-id="711f8-110">For example, if a resource manager received a TRANSACTION\_NOTIFY\_COMMIT notification and called the [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) function, the RM may still receive a duplicate TRANSACTION\_NOTIFY\_COMMIT notification at recovery time.</span></span>

<span data-ttu-id="711f8-111">Per eseguire correttamente il ripristino di una transazione dopo un errore di sistema o di Resource Manager, ogni gestore di risorse deve eseguire le operazioni seguenti ogni volta che viene avviato:</span><span class="sxs-lookup"><span data-stu-id="711f8-111">For a transaction to properly recover after a resource manager or system failure, each resource manager must do the following each time it is started:</span></span>

1.  <span data-ttu-id="711f8-112">Chiamare la funzione [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) per riaprire l'handle di Resource Manager usando il nome univoco e permanente.</span><span class="sxs-lookup"><span data-stu-id="711f8-112">Call the [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) function to re-open its resource manager handle using its unique, persistent name.</span></span> <span data-ttu-id="711f8-113">In questo modo, si informa che Gestione risorse è in esecuzione nuovamente ed è disponibile per eseguire il ripristino.</span><span class="sxs-lookup"><span data-stu-id="711f8-113">This informs KTM that the resource manager is running again and is available to perform recovery.</span></span> <span data-ttu-id="711f8-114">Se non è presente alcun elenco per il ripristino, la chiamata a **OpenResourceManager** può avere esito negativo.</span><span class="sxs-lookup"><span data-stu-id="711f8-114">If no enlistments exist to be recovered, the call to **OpenResourceManager** can fail.</span></span> <span data-ttu-id="711f8-115">Chiamare [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) per ricreare l'oggetto RM.</span><span class="sxs-lookup"><span data-stu-id="711f8-115">Call [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) to re-create the RM object.</span></span>
2.  <span data-ttu-id="711f8-116">Chiamare [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span><span class="sxs-lookup"><span data-stu-id="711f8-116">Call [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span></span> <span data-ttu-id="711f8-117">Resource Manager riceverà un evento di notifica della notifica di transazione per ogni integrazione per cui è necessario eseguire operazioni di ripristino, seguito da un ultimo ripristino della notifica della transazione [**\_ \_**](notification-mask.md) \_ \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="711f8-117">The resource manager will receive a [**TRANSACTION\_NOTIFY\_RECOVER**](notification-mask.md) notification event for each enlistment for which it needs to perform recovery operations, followed by a TRANSACTION\_NOTIFY\_LAST\_RECOVER.</span></span> <span data-ttu-id="711f8-118">L'evento di notifica include un identificatore univoco globale sia per la transazione che per l'integrazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-118">The notification event includes a globally unique identifier for both the transaction and the enlistment.</span></span>
3.  <span data-ttu-id="711f8-119">Chiamare la funzione [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) per riaprire ogni handle di integrazione per il quale il gestore di risorse ha ricevuto una notifica di recupero della notifica di transazione \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="711f8-119">Call the [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) function to re-open each enlistment handle for which the resource manager received a TRANSACTION\_NOTIFY\_RECOVER notification.</span></span>
4.  <span data-ttu-id="711f8-120">Per ogni integrazione aperta da [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), chiamare [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span><span class="sxs-lookup"><span data-stu-id="711f8-120">For each enlistment opened by [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), call [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span></span> <span data-ttu-id="711f8-121">\_ \_ \_ In questo \_ modo verrà recapitata la notifica del commit della notifica della transazione o della notifica della transazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-121">This causes the TRANSACTION\_NOTIFY\_COMMIT or TRANSACTION\_NOTIFY\_INDOUBT notification to be redelivered.</span></span>
5.  <span data-ttu-id="711f8-122">Se il RM ha ricevuto una \_ notifica \_ di transazione, il RM può completare la transazione chiamando [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span><span class="sxs-lookup"><span data-stu-id="711f8-122">If the RM received TRANSACTION\_NOTIFY\_COMMIT, the RM can complete the transaction by calling [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span></span>

    <span data-ttu-id="711f8-123">Se il RM ha ricevuto una \_ notifica \_ di transazione indubbia, il RM deve attendere l'arrivo della notifica di risultato.</span><span class="sxs-lookup"><span data-stu-id="711f8-123">If the RM received TRANSACTION\_NOTIFY\_INDOUBT, the RM should wait for the outcome notification to arrive.</span></span>

6.  <span data-ttu-id="711f8-124">Per tutte le transazioni che RM non riceve una notifica di \_ ripristino della transazione \_ , ma che in precedenza ha ricevuto una \_ \_ notifica di preparazione della transazione per, il RM deve elaborare la transazione come se fosse stato eseguito il rollback.</span><span class="sxs-lookup"><span data-stu-id="711f8-124">For any transactions that the RM does not receive a TRANSACTION\_NOTIFY\_RECOVER notification, but previously received a TRANSACTION\_NOTIFY\_PREPARE notification for, the RM should process the transaction as if it were rolled back.</span></span>

> [!Note]
>
> <span data-ttu-id="711f8-125">I gestori di risorse possono eseguire l'integrazione o creare nuove transazioni durante il processo di recupero.</span><span class="sxs-lookup"><span data-stu-id="711f8-125">Resource managers are allowed to enlist in or create new transactions while in the process of performing recovery.</span></span>

 

<span data-ttu-id="711f8-126">KTM utilizza un modello *presunto* di transazione di interruzione.</span><span class="sxs-lookup"><span data-stu-id="711f8-126">KTM uses a *presumed abort* transaction model.</span></span> <span data-ttu-id="711f8-127">Questo comportamento viene illustrato nello scenario seguente.</span><span class="sxs-lookup"><span data-stu-id="711f8-127">The following scenario illustrates this behavior.</span></span> <span data-ttu-id="711f8-128">Si supponga che KTM e uno strumento di gestione delle risorse esistano nello stesso computer.</span><span class="sxs-lookup"><span data-stu-id="711f8-128">Assume that KTM and an resource manager exist on the same computer.</span></span> <span data-ttu-id="711f8-129">Si supponga che KTM verifichi una notifica di preparazione per una transazione, ma il sistema si arresta in modo anomalo prima che KTM registri la notifica di preparazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-129">Suppose KTM issues a prepare notification for a transaction, but the system crashes before KTM logs the prepare notification.</span></span> <span data-ttu-id="711f8-130">Si supponga inoltre che Resource Manager riceva e registri la notifica di preparazione immediatamente prima che il sistema si arresti in modo anomalo.</span><span class="sxs-lookup"><span data-stu-id="711f8-130">Further suppose that the resource manager receives and logs the prepare notification just before the system crashes.</span></span> <span data-ttu-id="711f8-131">Una volta ripristinato il sistema, KTM non conosce la transazione, perché non ha mai registrato la fase di preparazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-131">After the system is restored, KTM has no knowledge of the transaction, because it never logged the prepare phase.</span></span> <span data-ttu-id="711f8-132">Resource Manager conosce la transazione, perché ha ricevuto, elaborato e registrato la notifica di preparazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-132">The resource manager has knowledge of the transaction, because it received, processed, and logged the prepare notification.</span></span> <span data-ttu-id="711f8-133">Quando KTM rilascia le notifiche di ripristino, Resource Manager non include una notifica di ripristino per la transazione in questione.</span><span class="sxs-lookup"><span data-stu-id="711f8-133">When KTM issues its recovery notifications, the resource manager does not include a recovery notification for the transaction in question.</span></span> <span data-ttu-id="711f8-134">Con il modello di interruzione presunto, gestione risorse in questo caso considererà la transazione preparata come interrotta quando non riceve le notifiche per eseguire il ripristino su tale transazione.</span><span class="sxs-lookup"><span data-stu-id="711f8-134">With the presumed abort model, the resource manager in this case will treat the prepared transaction as aborted when it does not receive notifications to perform recovery on that transaction.</span></span>

 

 



