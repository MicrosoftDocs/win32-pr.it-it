---
title: Autenticazione reciproca in un servizio Windows Sockets con SCP
description: Negli argomenti di questa sezione sono inclusi esempi di codice in cui viene illustrato come eseguire l'autenticazione reciproca con un servizio che pubblica se stesso utilizzando un punto di connessione del servizio (SCP).
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- Autenticazione reciproca in un servizio Windows Sockets con un annuncio SCP
- Active Directory, utilizzo di, autenticazione reciproca, servizio Windows Sockets con SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 527715c4a35dc15cd67f5820e6fa891b56452399
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/17/2020
ms.locfileid: "103872289"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a><span data-ttu-id="e7341-105">Autenticazione reciproca in un servizio Windows Sockets con SCP</span><span class="sxs-lookup"><span data-stu-id="e7341-105">Mutual Authentication in a Windows Sockets Service with SCP</span></span>

<span data-ttu-id="e7341-106">Negli argomenti di questa sezione sono inclusi esempi di codice in cui viene illustrato come eseguire l'autenticazione reciproca con un servizio che pubblica se stesso utilizzando un punto di connessione del servizio (SCP).</span><span class="sxs-lookup"><span data-stu-id="e7341-106">The topics in this section include code examples that show how to perform mutual authentication with a service that publishes itself using a service connection point (SCP).</span></span> <span data-ttu-id="e7341-107">Gli esempi si basano su un servizio Microsoft Windows Sockets che utilizza un pacchetto SSPI per gestire la negoziazione di autenticazione reciproca tra un client e il servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-107">The examples are based on a Microsoft Windows Sockets service that uses an SSPI package to handle the mutual authentication negotiation between a client and the service.</span></span> <span data-ttu-id="e7341-108">Utilizzare le procedure seguenti per implementare l'autenticazione reciproca all'interno di questo scenario.</span><span class="sxs-lookup"><span data-stu-id="e7341-108">Use the following procedures to implement mutual authentication within this scenario.</span></span>

<span data-ttu-id="e7341-109">**Per registrare i nomi SPN in una directory durante l'installazione di un servizio**</span><span class="sxs-lookup"><span data-stu-id="e7341-109">**To register SPNs in a directory when a service is installed**</span></span>

1.  <span data-ttu-id="e7341-110">Chiamare la funzione [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) per comporre i nomi dell'entità servizio (SPN) per il servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-110">Call the [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) function to compose service principal names (SPNs) for the service.</span></span>
2.  <span data-ttu-id="e7341-111">Chiamare la funzione [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) per registrare i nomi SPN nell'account del servizio o nel computer in cui viene eseguito il servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-111">Call the [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) function to register the SPNs on the service account or computer account in whose context the service will run.</span></span> <span data-ttu-id="e7341-112">Questo passaggio deve essere eseguito da un amministratore di dominio. un'eccezione è che un servizio in esecuzione con l'account LocalSystem può registrare il proprio SPN nel formato " <service class> / <host> " nell'account computer dell'host del servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-112">This step must be performed by a domain administrator; an exception is that a service running under the LocalSystem account can register its SPN in the form "<service class>/<host>" on the computer account of the service host.</span></span>

<span data-ttu-id="e7341-113">**Per verificare la configurazione all'avvio del servizio**</span><span class="sxs-lookup"><span data-stu-id="e7341-113">**To verify configuration at service startup**</span></span>

-   <span data-ttu-id="e7341-114">Verificare che i nomi SPN appropriati siano registrati nell'account con cui è in esecuzione il servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-114">Verify that the appropriate SPNs are registered on the account under which the service is running.</span></span> <span data-ttu-id="e7341-115">Per altre informazioni, vedere [attività di manutenzione degli account di accesso](logon-account-maintenance-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="e7341-115">For more information, see [Logon Account Maintenance Tasks](logon-account-maintenance-tasks.md).</span></span>

<span data-ttu-id="e7341-116">**Per autenticare il servizio all'avvio del client**</span><span class="sxs-lookup"><span data-stu-id="e7341-116">**To authenticate the service at client startup**</span></span>

1.  <span data-ttu-id="e7341-117">Recuperare i dati di connessione dal punto di connessione del servizio del servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-117">Retrieve connection data from the service's service connection point.</span></span>
2.  <span data-ttu-id="e7341-118">Stabilire una connessione al servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-118">Establish a connection to the service.</span></span>
3.  <span data-ttu-id="e7341-119">Chiamare la funzione [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) per comporre un nome SPN per il servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-119">Call the [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) function to compose an SPN for the service.</span></span> <span data-ttu-id="e7341-120">Comporre il nome SPN dalla stringa di classe del servizio nota e i dati recuperati dal punto di connessione del servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-120">Compose the SPN from the known service class string, and the data retrieved from the service connection point.</span></span> <span data-ttu-id="e7341-121">Questi dati includono il nome host del server in cui è in esecuzione il servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-121">This data includes the host name of the server on which the service is running.</span></span> <span data-ttu-id="e7341-122">Tenere presente che il nome host deve essere un nome DNS.</span><span class="sxs-lookup"><span data-stu-id="e7341-122">Be aware that the host name must be a DNS name.</span></span>
4.  <span data-ttu-id="e7341-123">Usare un pacchetto di sicurezza SSPI per eseguire l'autenticazione:</span><span class="sxs-lookup"><span data-stu-id="e7341-123">Use an SSPI security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="e7341-124">Chiamare la funzione [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) per acquisire le credenziali del client.</span><span class="sxs-lookup"><span data-stu-id="e7341-124">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the client's credentials.</span></span>
    2.  <span data-ttu-id="e7341-125">Passare le credenziali client e il nome SPN alla funzione [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) per generare un BLOB di sicurezza da inviare al servizio per l'autenticazione.</span><span class="sxs-lookup"><span data-stu-id="e7341-125">Pass the client credentials and the SPN to the [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) function to generate a security blob to send to the service for authentication.</span></span> <span data-ttu-id="e7341-126">Impostare il flag di autenticazione **\_ \_ reciproca \_ di ISC** per richiedere l'autenticazione reciproca.</span><span class="sxs-lookup"><span data-stu-id="e7341-126">Set the **ISC\_REQ\_MUTUAL\_AUTH** flag to request mutual authentication.</span></span>
    3.  <span data-ttu-id="e7341-127">Scambiare i BLOB con il servizio fino al completamento dell'autenticazione.</span><span class="sxs-lookup"><span data-stu-id="e7341-127">Exchange blobs with the service until the authentication is complete.</span></span>
5.  <span data-ttu-id="e7341-128">Verificare la maschera delle funzionalità restituita per il flag di autenticazione **\_ \_ reciproca \_ di ISC req** per verificare che sia stata eseguita l'autenticazione reciproca.</span><span class="sxs-lookup"><span data-stu-id="e7341-128">Verify the returned capabilities mask for the **ISC\_REQ\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
6.  <span data-ttu-id="e7341-129">Se l'autenticazione ha avuto esito positivo, scambiare il traffico con il servizio autenticato.</span><span class="sxs-lookup"><span data-stu-id="e7341-129">If the authentication was successful, exchange traffic with the authenticated service.</span></span> <span data-ttu-id="e7341-130">Usare la firma digitale per assicurarsi che i messaggi tra il client e il servizio non siano stati manomessi.</span><span class="sxs-lookup"><span data-stu-id="e7341-130">Use digital signing to ensure that messages between client and service have not been tampered with.</span></span> <span data-ttu-id="e7341-131">A meno che i requisiti di prestazioni non siano gravi, utilizzare la crittografia.</span><span class="sxs-lookup"><span data-stu-id="e7341-131">Unless performance requirements are severe, use encryption.</span></span> <span data-ttu-id="e7341-132">Per ulteriori informazioni e un esempio di codice in cui viene illustrato come utilizzare le funzioni [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md)e [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) in un pacchetto SSPI, vedere [garantire l'integrità della comunicazione durante lo scambio di messaggi](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span><span class="sxs-lookup"><span data-stu-id="e7341-132">For more information and a code example that shows how to use the [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md), and [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) functions in an SSPI package, see [Ensuring Communication Integrity During Message Exchange](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span></span>

<span data-ttu-id="e7341-133">**Per autenticare il client dal servizio quando si connette un client**</span><span class="sxs-lookup"><span data-stu-id="e7341-133">**To authenticate the client by the service when a client connects**</span></span>

1.  <span data-ttu-id="e7341-134">Caricare un pacchetto di sicurezza SSPI che supporti l'autenticazione reciproca.</span><span class="sxs-lookup"><span data-stu-id="e7341-134">Load an SSPI security package that supports mutual authentication.</span></span>
2.  <span data-ttu-id="e7341-135">Quando un client si connette, usare il pacchetto di sicurezza per eseguire l'autenticazione:</span><span class="sxs-lookup"><span data-stu-id="e7341-135">When a client connects, use the security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="e7341-136">Chiamare la funzione [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) per acquisire le credenziali del servizio.</span><span class="sxs-lookup"><span data-stu-id="e7341-136">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the service credentials.</span></span>
    2.  <span data-ttu-id="e7341-137">Passare le credenziali del servizio e il BLOB di sicurezza ricevuti dal client alla funzione [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) per generare un BLOB di sicurezza da restituire al client.</span><span class="sxs-lookup"><span data-stu-id="e7341-137">Pass the service credentials and the security blob received from the client to the [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) function to generate a security blob to send back to the client.</span></span>
    3.  <span data-ttu-id="e7341-138">Scambiare i BLOB con il client fino al completamento dell'autenticazione.</span><span class="sxs-lookup"><span data-stu-id="e7341-138">Exchange blobs with the client until the authentication is complete.</span></span>
3.  <span data-ttu-id="e7341-139">Per verificare che sia stata eseguita l'autenticazione reciproca, controllare la maschera delle funzionalità restituita per il flag **ASC \_ ret \_ reciproal \_ AUTH** .</span><span class="sxs-lookup"><span data-stu-id="e7341-139">Check the returned capabilities mask for the **ASC\_RET\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
4.  <span data-ttu-id="e7341-140">Se l'autenticazione ha avuto esito positivo, scambiare il traffico con il client autenticato.</span><span class="sxs-lookup"><span data-stu-id="e7341-140">If the authentication was successful, exchange traffic with the authenticated client.</span></span> <span data-ttu-id="e7341-141">Usare la firma digitale e la crittografia, a meno che le prestazioni non siano un problema.</span><span class="sxs-lookup"><span data-stu-id="e7341-141">Use digital signing and encryption unless performance is an issue.</span></span>

<span data-ttu-id="e7341-142">Per ulteriori informazioni e un esempio di codice per questo scenario di autenticazione reciproca, vedere:</span><span class="sxs-lookup"><span data-stu-id="e7341-142">For more information and a code example for this mutual authentication scenario, see:</span></span>

-   [<span data-ttu-id="e7341-143">Come un client autentica un servizio Windows Sockets basato su SCP</span><span class="sxs-lookup"><span data-stu-id="e7341-143">How a Client Authenticates an SCP-based Windows Sockets Service</span></span>](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="e7341-144">Composizione e registrazione di nomi SPN per un servizio Windows Sockets basato su SCP</span><span class="sxs-lookup"><span data-stu-id="e7341-144">Composing and Registering SPNs for an SCP-based Windows Sockets Service</span></span>](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="e7341-145">Modalità di autenticazione di un client in un servizio Windows Sockets</span><span class="sxs-lookup"><span data-stu-id="e7341-145">How a Windows Sockets Service Authenticates a Client</span></span>](how-a-windows-sockets-service-authenticates-a-client.md)

<span data-ttu-id="e7341-146">Per altre informazioni, vedere:</span><span class="sxs-lookup"><span data-stu-id="e7341-146">For more information, see:</span></span>

-   [<span data-ttu-id="e7341-147">Pubblicazione con i punti di connessione del servizio</span><span class="sxs-lookup"><span data-stu-id="e7341-147">Publishing with service connection points</span></span>](publishing-with-service-connection-points.md)
-   [<span data-ttu-id="e7341-148">Documentazione di SSPI</span><span class="sxs-lookup"><span data-stu-id="e7341-148">SSPI documentation</span></span>](/windows/desktop/SecAuthN/sspi)
-   [<span data-ttu-id="e7341-149">Documentazione di Windows Sockets</span><span class="sxs-lookup"><span data-stu-id="e7341-149">Windows Sockets documentation</span></span>](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 