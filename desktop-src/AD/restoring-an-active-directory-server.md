---
title: Ripristino di un server di Active Directory
description: I server di Active Directory devono essere ripristinati offline.
ms.assetid: 91fbbdc1-0e84-4b89-8a38-4c8d0268992b
ms.tgt_platform: multiple
keywords:
- Ripristino di Active Directory Active Directory
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 273d02fd50d6b3bd68a055a6a783566e4ebddcf7
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/17/2020
ms.locfileid: "103872254"
---
# <a name="restoring-an-active-directory-server"></a><span data-ttu-id="2f841-104">Ripristino di un server di Active Directory</span><span class="sxs-lookup"><span data-stu-id="2f841-104">Restoring an Active Directory Server</span></span>

<span data-ttu-id="2f841-105">I server di Active Directory devono essere ripristinati offline.</span><span class="sxs-lookup"><span data-stu-id="2f841-105">Active Directory servers must be restored offline.</span></span> <span data-ttu-id="2f841-106">Il sistema deve essere riavviato in modalità ripristino servizi directory.</span><span class="sxs-lookup"><span data-stu-id="2f841-106">The system must be restarted in Directory Services Restore mode.</span></span> <span data-ttu-id="2f841-107">In questa modalità, il sistema operativo è in esecuzione senza Active Directory Domain Services e tutte le convalide degli utenti avvengono tramite Gestione account di sicurezza (SAM) nel registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="2f841-107">In this mode, the operating system is running without Active Directory Domain Services and all user validation occurs through the Security Accounts Manager (SAM) in the registry.</span></span> <span data-ttu-id="2f841-108">Per ripristinare Active Directory Domain Services, utilizzare le credenziali di un amministratore locale nel controller di dominio ripristinato.</span><span class="sxs-lookup"><span data-stu-id="2f841-108">To restore Active Directory Domain Services, use the credentials of a local administrator on the domain controller that is restored.</span></span>

<span data-ttu-id="2f841-109">Il chiamante delle funzioni di ripristino deve disporre del privilegio di accesso **se \_ Restore \_ Name** .</span><span class="sxs-lookup"><span data-stu-id="2f841-109">The caller of the restore functions must have the **SE\_RESTORE\_NAME** access privilege.</span></span> <span data-ttu-id="2f841-110">Utilizzare la funzione [**DsSetAuthIdentity**](dssetauthidentity.md) per impostare il contesto di sicurezza in cui vengono chiamate le funzioni di backup e ripristino della directory.</span><span class="sxs-lookup"><span data-stu-id="2f841-110">Use the [**DsSetAuthIdentity**](dssetauthidentity.md) function to set the security context under which the directory backup and restore functions are called.</span></span>

<span data-ttu-id="2f841-111">Tenere presente che quando si esegue il ripristino di Active Directory Domain Services, è necessario ripristinare anche gli altri componenti dello stato del sistema.</span><span class="sxs-lookup"><span data-stu-id="2f841-111">Be aware that when you restore Active Directory Domain Services, you must also restore the other system state components.</span></span>

<span data-ttu-id="2f841-112">**Per ripristinare Active Directory Domain Services**</span><span class="sxs-lookup"><span data-stu-id="2f841-112">**To restore Active Directory Domain Services**</span></span>

1.  <span data-ttu-id="2f841-113">Chiamare la funzione [**DsIsNTDSOnline**](dsisntdsonline.md) per determinare se Active Directory Domain Services sono in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="2f841-113">Call the [**DsIsNTDSOnline**](dsisntdsonline.md) function to determine if Active Directory Domain Services are running.</span></span>
2.  <span data-ttu-id="2f841-114">Se Active Directory Domain Services non sono in esecuzione, viene chiamata la funzione [**DsRestorePrepare**](dsrestoreprepare.md) per inizializzare l'operazione di ripristino e ottenere un handle del contesto di backup.</span><span class="sxs-lookup"><span data-stu-id="2f841-114">If Active Directory Domain Services are not running, the [**DsRestorePrepare**](dsrestoreprepare.md) function is called to initialize the restore operation and obtain a backup context handle.</span></span> <span data-ttu-id="2f841-115">Se Active Directory Domain Services è in esecuzione, non può essere ripristinato e l'applicazione di ripristino deve avere esito negativo per l'operazione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="2f841-115">If Active Directory Domain Services are running, it cannot be restored and the restore application must fail the restore operation.</span></span> <span data-ttu-id="2f841-116">La funzione **DsRestorePrepare** richiede che il token di scadenza venga ottenuto dalla funzione [**DsBackupPrepare**](dsbackupprepare.md) durante l'operazione di backup.</span><span class="sxs-lookup"><span data-stu-id="2f841-116">The **DsRestorePrepare** function requires that the expiry token be obtained from the [**DsBackupPrepare**](dsbackupprepare.md) function during the backup operation.</span></span>
3.  <span data-ttu-id="2f841-117">Chiamare la funzione [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) per determinare le directory in cui devono essere ripristinati i file.</span><span class="sxs-lookup"><span data-stu-id="2f841-117">Call the [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) function to determine the directories where the files are to be restored.</span></span> <span data-ttu-id="2f841-118">Se questa funzione ha esito negativo, ripristinare i dati nella directory di origine del backup originale; ovvero la directory da cui è stato eseguito il backup dei dati.</span><span class="sxs-lookup"><span data-stu-id="2f841-118">If this function fails, restore the data back to the original backup source directory; that is the directory from which the data was backed up.</span></span>
4.  <span data-ttu-id="2f841-119">Chiamare la funzione [**DsRestoreRegister**](dsrestoreregister.md) per preparare il server Active Directory per l'operazione di ripristino e bloccare le directory di ripristino.</span><span class="sxs-lookup"><span data-stu-id="2f841-119">Call the [**DsRestoreRegister**](dsrestoreregister.md) function to prepare the Active Directory server for the restore operation and lock the restore directories.</span></span>
5.  <span data-ttu-id="2f841-120">Per ripristinare i file, utilizzare le funzioni Win32 standard.</span><span class="sxs-lookup"><span data-stu-id="2f841-120">Use standard Win32 functions to restore the files.</span></span> <span data-ttu-id="2f841-121">Prima di tutto, eliminare tutti i file nella directory di destinazione; Copiare quindi i file di backup nella directory di destinazione.</span><span class="sxs-lookup"><span data-stu-id="2f841-121">First, delete all files in the destination directory; then copy the backup files to the destination directory.</span></span>
6.  <span data-ttu-id="2f841-122">Chiamare la funzione [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) per indicare che il ripristino è stato completato.</span><span class="sxs-lookup"><span data-stu-id="2f841-122">Call the [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) function to indicate that the restore has completed.</span></span>
7.  <span data-ttu-id="2f841-123">Chiamare la funzione [**DsRestoreEnd**](dsrestoreend.md) per rilasciare tutte le risorse associate al contesto.</span><span class="sxs-lookup"><span data-stu-id="2f841-123">Call the [**DsRestoreEnd**](dsrestoreend.md) function to release any resources associated with the context.</span></span>

<span data-ttu-id="2f841-124">Dopo un ripristino in modalità ripristino servizi directory, il controller di dominio deve essere riavviato in modalità normale.</span><span class="sxs-lookup"><span data-stu-id="2f841-124">After a restore in Directory Services Restore mode, the domain controller should be restarted in normal mode.</span></span> <span data-ttu-id="2f841-125">All'avvio del servizio directory, il controller di dominio eseguirà la normale verifica della coerenza e la directory ripristinata sarà in linea.</span><span class="sxs-lookup"><span data-stu-id="2f841-125">When the directory service starts, the domain controller will perform the normal consistency check and the restored directory will then be online.</span></span>

<span data-ttu-id="2f841-126">Tenere presente che il ripristino di un server Active Directory è sempre un'operazione in due parti.</span><span class="sxs-lookup"><span data-stu-id="2f841-126">Be aware that restoring an Active Directory server is always a two-part operation.</span></span> <span data-ttu-id="2f841-127">Per prima cosa, ripristinare il database fino a un momento in cui è stato effettuato il backup.</span><span class="sxs-lookup"><span data-stu-id="2f841-127">First, restore the database to a time when the backup was taken.</span></span> <span data-ttu-id="2f841-128">In secondo luogo, replicare la directory, in cui la DSA appena ripristinata replica gli aggiornamenti post-backup da altri DSA nella foresta del dominio e dell'azienda.</span><span class="sxs-lookup"><span data-stu-id="2f841-128">Second, replicate the directory, where the newly restored DSA replicates post-backup updates from other DSAs in the domain and enterprise forest.</span></span>

<span data-ttu-id="2f841-129">Un computer che esegue Windows 2000 o Windows Server 2003, che contiene una replica del servizio directory, è un controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="2f841-129">A computer running on Windows 2000 or Windows Server 2003, that contains a replica of the directory service, is a domain controller.</span></span>

<span data-ttu-id="2f841-130">La funzione [**DsRestoreRegister**](dsrestoreregister.md) aggiunge dati al registro di sistema che devono rimanere inattivi nel processo di ripristino del registro di sistema affinché il ripristino funzioni correttamente.</span><span class="sxs-lookup"><span data-stu-id="2f841-130">The [**DsRestoreRegister**](dsrestoreregister.md) function adds data to the registry that must survive the registry restoration process for the restoration to work correctly.</span></span> <span data-ttu-id="2f841-131">Per garantire la conservazione dei dati del registro di sistema, ripristinare Active Directory Domain Services con le funzioni **Impossibile \*** prima di riavviare il computer dopo la chiamata della funzione [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) .</span><span class="sxs-lookup"><span data-stu-id="2f841-131">To ensure this registry data is preserved, restore Active Directory Domain Services with the **DsRestore\*** functions prior to restarting the computer after the [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) function is called.</span></span> <span data-ttu-id="2f841-132">Questo processo funziona perché **RegReplaceKey** non sostituisce effettivamente l'hive del registro di sistema finché il computer non viene riavviato e i dati del registro di sistema aggiunti dalla funzione **DsRestoreRegister** sono esclusi in modo specifico dalla sostituzione durante un'operazione di ripristino del registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="2f841-132">This process works because **RegReplaceKey** does not actually replace the registry hive until the computer is restarted and the registry data added by the **DsRestoreRegister** function is specifically excluded from being replaced during a registry restore operation.</span></span>

 

 