---
description: La pianificazione in modalità utente è un meccanismo leggero che le applicazioni possono utilizzare per pianificare i propri thread.
ms.assetid: f9dd92fe-6d7a-452c-893e-e6df1757e377
title: Pianificazione User-Mode
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f3ceea3c4d4e40d73f48414d074bcb5b4f6e911d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "106313315"
---
# <a name="user-mode-scheduling"></a><span data-ttu-id="4e890-103">Pianificazione User-Mode</span><span class="sxs-lookup"><span data-stu-id="4e890-103">User-Mode Scheduling</span></span>

<span data-ttu-id="4e890-104">La pianificazione in modalità utente è un meccanismo leggero che le applicazioni possono utilizzare per pianificare i propri thread.</span><span class="sxs-lookup"><span data-stu-id="4e890-104">User-mode scheduling (UMS) is a lightweight mechanism that applications can use to schedule their own threads.</span></span> <span data-ttu-id="4e890-105">Un'applicazione può passare tra i thread UMS in modalità utente senza coinvolgere l' [utilità di pianificazione del sistema](scheduling.md) e riacquisire il controllo del processore se un thread UMS si blocca nel kernel.</span><span class="sxs-lookup"><span data-stu-id="4e890-105">An application can switch between UMS threads in user mode without involving the [system scheduler](scheduling.md) and regain control of the processor if a UMS thread blocks in the kernel.</span></span> <span data-ttu-id="4e890-106">I thread UMS differiscono dalle [fibre](fibers.md) in quanto ogni thread UMS dispone di un proprio contesto di thread invece di condividere il contesto del thread di un singolo thread.</span><span class="sxs-lookup"><span data-stu-id="4e890-106">UMS threads differ from [fibers](fibers.md) in that each UMS thread has its own thread context instead of sharing the thread context of a single thread.</span></span> <span data-ttu-id="4e890-107">La possibilità di passare da un thread all'altro in modalità utente rende il UMS più efficiente dei [pool di thread](thread-pools.md) per la gestione di un numero elevato di elementi di lavoro di breve durata che richiedono poche chiamate di sistema.</span><span class="sxs-lookup"><span data-stu-id="4e890-107">The ability to switch between threads in user mode makes UMS more efficient than [thread pools](thread-pools.md) for managing large numbers of short-duration work items that require few system calls.</span></span>

<span data-ttu-id="4e890-108">Il sistema UMS è consigliato per le applicazioni con requisiti di prestazioni elevate che richiedono l'esecuzione efficiente di molti thread contemporaneamente su sistemi multiprocessore o multicore.</span><span class="sxs-lookup"><span data-stu-id="4e890-108">UMS is recommended for applications with high performance requirements that need to efficiently run many threads concurrently on multiprocessor or multicore systems.</span></span> <span data-ttu-id="4e890-109">Per sfruttare i vantaggi di UMS, un'applicazione deve implementare un componente dell'utilità di pianificazione che gestisce i thread UMS dell'applicazione e determina quando devono essere eseguiti.</span><span class="sxs-lookup"><span data-stu-id="4e890-109">To take advantage of UMS, an application must implement a scheduler component that manages the application's UMS threads and determines when they should run.</span></span> <span data-ttu-id="4e890-110">Gli sviluppatori devono considerare se i requisiti relativi alle prestazioni dell'applicazione giustificano il lavoro necessario per lo sviluppo di un componente di questo tipo.</span><span class="sxs-lookup"><span data-stu-id="4e890-110">Developers should consider whether their application performance requirements justify the work involved in developing such a component.</span></span> <span data-ttu-id="4e890-111">Le applicazioni con requisiti di prestazioni moderati possono essere gestite meglio consentendo all'utilità di pianificazione del sistema di pianificare i thread.</span><span class="sxs-lookup"><span data-stu-id="4e890-111">Applications with moderate performance requirements might be better served by allowing the system scheduler to schedule their threads.</span></span>

<span data-ttu-id="4e890-112">UMS è disponibile per le applicazioni a 64 bit in esecuzione su versioni a 64 bit di Windows 7 e Windows Server 2008 R2 o versioni successive a 64 bit di Windows.</span><span class="sxs-lookup"><span data-stu-id="4e890-112">UMS is available for 64-bit applications running on 64-bit versions of Windows 7 and Windows Server 2008 R2 or later 64-bit versions of Windows.</span></span> <span data-ttu-id="4e890-113">Questa funzionalità non è disponibile nelle versioni di Windows a 32 bit.</span><span class="sxs-lookup"><span data-stu-id="4e890-113">This feature is not available on 32-bit versions of Windows.</span></span>

<span data-ttu-id="4e890-114">Per informazioni dettagliate, vedere le sezioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="4e890-114">For details, see the following sections:</span></span>

-   [<span data-ttu-id="4e890-115">Utilità di pianificazione UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-115">UMS Scheduler</span></span>](#ums-scheduler)
-   [<span data-ttu-id="4e890-116">Thread dell'utilità di pianificazione UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-116">UMS Scheduler Thread</span></span>](#ums-scheduler-thread)
-   [<span data-ttu-id="4e890-117">Thread di lavoro UMS, contesti di thread ed elenchi di completamento</span><span class="sxs-lookup"><span data-stu-id="4e890-117">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>](#ums-worker-threads-thread-contexts-and-completion-lists)
-   [<span data-ttu-id="4e890-118">Funzione del punto di ingresso dell'utilità di pianificazione UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-118">UMS Scheduler Entry Point Function</span></span>](#ums-scheduler-entry-point-function)
-   [<span data-ttu-id="4e890-119">Esecuzione del thread UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-119">UMS Thread Execution</span></span>](#ums-thread-execution)
-   [<span data-ttu-id="4e890-120">Procedure consigliate per UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-120">UMS Best Practices</span></span>](#ums-best-practices)

## <a name="ums-scheduler"></a><span data-ttu-id="4e890-121">Utilità di pianificazione UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-121">UMS Scheduler</span></span>

<span data-ttu-id="4e890-122">L'utilità di pianificazione UMS di un'applicazione è responsabile della creazione, della gestione e dell'eliminazione di thread UMS e della determinazione del thread UMS da eseguire.</span><span class="sxs-lookup"><span data-stu-id="4e890-122">An application's UMS scheduler is responsible for creating, managing, and deleting UMS threads and determining which UMS thread to run.</span></span> <span data-ttu-id="4e890-123">L'utilità di pianificazione di un'applicazione esegue le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="4e890-123">An application's scheduler performs the following tasks:</span></span>

-   <span data-ttu-id="4e890-124">Crea un thread dell'utilità di pianificazione UMS per ogni processore in cui l'applicazione eseguirà i thread di lavoro di UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-124">Creates one UMS scheduler thread for each processor on which the application will run UMS worker threads.</span></span>
-   <span data-ttu-id="4e890-125">Crea thread di lavoro UMS per eseguire il lavoro dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="4e890-125">Creates UMS worker threads to perform the work of the application.</span></span>
-   <span data-ttu-id="4e890-126">Gestisce la coda dei thread di lavoro pronta per l'esecuzione e seleziona i thread da eseguire in base ai criteri di pianificazione dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="4e890-126">Maintains its own ready-thread queue of worker threads that are ready to run, and selects threads to run based on the application's scheduling policies.</span></span>
-   <span data-ttu-id="4e890-127">Crea e monitora uno o più elenchi di completamento in cui il sistema accoda i thread al termine dell'elaborazione nel kernel.</span><span class="sxs-lookup"><span data-stu-id="4e890-127">Creates and monitors one or more completion lists where the system queues threads after they finish processing in the kernel.</span></span> <span data-ttu-id="4e890-128">Sono inclusi i thread e i thread di lavoro appena creati precedentemente bloccati in una chiamata di sistema che viene sbloccata.</span><span class="sxs-lookup"><span data-stu-id="4e890-128">These include newly created worker threads and threads previously blocked on a system call that become unblocked.</span></span>
-   <span data-ttu-id="4e890-129">Fornisce una funzione del punto di ingresso dell'utilità di pianificazione per gestire le notifiche dal sistema.</span><span class="sxs-lookup"><span data-stu-id="4e890-129">Provides a scheduler entry point function to handles notifications from the system.</span></span> <span data-ttu-id="4e890-130">Il sistema chiama la funzione del punto di ingresso quando viene creato un thread dell'utilità di pianificazione, quando un thread di lavoro si blocca in una chiamata di sistema o quando un thread di lavoro restituisce in modo esplicito il controllo.</span><span class="sxs-lookup"><span data-stu-id="4e890-130">The system calls the entry point function when a scheduler thread is created, when a worker thread blocks on a system call, or when a worker thread explicitly yields control.</span></span>
-   <span data-ttu-id="4e890-131">Esegue attività di pulizia per i thread di lavoro che hanno terminato l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="4e890-131">Performs cleanup tasks for worker threads that have finished running.</span></span>
-   <span data-ttu-id="4e890-132">Esegue un arresto ordinato dell'utilità di pianificazione quando richiesto dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="4e890-132">Performs an orderly shutdown of the scheduler when requested by the application.</span></span>

## <a name="ums-scheduler-thread"></a><span data-ttu-id="4e890-133">Thread dell'utilità di pianificazione UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-133">UMS Scheduler Thread</span></span>

<span data-ttu-id="4e890-134">Un thread dell'utilità di pianificazione UMS è un thread normale che si è convertito in UMS chiamando la funzione [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) .</span><span class="sxs-lookup"><span data-stu-id="4e890-134">A UMS scheduler thread is an ordinary thread that has converted itself to UMS by calling the [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) function.</span></span> <span data-ttu-id="4e890-135">L'utilità di pianificazione del sistema determina il momento in cui il thread dell'utilità di pianificazione UMS viene eseguito in base alla priorità rispetto ad altri thread pronti.</span><span class="sxs-lookup"><span data-stu-id="4e890-135">The system scheduler determines when the UMS scheduler thread runs based on its priority relative to other ready threads.</span></span> <span data-ttu-id="4e890-136">Il processore in cui viene eseguito il thread dell'utilità di pianificazione è influenzato dall'affinità del thread, come per i thread non UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-136">The processor on which the scheduler thread runs is influenced by the thread's affinity, same as for non-UMS threads.</span></span>

<span data-ttu-id="4e890-137">Il chiamante di [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) specifica un elenco di completamento e una funzione del punto di ingresso [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) da associare al thread dell'utilità di pianificazione UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-137">The caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) specifies a completion list and a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) entry point function to associate with the UMS scheduler thread.</span></span> <span data-ttu-id="4e890-138">Il sistema chiama la funzione del punto di ingresso specificata al termine della conversione del thread chiamante in UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-138">The system calls the specified entry point function when it is finished converting the calling thread to UMS.</span></span> <span data-ttu-id="4e890-139">La funzione del punto di ingresso dell'utilità di pianificazione è responsabile della determinazione dell'azione successiva appropriata per il thread specificato.</span><span class="sxs-lookup"><span data-stu-id="4e890-139">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="4e890-140">Per ulteriori informazioni, vedere la [funzione del punto di ingresso dell'utilità di pianificazione UMS](#ums-scheduler-entry-point-function) più avanti in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="4e890-140">For more information, see [UMS Scheduler Entry Point Function](#ums-scheduler-entry-point-function) later in this topic.</span></span>

<span data-ttu-id="4e890-141">Un'applicazione potrebbe creare un thread dell'utilità di pianificazione UMS per ogni processore che verrà usato per eseguire i thread UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-141">An application might create one UMS scheduler thread for each processor that will be used to run UMS threads.</span></span> <span data-ttu-id="4e890-142">L'applicazione potrebbe anche impostare l'affinità di ogni thread dell'utilità di pianificazione UMS per un processore logico specifico, che tende a escludere i thread non correlati dall'esecuzione su tale processore, riservando in modo efficace il thread dell'utilità di pianificazione.</span><span class="sxs-lookup"><span data-stu-id="4e890-142">The application might also set the affinity of each UMS scheduler thread for a specific logical processor, which tends to exclude unrelated threads from running on that processor, effectively reserving it for that scheduler thread.</span></span> <span data-ttu-id="4e890-143">Tenere presente che l'impostazione dell'affinità dei thread in questo modo può influire sulle prestazioni complessive del sistema, eliminando gli altri processi che potrebbero essere in esecuzione nel sistema.</span><span class="sxs-lookup"><span data-stu-id="4e890-143">Be aware that setting thread affinity in this way can affect overall system performance by starving other processes that may be running on the system.</span></span> <span data-ttu-id="4e890-144">Per ulteriori informazioni sull'affinità di thread, vedere la pagina relativa a [più processori](multiple-processors.md).</span><span class="sxs-lookup"><span data-stu-id="4e890-144">For more information about thread affinity, see [Multiple Processors](multiple-processors.md).</span></span>

## <a name="ums-worker-threads-thread-contexts-and-completion-lists"></a><span data-ttu-id="4e890-145">Thread di lavoro UMS, contesti di thread ed elenchi di completamento</span><span class="sxs-lookup"><span data-stu-id="4e890-145">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>

<span data-ttu-id="4e890-146">Un thread di lavoro UMS viene creato chiamando [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) con l' \_ attributo thread \_ \_ UMS \_ thread UMS e specificando un contesto del thread UMS e un elenco di completamento.</span><span class="sxs-lookup"><span data-stu-id="4e890-146">A UMS worker thread is created by calling [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) with the PROC\_THREAD\_ATTRIBUTE\_UMS\_THREAD attribute and specifying a UMS thread context and a completion list.</span></span>

<span data-ttu-id="4e890-147">Un contesto del thread UMS rappresenta lo stato del thread UMS di un thread di lavoro e viene usato per identificare il thread di lavoro nelle chiamate di funzione UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-147">A UMS thread context represents the UMS thread state of a worker thread and is used to identify the worker thread in UMS function calls.</span></span> <span data-ttu-id="4e890-148">Viene creato chiamando [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span><span class="sxs-lookup"><span data-stu-id="4e890-148">It is created by calling [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span></span>

<span data-ttu-id="4e890-149">Viene creato un elenco di completamento chiamando la funzione [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) .</span><span class="sxs-lookup"><span data-stu-id="4e890-149">A completion list is created by calling the [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) function.</span></span> <span data-ttu-id="4e890-150">Un elenco di completamento riceve i thread di lavoro UMS che hanno completato l'esecuzione nel kernel e sono pronti per l'esecuzione in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="4e890-150">A completion list receives UMS worker threads that have completed execution in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="4e890-151">Solo il sistema può accodare i thread di lavoro a un elenco di completamento.</span><span class="sxs-lookup"><span data-stu-id="4e890-151">Only the system can queue worker threads to a completion list.</span></span> <span data-ttu-id="4e890-152">I nuovi thread di lavoro UMS vengono accodati automaticamente all'elenco di completamento specificato al momento della creazione dei thread.</span><span class="sxs-lookup"><span data-stu-id="4e890-152">New UMS worker threads are automatically queued to the completion list specified when the threads were created.</span></span> <span data-ttu-id="4e890-153">I thread di lavoro bloccati in precedenza vengono accodati anche all'elenco di completamento quando non sono più bloccati.</span><span class="sxs-lookup"><span data-stu-id="4e890-153">Previously blocked worker threads are also queued to the completion list when they are no longer blocked.</span></span>

<span data-ttu-id="4e890-154">Ogni thread dell'utilità di pianificazione UMS è associato a un unico elenco di completamento.</span><span class="sxs-lookup"><span data-stu-id="4e890-154">Each UMS scheduler thread is associated with a single completion list.</span></span> <span data-ttu-id="4e890-155">Tuttavia, lo stesso elenco di completamento può essere associato a un numero qualsiasi di thread dell'utilità di pianificazione UMS e un thread dell'utilità di pianificazione può recuperare i contesti UMS da qualsiasi elenco di completamento per il quale è presente un puntatore.</span><span class="sxs-lookup"><span data-stu-id="4e890-155">However, the same completion list can be associated with any number of UMS scheduler threads, and a scheduler thread can retrieve UMS contexts from any completion list for which it has a pointer.</span></span>

<span data-ttu-id="4e890-156">A ogni elenco di completamento è associato un evento segnalato dal sistema quando Accoda uno o più thread di lavoro a un elenco vuoto.</span><span class="sxs-lookup"><span data-stu-id="4e890-156">Each completion list has an associated event that is signaled by the system when it queues one or more worker threads to an empty list.</span></span> <span data-ttu-id="4e890-157">La funzione [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) recupera un handle per l'evento per un elenco di completamento specificato.</span><span class="sxs-lookup"><span data-stu-id="4e890-157">The [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) function retrieves a handle to the event for a specified completion list.</span></span> <span data-ttu-id="4e890-158">Un'applicazione può attendere più di un evento di elenco di completamento insieme ad altri eventi che hanno senso per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="4e890-158">An application can wait on more than one completion list event along with other events that make sense for the application.</span></span>

## <a name="ums-scheduler-entry-point-function"></a><span data-ttu-id="4e890-159">Funzione del punto di ingresso dell'utilità di pianificazione UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-159">UMS Scheduler Entry Point Function</span></span>

<span data-ttu-id="4e890-160">La funzione del punto di ingresso dell'utilità di pianificazione di un'applicazione viene implementata come funzione [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) .</span><span class="sxs-lookup"><span data-stu-id="4e890-160">An application's scheduler entry point function is implemented as a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function.</span></span> <span data-ttu-id="4e890-161">Il sistema chiama la funzione del punto di ingresso dell'utilità di pianificazione dell'applicazione negli orari seguenti:</span><span class="sxs-lookup"><span data-stu-id="4e890-161">The system calls the application's scheduler entry point function at the following times:</span></span>

-   <span data-ttu-id="4e890-162">Quando un thread non UMS viene convertito in un thread dell'utilità di pianificazione UMS chiamando [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="4e890-162">When a non-UMS thread is converted to a UMS scheduler thread by calling [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span>
-   <span data-ttu-id="4e890-163">Quando un thread di lavoro UMS chiama [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="4e890-163">When a UMS worker thread calls [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span>
-   <span data-ttu-id="4e890-164">Quando un thread di lavoro UMS si blocca in un servizio di sistema, ad esempio una chiamata di sistema o un errore di pagina.</span><span class="sxs-lookup"><span data-stu-id="4e890-164">When a UMS worker thread blocks on a system service such as a system call or a page fault.</span></span>

<span data-ttu-id="4e890-165">Il parametro *reason* della funzione [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) specifica il motivo per cui è stata chiamata la funzione del punto di ingresso.</span><span class="sxs-lookup"><span data-stu-id="4e890-165">The *Reason* parameter of the [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function specifies the reason that the entry point function was called.</span></span> <span data-ttu-id="4e890-166">Se la funzione del punto di ingresso è stata chiamata perché è stato creato un nuovo thread dell'utilità di pianificazione UMS, il parametro *SchedulerParam* contiene i dati specificati dal chiamante di [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="4e890-166">If the entry point function was called because a new UMS scheduler thread was created, the *SchedulerParam* parameter contains data specified by the caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span> <span data-ttu-id="4e890-167">Se la funzione del punto di ingresso è stata chiamata perché è stato restituito un thread di lavoro UMS, il parametro *SchedulerParam* contiene i dati specificati dal chiamante di [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="4e890-167">If the entry point function was called because a UMS worker thread yielded, the *SchedulerParam* parameter contains data specified by the caller of [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span> <span data-ttu-id="4e890-168">Se la funzione del punto di ingresso è stata chiamata perché un thread di lavoro UMS è bloccato nel kernel, il parametro *SchedulerParam* è null.</span><span class="sxs-lookup"><span data-stu-id="4e890-168">If the entry point function was called because a UMS worker thread blocked in the kernel, the *SchedulerParam* parameter is NULL.</span></span>

<span data-ttu-id="4e890-169">La funzione del punto di ingresso dell'utilità di pianificazione è responsabile della determinazione dell'azione successiva appropriata per il thread specificato.</span><span class="sxs-lookup"><span data-stu-id="4e890-169">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="4e890-170">Se, ad esempio, un thread di lavoro è bloccato, la funzione del punto di ingresso dell'utilità di pianificazione potrebbe eseguire il thread di lavoro UMS pronto disponibile successivo.</span><span class="sxs-lookup"><span data-stu-id="4e890-170">For example, if a worker thread is blocked, the scheduler entry point function might run the next available ready UMS worker thread.</span></span>

<span data-ttu-id="4e890-171">Quando viene chiamata la funzione del punto di ingresso dell'utilità di pianificazione, l'utilità di pianificazione dell'applicazione deve tentare di recuperare tutti gli elementi nell'elenco di completamento associato chiamando la funzione [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) .</span><span class="sxs-lookup"><span data-stu-id="4e890-171">When the scheduler entry point function is called, the application's scheduler should attempt to retrieve all of the items in its associated completion list by calling the [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) function.</span></span> <span data-ttu-id="4e890-172">Questa funzione recupera un elenco di contesti di thread UMS che hanno terminato l'elaborazione nel kernel e sono pronti per l'esecuzione in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="4e890-172">This function retrieves a list of UMS thread contexts that have finished processing in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="4e890-173">L'utilità di pianificazione dell'applicazione non deve eseguire i thread UMS direttamente da questo elenco perché questo può causare un comportamento imprevedibile nell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="4e890-173">The application's scheduler should not run UMS threads directly from this list because this can cause unpredictable behavior in the application.</span></span> <span data-ttu-id="4e890-174">L'utilità di pianificazione deve invece recuperare tutti i contesti di thread UMS chiamando la funzione [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) una volta per ogni contesto, inserire i contesti del thread UMS nella coda dei thread pronti dell'utilità di pianificazione e quindi eseguire i thread UMS dalla coda dei thread pronti.</span><span class="sxs-lookup"><span data-stu-id="4e890-174">Instead, the scheduler should retrieve all UMS thread contexts by calling the [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) function once for each context, insert the UMS thread contexts in the scheduler’s ready thread queue, and only then run UMS threads from the ready thread queue.</span></span>

<span data-ttu-id="4e890-175">Se l'utilità di pianificazione non deve attendere più eventi, deve chiamare [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) con un parametro di timeout diverso da zero, in modo che la funzione attenda l'evento dell'elenco di completamento prima di restituire.</span><span class="sxs-lookup"><span data-stu-id="4e890-175">If the scheduler does not need to wait on multiple events, it should call [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) with a nonzero timeout parameter so the function waits on the completion list event before returning.</span></span> <span data-ttu-id="4e890-176">Se l'utilità di pianificazione deve attendere più eventi dell'elenco di completamento, deve chiamare **DequeueUmsCompletionListItems** con un parametro di timeout pari a zero, in modo che la funzione venga restituita immediatamente, anche se l'elenco di completamento è vuoto.</span><span class="sxs-lookup"><span data-stu-id="4e890-176">If the scheduler does need to wait on multiple completion list events, it should call **DequeueUmsCompletionListItems** with a timeout parameter of zero so the function returns immediately, even if the completion list is empty.</span></span> <span data-ttu-id="4e890-177">In questo caso, l'utilità di pianificazione può attendere in modo esplicito gli eventi dell'elenco di completamento, ad esempio usando [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span><span class="sxs-lookup"><span data-stu-id="4e890-177">In this case, the scheduler can wait explicitly on completion list events, for example, by using [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span></span>

## <a name="ums-thread-execution"></a><span data-ttu-id="4e890-178">Esecuzione del thread UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-178">UMS Thread Execution</span></span>

<span data-ttu-id="4e890-179">Un thread di lavoro UMS appena creato viene accodato all'elenco di completamento specificato e non inizia l'esecuzione fino a quando l'utilità di pianificazione UMS dell'applicazione non la seleziona per l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="4e890-179">A newly created UMS worker thread is queued to the specified completion list and does not begin running until the application's UMS scheduler selects it to run.</span></span> <span data-ttu-id="4e890-180">Questo comportamento è diverso da quello dei thread non UMS, che l'utilità di pianificazione di sistema pianifica automaticamente per l'esecuzione, a meno che il chiamante non crei in modo esplicito il thread sospeso.</span><span class="sxs-lookup"><span data-stu-id="4e890-180">This differs from non-UMS threads, which the system scheduler automatically schedules to run unless the caller explicitly creates the thread suspended.</span></span>

<span data-ttu-id="4e890-181">L'utilità di pianificazione esegue un thread di lavoro chiamando [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) con il contesto UMS del thread di lavoro.</span><span class="sxs-lookup"><span data-stu-id="4e890-181">The scheduler runs a worker thread by calling [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) with the worker thread's UMS context.</span></span> <span data-ttu-id="4e890-182">Un thread di lavoro UMS viene eseguito fino a quando non viene restituito chiamando la funzione [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) , i blocchi o termina.</span><span class="sxs-lookup"><span data-stu-id="4e890-182">A UMS worker thread runs until it yields by calling the [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) function, blocks, or terminates.</span></span>

## <a name="ums-best-practices"></a><span data-ttu-id="4e890-183">Procedure consigliate per UMS</span><span class="sxs-lookup"><span data-stu-id="4e890-183">UMS Best Practices</span></span>

<span data-ttu-id="4e890-184">Le applicazioni che implementano UMS devono seguire queste procedure consigliate:</span><span class="sxs-lookup"><span data-stu-id="4e890-184">Applications that implement UMS should follow these best practices:</span></span>

-   <span data-ttu-id="4e890-185">Le strutture sottostanti per i contesti di thread UMS vengono gestite dal sistema e non devono essere modificate direttamente.</span><span class="sxs-lookup"><span data-stu-id="4e890-185">The underlying structures for UMS thread contexts are managed by the system and should not be modified directly.</span></span> <span data-ttu-id="4e890-186">Usare invece [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) e [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) per recuperare e impostare le informazioni su un thread di lavoro UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-186">Instead, use [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) and [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) to retrieve and set information about a UMS worker thread.</span></span>
-   <span data-ttu-id="4e890-187">Per evitare deadlock, il thread dell'utilità di pianificazione UMS non deve condividere i blocchi con i thread di lavoro UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-187">To help prevent deadlocks, the UMS scheduler thread should not share locks with UMS worker threads.</span></span> <span data-ttu-id="4e890-188">Sono inclusi i blocchi creati dall'applicazione e i blocchi di sistema che vengono acquisiti indirettamente da operazioni quali l'allocazione dall'heap o il caricamento di dll.</span><span class="sxs-lookup"><span data-stu-id="4e890-188">This includes both application-created locks and system locks that are acquired indirectly by operations such as allocating from the heap or loading DLLs.</span></span> <span data-ttu-id="4e890-189">Si supponga, ad esempio, che l'utilità di pianificazione esegua un thread di lavoro UMS che carica una DLL.</span><span class="sxs-lookup"><span data-stu-id="4e890-189">For example, suppose the scheduler runs a UMS worker thread that loads a DLL.</span></span> <span data-ttu-id="4e890-190">Il thread di lavoro acquisisce il blocco del caricatore e i blocchi.</span><span class="sxs-lookup"><span data-stu-id="4e890-190">The worker thread acquires the loader lock and blocks.</span></span> <span data-ttu-id="4e890-191">Il sistema chiama la funzione del punto di ingresso dell'utilità di pianificazione, che quindi carica una DLL.</span><span class="sxs-lookup"><span data-stu-id="4e890-191">The system calls the scheduler entry point function, which then loads a DLL.</span></span> <span data-ttu-id="4e890-192">Questo causa un deadlock, perché il blocco del caricatore è già attivo e non può essere rilasciato fino a quando il primo thread non viene sbloccato.</span><span class="sxs-lookup"><span data-stu-id="4e890-192">This causes a deadlock, because the loader lock is already held and cannot be released until the first thread unblocks.</span></span> <span data-ttu-id="4e890-193">Per evitare questo problema, delegare il lavoro che potrebbe condividere blocchi con thread di lavoro UMS a un thread di lavoro UMS dedicato o a un thread non UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-193">To help avoid this problem, delegate work that might share locks with UMS worker threads to a dedicated UMS worker thread or a non-UMS thread.</span></span>
-   <span data-ttu-id="4e890-194">UMS è più efficiente quando la maggior parte dell'elaborazione viene eseguita in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="4e890-194">UMS is most efficient when most processing is done in user mode.</span></span> <span data-ttu-id="4e890-195">Laddove possibile, evitare di effettuare chiamate di sistema nei thread di lavoro UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-195">Whenever possible, avoid making system calls in UMS worker threads.</span></span>
-   <span data-ttu-id="4e890-196">I thread di lavoro UMS non devono presupporre che l'utilità di pianificazione del sistema venga utilizzata.</span><span class="sxs-lookup"><span data-stu-id="4e890-196">UMS worker threads should not assume the system scheduler is being used.</span></span> <span data-ttu-id="4e890-197">Questo presupposto può avere effetti delicati; Se, ad esempio, un thread nel codice sconosciuto imposta una priorità o un'affinità del thread, l'utilità di pianificazione UMS potrebbe ancora eseguirne l'override.</span><span class="sxs-lookup"><span data-stu-id="4e890-197">This assumption can have subtle effects; for example, if a thread in the unknown code sets a thread priority or affinity, the UMS scheduler might still override it.</span></span> <span data-ttu-id="4e890-198">Il codice che presuppone che l'utilità di pianificazione del sistema venga utilizzato potrebbe non comportarsi come previsto e potrebbe interrompersi quando viene chiamato da un thread UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-198">Code that assumes the system scheduler is being used may not behave as expected and may break when called by a UMS thread.</span></span>
-   <span data-ttu-id="4e890-199">Il sistema potrebbe dover bloccare il contesto del thread di un thread di lavoro UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-199">The system may need to lock the thread context of a UMS worker thread.</span></span> <span data-ttu-id="4e890-200">Ad esempio, una chiamata di procedura asincrona (APC) in modalità kernel potrebbe modificare il contesto del thread UMS, quindi il contesto del thread deve essere bloccato.</span><span class="sxs-lookup"><span data-stu-id="4e890-200">For example, a kernel-mode asynchronous procedure call (APC) might change the context of the UMS thread, so the thread context must be locked.</span></span> <span data-ttu-id="4e890-201">Se l'utilità di pianificazione tenta di eseguire il contesto del thread UMS mentre è bloccata, la chiamata avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="4e890-201">If the scheduler tries to execute the UMS thread context while it is locked, the call will fail.</span></span> <span data-ttu-id="4e890-202">Questo comportamento è basato sulla progettazione e l'utilità di pianificazione deve essere progettata per ritentare l'accesso al contesto del thread UMS.</span><span class="sxs-lookup"><span data-stu-id="4e890-202">This behavior is by design, and the scheduler should be designed to retry access to the UMS thread context.</span></span>

 

 
