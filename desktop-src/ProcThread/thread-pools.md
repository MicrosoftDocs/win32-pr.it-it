---
description: Un pool di thread è una raccolta di thread di lavoro che eseguono in modo efficiente callback asincroni per conto dell'applicazione.
ms.assetid: abe0798a-0b60-4bdb-a61e-45393f1e958d
title: Pool di thread
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 690aa3eb6fd3ce7a99d71e0f57118529ef79113f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "106313318"
---
# <a name="thread-pools"></a><span data-ttu-id="934c2-103">Pool di thread</span><span class="sxs-lookup"><span data-stu-id="934c2-103">Thread Pools</span></span>

<span data-ttu-id="934c2-104">Un *pool di thread* è una raccolta di thread di lavoro che eseguono in modo efficiente callback asincroni per conto dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="934c2-104">A *thread pool* is a collection of worker threads that efficiently execute asynchronous callbacks on behalf of the application.</span></span> <span data-ttu-id="934c2-105">Il pool di thread viene utilizzato principalmente per ridurre il numero di thread dell'applicazione e fornire la gestione dei thread di lavoro.</span><span class="sxs-lookup"><span data-stu-id="934c2-105">The thread pool is primarily used to reduce the number of application threads and provide management of the worker threads.</span></span> <span data-ttu-id="934c2-106">Le applicazioni possono accodare gli elementi di lavoro, associare il lavoro con handle waitable, accodarsi automaticamente in base a un timer e associarli all'I/O.</span><span class="sxs-lookup"><span data-stu-id="934c2-106">Applications can queue work items, associate work with waitable handles, automatically queue based on a timer, and bind with I/O.</span></span>

## <a name="thread-pool-architecture"></a><span data-ttu-id="934c2-107">Architettura del pool di thread</span><span class="sxs-lookup"><span data-stu-id="934c2-107">Thread Pool Architecture</span></span>

<span data-ttu-id="934c2-108">Le applicazioni seguenti possono trarre vantaggio dall'utilizzo di un pool di thread:</span><span class="sxs-lookup"><span data-stu-id="934c2-108">The following applications can benefit from using a thread pool:</span></span>

-   <span data-ttu-id="934c2-109">Applicazione altamente parallela che può inviare un numero elevato di piccoli elementi di lavoro in modo asincrono, ad esempio ricerca di indici distribuiti o I/O di rete.</span><span class="sxs-lookup"><span data-stu-id="934c2-109">An application that is highly parallel and can dispatch a large number of small work items asynchronously (such as distributed index search or network I/O).</span></span>
-   <span data-ttu-id="934c2-110">Applicazione che crea ed elimina un numero elevato di thread eseguiti per un breve periodo di tempo.</span><span class="sxs-lookup"><span data-stu-id="934c2-110">An application that creates and destroys a large number of threads that each run for a short time.</span></span> <span data-ttu-id="934c2-111">L'utilizzo del pool di thread può ridurre la complessità della gestione dei thread e l'overhead necessario per la creazione e la distruzione di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-111">Using the thread pool can reduce the complexity of thread management and the overhead involved in thread creation and destruction.</span></span>
-   <span data-ttu-id="934c2-112">Applicazione che elabora gli elementi di lavoro indipendenti in background e in parallelo (ad esempio il caricamento di più schede).</span><span class="sxs-lookup"><span data-stu-id="934c2-112">An application that processes independent work items in the background and in parallel (such as loading multiple tabs).</span></span>
-   <span data-ttu-id="934c2-113">Un'applicazione che deve eseguire un'attesa esclusiva sugli oggetti kernel o bloccare gli eventi in ingresso in un oggetto.</span><span class="sxs-lookup"><span data-stu-id="934c2-113">An application that must perform an exclusive wait on kernel objects or block on incoming events on an object.</span></span> <span data-ttu-id="934c2-114">L'utilizzo del pool di thread può ridurre la complessità della gestione dei thread e migliorare le prestazioni riducendo il numero di cambi di contesto.</span><span class="sxs-lookup"><span data-stu-id="934c2-114">Using the thread pool can reduce the complexity of thread management and increase performance by reducing the number of context switches.</span></span>
-   <span data-ttu-id="934c2-115">Applicazione che crea thread del cameriere personalizzati da attendere per gli eventi.</span><span class="sxs-lookup"><span data-stu-id="934c2-115">An application that creates custom waiter threads to wait on events.</span></span>

<span data-ttu-id="934c2-116">Il pool di thread originale è stato completamente riprogettato in Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="934c2-116">The original thread pool has been completely rearchitected in Windows Vista.</span></span> <span data-ttu-id="934c2-117">Il nuovo pool di thread è migliorato perché fornisce un solo tipo di thread di lavoro (supporta le I/O e non I/O), non utilizza un thread del timer, fornisce una sola coda del timer e fornisce un thread permanente dedicato.</span><span class="sxs-lookup"><span data-stu-id="934c2-117">The new thread pool is improved because it provides a single worker thread type (supports both I/O and non-I/O), does not use a timer thread, provides a single timer queue, and provides a dedicated persistent thread.</span></span> <span data-ttu-id="934c2-118">Fornisce inoltre gruppi di pulitura, prestazioni più elevate, più pool per processo pianificati in modo indipendente e una nuova API del pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-118">It also provides clean-up groups, higher performance, multiple pools per process that are scheduled independently, and a new thread pool API.</span></span>

<span data-ttu-id="934c2-119">L'architettura del pool di thread è costituita dagli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="934c2-119">The thread pool architecture consists of the following:</span></span>

-   <span data-ttu-id="934c2-120">Thread di lavoro che eseguono le funzioni di callback</span><span class="sxs-lookup"><span data-stu-id="934c2-120">Worker threads that execute the callback functions</span></span>
-   <span data-ttu-id="934c2-121">Thread del cameriere che attendono più handle di attesa</span><span class="sxs-lookup"><span data-stu-id="934c2-121">Waiter threads that wait on multiple wait handles</span></span>
-   <span data-ttu-id="934c2-122">Coda di lavoro</span><span class="sxs-lookup"><span data-stu-id="934c2-122">A work queue</span></span>
-   <span data-ttu-id="934c2-123">Un pool di thread predefinito per ogni processo</span><span class="sxs-lookup"><span data-stu-id="934c2-123">A default thread pool for each process</span></span>
-   <span data-ttu-id="934c2-124">Una factory di lavoro che gestisce i thread di lavoro</span><span class="sxs-lookup"><span data-stu-id="934c2-124">A worker factory that manages the worker threads</span></span>

## <a name="best-practices"></a><span data-ttu-id="934c2-125">Procedure consigliate</span><span class="sxs-lookup"><span data-stu-id="934c2-125">Best Practices</span></span>

<span data-ttu-id="934c2-126">La nuova [API del pool di thread](thread-pool-api.md) offre maggiore flessibilità e controllo rispetto all' [API originale del pool di thread](thread-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="934c2-126">The new [thread pool API](thread-pool-api.md) provides more flexibility and control than the [original thread pool API](thread-pooling.md).</span></span> <span data-ttu-id="934c2-127">Tuttavia, esistono alcune differenze minime ma importanti.</span><span class="sxs-lookup"><span data-stu-id="934c2-127">However, there are a few subtle but important differences.</span></span> <span data-ttu-id="934c2-128">Nell'API originale il ripristino delle attese era automatico; nella nuova API, l'attesa deve essere reimpostata in modo esplicito ogni volta.</span><span class="sxs-lookup"><span data-stu-id="934c2-128">In the original API, the wait reset was automatic; in the new API, the wait must be explicitly reset each time.</span></span> <span data-ttu-id="934c2-129">L'API originale ha gestito automaticamente la rappresentazione, trasferendo il contesto di sicurezza del processo chiamante al thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-129">The original API handled impersonation automatically, transferring the security context of the calling process to the thread.</span></span> <span data-ttu-id="934c2-130">Con la nuova API, l'applicazione deve impostare in modo esplicito il contesto di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="934c2-130">With the new API, the application must explicitly set the security context.</span></span>

<span data-ttu-id="934c2-131">Di seguito sono illustrate le procedure consigliate per l'utilizzo di un pool di thread:</span><span class="sxs-lookup"><span data-stu-id="934c2-131">The following are best practices when using a thread pool:</span></span>

-   <span data-ttu-id="934c2-132">I thread di un processo condividono il pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-132">The threads of a process share the thread pool.</span></span> <span data-ttu-id="934c2-133">Un singolo thread di lavoro può eseguire più funzioni di callback, una alla volta.</span><span class="sxs-lookup"><span data-stu-id="934c2-133">A single worker thread can execute multiple callback functions, one at a time.</span></span> <span data-ttu-id="934c2-134">Questi thread di lavoro vengono gestiti dal pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-134">These worker threads are managed by the thread pool.</span></span> <span data-ttu-id="934c2-135">Pertanto, non terminare un thread dal pool di thread chiamando [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) sul thread o chiamando [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) da una funzione di callback.</span><span class="sxs-lookup"><span data-stu-id="934c2-135">Therefore, do not terminate a thread from the thread pool by calling [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) on the thread or by calling [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) from a callback function.</span></span>
-   <span data-ttu-id="934c2-136">Una richiesta di I/O può essere eseguita in qualsiasi thread del pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-136">An I/O request can run on any thread in the thread pool.</span></span> <span data-ttu-id="934c2-137">Per annullare l'I/O su un thread del pool di thread è necessaria la sincronizzazione perché la funzione Cancel può essere eseguita su un thread diverso da quello che gestisce la richiesta di I/O, operazione che può causare l'annullamento di un'operazione sconosciuta.</span><span class="sxs-lookup"><span data-stu-id="934c2-137">Canceling I/O on a thread pool thread requires synchronization because the cancel function might run on a different thread than the one that is handling the I/O request, which can result in cancellation of an unknown operation.</span></span> <span data-ttu-id="934c2-138">Per evitare questo problema, fornire sempre la struttura [**sovrapposta**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) a cui è stata avviata una richiesta di i/o durante la chiamata di [**CancelIoEx**](/windows/win32/api/ioapiset/nf-ioapiset-cancelioex) per l'i/o asincrono oppure utilizzare la sincronizzazione personalizzata per assicurarsi che non sia possibile avviare altre operazioni di i/o nel thread di destinazione prima di chiamare la funzione [**CancelSynchronousIo**](/windows/win32/api/ioapiset/nf-ioapiset-cancelsynchronousio) o **CancelIoEx** .</span><span class="sxs-lookup"><span data-stu-id="934c2-138">To avoid this, always provide the [**OVERLAPPED**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) structure with which an I/O request was initiated when calling [**CancelIoEx**](/windows/win32/api/ioapiset/nf-ioapiset-cancelioex) for asynchronous I/O, or use your own synchronization to ensure that no other I/O can be started on the target thread before calling either the [**CancelSynchronousIo**](/windows/win32/api/ioapiset/nf-ioapiset-cancelsynchronousio) or **CancelIoEx** function.</span></span>
-   <span data-ttu-id="934c2-139">Eseguire la pulizia di tutte le risorse create nella funzione di callback prima di restituire dalla funzione.</span><span class="sxs-lookup"><span data-stu-id="934c2-139">Clean up all resources created in the callback function before returning from the function.</span></span> <span data-ttu-id="934c2-140">Sono inclusi TLS, contesti di sicurezza, priorità dei thread e registrazione COM.</span><span class="sxs-lookup"><span data-stu-id="934c2-140">These include TLS, security contexts, thread priority, and COM registration.</span></span> <span data-ttu-id="934c2-141">Le funzioni di callback devono inoltre ripristinare lo stato del thread prima di restituire.</span><span class="sxs-lookup"><span data-stu-id="934c2-141">Callback functions must also restore the thread state before returning.</span></span>
-   <span data-ttu-id="934c2-142">Mantiene attivi gli handle di attesa e gli oggetti associati fino a quando il pool di thread non ha segnalato che è terminato con l'handle.</span><span class="sxs-lookup"><span data-stu-id="934c2-142">Keep wait handles and their associated objects alive until the thread pool has signaled that it is finished with the handle.</span></span>
-   <span data-ttu-id="934c2-143">Contrassegnare tutti i thread in attesa di operazioni lunghe, ad esempio gli scaricamenti di I/O o la pulizia delle risorse, in modo che il pool di thread possa allocare nuovi thread invece di attendere questo.</span><span class="sxs-lookup"><span data-stu-id="934c2-143">Mark all threads that are waiting on lengthy operations (such as I/O flushes or resource cleanup) so that the thread pool can allocate new threads instead of waiting for this one.</span></span>
-   <span data-ttu-id="934c2-144">Prima di scaricare una DLL che usa il pool di thread, annullare tutti gli elementi di lavoro, le operazioni di I/O, le operazioni di attesa e i timer e attendere il completamento dell'esecuzione dei callback.</span><span class="sxs-lookup"><span data-stu-id="934c2-144">Before unloading a DLL that uses the thread pool, cancel all work items, I/O, wait operations, and timers, and wait for executing callbacks to complete.</span></span>
-   <span data-ttu-id="934c2-145">Evitare i deadlock eliminando le dipendenze tra gli elementi di lavoro e tra i callback, garantendo che un callback non sia in attesa del completamento e mantenendo la priorità del thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-145">Avoid deadlocks by eliminating dependencies between work items and between callbacks, by ensuring a callback is not waiting for itself to complete, and by preserving the thread priority.</span></span>
-   <span data-ttu-id="934c2-146">Non accodare troppi elementi troppo rapidamente in un processo con altri componenti che usano il pool di thread predefinito.</span><span class="sxs-lookup"><span data-stu-id="934c2-146">Do not queue too many items too quickly in a process with other components using the default thread pool.</span></span> <span data-ttu-id="934c2-147">È presente un pool di thread predefinito per processo, incluso Svchost.exe.</span><span class="sxs-lookup"><span data-stu-id="934c2-147">There is one default thread pool per process, including Svchost.exe.</span></span> <span data-ttu-id="934c2-148">Per impostazione predefinita, ogni pool di thread ha un massimo di 500 thread di lavoro.</span><span class="sxs-lookup"><span data-stu-id="934c2-148">By default, each thread pool has a maximum of 500 worker threads.</span></span> <span data-ttu-id="934c2-149">Il pool di thread tenta di creare più thread di lavoro quando il numero di thread di lavoro nello stato pronto/in esecuzione deve essere inferiore al numero di processori.</span><span class="sxs-lookup"><span data-stu-id="934c2-149">The thread pool attempts to create more worker threads when the number of worker threads in the ready/running state must be less than the number of processors.</span></span>
-   <span data-ttu-id="934c2-150">Evitare il modello di Apartment a thread singolo COM, perché non è compatibile con il pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-150">Avoid the COM single-threaded apartment model, as it is incompatible with the thread pool.</span></span> <span data-ttu-id="934c2-151">STA creando lo stato del thread che può influire sull'elemento di lavoro successivo per il thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-151">STA creates thread state which can affect the next work item for the thread.</span></span> <span data-ttu-id="934c2-152">Sta in genere di lunga durata e presenta affinità di thread, che è l'opposto del pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-152">STA is generally long-lived and has thread affinity, which is the opposite of the thread pool.</span></span>
-   <span data-ttu-id="934c2-153">Creare un nuovo pool di thread per controllare la priorità e l'isolamento del thread, creare caratteristiche personalizzate e possibilmente migliorare la velocità di risposta.</span><span class="sxs-lookup"><span data-stu-id="934c2-153">Create a new thread pool to control thread priority and isolation, create custom characteristics, and possibly improve responsiveness.</span></span> <span data-ttu-id="934c2-154">Tuttavia, i pool di thread aggiuntivi richiedono più risorse di sistema (thread, memoria kernel).</span><span class="sxs-lookup"><span data-stu-id="934c2-154">However, additional thread pools require more system resources (threads, kernel memory).</span></span> <span data-ttu-id="934c2-155">Troppi pool aumentano il rischio di contesa di CPU.</span><span class="sxs-lookup"><span data-stu-id="934c2-155">Too many pools increases the potential for CPU contention.</span></span>
-   <span data-ttu-id="934c2-156">Se possibile, usare un oggetto waitable anziché un meccanismo basato su APC per segnalare un thread del pool di thread.</span><span class="sxs-lookup"><span data-stu-id="934c2-156">If possible, use a waitable object instead of an APC-based mechanism to signal a thread pool thread.</span></span> <span data-ttu-id="934c2-157">APC non funzionano anche con i thread del pool di thread come altri meccanismi di segnalazione, perché il sistema controlla la durata dei thread del pool di thread, quindi è possibile che un thread venga terminato prima che la notifica venga recapitata.</span><span class="sxs-lookup"><span data-stu-id="934c2-157">APCs do not work as well with thread pool threads as other signaling mechanisms because the system controls the lifetime of thread pool threads, so it is possible for a thread to be terminated before the notification is delivered.</span></span>
-   <span data-ttu-id="934c2-158">Utilizzare l'estensione del debugger del pool di thread,! TP.</span><span class="sxs-lookup"><span data-stu-id="934c2-158">Use the thread pool debugger extension, !tp.</span></span> <span data-ttu-id="934c2-159">Questo comando presenta il seguente utilizzo:</span><span class="sxs-lookup"><span data-stu-id="934c2-159">This command has the following usage:</span></span>

    -   <span data-ttu-id="934c2-160">*flag* di *indirizzi* del pool</span><span class="sxs-lookup"><span data-stu-id="934c2-160">pool *address* *flags*</span></span>
    -   <span data-ttu-id="934c2-161">*flag* di *indirizzi* obj</span><span class="sxs-lookup"><span data-stu-id="934c2-161">obj *address* *flags*</span></span>
    -   <span data-ttu-id="934c2-162">flag *indirizzi*  TImpossibile creare</span><span class="sxs-lookup"><span data-stu-id="934c2-162">tqueue *address* *flags*</span></span>
    -   <span data-ttu-id="934c2-163">*Indirizzo* del cameriere</span><span class="sxs-lookup"><span data-stu-id="934c2-163">waiter *address*</span></span>
    -   <span data-ttu-id="934c2-164">*Indirizzo* di lavoro</span><span class="sxs-lookup"><span data-stu-id="934c2-164">worker *address*</span></span>

    <span data-ttu-id="934c2-165">Per il pool, il cameriere e il ruolo di lavoro, se l'indirizzo è zero, il comando eseguirà il dump di tutti gli oggetti.</span><span class="sxs-lookup"><span data-stu-id="934c2-165">For pool, waiter, and worker, if the address is zero, the command dumps all objects.</span></span> <span data-ttu-id="934c2-166">Per il cameriere e il ruolo di lavoro, omettendo l'indirizzo viene eseguito il dump del thread corrente.</span><span class="sxs-lookup"><span data-stu-id="934c2-166">For waiter and worker, omitting the address dumps the current thread.</span></span> <span data-ttu-id="934c2-167">Vengono definiti i flag seguenti: 0x1 (output su una sola riga), 0x2 (membri dump) e 0x4 (dump coda di lavoro pool).</span><span class="sxs-lookup"><span data-stu-id="934c2-167">The following flags are defined: 0x1 (single-line output), 0x2 (dump members), and 0x4 (dump pool work queue).</span></span>

## <a name="related-topics"></a><span data-ttu-id="934c2-168">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="934c2-168">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="934c2-169">API del pool di thread</span><span class="sxs-lookup"><span data-stu-id="934c2-169">Thread Pool API</span></span>](thread-pool-api.md)
</dt> <dt>

[<span data-ttu-id="934c2-170">Uso delle funzioni del pool di thread</span><span class="sxs-lookup"><span data-stu-id="934c2-170">Using the Thread Pool Functions</span></span>](using-the-thread-pool-functions.md)
</dt> </dl>

 

 
