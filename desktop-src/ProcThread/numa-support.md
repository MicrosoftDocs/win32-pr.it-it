---
description: Il modello tradizionale per il supporto multiprocessore è SMP (Symmetric MultiProcessor). In questo modello, ogni processore ha uguale accesso alla memoria e all'I/O. Con l'aggiunta di più processori, il bus del processore diventa una limitazione per le prestazioni del sistema.
ms.assetid: a1263968-2b26-45cc-bdd7-6aa354821a5a
title: Supporto NUMA
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 178f53c6b55b6ae291cd5cdcf99386515a441094
ms.sourcegitcommit: f848119a8faa29b27585f4df53f6e50ee9666684
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 05/27/2021
ms.locfileid: "110549806"
---
# <a name="numa-support"></a><span data-ttu-id="42cc4-105">Supporto NUMA</span><span class="sxs-lookup"><span data-stu-id="42cc4-105">NUMA Support</span></span>

<span data-ttu-id="42cc4-106">Il modello tradizionale per il supporto multiprocessore è SMP (Symmetric MultiProcessor).</span><span class="sxs-lookup"><span data-stu-id="42cc4-106">The traditional model for multiprocessor support is symmetric multiprocessor (SMP).</span></span> <span data-ttu-id="42cc4-107">In questo modello, ogni processore ha uguale accesso alla memoria e all'I/O.</span><span class="sxs-lookup"><span data-stu-id="42cc4-107">In this model, each processor has equal access to memory and I/O.</span></span> <span data-ttu-id="42cc4-108">Con l'aggiunta di più processori, il bus del processore diventa una limitazione per le prestazioni del sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-108">As more processors are added, the processor bus becomes a limitation for system performance.</span></span>

<span data-ttu-id="42cc4-109">I progettisti di sistema usano l'accesso alla memoria non uniforme (NUMA) per aumentare la velocità del processore senza aumentare il carico sul bus del processore.</span><span class="sxs-lookup"><span data-stu-id="42cc4-109">System designers use non-uniform memory access (NUMA) to increase processor speed without increasing the load on the processor bus.</span></span> <span data-ttu-id="42cc4-110">L'architettura non è uniforme perché ogni processore è vicino ad alcune parti della memoria e più lontano da altre parti della memoria.</span><span class="sxs-lookup"><span data-stu-id="42cc4-110">The architecture is non-uniform because each processor is close to some parts of memory and farther from other parts of memory.</span></span> <span data-ttu-id="42cc4-111">Il processore ottiene rapidamente l'accesso alla memoria a cui è vicina, mentre può richiedere più tempo per ottenere l'accesso alla memoria più lontana.</span><span class="sxs-lookup"><span data-stu-id="42cc4-111">The processor quickly gains access to the memory it is close to, while it can take longer to gain access to memory that is farther away.</span></span>

<span data-ttu-id="42cc4-112">In un sistema NUMA le CPU sono disposte in sistemi più piccoli denominati *nodi*.</span><span class="sxs-lookup"><span data-stu-id="42cc4-112">In a NUMA system, CPUs are arranged in smaller systems called *nodes*.</span></span> <span data-ttu-id="42cc4-113">Ogni nodo ha i propri processori e memoria ed è connesso al sistema più grande tramite un bus di interconnessione coerente con la cache.</span><span class="sxs-lookup"><span data-stu-id="42cc4-113">Each node has its own processors and memory, and is connected to the larger system through a cache-coherent interconnect bus.</span></span>

<span data-ttu-id="42cc4-114">Il sistema tenta di migliorare le prestazioni pianificando i thread nei processori che si trovare nello stesso nodo della memoria in uso.</span><span class="sxs-lookup"><span data-stu-id="42cc4-114">The system attempts to improve performance by scheduling threads on processors that are in the same node as the memory being used.</span></span> <span data-ttu-id="42cc4-115">Tenta di soddisfare le richieste di allocazione di memoria dall'interno del nodo, ma alloca la memoria da altri nodi, se necessario.</span><span class="sxs-lookup"><span data-stu-id="42cc4-115">It attempts to satisfy memory-allocation requests from within the node, but will allocate memory from other nodes if necessary.</span></span> <span data-ttu-id="42cc4-116">Fornisce anche un'API per rendere disponibile la topologia del sistema alle applicazioni.</span><span class="sxs-lookup"><span data-stu-id="42cc4-116">It also provides an API to make the topology of the system available to applications.</span></span> <span data-ttu-id="42cc4-117">È possibile migliorare le prestazioni delle applicazioni usando le funzioni NUMA per ottimizzare la pianificazione e l'utilizzo della memoria.</span><span class="sxs-lookup"><span data-stu-id="42cc4-117">You can improve the performance of your applications by using the NUMA functions to optimize scheduling and memory usage.</span></span>

<span data-ttu-id="42cc4-118">Prima di tutto, è necessario determinare il layout dei nodi nel sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-118">First of all, you will need to determine the layout of nodes in the system.</span></span> <span data-ttu-id="42cc4-119">Per recuperare il nodo con il numero più alto nel sistema, usare la [**funzione GetNumaHighestNodeNumber.**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)</span><span class="sxs-lookup"><span data-stu-id="42cc4-119">To retrieve the highest numbered node in the system, use the [**GetNumaHighestNodeNumber**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) function.</span></span> <span data-ttu-id="42cc4-120">Si noti che non è garantito che questo numero sia uguale al numero totale di nodi nel sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-120">Note that this number is not guaranteed to equal the total number of nodes in the system.</span></span> <span data-ttu-id="42cc4-121">Inoltre, non è garantito che i nodi con numeri sequenziali siano vicini.</span><span class="sxs-lookup"><span data-stu-id="42cc4-121">Also, nodes with sequential numbers are not guaranteed to be close together.</span></span> <span data-ttu-id="42cc4-122">Per recuperare l'elenco dei processori nel sistema, usare la [**funzione GetProcessAffinityMask.**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask)</span><span class="sxs-lookup"><span data-stu-id="42cc4-122">To retrieve the list of processors on the system, use the [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) function.</span></span> <span data-ttu-id="42cc4-123">È possibile determinare il nodo per ogni processore nell'elenco usando la [**funzione GetNumaProcessorNode.**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)</span><span class="sxs-lookup"><span data-stu-id="42cc4-123">You can determine the node for each processor in the list by using the [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) function.</span></span> <span data-ttu-id="42cc4-124">In alternativa, per recuperare un elenco di tutti i processori in un nodo, usare la [**funzione GetNumaNodeProcessorMask.**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)</span><span class="sxs-lookup"><span data-stu-id="42cc4-124">Alternatively, to retrieve a list of all processors in a node, use the [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) function.</span></span>

<span data-ttu-id="42cc4-125">Dopo aver determinato quali processori appartengono a quali nodi, è possibile ottimizzare le prestazioni dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="42cc4-125">After you have determined which processors belong to which nodes, you can optimize your application's performance.</span></span> <span data-ttu-id="42cc4-126">Per assicurarsi che tutti i thread per il processo siano eseguiti nello stesso nodo, usare la [**funzione SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) con una maschera di affinità di processo che specifica i processori nello stesso nodo.</span><span class="sxs-lookup"><span data-stu-id="42cc4-126">To ensure that all threads for your process run on the same node, use the [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) function with a process affinity mask that specifies processors in the same node.</span></span> <span data-ttu-id="42cc4-127">Ciò aumenta l'efficienza delle applicazioni i cui thread devono accedere alla stessa memoria.</span><span class="sxs-lookup"><span data-stu-id="42cc4-127">This increases the efficiency of applications whose threads need to access the same memory.</span></span> <span data-ttu-id="42cc4-128">In alternativa, per limitare il numero di thread in ogni nodo, usare la [**funzione SetThreadAffinityMask.**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask)</span><span class="sxs-lookup"><span data-stu-id="42cc4-128">Alternatively, to limit the number of threads on each node, use the [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) function.</span></span>

<span data-ttu-id="42cc4-129">Le applicazioni a elevato utilizzo di memoria dovranno ottimizzare l'utilizzo della memoria.</span><span class="sxs-lookup"><span data-stu-id="42cc4-129">Memory-intensive applications will need to optimize their memory usage.</span></span> <span data-ttu-id="42cc4-130">Per recuperare la quantità di memoria disponibile per un nodo, usare la [**funzione GetNumaAvailableMemoryNode.**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)</span><span class="sxs-lookup"><span data-stu-id="42cc4-130">To retrieve the amount of free memory available to a node, use the [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) function.</span></span> <span data-ttu-id="42cc4-131">La [**funzione VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) consente all'applicazione di specificare un nodo preferito per l'allocazione di memoria.</span><span class="sxs-lookup"><span data-stu-id="42cc4-131">The [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) function enables the application to specify a preferred node for the memory allocation.</span></span> <span data-ttu-id="42cc4-132">**VirtualAllocExNuma** non alloca pagine fisiche, pertanto avrà esito positivo indipendentemente dal fatto che le pagine siano disponibili in tale nodo o in un'altra posizione nel sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-132">**VirtualAllocExNuma** does not allocate any physical pages, so it will succeed whether or not the pages are available on that node or elsewhere in the system.</span></span> <span data-ttu-id="42cc4-133">Le pagine fisiche vengono allocate su richiesta.</span><span class="sxs-lookup"><span data-stu-id="42cc4-133">The physical pages are allocated on demand.</span></span> <span data-ttu-id="42cc4-134">Se il nodo preferito esauriva le pagine, il gestore della memoria userà le pagine di altri nodi.</span><span class="sxs-lookup"><span data-stu-id="42cc4-134">If the preferred node runs out of pages, the memory manager will use pages from other nodes.</span></span> <span data-ttu-id="42cc4-135">Se si esegue il page out della memoria, viene usato lo stesso processo quando viene riesezione.</span><span class="sxs-lookup"><span data-stu-id="42cc4-135">If the memory is paged out, the same process is used when it is brought back in.</span></span>

### <a name="numa-support-on-systems-with-more-than-64-logical-processors"></a><span data-ttu-id="42cc4-136">Supporto NUMA nei sistemi con più di 64 processori logici</span><span class="sxs-lookup"><span data-stu-id="42cc4-136">NUMA Support on Systems With More Than 64 Logical Processors</span></span>

<span data-ttu-id="42cc4-137">Nei sistemi con più di 64 processori logici, i nodi vengono assegnati ai gruppi [di processori](processor-groups.md) in base alla capacità dei nodi.</span><span class="sxs-lookup"><span data-stu-id="42cc4-137">On systems with more than 64 logical processors, nodes are assigned to [processor groups](processor-groups.md) according to the capacity of the nodes.</span></span> <span data-ttu-id="42cc4-138">La capacità di un nodo è il numero di processori presenti quando il sistema viene avviato insieme a eventuali processori logici aggiuntivi che possono essere aggiunti mentre il sistema è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="42cc4-138">The capacity of a node is the number of processors that are present when the system starts together with any additional logical processors that can be added while the system is running.</span></span>

<span data-ttu-id="42cc4-139">**Windows Server 2008, Windows Vista, Windows Server 2003 e Windows XP:** I gruppi di processori non sono supportati.</span><span class="sxs-lookup"><span data-stu-id="42cc4-139">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Processor groups are not supported.</span></span>

<span data-ttu-id="42cc4-140">Ogni nodo deve essere completamente contenuto all'interno di un gruppo.</span><span class="sxs-lookup"><span data-stu-id="42cc4-140">Each node must be fully contained within a group.</span></span> <span data-ttu-id="42cc4-141">Se le capacità dei nodi sono relativamente piccole, il sistema assegna più nodi allo stesso gruppo, scegliendo nodi fisicamente vicini tra loro per ottenere prestazioni migliori.</span><span class="sxs-lookup"><span data-stu-id="42cc4-141">If the capacities of the nodes are relatively small, the system assigns more than one node to the same group, choosing nodes that are physically close to one another for better performance.</span></span> <span data-ttu-id="42cc4-142">Se la capacità di un nodo supera il numero massimo di processori in un gruppo, il sistema suddivide il nodo in più nodi più piccoli, ognuno sufficientemente piccolo da rientrare in un gruppo.</span><span class="sxs-lookup"><span data-stu-id="42cc4-142">If a node's capacity exceeds the maximum number of processors in a group, the system splits the node into multiple smaller nodes, each small enough to fit in a group.</span></span>

<span data-ttu-id="42cc4-143">Un nodo NUMA ideale per un nuovo processo può essere richiesto usando l'attributo esteso [**PROC THREAD ATTRIBUTE PREFERRED \_ \_ \_ \_ NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) al momento della creazione del processo.</span><span class="sxs-lookup"><span data-stu-id="42cc4-143">An ideal NUMA node for a new process can be requested using the [**PROC\_THREAD\_ATTRIBUTE\_PREFERRED\_NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) extended attribute when the process is created.</span></span> <span data-ttu-id="42cc4-144">Analogamente a un processore ideale per thread, il nodo ideale è un hint all'utilità di pianificazione, che assegna il nuovo processo al gruppo che contiene il nodo richiesto, se possibile.</span><span class="sxs-lookup"><span data-stu-id="42cc4-144">Like a thread ideal processor, the ideal node is a hint to the scheduler, which assigns the new process to the group that contains the requested node if possible.</span></span>

<span data-ttu-id="42cc4-145">Le funzioni NUMA estese [**GetNumaAvailableMemoryNodeEx,**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex) [**GetNumaNodeProcessorMaskEx,**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex) [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)e [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) differiscono dalle controparti non estese in quanto il numero di nodo è un valore **USHORT** anziché **UCHAR,** per supportare il numero potenzialmente maggiore di nodi in un sistema con più di 64 processori logici.</span><span class="sxs-lookup"><span data-stu-id="42cc4-145">The extended NUMA functions [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex), and [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) differ from their unextended counterparts in that the node number is a **USHORT** value rather than a **UCHAR**, to accommodate the potentially greater number of nodes on a system with more than 64 logical processors.</span></span> <span data-ttu-id="42cc4-146">Inoltre, il processore specificato con o recuperato dalle funzioni estese include il gruppo di processori. il processore specificato con o recuperato dalle funzioni non estense è relativo al gruppo.</span><span class="sxs-lookup"><span data-stu-id="42cc4-146">Also, the processor specified with or retrieved by the extended functions includes the processor group; the processor specified with or retrieved by the unextended functions is group-relative.</span></span> <span data-ttu-id="42cc4-147">Per informazioni dettagliate, vedere gli argomenti di riferimento sulle singole funzioni.</span><span class="sxs-lookup"><span data-stu-id="42cc4-147">For details, see the individual function reference topics.</span></span>

<span data-ttu-id="42cc4-148">Un'applicazione in grado di riconoscere i gruppi può assegnare tutti i relativi thread a un nodo specifico in modo simile a quello descritto in precedenza in questo argomento, usando le funzioni NUMA estese corrispondenti.</span><span class="sxs-lookup"><span data-stu-id="42cc4-148">A group-aware application can assign all of its threads to a particular node in a similar fashion to that described earlier in this topic, using the corresponding extended NUMA functions.</span></span> <span data-ttu-id="42cc4-149">L'applicazione [**usa GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) per ottenere l'elenco di tutti i processori nel sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-149">The application uses [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) to get the list of all processors on the system.</span></span> <span data-ttu-id="42cc4-150">Si noti che l'applicazione non può impostare la maschera di affinità del processo a meno che il processo non sia assegnato a un singolo gruppo e il nodo desiderato non si trovi in tale gruppo.</span><span class="sxs-lookup"><span data-stu-id="42cc4-150">Note that the application cannot set the process affinity mask unless the process is assigned to a single group and the intended node is located in that group.</span></span> <span data-ttu-id="42cc4-151">In genere l'applicazione deve [**chiamare SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) per limitare i thread al nodo desiderato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-151">Usually the application must call [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) to limit its threads to the intended node.</span></span>


### <a name="behavior-starting-with-windows-10-build-20348"></a><span data-ttu-id="42cc4-152">Comportamento a partire Windows 10 build 20348</span><span class="sxs-lookup"><span data-stu-id="42cc4-152">Behavior starting with Windows 10 Build 20348</span></span> 

> [!NOTE]
> <span data-ttu-id="42cc4-153">A partire Windows 10 build 20348, il comportamento di questa e di altre funzioni NUMA è stato modificato per supportare meglio i sistemi con nodi contenenti più di 64 processori.</span><span class="sxs-lookup"><span data-stu-id="42cc4-153">Starting with Windows 10 Build 20348, the behavior of this and other NUMA functions has been modified to better support systems with nodes containing more that 64 processors.</span></span>

<span data-ttu-id="42cc4-154">La creazione di nodi "falsi" per supportare un mapping 1:1 tra gruppi e nodi ha comportato comportamenti confusi in cui viene segnalato un numero imprevisto di nodi NUMA e quindi, a partire da Windows 10 Build 20348, il sistema operativo è stato modificato per consentire l'associazione di più gruppi a un nodo e quindi ora è possibile segnalarne la vera topologia NUMA del sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-154">Creating "fake" nodes to accommodate a 1:1 mapping between groups and nodes has resulted in confusing behaviors where unexpected numbers of NUMA nodes are reported and so, starting with Windows 10 Build 20348, the OS has changed to allow multiple groups to be associated with a node, and so now the true NUMA topology of the system can be reported.</span></span>  

<span data-ttu-id="42cc4-155">Come parte di queste modifiche al sistema operativo, diverse API NUMA sono state modificate per supportare la segnalazione di più gruppi che ora possono essere associati a un singolo nodo NUMA.</span><span class="sxs-lookup"><span data-stu-id="42cc4-155">As part of these changes to the OS, a number of NUMA APIs have changed to support reporting the multiple groups which can now be associated with a single NUMA node.</span></span> <span data-ttu-id="42cc4-156">Le API aggiornate e nuove sono etichettate nella tabella nella sezione **API NUMA riportata** di seguito.</span><span class="sxs-lookup"><span data-stu-id="42cc4-156">Updated and new APIs are labeled in the table in the **NUMA API** section below.</span></span>

<span data-ttu-id="42cc4-157">Poiché la rimozione della suddivisione dei nodi può potenzialmente influire sulle applicazioni esistenti, è disponibile un valore del Registro di sistema per consentire il rifiuto esplicito del comportamento di suddivisione dei nodi legacy.</span><span class="sxs-lookup"><span data-stu-id="42cc4-157">Because the removal of node splitting can potentially impact existing applications, a registry value is available to allow opting back into the legacy node splitting behavior.</span></span> <span data-ttu-id="42cc4-158">La suddivisione dei nodi può  essere ri abilitata creando un valore REG_DWORD denominato "SplitLargeNodes" con il valore 1 sotto HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span><span class="sxs-lookup"><span data-stu-id="42cc4-158">Node splitting can be re-enabled by creating a **REG_DWORD** value named "SplitLargeNodes" with value 1 underneath HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span></span> <span data-ttu-id="42cc4-159">Le modifiche apportate a questa impostazione richiedono un riavvio per avere effetto.</span><span class="sxs-lookup"><span data-stu-id="42cc4-159">Changes to this setting require a reboot to take effect.</span></span>

```powershell
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\NUMA" /v SplitLargeNumaNodes /t REG_DWORD /v 1
```

> [!NOTE]
> <span data-ttu-id="42cc4-160">Le applicazioni aggiornate per l'uso della nuova funzionalità API che segnala la vera topologia NUMA continueranno a funzionare correttamente nei sistemi in cui la suddivisione di nodi di grandi dimensioni è stata ri abilitata con questa chiave del Registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-160">Applications that are updated to use the new API functionality that reports the true NUMA topology will continue to work properly on systems where large node splitting has been reenabled with this registry key.</span></span>

<span data-ttu-id="42cc4-161">L'esempio seguente illustra prima di tutto potenziali problemi con le tabelle di compilazione che esemplizzano il mapping dei processori ai nodi NUMA usando le API di affinità legacy, che non forniscono più una copertura completa di tutti i processori nel sistema. Ciò può comportare una tabella incompleta.</span><span class="sxs-lookup"><span data-stu-id="42cc4-161">The following example first demonstrates potential issues with builds tables mapping processors to NUMA nodes using the legacy affinity APIs, which no longer provide a full cover of all processors in the system this can result in an incomplete table.</span></span> <span data-ttu-id="42cc4-162">Le implicazioni di tale incompletezza dipendono dal contenuto della tabella.</span><span class="sxs-lookup"><span data-stu-id="42cc4-162">The implications of such incompleteness depend on the contents of the table.</span></span> <span data-ttu-id="42cc4-163">Se la tabella archivia semplicemente il numero di nodo corrispondente, probabilmente si tratta solo di un problema di prestazioni con i processori scoperti che vengono lasciati come parte del nodo 0.</span><span class="sxs-lookup"><span data-stu-id="42cc4-163">If the table simply stores the corresponding node number then this is likely only a performance issue with uncovered processors being left as part of node 0.</span></span> <span data-ttu-id="42cc4-164">Tuttavia, se la tabella contiene puntatori a una struttura di contesto per nodo, ciò può comportare dereferenziazione NULL in fase di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="42cc4-164">However, if the table contains pointers to a per-node context structure this can result in NULL dereferences at runtime.</span></span>

<span data-ttu-id="42cc4-165">L'esempio di codice illustra quindi due soluzioni alternative per il problema.</span><span class="sxs-lookup"><span data-stu-id="42cc4-165">Next, the code example illustrates two workarounds for the issue.</span></span> <span data-ttu-id="42cc4-166">Il primo è eseguire la migrazione alle API di affinità dei nodi a più gruppi (modalità utente e modalità kernel).</span><span class="sxs-lookup"><span data-stu-id="42cc4-166">The first is to migrate to the multi-group node affinity APIs (user-mode and kernel-mode).</span></span> <span data-ttu-id="42cc4-167">Il secondo è usare **KeQueryLogicalProcessorRelationship** per eseguire direttamente una query sul nodo NUMA associato a un determinato numero di processore.</span><span class="sxs-lookup"><span data-stu-id="42cc4-167">The second is to use **KeQueryLogicalProcessorRelationship** to directly query the NUMA node associated with a given processor number.</span></span>

```cpp

//
// Problematic implementation using KeQueryNodeActiveAffinity.
//

USHORT CurrentNode;
USHORT HighestNodeNumber;
GROUP_AFFINITY NodeAffinity;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    KeQueryNodeActiveAffinity(CurrentNode, &NodeAffinity, NULL);
    while (NodeAffinity.Mask != 0) {

        ProcessorNumber.Group = NodeAffinity.Group;
        BitScanForward(&ProcessorNumber.Number, NodeAffinity.Mask);

        ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

        ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode;]

        NodeAffinity.Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
    }
}

//
// Resolution using KeQueryNodeActiveAffinity2.
//

USHORT CurrentIndex;
USHORT CurrentNode;
USHORT CurrentNodeAffinityCount;
USHORT HighestNodeNumber;
ULONG MaximumGroupCount;
PGROUP_AFFINITY NodeAffinityMasks;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

MaximumGroupCount = KeQueryMaximumGroupCount();
NodeAffinityMasks = ExAllocatePool2(POOL_FLAG_PAGED,
                                    sizeof(GROUP_AFFINITY) * MaximumGroupCount,
                                    'tseT');

if (NodeAffinityMasks == NULL) {
    return STATUS_NO_MEMORY;
}

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    Status = KeQueryNodeActiveAffinity2(CurrentNode,
                                        NodeAffinityMasks,
                                        MaximumGroupCount,
                                        &CurrentNodeAffinityCount);
    NT_ASSERT(NT_SUCCESS(Status));

    for (CurrentIndex = 0; CurrentIndex < CurrentNodeAffinityCount; CurrentIndex += 1) {

        CurrentAffinity = &NodeAffinityMasks[CurrentIndex];

        while (CurrentAffinity->Mask != 0) {

            ProcessorNumber.Group = CurrentAffinity.Group;
            BitScanForward(&ProcessorNumber.Number, CurrentAffinity->Mask);

            ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

            ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode];

            CurrentAffinity->Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
        }
    }
}

//
// Resolution using KeQueryLogicalProcessorRelationship.
//

ULONG ProcessorCount;
ULONG ProcessorIndex;
SYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX ProcessorInformation;
ULONG ProcessorInformationSize;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

ProcessorCount = KeQueryActiveProcessorCountEx(ALL_PROCESSOR_GROUPS);

for (ProcessorIndex = 0; ProcessorIndex < ProcessorCount; ProcessorIndex += 1) {

    Status = KeGetProcessorNumberFromIndex(ProcessorIndex, &ProcessorNumber);
    NT_ASSERT(NT_SUCCESS(Status));

    ProcessorInformationSize = sizeof(ProcessorInformation);
    Status = KeQueryLogicalProcessorRelationship(&ProcessorNumber,
                                                    RelationNumaNode,
                                                    &ProcessorInformation,
                                                    &ProcesorInformationSize);
    NT_ASSERT(NT_SUCCESS(Status));

    NodeNumber = ProcessorInformation.NumaNode.NodeNumber;

    ProcessorNodeContexts[ProcessorIndex] = NodeContexts[NodeNumber];
}
```

## <a name="numa-api"></a><span data-ttu-id="42cc4-168">NUMA API</span><span class="sxs-lookup"><span data-stu-id="42cc4-168">NUMA API</span></span>

<span data-ttu-id="42cc4-169">La tabella seguente descrive l'API NUMA.</span><span class="sxs-lookup"><span data-stu-id="42cc4-169">The following table describes the NUMA API.</span></span>



| <span data-ttu-id="42cc4-170">Funzione</span><span class="sxs-lookup"><span data-stu-id="42cc4-170">Function</span></span>                                                                     | <span data-ttu-id="42cc4-171">Descrizione</span><span class="sxs-lookup"><span data-stu-id="42cc4-171">Description</span></span>                                                                                                                                                                                                                     |
|------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="42cc4-172">**AllocateUserPhysicalPagesNuma**</span><span class="sxs-lookup"><span data-stu-id="42cc4-172">**AllocateUserPhysicalPagesNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-allocateuserphysicalpagesnuma)      | <span data-ttu-id="42cc4-173">Alloca le pagine di memoria fisica da mappare e annullare il mapping all'interno di qualsiasi area AWE [(Address Windowing Extensions)](../memory/address-windowing-extensions.md) di un processo specificato e specifica il nodo NUMA per la memoria fisica.</span><span class="sxs-lookup"><span data-stu-id="42cc4-173">Allocates physical memory pages to be mapped and unmapped within any [Address Windowing Extensions](../memory/address-windowing-extensions.md) (AWE) region of a specified process and specifies the NUMA node for the physical memory.</span></span> |
| [<span data-ttu-id="42cc4-174">**CreateFileMappingNuma**</span><span class="sxs-lookup"><span data-stu-id="42cc4-174">**CreateFileMappingNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-createfilemappingnumaw)                      | <span data-ttu-id="42cc4-175">Crea o apre un oggetto mapping di file denominato o senza nome per un file specificato e specifica il nodo NUMA per la memoria fisica.</span><span class="sxs-lookup"><span data-stu-id="42cc4-175">Creates or opens a named or unnamed file mapping object for a specified file, and specifies the NUMA node for the physical memory.</span></span>                                                                                              |
| [<span data-ttu-id="42cc4-176">**GetLogicalProcessorInformation**</span><span class="sxs-lookup"><span data-stu-id="42cc4-176">**GetLogicalProcessorInformation**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformation)     | <span data-ttu-id="42cc4-177">Aggiornamento in Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-177">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-178">Recupera informazioni sui processori logici e sull'hardware correlato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-178">Retrieves information about logical processors and related hardware.</span></span>                                                                                                                                                            |
| [<span data-ttu-id="42cc4-179">**GetLogicalProcessorInformationEx**</span><span class="sxs-lookup"><span data-stu-id="42cc4-179">**GetLogicalProcessorInformationEx**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) | <span data-ttu-id="42cc4-180">Aggiornamento in Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-180">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-181">Recupera informazioni sulle relazioni dei processori logici e dell'hardware correlato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-181">Retrieves information about the relationships of logical processors and related hardware.</span></span>                                                                                                                                       |
| [<span data-ttu-id="42cc4-182">**GetNumaAvailableMemoryNode**</span><span class="sxs-lookup"><span data-stu-id="42cc4-182">**GetNumaAvailableMemoryNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)             | <span data-ttu-id="42cc4-183">Recupera la quantità di memoria disponibile nel nodo specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-183">Retrieves the amount of memory available in the specified node.</span></span>                                                                                                                                                                 |
| [<span data-ttu-id="42cc4-184">**GetNumaAvailableMemoryNodeEx**</span><span class="sxs-lookup"><span data-stu-id="42cc4-184">**GetNumaAvailableMemoryNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex)         | <span data-ttu-id="42cc4-185">Recupera la quantità di memoria disponibile in un nodo specificato come valore **USHORT.**</span><span class="sxs-lookup"><span data-stu-id="42cc4-185">Retrieves the amount of memory available in a node specified as a **USHORT** value.</span></span>                                                                                                                                             |
| [<span data-ttu-id="42cc4-186">**GetNumaHighestNodeNumber**</span><span class="sxs-lookup"><span data-stu-id="42cc4-186">**GetNumaHighestNodeNumber**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)                 | <span data-ttu-id="42cc4-187">Recupera il nodo con il numero più alto.</span><span class="sxs-lookup"><span data-stu-id="42cc4-187">Retrieves the node that currently has the highest number.</span></span>                                                                                                                                                                       |
| [<span data-ttu-id="42cc4-188">**GetNumaNodeProcessorMask**</span><span class="sxs-lookup"><span data-stu-id="42cc4-188">**GetNumaNodeProcessorMask**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)                 | <span data-ttu-id="42cc4-189">Aggiornamento in Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-189">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-190">Recupera la maschera del processore per il nodo specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-190">Retrieves the processor mask for the specified node.</span></span>                                                                                                                                                                            |
| [<span data-ttu-id="42cc4-191">**GetNumaNodeProcessorMask2**</span><span class="sxs-lookup"><span data-stu-id="42cc4-191">**GetNumaNodeProcessorMask2**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormask2)                         | <span data-ttu-id="42cc4-192">Novità di Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-192">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-193">Recupera la maschera del processore multi-gruppo del nodo specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-193">Retrieves the multi-group processor mask of the specified node.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="42cc4-194">**GetNumaNodeProcessorMaskEx**</span><span class="sxs-lookup"><span data-stu-id="42cc4-194">**GetNumaNodeProcessorMaskEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex)             | <span data-ttu-id="42cc4-195">Aggiornamento in Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-195">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-196">Recupera la maschera del processore per un nodo specificato come **valore USHORT.**</span><span class="sxs-lookup"><span data-stu-id="42cc4-196">Retrieves the processor mask for a node specified as a **USHORT** value.</span></span>                                                                                                                                                        |
| [<span data-ttu-id="42cc4-197">**GetNumaProcessorNode**</span><span class="sxs-lookup"><span data-stu-id="42cc4-197">**GetNumaProcessorNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)                         | <span data-ttu-id="42cc4-198">Recupera il numero di nodo per il processore specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-198">Retrieves the node number for the specified processor.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="42cc4-199">**GetNumaProcessorNodeEx**</span><span class="sxs-lookup"><span data-stu-id="42cc4-199">**GetNumaProcessorNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)                     | <span data-ttu-id="42cc4-200">Recupera il numero di nodo come valore **USHORT** per il processore specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-200">Retrieves the node number as a **USHORT** value for the specified processor.</span></span>                                                                                                                                                    |
| [<span data-ttu-id="42cc4-201">**GetNumaProximityNode**</span><span class="sxs-lookup"><span data-stu-id="42cc4-201">**GetNumaProximityNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaproximitynode)                         | <span data-ttu-id="42cc4-202">Recupera il numero di nodo per l'identificatore di prossimità specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-202">Retrieves the node number for the specified proximity identifier.</span></span>                                                                                                                                                               |
| [<span data-ttu-id="42cc4-203">**GetNumaProximityNodeEx**</span><span class="sxs-lookup"><span data-stu-id="42cc4-203">**GetNumaProximityNodeEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex)                     | <span data-ttu-id="42cc4-204">Recupera il numero di nodo come valore **USHORT** per l'identificatore di prossimità specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-204">Retrieves the node number as a **USHORT** value for the specified proximity identifier.</span></span>                                                                                                                                         |
| [<span data-ttu-id="42cc4-205">**GetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="42cc4-205">**GetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocessdefaultcpusetmasks)                     | <span data-ttu-id="42cc4-206">Novità di Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-206">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-207">Recupera l'elenco di set di CPU nel set predefinito del processo impostato da SetProcessDefaultCpuSetMasks o SetProcessDefaultCpuSets.</span><span class="sxs-lookup"><span data-stu-id="42cc4-207">Retrieves the list of CPU Sets in the process default set that was set by SetProcessDefaultCpuSetMasks or SetProcessDefaultCpuSets.</span></span>                                                                                                                                         |
| [<span data-ttu-id="42cc4-208">**GetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="42cc4-208">**GetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadselectedcpusetmasks)                     | <span data-ttu-id="42cc4-209">Novità di Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-209">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-210">Imposta l'assegnazione dei set di CPU selezionati per il thread specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-210">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="42cc4-211">Questa assegnazione esegue l'override dell'assegnazione predefinita del processo, se impostata.</span><span class="sxs-lookup"><span data-stu-id="42cc4-211">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="42cc4-212">**MapViewOfFileExNuma**</span><span class="sxs-lookup"><span data-stu-id="42cc4-212">**MapViewOfFileExNuma**</span></span>](/windows/win32/api/winbase/nf-winbase-mapviewoffileexnuma)                          | <span data-ttu-id="42cc4-213">Esegue il mapping di una visualizzazione di un mapping di file nello spazio degli indirizzi di un processo chiamante e specifica il nodo NUMA per la memoria fisica.</span><span class="sxs-lookup"><span data-stu-id="42cc4-213">Maps a view of a file mapping into the address space of a calling process, and specifies the NUMA node for the physical memory.</span></span>                                                                                                 |
| [<span data-ttu-id="42cc4-214">**SetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="42cc4-214">**SetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessdefaultcpusetmasks)                     | <span data-ttu-id="42cc4-215">Novità di Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-215">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-216">Imposta l'assegnazione predefinita dei set di CPU per i thread nel processo specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-216">Sets the default CPU Sets assignment for threads in the specified process.</span></span>                                                                                                                                          |
| [<span data-ttu-id="42cc4-217">**SetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="42cc4-217">**SetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadselectedcpusetmasks)                     | <span data-ttu-id="42cc4-218">Novità di Windows 10 build 20348.</span><span class="sxs-lookup"><span data-stu-id="42cc4-218">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="42cc4-219">Imposta l'assegnazione dei set di CPU selezionati per il thread specificato.</span><span class="sxs-lookup"><span data-stu-id="42cc4-219">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="42cc4-220">Questa assegnazione esegue l'override dell'assegnazione predefinita del processo, se impostata.</span><span class="sxs-lookup"><span data-stu-id="42cc4-220">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="42cc4-221">**VirtualAllocExNuma**</span><span class="sxs-lookup"><span data-stu-id="42cc4-221">**VirtualAllocExNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma)                            | <span data-ttu-id="42cc4-222">Riserva o esegue il commit di un'area di memoria all'interno dello spazio degli indirizzi virtuali del processo specificato e specifica il nodo NUMA per la memoria fisica.</span><span class="sxs-lookup"><span data-stu-id="42cc4-222">Reserves or commits a region of memory within the virtual address space of the specified process, and specifies the NUMA node for the physical memory.</span></span>                                                                          |



 

<span data-ttu-id="42cc4-223">La [**funzione QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) può essere usata per recuperare il nodo NUMA in cui viene allocata una pagina.</span><span class="sxs-lookup"><span data-stu-id="42cc4-223">The [**QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) function can be used to retrieve the NUMA node on which a page is allocated.</span></span> <span data-ttu-id="42cc4-224">Per un esempio, vedere [Allocazione di memoria da un nodo NUMA](../memory/allocating-memory-from-a-numa-node.md).</span><span class="sxs-lookup"><span data-stu-id="42cc4-224">For an example, see [Allocating Memory from a NUMA Node](../memory/allocating-memory-from-a-numa-node.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="42cc4-225">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="42cc4-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="42cc4-226">Allocazione di memoria da un nodo NUMA</span><span class="sxs-lookup"><span data-stu-id="42cc4-226">Allocating Memory from a NUMA Node</span></span>](../memory/allocating-memory-from-a-numa-node.md)
</dt> <dt>

[<span data-ttu-id="42cc4-227">Processori multipli</span><span class="sxs-lookup"><span data-stu-id="42cc4-227">Multiple Processors</span></span>](multiple-processors.md)
</dt> <dt>

[<span data-ttu-id="42cc4-228">Gruppi di processori</span><span class="sxs-lookup"><span data-stu-id="42cc4-228">Processor Groups</span></span>](processor-groups.md)
</dt> </dl>

 

 
