---
description: Processo operativo COM+ CRM
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: Processo operativo COM+ CRM
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d39dba3dedcbdefebe0f62144547ebb6985fa51f
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "103878281"
---
# <a name="com-crm-operating-process"></a><span data-ttu-id="1f22b-103">Processo operativo COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="1f22b-103">COM+ CRM Operating Process</span></span>

<span data-ttu-id="1f22b-104">In un'operazione normale, un componente dell'applicazione in esecuzione in un processo di applicazione server utilizzerebbe un CRM COM+ creando un ruolo di lavoro CRM.</span><span class="sxs-lookup"><span data-stu-id="1f22b-104">In normal operation, an application component running in a server application process would use a COM+ CRM by creating a CRM worker.</span></span> <span data-ttu-id="1f22b-105">Il ruolo di lavoro CRM implementa un'interfaccia COM specifica dell'attività progettata per l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-105">The CRM worker implements a COM interface specific to the task it is designed to perform.</span></span> <span data-ttu-id="1f22b-106">Il componente dell'applicazione deve essere in esecuzione in una transazione, in modo che il processo di lavoro CRM erediti la transazione del componente dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-106">The application component must be running under a transaction so that the CRM worker inherits the transaction of the application component.</span></span> <span data-ttu-id="1f22b-107">I thread di lavoro CRM richiedono sempre una transazione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-107">CRM workers always require a transaction.</span></span>

<span data-ttu-id="1f22b-108">Per accedere a COM+ CRM, il ruolo di lavoro CRM ottiene innanzitutto l'interfaccia [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) , che consente al ruolo di lavoro CRM di scrivere record nel log durevole.</span><span class="sxs-lookup"><span data-stu-id="1f22b-108">To access the COM+ CRM, the CRM worker first obtains the [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface, which allows the CRM worker to write records to the durable log.</span></span> <span data-ttu-id="1f22b-109">Il ruolo di lavoro CRM ottiene questa interfaccia creando un componente Clerk CRM.</span><span class="sxs-lookup"><span data-stu-id="1f22b-109">The CRM worker obtains this interface by creating a CRM clerk component.</span></span>

<span data-ttu-id="1f22b-110">Il ruolo di lavoro CRM deve quindi indicare al Clerk CRM il nome del compensatore CRM che vuole usare.</span><span class="sxs-lookup"><span data-stu-id="1f22b-110">Next the CRM worker must tell the CRM clerk the name of the CRM Compensator it wants to use.</span></span> <span data-ttu-id="1f22b-111">Questa operazione viene eseguita chiamando il metodo [**ICrmLogControl:: RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) .</span><span class="sxs-lookup"><span data-stu-id="1f22b-111">It does this by calling the [**ICrmLogControl::RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) method.</span></span> <span data-ttu-id="1f22b-112">Dopo la chiamata a questo metodo, il compensatore CRM viene creato dall'infrastruttura CRM quando la transazione viene completata.</span><span class="sxs-lookup"><span data-stu-id="1f22b-112">After this method is called, the CRM Compensator is created by the CRM infrastructure when the transaction completes.</span></span>

<span data-ttu-id="1f22b-113">Dopo aver registrato il compensatore CRM, il ruolo di lavoro CRM può scrivere record nel log CRM usando [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="1f22b-113">After the CRM worker has registered its CRM Compensator, it can write records to the CRM log using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="1f22b-114">Il ruolo di lavoro CRM deve *scrivere in anticipo*; ovvero, deve scrivere un record nel log che descrive un'azione prima di eseguire effettivamente l'azione, nel caso in cui si verifichi un arresto anomalo immediatamente dopo aver completato l'azione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-114">The CRM worker must *write ahead*; that is, it must write a record to the log describing an action before it actually performs the action, in case a crash occurs immediately after completing the action.</span></span> <span data-ttu-id="1f22b-115">Senza questi record di log write-ahead, non esiste alcun modo per correggere l'azione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-115">Without these write-ahead log records, there is no way to correct for the action.</span></span>

<span data-ttu-id="1f22b-116">Inoltre, write-ahead significa che il compensatore CRM, che è il componente che riceve i record del log al recupero, deve gestire il caso in cui sono stati scritti i record del log, ma l'azione non è stata effettivamente eseguita.</span><span class="sxs-lookup"><span data-stu-id="1f22b-116">Also, write ahead means that the CRM Compensator, which is the component that receives the log records on recovery, must deal with the case where the log records were written but the action did not in fact occur.</span></span> <span data-ttu-id="1f22b-117">Le azioni eseguite dal compensatore CRM devono essere *idempotente*; ovvero, devono essere in grado di essere eseguite più di una volta, ma dovrebbero dare lo stesso risultato.</span><span class="sxs-lookup"><span data-stu-id="1f22b-117">Actions by the CRM Compensator must be *idempotent*; that is, they should be capable of being performed more than once but should lead to the same outcome.</span></span> <span data-ttu-id="1f22b-118">Ad esempio, l'impostazione di un saldo del conto sul valore $100 è un'azione idempotente. non è possibile aggiungere $100 al saldo del conto.</span><span class="sxs-lookup"><span data-stu-id="1f22b-118">For example, setting an account balance to the value of $100 is an idempotent action; adding $100 to the account balance is not.</span></span>

<span data-ttu-id="1f22b-119">L'interfaccia [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) fornisce i due metodi seguenti per la scrittura dei record di log:</span><span class="sxs-lookup"><span data-stu-id="1f22b-119">The [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface provides the following two methods for writing log records:</span></span>

-   <span data-ttu-id="1f22b-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) viene utilizzata per la scrittura di un record di log strutturato compilato come una raccolta di varianti.</span><span class="sxs-lookup"><span data-stu-id="1f22b-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) is used for writing a structured log record that is built up as a collection of Variants.</span></span> <span data-ttu-id="1f22b-121">Viene utilizzato principalmente per lo sviluppo di dispongono in Microsoft Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="1f22b-121">It is primarily for use when developing CRMs in Microsoft Visual Basic.</span></span>
-   <span data-ttu-id="1f22b-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) viene utilizzato per la scrittura di un record di log non strutturato come BLOB di byte.</span><span class="sxs-lookup"><span data-stu-id="1f22b-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) is used for writing an unstructured log record as BLOBs of bytes.</span></span> <span data-ttu-id="1f22b-123">Viene utilizzato principalmente per lo sviluppo di dispongono in Microsoft Visual C++.</span><span class="sxs-lookup"><span data-stu-id="1f22b-123">It is primarily for use when developing CRMs in Microsoft Visual C++.</span></span> <span data-ttu-id="1f22b-124">Poiché le strutture di record in C sono spesso costituite da un set di intestazioni e campi che possono essere dispersi in memoria, il metodo **WriteLogRecord** implementa una funzionalità di raccolta che riduce la copia dei dati.</span><span class="sxs-lookup"><span data-stu-id="1f22b-124">Because record structures in C are often made up of a set of headers and fields that may be scattered in memory, the **WriteLogRecord** method implements a gather capability that reduces the copying of data.</span></span>

> [!Note]  
> <span data-ttu-id="1f22b-125">I tipi di puntatore utente non devono essere presenti all'interno di strutture di dati in un record di log.</span><span class="sxs-lookup"><span data-stu-id="1f22b-125">You should not user pointer types within data structures in a log record.</span></span> <span data-ttu-id="1f22b-126">I puntatori non sono più validi durante la fase di recupero perché il compensatore CRM viene eseguito in un processo diverso rispetto a quello del ruolo di lavoro CRM che ha scritto il record di log.</span><span class="sxs-lookup"><span data-stu-id="1f22b-126">Pointers are no longer valid during recovery phase because the CRM Compensator runs in a different process than that of the CRM worker that wrote the log record.</span></span> <span data-ttu-id="1f22b-127">L'inclusione di tipi di puntatore in un record di log potrebbe causare l'arresto anomalo o il danneggiamento di un'applicazione durante il ripristino</span><span class="sxs-lookup"><span data-stu-id="1f22b-127">Including pointer types in a log record might cause an application to crash or corrupt itself during recovery.</span></span>

 

<span data-ttu-id="1f22b-128">Entrambi questi metodi di scrittura scrivono un record di log su disco, ma non garantiscono la durabilità del record.</span><span class="sxs-lookup"><span data-stu-id="1f22b-128">Both of these write methods write a log record to disk but do not guarantee the record's durability.</span></span> <span data-ttu-id="1f22b-129">Sebbene le scritture lazy si accumulino prima di forzare il disco in modo da poter migliorare le prestazioni, è possibile usare il metodo [**ICrmLogControl:: ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) per garantire che tutte le scritture eseguite dal CRM siano durevoli sul disco, operazione importante per il ripristino degli errori.</span><span class="sxs-lookup"><span data-stu-id="1f22b-129">While allowing lazy writes to accumulate before forcing to disk can improve performance, you can use the [**ICrmLogControl::ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) method instead to guarantee that all writes done by the CRM are durable on disk, which is important for failure recovery.</span></span>

<span data-ttu-id="1f22b-130">Quando il ruolo di lavoro CRM viene eseguito con le azioni e ha terminato di scrivere e forzare i record nel log, deve rilasciare [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="1f22b-130">When the CRM worker is done with its actions and has finished writing and forcing records to the log, it must release [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="1f22b-131">Quando la transazione viene completata (in genere a causa del componente dell'applicazione che chiama [**Tocomplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) o [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), l'infrastruttura CRM crea il componente compensatore CRM, che implementa l'interfaccia [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) o l'interfaccia [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) .</span><span class="sxs-lookup"><span data-stu-id="1f22b-131">When the transaction completes (typically due to the application component calling [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) or [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), the CRM infrastructure creates the CRM Compensator component, which implements either the [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) interface or the [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) interface.</span></span> <span data-ttu-id="1f22b-132">Queste interfacce vengono usate per passare i record non strutturati (Visual C++) o strutturati (Visual Basic) al compensatore CRM insieme alle notifiche relative al risultato della transazione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-132">These interfaces are used to pass the unstructured (Visual C++) or structured (Visual Basic) records to the CRM Compensator along with the transaction outcome notifications.</span></span>

<span data-ttu-id="1f22b-133">Il compensatore CRM riceve prima una notifica della fase di preparazione del completamento della transazione e può votare la richiesta di preparazione, sì o no.</span><span class="sxs-lookup"><span data-stu-id="1f22b-133">The CRM Compensator is first notified of the prepare phase of the transaction completion and can vote either yes or no to the prepare request.</span></span> <span data-ttu-id="1f22b-134">Se il compensatore CRM ha votato, non riceve altre notifiche di interruzione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-134">If the CRM Compensator votes no, it does not receive any further abort notifications.</span></span> <span data-ttu-id="1f22b-135">Se vota sì alla richiesta di preparazione, riceve le notifiche di commit o di interruzione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-135">If it votes yes to the prepare request, it receives either the commit or abort notifications.</span></span> <span data-ttu-id="1f22b-136">In caso di interruzione di un client, non vengono ricevute notifiche di preparazione, ma solo le notifiche di interruzione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-136">In the case of a client abort, no prepare notifications are received, only abort notifications.</span></span> <span data-ttu-id="1f22b-137">Il compensatore CRM deve essere pronto a gestire tutti questi casi e deve anche gestire il caso in cui nessun record di log è stato scritto correttamente dal ruolo di lavoro CRM.</span><span class="sxs-lookup"><span data-stu-id="1f22b-137">The CRM Compensator must be prepared to handle all these cases, and it also must handle the case where no log records were successfully written by the CRM worker.</span></span> <span data-ttu-id="1f22b-138">Il compensatore CRM non deve presupporre che la stessa istanza del compensatore CRM riceva le notifiche fase 1 (preparazione) e fase 2 (commit o Interrompi), in quanto potrebbero essere interrotte dal ripristino.</span><span class="sxs-lookup"><span data-stu-id="1f22b-138">The CRM Compensator must not assume that the same CRM Compensator instance will receive both the phase 1 (prepare) and the phase 2 (commit or abort) notifications, as these could be interrupted by recovery.</span></span>

<span data-ttu-id="1f22b-139">In genere, un compensatore CRM usa la notifica di interruzione per invertire l'azione eseguita dal ruolo di lavoro CRM.</span><span class="sxs-lookup"><span data-stu-id="1f22b-139">Typically, a CRM Compensator uses the abort notification to reverse the action that was performed by the CRM worker.</span></span> <span data-ttu-id="1f22b-140">Il ruolo di lavoro CRM potrebbe lasciare uno stato disponibile se è necessario invertire l'azione.</span><span class="sxs-lookup"><span data-stu-id="1f22b-140">The CRM worker might leave some state available in case it needs to reverse its action.</span></span> <span data-ttu-id="1f22b-141">Tale stato potrebbe essere completamente contenuto nei record di log. in caso contrario, il compensatore CRM deve pulire tale stato se la transazione viene sottoposto a commit.</span><span class="sxs-lookup"><span data-stu-id="1f22b-141">That state might be fully contained in the log records, and if not, the CRM Compensator needs to clean up that state if the transaction commits.</span></span> <span data-ttu-id="1f22b-142">Questo è il motivo per cui il compensatore CRM riceve la notifica di commit.</span><span class="sxs-lookup"><span data-stu-id="1f22b-142">This is the reason why the CRM Compensator receives the commit notification.</span></span> <span data-ttu-id="1f22b-143">Il compensatore CRM non viene eseguito in una transazione DTC.</span><span class="sxs-lookup"><span data-stu-id="1f22b-143">The CRM Compensator does not run under a DTC transaction.</span></span>

<span data-ttu-id="1f22b-144">Il compensatore CRM può registrare nuovi record se necessario usando [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), che riceve come viene creato.</span><span class="sxs-lookup"><span data-stu-id="1f22b-144">The CRM Compensator can log new records if required by using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), which it receives as it is created.</span></span> <span data-ttu-id="1f22b-145">Il ruolo di lavoro CRM e il compensatore CRM possono anche dimenticare l'ultimo record di log scritto, che potrebbe essere necessario per evitare il ripristino non necessario.</span><span class="sxs-lookup"><span data-stu-id="1f22b-145">Both the CRM worker and CRM Compensator can also forget the last log record they wrote, which might be required to avoid unnecessary recovery.</span></span>

## <a name="related-topics"></a><span data-ttu-id="1f22b-146">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="1f22b-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="1f22b-147">Concetti Gestione risorse di compensazione COM+</span><span class="sxs-lookup"><span data-stu-id="1f22b-147">COM+ Compensating Resource Manager Concepts</span></span>](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[<span data-ttu-id="1f22b-148">Avvio e ripristino di COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="1f22b-148">COM+ CRM Startup and Recovery</span></span>](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



