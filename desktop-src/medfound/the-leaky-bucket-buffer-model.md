---
description: Il \# modello di &0034; bucket&\# 0034; è un modo per modellare i requisiti di buffering per la riproduzione uniforme.
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: Modello di buffer di bucket a perdita (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/05/2021
ms.locfileid: "106320897"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a><span data-ttu-id="b454f-103">Modello di buffer di bucket a perdita (Microsoft Media Foundation)</span><span class="sxs-lookup"><span data-stu-id="b454f-103">The Leaky Bucket Buffer Model (Microsoft Media Foundation)</span></span>

<span data-ttu-id="b454f-104">Quando si esegue lo streaming di file multimediali in una rete, il decodificatore riceve i dati codificati a una velocità teoricamente costante (la velocità di trasmissione).</span><span class="sxs-lookup"><span data-stu-id="b454f-104">When you stream media over a network, the decoder receives encoded data at a theoretically constant rate (the transmission rate).</span></span> <span data-ttu-id="b454f-105">Il decodificatore utilizza questi dati per produrre output decodificato.</span><span class="sxs-lookup"><span data-stu-id="b454f-105">The decoder consumes this data to produce decoded output.</span></span> <span data-ttu-id="b454f-106">Nel caso generale, tuttavia, il decodificatore utilizza i dati a una frequenza *variabile* , perché il codificatore può utilizzare una frequenza di codifica variabile.</span><span class="sxs-lookup"><span data-stu-id="b454f-106">In the general case, however, the decoder consumes the data at a *variable* rate, because then encoder can use a variable encoding rate.</span></span>

<span data-ttu-id="b454f-107">Il modello "leaky bucket" è un modo per modellare i requisiti di buffering per la riproduzione senza problemi.</span><span class="sxs-lookup"><span data-stu-id="b454f-107">The "leaky bucket" model is a way to model the buffering requirements for smooth playback.</span></span> <span data-ttu-id="b454f-108">In questo modello, il decodificatore gestisce un buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-108">In this model, the decoder maintains a buffer.</span></span> <span data-ttu-id="b454f-109">I dati codificati passano dalla rete al buffer e dal buffer al decodificatore.</span><span class="sxs-lookup"><span data-stu-id="b454f-109">Encoded data goes from the network into the buffer, and from the buffer into the decoder.</span></span> <span data-ttu-id="b454f-110">Se il buffer viene sottoposto a propagazione, significa che il decodificatore sta rimuovendo i dati dal buffer più velocemente rispetto alla distribuzione della rete.</span><span class="sxs-lookup"><span data-stu-id="b454f-110">If the buffer underflows, it means the decoder is removing data from the buffer faster than the network is delivering it.</span></span> <span data-ttu-id="b454f-111">Se si verifica un overflow del buffer, significa che la rete sta distribuendo i dati più velocemente rispetto a quanto utilizzato dal decodificatore.</span><span class="sxs-lookup"><span data-stu-id="b454f-111">If the buffer overflows, it means the network is delivering data faster than the decoder consumes it.</span></span>

<span data-ttu-id="b454f-112">Questo argomento descrive il modello "leaky bucket" dei buffer per la codifica e la decodifica.</span><span class="sxs-lookup"><span data-stu-id="b454f-112">This topic describes the "leaky bucket" model of buffers for encoding and decoding.</span></span>

-   [<span data-ttu-id="b454f-113">Bucket a perdita</span><span class="sxs-lookup"><span data-stu-id="b454f-113">The Leaky Bucket</span></span>](#the-leaky-bucket)
-   [<span data-ttu-id="b454f-114">Il bucket in uso</span><span class="sxs-lookup"><span data-stu-id="b454f-114">The Bucket in Use</span></span>](#the-bucket-in-use)
-   [<span data-ttu-id="b454f-115">Impostazione dei valori bucket a perdita per i flussi ASF</span><span class="sxs-lookup"><span data-stu-id="b454f-115">Setting Leaky Bucket Values for ASF Streams</span></span>](#setting-leaky-bucket-values-for-asf-streams)
-   [<span data-ttu-id="b454f-116">Valori di bucket persi nel multiplexer ASF</span><span class="sxs-lookup"><span data-stu-id="b454f-116">Leaky Bucket Values in the ASF Multiplexer</span></span>](#leaky-bucket-values-in-the-asf-multiplexer)
-   [<span data-ttu-id="b454f-117">Aggiornamento dei valori di bucket a perdita nel sink multimediale ASF</span><span class="sxs-lookup"><span data-stu-id="b454f-117">Updating Leaky Bucket Values in the ASF Media Sink</span></span>](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [<span data-ttu-id="b454f-118">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="b454f-118">Related topics</span></span>](#related-topics)

## <a name="the-leaky-bucket"></a><span data-ttu-id="b454f-119">Bucket a perdita</span><span class="sxs-lookup"><span data-stu-id="b454f-119">The Leaky Bucket</span></span>

<span data-ttu-id="b454f-120">Per comprendere il modello di bucket a perdita, prendere in considerazione un bucket con un piccolo foro in basso.</span><span class="sxs-lookup"><span data-stu-id="b454f-120">To understand the leaky bucket model, consider a bucket with a small hole at the bottom.</span></span> <span data-ttu-id="b454f-121">Tre parametri definiscono il bucket:</span><span class="sxs-lookup"><span data-stu-id="b454f-121">Three parameters define the bucket:</span></span>

-   <span data-ttu-id="b454f-122">Capacità (B)</span><span class="sxs-lookup"><span data-stu-id="b454f-122">The capacity (B)</span></span>
-   <span data-ttu-id="b454f-123">Frequenza con cui l'acqua fuoriesce dal bucket (R)</span><span class="sxs-lookup"><span data-stu-id="b454f-123">The rate at which water flows out of the bucket (R)</span></span>
-   <span data-ttu-id="b454f-124">Completezza iniziale del bucket (F)</span><span class="sxs-lookup"><span data-stu-id="b454f-124">The initial fullness of the bucket (F)</span></span>

<span data-ttu-id="b454f-125">In questa metafora il bucket è il buffer:</span><span class="sxs-lookup"><span data-stu-id="b454f-125">In this metaphor, the bucket is the buffer:</span></span>

![illustrazione che mostra un buffer come bucket, frequenza di input come acqua che entra nel bucket e frequenza di output come acqua che lascia un foro nel bucket](images/asf-components03.png)

<span data-ttu-id="b454f-127">Se l'acqua viene versata nel bucket alla velocità esatta *R*, il bucket rimarrà in corrispondenza di F, perché la velocità di input è uguale alla frequenza di output.</span><span class="sxs-lookup"><span data-stu-id="b454f-127">If water is poured into the bucket at exactly rate *R*, the bucket will remain at F, because the input rate equals the output rate.</span></span> <span data-ttu-id="b454f-128">Se la frequenza di input aumenta mentre *R* rimane costante, il bucket accumula acqua.</span><span class="sxs-lookup"><span data-stu-id="b454f-128">If the input rate increases while *R* remains constant, the bucket accumulates water.</span></span> <span data-ttu-id="b454f-129">Se la frequenza di input è maggiore di *R* per un periodo di tempo prolungato, si verifica un overflow del bucket.</span><span class="sxs-lookup"><span data-stu-id="b454f-129">If the input rate is larger than *R* for a sustained period, eventually the bucket overflows.</span></span> <span data-ttu-id="b454f-130">Tuttavia, la frequenza di input può variare in base a *R* senza overflow del bucket, purché la velocità media di input non superi la capacità del bucket.</span><span class="sxs-lookup"><span data-stu-id="b454f-130">However, the input rate can vary around *R* without overflowing the bucket, as long as the average input rate does not exceed the capacity of the bucket.</span></span> <span data-ttu-id="b454f-131">Maggiore è la capacità, maggiore sarà la frequenza di input che può variare in un determinato intervallo di tempo.</span><span class="sxs-lookup"><span data-stu-id="b454f-131">The larger the capacity, the more the input rate can vary within a given window of time.</span></span>

<span data-ttu-id="b454f-132">In ASF, il bucket di perdita è definito da tre parametri:</span><span class="sxs-lookup"><span data-stu-id="b454f-132">In ASF, the leaky bucket is defined by three parameters:</span></span>

-   <span data-ttu-id="b454f-133">Velocità in bit media, in byte al secondo, che corrisponde alla frequenza di output (*R*)</span><span class="sxs-lookup"><span data-stu-id="b454f-133">The average bit rate, in bytes per second, which corresponds to the output rate (*R*)</span></span>
-   <span data-ttu-id="b454f-134">La finestra del buffer, misurata in millisecondi, che corrisponde alla capacità del bucket (*B*).</span><span class="sxs-lookup"><span data-stu-id="b454f-134">The buffer window, measured in milliseconds, which corresponds to the bucket capacity (*B*).</span></span>
-   <span data-ttu-id="b454f-135">Completezza del buffer iniziale, che in genere è impostata su zero.</span><span class="sxs-lookup"><span data-stu-id="b454f-135">The initial buffer fullness, which is generally set to zero.</span></span>

<span data-ttu-id="b454f-136">La velocità in bit misura il numero medio di bit al secondo nel flusso codificato.</span><span class="sxs-lookup"><span data-stu-id="b454f-136">The bit rate measures the average number of bits per second in the encoded stream.</span></span> <span data-ttu-id="b454f-137">La finestra buffer misura il numero di millisecondi di dati alla velocità in bit che possono essere inseriti nel buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-137">The buffer window measures the number of milliseconds of data at that bit rate that can fit in the buffer.</span></span> <span data-ttu-id="b454f-138">La dimensione del buffer in bit è uguale a R \* (B/1000).</span><span class="sxs-lookup"><span data-stu-id="b454f-138">The size of the buffer in bits is equal to R \* (B / 1000).</span></span>

<span data-ttu-id="b454f-139">I dati del payload ASF possono entrare nel bucket di perdita a intervalli irregolari e in importi irregolari, ma devono lasciare il bucket a una velocità in bit costante positiva.</span><span class="sxs-lookup"><span data-stu-id="b454f-139">ASF payload data may enter the leaky bucket at irregular times and in irregular amounts, but must leave the bucket at a constant positive bit rate.</span></span> <span data-ttu-id="b454f-140">A causa della finestra del buffer, esiste un possibile ritardo tra il momento in cui il payload entra nel bucket e quando viene lasciato.</span><span class="sxs-lookup"><span data-stu-id="b454f-140">Because of the buffer window, there is a possible delay between the time that payload enters the bucket and when it leaves.</span></span> <span data-ttu-id="b454f-141">Il ritardo massimo che può verificarsi è *B* / *R*.</span><span class="sxs-lookup"><span data-stu-id="b454f-141">The maximum delay that can occur is *B*/*R*.</span></span> <span data-ttu-id="b454f-142">I dati di payload che entrano nel bucket sono in base all'ora di presentazione e non devono mai eseguire l'overflow del bucket.</span><span class="sxs-lookup"><span data-stu-id="b454f-142">The payload data that enters into the bucket is according to the presentation time and must never overflow the bucket.</span></span> <span data-ttu-id="b454f-143">Oltre al tempo di presentazione, a ogni payload è associato anche un tempo di invio, ovvero l'ora in cui i dati del payload lasciano il bucket in base alla velocità in bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-143">In addition to the presentation time, each payload also has a send time—the time at which the payload data leaves the bucket according to the bit rate.</span></span> <span data-ttu-id="b454f-144">Il tempo di invio deve essere precedente all'ora di presentazione per assicurarsi che, quando il bucket si avvicina a essere pieno, ogni payload lascia il bucket prima o dopo l'ora di presentazione.</span><span class="sxs-lookup"><span data-stu-id="b454f-144">Send time must be earlier than the presentation time to ensure that, when the leaky bucket gets close to being full, every payload leaves the bucket before or at its presentation time.</span></span> <span data-ttu-id="b454f-145">A tale scopo, i tempi di presentazione vengono spostati in avanti dal valore *B* / *R* (il *preroll*) e i tempi di invio iniziano a partire da zero.</span><span class="sxs-lookup"><span data-stu-id="b454f-145">To accomplish this, the presentation times are shifted ahead by the *B*/*R* value (the *preroll*), and the send times get a head start starting at zero.</span></span> <span data-ttu-id="b454f-146">L'ora di invio deve essere successiva all'ora di presentazione perché indica che il payload è stato immesso troppo tardi e non può essere incluso nell'oggetto dati.</span><span class="sxs-lookup"><span data-stu-id="b454f-146">The send time must be no later than the presentation time because that would indicate that the payload entered the bucket too late and cannot be included in the data object.</span></span> <span data-ttu-id="b454f-147">Il valore di preroll è incluso nell' [oggetto intestazione ASF](asf-file-structure.md) .</span><span class="sxs-lookup"><span data-stu-id="b454f-147">The preroll value is included in the [ASF Header Object](asf-file-structure.md) .</span></span>

<span data-ttu-id="b454f-148">Per lo streaming senza glitch in rete, i flussi compressi all'interno del contenuto multimediale devono mantenere una velocità in bit costante per tutta la durata della riproduzione.</span><span class="sxs-lookup"><span data-stu-id="b454f-148">For glitch-free streaming over the network, compressed streams within the media content must maintain a constant bit rate throughout the playback duration.</span></span> <span data-ttu-id="b454f-149">Il modello di bucket a perdita di ASF garantisce che i dati multimediali vengano inviati attraverso la rete a una velocità in bit costante.</span><span class="sxs-lookup"><span data-stu-id="b454f-149">The ASF leaky bucket model ensures that media data is sent across the network at a constant bit rate.</span></span> <span data-ttu-id="b454f-150">I parametri del bucket perso sono specificati nell'oggetto proprietà del flusso esteso dell' [oggetto intestazione ASF](asf-file-structure.md).</span><span class="sxs-lookup"><span data-stu-id="b454f-150">The parameters of the leaky bucket are specified in the Extended Stream Properties Object of the [ASF Header Object](asf-file-structure.md).</span></span> <span data-ttu-id="b454f-151">In Microsoft Media Foundation vengono impostati come attributi sul tipo di supporto che rappresenta il flusso.</span><span class="sxs-lookup"><span data-stu-id="b454f-151">In Microsoft Media Foundation, they are set as attributes on the media type that represents the stream.</span></span>

<span data-ttu-id="b454f-152">I valori dei bucket persi vengono definiti sia nel sink di file ASF che nell'oggetto del multiplexer ASF sottostante e in Windows Media Encoder.</span><span class="sxs-lookup"><span data-stu-id="b454f-152">The leaky bucket values are defined both in the ASF file sink and the underlying ASF multiplexer object, and the Windows Media encoder.</span></span> <span data-ttu-id="b454f-153">Questi valori possono essere uguali o diversi.</span><span class="sxs-lookup"><span data-stu-id="b454f-153">These values could be same or different.</span></span> <span data-ttu-id="b454f-154">Si consideri ad esempio uno scenario di streaming, che richiede che gli esempi audio vengano recapitati in un secondo momento rispetto agli esempi video, in modo che il file possa essere trasmesso senza latenza.</span><span class="sxs-lookup"><span data-stu-id="b454f-154">For example, consider a streaming scenario, which requires the audio samples to be delivered later than the video samples so that the file can be streamed without latency.</span></span> <span data-ttu-id="b454f-155">A tale scopo, il bucket della perdita del flusso audio nel sink multimediale può essere impostato su un valore superiore al valore impostato nel codificatore audio Windows Media.</span><span class="sxs-lookup"><span data-stu-id="b454f-155">To achieve this, the audio stream's leaky bucket in the media sink can be set to a value higher than the value set in the Windows Media audio encoder.</span></span>

<span data-ttu-id="b454f-156">Per impostare i valori B/R nel codificatore, l'applicazione deve impostare le proprietà [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ Rmax**](mfpkey-rmaxproperty.md)e [**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) .</span><span class="sxs-lookup"><span data-stu-id="b454f-156">To set B/R values in the encoder, the application must set the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties.</span></span> <span data-ttu-id="b454f-157">Per informazioni sull'impostazione delle proprietà nel codificatore, vedere [proprietà di codifica](configuring-the-encoder.md).</span><span class="sxs-lookup"><span data-stu-id="b454f-157">For information about setting properties in the encoder, see [Encoding Properties](configuring-the-encoder.md).</span></span>

## <a name="the-bucket-in-use"></a><span data-ttu-id="b454f-158">Il bucket in uso</span><span class="sxs-lookup"><span data-stu-id="b454f-158">The Bucket in Use</span></span>

<span data-ttu-id="b454f-159">L'obiettivo di un codificatore è garantire che il contenuto non superi mai l'overflow del buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-159">The goal of an encoder is to ensure that the content never overflows the buffer.</span></span> <span data-ttu-id="b454f-160">Il codificatore usa i valori della velocità in bit e della finestra del buffer come guide.</span><span class="sxs-lookup"><span data-stu-id="b454f-160">The encoder uses the bit rate and buffer window values as guides.</span></span> <span data-ttu-id="b454f-161">Il numero effettivo di bit passati in un periodo di tempo uguale alla finestra del buffer non può mai essere maggiore del doppio delle dimensioni del buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-161">The actual number of bits passed over any period of time equal to the buffer window can never be greater than twice the size of the buffer.</span></span>

<span data-ttu-id="b454f-162">Si consideri l'esempio seguente: si ha un bucket da 3 litri con un foro al minuto, che può fluire al minuto di 1 gallone.</span><span class="sxs-lookup"><span data-stu-id="b454f-162">Consider the following example: You have a 3-gallon bucket with a hole in it through which 1 gallon can flow per minute.</span></span> <span data-ttu-id="b454f-163">Si posiziona il bucket sotto un perno e si apre la valvola per lasciare l'acqua a una velocità di 1 gallone al minuto.</span><span class="sxs-lookup"><span data-stu-id="b454f-163">You put the bucket under a spigot and open the valve to let out water at a rate of 1 gallon per minute.</span></span> <span data-ttu-id="b454f-164">L'acqua scorre fuori dal bucket con la stessa rapidità con cui entra, senza uscire dal bucket.</span><span class="sxs-lookup"><span data-stu-id="b454f-164">The water flows out of the bucket as quickly as it enters, leaving no extra in the bucket.</span></span> <span data-ttu-id="b454f-165">Si aumenta quindi il flusso dal perno a 2 litri al minuto.</span><span class="sxs-lookup"><span data-stu-id="b454f-165">Then you increase the flow from the spigot to 2 gallons per minute.</span></span> <span data-ttu-id="b454f-166">Ogni minuto che l'acqua scorre a questa velocità, 2 litri entrano nel bucket e 1 gallone fuoriesce, lasciando 1 gallone nel bucket.</span><span class="sxs-lookup"><span data-stu-id="b454f-166">Each minute that the water flows at this rate, 2 gallons go into the bucket and 1 gallon leaks out, leaving 1 gallon in the bucket.</span></span> <span data-ttu-id="b454f-167">Alla fine di 3 minuti, 6 litri di acqua sono entrati nel bucket, 3 litri di perdite e il bucket è pieno.</span><span class="sxs-lookup"><span data-stu-id="b454f-167">At the end of 3 minutes, 6 gallons of water have gone into the bucket, 3 gallons have leaked out, and the bucket is full.</span></span>

<span data-ttu-id="b454f-168">In pratica, la velocità teorica massima dei dati su un intervallo uguale alla finestra del buffer non viene mai realizzata.</span><span class="sxs-lookup"><span data-stu-id="b454f-168">In practice, the theoretical maximum data rate over an interval equal to the buffer window is never achieved.</span></span> <span data-ttu-id="b454f-169">Nell'esempio precedente si presuppone una velocità dati costante.</span><span class="sxs-lookup"><span data-stu-id="b454f-169">The previous example assumed a constant data rate.</span></span> <span data-ttu-id="b454f-170">Dato lo stesso bucket da 3 litri, è possibile aumentare la velocità di flusso dal perno a 6 galloni al minuto per un minuto e quindi spegnere il rubinetto per due minuti.</span><span class="sxs-lookup"><span data-stu-id="b454f-170">Given the same 3-gallon bucket, you could increase the flow rate from the spigot to 6 gallons per minute for one minute and then turn the spigot off for two minutes.</span></span> <span data-ttu-id="b454f-171">Anche se la quantità totale di acqua inserita nel bucket rientra nel massimo teorico per la finestra del buffer, la concentrazione di tale quantità in una parte della finestra causa l'overflow del bucket.</span><span class="sxs-lookup"><span data-stu-id="b454f-171">Even though the total amount of water put into the bucket is within the theoretical maximum for the buffer window, the concentration of that amount into one part of the window causes the bucket to overflow.</span></span> <span data-ttu-id="b454f-172">A 6 litri al minuto, i bucket da 3 litri si propagano poco dopo 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="b454f-172">At 6 gallons per minute, the 3-gallon bucket overflows shortly after 30 seconds pass.</span></span> <span data-ttu-id="b454f-173">Pertanto, la quantità effettiva massima di dati che è possibile recapitare al buffer per la durata di un intervallo uguale all'impostazione della finestra del buffer dipende dalle dimensioni dei singoli campioni e dal momento in cui vengono recapitati.</span><span class="sxs-lookup"><span data-stu-id="b454f-173">Therefore, the actual maximum amount of data that can be delivered to the buffer over the duration of any interval equal to the buffer window setting depends upon the size of individual samples and when they are delivered.</span></span>

<span data-ttu-id="b454f-174">Fino a questo punto, gli esempi hanno solo illustrato il buffer usato dal decodificatore, ma il codificatore crea il contenuto compresso anche per un buffer di bucket a perdita.</span><span class="sxs-lookup"><span data-stu-id="b454f-174">So far the examples have only discussed the buffer used by the decoder, but a leaky bucket buffer is also used by the encoder which creates the compressed content.</span></span> <span data-ttu-id="b454f-175">Il codificatore apporta tutte le modifiche necessarie agli algoritmi di compressione per tenere la velocità in bit degli esempi compressi entro i limiti descritti dalla velocità in bit e dalla finestra del buffer, supponendo che gli esempi vengano recapitati al decodificatore a una velocità costante.</span><span class="sxs-lookup"><span data-stu-id="b454f-175">The encoder makes whatever adjustments are necessary to the compression algorithms to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window, assuming that the samples will be delivered to the decoder at a constant rate.</span></span> <span data-ttu-id="b454f-176">È possibile considerare il bucket del codificatore come il mirroring del bucket del decodificatore.</span><span class="sxs-lookup"><span data-stu-id="b454f-176">You can think of the encoder bucket as mirroring the decoder bucket.</span></span> <span data-ttu-id="b454f-177">Il bucket del codificatore viene riempito a una frequenza variabile determinata dalla dimensione dei singoli campioni e dalle perdite a una velocità costante uguale alla velocità in bit media.</span><span class="sxs-lookup"><span data-stu-id="b454f-177">The encoder bucket is filled at a variable rate determined by the size of the individual samples and leaks at a constant rate equal to the average bit rate.</span></span>

<span data-ttu-id="b454f-178">Si consideri l'esempio seguente di un codificatore e un decodificatore connesso in rete.</span><span class="sxs-lookup"><span data-stu-id="b454f-178">Consider the following example of an encoder and decoder connected together over a network.</span></span> <span data-ttu-id="b454f-179">È possibile codificare un file video a 30 fotogrammi al secondo con una velocità in bit di 6.000 bit al secondo e una finestra del buffer di 3 secondi, ovvero una dimensione del buffer totale di 18.000 bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-179">You encode a video file at 30 frames per second with a bit rate of 6,000 bits per second and a buffer window of 3 seconds (a total buffer size of 18,000 bits).</span></span> <span data-ttu-id="b454f-180">Il primo campione viene codificato come fotogramma chiave e richiede 7.000 bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-180">The first sample is encoded as a key frame and takes up 7,000 bits.</span></span> <span data-ttu-id="b454f-181">Il buffer del codificatore ora contiene 7.000 bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-181">The encoder buffer now contains 7,000 bits.</span></span> <span data-ttu-id="b454f-182">I 29 frame successivi sono tutti i frame Delta che rientrano in totale 3.000 bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-182">The next 29 frames are all delta frames that total 3,000 bits.</span></span> <span data-ttu-id="b454f-183">Quindi, il primo secondo di contenuto (30 fotogrammi) inserirebbe la completezza del buffer a 10.000 bit se non si sono verificate perdite di dati. Sappiamo che la velocità in bit del flusso è di 6.000 bit al secondo, quindi, dopo che il primo secondo del contenuto codificato viene inserito nel buffer del codificatore, la completezza scende a 4.000 bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-183">So the first second of content (30 frames) would put the buffer fullness at 10,000 bits if nothing were leaking out. We know that the bit rate of the stream is 6,000 bits per second, so after the first second of encoded content is put in the encoder buffer, the fullness drops to 4,000 bits.</span></span> <span data-ttu-id="b454f-184">Nell'applicazione di decodifica questo flusso viene recapitato al buffer del decodificatore a 6.000 bit al secondo.</span><span class="sxs-lookup"><span data-stu-id="b454f-184">In the decoding application, this stream is delivered to the decoder buffer at 6,000 bits per second.</span></span> <span data-ttu-id="b454f-185">Dopo un secondo, il buffer contiene 6.000 bit.</span><span class="sxs-lookup"><span data-stu-id="b454f-185">After one second, the buffer contains 6,000 bits.</span></span> <span data-ttu-id="b454f-186">Il primo esempio contiene 7.000 bit, quindi il buffer del decodificatore deve essere riempito di più prima che il decodificatore inizi a rimuovere gli esempi.</span><span class="sxs-lookup"><span data-stu-id="b454f-186">The first sample contains 7,000 bits, so the decoder buffer must be filled more before the decoder begins removing samples.</span></span>

## <a name="setting-leaky-bucket-values-for-asf-streams"></a><span data-ttu-id="b454f-187">Impostazione dei valori bucket a perdita per i flussi ASF</span><span class="sxs-lookup"><span data-stu-id="b454f-187">Setting Leaky Bucket Values for ASF Streams</span></span>

<span data-ttu-id="b454f-188">In uno scenario di codifica dei file, un'applicazione può impostare i valori dei bucket persi durante la configurazione dei flussi nel [profilo ASF](asf-profile.md).</span><span class="sxs-lookup"><span data-stu-id="b454f-188">In a file-encoding scenario, an application can set the leaky bucket values while configuring the streams in the [ASF Profile](asf-profile.md).</span></span>

<span data-ttu-id="b454f-189">Dopo aver creato il flusso e avere un riferimento all'interfaccia [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) del flusso, è possibile impostare i valori usando gli attributi seguenti:</span><span class="sxs-lookup"><span data-stu-id="b454f-189">After you have created the stream and have a reference to the stream's [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) interface, you can set the values by using the following attributes:</span></span>

-   <span data-ttu-id="b454f-190">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (valori di bucket a perdita media)</span><span class="sxs-lookup"><span data-stu-id="b454f-190">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (average leaky bucket values)</span></span>
-   <span data-ttu-id="b454f-191">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (max Leaky Bucket Values)</span><span class="sxs-lookup"><span data-stu-id="b454f-191">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (maximum leaky bucket values)</span></span>

<span data-ttu-id="b454f-192">Per informazioni sull'aggiunta di flussi e sull'acquisizione del puntatore **IMFASFStreamConfig** , vedere [aggiunta di informazioni sul flusso al sink di file ASF](adding-stream-information-to-the-asf-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="b454f-192">For information about adding streams and getting the **IMFASFStreamConfig** pointer, see [Adding Stream Information to the ASF File Sink](adding-stream-information-to-the-asf-file-sink.md).</span></span>

<span data-ttu-id="b454f-193">Questi valori contengono il set di Informazioni seguente:</span><span class="sxs-lookup"><span data-stu-id="b454f-193">These values contain the following set of information:</span></span>

-   <span data-ttu-id="b454f-194">Velocità in bit media: ottenere la velocità in bit media dal tipo di supporto di output selezionato durante la negoziazione del tipo di supporto.</span><span class="sxs-lookup"><span data-stu-id="b454f-194">Average bit rate: Get the average bit rate from the output media type that is selected during media type negotiation.</span></span> <span data-ttu-id="b454f-195">Usare l'attributo [**MF \_ mt \_ audio \_ Avg \_ bytes \_ al \_ secondo**](mf-mt-audio-avg-bytes-per-second-attribute.md) (per i flussi audio) o l'attributo [**MF \_ mt \_ Avg \_ bitrate**](mf-mt-avg-bitrate-attribute.md) (per i flussi video).</span><span class="sxs-lookup"><span data-stu-id="b454f-195">Use the [**MF\_MT\_AUDIO\_AVG\_BYTES\_PER\_SECOND**](mf-mt-audio-avg-bytes-per-second-attribute.md) attribute (for audio streams) or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute (for video streams).</span></span>
-   <span data-ttu-id="b454f-196">Finestra buffer: se si dispone di un'istanza del codificatore e i tipi di supporti di output negoziati, è possibile aggiornare questo valore in un secondo momento eseguendo una query sul codificatore per l'interfaccia [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) e quindi chiamando [**IWMCodecLeakyBucket:: GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces. h, wmcodecdspuuid. lib).</span><span class="sxs-lookup"><span data-stu-id="b454f-196">Buffer window: If you have an instance of the encoder and have negotiated output media types, you can update this value later by querying the encoder for the [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) interface and then calling [**IWMCodecLeakyBucket::GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces.h, wmcodecdspuuid.lib).</span></span> <span data-ttu-id="b454f-197">In caso contrario, usare il valore predefinito di 3000 millisecondi.</span><span class="sxs-lookup"><span data-stu-id="b454f-197">Otherwise, Use the default value of 3000 milliseconds.</span></span>
-   <span data-ttu-id="b454f-198">Dimensioni iniziali del buffer: impostare su 0.</span><span class="sxs-lookup"><span data-stu-id="b454f-198">Initial buffer size: Set to 0.</span></span>

<span data-ttu-id="b454f-199">I valori forniti dall'applicazione dipendono dal tipo di codifica e dal tipo di supporto del flusso.</span><span class="sxs-lookup"><span data-stu-id="b454f-199">The values provided by the application depend on the type of encoding and the media type of the stream.</span></span> <span data-ttu-id="b454f-200">La codifica della [velocità in bit costante](constant-bit-rate-encoding.md) , ad esempio, richiede una frequenza a bit fissa predeterminata e una finestra del buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-200">For example, [Constant Bit Rate Encoding](constant-bit-rate-encoding.md) requires a predetermined fixed bit rate and a buffer window.</span></span> <span data-ttu-id="b454f-201">L'applicazione può specificare questi valori di bucket persione impostando la proprietà di codifica [**\_ VIDEOWINDOW di MFPKEY**](mfpkey-videowindowproperty.md) e l'attributo [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) nel flusso.</span><span class="sxs-lookup"><span data-stu-id="b454f-201">The application can specify these leaky bucket values by setting the [**MFPKEY\_VIDEOWINDOW**](mfpkey-videowindowproperty.md) encoding property and the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) attribute on the stream.</span></span> <span data-ttu-id="b454f-202">I valori della finestra del buffer specificati vengono utilizzati per verificare che il file codificato disponga dei tempi di invio corretti contrassegnati nei pacchetti di dati e che il valore di preroll venga visualizzato nell'oggetto intestazione ASF.</span><span class="sxs-lookup"><span data-stu-id="b454f-202">The specified buffer window values are used to make sure that the encoded file has the correct send times marked on the data packets and the preroll value appears in the ASF Header Object.</span></span> <span data-ttu-id="b454f-203">È sufficiente impostare **MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1** perché questi valori specificati vengono copiati nell'attributo [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) .</span><span class="sxs-lookup"><span data-stu-id="b454f-203">It is sufficient to set **MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1** because these specified values are copied into the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) attribute.</span></span>

<span data-ttu-id="b454f-204">Per le modalità di codifica a 2 passaggi è necessario impostare entrambi gli attributi per specificare i valori medi e massimi.</span><span class="sxs-lookup"><span data-stu-id="b454f-204">For 2-pass encoding modes you need to set both of these attributes to specify the average and maximum values.</span></span>

<span data-ttu-id="b454f-205">Per la codifica VBR, l'applicazione può eseguire una query per i valori dei bucket persi utilizzati dal codificatore solo dopo il completamento del passaggio di codifica.</span><span class="sxs-lookup"><span data-stu-id="b454f-205">For VBR encoding, the application can query for the leaky bucket values used by the encoder only after the encoding pass is complete.</span></span> <span data-ttu-id="b454f-206">Pertanto, durante la configurazione del sink multimediale, l'applicazione può scegliere di non impostare gli attributi o le proprietà correlate ai bucket persi.</span><span class="sxs-lookup"><span data-stu-id="b454f-206">Therefore, while configuring the media sink, the application can choose not to set the attributes or properties related to leaky buckets.</span></span> <span data-ttu-id="b454f-207">Dopo la codifica, l'applicazione deve eseguire una query sul codificatore per le proprietà [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ Rmax**](mfpkey-rmaxproperty.md)e [**MFPKEY \_**](mfpkey-bmaxproperty.md) BMAX e impostarle nel sink del supporto in modo che i valori accurati vengano riflessi nell'oggetto intestazione.</span><span class="sxs-lookup"><span data-stu-id="b454f-207">After encoding, the application must query the encoder for the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties and set them in the media sink so that the accurate values are reflected in the Header Object.</span></span> <span data-ttu-id="b454f-208">Per un esempio di codice su come aggiornare i valori per la codifica VBR, vedere l'argomento relativo all'aggiornamento delle proprietà di codifica nel sink di file in [esercitazione: codifica Windows Media da 1 pass](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="b454f-208">For code example about how to update the values for VBR encoding, see "Update Encoding Properties in the File Sink" in [Tutorial: 1-Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="b454f-209">Se si copia contenuto Windows Media dall'origine al sink multimediale senza codifica, è necessario impostare i valori bucket persi nel sink di supporto.</span><span class="sxs-lookup"><span data-stu-id="b454f-209">If you are copying Windows Media content from source to media sink without encoding, the leaky bucket values must be set in the media sink.</span></span>

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a><span data-ttu-id="b454f-210">Valori di bucket persi nel multiplexer ASF</span><span class="sxs-lookup"><span data-stu-id="b454f-210">Leaky Bucket Values in the ASF Multiplexer</span></span>

<span data-ttu-id="b454f-211">In Media Foundation, i valori dei bucket persi vengono usati dal [multiplexer ASF](asf-multiplexer.md) per configurare i valori di bucket interni che usa per generare i pacchetti di dati.</span><span class="sxs-lookup"><span data-stu-id="b454f-211">In Media Foundation, the leaky bucket values are used by the [ASF Multiplexer](asf-multiplexer.md) to set up the internal leaky bucket values that it uses to generate data packets.</span></span> <span data-ttu-id="b454f-212">Il payload è contenuto all'interno di un esempio multimediale e una serie di esempi di supporti costituisce un pacchetto di dati ASF.</span><span class="sxs-lookup"><span data-stu-id="b454f-212">The payload is contained within a media sample and a series of media samples constitutes an ASF data packet.</span></span> <span data-ttu-id="b454f-213">In base ai valori dei bucket a perdita e all'ora di presentazione, il multiplexer assegna un tempo di invio per ogni esempio di supporto in modo che la velocità in bit dei pacchetti inviati attraverso la rete sia a una velocità in bit costante (*R*).</span><span class="sxs-lookup"><span data-stu-id="b454f-213">Based on the leaky bucket values and the presentation time, the multiplexer assigns a send time for each media sample so that the bit rates of the packets being sent across the network is at a constant bit rate (*R*).</span></span>

<span data-ttu-id="b454f-214">Un'applicazione non è in grado di impostare direttamente i valori dei bucket persi nel multiplexer.</span><span class="sxs-lookup"><span data-stu-id="b454f-214">An application cannot set leaky bucket values in the multiplexer directly.</span></span> <span data-ttu-id="b454f-215">I valori devono essere specificati sul sink multimediale ASF, che consente di impostare i valori appropriati nel multiplexer.</span><span class="sxs-lookup"><span data-stu-id="b454f-215">The values must be provided on the ASF media sink, which sets the appropriate values on the multiplexer.</span></span> <span data-ttu-id="b454f-216">I valori impostati in [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) e [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) vengono usati dal multiplexer per convalidare gli esempi inviati al sink di supporto ASF vengono generati usando i valori specificati.</span><span class="sxs-lookup"><span data-stu-id="b454f-216">The values set in [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) and [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) are used by the multiplexer to validate the samples sent to the ASF media sink are generated by using the specified values.</span></span>

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a><span data-ttu-id="b454f-217">Aggiornamento dei valori di bucket a perdita nel sink multimediale ASF</span><span class="sxs-lookup"><span data-stu-id="b454f-217">Updating Leaky Bucket Values in the ASF Media Sink</span></span>

<span data-ttu-id="b454f-218">Un'applicazione può sovrascrivere i valori dei bucket a livello di flusso (impostati nel profilo ASF durante la creazione del flusso) impostando la proprietà [**\_ \_ \_ LEAKYBUCKET ASFSTREAMSINK con correzione MFPKEY**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) nell'archivio delle proprietà del sink multimediale.</span><span class="sxs-lookup"><span data-stu-id="b454f-218">An application can overwrite the stream-level leaky bucket values (set in the ASF profile during stream creation) by setting the [**MFPKEY\_ASFSTREAMSINK\_CORRECTED\_LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) property in the media sink's property store.</span></span> <span data-ttu-id="b454f-219">Per ottenere un riferimento all'archivio delle proprietà, usare l'oggetto ContentInfo implementato dal sink multimediale.</span><span class="sxs-lookup"><span data-stu-id="b454f-219">To get a reference to the property store, use the ContentInfo object implemented by the media sink.</span></span> <span data-ttu-id="b454f-220">Per ulteriori informazioni, vedere [impostazione delle proprietà nel sink di file](setting-properties-in-the-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="b454f-220">For more information, see [Setting Properties in the File Sink](setting-properties-in-the-file-sink.md).</span></span>

<span data-ttu-id="b454f-221">**Nota**  Questa operazione è consentita solo per i flussi audio.</span><span class="sxs-lookup"><span data-stu-id="b454f-221">**Note**  This operation is only allowed for audio streams.</span></span>

<span data-ttu-id="b454f-222">Questa proprietà deve essere impostata dopo aver impostato il tipo di output nel codificatore.</span><span class="sxs-lookup"><span data-stu-id="b454f-222">This property must be set after you have set the output type on the encoder.</span></span> <span data-ttu-id="b454f-223">In base alla velocità in bit impostata nel tipo di supporto, il codificatore calcola le dimensioni del buffer per assicurarsi che gli esempi di supporti generati non superino mai il buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-223">Based on the bit rate set in the media type, the encoder calculates the buffer size to ensure that the generated media samples never overflow the buffer.</span></span> <span data-ttu-id="b454f-224">Il codificatore apporta le modifiche necessarie durante la compressione per limitare la velocità in bit degli esempi compressi entro i limiti descritti dalla velocità in bit e dalla finestra del buffer.</span><span class="sxs-lookup"><span data-stu-id="b454f-224">The encoder makes necessary adjustments during compression to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window.</span></span>

<span data-ttu-id="b454f-225">Analogamente agli attributi di configurazione del flusso per i bucket con perdite, impostare la velocità in bit media e la dimensione del buffer e la completezza del buffer iniziale in una matrice di valori DWORD.</span><span class="sxs-lookup"><span data-stu-id="b454f-225">Similar to the stream configuration attributes for leaky buckets, set the average bit rate and the buffer size, and the initial buffer fullness in an array of DWORDs.</span></span> <span data-ttu-id="b454f-226">Per ulteriori informazioni, vedere la sezione "impostazione dei valori bucket per i flussi ASF" in questo argomento.</span><span class="sxs-lookup"><span data-stu-id="b454f-226">For more information, see "Setting Leaky Bucket Values for ASF Streams" section in this topic.</span></span>

## <a name="related-topics"></a><span data-ttu-id="b454f-227">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="b454f-227">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b454f-228">Supporto ASF in Media Foundation</span><span class="sxs-lookup"><span data-stu-id="b454f-228">ASF Support in Media Foundation</span></span>](asf-support-in-media-foundation.md)
</dt> <dt>

[<span data-ttu-id="b454f-229">Codec Windows Media</span><span class="sxs-lookup"><span data-stu-id="b454f-229">Windows Media Codecs</span></span>](windows-media-codecs.md)
</dt> </dl>

 

 
