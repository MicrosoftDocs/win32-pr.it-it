---
description: Descrive il contenuto video&\# 8211; funzionalità di protezione che possono essere fornite da un driver di grafica.
ms.assetid: FD0625BB-484A-43E6-8931-DB635D4F017F
title: GPU-Based protezione del contenuto
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6bbc1a0f88cae199b9aab38e5ec429ea5427f44b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104559601"
---
# <a name="gpu-based-content-protection"></a><span data-ttu-id="d3b77-103">GPU-Based protezione del contenuto</span><span class="sxs-lookup"><span data-stu-id="d3b77-103">GPU-Based Content Protection</span></span>

<span data-ttu-id="d3b77-104">Questo argomento descrive il contenuto video, ovvero le funzionalità di protezione che possono essere fornite da un driver di grafica.</span><span class="sxs-lookup"><span data-stu-id="d3b77-104">This topic describes video content–protection capabilities that a graphics driver can provide.</span></span>

-   [<span data-ttu-id="d3b77-105">Introduzione</span><span class="sxs-lookup"><span data-stu-id="d3b77-105">Introduction</span></span>](#introduction)
-   [<span data-ttu-id="d3b77-106">Panoramica del processo di decodifica</span><span class="sxs-lookup"><span data-stu-id="d3b77-106">Overview of the Decoding Process</span></span>](#overview-of-the-decoding-process)
-   [<span data-ttu-id="d3b77-107">Crittografia dei buffer video compressi per il decodificatore</span><span class="sxs-lookup"><span data-stu-id="d3b77-107">Encrypting Compressed Video Buffers for the Decoder</span></span>](#encrypting-compressed-video-buffers-for-the-decoder)
    -   [<span data-ttu-id="d3b77-108">1. eseguire una query sulle funzionalità di protezione del contenuto del driver</span><span class="sxs-lookup"><span data-stu-id="d3b77-108">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
    -   [<span data-ttu-id="d3b77-109">2. configurare il canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-109">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
    -   [<span data-ttu-id="d3b77-110">3. configurare la sessione di crittografia</span><span class="sxs-lookup"><span data-stu-id="d3b77-110">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
    -   [<span data-ttu-id="d3b77-111">4. ottenere un handle per il dispositivo di decodificatore DXVA</span><span class="sxs-lookup"><span data-stu-id="d3b77-111">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
    -   [<span data-ttu-id="d3b77-112">5. associare il decodificatore DXVA alla sessione di crittografia</span><span class="sxs-lookup"><span data-stu-id="d3b77-112">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)
-   [<span data-ttu-id="d3b77-113">Invio di comandi del canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-113">Sending Authenticated Channel Commands</span></span>](#sending-authenticated-channel-commands)
-   [<span data-ttu-id="d3b77-114">Invio di query sul canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-114">Sending Authenticated Channel Queries</span></span>](#sending-authenticated-channel-queries)
-   [<span data-ttu-id="d3b77-115">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="d3b77-115">Related topics</span></span>](#related-topics)

## <a name="introduction"></a><span data-ttu-id="d3b77-116">Introduzione</span><span class="sxs-lookup"><span data-stu-id="d3b77-116">Introduction</span></span>

<span data-ttu-id="d3b77-117">Il diagramma seguente mostra una visualizzazione semplificata del modo in cui il contenuto video protetto passa attraverso la pipeline per il rendering.</span><span class="sxs-lookup"><span data-stu-id="d3b77-117">The following diagram shows a simplified view of how protected video content travels through the pipeline to be rendered.</span></span>

![diagramma che mostra il contenuto video protetto.](images/d3d9video01.png)

> [!Note]  
> <span data-ttu-id="d3b77-119">Il [percorso multimediale protetto](protected-media-path.md) (PMP) non è illustrato in questo diagramma.</span><span class="sxs-lookup"><span data-stu-id="d3b77-119">The [Protected Media Path](protected-media-path.md) (PMP) is not depicted in this diagram.</span></span> <span data-ttu-id="d3b77-120">Il flusso di dati visualizzato qui potrebbe verificarsi in un processo PMP o all'interno di un processo dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-120">The data flow that is shown here might occur within a PMP process, or within an application process.</span></span>

 

<span data-ttu-id="d3b77-121">Il decodificatore riceve dati video crittografati e compressi da un'origine esterna.</span><span class="sxs-lookup"><span data-stu-id="d3b77-121">The decoder receives encrypted, compressed video data from an external source.</span></span> <span data-ttu-id="d3b77-122">Si presuppone inoltre che il decodificatore riceva anche una chiave crittografica per decrittografare i dati.</span><span class="sxs-lookup"><span data-stu-id="d3b77-122">It is assumed also the decoder also receives a cryptographic key to decrypt this data.</span></span> <span data-ttu-id="d3b77-123">Questo argomento non descrive lo scambio di chiave tra l'origine video e il decodificatore, ma il PMP definisce un possibile meccanismo.</span><span class="sxs-lookup"><span data-stu-id="d3b77-123">This topic does not describe the key exchange between the video source and decoder, but the PMP defines one possible mechanism.</span></span> <span data-ttu-id="d3b77-124">La GPU non è in questa fase.</span><span class="sxs-lookup"><span data-stu-id="d3b77-124">The GPU is not involved at this stage.</span></span>

<span data-ttu-id="d3b77-125">Per la decodifica con accelerazione hardware, il decodificatore software passa il contenuto video compresso alla GPU.</span><span class="sxs-lookup"><span data-stu-id="d3b77-125">For hardware-accelerated decoding, the software decoder passes compressed video content to the GPU.</span></span> <span data-ttu-id="d3b77-126">Per proteggere questo contenuto, il decodificatore esegue nuovamente la crittografia dei dati, in genere usando AES-CTR, prima di passarli all'acceleratore hardware.</span><span class="sxs-lookup"><span data-stu-id="d3b77-126">To protect this content, the decoder re-encrypts the data, typically using AES-CTR, before passing it to the hardware accelerator.</span></span> <span data-ttu-id="d3b77-127">Viene definito un meccanismo di scambio delle chiavi tra il decodificatore e il driver di grafica.</span><span class="sxs-lookup"><span data-stu-id="d3b77-127">A key-exchange mechanism is defined between the decoder and the graphics driver.</span></span>

<span data-ttu-id="d3b77-128">I fotogrammi video decodificati vengono archiviati nella memoria video, generalmente in chiaro.</span><span class="sxs-lookup"><span data-stu-id="d3b77-128">Decoded video frames are stored in video memory, generally in the clear.</span></span> <span data-ttu-id="d3b77-129">A questo punto, i frame vengono elaborati e quindi presentati.</span><span class="sxs-lookup"><span data-stu-id="d3b77-129">At this point, the frames are processed and then presented.</span></span> <span data-ttu-id="d3b77-130">Sono disponibili due opzioni principali per la presentazione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-130">There are two main options for presentation.</span></span>

-   <span data-ttu-id="d3b77-131">I frame possono essere presentati usando una sovrapposizione hardware.</span><span class="sxs-lookup"><span data-stu-id="d3b77-131">Frames can be presented using a hardware overlay.</span></span> <span data-ttu-id="d3b77-132">Per ulteriori informazioni, vedere [supporto della sovrimpressione hardware](hardware-overlay-support.md).</span><span class="sxs-lookup"><span data-stu-id="d3b77-132">For more information, see [Hardware Overlay Support](hardware-overlay-support.md).</span></span>
-   <span data-ttu-id="d3b77-133">I frame possono essere presentati dalla finestra desktop Manage (DWM) utilizzando una superficie condivisa.</span><span class="sxs-lookup"><span data-stu-id="d3b77-133">Frames can be presented by the Desktop Window Manage (DWM) using a shared surface.</span></span>

<span data-ttu-id="d3b77-134">L'ultimo passaggio consiste nel visualizzare il frame sul monitor, che può richiedere la protezione dei collegamenti tra la scheda grafica e il dispositivo di visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-134">The last step is to display the frame on the monitor, which may require link protection between the graphics card and the display device.</span></span> <span data-ttu-id="d3b77-135">Un esempio di protezione dei collegamenti è High-Bandwidth protezione del contenuto digitale (HDCP).</span><span class="sxs-lookup"><span data-stu-id="d3b77-135">An example of link protection is High-Bandwidth Digital Content Protection (HDCP).</span></span> <span data-ttu-id="d3b77-136">La protezione del collegamento viene configurata tramite [Output Protection Manager](output-protection-manager.md) (OPM).</span><span class="sxs-lookup"><span data-stu-id="d3b77-136">Link protection is configured using [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="d3b77-137">Questo argomento non descrive l'OPM; Per ulteriori informazioni, vedere [utilizzo di output Protection Manager](using-output-protection-manager.md).</span><span class="sxs-lookup"><span data-stu-id="d3b77-137">This topic does not describe OPM; for more information, see [Using Output Protection Manager](using-output-protection-manager.md).</span></span>

## <a name="overview-of-the-decoding-process"></a><span data-ttu-id="d3b77-138">Panoramica del processo di decodifica</span><span class="sxs-lookup"><span data-stu-id="d3b77-138">Overview of the Decoding Process</span></span>

<span data-ttu-id="d3b77-139">Durante la decodifica con accelerazione hardware, il decodificatore software deve passare dati video compressi alla scheda grafica.</span><span class="sxs-lookup"><span data-stu-id="d3b77-139">During hardware-accelerated decoding, the software decoder must pass compressed video data to the graphics card.</span></span> <span data-ttu-id="d3b77-140">Per il contenuto premium, questi dati in genere devono essere crittografati, usando la crittografia a chiave simmetrica, prima che vengano inviati alla GPU.</span><span class="sxs-lookup"><span data-stu-id="d3b77-140">For premium content, this data typically must be encrypted, using symmetric-key encryption, before it is sent to the GPU.</span></span>

<span data-ttu-id="d3b77-141">Per crittografare il video per la decodifica, il decodificatore software usa le interfacce seguenti:</span><span class="sxs-lookup"><span data-stu-id="d3b77-141">To encrypt the video for decoding, the software decoder uses the following interfaces:</span></span>

-   <span data-ttu-id="d3b77-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="d3b77-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span></span> <span data-ttu-id="d3b77-143">Rappresenta il dispositivo decodificatore DXVA, detto anche acceleratore.</span><span class="sxs-lookup"><span data-stu-id="d3b77-143">Represents the DXVA decoder device, also called the accelerator.</span></span>
-   <span data-ttu-id="d3b77-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span><span class="sxs-lookup"><span data-stu-id="d3b77-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span></span> <span data-ttu-id="d3b77-145">Rappresenta una sessione di crittografia che fornisce la chiave di crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-145">Represents a cryptographic session, which provides the encryption key.</span></span>
-   <span data-ttu-id="d3b77-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span><span class="sxs-lookup"><span data-stu-id="d3b77-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span></span> <span data-ttu-id="d3b77-147">Rappresenta un canale autenticato, che consente al decodificatore software di associare la sessione di crittografia al decodificatore DXVA.</span><span class="sxs-lookup"><span data-stu-id="d3b77-147">Represents an authenticated channel, which enables the software decoder to associate the cryptographic session with the DXVA decoder.</span></span>

![diagramma che mostra le interfacce di decodifica Direct3D9.](images/d3d9video02.png)

<span data-ttu-id="d3b77-149">Tutte queste interfacce vengono ottenute dal dispositivo Direct3D, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="d3b77-149">All of these interfaces are obtained from the Direct3D device, as follows:</span></span>



| <span data-ttu-id="d3b77-150">Interfaccia</span><span class="sxs-lookup"><span data-stu-id="d3b77-150">Interface</span></span>                                                                | <span data-ttu-id="d3b77-151">Creazione</span><span class="sxs-lookup"><span data-stu-id="d3b77-151">Creation</span></span>                                                                                                                                                                      |
|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="d3b77-152">**IDirectXVideoDecoder**</span><span class="sxs-lookup"><span data-stu-id="d3b77-152">**IDirectXVideoDecoder**</span></span>](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder)                     | <span data-ttu-id="d3b77-153">Chiamare [**IDirectXVideoDecoderService:: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="d3b77-153">Call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="d3b77-154">Il dispositivo decodificatore DXVA è identificato da un GUID del profilo DXVA.</span><span class="sxs-lookup"><span data-stu-id="d3b77-154">The DXVA decoder device is identified by a DXVA profile GUID.</span></span> |
| [<span data-ttu-id="d3b77-155">**IDirect3DCryptoSession9**</span><span class="sxs-lookup"><span data-stu-id="d3b77-155">**IDirect3DCryptoSession9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9)               | <span data-ttu-id="d3b77-156">Chiamare [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span><span class="sxs-lookup"><span data-stu-id="d3b77-156">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span></span>                                                                         |
| [<span data-ttu-id="d3b77-157">**IDirect3DAuthenticatedChannel9**</span><span class="sxs-lookup"><span data-stu-id="d3b77-157">**IDirect3DAuthenticatedChannel9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) | <span data-ttu-id="d3b77-158">Chiamare [**IDirect3DDevice9Video:: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="d3b77-158">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span></span>                                                           |



 

> [!Note]  
> <span data-ttu-id="d3b77-159">Per ottenere un puntatore all'interfaccia [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) , chiamare [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) su un dispositivo D3D9Ex.</span><span class="sxs-lookup"><span data-stu-id="d3b77-159">To get a pointer to the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface, call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on a D3D9Ex device.</span></span>

 

<span data-ttu-id="d3b77-160">Il canale autenticato fornisce un canale di comunicazione attendibile tra il decodificatore software e il driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-160">The authenticated channel provides a trusted communication channel between the software decoder and the driver.</span></span> <span data-ttu-id="d3b77-161">Il canale di comunicazione funziona nel modo seguente:</span><span class="sxs-lookup"><span data-stu-id="d3b77-161">The communication channel works as follows:</span></span>

-   <span data-ttu-id="d3b77-162">Il driver fornisce una catena di certificati X. 509 il cui certificato radice è firmato da Microsoft.</span><span class="sxs-lookup"><span data-stu-id="d3b77-162">The driver provides an X.509 certificate chain whose root certificate is signed by Microsoft.</span></span>
-   <span data-ttu-id="d3b77-163">Il certificato contiene una chiave pubblica RSA per il driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-163">The certificate contains an RSA public key for the driver.</span></span>
-   <span data-ttu-id="d3b77-164">Il decodificatore software usa la chiave pubblica per inviare al driver una chiave di sessione AES a 128 bit.</span><span class="sxs-lookup"><span data-stu-id="d3b77-164">The software decoder uses the public key to send the driver a 128-bit AES session key.</span></span>
-   <span data-ttu-id="d3b77-165">Il decodificatore software invia le query e i comandi al canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-165">The software decoder sends queries and commands to the authenticated channel.</span></span>
-   <span data-ttu-id="d3b77-166">La chiave di sessione viene usata per calcolare i codici Mac (Message Authentication Code) per le query e i comandi.</span><span class="sxs-lookup"><span data-stu-id="d3b77-166">The session key is used to compute message authentication codes (MACs) for the queries and commands.</span></span> <span data-ttu-id="d3b77-167">Il driver usa i computer Mac per verificare l'integrità dei dati di query/comando e il decodificatore software li usa per verificare l'integrità dei dati di risposta dal driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-167">The driver uses the MACs to verify the integrity of the query/command data, and the software decoder uses them to verify the integrity of the response data from the driver.</span></span>

## <a name="encrypting-compressed-video-buffers-for-the-decoder"></a><span data-ttu-id="d3b77-168">Crittografia dei buffer video compressi per il decodificatore</span><span class="sxs-lookup"><span data-stu-id="d3b77-168">Encrypting Compressed Video Buffers for the Decoder</span></span>

<span data-ttu-id="d3b77-169">Ecco una panoramica di alto livello del processo di crittografia e decodifica:</span><span class="sxs-lookup"><span data-stu-id="d3b77-169">Here is a high-level overview of the encryption and decoding process:</span></span>

1.  <span data-ttu-id="d3b77-170">Il decodificatore software riceve un flusso di dati crittografati dall'origine video.</span><span class="sxs-lookup"><span data-stu-id="d3b77-170">The software decoder receives a stream of encrypted data from the video source.</span></span> <span data-ttu-id="d3b77-171">Il decodificatore decrittografa il flusso.</span><span class="sxs-lookup"><span data-stu-id="d3b77-171">The decoder decrypts this stream.</span></span>
2.  <span data-ttu-id="d3b77-172">Il decodificatore software negozia una chiave di sessione con la sessione di crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-172">The software decoder negotiates a session key with the cryptographic session.</span></span>
3.  <span data-ttu-id="d3b77-173">Il decodificatore software usa il canale autenticato per associare la sessione di crittografia al dispositivo di decodificatore DXVA.</span><span class="sxs-lookup"><span data-stu-id="d3b77-173">The software decoder uses the authenticated channel to associate the cryptographic session with the DXVA decoder device.</span></span>
4.  <span data-ttu-id="d3b77-174">Il decodificatore software inserisce i dati compressi nei buffer DXVA ottenuti dal dispositivo di decodificatore DXVA (Accelerator).</span><span class="sxs-lookup"><span data-stu-id="d3b77-174">The software decoder puts compressed data in DXVA buffers that it gets from the DXVA decoder device (accelerator).</span></span> <span data-ttu-id="d3b77-175">Per il contenuto protetto, il codificatore software crittografa i dati inseriti nei buffer DXVA, usando la chiave di sessione per la crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-175">For protected content, the software encoder encrypts the data that is puts into the DXVA buffers, using the session key for the encryption.</span></span>
    > [!Note]  
    > <span data-ttu-id="d3b77-176">Alcuni driver usano una chiave simmetrica invece della chiave della sessione per la crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-176">Some drivers use a content key, instead of the session key, for encryption.</span></span> <span data-ttu-id="d3b77-177">La chiave simmetrica può variare da un fotogramma a quello successivo.</span><span class="sxs-lookup"><span data-stu-id="d3b77-177">The content key could change from one frame to the next.</span></span>

     

5.  <span data-ttu-id="d3b77-178">Il decodificatore invia i buffer compressi crittografati al tasto di scelta rapida.</span><span class="sxs-lookup"><span data-stu-id="d3b77-178">The decoder submits the encrypted compressed buffers to the accelerator.</span></span> <span data-ttu-id="d3b77-179">Per AES-CTR, il decodificatore passa anche il vettore di inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-179">For AES-CTR, the decoder also passes the initialization vector.</span></span> <span data-ttu-id="d3b77-180">Se viene usata una chiave simmetrica, il decodificatore passa la chiave simmetrica, crittografata usando la chiave della sessione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-180">If a content key is used, the decoder passes content key, encrypted using the session key.</span></span>

<span data-ttu-id="d3b77-181">Direct3D dispone del supporto standard per AES-CTR a 128 bit, ma è progettato per essere esteso ad altri tipi di crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-181">Direct3D has standard support for 128-bit AES-CTR, but is designed to extend to additional encryption types.</span></span>

<span data-ttu-id="d3b77-182">Le cinque sezioni successive forniscono passaggi più dettagliati.</span><span class="sxs-lookup"><span data-stu-id="d3b77-182">The next five sections give more detailed steps.</span></span>

-   [<span data-ttu-id="d3b77-183">1. eseguire una query sulle funzionalità di protezione del contenuto del driver</span><span class="sxs-lookup"><span data-stu-id="d3b77-183">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
-   [<span data-ttu-id="d3b77-184">2. configurare il canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-184">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
-   [<span data-ttu-id="d3b77-185">3. configurare la sessione di crittografia</span><span class="sxs-lookup"><span data-stu-id="d3b77-185">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
-   [<span data-ttu-id="d3b77-186">4. ottenere un handle per il dispositivo di decodificatore DXVA</span><span class="sxs-lookup"><span data-stu-id="d3b77-186">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
-   [<span data-ttu-id="d3b77-187">5. associare il decodificatore DXVA alla sessione di crittografia</span><span class="sxs-lookup"><span data-stu-id="d3b77-187">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)

### <a name="1-query-the-content-protection-capabilities-of-the-driver"></a><span data-ttu-id="d3b77-188">1. eseguire una query sulle funzionalità di protezione del contenuto del driver</span><span class="sxs-lookup"><span data-stu-id="d3b77-188">1. Query the Content Protection Capabilities of the Driver</span></span>

<span data-ttu-id="d3b77-189">Prima di provare ad applicare la crittografia, ottenere le funzionalità di protezione del contenuto del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-189">Before attempting to apply encryption, get the content protection capabilities of the driver.</span></span>

1.  <span data-ttu-id="d3b77-190">Ottenere un puntatore al dispositivo Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="d3b77-190">Get a pointer to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="d3b77-191">Chiamare [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) per l'interfaccia [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-191">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) for the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface.</span></span>
3.  <span data-ttu-id="d3b77-192">Chiamare [**IDirect3DDevice9Video:: GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span><span class="sxs-lookup"><span data-stu-id="d3b77-192">Call [**IDirect3DDevice9Video::GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span></span> <span data-ttu-id="d3b77-193">Questo metodo compila una struttura [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) con le funzionalità di protezione del contenuto del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-193">This method fills in a [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) structure with the driver’s content protection capabilities.</span></span>

<span data-ttu-id="d3b77-194">In particolare, cercare le funzionalità seguenti:</span><span class="sxs-lookup"><span data-stu-id="d3b77-194">In particular, look for the following capabilities:</span></span>

-   <span data-ttu-id="d3b77-195">Se il membro **Caps** contiene il flag **D3DCPCAPS_SOFTWARE** o **D3DCPCAPS_HARDWARE** , il driver può eseguire la crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-195">If the **Caps** member contains the **D3DCPCAPS_SOFTWARE** or **D3DCPCAPS_HARDWARE** flag, the driver can perform encryption.</span></span>
-   <span data-ttu-id="d3b77-196">Il membro **KeyExchangeType** specifica come eseguire lo scambio di chiave per la chiave della sessione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-196">The **KeyExchangeType** member specifies how to perform key exchange for the session key.</span></span>
-   <span data-ttu-id="d3b77-197">Se il membro **Caps** contiene il flag di **D3DCPCAPS_CONTENTKEY** , il driver utilizza una chiave simmetrica separata per la crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-197">If the **Caps** member contains the **D3DCPCAPS_CONTENTKEY** flag, the driver uses a separate content key for encryption.</span></span> <span data-ttu-id="d3b77-198">Questo è importante quando si genera la chiave della sessione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-198">This is important when you generate the session key.</span></span>

<span data-ttu-id="d3b77-199">Nel membro **Caps** sono indicate funzionalità aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="d3b77-199">Additional capabilities are indicated in the **Caps** member.</span></span>

### <a name="2-configure-the-authenticated-channel"></a><span data-ttu-id="d3b77-200">2. configurare il canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-200">2. Configure the Authenticated Channel</span></span>

<span data-ttu-id="d3b77-201">Il passaggio successivo consiste nel configurare il canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-201">The next step is to configure the authenticated channel.</span></span>

1.  <span data-ttu-id="d3b77-202">Chiamare [**IDirect3DDevice9Video:: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) per creare il canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-202">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) to create the authenticated channel.</span></span> <span data-ttu-id="d3b77-203">Per il parametro *ChannelType* , specificare un tipo di canale corrispondente alle funzionalità del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-203">For the *ChannelType* parameter, specify a channel type that matches the capabilities of the driver.</span></span>
    -   <span data-ttu-id="d3b77-204">Il tipo di canale **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** corrisponde a **D3DCPCAPS_SOFTWARE**.</span><span class="sxs-lookup"><span data-stu-id="d3b77-204">The **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** channel type corresponds to **D3DCPCAPS_SOFTWARE**.</span></span>
    -   <span data-ttu-id="d3b77-205">Il tipo di canale **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** corrisponde a **D3DCPCAPS_HARDWARE**.</span><span class="sxs-lookup"><span data-stu-id="d3b77-205">The **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** channel type corresponds to **D3DCPCAPS_HARDWARE**.</span></span>

    <span data-ttu-id="d3b77-206">Il metodo **CreateAuthenticatedChannel** restituisce un puntatore all'interfaccia [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) insieme a un handle per il canale.</span><span class="sxs-lookup"><span data-stu-id="d3b77-206">The **CreateAuthenticatedChannel** method returns a pointer to the [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) interface along with a handle to the channel.</span></span> <span data-ttu-id="d3b77-207">L'handle viene utilizzato in un secondo momento per associare la sessione di crittografia al canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-207">The handle is used later to associate the cryptographic session with the authenticated channel.</span></span>
2.  <span data-ttu-id="d3b77-208">Chiamare [**IDirect3DAuthenticatedChannel9:: GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) per ottenere le dimensioni del certificato X. 509 del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-208">Call [**IDirect3DAuthenticatedChannel9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="d3b77-209">Allocare un buffer della dimensione richiesta.</span><span class="sxs-lookup"><span data-stu-id="d3b77-209">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="d3b77-210">Chiamare [**IDirect3DAuthenticatedChannel9:: GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) per ottenere il certificato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-210">Call [**IDirect3DAuthenticatedChannel9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="d3b77-211">Il metodo copia il certificato nel buffer allocato nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="d3b77-211">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="d3b77-212">Verificare che il certificato del driver sia stato firmato da Microsoft e non sia stato revocato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-212">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="d3b77-213">Ottenere la chiave pubblica dal certificato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-213">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="d3b77-214">Genera una chiave di sessione RSA casuale.</span><span class="sxs-lookup"><span data-stu-id="d3b77-214">Generate a random RSA session key.</span></span> <span data-ttu-id="d3b77-215">Questa chiave di sessione viene utilizzata per firmare i dati inviati al canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-215">This session key is used to sign data that is sent to the authenticated channel.</span></span> <span data-ttu-id="d3b77-216">Crittografare la chiave della sessione utilizzando la chiave pubblica del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-216">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="d3b77-217">Chiamare [**IDirect3DAuthenticatedChannel9:: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) per inviare la chiave della sessione crittografata al driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-217">Call [**IDirect3DAuthenticatedChannel9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="d3b77-218">Inizializzare il canale sicuro come segue:</span><span class="sxs-lookup"><span data-stu-id="d3b77-218">Initialize the secure channel as follows:</span></span>
    1.  <span data-ttu-id="d3b77-219">Compilare una struttura [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) come descritto nella documentazione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-219">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) structure as described in the documentation.</span></span>
    2.  <span data-ttu-id="d3b77-220">Inviare il comando [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) chiamando [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) come descritto nella sezione invio dei [comandi del canale autenticato](#sending-authenticated-channel-commands).</span><span class="sxs-lookup"><span data-stu-id="d3b77-220">Send the [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) command by calling [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) as described in the section [Sending Authenticated Channel Commands](#sending-authenticated-channel-commands).</span></span> <span data-ttu-id="d3b77-221">Questo comando contiene i numeri di sequenza iniziali per i comandi e le query inviati al canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-221">This command contains the starting sequence numbers for the commands and queries that are sent to the authenticated channel.</span></span>
9.  <span data-ttu-id="d3b77-222">Verificare il tipo di canale inviando una query [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) al canale autenticato, come descritto nella sezione [invio di query sul canale autenticato](#sending-authenticated-channel-queries).</span><span class="sxs-lookup"><span data-stu-id="d3b77-222">Verify the channel type by sending a [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) query to the authenticated channel, as described in the section [Sending Authenticated Channel Queries](#sending-authenticated-channel-queries).</span></span> <span data-ttu-id="d3b77-223">Verificare che il tipo di canale corrisponda a quanto specificato nel metodo [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-223">Check that the channel type matches what you specified in the [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) method.</span></span>

### <a name="3-configure-the-cryptographic-session"></a><span data-ttu-id="d3b77-224">3. configurare la sessione di crittografia</span><span class="sxs-lookup"><span data-stu-id="d3b77-224">3. Configure the Cryptographic Session</span></span>

<span data-ttu-id="d3b77-225">Configurare quindi la sessione di crittografia e stabilire la chiave della sessione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-225">Next, configure the cryptographic session and establish the session key.</span></span>

1.  <span data-ttu-id="d3b77-226">Chiamare [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) per creare la sessione di crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-226">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) to create the cryptographic session.</span></span> <span data-ttu-id="d3b77-227">Questo metodo restituisce un puntatore all'interfaccia [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) insieme a un handle per la sessione di crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-227">This method returns a pointer to the [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) interface and along with a handle to the cryptographic session.</span></span>
2.  <span data-ttu-id="d3b77-228">Chiamare [**IDirect3DCryptoSession9:: GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) per ottenere le dimensioni del certificato X. 509 del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-228">Call [**IDirect3DCryptoSession9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="d3b77-229">Allocare un buffer della dimensione richiesta.</span><span class="sxs-lookup"><span data-stu-id="d3b77-229">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="d3b77-230">Chiamare [**IDirect3DCryptoSession9:: GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) per ottenere il certificato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-230">Call [**IDirect3DCryptoSession9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="d3b77-231">Il metodo copia il certificato nel buffer allocato nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="d3b77-231">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="d3b77-232">Verificare che il certificato del driver sia stato firmato da Microsoft e non sia stato revocato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-232">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="d3b77-233">Ottenere la chiave pubblica dal certificato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-233">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="d3b77-234">Genera una chiave di sessione RSA casuale.</span><span class="sxs-lookup"><span data-stu-id="d3b77-234">Generate a random RSA session key.</span></span> <span data-ttu-id="d3b77-235">Si tratta di una chiave di sessione separata dalla chiave di sessione del canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-235">This is a separate session key from the authenticated channel session key.</span></span> <span data-ttu-id="d3b77-236">Crittografare la chiave della sessione utilizzando la chiave pubblica del driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-236">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="d3b77-237">Chiamare [**IDirect3DCryptoSession9:: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) per inviare la chiave della sessione crittografata al driver.</span><span class="sxs-lookup"><span data-stu-id="d3b77-237">Call [**IDirect3DCryptoSession9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="d3b77-238">Se le funzionalità di protezione del contenuto includono **D3DCPCAPS_CONTENTKEY**, creare una chiave simmetrica casuale di RSA.</span><span class="sxs-lookup"><span data-stu-id="d3b77-238">If the content protection capabilities include **D3DCPCAPS_CONTENTKEY**, create a random RSA content key.</span></span> <span data-ttu-id="d3b77-239">Questa operazione verrà utilizzata in un secondo momento nel processo di decodifica.</span><span class="sxs-lookup"><span data-stu-id="d3b77-239">This will be used later in the decoding process.</span></span>

### <a name="4-get-a-handle-to-the-dxva-decoder-device"></a><span data-ttu-id="d3b77-240">4. ottenere un handle per il dispositivo di decodificatore DXVA</span><span class="sxs-lookup"><span data-stu-id="d3b77-240">4. Get a Handle to the DXVA Decoder Device</span></span>

<span data-ttu-id="d3b77-241">Per il passaggio successivo, sarà necessario un handle per il dispositivo di decodificatore DXVA.</span><span class="sxs-lookup"><span data-stu-id="d3b77-241">For the next step, you will need a handle to the DXVA decoder device.</span></span> <span data-ttu-id="d3b77-242">Per ottenere questo handle, compilare una struttura DXVA2_DecodeExecuteParams come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="d3b77-242">To get this handle, fill in a DXVA2_DecodeExecuteParams structure as follows:</span></span>


```C++
HANDLE hDecodeDeviceHandle;

DXVA2_DecodeExecuteParams execParams = {0};
DXVA2_DecodeExtensionData ExtensionExecute = {0};
    
execParams.NumCompBuffers = 0;
execParams.pCompressedBuffers = NULL;
execParams.pExtensionData = &ExtensionExecute;

ExtensionExecute.Function = DXVA2_DECODE_GET_DRIVER_HANDLE;
ExtensionExecute.pPrivateInputData = NULL;
ExtensionExecute.PrivateInputDataSize = 0;
ExtensionExecute.pPrivateOutputData = &hDecodeDeviceHandle;
ExtensionExecute.PrivateOutputDataSize = sizeof(HANDLE);
```



<span data-ttu-id="d3b77-243">Impostare il membro **pExtensionData** della struttura [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) sull'indirizzo di una struttura di [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-243">Set the **pExtensionData** member of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure to the address of a [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure.</span></span>

<span data-ttu-id="d3b77-244">Nella struttura [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) impostare il membro della **funzione** su **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span><span class="sxs-lookup"><span data-stu-id="d3b77-244">In the [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure, set the **Function** member to **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span></span> <span data-ttu-id="d3b77-245">Impostare **pPrivateOutputData** sull'indirizzo di un buffer sufficientemente grande da archiviare un valore di **handle** .</span><span class="sxs-lookup"><span data-stu-id="d3b77-245">Set **pPrivateOutputData** to the address of a buffer that is large enough to store a **HANDLE** value.</span></span> <span data-ttu-id="d3b77-246">Nell'esempio precedente, questo buffer è la variabile *hDecodeDeviceHandle* .</span><span class="sxs-lookup"><span data-stu-id="d3b77-246">(In the previous example, this buffer is the *hDecodeDeviceHandle* variable.)</span></span>

<span data-ttu-id="d3b77-247">Chiamare quindi [**IDirectXVideoDecoder:: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) e passare l'indirizzo della struttura [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-247">Then call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) and pass in the address of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure.</span></span> <span data-ttu-id="d3b77-248">L'handle per il decodificatore DXVA viene restituito in **pPrivateOutputData**.</span><span class="sxs-lookup"><span data-stu-id="d3b77-248">The handle to the DXVA decoder is returned in **pPrivateOutputData**.</span></span>

### <a name="5-associate-the-dxva-decoder-with-the-cryptographic-session"></a><span data-ttu-id="d3b77-249">5. associare il decodificatore DXVA alla sessione di crittografia</span><span class="sxs-lookup"><span data-stu-id="d3b77-249">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>

<span data-ttu-id="d3b77-250">Successivamente, associare il dispositivo DXVA decoder al dispositivo Direct3D e alla sessione di crittografia, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="d3b77-250">Next, associate the DXVA decoder device with the Direct3D device and the cryptographic session, as follows:</span></span>

1.  <span data-ttu-id="d3b77-251">Ottenere un handle per il dispositivo di decodificatore DXVA, come descritto nella sezione precedente.</span><span class="sxs-lookup"><span data-stu-id="d3b77-251">Get a handle to the DXVA decoder device, as described in the previous section.</span></span>
2.  <span data-ttu-id="d3b77-252">Ottenere un handle per il dispositivo Direct3D inviando una query di [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) al canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-252">Get a handle to the Direct3D device, by sending a [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) query to the authenticated channel.</span></span>
3.  <span data-ttu-id="d3b77-253">Compilare una struttura [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) con le seguenti informazioni:</span><span class="sxs-lookup"><span data-stu-id="d3b77-253">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) structure with the following information:</span></span>
    -   <span data-ttu-id="d3b77-254">Impostare il membro **DXVA2DecodeHandle** sull'handle del dispositivo DXVA decoder.</span><span class="sxs-lookup"><span data-stu-id="d3b77-254">Set the **DXVA2DecodeHandle** member to the handle to the DXVA decoder device.</span></span>
    -   <span data-ttu-id="d3b77-255">Impostare il membro **CryptoSessionHandle** sull'handle per la sessione di crittografia.</span><span class="sxs-lookup"><span data-stu-id="d3b77-255">Set the **CryptoSessionHandle** member to the handle to the cryptographic session.</span></span> <span data-ttu-id="d3b77-256">Questo handle viene restituito dal metodo [**IDirect3DDevice9Video:: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-256">This handle is returned by the [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) method.</span></span>
    -   <span data-ttu-id="d3b77-257">Impostare il membro **DeviceHandle** sull'handle del dispositivo Direct3D.</span><span class="sxs-lookup"><span data-stu-id="d3b77-257">Set the **DeviceHandle** member to the Direct3D device handle.</span></span>
4.  <span data-ttu-id="d3b77-258">Chiamare [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) per inviare un comando [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) al canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-258">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) to send a [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) command to the authenticated channel.</span></span>

<span data-ttu-id="d3b77-259">Il diagramma seguente illustra lo scambio di handle:</span><span class="sxs-lookup"><span data-stu-id="d3b77-259">The following diagram illustrates the exchange of handles:</span></span>

![diagramma che Mostra come il decodificatore DXVA è associato alla sessione di crittografia.](images/d3d9video03.png)

<span data-ttu-id="d3b77-261">Il decodificatore software ora può usare la chiave della sessione di crittografia per crittografare i buffer video compressi.</span><span class="sxs-lookup"><span data-stu-id="d3b77-261">The software decoder can now use the cryptographic session key to encrypt the compressed video buffers.</span></span> <span data-ttu-id="d3b77-262">Ogni buffer compresso avrà il proprio vettore di inizializzazione (IV) specificato nel membro **pvPVPState** della struttura [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-262">Each compressed buffer will have its own initialization vector (IV) specified in the **pvPVPState** member of the [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) structure.</span></span>

## <a name="sending-authenticated-channel-commands"></a><span data-ttu-id="d3b77-263">Invio di comandi del canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-263">Sending Authenticated Channel Commands</span></span>

<span data-ttu-id="d3b77-264">Viene definito un set di comandi per configurare il canale autenticato e impostare varie protezioni del contenuto.</span><span class="sxs-lookup"><span data-stu-id="d3b77-264">A set of commands are defined for configuring the authenticated channel and setting various content protections.</span></span> <span data-ttu-id="d3b77-265">Per un elenco di comandi, vedere [protezione del contenuto comandi](content-protection-commands.md).</span><span class="sxs-lookup"><span data-stu-id="d3b77-265">For a list of commands, see [Content Protection Commands](content-protection-commands.md).</span></span>

<span data-ttu-id="d3b77-266">Per inviare un comando al canale autenticato, seguire questa procedura.</span><span class="sxs-lookup"><span data-stu-id="d3b77-266">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="d3b77-267">Compilare la struttura dei dati di input.</span><span class="sxs-lookup"><span data-stu-id="d3b77-267">Fill in the input data structure.</span></span> <span data-ttu-id="d3b77-268">Questa struttura di dati è sempre una struttura di [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) seguita da campi aggiuntivi.</span><span class="sxs-lookup"><span data-stu-id="d3b77-268">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) structure followed by additional fields.</span></span> <span data-ttu-id="d3b77-269">Compilare la struttura **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** come illustrato nella tabella seguente.</span><span class="sxs-lookup"><span data-stu-id="d3b77-269">Fill in the **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="d3b77-270">Membro</span><span class="sxs-lookup"><span data-stu-id="d3b77-270">Member</span></span></th>
    <th><span data-ttu-id="d3b77-271">Descrizione</span><span class="sxs-lookup"><span data-stu-id="d3b77-271">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="d3b77-272"><strong>OMAC</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-272"><strong>omac</strong></span></span></td>
    <td><span data-ttu-id="d3b77-273">Ignorare questo campo per il momento.</span><span class="sxs-lookup"><span data-stu-id="d3b77-273">Skip this field for now.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="d3b77-274"><strong>ConfigureType</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-274"><strong>ConfigureType</strong></span></span></td>
    <td><span data-ttu-id="d3b77-275">GUID che identifica il comando.</span><span class="sxs-lookup"><span data-stu-id="d3b77-275">GUID that identifies the command.</span></span> <span data-ttu-id="d3b77-276">Per un elenco di comandi, vedere <a href="content-protection-commands.md">protezione del contenuto comandi</a>.</span><span class="sxs-lookup"><span data-stu-id="d3b77-276">For a list of commands, see <a href="content-protection-commands.md">Content Protection Commands</a>.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="d3b77-277"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-277"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="d3b77-278">Handle per il canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-278">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="d3b77-279"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-279"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="d3b77-280">Numero di sequenza.</span><span class="sxs-lookup"><span data-stu-id="d3b77-280">The sequence number.</span></span> <span data-ttu-id="d3b77-281">Il primo numero di sequenza viene specificato inviando un comando <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="d3b77-281">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="d3b77-282">Ogni volta che si invia un altro comando, incrementare il numero di 1.</span><span class="sxs-lookup"><span data-stu-id="d3b77-282">Each time you send another command, increment this number by 1.</span></span> <span data-ttu-id="d3b77-283">Il numero di sequenza protegge da attacchi di riproduzione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-283">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="d3b77-284">Vengono utilizzati due numeri di sequenza distinti, uno per i comandi e uno per le query.</span><span class="sxs-lookup"><span data-stu-id="d3b77-284">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="d3b77-285">Calcolare il tag OMAC per il blocco di dati visualizzato dopo il membro **OMAC** della struttura di input.</span><span class="sxs-lookup"><span data-stu-id="d3b77-285">Calculate the OMAC tag for the block of data that appears after the **omac** member of the input structure.</span></span> <span data-ttu-id="d3b77-286">Copiare quindi il valore del tag nel membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="d3b77-286">Then copy this tag value into the **omac** member.</span></span>
3.  <span data-ttu-id="d3b77-287">Chiamare [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span><span class="sxs-lookup"><span data-stu-id="d3b77-287">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span></span>
4.  <span data-ttu-id="d3b77-288">Il driver inserisce l'output del comando nella struttura [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-288">The driver places the output from the command in the [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) structure.</span></span>
5.  <span data-ttu-id="d3b77-289">Calcolare il tag OMAC per il blocco di dati visualizzato dopo il membro **OMAC** della struttura di output.</span><span class="sxs-lookup"><span data-stu-id="d3b77-289">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="d3b77-290">Confrontare con il valore del membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="d3b77-290">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="d3b77-291">Esito negativo se non corrispondono.</span><span class="sxs-lookup"><span data-stu-id="d3b77-291">Fail if they do not match.</span></span>
6.  <span data-ttu-id="d3b77-292">Confrontare i valori dei membri **ConfigureType**, **hChannel** e **SequenceNumber** nella struttura di output con i valori per tali membri.</span><span class="sxs-lookup"><span data-stu-id="d3b77-292">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="d3b77-293">Esito negativo se non corrispondono.</span><span class="sxs-lookup"><span data-stu-id="d3b77-293">Fail if they do not match.</span></span>
7.  <span data-ttu-id="d3b77-294">Incrementare il numero di sequenza del comando successivo.</span><span class="sxs-lookup"><span data-stu-id="d3b77-294">Increment the sequence number for the next command.</span></span>

## <a name="sending-authenticated-channel-queries"></a><span data-ttu-id="d3b77-295">Invio di query sul canale autenticato</span><span class="sxs-lookup"><span data-stu-id="d3b77-295">Sending Authenticated Channel Queries</span></span>

<span data-ttu-id="d3b77-296">Viene definito un set di query per il recupero di informazioni sul canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-296">A set of queries are defined for retrieving information about the authenticated channel.</span></span> <span data-ttu-id="d3b77-297">Per un elenco di query, vedere [protezione del contenuto query](content-protection-queries.md).</span><span class="sxs-lookup"><span data-stu-id="d3b77-297">For a list of queries, see [Content Protection Queries](content-protection-queries.md).</span></span>

<span data-ttu-id="d3b77-298">Per inviare un comando al canale autenticato, seguire questa procedura.</span><span class="sxs-lookup"><span data-stu-id="d3b77-298">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="d3b77-299">Compilare la struttura dei dati di input.</span><span class="sxs-lookup"><span data-stu-id="d3b77-299">Fill in the input data structure.</span></span> <span data-ttu-id="d3b77-300">Questa struttura di dati è sempre una struttura di [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) , probabilmente seguita da campi aggiuntivi.</span><span class="sxs-lookup"><span data-stu-id="d3b77-300">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) structure, possibly followed by additional fields.</span></span> <span data-ttu-id="d3b77-301">Compilare la struttura **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** come illustrato nella tabella seguente.</span><span class="sxs-lookup"><span data-stu-id="d3b77-301">Fill in the **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="d3b77-302">Membro</span><span class="sxs-lookup"><span data-stu-id="d3b77-302">Member</span></span></th>
    <th><span data-ttu-id="d3b77-303">Descrizione</span><span class="sxs-lookup"><span data-stu-id="d3b77-303">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="d3b77-304"><strong>QueryType</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-304"><strong>QueryType</strong></span></span></td>
    <td><span data-ttu-id="d3b77-305">GUID che identifica la query.</span><span class="sxs-lookup"><span data-stu-id="d3b77-305">GUID that identifies the query.</span></span> <span data-ttu-id="d3b77-306">Per un elenco di query, vedere <a href="content-protection-queries.md">protezione del contenuto query</a>.</span><span class="sxs-lookup"><span data-stu-id="d3b77-306">For a list of queries, see <a href="content-protection-queries.md">Content Protection Queries</a>.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="d3b77-307"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-307"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="d3b77-308">Handle per il canale autenticato.</span><span class="sxs-lookup"><span data-stu-id="d3b77-308">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="d3b77-309"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="d3b77-309"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="d3b77-310">Numero di sequenza.</span><span class="sxs-lookup"><span data-stu-id="d3b77-310">The sequence number.</span></span> <span data-ttu-id="d3b77-311">Il primo numero di sequenza viene specificato inviando un comando <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="d3b77-311">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="d3b77-312">Ogni volta che si invia un'altra query, il numero viene incrementato di 1.</span><span class="sxs-lookup"><span data-stu-id="d3b77-312">Each time you send another query, increment this number by 1.</span></span> <span data-ttu-id="d3b77-313">Il numero di sequenza protegge da attacchi di riproduzione.</span><span class="sxs-lookup"><span data-stu-id="d3b77-313">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="d3b77-314">Vengono utilizzati due numeri di sequenza distinti, uno per i comandi e uno per le query.</span><span class="sxs-lookup"><span data-stu-id="d3b77-314">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="d3b77-315">Chiamare [**IDirect3DAuthenticatedChannel9:: query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span><span class="sxs-lookup"><span data-stu-id="d3b77-315">Call [**IDirect3DAuthenticatedChannel9::Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span></span>
3.  <span data-ttu-id="d3b77-316">Il driver inserisce l'output dalla query in una struttura [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) .</span><span class="sxs-lookup"><span data-stu-id="d3b77-316">The driver places the output from the query in a [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) structure.</span></span> <span data-ttu-id="d3b77-317">Questa struttura è seguita da campi aggiuntivi, a seconda del tipo di query.</span><span class="sxs-lookup"><span data-stu-id="d3b77-317">This structure is followed by additional fields, depending on the query type.</span></span>
4.  <span data-ttu-id="d3b77-318">Calcolare il tag OMAC per il blocco di dati visualizzato dopo il membro **OMAC** della struttura di output.</span><span class="sxs-lookup"><span data-stu-id="d3b77-318">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="d3b77-319">Confrontare con il valore del membro **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="d3b77-319">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="d3b77-320">Esito negativo se non corrispondono.</span><span class="sxs-lookup"><span data-stu-id="d3b77-320">Fail if they do not match.</span></span>
5.  <span data-ttu-id="d3b77-321">Confrontare i valori dei membri **ConfigureType**, **hChannel** e **SequenceNumber** nella struttura di output con i valori per tali membri.</span><span class="sxs-lookup"><span data-stu-id="d3b77-321">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="d3b77-322">Esito negativo se non corrispondono.</span><span class="sxs-lookup"><span data-stu-id="d3b77-322">Fail if they do not match.</span></span>
6.  <span data-ttu-id="d3b77-323">Incrementa il numero di sequenza per la query successiva.</span><span class="sxs-lookup"><span data-stu-id="d3b77-323">Increment the sequence number for the next query.</span></span>

## <a name="related-topics"></a><span data-ttu-id="d3b77-324">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="d3b77-324">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="d3b77-325">API video Direct3D 9</span><span class="sxs-lookup"><span data-stu-id="d3b77-325">Direct3D 9 Video APIs</span></span>](direct3d-video-apis.md)
</dt> </dl>

 

 
