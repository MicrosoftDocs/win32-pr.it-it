---
description: Supporto di DXVA 2,0 in Media Foundation
ms.assetid: d7330370-adb3-4c6a-962a-7b46c344500c
title: Supporto di DXVA 2,0 in Media Foundation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ce144c24a1aeeda6281ddb423757f3e339903440
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/03/2021
ms.locfileid: "106320700"
---
# <a name="supporting-dxva-20-in-media-foundation"></a><span data-ttu-id="4921a-103">Supporto di DXVA 2,0 in Media Foundation</span><span class="sxs-lookup"><span data-stu-id="4921a-103">Supporting DXVA 2.0 in Media Foundation</span></span>

<span data-ttu-id="4921a-104">In questo argomento viene descritto come supportare l'accelerazione video DirectX (DXVA) 2,0 in una trasformazione Media Foundation (MFT) utilizzando Microsoft Direct3D 9 in modo specifico, viene descritta la comunicazione tra il decodificatore e il renderer video, che viene mediato dal caricatore della topologia.</span><span class="sxs-lookup"><span data-stu-id="4921a-104">This topic describes how to support DirectX Video Acceleration (DXVA) 2.0 in a Media Foundation transform (MFT) using Microsoft Direct3D 9 Specifically, it describes the communication between the decoder and the video renderer, which is mediated by the topology loader.</span></span> <span data-ttu-id="4921a-105">In questo argomento non viene descritto come implementare la decodifica DXVA.</span><span class="sxs-lookup"><span data-stu-id="4921a-105">This topic does not describe how to implement DXVA decoding.</span></span>

<span data-ttu-id="4921a-106">Nella parte restante di questo argomento, il termine *decodificatore* si riferisce al decodificatore MFT, che riceve video compresso e genera video non compressi.</span><span class="sxs-lookup"><span data-stu-id="4921a-106">In the remainder of this topic, the term *decoder* refers to the decoder MFT, which receives compressed video and outputs uncompressed video.</span></span> <span data-ttu-id="4921a-107">Il termine *dispositivo decodificatore* si riferisce a un acceleratore video hardware implementato dal driver Graphics.</span><span class="sxs-lookup"><span data-stu-id="4921a-107">The term *decoder device* refers to a hardware video accelerator implemented by the graphics driver.</span></span>

> [!TIP]
> <span data-ttu-id="4921a-108">Per informazioni sulla decodifica video Microsoft Direct3D 11, vedere [supporto della decodifica video Direct3D 11 in Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span><span class="sxs-lookup"><span data-stu-id="4921a-108">For info on Microsoft Direct3D 11 video decoding see, [Supporting Direct3D 11 Video Decoding in Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="4921a-109">Le app di Windows Store devono usare Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4921a-109">Windows Store apps must use Direct3D 11.</span></span>

 

<span data-ttu-id="4921a-110">Ecco i passaggi di base che devono essere eseguiti da un decodificatore per supportare DXVA 2,0 in Media Foundation:</span><span class="sxs-lookup"><span data-stu-id="4921a-110">Here are the basic steps that a decoder must perform to support DXVA 2.0 in Media Foundation:</span></span>

1.  <span data-ttu-id="4921a-111">Aprire un handle per il dispositivo Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="4921a-111">Open a handle to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="4921a-112">Trovare una configurazione del decodificatore DXVA.</span><span class="sxs-lookup"><span data-stu-id="4921a-112">Find a DXVA decoder configuration.</span></span>
3.  <span data-ttu-id="4921a-113">Allocare buffer non compressi.</span><span class="sxs-lookup"><span data-stu-id="4921a-113">Allocate uncompressed Buffers.</span></span>
4.  <span data-ttu-id="4921a-114">Decodificare i frame.</span><span class="sxs-lookup"><span data-stu-id="4921a-114">Decode frames.</span></span>

<span data-ttu-id="4921a-115">Questi passaggi sono descritti in modo più dettagliato nella parte restante di questo argomento.</span><span class="sxs-lookup"><span data-stu-id="4921a-115">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="opening-a-direct3d-device-handle"></a><span data-ttu-id="4921a-116">Apertura di un handle di dispositivo Direct3D</span><span class="sxs-lookup"><span data-stu-id="4921a-116">Opening a Direct3D Device Handle</span></span>

<span data-ttu-id="4921a-117">Il MFT USA gestione dispositivi Microsoft Direct3D per ottenere un handle per il dispositivo Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="4921a-117">The MFT uses the Microsoft Direct3D device manager to get a handle to the Direct3D 9 device.</span></span> <span data-ttu-id="4921a-118">Per aprire l'handle del dispositivo, seguire questa procedura:</span><span class="sxs-lookup"><span data-stu-id="4921a-118">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="4921a-119">Esporre l'attributo in grado di riconoscere il valore [MF \_ sa \_ D3D \_](mf-sa-d3d-aware-attribute.md) con il valore **true**.</span><span class="sxs-lookup"><span data-stu-id="4921a-119">Expose the [MF\_SA\_D3D\_AWARE](mf-sa-d3d-aware-attribute.md) attribute with the value **TRUE**.</span></span> <span data-ttu-id="4921a-120">Il caricatore della topologia esegue una query su questo attributo chiamando [**IMFTransform:: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span><span class="sxs-lookup"><span data-stu-id="4921a-120">The topology loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="4921a-121">Se si imposta l'attributo su **true** , viene inviata una notifica al caricatore della topologia supportata da DXVA.</span><span class="sxs-lookup"><span data-stu-id="4921a-121">Setting the attribute to **TRUE** notifies the topology loader that the MFT supports DXVA.</span></span>
2.  <span data-ttu-id="4921a-122">Quando viene avviata la negoziazione del formato, il caricatore della topologia chiama [**IMFTransform::P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) con il messaggio di [**\_ \_ \_ \_ gestione D3D del set di messaggi di MFT**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="4921a-122">When format negotiation begins, the topology loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="4921a-123">Il parametro *ulParam* è un puntatore **IUnknown** alla gestione dispositivi Direct3D del renderer video.</span><span class="sxs-lookup"><span data-stu-id="4921a-123">The *ulParam* parameter is an **IUnknown** pointer to the video renderer's Direct3D device manager.</span></span> <span data-ttu-id="4921a-124">Eseguire una query su questo puntatore per l'interfaccia [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="4921a-124">Query this pointer for the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span>
3.  <span data-ttu-id="4921a-125">Chiamare [**IDirect3DDeviceManager9:: OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) per ottenere un handle per il dispositivo Direct3D del renderer.</span><span class="sxs-lookup"><span data-stu-id="4921a-125">Call [**IDirect3DDeviceManager9::OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) to get a handle to the renderer's Direct3D device.</span></span>
4.  <span data-ttu-id="4921a-126">Chiamare [**IDirect3DDeviceManager9:: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) e passare l'handle del dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4921a-126">Call [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) and pass in the device handle.</span></span> <span data-ttu-id="4921a-127">Questo metodo restituisce un puntatore all'interfaccia [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) .</span><span class="sxs-lookup"><span data-stu-id="4921a-127">This method returns a pointer to the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface.</span></span>
5.  <span data-ttu-id="4921a-128">Memorizzare nella cache i puntatori e l'handle del dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4921a-128">Cache the pointers and the device handle.</span></span>

## <a name="finding-a-decoder-configuration"></a><span data-ttu-id="4921a-129">Ricerca di una configurazione del decodificatore</span><span class="sxs-lookup"><span data-stu-id="4921a-129">Finding a Decoder Configuration</span></span>

<span data-ttu-id="4921a-130">MFT deve trovare una configurazione compatibile per il dispositivo di decodificatore DXVA.</span><span class="sxs-lookup"><span data-stu-id="4921a-130">The MFT must find a compatible configuration for the DXVA decoder device.</span></span> <span data-ttu-id="4921a-131">Eseguire i passaggi seguenti all'interno del metodo [**IMFTransform:: SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) , dopo aver convalidato il tipo di input:</span><span class="sxs-lookup"><span data-stu-id="4921a-131">Perform the following steps inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, after validating the input type:</span></span>

1.  <span data-ttu-id="4921a-132">Chiamare [**IDirectXVideoDecoderService:: GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span><span class="sxs-lookup"><span data-stu-id="4921a-132">Call [**IDirectXVideoDecoderService::GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span></span> <span data-ttu-id="4921a-133">Questo metodo restituisce una matrice di GUID del dispositivo del decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-133">This method returns an array of decoder device GUIDs.</span></span>
2.  <span data-ttu-id="4921a-134">Scorrere la matrice dei GUID del decodificatore per trovare quelli supportati dal decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-134">Loop through the array of decoder GUIDs to find the ones that the decoder supports.</span></span> <span data-ttu-id="4921a-135">Per un decodificatore MPEG-2, ad esempio, si cercherà **DXVA2 \_ ModeMPEG2 \_ MOCOMP**, **DXVA2 \_ ModeMPEG2 \_ IDCT** o **DXVA2 \_ ModeMPEG2 \_ VLD.**</span><span class="sxs-lookup"><span data-stu-id="4921a-135">For example, for an MPEG-2 decoder, you would look for **DXVA2\_ModeMPEG2\_MOCOMP**, **DXVA2\_ModeMPEG2\_IDCT**, or **DXVA2\_ModeMPEG2\_VLD**.</span></span>

3.  <span data-ttu-id="4921a-136">Quando si trova un GUID del dispositivo del decodificatore candidato, passare il GUID al metodo [**IDirectXVideoDecoderService:: GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) .</span><span class="sxs-lookup"><span data-stu-id="4921a-136">When you find a candidate decoder device GUID, pass the GUID to the [**IDirectXVideoDecoderService::GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) method.</span></span> <span data-ttu-id="4921a-137">Questo metodo restituisce una matrice di formati di destinazione di rendering, specificati come valori **D3DFORMAT** .</span><span class="sxs-lookup"><span data-stu-id="4921a-137">This method returns an array of render target formats, specified as **D3DFORMAT** values.</span></span>
4.  <span data-ttu-id="4921a-138">Scorrere i formati della destinazione di rendering e cercare un formato supportato dal decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-138">Loop through the render target formats and look for a format supported by the decoder.</span></span>
5.  <span data-ttu-id="4921a-139">Chiamare [**IDirectXVideoDecoderService:: GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span><span class="sxs-lookup"><span data-stu-id="4921a-139">Call [**IDirectXVideoDecoderService::GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span></span> <span data-ttu-id="4921a-140">Passare lo stesso GUID del dispositivo di decodificatore, insieme a una struttura [**DXVA2 \_ VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) che descrive il formato di output proposto.</span><span class="sxs-lookup"><span data-stu-id="4921a-140">Pass in the same decoder device GUID, along with a [**DXVA2\_VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) structure that describes the proposed output format.</span></span> <span data-ttu-id="4921a-141">Il metodo restituisce una matrice di [**strutture \_ ConfigPictureDecode di DXVA2**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) .</span><span class="sxs-lookup"><span data-stu-id="4921a-141">The method returns an array of [**DXVA2\_ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) structures.</span></span> <span data-ttu-id="4921a-142">Ogni struttura descrive una possibile configurazione per il dispositivo di decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-142">Each structure describes one possible configuration for the decoder device.</span></span> <span data-ttu-id="4921a-143">Cercare una configurazione supportata dal decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-143">Look for a configuration that the decoder supports.</span></span>
6.  <span data-ttu-id="4921a-144">Archiviare il formato e la configurazione della destinazione di rendering.</span><span class="sxs-lookup"><span data-stu-id="4921a-144">Store the render target format and configuration.</span></span>

<span data-ttu-id="4921a-145">Nel metodo [**IMFTransform:: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) restituire un formato video non compresso, in base al formato di destinazione di rendering proposto.</span><span class="sxs-lookup"><span data-stu-id="4921a-145">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format, based on the proposed render target format.</span></span>

<span data-ttu-id="4921a-146">Nel metodo [**IMFTransform:: SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) controllare il tipo di supporto in base al formato di destinazione di rendering.</span><span class="sxs-lookup"><span data-stu-id="4921a-146">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

### <a name="fallback-to-software-decoding"></a><span data-ttu-id="4921a-147">Fallback alla decodifica software</span><span class="sxs-lookup"><span data-stu-id="4921a-147">Fallback to Software Decoding</span></span>

<span data-ttu-id="4921a-148">Se MFT non riesce a trovare una configurazione DXVA (ad esempio, se il driver di grafica non ha le funzionalità appropriate), deve restituire il codice di errore **MF \_ e il \_ \_ \_ tipo D3D non supportato** dai metodi [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) e [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) .</span><span class="sxs-lookup"><span data-stu-id="4921a-148">If the MFT cannot find a DXVA configuration (for example, if the graphics driver does not have the right capabilities), it should return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE** from the [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods.</span></span> <span data-ttu-id="4921a-149">Il caricatore della topologia risponderà inviando il messaggio [**MFT \_ \_ \_ \_ gestione D3D message set**](mft-message-set-d3d-manager.md) con il valore **null** per il parametro *ulParam* .</span><span class="sxs-lookup"><span data-stu-id="4921a-149">The topology loader will respond by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span> <span data-ttu-id="4921a-150">Il MFT deve rilasciare il puntatore all'interfaccia [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="4921a-150">The MFT should release its pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="4921a-151">Il caricatore della topologia rinegozierà quindi il tipo di supporto e la MFT potrà usare la decodifica software.</span><span class="sxs-lookup"><span data-stu-id="4921a-151">The topology loader will then renegotiate the media type, and the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="4921a-152">Allocazione di buffer non compressi</span><span class="sxs-lookup"><span data-stu-id="4921a-152">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="4921a-153">In DXVA 2,0, il decodificatore è responsabile dell'allocazione di superfici Direct3D da usare come buffer video non compressi.</span><span class="sxs-lookup"><span data-stu-id="4921a-153">In DXVA 2.0, the decoder is responsible for allocating Direct3D surfaces to use as uncompressed video buffers.</span></span> <span data-ttu-id="4921a-154">Il decodificatore deve allocare 3 superfici per il EVR da usare per la deinterlacciamento.</span><span class="sxs-lookup"><span data-stu-id="4921a-154">The decoder should allocate 3 surfaces for the EVR to use for deinterlacing.</span></span> <span data-ttu-id="4921a-155">Questo numero è fisso, perché Media Foundation non fornisce un modo per EVR di specificare il numero di superfici richieste dal driver grafico per la deinterlacciamento.</span><span class="sxs-lookup"><span data-stu-id="4921a-155">This number is fixed, because Media Foundation does not provide a way for the EVR to specify how many surfaces the graphics driver requires for deinterlacing.</span></span> <span data-ttu-id="4921a-156">Tre superfici dovrebbero essere sufficienti per tutti i driver.</span><span class="sxs-lookup"><span data-stu-id="4921a-156">Three surfaces should be sufficient for any driver.</span></span>

<span data-ttu-id="4921a-157">Nel metodo [**IMFTransform:: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) impostare il flusso di **output di MFT fornisce il flag \_ \_ \_ \_ Samples** nella struttura di [**informazioni del flusso di output di MFT \_ \_ \_**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) .</span><span class="sxs-lookup"><span data-stu-id="4921a-157">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) structure.</span></span> <span data-ttu-id="4921a-158">Questo flag notifica alla sessione multimediale che la MFT alloca gli esempi di output.</span><span class="sxs-lookup"><span data-stu-id="4921a-158">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span>

<span data-ttu-id="4921a-159">Per creare le superfici, chiamare [**IDirectXVideoAccelerationService:: CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span><span class="sxs-lookup"><span data-stu-id="4921a-159">To create the surfaces, call [**IDirectXVideoAccelerationService::CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span></span> <span data-ttu-id="4921a-160">(L'interfaccia [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) eredita questo metodo da [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice)). Questa operazione può essere eseguita in [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype)dopo aver individuato il formato della destinazione di rendering.</span><span class="sxs-lookup"><span data-stu-id="4921a-160">(The [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface inherits this method from [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) You can do this in [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), after finding the render target format.</span></span>

<span data-ttu-id="4921a-161">Per ogni superficie, chiamare [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) per creare un esempio multimediale che contenga la superficie.</span><span class="sxs-lookup"><span data-stu-id="4921a-161">For each surface, call [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) to create a media sample to hold the surface.</span></span> <span data-ttu-id="4921a-162">Il metodo restituisce un puntatore all'interfaccia [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) .</span><span class="sxs-lookup"><span data-stu-id="4921a-162">The method returns a pointer to the [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface.</span></span>

## <a name="decoding"></a><span data-ttu-id="4921a-163">Decodifica</span><span class="sxs-lookup"><span data-stu-id="4921a-163">Decoding</span></span>

<span data-ttu-id="4921a-164">Per creare il dispositivo di decodificatore, chiamare [**IDirectXVideoDecoderService:: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="4921a-164">To create the decoder device, call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="4921a-165">Il metodo restituisce un puntatore all'interfaccia [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) del dispositivo di decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-165">The method returns a pointer to the [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) interface of the decoder device.</span></span>

<span data-ttu-id="4921a-166">La decodifica deve essere eseguita all'interno del metodo [**IMFTransform::P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) .</span><span class="sxs-lookup"><span data-stu-id="4921a-166">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="4921a-167">In ogni frame, chiamare [**IDirect3DDeviceManager9:: TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) per testare l'handle del dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4921a-167">On each frame, call [**IDirect3DDeviceManager9::TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) to test the device handle.</span></span> <span data-ttu-id="4921a-168">Se il dispositivo è stato modificato, il metodo restituisce il **\_ \_ nuovo \_ \_ dispositivo video DXVA2 E**.</span><span class="sxs-lookup"><span data-stu-id="4921a-168">If the device has changed, the method returns **DXVA2\_E\_NEW\_VIDEO\_DEVICE**.</span></span> <span data-ttu-id="4921a-169">In tal caso, effettuare le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="4921a-169">If this occurs, do the following:</span></span>

1.  <span data-ttu-id="4921a-170">Chiudere l'handle del dispositivo chiamando [**IDirect3DDeviceManager9:: CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span><span class="sxs-lookup"><span data-stu-id="4921a-170">Close the device handle by calling [**IDirect3DDeviceManager9::CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span></span>
2.  <span data-ttu-id="4921a-171">Rilasciare i puntatori [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) e [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) .</span><span class="sxs-lookup"><span data-stu-id="4921a-171">Release the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) and [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) pointers.</span></span>
3.  <span data-ttu-id="4921a-172">Aprire un nuovo handle di dispositivo.</span><span class="sxs-lookup"><span data-stu-id="4921a-172">Open a new device handle.</span></span>
4.  <span data-ttu-id="4921a-173">Negoziare una nuova configurazione del decodificatore, come descritto in "ricerca di una configurazione di decodificatore" più indietro in questa pagina.</span><span class="sxs-lookup"><span data-stu-id="4921a-173">Negotiate a new decoder configuration, as described in "Finding a Decoder Configuration" earlier on this page.</span></span>
5.  <span data-ttu-id="4921a-174">Creare un nuovo dispositivo di decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-174">Create a new decoder device.</span></span>

<span data-ttu-id="4921a-175">Supponendo che l'handle del dispositivo sia valido, il processo di decodifica funziona nel modo seguente:</span><span class="sxs-lookup"><span data-stu-id="4921a-175">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="4921a-176">Ottenere una superficie disponibile che non è attualmente in uso.</span><span class="sxs-lookup"><span data-stu-id="4921a-176">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="4921a-177">(Inizialmente tutte le superfici sono disponibili).</span><span class="sxs-lookup"><span data-stu-id="4921a-177">(Initially all of the surfaces are available.)</span></span>
2.  <span data-ttu-id="4921a-178">Eseguire una query sull'esempio multimediale per l'interfaccia [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) .</span><span class="sxs-lookup"><span data-stu-id="4921a-178">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="4921a-179">Chiamare [**IMFTrackedSample:: Seallocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) e fornire un puntatore all'interfaccia [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) , implementata dal decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-179">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface, implemented by the decoder.</span></span> <span data-ttu-id="4921a-180">Quando il renderer video rilascia l'esempio, verrà richiamato il callback del decodificatore.</span><span class="sxs-lookup"><span data-stu-id="4921a-180">When the video renderer releases the sample, the decoder's callback will be invoked.</span></span>
4.  <span data-ttu-id="4921a-181">Chiamare [**IDirectXVideoDecoder:: BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span><span class="sxs-lookup"><span data-stu-id="4921a-181">Call [**IDirectXVideoDecoder::BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span></span>
5.  <span data-ttu-id="4921a-182">Eseguire le operazioni seguenti una o più volte:</span><span class="sxs-lookup"><span data-stu-id="4921a-182">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="4921a-183">Chiamare [**IDirectXVideoDecoder:: GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) per ottenere un buffer del decodificatore DXVA.</span><span class="sxs-lookup"><span data-stu-id="4921a-183">Call [**IDirectXVideoDecoder::GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) to get a DXVA decoder buffer.</span></span>
    2.  <span data-ttu-id="4921a-184">Riempire il buffer.</span><span class="sxs-lookup"><span data-stu-id="4921a-184">Fill the buffer.</span></span>
    3.  <span data-ttu-id="4921a-185">Chiamare [**IDirectXVideoDecoder:: ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span><span class="sxs-lookup"><span data-stu-id="4921a-185">Call [**IDirectXVideoDecoder::ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span></span>
    4.  <span data-ttu-id="4921a-186">Chiamare [**IDirectXVideoDecoder:: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) per eseguire le operazioni di decodifica sul frame.</span><span class="sxs-lookup"><span data-stu-id="4921a-186">Call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) to perform the decoding operations on the frame.</span></span>

<span data-ttu-id="4921a-187">DXVA 2,0 usa le stesse strutture di dati di DXVA 1,0 per le operazioni di decodifica.</span><span class="sxs-lookup"><span data-stu-id="4921a-187">DXVA 2.0 uses the same data structures as DXVA 1.0 for decoding operations.</span></span> <span data-ttu-id="4921a-188">Per il set originale di profili DXVA (per H. 261, H. 263 e MPEG-2), queste strutture di dati sono descritte nella [specifica DXVA 1,0](/windows-hardware/drivers/display/directx-video-acceleration).</span><span class="sxs-lookup"><span data-stu-id="4921a-188">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="4921a-189">All'interno di ogni [](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)coppia di chiamate di / [**esecuzione**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) BeginFrame, è possibile chiamare più volte [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) , ma solo una volta per ogni tipo di buffer DXVA.</span><span class="sxs-lookup"><span data-stu-id="4921a-189">Within each pair of [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)/[**Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) calls, you may call [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) multiple times, but only once for each type of DXVA buffer.</span></span> <span data-ttu-id="4921a-190">Se viene chiamato due volte con lo stesso tipo di buffer, i dati vengono sovrascritti.</span><span class="sxs-lookup"><span data-stu-id="4921a-190">If you call it twice with the same buffer type, you will overwrite the data.</span></span>

<span data-ttu-id="4921a-191">Usare il callback del metodo [**Seallocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) (passaggio 3) per tenere traccia degli esempi attualmente disponibili e in uso.</span><span class="sxs-lookup"><span data-stu-id="4921a-191">Use the callback from the [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) method (step 3) to keep track of which samples are currently available and which are in use.</span></span>

## <a name="related-topics"></a><span data-ttu-id="4921a-192">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="4921a-192">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4921a-193">Accelerazione video DirectX 2,0</span><span class="sxs-lookup"><span data-stu-id="4921a-193">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> <dt>

[<span data-ttu-id="4921a-194">Trasformazioni Media Foundation</span><span class="sxs-lookup"><span data-stu-id="4921a-194">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 
