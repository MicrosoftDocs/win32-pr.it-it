---
description: In questo argomento viene descritto come implementare una trasformazione di Media Foundation compatibile con Direct3D (MFT) per i video.
ms.assetid: 8ec7e678-8477-41fa-9726-54df5ed187cd
title: Direct3D-Aware MFTs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad50438250c0ee1627cc20aebb49262ec8eec9ac
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104524561"
---
# <a name="direct3d-aware-mfts"></a><span data-ttu-id="2b2e4-103">Direct3D-Aware MFTs</span><span class="sxs-lookup"><span data-stu-id="2b2e4-103">Direct3D-Aware MFTs</span></span>

<span data-ttu-id="2b2e4-104">In questo argomento viene descritto come implementare una trasformazione di Media Foundation *compatibile con Direct3D* (MFT) per i video.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-104">This topic describes how to implement a *Direct3D-aware* Media Foundation transform (MFT) for video.</span></span>

<span data-ttu-id="2b2e4-105">Un video MFT viene considerato *compatibile con Direct3D* se può elaborare esempi che contengono superfici Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-105">An video MFT is considered *Direct3D-aware* if it can process samples that contain Direct3D surfaces.</span></span> <span data-ttu-id="2b2e4-106">Il motivo tipico per il supporto di Direct3D in un video MFT consiste nell'abilitare la decodifica con accelerazione hardware, usando l'accelerazione video DirectX (DXVA).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-106">The typical reason for supporting Direct3D in a video MFT is to enable hardware-accelerated decoding, using DirectX Video Acceleration (DXVA).</span></span>

<span data-ttu-id="2b2e4-107">In questo argomento vengono descritti i passaggi necessari per rendere compatibile con Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-107">This topic describes the steps that are required to make your MFT Direct3D-aware.</span></span> <span data-ttu-id="2b2e4-108">Questo argomento non copre i meccanismi di decodifica DXVA.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-108">This topic does not cover the mechanics of DXVA decoding.</span></span> <span data-ttu-id="2b2e4-109">Per informazioni su DXVA, vedere [accelerazione video DirectX 2,0](directx-video-acceleration-2-0.md).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-109">For information about DXVA, see [DirectX Video Acceleration 2.0](directx-video-acceleration-2-0.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="2b2e4-110">A partire da Windows 8, è possibile usare [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) invece di [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-110">Beginning in Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) can be used instead of the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span></span> <span data-ttu-id="2b2e4-111">Per le app di Windows Store, è necessario usare **IMFDXGIDeviceManager** e Microsoft Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-111">For Windows Store apps, you must use **IMFDXGIDeviceManager** and Microsoft Direct3D 11.</span></span> <span data-ttu-id="2b2e4-112">Per altre informazioni, vedere le [API video di Direct3D 11](direct3d-11-video-apis.md).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-112">For more info, see the [Direct3D 11 Video APIs](direct3d-11-video-apis.md).</span></span>

 

1.  <span data-ttu-id="2b2e4-113">Implementare il metodo [**IMFTransform:: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) .</span><span class="sxs-lookup"><span data-stu-id="2b2e4-113">Implement the [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) method.</span></span> <span data-ttu-id="2b2e4-114">Questo metodo restituisce un puntatore a un archivio di attributi.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-114">This method returns a pointer to an attribute store.</span></span>
2.  <span data-ttu-id="2b2e4-115">Il file MFT deve impostare il valore dell'attributo in grado di riconoscere il valore [**MF \_ sa \_ D3D \_**](mf-sa-d3d-aware-attribute.md) su **true** nel relativo archivio attributi.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-115">The MFT must set the value of the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) attribute to **TRUE** on its own attribute store.</span></span> <span data-ttu-id="2b2e4-116">A partire da Windows 8, se si usa Direct3D 11 usare [MF \_ sa \_ d3d11 \_ Aware](mf-sa-d3d11-aware.md).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-116">Beginning in Windows 8, if using Direct3D 11 use [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md).</span></span>
3.  <span data-ttu-id="2b2e4-117">Durante la negoziazione del formato, se l'attributo per la compatibilità con la compatibilità con l'utilizzo di Direct3D [**\_ sa \_ \_**](mf-sa-d3d-aware-attribute.md) o [MF \_ sa \_ d3d11 \_](mf-sa-d3d11-aware.md) è **true**, il client può inviare il messaggio [**MFT \_ message \_ set \_ \_ gestione D3D**](mft-message-set-d3d-manager.md) alla MFT.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-117">During format negotiation, if the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) (or [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) if using Direct3D 11) attribute is **TRUE**, the client may send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message to the MFT.</span></span> <span data-ttu-id="2b2e4-118">Il parametro dell'evento *ulParam* è un puntatore all'interfaccia [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="2b2e4-118">The *ulParam* event parameter is a pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="2b2e4-119">A partire da Windows 8, è possibile usare [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) anziché **IDirect3DDeviceManager9**.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-119">Beginning in Windows 8, you can use [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) instead of **IDirect3DDeviceManager9**.</span></span> <span data-ttu-id="2b2e4-120">Il client non è necessario per l'invio di questo messaggio.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-120">The client is not required to send this message.</span></span>
4.  <span data-ttu-id="2b2e4-121">Il MFT chiama [**IDirect3DDeviceManager9:: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) per eseguire una query per il servizio DXVA necessario.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-121">The MFT calls [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) to query for the DXVA service it needs.</span></span> <span data-ttu-id="2b2e4-122">A partire da Windows 8, se è stato usato [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) , il MFT chiama [**IMFDXGIDeviceManager:: GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-122">Beginning in Windows 8, if [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) was used the MFT calls [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="2b2e4-123">In genere, un decodificatore esegue una query per [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice)e un processore video esegue una query per [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-123">Typically a decoder would query for [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), and a video processor would query for [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span></span>
5.  <span data-ttu-id="2b2e4-124">Supponendo che il passaggio precedente abbia esito positivo, i metodi [**IMFTransform:: GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) e [**IMFTransform:: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) devono restituire formati compatibili con DXVA.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-124">Assuming the previous step is successful, the [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) and [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) methods must return DXVA-compatible formats.</span></span>
6.  <span data-ttu-id="2b2e4-125">Il client configura i tipi di supporto in MFT.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-125">The client configures the media types on the MFT.</span></span> <span data-ttu-id="2b2e4-126">Se un tipo di supporto non è compatibile con DXVA, MFT deve restituire il codice di errore **MF \_ E il \_ \_ \_ tipo D3D non supportato**.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-126">If a media type is not compatible with DXVA, the MFT must return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
7.  <span data-ttu-id="2b2e4-127">A questo punto, sono disponibili due opzioni, a seconda che il client trovi un formato DXVA appropriato.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-127">At this point, there are two options, depending on whether the client finds a suitable DXVA format.</span></span>
    -   <span data-ttu-id="2b2e4-128">Se il client configura correttamente un formato DXVA, può iniziare l'elaborazione.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-128">If the client successfully configures a DXVA format, it may begin processing.</span></span> <span data-ttu-id="2b2e4-129">A questo punto, la MFT può usare DXVA per l'elaborazione o eseguire il fallback all'elaborazione software.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-129">At this point, the MFT can use DXVA for processing, or fall back to software processing.</span></span>
    -   <span data-ttu-id="2b2e4-130">In alternativa, se il client non trova un formato DXVA accettabile, il client può inviare un altro messaggio di [**\_ \_ \_ \_ gestione D3D del set di messaggi MFT**](mft-message-set-d3d-manager.md) , questa volta impostando *ulParam* su **null**.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-130">Alternatively, if the client does not find an acceptable DXVA format, the client may send another [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message, this time setting *ulParam* to **NULL**.</span></span> <span data-ttu-id="2b2e4-131">Il MFT deve rilasciare il puntatore [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) (il puntatore [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) se è stato usato **IMFDXGIDeviceManager** ) e qualsiasi altra interfaccia DXVA e ripristinare l'elaborazione del software.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-131">The MFT must release the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) pointer (the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pointer, if **IMFDXGIDeviceManager** was used) and any other DXVA interfaces, and revert to software processing.</span></span> <span data-ttu-id="2b2e4-132">A questo punto, il MFT non deve usare l'elaborazione DXVA.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-132">At this point, the MFT must not use DXVA processing.</span></span>

<span data-ttu-id="2b2e4-133">Un MFT compatibile con Direct3D deve essere preparato per gestire esempi che contengono una superficie Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-133">A Direct3D-aware MFT must be prepared to handle samples that contain a Direct3D surface.</span></span> <span data-ttu-id="2b2e4-134">L'esempio conterrà esattamente un buffer multimediale.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-134">The sample will contain exactly one media buffer.</span></span> <span data-ttu-id="2b2e4-135">Per ottenere la superficie Direct3D dal buffer, chiamare la funzione [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) e specificare il servizio **del \_ \_ servizio buffer di Mr** .</span><span class="sxs-lookup"><span data-stu-id="2b2e4-135">To get the Direct3D surface from the buffer, call the [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) function and specify the **MR\_BUFFER\_SERVICE** service.</span></span> <span data-ttu-id="2b2e4-136">Per ulteriori informazioni, vedere la pagina relativa al [buffer della superficie DirectX](directx-surface-buffer.md).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-136">For more information, see [DirectX Surface Buffer](directx-surface-buffer.md).</span></span>

<span data-ttu-id="2b2e4-137">Un MFT che usa DXVA deve allocare i propri esempi di output, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="2b2e4-137">An MFT that uses DXVA must allocate its own output samples, as follows:</span></span>

1.  <span data-ttu-id="2b2e4-138">Nel metodo [**IMFTransform:: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) impostare il flusso di **output di MFT fornisce il flag \_ \_ \_ \_ Samples** .</span><span class="sxs-lookup"><span data-stu-id="2b2e4-138">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag.</span></span>
2.  <span data-ttu-id="2b2e4-139">Creare un pool di superfici DXVA, come descritto nella specifica DXVA.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-139">Create a pool of DXVA surfaces, as described in the DXVA specification.</span></span>
3.  <span data-ttu-id="2b2e4-140">Creare esempi di supporti chiamando [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span><span class="sxs-lookup"><span data-stu-id="2b2e4-140">Create media samples by calling [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span></span>

<span data-ttu-id="2b2e4-141">La MFT deve sempre supportare l'elaborazione software come fallback, perché l'elaborazione del DXVA potrebbe non essere disponibile, per diversi motivi:</span><span class="sxs-lookup"><span data-stu-id="2b2e4-141">The MFT should always support software processing as a fallback, because DXVA processing might not available, for several reasons:</span></span>

-   <span data-ttu-id="2b2e4-142">La GPU potrebbe non supportare DXVA.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-142">The GPU might not support DXVA.</span></span>
-   <span data-ttu-id="2b2e4-143">Il client potrebbe non usare Direct3D.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-143">The client might not use Direct3D.</span></span>
-   <span data-ttu-id="2b2e4-144">I profili DXVA non sono definiti per ogni formato video.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-144">DXVA profiles are not defined for every video format.</span></span>

<span data-ttu-id="2b2e4-145">Un MFT compatibile con Direct3D deve avere un singolo flusso di output.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-145">A Direct3D-aware MFT must have a single output stream.</span></span> <span data-ttu-id="2b2e4-146">Non può avere più output.</span><span class="sxs-lookup"><span data-stu-id="2b2e4-146">It cannot have multiple outputs.</span></span>

## <a name="related-topics"></a><span data-ttu-id="2b2e4-147">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="2b2e4-147">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="2b2e4-148">Scrittura di un MFT personalizzato</span><span class="sxs-lookup"><span data-stu-id="2b2e4-148">Writing a Custom MFT</span></span>](writing-a-custom-mft.md)
</dt> </dl>

 

 



