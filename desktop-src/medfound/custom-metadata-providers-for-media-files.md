---
description: In questo argomento viene descritto come scrivere un gestore di proprietà della shell personalizzato per un Microsoft Media Foundation origine multimediale.
ms.assetid: f8cf70ff-8324-4308-8adf-a145aa351ca9
title: Provider di metadati personalizzati per i file multimediali
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2ded77492d03f7b802f6b2f9c25e1009ef97f50
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/03/2021
ms.locfileid: "106320725"
---
# <a name="custom-metadata-providers-for-media-files"></a><span data-ttu-id="6caf1-103">Provider di metadati personalizzati per i file multimediali</span><span class="sxs-lookup"><span data-stu-id="6caf1-103">Custom Metadata Providers for Media Files</span></span>

<span data-ttu-id="6caf1-104">In questo argomento viene descritto come scrivere un gestore di proprietà della shell personalizzato per un Microsoft Media Foundation origine multimediale.</span><span class="sxs-lookup"><span data-stu-id="6caf1-104">This topic describes how to write a custom Shell property handler for a Microsoft Media Foundation media source.</span></span>

> [!Note]  
> <span data-ttu-id="6caf1-105">Per informazioni generali sui provider di metadati in Media Foundation, vedere [metadati del supporto](media-metadata.md).</span><span class="sxs-lookup"><span data-stu-id="6caf1-105">For background information about metadata providers in Media Foundation, see [Media Metadata](media-metadata.md).</span></span> <span data-ttu-id="6caf1-106">In questo argomento vengono illustrati i gestori delle proprietà della shell. non descrive l'interfaccia dei metadati della versione 1, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span><span class="sxs-lookup"><span data-stu-id="6caf1-106">This topic discusses Shell property handlers; it does not describe the version 1 metadata interface, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span></span>

 

<span data-ttu-id="6caf1-107">I metadati sono strettamente legati al formato del file.</span><span class="sxs-lookup"><span data-stu-id="6caf1-107">Metadata is closely tied to the format of the file.</span></span> <span data-ttu-id="6caf1-108">In Media Foundation i formati di file sono rappresentati da origini multimediali.</span><span class="sxs-lookup"><span data-stu-id="6caf1-108">In Media Foundation, file formats are represented by media sources.</span></span> <span data-ttu-id="6caf1-109">Se si desidera supportare i metadati per un formato non supportato in modo nativo in Media Foundation, è necessario implementare un'origine multimediale personalizzata con un gestore proprietà.</span><span class="sxs-lookup"><span data-stu-id="6caf1-109">If you want to support metadata for a format that is not supported natively in Media Foundation, you must implement a custom media source with a property handler.</span></span> <span data-ttu-id="6caf1-110">Il gestore proprietà consente al sistema di proprietà della shell di leggere e scrivere i metadati in modo efficiente.</span><span class="sxs-lookup"><span data-stu-id="6caf1-110">The property handler enables the Shell property system to read and write metadata efficiently.</span></span>

<span data-ttu-id="6caf1-111">Un gestore proprietà è un oggetto COM che implementa le interfacce seguenti:</span><span class="sxs-lookup"><span data-stu-id="6caf1-111">A property handler is a COM object that implements the following interfaces:</span></span>

-   [<span data-ttu-id="6caf1-112">**IInitializeWithStream**</span><span class="sxs-lookup"><span data-stu-id="6caf1-112">**IInitializeWithStream**</span></span>](/windows/win32/api/propsys/nn-propsys-iinitializewithstream)
-   [<span data-ttu-id="6caf1-113">**IPropertyStore**</span><span class="sxs-lookup"><span data-stu-id="6caf1-113">**IPropertyStore**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystore)

<span data-ttu-id="6caf1-114">Facoltativamente, può anche esporre l'interfaccia seguente:</span><span class="sxs-lookup"><span data-stu-id="6caf1-114">Optionally, it can also expose the following interface:</span></span>

-   [<span data-ttu-id="6caf1-115">**IPropertyStoreCapabilities**</span><span class="sxs-lookup"><span data-stu-id="6caf1-115">**IPropertyStoreCapabilities**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystorecapabilities)

<span data-ttu-id="6caf1-116">Se il sistema di proprietà della shell deve ottenere i metadati per un file, chiama [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) per creare il gestore della proprietà, quindi chiama i metodi di lettura e scrittura appropriati sull'interfaccia [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) .</span><span class="sxs-lookup"><span data-stu-id="6caf1-116">If the Shell property system needs to get metadata for a file, it calls [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler and then calls the appropriate read and write methods on the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface.</span></span>

<span data-ttu-id="6caf1-117">La pipeline Media Foundation usa un meccanismo leggermente diverso, perché la pipeline ottiene il gestore della proprietà direttamente dall'origine multimediale.</span><span class="sxs-lookup"><span data-stu-id="6caf1-117">The Media Foundation pipeline uses a slightly different mechanism, because the pipeline gets the property handler directly from the media source.</span></span> <span data-ttu-id="6caf1-118">Anziché chiamare [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) per creare il gestore della proprietà, la pipeline chiama [**IMFGetService:: GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) nell'origine del supporto, come descritto nell'argomento [provider di metadati della shell](shell-metadata-providers.md).</span><span class="sxs-lookup"><span data-stu-id="6caf1-118">Instead of calling [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler, the pipeline calls [**IMFGetService::GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) on the media source, as described in the topic [Shell Metadata Providers](shell-metadata-providers.md).</span></span>

<span data-ttu-id="6caf1-119">Per creare un gestore di proprietà personalizzato, eseguire le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="6caf1-119">To create a custom property handler, do the following:</span></span>

-   <span data-ttu-id="6caf1-120">Implementare l'interfaccia [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) per esporre [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span><span class="sxs-lookup"><span data-stu-id="6caf1-120">Implement the [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) interface to expose [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span></span> <span data-ttu-id="6caf1-121">Il GUID del servizio è il **\_ servizio del \_ gestore \_ delle proprietà MF**.</span><span class="sxs-lookup"><span data-stu-id="6caf1-121">The service GUID is **MF\_PROPERTY\_HANDLER\_SERVICE**.</span></span>
-   <span data-ttu-id="6caf1-122">Se l'origine supporto verrà usata in modalità remota, deve anche esporre l'interfaccia [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) tramite il metodo **QueryInterface** dell'origine multimediale, oltre a [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span><span class="sxs-lookup"><span data-stu-id="6caf1-122">If the media source will be used remotely, it must also expose the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface through the media source's **QueryInterface** method, in addition to [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span></span>
-   <span data-ttu-id="6caf1-123">Per rendere disponibile il gestore delle proprietà per il sistema di proprietà della shell, registrare la DLL per il gestore della proprietà come descritto in [registrazione e distribuzione dei gestori di proprietà](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="6caf1-123">To make the property handler available to the Shell property system, register the DLL for the property handler as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>
-   <span data-ttu-id="6caf1-124">L'origine multimediale viene registrata separatamente, come descritto in [gestori di schemi e gestori di Byte-Stream](scheme-handlers-and-byte-stream-handlers.md).</span><span class="sxs-lookup"><span data-stu-id="6caf1-124">The media source is registered separately, as described in [Scheme Handlers and Byte-Stream Handlers](scheme-handlers-and-byte-stream-handlers.md).</span></span>

### <a name="implementation-tips"></a><span data-ttu-id="6caf1-125">Suggerimenti per l'implementazione</span><span class="sxs-lookup"><span data-stu-id="6caf1-125">Implementation Tips</span></span>

<span data-ttu-id="6caf1-126">Per un elenco di chiavi di proprietà dei metadati, vedere [proprietà dei metadati per i file multimediali](metadata-properties-for-media-files.md).</span><span class="sxs-lookup"><span data-stu-id="6caf1-126">For a list of metadata property keys, see [Metadata Properties for Media Files](metadata-properties-for-media-files.md).</span></span>

<span data-ttu-id="6caf1-127">I gestori di proprietà devono essere veloci; devono fornire un accesso in lettura e scrittura efficiente ai metadati.</span><span class="sxs-lookup"><span data-stu-id="6caf1-127">Property handlers must be fast; they must provide efficient read and write access to the metadata.</span></span> <span data-ttu-id="6caf1-128">(Si consideri che la shell può recuperare i metadati da centinaia di file). Pertanto, non chiamare [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) dal gestore della proprietà.</span><span class="sxs-lookup"><span data-stu-id="6caf1-128">(Consider that the Shell may retrieve metadata from hundreds of files.) Therefore, do not call [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) from your property handler.</span></span> <span data-ttu-id="6caf1-129">La funzione **MFStartup** introduce la latenza di avvio, perché crea più thread della coda di lavoro e alloca memoria globale.</span><span class="sxs-lookup"><span data-stu-id="6caf1-129">The **MFStartup** function introduces startup latency, because it creates multiple work-queue threads and allocates global memory.</span></span>

<span data-ttu-id="6caf1-130">In un'implementazione tipica, il gestore della proprietà e l'origine multimediale condividono parte dello stesso codice di analisi.</span><span class="sxs-lookup"><span data-stu-id="6caf1-130">In a typical implementation, the property handler and the media source will share some of the same parsing code.</span></span> <span data-ttu-id="6caf1-131">Tuttavia, un'origine multimediale usa le chiamate [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) asincrone per i/O, mentre il gestore delle proprietà usa l'interfaccia [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) .</span><span class="sxs-lookup"><span data-stu-id="6caf1-131">However, a media source uses asynchronous [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) calls for I/O, whereas the property handler uses the [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="6caf1-132">Media Foundation fornisce un oggetto helper che esegue il wrapping di un flusso basato su **IStream** e lo espone come flusso **IMFByteStream** .</span><span class="sxs-lookup"><span data-stu-id="6caf1-132">Media Foundation provides a helper object that wraps an **IStream**-based stream and exposes it as an **IMFByteStream** stream.</span></span> <span data-ttu-id="6caf1-133">Per creare il wrapper, chiamare [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span><span class="sxs-lookup"><span data-stu-id="6caf1-133">To create the wrapper, call [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span></span>

<span data-ttu-id="6caf1-134">Quando si aggiornano i metadati, è consigliabile scrivere i dati direttamente nel flusso originale.</span><span class="sxs-lookup"><span data-stu-id="6caf1-134">When updating metadata, it is recommended to write the data directly to the original stream.</span></span> <span data-ttu-id="6caf1-135">Questa raccomandazione differisce dal comportamento di *copia su scrittura* della maggior parte dei gestori di proprietà, in cui una copia dei dati viene modificata.</span><span class="sxs-lookup"><span data-stu-id="6caf1-135">This recommendation differs from the *copy-on-write* behavior of most property handlers, in which a copy of the data is modified.</span></span> <span data-ttu-id="6caf1-136">I file multimediali possono essere molto grandi, quindi la copia in scrittura è in genere troppo lenta per un'implementazione efficiente.</span><span class="sxs-lookup"><span data-stu-id="6caf1-136">Media files can be very large, so copy-on-write is typically too slow for an efficient implementation.</span></span> <span data-ttu-id="6caf1-137">Per disabilitare la copia in scrittura, impostare l'impostazione del registro di sistema **ManualSafeSave** , come descritto in [registrazione e distribuzione di gestori di proprietà](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="6caf1-137">To disable copy-on-write, set the **ManualSafeSave** registry setting, as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="6caf1-138">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="6caf1-138">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="6caf1-139">Metadati del supporto</span><span class="sxs-lookup"><span data-stu-id="6caf1-139">Media Metadata</span></span>](media-metadata.md)
</dt> <dt>

[<span data-ttu-id="6caf1-140">Origini supporti</span><span class="sxs-lookup"><span data-stu-id="6caf1-140">Media Sources</span></span>](media-sources.md)
</dt> <dt>

[<span data-ttu-id="6caf1-141">Scrittura di un'origine multimediale personalizzata</span><span class="sxs-lookup"><span data-stu-id="6caf1-141">Writing a Custom Media Source</span></span>](writing-a-custom-media-source.md)
</dt> </dl>

 

 
