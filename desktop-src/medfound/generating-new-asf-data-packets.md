---
description: Generazione di nuovi pacchetti di dati ASF
ms.assetid: 7afa9694-c965-40e2-8549-e32ff48def2a
title: Generazione di nuovi pacchetti di dati ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78f3432ecf34c58247a1533adb202b75f59d770c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104484069"
---
# <a name="generating-new-asf-data-packets"></a><span data-ttu-id="56aa6-103">Generazione di nuovi pacchetti di dati ASF</span><span class="sxs-lookup"><span data-stu-id="56aa6-103">Generating New ASF Data Packets</span></span>

<span data-ttu-id="56aa6-104">Il *multiplexing* ASF è un componente di livello WMContainer che funziona con l' [oggetto dati ASF](asf-file-structure.md) e fornisce a un'applicazione la possibilità di generare pacchetti di dati ASF per un flusso che soddisfano i requisiti definiti nell'oggetto ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="56aa6-104">The ASF *multiplexer* is a WMContainer layer component that works with the [ASF Data Object](asf-file-structure.md) and gives an application the ability to generate ASF data packets for a stream that match the requirements defined in the ContentInfo object.</span></span>

<span data-ttu-id="56aa6-105">Multiplexer include un input e un output.</span><span class="sxs-lookup"><span data-stu-id="56aa6-105">The multiplexer has one input and one output.</span></span> <span data-ttu-id="56aa6-106">Riceve un esempio di flusso contenente dati multimediali digitali e produce uno o più pacchetti di dati che possono essere scritti in un contenitore ASF.</span><span class="sxs-lookup"><span data-stu-id="56aa6-106">It receives a stream sample that contains digital media data and produces one or more data packet that can be written to an ASF container.</span></span>

<span data-ttu-id="56aa6-107">Nell'elenco seguente viene riepilogato il processo di generazione dei pacchetti di dati ASF:</span><span class="sxs-lookup"><span data-stu-id="56aa6-107">The following list summarizes the process of generating ASF data packets:</span></span>

1.  <span data-ttu-id="56aa6-108">Passare i dati di input al multiplexer in [**IMFASFMultiplexer::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="56aa6-108">Pass input data to the multiplexer in [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>
2.  <span data-ttu-id="56aa6-109">Raccogliere i pacchetti di dati chiamando [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in un ciclo fino a quando non vengono recuperati tutti i pacchetti completi.</span><span class="sxs-lookup"><span data-stu-id="56aa6-109">Collect the data packets by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until all the complete packets have been retrieved.</span></span>
3.  <span data-ttu-id="56aa6-110">Dopo che i dati di input sono stati convertiti in pacchetti completi potrebbero essere presenti alcuni dati in sospeso nel multiplexer, che non è stato recuperato da [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="56aa6-110">After the input data has been converted into complete packets there might be some pending data in the multiplexer, which was not retrieved by [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="56aa6-111">Chiamare [**IMFASFMultiplexer:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) per packetize gli esempi in sospeso e raccoglierli dal multiplexer chiamando di nuovo **GetNextPacket** .</span><span class="sxs-lookup"><span data-stu-id="56aa6-111">Call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) to packetize the pending samples and collect them from the multiplexer by calling **GetNextPacket** again.</span></span>
4.  <span data-ttu-id="56aa6-112">Aggiornare gli oggetti intestazione ASF associati chiamando [**IMFASFMultiplexer:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) per riflettere le modifiche apportate dal multiplexer durante la generazione del pacchetto di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-112">Update the associated ASF Header Objects by calling [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to reflect changes made by the multiplexer during data packet generation.</span></span>

<span data-ttu-id="56aa6-113">Il diagramma seguente illustra la generazione di pacchetti di dati per un file ASF tramite multiplexer.</span><span class="sxs-lookup"><span data-stu-id="56aa6-113">The following diagram illustrates data packet generation for an ASF file through the multiplexer.</span></span>

![diagramma che mostra la generazione di pacchetti di dati per un file ASF](images/packet.gif)

## <a name="asf-data-packet-creation"></a><span data-ttu-id="56aa6-115">Creazione di pacchetti di dati ASF</span><span class="sxs-lookup"><span data-stu-id="56aa6-115">ASF Data Packet Creation</span></span>

<span data-ttu-id="56aa6-116">Dopo la creazione e l'inizializzazione del multiplexer come descritto in [creazione dell'oggetto multiplexer](creating-the-multiplexer-object.md), chiamare [**IMFASFMultiplexer::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) per passare i dati di input al multiplexer per l'elaborazione nei pacchetti di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-116">After creating and initializing the multiplexer as described in [Creating the Multiplexer Object](creating-the-multiplexer-object.md), call [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) to pass input data to the multiplexer for processing into data packets.</span></span> <span data-ttu-id="56aa6-117">L'input specificato deve trovarsi in un esempio di supporto (interfaccia [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) ) che può avere uno o più buffer multimediali (interfaccia [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) ) che contengono i dati per un flusso.</span><span class="sxs-lookup"><span data-stu-id="56aa6-117">The specified input must be in a media sample ([**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface) that can have one or more media buffers ([**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface) containing the data for a stream.</span></span> <span data-ttu-id="56aa6-118">Nel caso di una transcodifica da ASF ad ASF, l'esempio di supporti di input può essere generato dalla barra di divisione che crea esempi di flussi in pacchetti.</span><span class="sxs-lookup"><span data-stu-id="56aa6-118">In case of ASF-to-ASF transcoding, the input media sample can be generated from the splitter that creates packetized stream samples.</span></span> <span data-ttu-id="56aa6-119">Per ulteriori informazioni, vedere la [barra di divisione ASF](asf-splitter.md).</span><span class="sxs-lookup"><span data-stu-id="56aa6-119">For more information, see [ASF Splitter](asf-splitter.md).</span></span>

<span data-ttu-id="56aa6-120">Prima di chiamare [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), verificare che il timestamp dell'esempio di supporti di input sia un tempo di presentazione valido. in caso contrario **ProcessSample** ha esito negativo e restituisce il \_ codice di timestamp MF e \_ nessun \_ esempio \_ .</span><span class="sxs-lookup"><span data-stu-id="56aa6-120">Before calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), make sure that the time stamp of the input media sample is a valid presentation time; otherwise **ProcessSample** fails and returns the MF\_E\_NO\_SAMPLE\_TIMESTAMP code.</span></span>

<span data-ttu-id="56aa6-121">Il multiplexer può accettare l'input come esempio di supporti compressi o non compressi tramite [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="56aa6-121">The multiplexer can accept input as compressed or uncompressed media samples through [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span> <span data-ttu-id="56aa6-122">Il multiplexer assegna i tempi di invio a questi esempi a seconda dell'utilizzo della larghezza di banda del flusso.</span><span class="sxs-lookup"><span data-stu-id="56aa6-122">The multiplexer assigns send times to these samples depending on the bandwidth usage of the stream.</span></span> <span data-ttu-id="56aa6-123">Durante questo processo, il multiplexer controlla i parametri di bucket persi (velocità in bit e utilizzo della finestra del buffer) e può rifiutare campioni che non rispettano tali valori.</span><span class="sxs-lookup"><span data-stu-id="56aa6-123">During this process, the multiplexer checks the leaky bucket parameters (bit rate and buffer window utilization) and can reject samples that do not adhere to those values.</span></span> <span data-ttu-id="56aa6-124">L'esempio di supporti di input può non riuscire a controllare la larghezza di banda per uno dei seguenti motivi:</span><span class="sxs-lookup"><span data-stu-id="56aa6-124">The input media sample can fail the bandwidth check for either of the following reasons:</span></span>

-   <span data-ttu-id="56aa6-125">Se l'esempio di supporti di input è arrivato in ritardo perché il tempo di invio assegnato per ultimo è maggiore del timestamp di questo esempio multimediale.</span><span class="sxs-lookup"><span data-stu-id="56aa6-125">If the input media sample arrived late because the last-assigned send time is greater than the time stamp on this media sample.</span></span> <span data-ttu-id="56aa6-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) ha esito negativo e restituisce il codice di errore di **\_ esempio MF e \_ tardivo \_** .</span><span class="sxs-lookup"><span data-stu-id="56aa6-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_LATE\_SAMPLE** error code.</span></span>
-   <span data-ttu-id="56aa6-127">Se il timestamp dell'esempio di supporti di input è precedente all'ora di invio assegnata (indica l'overflow del buffer).</span><span class="sxs-lookup"><span data-stu-id="56aa6-127">If the time stamp on the input media sample is earlier than the assigned send time (this indicates buffer overflow).</span></span> <span data-ttu-id="56aa6-128">Il multiplexer può ignorare questa situazione se è configurata per regolare la velocità in bit impostando il flag **MFASF \_ multiplexer \_ AutoAdjust \_ bitrate** durante l'inizializzazione del multiplexer.</span><span class="sxs-lookup"><span data-stu-id="56aa6-128">The multiplexer can ignore this situation if it is configured to adjust the bit rate by setting the **MFASF\_MULTIPLEXER\_AUTOADJUST\_BITRATE** flag during multiplexer initialization.</span></span> <span data-ttu-id="56aa6-129">Per ulteriori informazioni, vedere l'argomento relativo all'inizializzazione del multiplexer e alle impostazioni dei bucket persi nella [creazione dell'oggetto multiplexer](creating-the-multiplexer-object.md).</span><span class="sxs-lookup"><span data-stu-id="56aa6-129">For more information, see "Multiplexer Initialization and Leaky Bucket Settings" in [Creating the Multiplexer Object](creating-the-multiplexer-object.md).</span></span> <span data-ttu-id="56aa6-130">Se questo flag non è impostato e il multiplexer rileva un sovraccarico della larghezza di banda, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) ha esito negativo e restituisce il codice di errore di **sovraccarico della larghezza di \_ \_ banda \_ MF** e.</span><span class="sxs-lookup"><span data-stu-id="56aa6-130">If this flag is not set and the multiplexer encounters bandwidth overrun, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_BANDWIDTH\_OVERRUN** error code.</span></span>

<span data-ttu-id="56aa6-131">Quando il multiplexer assegna l'ora di invio, l'esempio di supporto di input viene aggiunto alla *finestra di trasmissione*, ovvero un elenco di esempi di supporti di input ordinati in base ai tempi di invio e pronti per essere elaborati nei pacchetti di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-131">After the multiplexer assigns the send time, the input media sample is added to the *send window*—a list of input media samples ordered by send times and ready to be processed into data packets.</span></span> <span data-ttu-id="56aa6-132">Durante la creazione di pacchetti di dati, l'esempio di supporti di input viene analizzato e i dati rilevanti vengono scritti in un pacchetto di dati come payload.</span><span class="sxs-lookup"><span data-stu-id="56aa6-132">During data packet construction, the input media sample is parsed and relevant data is written to a data packet as payload.</span></span> <span data-ttu-id="56aa6-133">Un pacchetto di dati completo può contenere dati di uno o più esempi di supporti di input.</span><span class="sxs-lookup"><span data-stu-id="56aa6-133">A complete data packet can contain data from one or more input media samples.</span></span>

<span data-ttu-id="56aa6-134">Quando arrivano nuovi esempi di supporti di input nella finestra di trasmissione, vengono aggiunti a una coda finché non sono disponibili sufficienti esempi di supporti per formare un pacchetto completo.</span><span class="sxs-lookup"><span data-stu-id="56aa6-134">When new input media samples arrive in the send window, they are added to a queue until there are enough media samples to form one complete packet.</span></span> <span data-ttu-id="56aa6-135">I dati nei buffer multimediali contenuti nell'esempio di supporto di input non vengono copiati nel pacchetto di dati generato.</span><span class="sxs-lookup"><span data-stu-id="56aa6-135">The data in media buffers contained by the input media sample are not copied to the generated data packet.</span></span> <span data-ttu-id="56aa6-136">Il pacchetto di dati contiene riferimenti ai buffer del supporto di input fino a quando l'esempio di file multimediale di input non è stato completamente sottoposto a pacchetti e il pacchetto completo è stato raccolto dal multiplexer.</span><span class="sxs-lookup"><span data-stu-id="56aa6-136">The data packet hold references to the input media buffers until the input media sample has been fully packetized and the complete packet have been collected from the multiplexer.</span></span>

<span data-ttu-id="56aa6-137">Quando è disponibile un pacchetto di dati completo, può essere recuperato chiamando [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="56aa6-137">When a complete data packet is available, it can be retrieved by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="56aa6-138">Se si chiama [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) mentre sono presenti pacchetti completi pronti per il recupero, l'operazione ha esito negativo e restituisce il codice di errore **MF \_ e \_ NOTACCEPTING** .</span><span class="sxs-lookup"><span data-stu-id="56aa6-138">If you call [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) while there are complete packets ready for retrieval, it fails and returns the **MF\_E\_NOTACCEPTING** error code.</span></span> <span data-ttu-id="56aa6-139">Ciò indica che il multiplexer non può accettare più input ed è necessario chiamare **GetNextPacket** per recuperare i pacchetti in attesa.</span><span class="sxs-lookup"><span data-stu-id="56aa6-139">This indicates that the multiplexer cannot accept more input and you must call **GetNextPacket** to retrieve the waiting packets.</span></span> <span data-ttu-id="56aa6-140">Idealmente, ogni chiamata a **ProcessSample** deve essere seguita da una o più chiamate **GetNextPacket** per ottenere i pacchetti di dati completi.</span><span class="sxs-lookup"><span data-stu-id="56aa6-140">Ideally, every **ProcessSample** call should be followed by one or more **GetNextPacket** calls to get the complete data packets.</span></span> <span data-ttu-id="56aa6-141">Per creare un pacchetto di dati completo, potrebbe essere necessario più di un esempio di file multimediale di input.</span><span class="sxs-lookup"><span data-stu-id="56aa6-141">It may take more than one input media sample to create a complete data packet.</span></span> <span data-ttu-id="56aa6-142">Viceversa, i dati in un esempio di supporti di input possono estendersi su più pacchetti.</span><span class="sxs-lookup"><span data-stu-id="56aa6-142">Conversely, data in one input media sample might span multiple packets.</span></span> <span data-ttu-id="56aa6-143">Di conseguenza, non tutte le chiamate a **ProcessSample** produrranno esempi di supporti di output.</span><span class="sxs-lookup"><span data-stu-id="56aa6-143">Therefore, not all calls to **ProcessSample** will yield output media samples.</span></span>

<span data-ttu-id="56aa6-144">Se l'esempio multimediale di input contiene un fotogramma chiave indicato dall'attributo [**\_ CleanPoint di MFSampleExtension**](mfsampleextension-cleanpoint-attribute.md) , il multiplexer copia l'attributo nel pacchetto.</span><span class="sxs-lookup"><span data-stu-id="56aa6-144">If the input media sample contains a key frame indicated by the [**MFSampleExtension\_CleanPoint**](mfsampleextension-cleanpoint-attribute.md) attribute, the multiplexer copies the attribute to the packet.</span></span>

## <a name="getting-asf-data-packets"></a><span data-ttu-id="56aa6-145">Recupero di pacchetti di dati ASF</span><span class="sxs-lookup"><span data-stu-id="56aa6-145">Getting ASF Data Packets</span></span>

<span data-ttu-id="56aa6-146">Per raccogliere gli esempi di supporti di output per un pacchetto di dati completo generato dal multiplexer, chiamare [**IMFASFMultiplexer:: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in un ciclo fino a quando non sono presenti altri esempi di supporti di output rimasti per il pacchetto.</span><span class="sxs-lookup"><span data-stu-id="56aa6-146">To collect the output media samples for a complete data packet generated by the multiplexer, call [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until there are no more output media samples left for the packet.</span></span> <span data-ttu-id="56aa6-147">Di seguito sono elencati i casi di esito positivo:</span><span class="sxs-lookup"><span data-stu-id="56aa6-147">The following lists the success cases:</span></span>

-   <span data-ttu-id="56aa6-148">Se è disponibile un pacchetto di dati completo, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) riceve il flag di **\_ stato ASF \_ \_ incompleto** nel parametro *pdwStatusFlags* , mentre il parametro *ppIPacket* riceve un puntatore al primo pacchetto di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-148">If there is a complete data packet available, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) receives the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag in the *pdwStatusFlags* parameter; the *ppIPacket* parameter receives a pointer to the first data packet.</span></span> <span data-ttu-id="56aa6-149">È necessario chiamare questo metodo finché riceve questo flag.</span><span class="sxs-lookup"><span data-stu-id="56aa6-149">You must call this method as long it receives this flag.</span></span> <span data-ttu-id="56aa6-150">Con ogni iterazione, *ppIPacket* punta al pacchetto successivo nella coda.</span><span class="sxs-lookup"><span data-stu-id="56aa6-150">With every iteration, *ppIPacket* points to the next packet in the queue.</span></span>
-   <span data-ttu-id="56aa6-151">Se è presente un solo pacchetto di dati, *ppIPacket* fa riferimento a tale pacchetto e il flag di **\_ stato ASF \_ \_ incompleto** non è stato ricevuto in *pdwStatusFlags*.</span><span class="sxs-lookup"><span data-stu-id="56aa6-151">If there is only one data packet, *ppIPacket* points to it and the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag is not received in *pdwStatusFlags*.</span></span>
-   <span data-ttu-id="56aa6-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) può avere esito positivo senza produrre pacchetti di dati se il multiplexer è ancora in fase di packetizing e aggiunge pacchetti di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) can succeed without yielding any data packets if the multiplexer is still in the process of packetizing and adding data packets.</span></span> <span data-ttu-id="56aa6-153">In questo caso, *ppIPacket* punta a **null**.</span><span class="sxs-lookup"><span data-stu-id="56aa6-153">In this case, *ppIPacket* points to **NULL**.</span></span> <span data-ttu-id="56aa6-154">Per continuare, è necessario fornire al multiplexer più esempi di supporti di input chiamando [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="56aa6-154">To proceed, you must provide the multiplexer with more input media samples by calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>

<span data-ttu-id="56aa6-155">Nell'esempio di codice seguente viene illustrata una funzione che genera pacchetti di dati tramite multiplexer.</span><span class="sxs-lookup"><span data-stu-id="56aa6-155">The following example code shows a function that generates data packets by using the multiplexer.</span></span> <span data-ttu-id="56aa6-156">Il contenuto del pacchetto di dati generato verrà scritto nel flusso di byte dei dati allocato dal chiamante.</span><span class="sxs-lookup"><span data-stu-id="56aa6-156">The generated data packet contents will be written to the data byte stream allocated by the caller.</span></span>


```C++
//-------------------------------------------------------------------
// GenerateASFDataPackets
// 
// Gets data packets from the mux. This function is called after 
// calling IMFASFMultiplexer::ProcessSample. 
//-------------------------------------------------------------------

HRESULT GenerateASFDataPackets( 
    IMFASFMultiplexer *pMux, 
    IMFByteStream *pDataStream
    )
{
    HRESULT hr = S_OK;

    IMFSample *pOutputSample = NULL;
    IMFMediaBuffer *pDataPacketBuffer = NULL;

    DWORD dwMuxStatus = ASF_STATUSFLAGS_INCOMPLETE;

    while (dwMuxStatus & ASF_STATUSFLAGS_INCOMPLETE)
    {
        hr = pMux->GetNextPacket(&dwMuxStatus, &pOutputSample);

        if (FAILED(hr))
        {
            break;
        }

        if (pOutputSample)
        {
            //Convert to contiguous buffer
            hr = pOutputSample->ConvertToContiguousBuffer(&pDataPacketBuffer);
            
            if (FAILED(hr))
            {
                break;
            }

            //Write buffer to byte stream
            hr = WriteBufferToByteStream(pDataStream, pDataPacketBuffer, NULL);

            if (FAILED(hr))
            {
                break;
            }
        }

        SafeRelease(&pDataPacketBuffer);
        SafeRelease(&pOutputSample);
    }

    SafeRelease(&pOutputSample);
    SafeRelease(&pDataPacketBuffer);
    return hr;
}
```



<span data-ttu-id="56aa6-157">La `WriteBufferToByteStream` funzione è illustrata nell'argomento [**IMFByteStream:: Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span><span class="sxs-lookup"><span data-stu-id="56aa6-157">The `WriteBufferToByteStream` function is shown in the topic [**IMFByteStream::Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span></span>

<span data-ttu-id="56aa6-158">Per visualizzare un'applicazione completa che usa questo esempio di codice, vedere [esercitazione: copia di flussi ASF da un file a un altro](tutorial--copying-asf-streams-from-one-file-to-another.md).</span><span class="sxs-lookup"><span data-stu-id="56aa6-158">To see a complete application that uses this code example, see [Tutorial: Copying ASF Streams from One File to Another](tutorial--copying-asf-streams-from-one-file-to-another.md).</span></span>

## <a name="post-packet-generation-calls"></a><span data-ttu-id="56aa6-159">Chiamate di post Packet-Generation</span><span class="sxs-lookup"><span data-stu-id="56aa6-159">Post Packet-Generation Calls</span></span>

<span data-ttu-id="56aa6-160">Per assicurarsi che non siano presenti pacchetti di dati completi in attesa nel multiplexer, chiamare [**IMFASFMultiplexer:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span><span class="sxs-lookup"><span data-stu-id="56aa6-160">To make sure that there are no complete data packets waiting in the multiplexer, call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span></span> <span data-ttu-id="56aa6-161">In questo modo, il multiplexer packetize tutti gli esempi di supporti in corso.</span><span class="sxs-lookup"><span data-stu-id="56aa6-161">This forces the multiplexer to packetize all the media samples that are in progress.</span></span> <span data-ttu-id="56aa6-162">L'applicazione può raccogliere questi pacchetti sotto forma di esempi di supporti tramite **GetNextPacket** in un ciclo fino a quando non sono presenti altri pacchetti da recuperare.</span><span class="sxs-lookup"><span data-stu-id="56aa6-162">The application can collect these packets in form of media samples through **GetNextPacket** in a loop until there are no more packets left to be retrieved.</span></span>

<span data-ttu-id="56aa6-163">Una volta generati tutti gli esempi di supporti, chiamare [**IMFASFMultiplexer:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) per aggiornare l'oggetto intestazione ASF associato a questi pacchetti di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-163">After all the media samples are generated, call [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to update the ASF Header Object that is associated with these data packets.</span></span> <span data-ttu-id="56aa6-164">L'oggetto Header viene specificato passando l'oggetto ContentInfo utilizzato per inizializzare il multiplexer.</span><span class="sxs-lookup"><span data-stu-id="56aa6-164">The Header Object is specified by passing the ContentInfo object that was used to initialize the multiplexer.</span></span> <span data-ttu-id="56aa6-165">Questa chiamata Aggiorna vari oggetti intestazione in modo da riflettere le modifiche apportate dal multiplexer durante la generazione del pacchetto di dati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-165">This call updates various Header Objects to reflect changes made by the multiplexer during data packet generation.</span></span> <span data-ttu-id="56aa6-166">Queste informazioni includono il numero di pacchetti, la durata di invio, la durata della riproduzione e i numeri di flusso di tutti i flussi.</span><span class="sxs-lookup"><span data-stu-id="56aa6-166">This information includes packet count, send duration, play duration, and stream numbers of all the streams.</span></span> <span data-ttu-id="56aa6-167">Viene aggiornata anche la dimensione complessiva dell'intestazione.</span><span class="sxs-lookup"><span data-stu-id="56aa6-167">The overall header size is also updated.</span></span>

<span data-ttu-id="56aa6-168">È necessario assicurarsi che [**end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) venga chiamato dopo che tutti i pacchetti di dati sono stati recuperati.</span><span class="sxs-lookup"><span data-stu-id="56aa6-168">You must ensure that [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) is called after all the data packets have been retrieved.</span></span> <span data-ttu-id="56aa6-169">Se sono presenti pacchetti in attesa nel multiplexer, **end** avrà esito negativo e restituirà il codice di errore **MF \_ e \_ Flush \_ necessario** .</span><span class="sxs-lookup"><span data-stu-id="56aa6-169">If there are any packets waiting in the multiplexer, **End** will fail and return the **MF\_E\_FLUSH\_NEEDED** error code.</span></span> <span data-ttu-id="56aa6-170">In questo caso, recuperare il pacchetto in attesa chiamando [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) e [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in un ciclo.</span><span class="sxs-lookup"><span data-stu-id="56aa6-170">In this case, get the waiting packet by calling [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) and [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop.</span></span>

> [!Note]  
> <span data-ttu-id="56aa6-171">Per la codifica VBR, dopo aver chiamato **end** è necessario impostare le statistiche di codifica nelle proprietà di codifica dell'oggetto ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="56aa6-171">For VBR encoding, after calling **End**, you must set the encoding statistics in the ContentInfo object's encoding properties.</span></span> <span data-ttu-id="56aa6-172">Per informazioni su questo processo, vedere "configurazione dell'oggetto ContentInfo con le impostazioni del codificatore" in [impostazione delle proprietà nell'oggetto ContentInfo](setting-properties-in-the-contentinfo-object.md).</span><span class="sxs-lookup"><span data-stu-id="56aa6-172">For information about this process, see "Configuring the ContentInfo Object with Encoder Settings" in [Setting Properties in the ContentInfo Object](setting-properties-in-the-contentinfo-object.md).</span></span> <span data-ttu-id="56aa6-173">Nell'elenco seguente vengono illustrate le proprietà specifiche da impostare:</span><span class="sxs-lookup"><span data-stu-id="56aa6-173">The following list shows the specific properties to set:</span></span>
>
> -   <span data-ttu-id="56aa6-174">[**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md) è la velocità in bit media del contenuto VBR.</span><span class="sxs-lookup"><span data-stu-id="56aa6-174">[**MFPKEY\_RAVG**](mfpkey-ravgproperty.md) is the average bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="56aa6-175">[**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md) è la finestra del buffer per la velocità in bit media.</span><span class="sxs-lookup"><span data-stu-id="56aa6-175">[**MFPKEY\_BAVG**](mfpkey-bavgproperty.md) is the buffer window for the average bit rate.</span></span>
> -   <span data-ttu-id="56aa6-176">[**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md) è la velocità in bit massima del contenuto VBR.</span><span class="sxs-lookup"><span data-stu-id="56aa6-176">[**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md) is the peak bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="56aa6-177">[**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) è la finestra del buffer di picco.</span><span class="sxs-lookup"><span data-stu-id="56aa6-177">[**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) is the peak buffer window.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="56aa6-178">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="56aa6-178">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="56aa6-179">Multiplexer ASF</span><span class="sxs-lookup"><span data-stu-id="56aa6-179">ASF Multiplexer</span></span>](asf-multiplexer.md)
</dt> <dt>

[<span data-ttu-id="56aa6-180">Esercitazione: copia di flussi ASF da un file a un altro</span><span class="sxs-lookup"><span data-stu-id="56aa6-180">Tutorial: Copying ASF Streams from One File to Another</span></span>](tutorial--copying-asf-streams-from-one-file-to-another.md)
</dt> <dt>

[<span data-ttu-id="56aa6-181">Esercitazione: scrittura di un file WMA usando la codifica CBR</span><span class="sxs-lookup"><span data-stu-id="56aa6-181">Tutorial: Writing a WMA File by Using CBR Encoding</span></span>](tutorial--writing-a-wma-file-by-using-cbr-encoding.md)
</dt> </dl>

 

 



