---
description: Un provider è una DLL di prestazioni che fornisce ai clienti i dati del contatore.
ms.assetid: bbb777fe-b97e-4777-b797-ec8525065610
title: Creazione di una DLL di estensione prestazioni
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d397f1581454aca1b25c447b35f250eefd215f57
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "103881769"
---
# <a name="creating-a-performance-extension-dll"></a><span data-ttu-id="0450d-103">Creazione di una DLL di estensione prestazioni</span><span class="sxs-lookup"><span data-stu-id="0450d-103">Creating a Performance Extension DLL</span></span>

> [!IMPORTANT]
> <span data-ttu-id="0450d-104">A causa di limitazioni significative in merito a prestazioni e affidabilità, il metodo per fornire i dati dei contatori delle prestazioni descritti in questo argomento può essere modificato o non disponibile in futuro.</span><span class="sxs-lookup"><span data-stu-id="0450d-104">Due to significant performance and reliability limitations, the method for providing performance counter data that this topic describes may be altered or unavailable in the future.</span></span> <span data-ttu-id="0450d-105">Microsoft consiglia invece di usare il metodo descritto in [fornire i dati del contatore usando la versione 2,0](providing-counter-data-using-version-2-0.md) per creare nuovi contatori delle prestazioni e migrare i contatori delle prestazioni esistenti per usare anche tale metodo.</span><span class="sxs-lookup"><span data-stu-id="0450d-105">Instead, Microsoft recommends that you use the method described in [Providing Counter Data Using Version 2.0](providing-counter-data-using-version-2-0.md) for creating new performance counters and that you migrate existing performance counters to use that method as well.</span></span>

<span data-ttu-id="0450d-106">Un [provider v1](providing-counter-data.md) utilizza una DLL di prestazioni che fornisce ai clienti dati del contatore.</span><span class="sxs-lookup"><span data-stu-id="0450d-106">A [V1 provider](providing-counter-data.md) uses a performance DLL that provides counter data to consumers.</span></span> <span data-ttu-id="0450d-107">La DLL di prestazioni deve esportare le funzioni [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc)e [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) .</span><span class="sxs-lookup"><span data-stu-id="0450d-107">The performance DLL must export the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc), and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions.</span></span> <span data-ttu-id="0450d-108">In genere, si usa un file di definizione del modulo (con estensione def) per esportare le funzioni dalla DLL.</span><span class="sxs-lookup"><span data-stu-id="0450d-108">Typically, you use a module definition (.def) file to export the functions from the DLL.</span></span> <span data-ttu-id="0450d-109">Il sistema chiama queste funzioni quando un consumer esegue una query dei dati sulle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="0450d-109">The system calls these functions when a consumer queries performance data.</span></span>

<span data-ttu-id="0450d-110">La prima volta che un consumer chiama [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa)o se il consumer usa la funzione [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) o [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) per aprire `HKEY_PERFORMANCE_DATA` , il sistema chiama la funzione [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) per ogni provider [registrato](adding-performance-counters.md) nel computer.</span><span class="sxs-lookup"><span data-stu-id="0450d-110">The first time a consumer calls [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), or if the consumer uses the [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) or [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) function to open `HKEY_PERFORMANCE_DATA`, the system calls the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function for each provider that is [registered](adding-performance-counters.md) on the computer.</span></span> <span data-ttu-id="0450d-111">L'eccezione è rappresentata dal provider che specifica l'elenco di oggetti supportati nella `[objects]` sezione di. File INI.</span><span class="sxs-lookup"><span data-stu-id="0450d-111">The exception is if the provider specifies the list of objects that it supports in the `[objects]` section of the .INI file.</span></span> <span data-ttu-id="0450d-112">In questo caso, il sistema chiama il provider solo se uno degli oggetti sottoposti a query corrisponde a un oggetto dell'elenco.</span><span class="sxs-lookup"><span data-stu-id="0450d-112">In this case, the system calls the provider only if one of the queried objects matches an object from the list.</span></span>

<span data-ttu-id="0450d-113">La funzione [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) offre a ogni provider la possibilità di inizializzare le strutture dei dati sulle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="0450d-113">The [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function gives each provider an opportunity to initialize its performance data structures.</span></span> <span data-ttu-id="0450d-114">Quindi, se la funzione **OpenPerformanceData** restituisce correttamente, il sistema chiama la funzione [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) del provider.</span><span class="sxs-lookup"><span data-stu-id="0450d-114">Then, if the **OpenPerformanceData** function returns successfully, the system calls the provider's [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) function.</span></span> <span data-ttu-id="0450d-115">Le chiamate successive a [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) provocano la chiamata della funzione **CollectPerformanceData** da parte del sistema.</span><span class="sxs-lookup"><span data-stu-id="0450d-115">Subsequent calls to [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) cause the system to call the **CollectPerformanceData** function.</span></span>

<span data-ttu-id="0450d-116">Al termine della raccolta dei dati sulle prestazioni, il consumer specifica `HKEY_PERFORMANCE_DATA` in una chiamata alla funzione [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) .</span><span class="sxs-lookup"><span data-stu-id="0450d-116">When the consumer finishes collecting performance data, it specifies `HKEY_PERFORMANCE_DATA` in a call to the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function.</span></span> <span data-ttu-id="0450d-117">In questo modo il sistema chiama la funzione [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) per ogni provider.</span><span class="sxs-lookup"><span data-stu-id="0450d-117">This causes the system to call the [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) function for each provider.</span></span> <span data-ttu-id="0450d-118">I provider vengono quindi scaricati.</span><span class="sxs-lookup"><span data-stu-id="0450d-118">The providers are then unloaded.</span></span>

<span data-ttu-id="0450d-119">È possibile che più consumer raccolgano i dati sulle prestazioni nello stesso momento.</span><span class="sxs-lookup"><span data-stu-id="0450d-119">It is possible for multiple consumers to collect performance data at the same time.</span></span> <span data-ttu-id="0450d-120">Il sistema chiama le funzioni [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) e [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) solo una volta ogni volta che la dll viene caricata o scaricata.</span><span class="sxs-lookup"><span data-stu-id="0450d-120">The system calls [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions only once each time the DLL is loaded or unloaded.</span></span>

> [!Note]
> <span data-ttu-id="0450d-121">Assicurarsi di includere extern "C" nel codice C++ per impedire al compilatore di aggiungere decorazioni ai nomi di funzione; in caso contrario, il sistema potrebbe non riuscire a trovare le funzioni.</span><span class="sxs-lookup"><span data-stu-id="0450d-121">Be sure to include extern "C" in your C++ code to prevent the compiler from adding decorations to your function names; otherwise, the system may fail to find your functions.</span></span>

> [!Note]
> <span data-ttu-id="0450d-122">Se si verifica un errore durante il caricamento della DLL di prestazioni, la ricerca delle funzioni o la chiamata delle funzioni, il sistema Disabilita il provider per le raccolte successive nello stesso processo.</span><span class="sxs-lookup"><span data-stu-id="0450d-122">If an error occurs while loading your performance DLL, finding your functions, or calling your functions, the system will disable the provider for subsequent collections within the same process.</span></span> <span data-ttu-id="0450d-123">Inoltre, se questa situazione si verifica durante l'esecuzione in un processo con privilegi, il sistema aggiunge un valore **Disabilita contatori delle prestazioni** alla chiave **prestazioni** per impedire che il provider venga caricato in futuro.</span><span class="sxs-lookup"><span data-stu-id="0450d-123">In addition, if this occurs while running in a privileged process, the system adds a **Disable Performance Counters** value to your **Performance** key to prevent the provider from being loaded in the future.</span></span>

<span data-ttu-id="0450d-124">Per ulteriori informazioni sulla scrittura di una DLL di prestazioni, vedere gli argomenti seguenti:</span><span class="sxs-lookup"><span data-stu-id="0450d-124">For more information on writing a performance DLL, see the following topics:</span></span>

- [<span data-ttu-id="0450d-125">Implementazione della funzione OpenPerformanceData</span><span class="sxs-lookup"><span data-stu-id="0450d-125">Implementing the OpenPerformanceData function</span></span>](implementing-openperformancedata.md)
- [<span data-ttu-id="0450d-126">Implementazione della funzione CollectPerformanceData</span><span class="sxs-lookup"><span data-stu-id="0450d-126">Implementing the CollectPerformanceData function</span></span>](implementing-collectperformancedata.md)
- [<span data-ttu-id="0450d-127">Gestione degli errori nella DLL</span><span class="sxs-lookup"><span data-stu-id="0450d-127">Error Handling in the DLL</span></span>](error-handling-in-the-dll.md)
- [<span data-ttu-id="0450d-128">Limitazione dell'accesso alle DLL dell'estensione per le prestazioni</span><span class="sxs-lookup"><span data-stu-id="0450d-128">Restricting Access to Performance Extension DLLs</span></span>](restricting-access-to-performance-extension--dlls.md)
- [<span data-ttu-id="0450d-129">Esempi di DLL di prestazioni</span><span class="sxs-lookup"><span data-stu-id="0450d-129">Performance DLL Samples</span></span>](performance-dll-samples.md)
