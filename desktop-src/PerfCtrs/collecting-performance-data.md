---
description: Dopo la creazione di una query e l'aggiunta di contatori, chiamare la funzione PdhCollectQueryData per recuperare i dati non elaborati correnti per tutti i contatori nella query.
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: Raccolta dei dati sulle prestazioni
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99bd2c0e22553245e87d3844694051c88c57895
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104345521"
---
# <a name="collecting-performance-data"></a><span data-ttu-id="f712f-103">Raccolta dei dati sulle prestazioni</span><span class="sxs-lookup"><span data-stu-id="f712f-103">Collecting Performance Data</span></span>

<span data-ttu-id="f712f-104">Dopo la [creazione di una query](creating-a-query.md) e l'aggiunta di contatori, chiamare la funzione [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) per recuperare i dati non elaborati correnti per tutti i contatori nella query.</span><span class="sxs-lookup"><span data-stu-id="f712f-104">After [creating a query](creating-a-query.md) and adding counters to it, call the [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) function to retrieve the current raw data for all counters in the query.</span></span>

<span data-ttu-id="f712f-105">Molti contatori, ad esempio i contatori di frequenza, richiedono due esempi di dati per calcolare un valore di dati formattato.</span><span class="sxs-lookup"><span data-stu-id="f712f-105">Many counters, such as rate counters, require two data samples to calculate a formatted data value.</span></span> <span data-ttu-id="f712f-106">PDH gestisce i dati per l'esempio corrente e l'esempio precedentemente raccolto.</span><span class="sxs-lookup"><span data-stu-id="f712f-106">PDH maintains data for the current sample and the previously collected sample.</span></span> <span data-ttu-id="f712f-107">Nella procedura seguente viene descritto come raccogliere i valori dei contatori che richiedono due esempi per calcolare un valore visualizzabile.</span><span class="sxs-lookup"><span data-stu-id="f712f-107">The following procedure describes how to collect counter values that require two samples to calculate a displayable value.</span></span>

<span data-ttu-id="f712f-108">**Per raccogliere i valori dei contatori che richiedono due esempi per calcolare un valore visualizzabile**</span><span class="sxs-lookup"><span data-stu-id="f712f-108">**To collect counter values that require two samples to calculate a displayable value**</span></span>

1.  <span data-ttu-id="f712f-109">Chiamare [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) per raccogliere il primo esempio.</span><span class="sxs-lookup"><span data-stu-id="f712f-109">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) to collect the first sample.</span></span>
2.  <span data-ttu-id="f712f-110">Chiamare la funzione [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) per attendere un minimo di un secondo tra le raccolte.</span><span class="sxs-lookup"><span data-stu-id="f712f-110">Call the [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) function to wait a minimum of one second between collections.</span></span>
3.  <span data-ttu-id="f712f-111">Chiamare nuovamente [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) per raccogliere il secondo campione.</span><span class="sxs-lookup"><span data-stu-id="f712f-111">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) again to collect the second sample.</span></span>
4.  <span data-ttu-id="f712f-112">Chiamare la funzione [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) per calcolare un valore visualizzabile.</span><span class="sxs-lookup"><span data-stu-id="f712f-112">Call the [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) function to calculate a displayable value.</span></span>
5.  <span data-ttu-id="f712f-113">Ripetere i passaggi da 2 a 4.</span><span class="sxs-lookup"><span data-stu-id="f712f-113">Repeat steps 2 through 4.</span></span>

<span data-ttu-id="f712f-114">In alternativa all'implementazione autonoma di un periodo di attesa, è possibile chiamare la funzione [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) , che crea un thread di temporizzazione che attende una quantità di tempo specificata, raccoglie l'esempio e quindi attiva un evento definito dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="f712f-114">As an alternative to implementing a wait period yourself, you can call the [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) function, which creates a timing thread that waits a specified amount of time, collects the sample, and then triggers an application-defined event.</span></span>

<span data-ttu-id="f712f-115">Se si desidera eseguire query sui dati sulle prestazioni da un file di log, è anche possibile definire un intervallo di tempo.</span><span class="sxs-lookup"><span data-stu-id="f712f-115">If you want to query performance data from a log file, you can also define a time range.</span></span> <span data-ttu-id="f712f-116">L'intervallo di tempo limita la query agli esempi raccolti nell'intervallo di tempo (ogni campione contiene un timestamp per il momento in cui è stato raccolto).</span><span class="sxs-lookup"><span data-stu-id="f712f-116">The time range limits the query to those samples that were collected within the time range (each sample contains a time stamp for when it was collected).</span></span> <span data-ttu-id="f712f-117">Per ulteriori informazioni su come impostare e recuperare gli intervalli di tempo, vedere [impostazione di un intervallo di tempo per una query](setting-a-time-range-for-a-query.md).</span><span class="sxs-lookup"><span data-stu-id="f712f-117">For more information on how to set and retrieve time ranges, see [Setting a Time Range for a Query](setting-a-time-range-for-a-query.md).</span></span>

<span data-ttu-id="f712f-118">Se si desidera raccogliere i dati sulle prestazioni e scriverli in un file di log, è necessario chiamare la funzione [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) invece di chiamare [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span><span class="sxs-lookup"><span data-stu-id="f712f-118">If you want to collect performance data and write it to a log file, you would call the [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) function instead of calling [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span></span> <span data-ttu-id="f712f-119">Per informazioni dettagliate, vedere [utilizzo di file di log](working-with-log-files.md) e [scrittura di dati sulle prestazioni in un file di log](writing-performance-data-to-a-log-file.md).</span><span class="sxs-lookup"><span data-stu-id="f712f-119">For details, see [Working with Log Files](working-with-log-files.md) and [Writing Performance Data to a Log File](writing-performance-data-to-a-log-file.md).</span></span>

<span data-ttu-id="f712f-120">Per informazioni dettagliate sul calcolo di un valore di esempio visualizzabile, vedere [visualizzazione dei dati sulle prestazioni](displaying-performance-data.md).</span><span class="sxs-lookup"><span data-stu-id="f712f-120">For details on calculating a displayable sample value, see [Displaying Performance Data](displaying-performance-data.md).</span></span>

## <a name="understanding-multiple-processor-counters"></a><span data-ttu-id="f712f-121">Informazioni sui contatori di più processori</span><span class="sxs-lookup"><span data-stu-id="f712f-121">Understanding Multiple Processor Counters</span></span>

<span data-ttu-id="f712f-122">Alcuni contatori delle prestazioni sono stati progettati per sistemi a processore singolo e potrebbero non essere accurati per i computer multiprocessore.</span><span class="sxs-lookup"><span data-stu-id="f712f-122">Some performance counters were designed for single processor systems and might not be accurate for multiprocessor computers.</span></span> <span data-ttu-id="f712f-123">Un processo, ad esempio, è limitato al 100% di un singolo processore. Tuttavia, i thread possono usare più processori, per un totale superiore al 100%.</span><span class="sxs-lookup"><span data-stu-id="f712f-123">For example, a process is limited to 100 percent of a single processor; however, its threads can use several processors, totaling more than 100 percent.</span></span>

<span data-ttu-id="f712f-124">Il \\ valore del contatore "processore ( \_ totale) \\ % tempo processore" indica l'utilizzo medio di tutti i processori.</span><span class="sxs-lookup"><span data-stu-id="f712f-124">The "\\Processor(\_Total)\\% Processor Time" counter value is the average usage of all processors.</span></span> <span data-ttu-id="f712f-125">Se, ad esempio, si dispone di due processori, uno con un 100% e un altro allo 0%, questo contatore segnalerà il 50%.</span><span class="sxs-lookup"><span data-stu-id="f712f-125">For example, if you have two processors, one at 100 percent and another at 0 percent, this counter will report 50 percent.</span></span> <span data-ttu-id="f712f-126">Quindi l'intervallo è compreso tra 0 e 100.</span><span class="sxs-lookup"><span data-stu-id="f712f-126">So the range is from 0 through 100.</span></span>

<span data-ttu-id="f712f-127">Il \\ valore del contatore "processo (X) \\ % tempo di elaborazione" è la somma dell'utilizzo del processore da parte di tutti i thread del processo X. Ad esempio, in un computer con due processori, se un processo dispone di due thread, uno che occupa il 75% di una CPU e l'altro impiega il 80% di un'altra CPU, questo contatore segnalerà il 155%.</span><span class="sxs-lookup"><span data-stu-id="f712f-127">The "\\Process(X)\\% Process Time" counter value is the sum of the processor usage by all threads of process X. For example, in a computer with two processors, if a process has two threads, one taking up 75 percent of a CPU and the other taking 80 percent of another CPU, this counter will report 155 percent.</span></span> <span data-ttu-id="f712f-128">L'intervallo per questo contatore è compreso tra 0 e 100 \* ProcessorCount.</span><span class="sxs-lookup"><span data-stu-id="f712f-128">The range for this counter is from 0 through 100 \* ProcessorCount.</span></span>

<span data-ttu-id="f712f-129">\* \* Windows Server 2003 e Windows XP: \* \*</span><span class="sxs-lookup"><span data-stu-id="f712f-129">\*\*Windows Server 2003 and Windows XP:  \*\*</span></span>

<span data-ttu-id="f712f-130">È possibile ricevere valori non compresi nell'intervallo di valori previsto per l'utilizzo della CPU.</span><span class="sxs-lookup"><span data-stu-id="f712f-130">You can receive values outside the expected range of values for CPU usage.</span></span> <span data-ttu-id="f712f-131">Per calcolare la percentuale di utilizzo della CPU, PDH richiede due campioni (ognuno con un valore non elaborato e un timestamp).</span><span class="sxs-lookup"><span data-stu-id="f712f-131">To calculate the percentage of CPU usage, PDH needs two samples (each with a raw value and a time stamp).</span></span> <span data-ttu-id="f712f-132">Poiché PDH utilizza solo il nome dell'istanza per trovare la corrispondenza con i processi, può talvolta utilizzare due esempi di processi diversi.</span><span class="sxs-lookup"><span data-stu-id="f712f-132">Because PDH uses only the instance name to match the processes, it can sometimes use two samples from different processes.</span></span> <span data-ttu-id="f712f-133">Se, ad esempio, si campionano tre processi e un processo viene terminato dopo il terzo campione, un altro processo verrà spostato nello slot sgomberato da tale processo terminato.</span><span class="sxs-lookup"><span data-stu-id="f712f-133">For example, if three processes are being sampled and one process is terminated after the third sample, another process will move to the slot vacated by that terminated process.</span></span> <span data-ttu-id="f712f-134">Di conseguenza, un contatore formattato fornisce un valore non corretto quando si formatta il quarto campione, perché usa il terzo esempio del processo terminato e il quarto campione dal processo che è stato spostato nello slot del processo terminato.</span><span class="sxs-lookup"><span data-stu-id="f712f-134">As a result, a formatted counter will provide an incorrect value when you format the fourth sample, because it’s using the third sample from the terminated process and the fourth sample from the process that moved into the terminated process's slot.</span></span>

<span data-ttu-id="f712f-135">La tabella seguente illustra come questa situazione può verificarsi se un processo viene terminato durante la raccolta dei dati.</span><span class="sxs-lookup"><span data-stu-id="f712f-135">The following table shows how this can occur if a process is terminated while data is being collected.</span></span> <span data-ttu-id="f712f-136">La tabella mostra cinque esempi di valore del contatore per tre istanze del processo X. Gli esempi vengono raccolti in intervalli di un secondo.</span><span class="sxs-lookup"><span data-stu-id="f712f-136">The table shows five counter value samples for three instances of process X. The samples are collected in one second intervals.</span></span> <span data-ttu-id="f712f-137">Dopo la raccolta del terzo campione, viene terminato il processo X nello slot 1.</span><span class="sxs-lookup"><span data-stu-id="f712f-137">After the third sample is collected, process X in slot 1 is terminated.</span></span> <span data-ttu-id="f712f-138">Quando il processo X nello slot 1 viene terminato, il processo X nello slot 2 si sposta nello slot 1.</span><span class="sxs-lookup"><span data-stu-id="f712f-138">When process X in slot 1 is terminated, process X in slot 2 moves to slot 1.</span></span> <span data-ttu-id="f712f-139">Quando si raccoglie il quarto esempio per il processo X nello slot 2, il primo valore è ora 20 anziché 1.000 e il secondo valore è 1.500.</span><span class="sxs-lookup"><span data-stu-id="f712f-139">When you collect the fourth sample for process X in slot 2, the first value is now 20 instead of 1,000, and the second value is 1,500.</span></span> <span data-ttu-id="f712f-140">Quando si formatta il valore del contatore, si ottengono 1.480 millisecondi anziché i 500 millisecondi previsti.</span><span class="sxs-lookup"><span data-stu-id="f712f-140">When you format the counter value, you get 1,480 milliseconds instead of the expected 500 milliseconds.</span></span> <span data-ttu-id="f712f-141">Quando si formatta il quinto valore di esempio, è necessario ottenere il valore previsto.</span><span class="sxs-lookup"><span data-stu-id="f712f-141">When you format the fifth sample value, you should get the expected value.</span></span>

| <span data-ttu-id="f712f-142">Esempio</span><span class="sxs-lookup"><span data-stu-id="f712f-142">Sample</span></span>   | <span data-ttu-id="f712f-143">Slot 0 per il processo X</span><span class="sxs-lookup"><span data-stu-id="f712f-143">Slot 0 for process X</span></span> | <span data-ttu-id="f712f-144">Slot 1 per il processo X</span><span class="sxs-lookup"><span data-stu-id="f712f-144">Slot 1 for process X</span></span>           | <span data-ttu-id="f712f-145">Slot 2 per il processo X</span><span class="sxs-lookup"><span data-stu-id="f712f-145">Slot 2 for process X</span></span>                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| <span data-ttu-id="f712f-146">Esempio 1</span><span class="sxs-lookup"><span data-stu-id="f712f-146">Sample 1</span></span> | <span data-ttu-id="f712f-147">0</span><span class="sxs-lookup"><span data-stu-id="f712f-147">0</span></span>                    | <span data-ttu-id="f712f-148">0</span><span class="sxs-lookup"><span data-stu-id="f712f-148">0</span></span>                              | <span data-ttu-id="f712f-149">0</span><span class="sxs-lookup"><span data-stu-id="f712f-149">0</span></span>                                        |
| <span data-ttu-id="f712f-150">Esempio 2</span><span class="sxs-lookup"><span data-stu-id="f712f-150">Sample 2</span></span> | <span data-ttu-id="f712f-151">20</span><span class="sxs-lookup"><span data-stu-id="f712f-151">20</span></span>                   | <span data-ttu-id="f712f-152">10</span><span class="sxs-lookup"><span data-stu-id="f712f-152">10</span></span>                             | <span data-ttu-id="f712f-153">500</span><span class="sxs-lookup"><span data-stu-id="f712f-153">500</span></span>                                      |
| <span data-ttu-id="f712f-154">Esempio 3</span><span class="sxs-lookup"><span data-stu-id="f712f-154">Sample 3</span></span> | <span data-ttu-id="f712f-155">40</span><span class="sxs-lookup"><span data-stu-id="f712f-155">40</span></span>                   | <span data-ttu-id="f712f-156">20</span><span class="sxs-lookup"><span data-stu-id="f712f-156">20</span></span>                             | <span data-ttu-id="f712f-157">1\.000</span><span class="sxs-lookup"><span data-stu-id="f712f-157">1,000</span></span>                                    |
| <span data-ttu-id="f712f-158">Esempio 4</span><span class="sxs-lookup"><span data-stu-id="f712f-158">Sample 4</span></span> | <span data-ttu-id="f712f-159">60</span><span class="sxs-lookup"><span data-stu-id="f712f-159">60</span></span>                   | <span data-ttu-id="f712f-160">1.500 (dallo slot precedente 2)</span><span class="sxs-lookup"><span data-stu-id="f712f-160">1,500 (from the former slot 2)</span></span> | <span data-ttu-id="f712f-161">Non applicabile.</span><span class="sxs-lookup"><span data-stu-id="f712f-161">Not applicable.</span></span> <span data-ttu-id="f712f-162">Ora raccolti nello slot 1.</span><span class="sxs-lookup"><span data-stu-id="f712f-162">Now collected in slot 1.</span></span> |
| <span data-ttu-id="f712f-163">Esempio 5</span><span class="sxs-lookup"><span data-stu-id="f712f-163">Sample 5</span></span> | <span data-ttu-id="f712f-164">80</span><span class="sxs-lookup"><span data-stu-id="f712f-164">80</span></span>                   | <span data-ttu-id="f712f-165">2\.000</span><span class="sxs-lookup"><span data-stu-id="f712f-165">2,000</span></span>                          | <span data-ttu-id="f712f-166">Non applicabile.</span><span class="sxs-lookup"><span data-stu-id="f712f-166">Not applicable.</span></span> <span data-ttu-id="f712f-167">Ora raccolti nello slot 1.</span><span class="sxs-lookup"><span data-stu-id="f712f-167">Now collected in slot 1.</span></span> |



 

 

 
