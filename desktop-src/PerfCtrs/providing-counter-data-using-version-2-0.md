---
description: Con la versione 2,0, i contatori delle prestazioni hanno modificato l'architettura per semplificare il processo di invio dei dati dei contatori ai consumer.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Fornire dati del contatore usando la versione 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "106312094"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="9f2aa-103">Fornire dati del contatore usando la versione 2,0</span><span class="sxs-lookup"><span data-stu-id="9f2aa-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="9f2aa-104">I provider di dati delle prestazioni moderni utilizzano un manifesto per definire i dati del contatore e utilizzare le API del provider del contatore delle prestazioni per gestire i dati all'interno del contesto del provider.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="9f2aa-105">I provider implementati utilizzando un manifesto e le API del provider del contatore delle prestazioni vengono spesso chiamati **provider v2**.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="9f2aa-106">Windows supporta i provider v2 in modalità utente in Windows Vista o versioni successive e i provider in modalità kernel v2 in Windows 7 o versioni successive.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="9f2aa-107">Questa pagina descrive i provider v2 in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="9f2aa-108">Per informazioni sui provider v2 in modalità kernel, vedere [monitoraggio delle prestazioni in modalità kernel](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span><span class="sxs-lookup"><span data-stu-id="9f2aa-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="9f2aa-109">In fase di esecuzione, i provider v2 funzionano come segue:</span><span class="sxs-lookup"><span data-stu-id="9f2aa-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="9f2aa-110">Il processo del provider viene registrato con il sistema di contatori delle prestazioni Windows chiamando PerfStartProvider e PerfSetCounterSetInfo.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="9f2aa-111">Il provider fornisce facoltativamente una funzione di callback che riceverà una notifica relativa alle richieste del consumer.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="9f2aa-112">Il processo del provider aggiunge o rimuove le istanze in base alle esigenze usando PerfCreateInstance e PerfDeleteInstance.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="9f2aa-113">Il provider aggiorna i valori dei contatori quando vengono modificati usando le API PerfSet \* \* _.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="9f2aa-114">Un consumer effettua una richiesta di dati da un contatore.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="9f2aa-115">Il sistema verifica che il chiamante disponga delle autorizzazioni per la raccolta dei dati.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="9f2aa-116">Il sistema usa quindi un thread di lavoro in esecuzione nel processo del provider per gestire la richiesta, richiamando la funzione di callback del provider, se appropriato.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="9f2aa-117">Il thread di lavoro copia i dati raccolti in un buffer gestito dal sistema, quindi i dati vengono restituiti al consumer.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="9f2aa-118">Passaggi per la creazione di un provider</span><span class="sxs-lookup"><span data-stu-id="9f2aa-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="9f2aa-119">Scrivere un manifesto che definisce i dati del contatore che il provider fornirà.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="9f2aa-120">Per informazioni dettagliate sulla scrittura del manifesto, vedere [schema dei contatori delle prestazioni](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="9f2aa-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="9f2aa-121">Usare [CTRPP](ctrpp.md) per generare il codice del modello incluso nel provider.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="9f2aa-122">Il codice del modello include le strutture che definiscono gli insiemi di contatori, le funzioni [_ *CounterInitialize* \*](counterinitialize.md) e [**CounterCleanup**](countercleanup.md) e le stringhe di risorsa.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="9f2aa-123">Il provider deve chiamare le funzioni [**CounterInitialize**](counterinitialize.md) e [**CounterCleanup**](countercleanup.md) .</span><span class="sxs-lookup"><span data-stu-id="9f2aa-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="9f2aa-124">**CounterInitialize** chiama la funzione [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) per registrare il provider e chiama anche la funzione [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) per inizializzare l'insieme di contatori.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="9f2aa-125">**CounterCleanup** chiama la funzione [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) per rimuovere la registrazione del provider.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="9f2aa-126">Includere il codice del modello del passaggio precedente nel progetto e completare il provider.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="9f2aa-127">Per completare il provider, è necessario chiamare la funzione [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) per ogni istanza dell'insieme di contatori fornito.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="9f2aa-128">Per impostare i valori del contatore, chiamare una delle funzioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="9f2aa-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="9f2aa-129">**PerfSetULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="9f2aa-130">**PerfSetULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="9f2aa-131">**PerfSetCounterRefValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="9f2aa-132">Il vantaggio dell'utilizzo di [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) consiste nel fatto che non è necessario effettuare una chiamata di funzione per impostare o aggiornare il valore del contatore, ma è sufficiente aggiornare la variabile del contatore locale (la variabile a cui puntano i punti di riferimento) e i contatori delle prestazioni utilizzano il puntatore per accedere al valore del contatore.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="9f2aa-133">Se non si utilizza [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), è possibile utilizzare le funzioni seguenti per incrementare o decrementare il valore del contatore:</span><span class="sxs-lookup"><span data-stu-id="9f2aa-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="9f2aa-134">**PerfDecrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="9f2aa-135">**PerfDecrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="9f2aa-136">**PerfIncrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="9f2aa-137">**PerfIncrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="9f2aa-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="9f2aa-138">Prima della chiusura del provider, deve chiamare il [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) per ogni istanza dell'insieme di contatori creata.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="9f2aa-139">Se è [**stato**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) specificato l'attributo **callback** nell'elemento provider nel manifesto oppure è stato usato l'argomento **-NotificationCallback** quando si chiama [CTRPP](ctrpp.md), è necessario implementare la funzione di callback [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) .</span><span class="sxs-lookup"><span data-stu-id="9f2aa-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="9f2aa-140">La funzione di callback viene passata a [**CounterInitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="9f2aa-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="9f2aa-141">Se è stato usato il **-MemoryRoutines** quando si chiama [CTRPP](ctrpp.md), è necessario implementare le funzioni di callback [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) e [*freememory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) .</span><span class="sxs-lookup"><span data-stu-id="9f2aa-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="9f2aa-142">Le funzioni di callback vengono passate a [**CounterInitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="9f2aa-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="9f2aa-143">Quando si installa il provider, usare lo strumento LodCtr per scrivere il nome del file binario che contiene le stringhe di risorsa localizzate e gli ID risorsa nel registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="9f2aa-144">Per informazioni dettagliate sull'uso di LodCtr, vedere [schema dei contatori delle prestazioni](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="9f2aa-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="9f2aa-145">Quando si disinstalla il provider, usare lo strumento UnlodCtr per rimuovere le informazioni del provider dal registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="9f2aa-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
