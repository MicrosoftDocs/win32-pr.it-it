---
description: Al termine dell'operazione WMI, il provider viene scaricato dalla memoria.
ms.assetid: 6116769f-3402-42b3-835d-9bdb0fc27ce0
ms.tgt_platform: multiple
title: Scaricamento di un provider
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 123d8c4f6b9d9155cdc22dc435635466956bdb0a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104528465"
---
# <a name="unloading-a-provider"></a><span data-ttu-id="c73ee-103">Scaricamento di un provider</span><span class="sxs-lookup"><span data-stu-id="c73ee-103">Unloading a Provider</span></span>

<span data-ttu-id="c73ee-104">Al termine dell'operazione WMI, il provider viene scaricato dalla memoria.</span><span class="sxs-lookup"><span data-stu-id="c73ee-104">After WMI is finished with a provider, it unloads the provider from memory.</span></span> <span data-ttu-id="c73ee-105">Il motivo principale per cui WMI Scarica un provider consiste nel conservare le risorse di sistema.</span><span class="sxs-lookup"><span data-stu-id="c73ee-105">The primary reason WMI unloads a provider is to conserve system resources.</span></span> <span data-ttu-id="c73ee-106">Pertanto, è necessario aggiungere codice che consenta a WMI di scaricare il provider in modo efficiente.</span><span class="sxs-lookup"><span data-stu-id="c73ee-106">Therefore, you must add code that allows WMI to unload your provider in an efficient manner.</span></span> <span data-ttu-id="c73ee-107">Per lo scaricamento di un provider, l'intervallo specificato nel controllo della cache è necessario per due volte.</span><span class="sxs-lookup"><span data-stu-id="c73ee-107">It takes anywhere from the interval specified in the cache control to twice that interval for WMI to unload a provider.</span></span>

<span data-ttu-id="c73ee-108">WMI Scarica un provider in uno dei modi seguenti:</span><span class="sxs-lookup"><span data-stu-id="c73ee-108">WMI unloads a provider in one of the following ways:</span></span>

-   <span data-ttu-id="c73ee-109">Scarica un provider dopo che il provider ha completato le attività fornite.</span><span class="sxs-lookup"><span data-stu-id="c73ee-109">Unload a provider after the provider finishes the tasks given to it.</span></span>
-   <span data-ttu-id="c73ee-110">Scarica rapidamente tutti i provider quando l'utente arresta il sistema.</span><span class="sxs-lookup"><span data-stu-id="c73ee-110">Quickly unload all providers when the user shuts down the system.</span></span> <span data-ttu-id="c73ee-111">Si noti che WMI Scarica i provider in-process quando il servizio WMI viene arrestato dalla riga di comando.</span><span class="sxs-lookup"><span data-stu-id="c73ee-111">Note that WMI unloads in-process providers when the WMI service is shut down from the command line.</span></span>

<span data-ttu-id="c73ee-112">Mentre il primo scenario è più comune, è necessario scrivere il provider per entrambe le possibilità.</span><span class="sxs-lookup"><span data-stu-id="c73ee-112">While the first scenario is more common, you must write your provider for both possibilities.</span></span>

<span data-ttu-id="c73ee-113">Le sezioni seguenti sono illustrate in questo argomento:</span><span class="sxs-lookup"><span data-stu-id="c73ee-113">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="c73ee-114">Scaricamento di un provider inattivo</span><span class="sxs-lookup"><span data-stu-id="c73ee-114">Unloading an Idle Provider</span></span>](#unloading-an-idle-provider)
-   [<span data-ttu-id="c73ee-115">Accesso al tempo di inattività per un provider</span><span class="sxs-lookup"><span data-stu-id="c73ee-115">Accessing the Idle Time for a Provider</span></span>](#accessing-the-idle-time-for-a-provider)
-   [<span data-ttu-id="c73ee-116">Scaricamento di un provider che è anche un client WMI</span><span class="sxs-lookup"><span data-stu-id="c73ee-116">Unloading a Provider That Is Also a WMI Client</span></span>](#unloading-a-provider-that-is-also-a-wmi-client)
-   [<span data-ttu-id="c73ee-117">Scaricamento di un provider durante la chiusura</span><span class="sxs-lookup"><span data-stu-id="c73ee-117">Unloading a Provider During Shutdown</span></span>](#unloading-a-provider-during-shutdown)
-   [<span data-ttu-id="c73ee-118">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="c73ee-118">Related topics</span></span>](#related-topics)

## <a name="unloading-an-idle-provider"></a><span data-ttu-id="c73ee-119">Scaricamento di un provider inattivo</span><span class="sxs-lookup"><span data-stu-id="c73ee-119">Unloading an Idle Provider</span></span>

<span data-ttu-id="c73ee-120">Quando Scarica un provider inattivo, WMI esegue le azioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="c73ee-120">WMI performs the following actions when it unloads an idle provider:</span></span>

-   <span data-ttu-id="c73ee-121">Determina se il provider è inattivo.</span><span class="sxs-lookup"><span data-stu-id="c73ee-121">Determines if the provider is idle.</span></span>

    <span data-ttu-id="c73ee-122">WMI utilizza la proprietà **ClearAfter** per determinare per quanto tempo un provider può rimanere inattivo prima di scaricare tale provider.</span><span class="sxs-lookup"><span data-stu-id="c73ee-122">WMI uses the **ClearAfter** property to determine how long a provider may stay idle before unloading that provider.</span></span> <span data-ttu-id="c73ee-123">Per ulteriori informazioni, vedere [accesso al tempo di inattività per un provider](#accessing-the-idle-time-for-a-provider).</span><span class="sxs-lookup"><span data-stu-id="c73ee-123">For more information, see [Accessing the Idle Time for a Provider](#accessing-the-idle-time-for-a-provider).</span></span>

-   <span data-ttu-id="c73ee-124">Chiama il metodo di [**rilascio**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) del provider.</span><span class="sxs-lookup"><span data-stu-id="c73ee-124">Calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the provider.</span></span>

    <span data-ttu-id="c73ee-125">Se il provider è un provider pure, la [**versione**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) rimuove completamente il provider dalla memoria attiva.</span><span class="sxs-lookup"><span data-stu-id="c73ee-125">If the provider was a pure provider, then [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) completely removes the provider from active memory.</span></span> <span data-ttu-id="c73ee-126">Tuttavia, un provider non pure può continuare a essere eseguito dopo il **rilascio** delle chiamate WMI.</span><span class="sxs-lookup"><span data-stu-id="c73ee-126">However, a nonpure provider may continue to run after WMI calls **Release**.</span></span>

## <a name="accessing-the-idle-time-for-a-provider"></a><span data-ttu-id="c73ee-127">Accesso al tempo di inattività per un provider</span><span class="sxs-lookup"><span data-stu-id="c73ee-127">Accessing the Idle Time for a Provider</span></span>

<span data-ttu-id="c73ee-128">La quantità minima di tempo per cui un provider rimane attivo è determinata dalla proprietà **ClearAfter** .</span><span class="sxs-lookup"><span data-stu-id="c73ee-128">The minimum amount of time a provider remains active is determined by the **ClearAfter** property.</span></span> <span data-ttu-id="c73ee-129">È possibile trovare **ClearAfter** in istanze delle classi derivate dalla classe di sistema WMI [**\_ \_ CacheControl**](--cachecontrol.md) nello \\ spazio dei nomi radice.</span><span class="sxs-lookup"><span data-stu-id="c73ee-129">You can find **ClearAfter** in instances of classes derived from the WMI system class [**\_\_CacheControl**](--cachecontrol.md) in the \\root namespace.</span></span>

<span data-ttu-id="c73ee-130">Nell'elenco seguente vengono descritte le classi derivate da [**\_ \_ CacheControl**](--cachecontrol.md), che controlla lo scaricamento del provider:</span><span class="sxs-lookup"><span data-stu-id="c73ee-130">The following list describes the classes that are derived from [**\_\_CacheControl**](--cachecontrol.md), which controls provider unloading:</span></span>

-   [<span data-ttu-id="c73ee-131">**\_\_EventConsumerProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="c73ee-131">**\_\_EventConsumerProviderCacheControl**</span></span>](--eventconsumerprovidercachecontrol.md)
-   [<span data-ttu-id="c73ee-132">**\_\_EventProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="c73ee-132">**\_\_EventProviderCacheControl**</span></span>](--eventprovidercachecontrol.md)
-   [<span data-ttu-id="c73ee-133">**\_\_EventSinkCacheControl**</span><span class="sxs-lookup"><span data-stu-id="c73ee-133">**\_\_EventSinkCacheControl**</span></span>](--eventsinkcachecontrol.md)
-   [<span data-ttu-id="c73ee-134">**\_\_ObjectProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="c73ee-134">**\_\_ObjectProviderCacheControl**</span></span>](--objectprovidercachecontrol.md)
-   [<span data-ttu-id="c73ee-135">**\_\_PropertyProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="c73ee-135">**\_\_PropertyProviderCacheControl**</span></span>](--propertyprovidercachecontrol.md)

<span data-ttu-id="c73ee-136">È possibile modificare la quantità minima di tempo che WMI consente a un provider di rimanere inattivo modificando la proprietà **ClearAfter** nell'istanza del controllo cache per un tipo specifico di provider.</span><span class="sxs-lookup"><span data-stu-id="c73ee-136">You can change the minimum amount of time that WMI allows a provider to remain inactive by editing the **ClearAfter** property in the cache control instance for a specific type of provider.</span></span> <span data-ttu-id="c73ee-137">Ad esempio, per limitare la quantità di tempo in cui un provider di proprietà può rimanere inattivo, modificare la proprietà **ClearAfter** di un'istanza di [**\_ \_ PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) nello \\ spazio dei nomi radice.</span><span class="sxs-lookup"><span data-stu-id="c73ee-137">For example, to limit the amount of time a property provider can remain idle, you would edit the **ClearAfter** property of a [**\_\_PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) instance in the \\root namespace.</span></span>

## <a name="unloading-a-provider-that-is-also-a-wmi-client"></a><span data-ttu-id="c73ee-138">Scaricamento di un provider che è anche un client WMI</span><span class="sxs-lookup"><span data-stu-id="c73ee-138">Unloading a Provider That Is Also a WMI Client</span></span>

<span data-ttu-id="c73ee-139">È possibile che il provider debba rimanere un client di WMI dopo aver completato le funzioni del provider chiamate per l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="c73ee-139">Your provider may need to remain a client of WMI after it has completed the provider functions it was called to perform.</span></span> <span data-ttu-id="c73ee-140">È ad esempio possibile che un provider di push debba eseguire query in WMI.</span><span class="sxs-lookup"><span data-stu-id="c73ee-140">For example, a push provider may need to issue queries to WMI.</span></span> <span data-ttu-id="c73ee-141">Per ulteriori informazioni, vedere [determinare lo stato di push o pull](determining-push-or-pull-status.md).</span><span class="sxs-lookup"><span data-stu-id="c73ee-141">For more information, see [Determining Push or Pull Status](determining-push-or-pull-status.md).</span></span> <span data-ttu-id="c73ee-142">In questo caso, la proprietà **pure** dell'istanza di [**\_ \_ Win32Provider**](--win32provider.md) che rappresenta il provider deve essere impostata su **true**.</span><span class="sxs-lookup"><span data-stu-id="c73ee-142">In this case, the **Pure** property of the [**\_\_Win32Provider**](--win32provider.md) instance that represents the provider should be set to **TRUE**.</span></span> <span data-ttu-id="c73ee-143">Se la proprietà **pure** è impostata su **false**, il provider si prepara a eseguire lo scaricamento chiamando [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) su tutti i punti di interfaccia in attesa quando WMI chiama il metodo release della relativa interfaccia principale.</span><span class="sxs-lookup"><span data-stu-id="c73ee-143">If the **Pure** property is set to **FALSE**, the provider prepares to unload by calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on all outstanding interface points when WMI calls the Release method of its primary interface.</span></span> <span data-ttu-id="c73ee-144">Per ulteriori informazioni, vedere la sezione Osservazioni in [**\_ \_ Win32Provider**](--win32provider.md).</span><span class="sxs-lookup"><span data-stu-id="c73ee-144">For more information, see the Remarks section in [**\_\_Win32Provider**](--win32provider.md).</span></span>

<span data-ttu-id="c73ee-145">Nella procedura seguente viene descritto come implementare un metodo di rilascio per l'interfaccia principale del provider.</span><span class="sxs-lookup"><span data-stu-id="c73ee-145">The following procedure describes how to implement a release method for the primary interface of your provider.</span></span>

<span data-ttu-id="c73ee-146">**Per scaricare un provider**</span><span class="sxs-lookup"><span data-stu-id="c73ee-146">**To unload a provider**</span></span>

1.  <span data-ttu-id="c73ee-147">Rilascia tutti i puntatori di interfaccia mantenuti su WMI quando WMI chiama il metodo di [**rilascio**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) dell'interfaccia principale del provider.</span><span class="sxs-lookup"><span data-stu-id="c73ee-147">Release all interface pointers held against WMI when WMI calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the primary interface of your provider.</span></span>

    <span data-ttu-id="c73ee-148">In genere, un provider include i puntatori alle interfacce [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) e [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) fornite in [**IWbemProviderInit:: Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span><span class="sxs-lookup"><span data-stu-id="c73ee-148">Typically, a provider holds pointers to the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) interfaces supplied in [**IWbemProviderInit::Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span></span>

2.  <span data-ttu-id="c73ee-149">Se la proprietà **pure** nell'istanza di [**\_ \_ Win32Provider**](--win32provider.md) associata è impostata su **false**, il provider può passare al ruolo di applicazione client dopo la [**versione**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release)di WMI.</span><span class="sxs-lookup"><span data-stu-id="c73ee-149">If the **Pure** property in the associated [**\_\_Win32Provider**](--win32provider.md) instance is set to **FALSE**, the provider can transition to the role of client application after WMI calls [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="c73ee-150">Tuttavia, WMI non è in grado di scaricare un provider che opera come sistema client, aumentando così l'overhead del sistema.</span><span class="sxs-lookup"><span data-stu-id="c73ee-150">However, WMI cannot unload a provider that is operating as a client system, which increases the system overhead.</span></span>

    <span data-ttu-id="c73ee-151">Un provider con l'impostazione **pure** su **true** esiste solo per le richieste di servizio.</span><span class="sxs-lookup"><span data-stu-id="c73ee-151">A provider with **Pure** set to **TRUE** exists only to service requests.</span></span> <span data-ttu-id="c73ee-152">Pertanto, questo tipo di provider non può assumere il ruolo di un'applicazione client e WMI può scaricarlo.</span><span class="sxs-lookup"><span data-stu-id="c73ee-152">Therefore, this type of provider cannot take on the role of a client application and WMI can unload it.</span></span>

## <a name="unloading-a-provider-during-shutdown"></a><span data-ttu-id="c73ee-153">Scaricamento di un provider durante la chiusura</span><span class="sxs-lookup"><span data-stu-id="c73ee-153">Unloading a Provider During Shutdown</span></span>

<span data-ttu-id="c73ee-154">In circostanze normali, l'utilizzo delle linee guida nello scaricamento di [un provider che è anche un client WMI](#unloading-a-provider-that-is-also-a-wmi-client) consente a WMI di scaricare il provider in modo corretto.</span><span class="sxs-lookup"><span data-stu-id="c73ee-154">Under normal circumstances, using the guidelines in [Unloading a Provider That is Also a WMI Client](#unloading-a-provider-that-is-also-a-wmi-client) allows WMI to unload your provider properly.</span></span> <span data-ttu-id="c73ee-155">Tuttavia, è possibile che si verifichino situazioni in cui WMI non è in grado di avviare le normali procedure di scaricamento, ad esempio quando l'utente sceglie di arrestare il sistema.</span><span class="sxs-lookup"><span data-stu-id="c73ee-155">However, you may run into situations where WMI is unable to instigate the normal unloading procedures, such as when the user chooses to shut the system down.</span></span> <span data-ttu-id="c73ee-156">Utilizzando un modello di transazione di archiviazione dei dati, oltre all'implementazione di una strategia di pulizia valida, è possibile verificare che il provider sia stato scaricato correttamente.</span><span class="sxs-lookup"><span data-stu-id="c73ee-156">By using a transaction model of data storage, in addition to implementing a good cleanup strategy, you can ensure that your provider is properly unloaded.</span></span>

<span data-ttu-id="c73ee-157">L'utente può arrestare WMI in qualsiasi momento.</span><span class="sxs-lookup"><span data-stu-id="c73ee-157">The user may stop WMI at any time.</span></span> <span data-ttu-id="c73ee-158">In una situazione di questo tipo, WMI non Scarica alcun provider né chiama il punto di ingresso [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) in alcun provider in-process.</span><span class="sxs-lookup"><span data-stu-id="c73ee-158">In such a situation, WMI does not unload any providers or call the [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) entry point on any in-process provider.</span></span> <span data-ttu-id="c73ee-159">Inoltre, se un provider in-process si trova al centro di una chiamata al metodo al momento dell'arresto, WMI può eventualmente terminare il thread in esecuzione al centro della chiamata.</span><span class="sxs-lookup"><span data-stu-id="c73ee-159">Moreover, if an in-process provider is in the middle of a method call at the time of the shutdown, WMI can possibly terminate the executing thread in the middle of the call.</span></span> <span data-ttu-id="c73ee-160">In questa circostanza, WMI non chiama routine che in genere gestiscono la pulizia, ad esempio un distruttore di oggetti.</span><span class="sxs-lookup"><span data-stu-id="c73ee-160">In this circumstance, WMI does not call routines that normally handle cleanup, such as an object destructor.</span></span> <span data-ttu-id="c73ee-161">WMI chiamerà al massimo solo [**DllMain**](/windows/desktop/Dlls/dllmain) .</span><span class="sxs-lookup"><span data-stu-id="c73ee-161">At most, WMI will call [**DllMain**](/windows/desktop/Dlls/dllmain) only.</span></span>

<span data-ttu-id="c73ee-162">Quando il sistema operativo arresta WMI, il sistema rilascia automaticamente tutta la memoria allocata a un provider in-process.</span><span class="sxs-lookup"><span data-stu-id="c73ee-162">When the operating system shuts down WMI, the system automatically releases all memory allocated to an in-process provider.</span></span> <span data-ttu-id="c73ee-163">Il sistema operativo chiude anche la maggior parte delle risorse utilizzate dal provider, ad esempio handle di file, handle di finestra e così via.</span><span class="sxs-lookup"><span data-stu-id="c73ee-163">The operating system also closes most resources held by the provider, such as file handles, window handles, and so on.</span></span> <span data-ttu-id="c73ee-164">Per eseguire questa operazione, il provider non deve intraprendere alcuna azione specifica.</span><span class="sxs-lookup"><span data-stu-id="c73ee-164">The provider does not need to take any specific action to make this happen.</span></span>

<span data-ttu-id="c73ee-165">Poiché WMI potrebbe arrestarsi durante una chiamata, un provider non deve lasciare le origini dati in uno stato incoerente.</span><span class="sxs-lookup"><span data-stu-id="c73ee-165">Because WMI may shut down in the middle of a call, a provider should not leave data sources in an inconsistent state.</span></span> <span data-ttu-id="c73ee-166">Lasciare i dati in uno stato incoerente non è un problema per i provider di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="c73ee-166">Leaving your data in an inconsistent state is not a problem for read-only providers.</span></span> <span data-ttu-id="c73ee-167">Tuttavia, i provider con funzionalità di scrittura potrebbero voler implementare una sorta di modello di transazione per consentire un rollback sicuro dopo un'interruzione improvvisa.</span><span class="sxs-lookup"><span data-stu-id="c73ee-167">However, providers with write capabilities may want to implement some sort of transaction model to allow a safe rollback after an abrupt termination.</span></span>

<span data-ttu-id="c73ee-168">Mentre il sistema operativo può rilasciare alcune risorse di sistema generali, il sistema non rilascia automaticamente tutte le risorse.</span><span class="sxs-lookup"><span data-stu-id="c73ee-168">While the operating system may release some general system resources, the system does not automatically release all resources.</span></span> <span data-ttu-id="c73ee-169">Ad esempio, il sistema operativo potrebbe non rilasciare un socket o una connessione di database.</span><span class="sxs-lookup"><span data-stu-id="c73ee-169">For example, the operating system may not release a socket or a database connection.</span></span> <span data-ttu-id="c73ee-170">Al contrario, è possibile che il provider debba eseguire manualmente la pulizia di tali risorse.</span><span class="sxs-lookup"><span data-stu-id="c73ee-170">Instead, the provider may need to manually clean up such resources.</span></span> <span data-ttu-id="c73ee-171">Per evitare questi problemi, è possibile implementare il provider out-of-process oppure è possibile aggiungere il codice di pulizia.</span><span class="sxs-lookup"><span data-stu-id="c73ee-171">To avoid these problems, you can either implement your provider out-of-process, or you can add cleanup code.</span></span>

<span data-ttu-id="c73ee-172">La soluzione più semplice consiste nell'implementare il provider out-of-process.</span><span class="sxs-lookup"><span data-stu-id="c73ee-172">The simplest solution is to implement your provider out-of-process.</span></span> <span data-ttu-id="c73ee-173">Un provider out-of-process non viene terminato quando WMI viene arrestato, sebbene WMI rilascerà il provider dopo un timeout COM.</span><span class="sxs-lookup"><span data-stu-id="c73ee-173">An out-of-process provider is not killed when WMI shuts down, although WMI will release the provider after a COM timeout.</span></span> <span data-ttu-id="c73ee-174">I provider per i quali si verificano problemi di affidabilità della pulizia e della terminazione sono più importanti delle prestazioni che potrebbero essere out-of-process.</span><span class="sxs-lookup"><span data-stu-id="c73ee-174">Providers for whom cleanup and termination robustness issues are more important than performance may be out-of-process.</span></span>

<span data-ttu-id="c73ee-175">Se è necessario inserire il codice di pulizia nel provider, sono disponibili due opzioni.</span><span class="sxs-lookup"><span data-stu-id="c73ee-175">If you must place cleanup code in your provider, you have two options.</span></span> <span data-ttu-id="c73ee-176">Un'unica posizione per eseguire questo tipo di pulizia è [**DllMain**](/windows/desktop/Dlls/dllmain), ovvero la funzione del punto di ingresso della DLL chiamata dal sistema operativo durante lo scaricamento della dll.</span><span class="sxs-lookup"><span data-stu-id="c73ee-176">One place to perform this sort of cleanup is [**DllMain**](/windows/desktop/Dlls/dllmain), the DLL entry point function the operating system calls when unloading the DLL.</span></span> <span data-ttu-id="c73ee-177">Il codice di pulitura può essere aggiunto direttamente in **DllMain**, eseguendolo in risposta alla **\_ \_ disconnessione del processo dll**.</span><span class="sxs-lookup"><span data-stu-id="c73ee-177">Cleanup code can be added directly into **DllMain**, executing it in response to **DLL\_PROCESS\_DETACH**.</span></span> <span data-ttu-id="c73ee-178">L'implementazione del codice di pulizia in **DllMain** può essere piuttosto difficile da disporre, soprattutto in ambienti di programmazione come MFC o ATL.</span><span class="sxs-lookup"><span data-stu-id="c73ee-178">Implementing cleanup code in **DllMain** can be somewhat difficult to arrange, especially in programming environments such as MFC or ATL.</span></span> <span data-ttu-id="c73ee-179">Per ulteriori informazioni, vedere l'articolo della Microsoft Knowledge base Q148791, "*come specificare DllMain in una DLL regolare MFC".*</span><span class="sxs-lookup"><span data-stu-id="c73ee-179">For more information, see the Microsoft Knowledge Base article Q148791, "*How to Provide Your Own DllMain in an MFC Regular DLL.*"</span></span> <span data-ttu-id="c73ee-180">Questa risorsa potrebbe non essere disponibile in alcune lingue e paesi o aree geografiche.</span><span class="sxs-lookup"><span data-stu-id="c73ee-180">(This resource may not be available in some languages and countries or regions.)</span></span>

<span data-ttu-id="c73ee-181">In alternativa, è anche possibile inserire il codice di pulizia nel distruttore di una classe globale.</span><span class="sxs-lookup"><span data-stu-id="c73ee-181">Alternately, you could also place the cleanup code in the destructor of a global class.</span></span> <span data-ttu-id="c73ee-182">Per ulteriori informazioni, vedere Scaricamento di un provider.</span><span class="sxs-lookup"><span data-stu-id="c73ee-182">For more information, see Unloading a Provider.</span></span> <span data-ttu-id="c73ee-183">Il sistema operativo Windows non alloca oggetti globali nell'heap.</span><span class="sxs-lookup"><span data-stu-id="c73ee-183">The Windows operating system does not allocate global objects on the heap.</span></span> <span data-ttu-id="c73ee-184">Al contrario, il sistema operativo chiama i distruttori durante lo scaricamento della DLL.</span><span class="sxs-lookup"><span data-stu-id="c73ee-184">Instead, the operating system calls the destructors during DLL unload.</span></span>

<span data-ttu-id="c73ee-185">Di seguito è riportata una semplice procedura di pulizia che può rientrare in un oggetto globale per WMI.</span><span class="sxs-lookup"><span data-stu-id="c73ee-185">The following is a simple cleanup procedure that could fit inside a global object for WMI.</span></span>


```C++
class CMyCleanup
{
    ~CMyCleanup()
    {
        CloseHandle(m_hOpenFile);
        CloseDatabaseConnection(g_hDatabase);
    }
} g_Cleanup;
```



<span data-ttu-id="c73ee-186">Esistono diverse restrizioni relative a ciò che è possibile eseguire nel codice di pulizia con entrambi gli approcci.</span><span class="sxs-lookup"><span data-stu-id="c73ee-186">There are many restrictions as to what can be done in the cleanup code with either approach.</span></span> <span data-ttu-id="c73ee-187">Non è ad esempio possibile accedere ai thread né a qualsiasi dll non collegata in modo implicito.</span><span class="sxs-lookup"><span data-stu-id="c73ee-187">For example, neither threads nor any DLLs that are not implicitly linked may be accessed in any way.</span></span> <span data-ttu-id="c73ee-188">Inoltre, non è possibile effettuare chiamate COM in qualsiasi circostanza.</span><span class="sxs-lookup"><span data-stu-id="c73ee-188">Further, you cannot make COM calls under any circumstances.</span></span>

## <a name="related-topics"></a><span data-ttu-id="c73ee-189">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="c73ee-189">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c73ee-190">Impostazione di descrittori di sicurezza spazio dei nomi</span><span class="sxs-lookup"><span data-stu-id="c73ee-190">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="c73ee-191">Sicurezza del provider</span><span class="sxs-lookup"><span data-stu-id="c73ee-191">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> <dt>

[<span data-ttu-id="c73ee-192">Sviluppo di un provider WMI</span><span class="sxs-lookup"><span data-stu-id="c73ee-192">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> </dl>

 

 
