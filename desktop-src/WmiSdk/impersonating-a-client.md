---
description: Quando un'applicazione utente richiede dati da oggetti nel sistema tramite un provider WMI, la rappresentazione significa che il provider presenta le credenziali che rappresentano il livello di sicurezza dei client anziché i provider.
ms.assetid: 6d54f234-45aa-445b-ad50-7d5a9946c134
ms.tgt_platform: multiple
title: Rappresentazione di un client
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 162857d90c8bddb70d90eb2e10efbc08537299d9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "103883533"
---
# <a name="impersonating-a-client"></a><span data-ttu-id="fab9b-103">Rappresentazione di un client</span><span class="sxs-lookup"><span data-stu-id="fab9b-103">Impersonating a Client</span></span>

<span data-ttu-id="fab9b-104">Quando un'applicazione utente richiede dati da oggetti nel sistema tramite un provider WMI, la rappresentazione significa che il provider presenta le credenziali che rappresentano il livello di sicurezza del client anziché l'oggetto del provider.</span><span class="sxs-lookup"><span data-stu-id="fab9b-104">When a user application requests data from objects on the system through a WMI provider, impersonation means the provider presents credentials that represent the client's security level rather than the provider's.</span></span> <span data-ttu-id="fab9b-105">La rappresentazione impedisce a un client di ottenere accesso non autorizzato alle informazioni sul sistema.</span><span class="sxs-lookup"><span data-stu-id="fab9b-105">Impersonation prevents a client from obtaining unauthorized access to information on the system.</span></span>

<span data-ttu-id="fab9b-106">Le sezioni seguenti sono illustrate in questo argomento:</span><span class="sxs-lookup"><span data-stu-id="fab9b-106">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="fab9b-107">Registrazione di un provider per la rappresentazione</span><span class="sxs-lookup"><span data-stu-id="fab9b-107">Registering a Provider for Impersonation</span></span>](#registering-a-provider-for-impersonation)
-   [<span data-ttu-id="fab9b-108">Impostazione di livelli di rappresentazione in un provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-108">Setting Impersonation Levels Within a Provider</span></span>](#setting-impersonation-levels-within-a-provider)
-   [<span data-ttu-id="fab9b-109">Gestione di livelli di sicurezza in un provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-109">Maintaining Security Levels in a Provider</span></span>](#maintaining-security-levels-in-a-provider)
-   [<span data-ttu-id="fab9b-110">Gestione dei messaggi di accesso negato in un provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-110">Handling Access Denied Messages in a Provider</span></span>](#handling-access-denied-messages-in-a-provider)
-   [<span data-ttu-id="fab9b-111">Segnalazione di istanze parziali</span><span class="sxs-lookup"><span data-stu-id="fab9b-111">Reporting Partial Instances</span></span>](#reporting-partial-instances)
-   [<span data-ttu-id="fab9b-112">Segnalazione di enumerazioni parziali</span><span class="sxs-lookup"><span data-stu-id="fab9b-112">Reporting Partial Enumerations</span></span>](#reporting-partial-enumerations)
-   [<span data-ttu-id="fab9b-113">Debug del codice di accesso negato</span><span class="sxs-lookup"><span data-stu-id="fab9b-113">Debugging Your Access Denied Code</span></span>](#debugging-your-access-denied-code)
-   [<span data-ttu-id="fab9b-114">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="fab9b-114">Related topics</span></span>](#related-topics)

<span data-ttu-id="fab9b-115">WMI viene in genere eseguito come servizio amministrativo a un livello di sicurezza elevato, usando il contesto di sicurezza LocalServer.</span><span class="sxs-lookup"><span data-stu-id="fab9b-115">WMI typically runs as an administrative service at a high security level, using the LocalServer security context.</span></span> <span data-ttu-id="fab9b-116">L'utilizzo di un servizio amministrativo fornisce a WMI i mezzi per accedere alle informazioni privilegiate.</span><span class="sxs-lookup"><span data-stu-id="fab9b-116">Using an administrative service gives WMI the means to access privileged information.</span></span> <span data-ttu-id="fab9b-117">Quando si chiama un provider per informazioni, WMI passa il proprio ID di sicurezza (SID) al provider, consentendo al provider di accedere alle informazioni allo stesso livello di sicurezza elevato.</span><span class="sxs-lookup"><span data-stu-id="fab9b-117">When calling a provider for information, WMI passes its security identifier (SID) to the provider, enabling the provider to access information at the same high security level.</span></span>

<span data-ttu-id="fab9b-118">Durante il processo di avvio dell'applicazione WMI, il sistema operativo Windows fornisce all'applicazione WMI il contesto di sicurezza dell'utente che ha avviato il processo.</span><span class="sxs-lookup"><span data-stu-id="fab9b-118">During the WMI application launch process, the Windows operating system gives the WMI application the security context of the user who began the process.</span></span> <span data-ttu-id="fab9b-119">Il contesto di sicurezza dell'utente è in genere un livello di sicurezza inferiore rispetto a LocalServer, pertanto l'utente potrebbe non disporre delle autorizzazioni necessarie per accedere a tutte le informazioni disponibili in WMI.</span><span class="sxs-lookup"><span data-stu-id="fab9b-119">The security context of the user is typically a lower security level than LocalServer, so the user may not have permission to access all of the information available to WMI.</span></span> <span data-ttu-id="fab9b-120">Quando l'applicazione utente richiede informazioni dinamiche, WMI passa il SID dell'utente al provider corrispondente.</span><span class="sxs-lookup"><span data-stu-id="fab9b-120">When the user application asks for dynamic information, WMI passes the SID of the user to the corresponding provider.</span></span> <span data-ttu-id="fab9b-121">Se scritto in modo appropriato, il provider tenta di accedere alle informazioni con il SID dell'utente, anziché il SID del provider.</span><span class="sxs-lookup"><span data-stu-id="fab9b-121">If written appropriately, the provider attempts to access information with the user SID, rather than the provider SID.</span></span>

<span data-ttu-id="fab9b-122">Affinché il provider rappresenti correttamente l'applicazione client, è necessario che l'applicazione client e il provider soddisfino i criteri seguenti:</span><span class="sxs-lookup"><span data-stu-id="fab9b-122">For the provider to successfully impersonate the client application, the client application and provider must meet the following criteria:</span></span>

-   <span data-ttu-id="fab9b-123">È necessario che l'applicazione client chiami WMI con un livello di sicurezza della connessione COM di **RPC \_ c \_ Imp level \_ \_ Impersonate** o di **RPC \_ c \_ Imp \_ level \_ delegate**.</span><span class="sxs-lookup"><span data-stu-id="fab9b-123">The client application must call WMI with a COM connection security level of **RPC\_C\_IMP\_LEVEL\_IMPERSONATE** or **RPC\_C\_IMP\_LEVEL\_DELEGATE**.</span></span> <span data-ttu-id="fab9b-124">Per ulteriori informazioni, vedere [gestione della sicurezza WMI](maintaining-wmi-security.md).</span><span class="sxs-lookup"><span data-stu-id="fab9b-124">For more information, see [Maintaining WMI Security](maintaining-wmi-security.md).</span></span>
-   <span data-ttu-id="fab9b-125">Il provider deve eseguire la registrazione con WMI come provider di rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-125">The provider must register with WMI as an impersonation provider.</span></span> <span data-ttu-id="fab9b-126">Per ulteriori informazioni, vedere la pagina relativa alla [registrazione di un provider per la rappresentazione](#registering-a-provider-for-impersonation).</span><span class="sxs-lookup"><span data-stu-id="fab9b-126">For more information, see [Registering a Provider for Impersonation](#registering-a-provider-for-impersonation).</span></span>
-   <span data-ttu-id="fab9b-127">Il provider deve passare al livello di sicurezza dell'applicazione client prima di accedere alle informazioni privilegiate.</span><span class="sxs-lookup"><span data-stu-id="fab9b-127">The provider must switch to the security level of the client application before accessing privileged information.</span></span> <span data-ttu-id="fab9b-128">Per ulteriori informazioni, vedere [impostazione dei livelli di rappresentazione in un provider](#setting-impersonation-levels-within-a-provider).</span><span class="sxs-lookup"><span data-stu-id="fab9b-128">For more information, see [Setting Impersonation Levels Within a Provider](#setting-impersonation-levels-within-a-provider).</span></span>
-   <span data-ttu-id="fab9b-129">Il provider deve gestire correttamente le condizioni di errore se l'accesso a queste informazioni viene negato.</span><span class="sxs-lookup"><span data-stu-id="fab9b-129">The provider must correctly handle error conditions if access to this information is denied.</span></span> <span data-ttu-id="fab9b-130">Per ulteriori informazioni, vedere [gestione dei messaggi di accesso negato in un provider](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="fab9b-130">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

## <a name="registering-a-provider-for-impersonation"></a><span data-ttu-id="fab9b-131">Registrazione di un provider per la rappresentazione</span><span class="sxs-lookup"><span data-stu-id="fab9b-131">Registering a Provider for Impersonation</span></span>

<span data-ttu-id="fab9b-132">WMI passa il SID di un'applicazione client solo ai provider che hanno eseguito la registrazione come provider di rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-132">WMI only passes the SID of a client application to providers who have registered as impersonation providers.</span></span> <span data-ttu-id="fab9b-133">Per consentire a un provider di eseguire la rappresentazione è necessario modificare il processo di registrazione del provider.</span><span class="sxs-lookup"><span data-stu-id="fab9b-133">Enabling a provider to perform impersonation requires that you modify the provider registration process.</span></span>

<span data-ttu-id="fab9b-134">Nella procedura riportata di seguito viene descritto come registrare un provider per la rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-134">The following procedure describes how to register a provider for impersonation.</span></span> <span data-ttu-id="fab9b-135">Nella procedura si presuppone che l'utente abbia già compreso il processo di registrazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-135">The procedure assumes that you already understand the registration process.</span></span> <span data-ttu-id="fab9b-136">Per ulteriori informazioni sul processo di registrazione, vedere la pagina relativa alla [registrazione di un provider](registering-a-provider.md).</span><span class="sxs-lookup"><span data-stu-id="fab9b-136">For more information about the registration process, see [Registering a Provider](registering-a-provider.md).</span></span>

<span data-ttu-id="fab9b-137">**Per registrare un provider per la rappresentazione**</span><span class="sxs-lookup"><span data-stu-id="fab9b-137">**To register a provider for impersonation**</span></span>

1.  <span data-ttu-id="fab9b-138">Impostare la proprietà [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) della classe [**\_ \_ Win32Provider**](--win32provider.md) che rappresenta il provider su 1.</span><span class="sxs-lookup"><span data-stu-id="fab9b-138">Set the [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property of the [**\_\_Win32Provider**](--win32provider.md) class that represents your provider to 1.</span></span>

    <span data-ttu-id="fab9b-139">La proprietà [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) documenta se il provider supporta o meno la rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-139">The [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property documents whether the provider supports impersonation or not.</span></span> <span data-ttu-id="fab9b-140">L'impostazione di **ImpersonationLevel** su 0 indica che il provider non rappresenta il client ed esegue tutte le operazioni richieste nello stesso contesto utente di WMI.</span><span class="sxs-lookup"><span data-stu-id="fab9b-140">Setting **ImpersonationLevel** to 0 indicates that the provider does not impersonate the client and performs all requested operations in the same user context as WMI.</span></span> <span data-ttu-id="fab9b-141">Se si imposta **ImpersonationLevel** su 1, il provider utilizza chiamate di rappresentazione per verificare le operazioni eseguite per conto del client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-141">Setting **ImpersonationLevel** to 1 indicates that the provider uses impersonation calls to check operations performed on behalf of the client.</span></span>

2.  <span data-ttu-id="fab9b-142">Impostare la proprietà **PerUserInitialization** della stessa classe [**\_ \_ Win32Provider**](--win32provider.md) su **true**.</span><span class="sxs-lookup"><span data-stu-id="fab9b-142">Set the **PerUserInitialization** property of the same [**\_\_Win32Provider**](--win32provider.md) class to **TRUE**.</span></span>

> [!Note]  
> <span data-ttu-id="fab9b-143">Se si registra un provider con la proprietà [**\_ \_ Win32Provider**](--win32provider.md) **InitializeAsAdminFirst** impostata su **true**, il provider utilizzerà il token di sicurezza thread a livello di amministrazione solo durante la fase di inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-143">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) property **InitializeAsAdminFirst** set to **TRUE**, then the provider uses the administration-level thread security token only during the initialization phase.</span></span> <span data-ttu-id="fab9b-144">Mentre una chiamata a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) non ha esito negativo, il provider usa il contesto di sicurezza di WMI e non del client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-144">While a call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not fail, the provider uses the security context of WMI and not of the client.</span></span>

 

<span data-ttu-id="fab9b-145">Nell'esempio di codice riportato di seguito viene illustrato come registrare un provider per la rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-145">The following code example shows how to register a provider for impersonation.</span></span>

``` syntax
instance of __Win32Provider
{
    CLSID = "{FD4F53E0-65DC-11d1-AB64-00C04FD9159E}";
    ImpersonationLevel = 1;
    Name = "MS_NT_EVENTLOG_PROVIDER";
    PerUserInitialization = TRUE;
};
```

## <a name="setting-impersonation-levels-within-a-provider"></a><span data-ttu-id="fab9b-146">Impostazione di livelli di rappresentazione in un provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-146">Setting Impersonation Levels Within a Provider</span></span>

<span data-ttu-id="fab9b-147">Se si registra un provider con la proprietà della classe [**\_ \_ Win32Provider**](--win32provider.md) [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) impostata su 1, WMI chiama il provider per rappresentare diversi client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-147">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) class property [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) set to 1, then WMI calls your provider to impersonate various clients.</span></span> <span data-ttu-id="fab9b-148">Per gestire queste chiamate, usare le funzioni com [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) e [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) nell'implementazione dell'interfaccia [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) .</span><span class="sxs-lookup"><span data-stu-id="fab9b-148">To handle these calls, use the [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) COM functions in your implementation of the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) interface.</span></span>

<span data-ttu-id="fab9b-149">La funzione [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) consente a un server di rappresentare il client che ha effettuato la chiamata.</span><span class="sxs-lookup"><span data-stu-id="fab9b-149">The [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) function allows a server to impersonate the client that made the call.</span></span> <span data-ttu-id="fab9b-150">Inserendo una chiamata a **CoImpersonateClient** nell'implementazione di [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), si consente al provider di impostare il token del thread del provider in modo che corrisponda al token del thread del client e quindi rappresentare il client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-150">By placing a call to **CoImpersonateClient** into your implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), you allow your provider to set the thread token of the provider to match the thread token of the client, and thus impersonate the client.</span></span> <span data-ttu-id="fab9b-151">Se non si chiama **CoImpersonateClient**, il provider esegue il codice a un livello di sicurezza di amministratore, creando così una potenziale vulnerabilità di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-151">If you do not call **CoImpersonateClient**, your provider executes code at an administrator level of security, thereby creating a potential security vulnerability.</span></span> <span data-ttu-id="fab9b-152">Se il provider deve agire temporaneamente come amministratore o eseguire manualmente il controllo dell'accesso, chiamare [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="fab9b-152">If your provider temporarily needs to act as an administrator or perform the access check manually, then call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span>

<span data-ttu-id="fab9b-153">A differenza di [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) è una funzione com che gestisce i livelli di rappresentazione del thread.</span><span class="sxs-lookup"><span data-stu-id="fab9b-153">In contrast to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is a COM function that handles thread impersonation levels.</span></span> <span data-ttu-id="fab9b-154">In questo caso, **CoRevertToSelf** modifica di nuovo il livello di rappresentazione nell'impostazione di rappresentazione originale.</span><span class="sxs-lookup"><span data-stu-id="fab9b-154">In this case, **CoRevertToSelf** changes the impersonation level back to the original impersonation setting.</span></span> <span data-ttu-id="fab9b-155">In generale, il provider è inizialmente un amministratore e si alterna tra **CoImpersonateClient** e **CoRevertToSelf** , a seconda che venga effettuato o meno una chiamata che rappresenta il chiamante o le proprie chiamate.</span><span class="sxs-lookup"><span data-stu-id="fab9b-155">In general, the provider is initially an administrator and alternates between **CoImpersonateClient** and **CoRevertToSelf** depending on whether it is making a call that represents the caller or its own calls.</span></span> <span data-ttu-id="fab9b-156">È responsabilità del provider inserire correttamente le chiamate in modo da non esporre un problema di sicurezza all'utente finale.</span><span class="sxs-lookup"><span data-stu-id="fab9b-156">It is the responsibility of the provider to place these calls correctly so as not to expose a security hole to the end user.</span></span> <span data-ttu-id="fab9b-157">Il provider, ad esempio, deve chiamare solo le funzioni Windows native all'interno della sequenza di codice rappresentata.</span><span class="sxs-lookup"><span data-stu-id="fab9b-157">For example, the provider should only call native Windows functions within the impersonated code sequence.</span></span>

> [!Note]  
> <span data-ttu-id="fab9b-158">Lo scopo di [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) e [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) è quello di impostare la sicurezza per un provider.</span><span class="sxs-lookup"><span data-stu-id="fab9b-158">The purpose of [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is to set security for a provider.</span></span> <span data-ttu-id="fab9b-159">Se si determina che la rappresentazione ha avuto esito negativo, è necessario restituire un codice di completamento appropriato a WMI tramite [**IWbemObjectSink:: sestato**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span><span class="sxs-lookup"><span data-stu-id="fab9b-159">If you determine that your impersonation has failed, you should return an appropriate completion code to WMI through [**IWbemObjectSink::SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span></span> <span data-ttu-id="fab9b-160">Per ulteriori informazioni, vedere [gestione dei messaggi di accesso negato in un provider](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="fab9b-160">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

 

## <a name="maintaining-security-levels-in-a-provider"></a><span data-ttu-id="fab9b-161">Gestione di livelli di sicurezza in un provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-161">Maintaining Security Levels in a Provider</span></span>

<span data-ttu-id="fab9b-162">I provider non possono chiamare [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) una sola volta in un'implementazione di [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) e presuppongono che le credenziali di rappresentazione rimangano valide per la durata del provider.</span><span class="sxs-lookup"><span data-stu-id="fab9b-162">Providers cannot call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) one time in an implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and assume that the impersonation credentials remain in place for the duration of the provider.</span></span> <span data-ttu-id="fab9b-163">Al contrario, chiamare **CoImpersonateClient** più volte nel corso di un'implementazione di per impedire la modifica delle credenziali da parte di WMI.</span><span class="sxs-lookup"><span data-stu-id="fab9b-163">Instead, call **CoImpersonateClient** multiple times during the course of an implementation to keep WMI from changing the credentials.</span></span>

<span data-ttu-id="fab9b-164">La preoccupazione principale per l'impostazione della rappresentazione per un provider è la rientranza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-164">The main concern for setting impersonation for a provider is reentrancy.</span></span> <span data-ttu-id="fab9b-165">In questo contesto, la rientranza si verifica quando un provider effettua una chiamata a WMI per informazioni e attende fino a quando WMI richiama il provider.</span><span class="sxs-lookup"><span data-stu-id="fab9b-165">In this context, reentrancy is when a provider makes a call to WMI for information and waits until WMI calls back into the provider.</span></span> <span data-ttu-id="fab9b-166">In sostanza, il thread di esecuzione lascia il codice del provider, solo per reimmettere il codice in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="fab9b-166">In essence, the thread of execution leaves the provider code, only to reenter the code at a later date.</span></span> <span data-ttu-id="fab9b-167">Il rientro è parte della progettazione di COM e non è in genere un problema.</span><span class="sxs-lookup"><span data-stu-id="fab9b-167">Reentry is a part of the design of COM, and is generally not a concern.</span></span> <span data-ttu-id="fab9b-168">Tuttavia, quando il thread di esecuzione entra in WMI, il thread accetta i livelli di rappresentazione di WMI.</span><span class="sxs-lookup"><span data-stu-id="fab9b-168">However, when the thread of execution enters WMI, the thread takes on the impersonation levels of WMI.</span></span> <span data-ttu-id="fab9b-169">Quando il thread torna al provider, è necessario reimpostare i livelli di rappresentazione con un'altra chiamata a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span><span class="sxs-lookup"><span data-stu-id="fab9b-169">When the thread returns to the provider, you must reset the impersonation levels with another call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span></span>

<span data-ttu-id="fab9b-170">Per proteggersi da buchi di sicurezza nel provider, è necessario effettuare chiamate rientranti in WMI solo quando si rappresenta il client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-170">To protect yourself from security holes in your provider, you should make reentrant calls into WMI only while impersonating the client.</span></span> <span data-ttu-id="fab9b-171">Ovvero, le chiamate a WMI devono essere effettuate dopo la chiamata a [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) e prima di chiamare [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="fab9b-171">That is, calls to WMI should be made after you call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and before you call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span> <span data-ttu-id="fab9b-172">Poiché **CoRevertToSelf** fa sì che la rappresentazione sia impostata sul livello utente, WMI è in esecuzione, in genere LocalSystem, le chiamate rientranti a WMI dopo la chiamata di **CoRevertToSelf** potrebbero dare all'utente e a tutti i provider chiamati, molto più funzionalità del necessario.</span><span class="sxs-lookup"><span data-stu-id="fab9b-172">Because **CoRevertToSelf** causes the impersonation to be set to the user level WMI is running, generally LocalSystem, reentrant calls to WMI after calling **CoRevertToSelf** could give the user, and any providers called, a lot more capabilities than they should have.</span></span>

> [!Note]  
> <span data-ttu-id="fab9b-173">Se si chiama una funzione di sistema o un altro metodo di interfaccia, non è garantito che il contesto di chiamata venga mantenuto.</span><span class="sxs-lookup"><span data-stu-id="fab9b-173">If you call a system function or another interface method, the call context is not guaranteed to be maintained.</span></span>

 

## <a name="handling-access-denied-messages-in-a-provider"></a><span data-ttu-id="fab9b-174">Gestione dei messaggi di accesso negato in un provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-174">Handling Access Denied Messages in a Provider</span></span>

<span data-ttu-id="fab9b-175">La maggior parte dei messaggi di errore di accesso negato viene visualizzata quando un client richiede una classe o informazioni a cui non ha accesso.</span><span class="sxs-lookup"><span data-stu-id="fab9b-175">Most Access Denied error messages appear when a client requests a class or information to which they do not have access.</span></span> <span data-ttu-id="fab9b-176">Se il provider restituisce un messaggio di errore di accesso negato a WMI e WMI lo passa al client, il client può dedurre che esistono le informazioni.</span><span class="sxs-lookup"><span data-stu-id="fab9b-176">If the provider returns an Access Denied error message to WMI and WMI passes this on to the client, the client can infer that the information exists.</span></span> <span data-ttu-id="fab9b-177">In alcune situazioni, può trattarsi di una violazione della sicurezza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-177">In some situations, this can be a breach of security.</span></span> <span data-ttu-id="fab9b-178">Pertanto, il provider non deve propagare il messaggio al client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-178">Therefore, your provider should not propagate the message to the client.</span></span> <span data-ttu-id="fab9b-179">Al contrario, il set di classi che il provider fornirebbe non dovrebbe essere esposto.</span><span class="sxs-lookup"><span data-stu-id="fab9b-179">Instead, the set of classes that the provider would have supplied should not be exposed.</span></span> <span data-ttu-id="fab9b-180">Analogamente, un provider di istanze dinamico deve chiamare all'origine dati sottostante per determinare come gestire i messaggi di accesso negato.</span><span class="sxs-lookup"><span data-stu-id="fab9b-180">Similarly, a dynamic instance provider should call to the underlying data source to determine how to deal with Access Denied messages.</span></span> <span data-ttu-id="fab9b-181">È responsabilità del provider replicare tale filosofia nell'ambiente WMI.</span><span class="sxs-lookup"><span data-stu-id="fab9b-181">It is the responsibility of the provider to replicate that philosophy into the WMI environment.</span></span> <span data-ttu-id="fab9b-182">Per ulteriori informazioni, vedere [segnalazione di istanze parziali](#reporting-partial-instances) e [segnalazione di enumerazioni parziali](#reporting-partial-enumerations).</span><span class="sxs-lookup"><span data-stu-id="fab9b-182">For more information, see [Reporting Partial Instances](#reporting-partial-instances) and [Reporting Partial Enumerations](#reporting-partial-enumerations).</span></span>

<span data-ttu-id="fab9b-183">Quando si determina il modo in cui il provider deve gestire i messaggi di accesso negato, è necessario scrivere ed eseguire il debug del codice.</span><span class="sxs-lookup"><span data-stu-id="fab9b-183">When you determine how your provider should handle Access Denied messages, you must write and debug your code.</span></span> <span data-ttu-id="fab9b-184">Durante il debug, è spesso utile distinguere tra un rifiuto a causa di una rappresentazione bassa e una negazione a causa di un errore nel codice.</span><span class="sxs-lookup"><span data-stu-id="fab9b-184">While debugging, it is often convenient to distinguish between a denial due to low impersonation, and a denial due to an error in your code.</span></span> <span data-ttu-id="fab9b-185">È possibile utilizzare un semplice test nel codice per determinare la differenza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-185">You can use a simple test in your code to determine the difference.</span></span> <span data-ttu-id="fab9b-186">Per altre informazioni, vedere [debug del codice di accesso negato](#debugging-your-access-denied-code).</span><span class="sxs-lookup"><span data-stu-id="fab9b-186">For more information, see [Debugging your Access Denied Code](#debugging-your-access-denied-code).</span></span>

## <a name="reporting-partial-instances"></a><span data-ttu-id="fab9b-187">Segnalazione di istanze parziali</span><span class="sxs-lookup"><span data-stu-id="fab9b-187">Reporting Partial Instances</span></span>

<span data-ttu-id="fab9b-188">Un'occorrenza comune di un messaggio di accesso negato è quando WMI non è in grado di fornire tutte le informazioni per riempire un'istanza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-188">One common occurrence of an Access Denied message is when WMI cannot provide all the information to fill an instance.</span></span> <span data-ttu-id="fab9b-189">Un client, ad esempio, può avere l'autorità di visualizzare un oggetto unità disco rigido, ma potrebbe non avere l'autorità per verificare la quantità di spazio disponibile sull'unità disco rigido.</span><span class="sxs-lookup"><span data-stu-id="fab9b-189">For example, a client may have the authority to view a hard disk drive object, but may not have authority to see how much space is available on the hard disk drive itself.</span></span> <span data-ttu-id="fab9b-190">Il provider deve determinare come gestire qualsiasi situazione quando il provider non è in grado di riempire completamente un'istanza con proprietà a causa di una violazione di accesso.</span><span class="sxs-lookup"><span data-stu-id="fab9b-190">Your provider must determine how to handle any situation when the provider cannot completely fill an instance with properties due to an access violation.</span></span>

<span data-ttu-id="fab9b-191">WMI non richiede una singola risposta ai client con accesso parziale a un'istanza di.</span><span class="sxs-lookup"><span data-stu-id="fab9b-191">WMI does not require a single response to clients that have partial access to an instance.</span></span> <span data-ttu-id="fab9b-192">WMI versione 1. x, invece, consente al provider una delle opzioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="fab9b-192">Instead, WMI version 1.x allows the provider one of the following options:</span></span>

-   <span data-ttu-id="fab9b-193">Interrompere l'intera operazione con **WBEM \_ e \_ accesso \_ negato** e non restituire alcuna istanza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-193">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="fab9b-194">Restituisce un oggetto Error insieme a **WBEM \_ E \_ Access \_ Denied** per descrivere il motivo del rifiuto.</span><span class="sxs-lookup"><span data-stu-id="fab9b-194">Return an error object along with **WBEM\_E\_ACCESS\_DENIED**, to describe the reason for the denial.</span></span>

-   <span data-ttu-id="fab9b-195">Restituisce tutte le proprietà disponibili e riempie le proprietà non disponibili con **null**.</span><span class="sxs-lookup"><span data-stu-id="fab9b-195">Return all available properties, and fill unavailable properties with **NULL**.</span></span>

> [!Note]  
> <span data-ttu-id="fab9b-196">Assicurarsi che la restituzione di **WBEM \_ E \_ Access \_ Denied** non crei un problema di sicurezza nell'azienda.</span><span class="sxs-lookup"><span data-stu-id="fab9b-196">Make sure that returning **WBEM\_E\_ACCESS\_DENIED** does not create a security hole in your enterprise.</span></span>

 

## <a name="reporting-partial-enumerations"></a><span data-ttu-id="fab9b-197">Segnalazione di enumerazioni parziali</span><span class="sxs-lookup"><span data-stu-id="fab9b-197">Reporting Partial Enumerations</span></span>

<span data-ttu-id="fab9b-198">Un'altra occorrenza comune di una violazione di accesso è quando WMI non è in grado di restituire tutte le enumerazioni.</span><span class="sxs-lookup"><span data-stu-id="fab9b-198">Another common occurrence of an access violation is when WMI cannot return all of an enumeration.</span></span> <span data-ttu-id="fab9b-199">Ad esempio, un client può avere accesso per visualizzare tutti gli oggetti computer della rete locale, ma potrebbe non avere accesso per visualizzare gli oggetti computer all'esterno del suo dominio.</span><span class="sxs-lookup"><span data-stu-id="fab9b-199">For example, a client may have access to view all of the local network computer objects, but may not have access to view computer objects outside of his domain.</span></span> <span data-ttu-id="fab9b-200">Il provider deve determinare come gestire una situazione in cui non è possibile completare un'enumerazione a causa di una violazione di accesso.</span><span class="sxs-lookup"><span data-stu-id="fab9b-200">Your provider must determine how to handle any situation when an enumeration cannot be completed due to an access violation.</span></span>

<span data-ttu-id="fab9b-201">Come per un provider di istanze, WMI non richiede una singola risposta a un'enumerazione parziale.</span><span class="sxs-lookup"><span data-stu-id="fab9b-201">As with an instance provider, WMI does not require a single response to a partial enumeration.</span></span> <span data-ttu-id="fab9b-202">WMI versione 1. x consente invece a un provider una delle opzioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="fab9b-202">Instead, WMI version 1.x allows a provider one of the following options:</span></span>

-   <span data-ttu-id="fab9b-203">Restituisce **WBEM \_ S \_ nessun \_ errore** per tutte le istanze a cui il provider può accedere.</span><span class="sxs-lookup"><span data-stu-id="fab9b-203">Return **WBEM\_S\_NO\_ERROR** for all instances that the provider can access.</span></span>

    <span data-ttu-id="fab9b-204">Se si usa questa opzione, l'utente non è a conoscenza del fatto che alcune istanze non erano disponibili.</span><span class="sxs-lookup"><span data-stu-id="fab9b-204">If you use this option, the user is not aware that some instances were not available.</span></span> <span data-ttu-id="fab9b-205">Alcuni provider, ad esempio quelli che utilizzano Structured Query Language (SQL) con sicurezza a livello di riga, restituiscono risultati parziali riusciti utilizzando il livello di sicurezza del chiamante per definire il set di risultati.</span><span class="sxs-lookup"><span data-stu-id="fab9b-205">A number of providers, such as those using Structured Query Language (SQL) with row-level security, return successful partial results using the security level of the caller to define the result set.</span></span>

-   <span data-ttu-id="fab9b-206">Interrompere l'intera operazione con **WBEM \_ e \_ accesso \_ negato** e non restituire alcuna istanza.</span><span class="sxs-lookup"><span data-stu-id="fab9b-206">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="fab9b-207">Il provider può includere facoltativamente un oggetto Error che descrive la situazione al client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-207">The provider may optionally include an error object that describes the situation to the client.</span></span> <span data-ttu-id="fab9b-208">Si noti che alcuni provider possono accedere alle origini dati in modo seriale e potrebbero non essere in grado di rilevare i rifiuti fino a legato tramite l'enumerazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-208">Note that some providers may access data sources serially and may not encounter denials until partway through the enumeration.</span></span>

-   <span data-ttu-id="fab9b-209">Restituisce tutte le istanze a cui è possibile accedere, ma restituisce anche il codice di stato non di errore. **\_ \_ accesso \_ negato**.</span><span class="sxs-lookup"><span data-stu-id="fab9b-209">Return all of the instances that can be accessed but also return the nonerror status code **WBEM\_S\_ACCESS\_DENIED**.</span></span>

    <span data-ttu-id="fab9b-210">Il provider deve prendere nota del rifiuto durante l'enumerazione e può continuare a fornire istanze, terminando con il codice di stato non di errore.</span><span class="sxs-lookup"><span data-stu-id="fab9b-210">The provider should note the denial during enumeration and may continue providing instances, finishing up with the nonerror status code.</span></span> <span data-ttu-id="fab9b-211">Il provider può inoltre decidere di terminare l'enumerazione al primo rifiuto.</span><span class="sxs-lookup"><span data-stu-id="fab9b-211">The provider may also elect to terminate the enumeration at the first denial.</span></span> <span data-ttu-id="fab9b-212">La giustificazione di questa opzione è che provider diversi hanno paradigmi di recupero diversi.</span><span class="sxs-lookup"><span data-stu-id="fab9b-212">The justification for this option is that different providers have different retrieval paradigms.</span></span> <span data-ttu-id="fab9b-213">È possibile che un provider abbia già recapitato le istanze prima di individuare una violazione di accesso.</span><span class="sxs-lookup"><span data-stu-id="fab9b-213">A provider may have already delivered instances before discovering an access violation.</span></span> <span data-ttu-id="fab9b-214">Alcuni provider possono decidere di continuare a fornire altre istanze e altri potrebbero voler terminare.</span><span class="sxs-lookup"><span data-stu-id="fab9b-214">Some providers may elect to continue providing other instances and others may wish to terminate.</span></span>

<span data-ttu-id="fab9b-215">A causa della struttura di COM, non è possibile eseguire il marshalling di tutte le informazioni durante un errore, ad eccezione di un oggetto Error.</span><span class="sxs-lookup"><span data-stu-id="fab9b-215">Due to the structure of COM, you cannot marshal back any information during an error except for an error object.</span></span> <span data-ttu-id="fab9b-216">Non è pertanto possibile restituire informazioni e un codice di errore.</span><span class="sxs-lookup"><span data-stu-id="fab9b-216">Therefore, you cannot return both information and an error code.</span></span> <span data-ttu-id="fab9b-217">Se si sceglie di restituire le informazioni, è necessario utilizzare invece un codice di stato non di errore.</span><span class="sxs-lookup"><span data-stu-id="fab9b-217">If you choose to return information, you must use a nonerror status code instead.</span></span>

## <a name="debugging-your-access-denied-code"></a><span data-ttu-id="fab9b-218">Debug del codice di accesso negato</span><span class="sxs-lookup"><span data-stu-id="fab9b-218">Debugging Your Access Denied Code</span></span>

<span data-ttu-id="fab9b-219">Per alcune applicazioni è possibile utilizzare livelli di rappresentazione inferiori rispetto a quello di **RPC \_ C \_ Imp \_ \_**.</span><span class="sxs-lookup"><span data-stu-id="fab9b-219">Some applications may use impersonation levels lower than **RPC\_C\_IMP\_LEVEL\_IMPERSONATE**.</span></span> <span data-ttu-id="fab9b-220">In questo caso, la maggior parte delle chiamate di rappresentazione effettuate dal provider per l'applicazione client avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="fab9b-220">In this case, most impersonation calls made by the provider for the client application will fail.</span></span> <span data-ttu-id="fab9b-221">Per progettare e implementare correttamente un provider, è necessario tenere presente questa idea.</span><span class="sxs-lookup"><span data-stu-id="fab9b-221">To successfully design and implement a provider, you must keep this idea in mind.</span></span>

<span data-ttu-id="fab9b-222">Per impostazione predefinita, l'unico altro livello di rappresentazione che può accedere a un provider è l' **identificazione a livello di RPC \_ C \_ \_ \_ Imp**.</span><span class="sxs-lookup"><span data-stu-id="fab9b-222">By default, the only other level of impersonation that can access a provider is **RPC\_C\_IMP\_LEVEL\_IDENTIFY**.</span></span> <span data-ttu-id="fab9b-223">Nei casi in cui un'applicazione client utilizza l' **identificazione a livello di RPC \_ C \_ \_ \_ Imp**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) non restituisce un codice di errore.</span><span class="sxs-lookup"><span data-stu-id="fab9b-223">In cases where a client application uses **RPC\_C\_IMP\_LEVEL\_IDENTIFY**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not return an error code.</span></span> <span data-ttu-id="fab9b-224">Il provider rappresenta invece il client solo a scopo di identificazione.</span><span class="sxs-lookup"><span data-stu-id="fab9b-224">Instead, the provider impersonates the client for identification purposes only.</span></span> <span data-ttu-id="fab9b-225">Pertanto, la maggior parte dei metodi di Windows chiamati dal provider restituirà un messaggio di accesso negato.</span><span class="sxs-lookup"><span data-stu-id="fab9b-225">Therefore, most Windows methods called by the provider will return an access denied message.</span></span> <span data-ttu-id="fab9b-226">Si tratta di una procedura innocua, in quanto gli utenti non saranno autorizzati a eseguire alcuna operazione inadeguata.</span><span class="sxs-lookup"><span data-stu-id="fab9b-226">This is harmless in practice, as users will not be permitted to do anything inappropriate.</span></span> <span data-ttu-id="fab9b-227">Tuttavia, può essere utile durante lo sviluppo del provider per sapere se il client è stato effettivamente rappresentato o meno.</span><span class="sxs-lookup"><span data-stu-id="fab9b-227">However, it may be useful during provider development to know whether the client was truly impersonated or not.</span></span>

<span data-ttu-id="fab9b-228">Il codice richiede i riferimenti seguenti e le \# istruzioni include per la compilazione corretta.</span><span class="sxs-lookup"><span data-stu-id="fab9b-228">The code requires the following references and \#include statements to compile correctly.</span></span>


```C++
#define _WIN32_DCOM
#include <iostream>
using namespace std;
#include <wbemidl.h>
```



<span data-ttu-id="fab9b-229">Nell'esempio di codice seguente viene illustrato come determinare se un provider ha rappresentato correttamente un'applicazione client.</span><span class="sxs-lookup"><span data-stu-id="fab9b-229">The following code example shows how to determine whether a provider has successfully impersonated a client application.</span></span>


```C++
DWORD dwImp = 0;
HANDLE hThreadTok;
DWORD dwBytesReturned;
BOOL bRes;

// You must call this before trying to open a thread token!
CoImpersonateClient();

bRes = OpenThreadToken(
    GetCurrentThread(),
    TOKEN_QUERY,
    TRUE,
    &hThreadTok
);

if (bRes == FALSE)
{
    printf("Unable to read thread token (%d)\n", GetLastError());
    return 0;
}

bRes = GetTokenInformation(
    hThreadTok,
    TokenImpersonationLevel, 
    &dwImp,
    sizeof(DWORD),
    &dwBytesReturned
);

if (!bRes)
{
    printf("Unable to read impersonation level\n");
    CloseHandle(hThreadTok);
    return 0;
}

switch (dwImp)
{
case SecurityAnonymous:
    printf("SecurityAnonymous\n");
    break;

case SecurityIdentification:
    printf("SecurityIdentification\n");
    break;

case SecurityImpersonation:
    printf("SecurityImpersonation\n");
    break;

case SecurityDelegation:
    printf("SecurityDelegation\n");
    break;

default:
    printf("Error. Unable to determine impersonation level\n");
    break;
}

CloseHandle(hThreadTok);
```



## <a name="related-topics"></a><span data-ttu-id="fab9b-230">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="fab9b-230">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="fab9b-231">Sviluppo di un provider WMI</span><span class="sxs-lookup"><span data-stu-id="fab9b-231">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> <dt>

[<span data-ttu-id="fab9b-232">Impostazione di descrittori di sicurezza spazio dei nomi</span><span class="sxs-lookup"><span data-stu-id="fab9b-232">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="fab9b-233">Sicurezza del provider</span><span class="sxs-lookup"><span data-stu-id="fab9b-233">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> </dl>

 

 
