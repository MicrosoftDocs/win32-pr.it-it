---
title: Implementazione del conteggio dei riferimenti
description: Implementazione del conteggio dei riferimenti
ms.assetid: d4fd98c9-afa4-4c5c-a3c9-44d34881cbdb
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a0d4dfe2b0faf2fc6557d1b089e33ae6ce4b98cb
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/21/2020
ms.locfileid: "106300554"
---
# <a name="implementing-reference-counting"></a><span data-ttu-id="4b8ee-103">Implementazione del conteggio dei riferimenti</span><span class="sxs-lookup"><span data-stu-id="4b8ee-103">Implementing Reference Counting</span></span>

<span data-ttu-id="4b8ee-104">Il conteggio dei riferimenti richiede il lavoro sulla parte sia dell'implementatore di una classe che dei client che utilizzano oggetti di tale classe.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-104">Reference counting requires work on the part of both the implementor of a class and the clients who use objects of that class.</span></span> <span data-ttu-id="4b8ee-105">Quando si implementa una classe, è necessario implementare i metodi [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) e [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) come parte dell'interfaccia [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="4b8ee-105">When you implement a class, you must implement the [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) and [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) methods as part of the [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="4b8ee-106">Questi due metodi hanno le seguenti implementazioni semplici:</span><span class="sxs-lookup"><span data-stu-id="4b8ee-106">These two methods have the following simple implementations:</span></span>

-   <span data-ttu-id="4b8ee-107">[**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) incrementa il conteggio dei riferimenti interni dell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-107">[**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) increments the object's internal reference count.</span></span>
-   <span data-ttu-id="4b8ee-108">[**Rilascia**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) innanzitutto decrementa il conteggio dei riferimenti interni dell'oggetto, quindi controlla se il conteggio dei riferimenti è sceso a zero.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-108">[**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) first decrements the object's internal reference count, and then it checks whether the reference count has fallen to zero.</span></span> <span data-ttu-id="4b8ee-109">In caso affermativo, significa che nessuno sta usando più l'oggetto, quindi la funzione **Release** dealloca l'oggetto.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-109">If it has, that means no one is using the object any longer, so the **Release** function deallocates the object.</span></span>

<span data-ttu-id="4b8ee-110">Un approccio di implementazione comune per la maggior parte degli oggetti consiste nel disporre di una sola implementazione di questi metodi (insieme a [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), che viene condivisa tra tutte le interfacce e, di conseguenza, un conteggio dei riferimenti applicato all'intero oggetto.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-110">A common implementation approach for most objects is to have only one implementation of these methods (along with [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), which is shared between all interfaces, and therefore a reference count that applies to the entire object.</span></span> <span data-ttu-id="4b8ee-111">Tuttavia, dal punto di vista del client, il conteggio dei riferimenti è rigorosamente e chiaramente una nozione di puntatore per interfaccia e pertanto gli oggetti che sfruttano questa funzionalità creando dinamicamente, eliminando, caricando o scaricando parti della loro funzionalità in base ai puntatori di interfaccia attualmente esistenti possono essere implementati.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-111">However, from a client's perspective, reference counting is strictly and clearly a per-interface-pointer notion, and therefore objects that take advantage of this capability by dynamically constructing, destroying, loading, or unloading portions of their functionality based on the currently extant interface pointers may be implemented.</span></span> <span data-ttu-id="4b8ee-112">Queste interfacce sono comunemente dette *interfacce di strappo*.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-112">These are colloquially called *tear-off interfaces*.</span></span>

<span data-ttu-id="4b8ee-113">Ogni volta che un client chiama un metodo (o funzione API), ad esempio [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), che restituisce un nuovo puntatore di interfaccia, il metodo chiamato è responsabile dell'incremento del conteggio dei riferimenti tramite il puntatore restituito.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-113">Whenever a client calls a method (or API function), such as [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), that returns a new interface pointer, the method being called is responsible for incrementing the reference count through the returned pointer.</span></span> <span data-ttu-id="4b8ee-114">Ad esempio, quando un client crea prima un oggetto, riceve un puntatore di interfaccia a un oggetto che, dal punto di vista del client, ha un conteggio dei riferimenti di uno.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-114">For example, when a client first creates an object, it receives an interface pointer to an object that, from the client's point of view, has a reference count of one.</span></span> <span data-ttu-id="4b8ee-115">Se il client chiama [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) sul puntatore a interfaccia, il conteggio dei riferimenti diventa due.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-115">If the client then calls [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) on the interface pointer, the reference count becomes two.</span></span> <span data-ttu-id="4b8ee-116">Il client deve chiamare il [**rilascio**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) due volte sul puntatore a interfaccia per eliminare tutti i relativi riferimenti all'oggetto.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-116">The client must call [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) twice on the interface pointer to drop all of its references to the object.</span></span>

<span data-ttu-id="4b8ee-117">Un esempio di come i conteggi dei riferimenti sono rigorosamente per interfaccia-puntatore si verifica quando un client chiama [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) sul primo puntatore per una nuova interfaccia o la stessa interfaccia.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-117">An example of how reference counts are strictly per-interface-pointer occurs when a client calls [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) on the first pointer for either a new interface or the same interface.</span></span> <span data-ttu-id="4b8ee-118">In entrambi i casi, è necessario che il client chiami [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) una volta per ogni puntatore.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-118">In either of these cases, the client is required to call [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) once for each pointer.</span></span> <span data-ttu-id="4b8ee-119">COM non richiede che un oggetto restituisca lo stesso puntatore quando viene richiesta la stessa interfaccia più volte.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-119">COM does not require that an object return the same pointer when asked for the same interface multiple times.</span></span> <span data-ttu-id="4b8ee-120">L'unica eccezione è costituita da una query a [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), che identifica un oggetto a com. Ciò consente all'implementazione dell'oggetto di gestire le risorse in modo efficiente.</span><span class="sxs-lookup"><span data-stu-id="4b8ee-120">(The only exception to this is a query to [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), which identifies an object to COM.) This allows the object implementation to manage resources efficiently.</span></span>

<span data-ttu-id="4b8ee-121">La thread-safety rappresenta anche un problema importante nell'implementazione di [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) e [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span><span class="sxs-lookup"><span data-stu-id="4b8ee-121">Thread-safety is also an important issue in implementing [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) and [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="4b8ee-122">Per ulteriori informazioni, vedere [processi, thread e Apartment](processes--threads--and-apartments.md).</span><span class="sxs-lookup"><span data-stu-id="4b8ee-122">For more information, see [Processes, Threads, and Apartments](processes--threads--and-apartments.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="4b8ee-123">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="4b8ee-123">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4b8ee-124">Gestione della durata degli oggetti tramite il conteggio dei riferimenti</span><span class="sxs-lookup"><span data-stu-id="4b8ee-124">Managing Object Lifetimes Through Reference Counting</span></span>](managing-object-lifetimes-through-reference-counting.md)
</dt> </dl>

 

 