---
title: Problemi di threading del server In-Process
description: Problemi di threading del server In-Process
ms.assetid: 7bd6f62f-8c91-44bd-9a7f-d47988180eed
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8a9d02af739eac11a6adae62de76be9078ee8e32
ms.sourcegitcommit: 89f99926f946dc6c5ea600fb7c41f6b19ceac516
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/21/2020
ms.locfileid: "104399919"
---
# <a name="in-process-server-threading-issues"></a><span data-ttu-id="6ad3f-103">Problemi di threading del server In-Process</span><span class="sxs-lookup"><span data-stu-id="6ad3f-103">In-Process Server Threading Issues</span></span>

<span data-ttu-id="6ad3f-104">Un server in-process non chiama [**CoInitialize**](/windows/desktop/api/Objbase/nf-objbase-coinitialize), [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex)o [**OleInitialize**](/windows/desktop/api/Ole2/nf-ole2-oleinitialize) per contrassegnare il modello di Threading.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-104">An in-process server does not call [**CoInitialize**](/windows/desktop/api/Objbase/nf-objbase-coinitialize), [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex), or [**OleInitialize**](/windows/desktop/api/Ole2/nf-ole2-oleinitialize) to mark its threading model.</span></span> <span data-ttu-id="6ad3f-105">Per gli oggetti basati su DLL o in-process compatibili con i thread, è necessario impostare il modello di threading nel registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-105">For thread-aware DLL-based or in-process objects, you need to set the threading model in the registry.</span></span> <span data-ttu-id="6ad3f-106">Il modello predefinito quando non si specifica un modello di threading è a thread singolo per processo.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-106">The default model when you do not specify a threading model is single-thread-per-process.</span></span> <span data-ttu-id="6ad3f-107">Per specificare un modello, aggiungere il valore **ThreadingModel** alla chiave [InprocServer32](inprocserver32.md) nel registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-107">To specify a model, you add the **ThreadingModel** value to the [InprocServer32](inprocserver32.md) key in the registry.</span></span>

<span data-ttu-id="6ad3f-108">Le dll che supportano la creazione di un'istanza di un oggetto classe devono implementare ed esportare le funzioni [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) e [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow).</span><span class="sxs-lookup"><span data-stu-id="6ad3f-108">DLLs that support instantiation of a class object must implement and export the functions [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow).</span></span> <span data-ttu-id="6ad3f-109">Quando un client desidera un'istanza della classe supportata dalla DLL, una chiamata a [**CoGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetclassobject) (direttamente o tramite una chiamata a [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)) chiama **DllGetClassObject** per ottenere un puntatore all'oggetto classe quando l'oggetto viene implementato in una dll.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-109">When a client wants an instance of the class the DLL supports, a call to [**CoGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetclassobject) (either directly or through a call to [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)) calls **DllGetClassObject** to get a pointer to its class object when the object is implemented in a DLL.</span></span> <span data-ttu-id="6ad3f-110">**DllGetClassObject** deve pertanto essere in grado di fornire più oggetti classe o un singolo oggetto thread-safe (essenzialmente utilizzando [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement) / [**InterlockedDecrement**](/windows/desktop/api/winbase/nf-winbase-interlockeddecrement) sui rispettivi conteggi dei riferimenti interni).</span><span class="sxs-lookup"><span data-stu-id="6ad3f-110">**DllGetClassObject** should therefore be able to give away multiple class objects or a single thread-safe object (essentially just using [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement)/[**InterlockedDecrement**](/windows/desktop/api/winbase/nf-winbase-interlockeddecrement) on their internal reference counts).</span></span>

<span data-ttu-id="6ad3f-111">Come suggerisce il nome, viene chiamato [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow) per determinare se la dll che lo implementa è in uso, consentendo al chiamante di scaricarla in modo sicuro in caso contrario.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-111">As its name implies, [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow) is called to determine whether the DLL that implements it is in use, enabling the caller to safely unload it if it is not.</span></span> <span data-ttu-id="6ad3f-112">Le chiamate a [**CoFreeUnusedLibraries**](/windows/desktop/api/combaseapi/nf-combaseapi-cofreeunusedlibraries) da qualsiasi thread vengono sempre indirizzate attraverso il thread dell'Apartment principale per chiamare **DllCanUnloadNow**.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-112">Calls to [**CoFreeUnusedLibraries**](/windows/desktop/api/combaseapi/nf-combaseapi-cofreeunusedlibraries) from any thread always route through the main apartment's thread to call **DllCanUnloadNow**.</span></span>

<span data-ttu-id="6ad3f-113">Analogamente ad altri server, i server in-process possono essere a thread singolo, a thread apartment o a thread libero.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-113">Like other servers, in-process servers can be single-threaded, apartment-threaded, or free-threaded.</span></span> <span data-ttu-id="6ad3f-114">Questi server possono essere utilizzati da qualsiasi client OLE, indipendentemente dal modello di threading utilizzato da tale client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-114">These servers can be used by any OLE client, regardless of the threading model used by that client.</span></span>

<span data-ttu-id="6ad3f-115">Sono consentite tutte le combinazioni di interoperabilità del modello di threading tra client e oggetti in-process.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-115">All combinations of threading model interoperability are allowed between clients and in-process objects.</span></span> <span data-ttu-id="6ad3f-116">L'interazione tra un client e un oggetto in-process che utilizza modelli di threading diversi è esattamente come l'interazione tra client e server out-of-process.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-116">Interaction between a client and an in-process object that use different threading models is exactly like the interaction between clients and out-of-process servers.</span></span> <span data-ttu-id="6ad3f-117">Per un server in-process, quando il modello di threading del client e del server in-process è diverso, è necessario che COM intervenga tra il client e l'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-117">For an in-process server, when the threading model of the client and in-process server differ, COM must interpose itself between the client and the object.</span></span>

<span data-ttu-id="6ad3f-118">Quando un oggetto in-process che supporta il modello a thread singolo viene chiamato simultaneamente da più thread di un client, COM non può consentire ai thread client di accedere direttamente al interfaceâ dell'oggetto. l'oggetto non è stato progettato per tale accesso.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-118">When an in-process object that supports the single-threaded model is called simultaneously by multiple threads of a client, COM cannot allow the client threads to directly access the object's interfaceâ€”the object was not designed for such access.</span></span> <span data-ttu-id="6ad3f-119">COM deve invece garantire che le chiamate siano sincronizzate e vengano effettuate solo dal thread client che ha creato l'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-119">Instead, COM must ensure that calls are synchronized and are made only by the client thread that created the object.</span></span> <span data-ttu-id="6ad3f-120">Quindi, COM crea l'oggetto nell'Apartment principale del client e richiede che tutti gli altri appartamenti client accedano all'oggetto tramite proxy.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-120">Therefore, COM creates the object in the client's main apartment and requires all the other client apartments to access the object by using proxies.</span></span>

<span data-ttu-id="6ad3f-121">Quando un Apartment a thread libero (modello di Apartment a thread multipli) in un client crea un server in-process con threading di tipo Apartment, COM avvia un thread "host" del modello a thread singolo nel client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-121">When a free-threaded apartment (multithreaded apartment model) in a client creates an apartment-threaded in-process server, COM spins up a single-threaded apartment model "host" thread in the client.</span></span> <span data-ttu-id="6ad3f-122">Questo thread host creerà l'oggetto e verrà eseguito il marshalling del puntatore di interfaccia all'Apartment a thread libero del client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-122">This host thread will create the object, and the interface pointer will be marshaled back to the client's free-threaded apartment.</span></span> <span data-ttu-id="6ad3f-123">Analogamente, quando un Apartment a thread singolo in un client modello di Apartment crea un server in-process a thread libero, COM avvia un thread host a thread libero (Apartment multithread in cui l'oggetto verrà creato e di cui viene eseguito il marshalling all'Apartment a thread singolo client).</span><span class="sxs-lookup"><span data-stu-id="6ad3f-123">Similarly, when a single-threaded apartment in an apartment-model client creates a free-threaded in-process server, COM spins up a free-threaded host thread (multithreaded apartment on which the object will be created and then marshaled back to the client single-threaded apartment).</span></span>

> [!Note]  
> <span data-ttu-id="6ad3f-124">In generale, se si progetta un'interfaccia personalizzata in un server in-process, è necessario fornire anche il codice di marshalling in modo che COM possa effettuare il marshalling dell'interfaccia tra Apartment client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-124">In general, if you design a custom interface on an in-process server, you should also provide the marshaling code for it so that COM can marshal the interface between client apartments.</span></span>

 

<span data-ttu-id="6ad3f-125">COM consente di proteggere l'accesso agli oggetti forniti da una DLL a thread singolo richiedendo l'accesso dallo stesso Apartment client in cui sono stati creati.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-125">COM helps protect access to objects provided by a single-threaded DLL by requiring access from the same client apartment in which they were created.</span></span> <span data-ttu-id="6ad3f-126">Inoltre, tutti i punti di ingresso della DLL, ad esempio [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) e [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow), e i dati globali devono essere sempre accessibili dallo stesso Apartment.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-126">In addition, all of the DLL entry points (like [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) and global data should always be accessed by the same apartment.</span></span> <span data-ttu-id="6ad3f-127">COM crea tali oggetti nell'Apartment principale del client, concedendo all'Apartment principale l'accesso diretto ai puntatori dell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-127">COM creates such objects in the main apartment of the client, giving the main apartment direct access to the object's pointers.</span></span> <span data-ttu-id="6ad3f-128">Le chiamate dagli altri appartamenti usano il marshalling di interthreading per passare dal proxy allo stub nell'Apartment principale e quindi all'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-128">Calls from the other apartments use interthread marshaling to go from the proxy to the stub in the main apartment and then to the object.</span></span> <span data-ttu-id="6ad3f-129">Ciò consente a COM di sincronizzare le chiamate all'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-129">This allows COM to synchronize calls to the object.</span></span> <span data-ttu-id="6ad3f-130">Le chiamate interthreading sono lente, quindi è consigliabile riscrivere questi server per supportare più Apartment.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-130">Interthread calls are slow, so it is recommended that these servers be rewritten to support multiple apartments.</span></span>

<span data-ttu-id="6ad3f-131">Analogamente a un server in-process a thread singolo, è necessario che venga eseguito l'accesso a un oggetto fornito da una DLL del modello Apartment dallo stesso Apartment client da cui è stato creato.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-131">Like a single-threaded in-process server, an object provided by an apartment model DLL must be accessed by the same client apartment from which it was created.</span></span> <span data-ttu-id="6ad3f-132">Tuttavia, gli oggetti forniti da questo server possono essere creati in più Apartment del client, quindi il server deve implementare i relativi punti di ingresso (ad esempio [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) e [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) per l'uso multithread.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-132">However, objects provided by this server can be created in multiple apartments of the client, so the server must implement its entry points (like [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) for multithreaded use.</span></span> <span data-ttu-id="6ad3f-133">Se, ad esempio, due Apartment di un client tentano di creare contemporaneamente due istanze dell'oggetto in-process, è possibile chiamare **DllGetClassObject** contemporaneamente da entrambi gli Apartment.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-133">For example, if two apartments of a client try to create two instances of the in-process object simultaneously, **DllGetClassObject** can be called simultaneously by both apartments.</span></span> <span data-ttu-id="6ad3f-134">È necessario scrivere **DllCanUnloadNow** in modo che la dll non venga scaricata mentre il codice è ancora in esecuzione nella dll.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-134">**DllCanUnloadNow** must be written so that the DLL does not unload while code is still executing in the DLL.</span></span>

<span data-ttu-id="6ad3f-135">Se la DLL fornisce solo un'istanza del class factory per creare tutti gli oggetti, l'implementazione di class factory deve essere progettata anche per l'uso multithreading, perché sarà accessibile da più Apartment client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-135">If the DLL provides only one instance of the class factory to create all the objects, the class factory implementation must also be designed for multithreaded use, because it will be accessed by multiple client apartments.</span></span> <span data-ttu-id="6ad3f-136">Se la DLL crea una nuova istanza del class factory ogni volta che viene chiamato [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) , il class factory non deve essere thread-safe.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-136">If the DLL creates a new instance of the class factory each time [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) is called, the class factory need not be thread-safe.</span></span>

<span data-ttu-id="6ad3f-137">Gli oggetti creati dal class factory non devono essere thread-safe.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-137">Objects created by the class factory need not be thread-safe.</span></span> <span data-ttu-id="6ad3f-138">Una volta creata da un thread, viene sempre eseguito l'accesso all'oggetto tramite tale thread e tutte le chiamate all'oggetto vengono sincronizzate da COM.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-138">Once created by a thread, the object is always accessed through that thread and all calls to the object are synchronized by COM.</span></span> <span data-ttu-id="6ad3f-139">L'Apartment del modello di Apartment di un client che crea questo oggetto otterrà un puntatore diretto all'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-139">The apartment model apartment of a client that creates this object will get a direct pointer to the object.</span></span> <span data-ttu-id="6ad3f-140">Gli appartamenti client diversi dall'Apartment in cui è stato creato l'oggetto devono accedere all'oggetto tramite proxy.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-140">Client apartments that are different from the apartment in which the object was created must access the object through proxies.</span></span> <span data-ttu-id="6ad3f-141">Questi proxy vengono creati quando il client esegue il marshalling dell'interfaccia tra gli appartamenti.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-141">These proxies are created when the client marshals the interface between its apartments.</span></span>

<span data-ttu-id="6ad3f-142">Quando un valore **ThreadingModel** della dll in-process è impostato su "both", un oggetto fornito da questa dll può essere creato e usato direttamente (senza un proxy) negli Apartment client a thread singolo o multithreading.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-142">When an in-process DLL **ThreadingModel** value is set to "Both", an object provided by this DLL can be created and used directly (without a proxy) in single-threaded or multithreaded client apartments.</span></span> <span data-ttu-id="6ad3f-143">Tuttavia, può essere utilizzato direttamente solo nell'Apartment in cui è stato creato.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-143">However, it can be used directly only within the apartment in which it was created.</span></span> <span data-ttu-id="6ad3f-144">Per assegnare l'oggetto a qualsiasi altro Apartment, è necessario effettuare il marshalling dell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-144">To give the object to any other apartment, the object must be marshaled.</span></span> <span data-ttu-id="6ad3f-145">L'oggetto DLL deve implementare una sincronizzazione personalizzata ed è possibile accedervi da più Apartment client nello stesso momento.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-145">The DLL object must implement its own synchronization and can be accessed by multiple client apartments at the same time.</span></span>

<span data-ttu-id="6ad3f-146">Per velocizzare le prestazioni per l'accesso a thread libero a oggetti DLL in-process, COM fornisce la funzione [**CoCreateFreeThreadedMarshaler**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreatefreethreadedmarshaler) .</span><span class="sxs-lookup"><span data-stu-id="6ad3f-146">To speed performance for free-threaded access to in-process DLL objects, COM provides the [**CoCreateFreeThreadedMarshaler**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreatefreethreadedmarshaler) function.</span></span> <span data-ttu-id="6ad3f-147">Questa funzione crea un oggetto di marshalling a thread libero che può essere aggregato con un oggetto server in-process.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-147">This function creates a free-threaded marshaling object that can be aggregated with an in-process server object.</span></span> <span data-ttu-id="6ad3f-148">Quando un Apartment client nello stesso processo richiede l'accesso a un oggetto in un altro Apartment, l'aggregazione del gestore di marshalling a thread libero fornisce al client un puntatore diretto all'oggetto server, anziché a un proxy, quando il client esegue il marshalling dell'interfaccia dell'oggetto in un apartment diverso.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-148">When a client apartment in the same process needs access to an object in another apartment, aggregating the free-threaded marshaler provides the client with a direct pointer to the server object, rather than to a proxy, when the client marshals the object's interface to a different apartment.</span></span> <span data-ttu-id="6ad3f-149">Il client non deve eseguire alcuna sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-149">The client does not need to do any synchronization.</span></span> <span data-ttu-id="6ad3f-150">Funziona solo all'interno dello stesso processo. il marshalling standard viene usato per un riferimento all'oggetto inviato a un altro processo.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-150">This works only within the same process; standard marshaling is used for a reference to the object that is sent to another process.</span></span>

<span data-ttu-id="6ad3f-151">Un oggetto fornito da una DLL in-process che supporta solo il threading libero è un oggetto a thread libero.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-151">An object provided by an in-process DLL that supports only free threading is a free-threaded object.</span></span> <span data-ttu-id="6ad3f-152">Implementa la propria sincronizzazione ed è possibile accedervi contemporaneamente da più thread client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-152">It implements its own synchronization and can be accessed by multiple client threads at the same time.</span></span> <span data-ttu-id="6ad3f-153">Questo server non esegue il marshalling delle interfacce tra thread, quindi questo server può essere creato e usato direttamente (senza proxy) solo da Apartment con multithreading in un client.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-153">This server does not marshal interfaces between threads, so this server can be created and used directly (without a proxy) only by multithreaded apartments in a client.</span></span> <span data-ttu-id="6ad3f-154">Gli Apartment a thread singolo che li creano accederanno tramite un proxy.</span><span class="sxs-lookup"><span data-stu-id="6ad3f-154">Single-threaded apartments that create it will access it through a proxy.</span></span>

## <a name="related-topics"></a><span data-ttu-id="6ad3f-155">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="6ad3f-155">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="6ad3f-156">Accesso alle interfacce tra gli Apartment</span><span class="sxs-lookup"><span data-stu-id="6ad3f-156">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)
</dt> <dt>

[<span data-ttu-id="6ad3f-157">Scelta del modello di threading</span><span class="sxs-lookup"><span data-stu-id="6ad3f-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
</dt> <dt>

[<span data-ttu-id="6ad3f-158">Apartment con multithreading</span><span class="sxs-lookup"><span data-stu-id="6ad3f-158">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
</dt> <dt>

[<span data-ttu-id="6ad3f-159">Processi, thread e Apartment</span><span class="sxs-lookup"><span data-stu-id="6ad3f-159">Processes, Threads, and Apartments</span></span>](processes--threads--and-apartments.md)
</dt> <dt>

[<span data-ttu-id="6ad3f-160">Comunicazione a thread singolo e multithreading</span><span class="sxs-lookup"><span data-stu-id="6ad3f-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
</dt> <dt>

[<span data-ttu-id="6ad3f-161">Apartment a thread singolo</span><span class="sxs-lookup"><span data-stu-id="6ad3f-161">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
</dt> </dl>

 

 