---
title: Processi, thread e Apartment
description: Un processo è una raccolta di spazio di memoria virtuale, codice, dati e risorse di sistema.
ms.assetid: cb62412a-d079-40f9-89dc-cce0bf3889af
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d598fc9d7dd39ab070b58aa7ba45a6e2fcae90db
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/21/2020
ms.locfileid: "104399758"
---
# <a name="processes-threads-and-apartments"></a><span data-ttu-id="5eafb-103">Processi, thread e Apartment</span><span class="sxs-lookup"><span data-stu-id="5eafb-103">Processes, Threads, and Apartments</span></span>

<span data-ttu-id="5eafb-104">Un *processo* è una raccolta di spazio di memoria virtuale, codice, dati e risorse di sistema.</span><span class="sxs-lookup"><span data-stu-id="5eafb-104">A *process* is a collection of virtual memory space, code, data, and system resources.</span></span> <span data-ttu-id="5eafb-105">Un *thread* è il codice che deve essere eseguito in modo seriale all'interno di un processo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-105">A *thread* is code that is to be serially executed within a process.</span></span> <span data-ttu-id="5eafb-106">Un processore esegue thread, non processi, quindi ogni applicazione dispone di almeno un processo e un processo ha sempre almeno un thread di esecuzione, noto come thread primario.</span><span class="sxs-lookup"><span data-stu-id="5eafb-106">A processor executes threads, not processes, so each application has at least one process, and a process always has at least one thread of execution, known as the primary thread.</span></span> <span data-ttu-id="5eafb-107">Un processo può avere più thread oltre al thread primario.</span><span class="sxs-lookup"><span data-stu-id="5eafb-107">A process can have multiple threads in addition to the primary thread.</span></span>

<span data-ttu-id="5eafb-108">I processi comunicano tra loro tramite messaggi, usando la tecnologia RPC (Remote Procedure Call) di Microsoft per passare le informazioni tra loro.</span><span class="sxs-lookup"><span data-stu-id="5eafb-108">Processes communicate with one another through messages, using Microsoft's Remote Procedure Call (RPC) technology to pass information to one another.</span></span> <span data-ttu-id="5eafb-109">Non esiste alcuna differenza per il chiamante tra una chiamata proveniente da un processo in un computer remoto e una chiamata proveniente da un altro processo nello stesso computer.</span><span class="sxs-lookup"><span data-stu-id="5eafb-109">There is no difference to the caller between a call coming from a process on a remote machine and a call coming from another process on the same machine.</span></span>

<span data-ttu-id="5eafb-110">Quando un thread inizia l'esecuzione, continua fino a quando non viene terminato o fino a quando non viene interrotto da un thread con priorità più alta (da un'azione dell'utente o dall'utilità di pianificazione dei thread del kernel).</span><span class="sxs-lookup"><span data-stu-id="5eafb-110">When a thread begins to execute, it continues until it is killed or until it is interrupted by a thread with higher priority (by a user action or the kernel's thread scheduler).</span></span> <span data-ttu-id="5eafb-111">Ogni thread può eseguire sezioni separate di codice oppure più thread possono eseguire la stessa sezione di codice.</span><span class="sxs-lookup"><span data-stu-id="5eafb-111">Each thread can run separate sections of code, or multiple threads can execute the same section of code.</span></span> <span data-ttu-id="5eafb-112">I thread che eseguono lo stesso blocco di codice conservano stack distinti.</span><span class="sxs-lookup"><span data-stu-id="5eafb-112">Threads executing the same block of code maintain separate stacks.</span></span> <span data-ttu-id="5eafb-113">Ogni thread in un processo condivide le variabili e le risorse globali del processo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-113">Each thread in a process shares that process's global variables and resources.</span></span>

<span data-ttu-id="5eafb-114">L'utilità di pianificazione dei thread determina quando e con quale frequenza eseguire un thread, in base a una combinazione dell'attributo della classe di priorità del processo e della priorità di base del thread.</span><span class="sxs-lookup"><span data-stu-id="5eafb-114">The thread scheduler determines when and how often to execute a thread, according to a combination of the process's priority class attribute and the thread's base priority.</span></span> <span data-ttu-id="5eafb-115">Per impostare un attributo della classe di priorità di un processo, chiamare la funzione [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) e impostare la priorità di base di un thread con una chiamata a [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span><span class="sxs-lookup"><span data-stu-id="5eafb-115">You set a process's priority class attribute by calling the [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) function , and you set a thread's base priority with a call to [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span></span>

<span data-ttu-id="5eafb-116">Le applicazioni multithread devono evitare due problemi di threading: *deadlock* e *Races*.</span><span class="sxs-lookup"><span data-stu-id="5eafb-116">Multithreaded applications must avoid two threading problems: *deadlocks* and *races*.</span></span> <span data-ttu-id="5eafb-117">Si verifica un deadlock quando ogni thread è in attesa dell'altro per eseguire un'operazione.</span><span class="sxs-lookup"><span data-stu-id="5eafb-117">A deadlock occurs when each thread is waiting for the other to do something.</span></span> <span data-ttu-id="5eafb-118">Il controllo delle chiamate COM consente di impedire deadlock nelle chiamate tra oggetti.</span><span class="sxs-lookup"><span data-stu-id="5eafb-118">The COM call control helps prevent deadlocks in calls between objects.</span></span> <span data-ttu-id="5eafb-119">Un race condition si verifica quando un thread termina prima di un altro oggetto da cui dipende, causando il primo utilizzo di un valore non inizializzato perché quest'ultimo non ha ancora fornito un valore valido.</span><span class="sxs-lookup"><span data-stu-id="5eafb-119">A race condition occurs when one thread finishes before another on which it depends, causing the former to use an uninitialized value because the latter has not yet supplied a valid one.</span></span> <span data-ttu-id="5eafb-120">COM fornisce alcune funzioni progettate appositamente per evitare race condition nei server out-of-process.</span><span class="sxs-lookup"><span data-stu-id="5eafb-120">COM supplies some functions specifically designed to help avoid race conditions in out-of-process servers.</span></span> <span data-ttu-id="5eafb-121">(Vedere [Helper di implementazione di server out-of-process](out-of-process-server-implementation-helpers.md)).</span><span class="sxs-lookup"><span data-stu-id="5eafb-121">(See [Out-of-Process Server Implementation Helpers](out-of-process-server-implementation-helpers.md).)</span></span>

## <a name="the-apartment-and-the-com-threading-architecture"></a><span data-ttu-id="5eafb-122">L'Apartment e l'architettura di threading COM</span><span class="sxs-lookup"><span data-stu-id="5eafb-122">The Apartment and the COM Threading Architecture</span></span>

<span data-ttu-id="5eafb-123">Sebbene COM supporti il modello a thread singolo per processo prevalentemente prima dell'introduzione di più thread di esecuzione, è possibile scrivere codice per sfruttare i vantaggi di più thread, ottenendo applicazioni più efficienti, consentendo l'esecuzione di un thread mentre un altro thread attende il completamento di un'operazione che richiede molto tempo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-123">While COM supports the single-thread-per-process model prevalent before the introduction of multiple threads of execution, you can write code to take advantage of multiple threads, resulting in more efficient applications, by allowing one thread to be executed while another thread waits for some time-consuming operation to complete.</span></span>

> [!Note]  
> <span data-ttu-id="5eafb-124">L'uso di più thread non garantisce prestazioni migliori.</span><span class="sxs-lookup"><span data-stu-id="5eafb-124">Using multiple threads is not a guarantee of better performance.</span></span> <span data-ttu-id="5eafb-125">Infatti, poiché il fattore di threading è un problema complesso, l'utilizzo di più thread causa spesso problemi di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="5eafb-125">In fact, because thread factoring is a difficult problem, using multiple threads often causes performance problems.</span></span> <span data-ttu-id="5eafb-126">La chiave consiste nell'usare più thread solo se si è sicuri di ciò che si sta facendo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-126">The key is to use multiple threads only if you are very sure of what you are doing.</span></span>

 

<span data-ttu-id="5eafb-127">In generale, il modo più semplice per visualizzare l'architettura di threading COM consiste nel considerare tutti gli oggetti COM nel processo suddivisi in gruppi denominati *Apartment*.</span><span class="sxs-lookup"><span data-stu-id="5eafb-127">In general, the simplest way to view the COM threading architecture is to think of all the COM objects in the process as divided into groups called *apartments*.</span></span> <span data-ttu-id="5eafb-128">Un oggetto COM risiede esattamente in un Apartment, nel senso che i relativi metodi possono essere chiamati legalmente direttamente da un thread che appartiene a tale Apartment.</span><span class="sxs-lookup"><span data-stu-id="5eafb-128">A COM object lives in exactly one apartment, in the sense that its methods can legally be directly called only by a thread that belongs to that apartment.</span></span> <span data-ttu-id="5eafb-129">Qualsiasi altro thread che desidera chiamare l'oggetto deve passare attraverso un proxy.</span><span class="sxs-lookup"><span data-stu-id="5eafb-129">Any other thread that wants to call the object must go through a proxy.</span></span>

<span data-ttu-id="5eafb-130">Sono disponibili due tipi di Apartment: [Apartment a thread singolo](single-threaded-apartments.md)e [apartment multithreading](multithreaded-apartments.md).</span><span class="sxs-lookup"><span data-stu-id="5eafb-130">There are two types of apartments: [single-threaded apartments](single-threaded-apartments.md), and [multithreaded apartments](multithreaded-apartments.md).</span></span>

-   <span data-ttu-id="5eafb-131">Gli Apartment a thread singolo sono costituiti esattamente da un solo thread, quindi tutti gli oggetti COM che risiedono in un Apartment a thread singolo possono ricevere chiamate al metodo solo da un thread che appartiene a tale Apartment.</span><span class="sxs-lookup"><span data-stu-id="5eafb-131">Single-threaded apartments consist of exactly one thread, so all COM objects that live in a single-threaded apartment can receive method calls only from the one thread that belongs to that apartment.</span></span> <span data-ttu-id="5eafb-132">Tutte le chiamate al metodo a un oggetto COM in un Apartment a thread singolo vengono sincronizzate con la coda di messaggi di Windows per il thread dell'Apartment a thread singolo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-132">All method calls to a COM object in a single-threaded apartment are synchronized with the windows message queue for the single-threaded apartment's thread.</span></span> <span data-ttu-id="5eafb-133">Un processo con un solo thread di esecuzione è semplicemente un caso speciale di questo modello.</span><span class="sxs-lookup"><span data-stu-id="5eafb-133">A process with a single thread of execution is simply a special case of this model.</span></span>
-   <span data-ttu-id="5eafb-134">Gli Apartment a thread multipli sono costituiti da uno o più thread, quindi tutti gli oggetti COM che risiedono in un Apartment a thread multipli possono ricevere chiamate al metodo direttamente da uno qualsiasi dei thread appartenenti all'Apartment a thread multipli.</span><span class="sxs-lookup"><span data-stu-id="5eafb-134">Multithreaded apartments consist of one or more threads, so all COM objects that live in an multithreaded apartment can receive method calls directly from any of the threads that belong to the multithreaded apartment.</span></span> <span data-ttu-id="5eafb-135">I thread in un Apartment a thread multipli utilizzano un modello denominato *Threading libero*.</span><span class="sxs-lookup"><span data-stu-id="5eafb-135">Threads in a multithreaded apartment use a model called *free-threading*.</span></span> <span data-ttu-id="5eafb-136">Le chiamate a oggetti COM in un Apartment a thread multipli vengono sincronizzate dagli oggetti stessi.</span><span class="sxs-lookup"><span data-stu-id="5eafb-136">Calls to COM objects in a multithreaded apartment are synchronized by the objects themselves.</span></span>

> [!Note]  
> <span data-ttu-id="5eafb-137">Per una descrizione della comunicazione tra Apartment a thread singolo e Apartment con multithreading nello stesso processo, vedere [comunicazione a thread singolo e multithreading](single-threaded-and-multithreaded-communication.md).</span><span class="sxs-lookup"><span data-stu-id="5eafb-137">For a description of communication between single-threaded apartments and multithreaded apartments within the same process, see [Single-Threaded and Multithreaded Communication](single-threaded-and-multithreaded-communication.md).</span></span>

 

<span data-ttu-id="5eafb-138">Un processo può avere zero o più Apartment a thread singolo e zero o un Apartment a thread multipli.</span><span class="sxs-lookup"><span data-stu-id="5eafb-138">A process can have zero or more single-threaded apartments and zero or one multithreaded apartment.</span></span>

<span data-ttu-id="5eafb-139">In un processo, l'Apartment principale è il primo da inizializzare.</span><span class="sxs-lookup"><span data-stu-id="5eafb-139">In a process, the main apartment is the first to be initialized.</span></span> <span data-ttu-id="5eafb-140">In un processo a thread singolo, questo è l'unico Apartment.</span><span class="sxs-lookup"><span data-stu-id="5eafb-140">In a single-threaded process, this is the only apartment.</span></span> <span data-ttu-id="5eafb-141">Viene eseguito il marshalling dei parametri di chiamata tra gli Apartment e COM gestisce la sincronizzazione tramite la messaggistica.</span><span class="sxs-lookup"><span data-stu-id="5eafb-141">Call parameters are marshaled between apartments, and COM handles the synchronization through messaging.</span></span> <span data-ttu-id="5eafb-142">Se si definiscono più thread in un processo per essere a thread libero, tutti i thread disponibili si trovano in un singolo Apartment, i parametri vengono passati direttamente a qualsiasi thread nell'Apartment ed è necessario gestire tutte le sincronizzazioni.</span><span class="sxs-lookup"><span data-stu-id="5eafb-142">If you designate multiple threads in a process to be free-threaded, all free threads reside in a single apartment, parameters are passed directly to any thread in the apartment, and you must handle all synchronization.</span></span> <span data-ttu-id="5eafb-143">In un processo con threading libero e threading di Apartment, tutti i thread gratuiti si trovano in un singolo Apartment e tutti gli altri appartamenti sono appartamenti a thread singolo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-143">In a process with both free-threading and apartment threading, all free threads reside in a single apartment and all other apartments are single-threaded apartments.</span></span> <span data-ttu-id="5eafb-144">Un processo che esegue lavoro COM è una raccolta di appartamenti con, al massimo, un Apartment a thread multipli ma un numero qualsiasi di Apartment a thread singolo.</span><span class="sxs-lookup"><span data-stu-id="5eafb-144">A process that does COM work is a collection of apartments with, at most, one multithreaded apartment but any number of single-threaded apartments.</span></span>

<span data-ttu-id="5eafb-145">I modelli di threading in COM forniscono il meccanismo per i client e i server che usano architetture di threading diverse per collaborare.</span><span class="sxs-lookup"><span data-stu-id="5eafb-145">The threading models in COM provide the mechanism for clients and servers that use different threading architectures to work together.</span></span> <span data-ttu-id="5eafb-146">Le chiamate tra oggetti con modelli di threading diversi in processi diversi sono naturalmente supportate.</span><span class="sxs-lookup"><span data-stu-id="5eafb-146">Calls among objects with different threading models in different processes are naturally supported.</span></span> <span data-ttu-id="5eafb-147">Dal punto di vista dell'oggetto chiamante, tutte le chiamate a oggetti all'esterno di un processo si comportano in modo identico, indipendentemente dal fatto che l'oggetto chiamato sia thread.</span><span class="sxs-lookup"><span data-stu-id="5eafb-147">From the perspective of the calling object, all calls to objects outside a process behave identically, no matter how the object being called is threaded.</span></span> <span data-ttu-id="5eafb-148">Analogamente, dal punto di vista dell'oggetto chiamato, le chiamate in arrivo si comportano in modo identico, indipendentemente dal modello di threading del chiamante.</span><span class="sxs-lookup"><span data-stu-id="5eafb-148">Likewise, from the perspective of the object being called, arriving calls behave identically, regardless of the threading model of the caller.</span></span>

<span data-ttu-id="5eafb-149">L'interazione tra un client e un oggetto out-of-process è semplice, anche quando usano modelli di threading diversi perché il client e l'oggetto si trovano in processi diversi.</span><span class="sxs-lookup"><span data-stu-id="5eafb-149">Interaction between a client and an out-of-process object is straightforward, even when they use different threading models because the client and object are in different processes.</span></span> <span data-ttu-id="5eafb-150">COM, interposta tra il client e il server, può fornire il codice per l'interoperabilità tra i modelli di threading, usando il marshalling standard e RPC.</span><span class="sxs-lookup"><span data-stu-id="5eafb-150">COM, interposed between the client and the server, can provide the code for the threading models to interoperate, using standard marshaling and RPC.</span></span> <span data-ttu-id="5eafb-151">Se, ad esempio, un oggetto a thread singolo viene chiamato contemporaneamente da più client a thread libero, le chiamate verranno sincronizzate da COM inserendo i messaggi della finestra corrispondenti nella coda di messaggi del server.</span><span class="sxs-lookup"><span data-stu-id="5eafb-151">For example, if a single-threaded object is called simultaneously by multiple free-threaded clients, the calls will be synchronized by COM by placing corresponding window messages in the server's message queue.</span></span> <span data-ttu-id="5eafb-152">L'Apartment dell'oggetto riceve una chiamata ogni volta che recupera e invia i messaggi.</span><span class="sxs-lookup"><span data-stu-id="5eafb-152">The object's apartment will receive one call each time it retrieves and dispatches messages.</span></span> <span data-ttu-id="5eafb-153">Tuttavia, è necessario prestare attenzione per garantire che i server in-process interagiscano correttamente con i client.</span><span class="sxs-lookup"><span data-stu-id="5eafb-153">However, some care must be taken to ensure that in-process servers interact properly with their clients.</span></span> <span data-ttu-id="5eafb-154">(Vedere [problemi di threading del server in-process](in-process-server-threading-issues.md)).</span><span class="sxs-lookup"><span data-stu-id="5eafb-154">(See [In-Process Server Threading Issues](in-process-server-threading-issues.md).)</span></span>

<span data-ttu-id="5eafb-155">Il problema più importante nella programmazione con un modello multithreading consiste nel rendere il codice thread-safe in modo che i messaggi destinati a un particolare thread vadano solo a tale thread e che l'accesso ai thread sia protetto.</span><span class="sxs-lookup"><span data-stu-id="5eafb-155">The most important issue in programming with a multithreaded model is to make your code thread-safe so that messages intended for a particular thread go only to that thread and access to threads is protected.</span></span>

<span data-ttu-id="5eafb-156">Per altre informazioni, vedere i seguenti argomenti:</span><span class="sxs-lookup"><span data-stu-id="5eafb-156">For more information, see the following topics:</span></span>

-   [<span data-ttu-id="5eafb-157">Scelta del modello di threading</span><span class="sxs-lookup"><span data-stu-id="5eafb-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
-   [<span data-ttu-id="5eafb-158">Apartment a thread singolo</span><span class="sxs-lookup"><span data-stu-id="5eafb-158">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
-   [<span data-ttu-id="5eafb-159">Apartment con multithreading</span><span class="sxs-lookup"><span data-stu-id="5eafb-159">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
-   [<span data-ttu-id="5eafb-160">Comunicazione a thread singolo e multithreading</span><span class="sxs-lookup"><span data-stu-id="5eafb-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
-   [<span data-ttu-id="5eafb-161">Problemi di threading del server in-process</span><span class="sxs-lookup"><span data-stu-id="5eafb-161">In-Process Server Threading Issues</span></span>](in-process-server-threading-issues.md)
-   [<span data-ttu-id="5eafb-162">Accesso alle interfacce tra gli Apartment</span><span class="sxs-lookup"><span data-stu-id="5eafb-162">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)

 

 