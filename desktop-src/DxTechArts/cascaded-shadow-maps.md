---
title: Mappe di profondità a cascata
description: Le mappe Shadow a cascata (CSM) rappresentano il modo migliore per combattere uno degli errori più comuni con l'aliasing della prospettiva shadowing.
ms.assetid: d3570d0a-74e0-5b9c-6586-c933f630c4ee
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ae70433f97f33c3cc28af8e282b14ea1f513cf4d
ms.sourcegitcommit: 54db9e6a00a5c8f68e7c1a16b8c6d4943374498c
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/01/2021
ms.locfileid: "106334314"
---
# <a name="cascaded-shadow-maps"></a><span data-ttu-id="10141-103">Mappe di profondità a cascata</span><span class="sxs-lookup"><span data-stu-id="10141-103">Cascaded Shadow Maps</span></span>

<span data-ttu-id="10141-104">Le mappe Shadow a cascata (CSM) rappresentano il modo migliore per combattere uno degli errori più comuni con l'ombreggiatura, ovvero la prospettiva di aliasing.</span><span class="sxs-lookup"><span data-stu-id="10141-104">Cascaded shadow maps (CSMs) are the best way to combat one of the most prevalent errors with shadowing: perspective aliasing.</span></span> <span data-ttu-id="10141-105">Questo articolo tecnico, che presuppone che il lettore abbia familiarità con il mapping Shadow, affronta l'argomento di CSM.</span><span class="sxs-lookup"><span data-stu-id="10141-105">This technical article, which assumes the reader is familiar with shadow mapping, tackles the topic of CSMs.</span></span> <span data-ttu-id="10141-106">Nello specifico:</span><span class="sxs-lookup"><span data-stu-id="10141-106">Specifically, it:</span></span>

-   <span data-ttu-id="10141-107">viene illustrata la complessità di CSM;</span><span class="sxs-lookup"><span data-stu-id="10141-107">explains the complexity of CSMs;</span></span>
-   <span data-ttu-id="10141-108">fornisce informazioni dettagliate sulle possibili varianti degli algoritmi CSM.</span><span class="sxs-lookup"><span data-stu-id="10141-108">gives details on the possible variations of the CSM algorithms;</span></span>
-   <span data-ttu-id="10141-109">vengono descritte le due tecniche di filtro più comuni, ovvero la percentuale di filtro più vicino (PCF) e il filtro con le mappe shadow di varianza (VSMs);</span><span class="sxs-lookup"><span data-stu-id="10141-109">describes the two most common filtering techniques—percentage closer filtering (PCF) and filtering with variance shadow maps (VSMs);</span></span>
-   <span data-ttu-id="10141-110">identifica e risolve alcuni problemi comuni associati all'aggiunta di filtri a CSM; e</span><span class="sxs-lookup"><span data-stu-id="10141-110">identifies and addresses some of the common pitfalls associated with adding filtering to CSMs; and</span></span>
-   <span data-ttu-id="10141-111">viene illustrato come eseguire il mapping di CSM a Direct3D 10 tramite l'hardware Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="10141-111">shows how to map CSMs to Direct3D 10 through Direct3D 11 hardware.</span></span>

<span data-ttu-id="10141-112">Il codice usato in questo articolo è disponibile in DirectX Software Development Kit (SDK) negli esempi di CascadedShadowMaps11 e VarianceShadows11.</span><span class="sxs-lookup"><span data-stu-id="10141-112">The code used in this article can be found in the DirectX Software Development Kit (SDK) in the CascadedShadowMaps11 and VarianceShadows11 samples.</span></span> <span data-ttu-id="10141-113">Questo articolo si rivelerà particolarmente utile dopo l'implementazione delle tecniche descritte nell'articolo tecnico, vengono implementate le [tecniche comuni per migliorare le mappe di profondità Shadow](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps).</span><span class="sxs-lookup"><span data-stu-id="10141-113">This article will prove most useful after implementing the techniques covered in the technical article, [Common Techniques to Improve Shadow Depth Maps](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps), are implemented.</span></span>

## <a name="cascaded-shadow-maps-and-perspective-aliasing"></a><span data-ttu-id="10141-114">Mappe Shadow a cascata e aliasing delle prospettive</span><span class="sxs-lookup"><span data-stu-id="10141-114">Cascaded Shadow Maps and Perspective Aliasing</span></span>

<span data-ttu-id="10141-115">L'aliasing della prospettiva in una mappa Shadow è uno dei problemi più difficili da superare.</span><span class="sxs-lookup"><span data-stu-id="10141-115">Perspective aliasing in a shadow map is one of the most difficult problems to overcome.</span></span> <span data-ttu-id="10141-116">Nell'articolo tecnico sono descritte le tecniche comuni per migliorare le mappe della profondità Shadow, l'aliasing della prospettiva e alcuni approcci per attenuare il problema.</span><span class="sxs-lookup"><span data-stu-id="10141-116">In the technical article, Common Techniques to Improve Shadow Depth Maps, perspective aliasing is described and some approaches to mitigate the problem are identified.</span></span> <span data-ttu-id="10141-117">In pratica, CSM tendono a essere la soluzione migliore e sono comunemente usati nei giochi moderni.</span><span class="sxs-lookup"><span data-stu-id="10141-117">In practice, CSMs tend to be the best solution, and are commonly employed in modern games.</span></span>

<span data-ttu-id="10141-118">Il concetto di base di CSM è facile da comprendere.</span><span class="sxs-lookup"><span data-stu-id="10141-118">The basic concept of CSMs is easy to understand.</span></span> <span data-ttu-id="10141-119">Diverse aree della fotocamera tronco richiedono mappe Shadow con diverse risoluzioni.</span><span class="sxs-lookup"><span data-stu-id="10141-119">Different areas of the camera frustum require shadow maps with different resolutions.</span></span> <span data-ttu-id="10141-120">Gli oggetti più vicini all'occhio richiedono una risoluzione più elevata rispetto agli oggetti più distanti.</span><span class="sxs-lookup"><span data-stu-id="10141-120">Objects nearest the eye require a higher resolution than do more distant objects.</span></span> <span data-ttu-id="10141-121">Infatti, quando l'occhio si sposta molto vicino alla geometria, i pixel più vicini all'occhio possono richiedere una risoluzione così elevata che anche una mappa Shadow 4096 × 4096 non è sufficiente.</span><span class="sxs-lookup"><span data-stu-id="10141-121">In fact, when the eye moves very close to the geometry, the pixels nearest the eye can require so much resolution that even a 4096 × 4096 shadow map is insufficient.</span></span>

<span data-ttu-id="10141-122">L'idea di base di CSM consiste nel partizionare il tronco in più frusta.</span><span class="sxs-lookup"><span data-stu-id="10141-122">The basic idea of CSMs is to partition the frustum into multiple frusta.</span></span> <span data-ttu-id="10141-123">Viene eseguito il rendering di una mappa shadow per ogni subfrustum; il pixel shader esegue quindi il campionamento dalla mappa che corrisponde maggiormente alla risoluzione necessaria (Figura 2).</span><span class="sxs-lookup"><span data-stu-id="10141-123">A shadow map is rendered for each subfrustum; the pixel shader then samples from the map that most closely matches the required resolution (Figure 2).</span></span>

<span data-ttu-id="10141-124">**Figura 1. Copertura mappa Shadow**</span><span class="sxs-lookup"><span data-stu-id="10141-124">**Figure 1. Shadow map coverage**</span></span>

![Copertura mappa Shadow](images/shadow-map-coverage.png)

<span data-ttu-id="10141-126">Nella figura 1 viene visualizzata la qualità, da sinistra a destra, dal più alto al più basso.</span><span class="sxs-lookup"><span data-stu-id="10141-126">In Figure 1, quality is shown (left to right) from highest to lowest.</span></span> <span data-ttu-id="10141-127">La serie di griglie che rappresentano le mappe Shadow con una visualizzazione tronco (cono invertito in rosso) Mostra il modo in cui il code coverage dei pixel è influenzato dalle diverse mappe Shadow della risoluzione.</span><span class="sxs-lookup"><span data-stu-id="10141-127">The series of grids representing shadow maps with a view frustum (inverted cone in red) shows how pixel coverage is affected with different resolution shadow maps.</span></span> <span data-ttu-id="10141-128">Le ombre sono della qualità massima (pixel bianchi) quando è presente un rapporto di 1:1 pixel di mapping nello spazio chiaro ai Texel nella mappa Shadow.</span><span class="sxs-lookup"><span data-stu-id="10141-128">Shadows are of the highest quality (white pixels) when there is a 1:1 ratio mapping pixels in light space to texels in the shadow map.</span></span> <span data-ttu-id="10141-129">L'aliasing della prospettiva si verifica sotto forma di mappe di trame di grandi dimensioni (immagine a sinistra) quando un numero eccessivo di pixel viene mappato allo stesso Texel ombreggiato.</span><span class="sxs-lookup"><span data-stu-id="10141-129">Perspective aliasing occurs in the form of large, blocky texture maps (left image) when too many pixels map to the same shadow texel.</span></span> <span data-ttu-id="10141-130">Quando la mappa Shadow è troppo grande, viene sottoposta a campionamento.</span><span class="sxs-lookup"><span data-stu-id="10141-130">When the shadow map is too large, it is under sampled.</span></span> <span data-ttu-id="10141-131">In questo caso, i Texel vengono ignorati, vengono introdotti gli artefatti luccicanti e le prestazioni sono interessate.</span><span class="sxs-lookup"><span data-stu-id="10141-131">In this case, texels are skipped, shimmering artifacts are introduced, and performance is affected.</span></span>

<span data-ttu-id="10141-132">**Figura 2. Qualità ombreggiatura CSM**</span><span class="sxs-lookup"><span data-stu-id="10141-132">**Figure 2. CSM shadow quality**</span></span>

![qualità ombreggiatura CSM](images/csm-shadow-quality.png)

<span data-ttu-id="10141-134">Nella figura 2 sono illustrati i ritagli della sezione relativa alla qualità più elevata in ogni mappa shadow nella figura 1.</span><span class="sxs-lookup"><span data-stu-id="10141-134">Figure 2 shows cutouts from the highest quality section in each shadow map in Figure 1.</span></span> <span data-ttu-id="10141-135">La mappa Shadow con i pixel più vicini (al vertice) è più vicina all'occhio.</span><span class="sxs-lookup"><span data-stu-id="10141-135">The shadow map with the most closely placed pixels (at the apex) is nearest the eye.</span></span> <span data-ttu-id="10141-136">Tecnicamente, questi sono mappe della stessa dimensione, con bianco e grigio usati per esemplificare il successo della mappa Shadow a cascata.</span><span class="sxs-lookup"><span data-stu-id="10141-136">Technically, these are maps of the same size, with white and grey used to exemplify the success of the cascaded shadow map.</span></span> <span data-ttu-id="10141-137">Il bianco è ideale perché mostra una copertura ottimale, ovvero un rapporto 1:1 per gli spazi vuoti e i Texel Mappa Shadow.</span><span class="sxs-lookup"><span data-stu-id="10141-137">White is ideal because it shows good coverage—a 1:1 ratio for eye-space pixels and shadow-map texels.</span></span>

<span data-ttu-id="10141-138">CSM richiede i passaggi seguenti per frame.</span><span class="sxs-lookup"><span data-stu-id="10141-138">CSMs require the following steps per frame.</span></span>

1.  <span data-ttu-id="10141-139">Partizionare il tronco in subfrusta.</span><span class="sxs-lookup"><span data-stu-id="10141-139">Partition the frustum into subfrusta.</span></span>
2.  <span data-ttu-id="10141-140">Calcola una proiezione ortogonale per ogni subfrustum.</span><span class="sxs-lookup"><span data-stu-id="10141-140">Compute an orthographic projection for each subfrustum.</span></span>
3.  <span data-ttu-id="10141-141">Eseguire il rendering di una mappa shadow per ogni subfrustum.</span><span class="sxs-lookup"><span data-stu-id="10141-141">Render a shadow map for each subfrustum.</span></span>
4.  <span data-ttu-id="10141-142">Esegue il rendering della scena.</span><span class="sxs-lookup"><span data-stu-id="10141-142">Render the scene.</span></span>

    1.  <span data-ttu-id="10141-143">Associare le mappe Shadow e il rendering.</span><span class="sxs-lookup"><span data-stu-id="10141-143">Bind the shadow maps and render.</span></span>
    2.  <span data-ttu-id="10141-144">Il vertex shader esegue le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="10141-144">The vertex shader does the following:</span></span>

        -   <span data-ttu-id="10141-145">Calcola le coordinate di trama per ogni subfrustum di luce (a meno che la coordinata di trama necessaria non venga calcolata nell'pixel shader).</span><span class="sxs-lookup"><span data-stu-id="10141-145">Computes texture coordinates for each light subfrustum (unless the needed texture coordinate is calculated in the pixel shader).</span></span>
        -   <span data-ttu-id="10141-146">Trasforma e accende il vertice e così via.</span><span class="sxs-lookup"><span data-stu-id="10141-146">Transforms and lights the vertex, and so on.</span></span>

    3.  <span data-ttu-id="10141-147">Il pixel shader esegue le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="10141-147">The pixel shader does the following:</span></span>

        -   <span data-ttu-id="10141-148">Determina la mappa Shadow corretta.</span><span class="sxs-lookup"><span data-stu-id="10141-148">Determines the proper shadow map.</span></span>
        -   <span data-ttu-id="10141-149">Trasforma le coordinate di trama, se necessario.</span><span class="sxs-lookup"><span data-stu-id="10141-149">Transforms the texture coordinates if necessary.</span></span>
        -   <span data-ttu-id="10141-150">Campiona la Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-150">Samples the cascade.</span></span>
        -   <span data-ttu-id="10141-151">Accende il pixel.</span><span class="sxs-lookup"><span data-stu-id="10141-151">Lights the pixel.</span></span>

## <a name="partitioning-the-frustum"></a><span data-ttu-id="10141-152">Partizionamento di tronco</span><span class="sxs-lookup"><span data-stu-id="10141-152">Partitioning the Frustum</span></span>

<span data-ttu-id="10141-153">Il partizionamento di tronco è l'azione di creazione di subfrusta.</span><span class="sxs-lookup"><span data-stu-id="10141-153">Partitioning the frustum is the act of creating subfrusta.</span></span> <span data-ttu-id="10141-154">Una tecnica per suddividere il tronco consiste nel calcolare gli intervalli dallo zero% al 100% nella direzione Z.</span><span class="sxs-lookup"><span data-stu-id="10141-154">One technique for splitting the frustum is to calculate intervals from zero percent to one hundred percent in the Z-direction.</span></span> <span data-ttu-id="10141-155">Ogni intervallo rappresenta quindi un piano vicino e un piano lontano come percentuale dell'asse Z.</span><span class="sxs-lookup"><span data-stu-id="10141-155">Each interval then represents a near plane and a far plane as a percentage of the Z-axis.</span></span>

<span data-ttu-id="10141-156">**Figura 3. Visualizza frustums partizionata arbitrariamente**</span><span class="sxs-lookup"><span data-stu-id="10141-156">**Figure 3. View frustums partitioned arbitrarily**</span></span>

![Visualizza frustums partizionata arbitrariamente](images/view-frustums-partitioned-arbitrarily.png)

<span data-ttu-id="10141-158">In pratica, il ricalcolo delle divisioni di tronco per frame causa la brillantezza dei bordi ombreggiatura.</span><span class="sxs-lookup"><span data-stu-id="10141-158">In practice, recalculating the frustum splits per frame causes shadow edges to shimmer.</span></span> <span data-ttu-id="10141-159">La prassi generalmente accettata prevede l'uso di un set statico di intervalli a cascata per ogni scenario.</span><span class="sxs-lookup"><span data-stu-id="10141-159">The generally accepted practice is to use a static set of cascade intervals per scenario.</span></span> <span data-ttu-id="10141-160">In questo scenario, l'intervallo lungo l'asse Z viene usato per descrivere un subfrustum che si verifica durante il partizionamento di tronco.</span><span class="sxs-lookup"><span data-stu-id="10141-160">In this scenario, the interval along the Z-axis is used to describe a subfrustum that occurs when partitioning the frustum.</span></span> <span data-ttu-id="10141-161">Determinare gli intervalli di dimensioni corretti per una determinata scena dipende da diversi fattori.</span><span class="sxs-lookup"><span data-stu-id="10141-161">Determining the correct size intervals for a given scene depends upon several factors.</span></span>

### <a name="orientation-of-the-scene-geometry"></a><span data-ttu-id="10141-162">Orientamento della geometria della scena</span><span class="sxs-lookup"><span data-stu-id="10141-162">Orientation of the Scene Geometry</span></span>

<span data-ttu-id="10141-163">Per quanto riguarda la geometria della scena, l'orientamento della fotocamera influiscono sulla selezione dell'intervallo a cascata.</span><span class="sxs-lookup"><span data-stu-id="10141-163">With respect to scene geometry, camera orientation affects cascade interval selection.</span></span> <span data-ttu-id="10141-164">Ad esempio, una videocamera molto vicino alla strada, ad esempio una fotocamera da zero in una partita di calcio, presenta un set statico diverso di intervalli a cascata rispetto a una fotocamera in cielo.</span><span class="sxs-lookup"><span data-stu-id="10141-164">For example, a camera very near the ground, such as a ground camera in a football game, has a different static set of cascade intervals than a camera in the sky.</span></span>

<span data-ttu-id="10141-165">Nella figura 4 sono illustrate alcune fotocamere diverse e le rispettive partizioni.</span><span class="sxs-lookup"><span data-stu-id="10141-165">Figure 4 shows some different cameras and their respective partitions.</span></span> <span data-ttu-id="10141-166">Quando l'intervallo Z della scena è molto grande, sono necessari più piani divisi.</span><span class="sxs-lookup"><span data-stu-id="10141-166">When the scene's Z-range is very large, more split planes are required.</span></span> <span data-ttu-id="10141-167">Ad esempio, quando l'occhio si trova molto vicino al piano di fondo, ma gli oggetti distanti sono ancora visibili, possono essere necessarie più cascate.</span><span class="sxs-lookup"><span data-stu-id="10141-167">For example, when the eye is very near the ground plane, but distant objects are still visible, multiple cascades can be necessary.</span></span> <span data-ttu-id="10141-168">La divisione del tronco in modo che siano più divisioni vicine (in cui l'aliasing delle prospettive sta cambiando il più veloce) è anche utile.</span><span class="sxs-lookup"><span data-stu-id="10141-168">Dividing the frustum so that more splits are near the eye (where perspective aliasing is changing the fastest) is also valuable.</span></span> <span data-ttu-id="10141-169">Quando la maggior parte della geometria viene raggruppata in una piccola sezione, ad esempio una visualizzazione overhead o un simulatore di volo, della vista tronco, è necessario un minor numero di Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-169">When most of the geometry is clumped into a small section (such as an overhead view or a flight simulator) of the view frustum, fewer cascades are necessary.</span></span>

<span data-ttu-id="10141-170">**Figura 4. Configurazioni diverse richiedono divisioni tronco diverse**</span><span class="sxs-lookup"><span data-stu-id="10141-170">**Figure 4. Different configurations require different frustum splits**</span></span>

![configurazioni diverse richiedono divisioni tronco diverse](images/different-configurations-require-different-frustum-splits.png)

<span data-ttu-id="10141-172">Sinistra Quando la geometria ha un intervallo dinamico elevato in Z, sono necessarie numerose cascate.</span><span class="sxs-lookup"><span data-stu-id="10141-172">(Left) When geometry has a high dynamic range in Z, lots of cascades are required.</span></span> <span data-ttu-id="10141-173">Center Quando la geometria ha un intervallo dinamico basso in Z, i vantaggi derivanti da più frustums sono pochi.</span><span class="sxs-lookup"><span data-stu-id="10141-173">(Center) When the geometry has low dynamic range in Z, there is little benefit from multiple frustums.</span></span> <span data-ttu-id="10141-174">Destra Quando l'intervallo dinamico è medio, sono necessarie solo tre partizioni.</span><span class="sxs-lookup"><span data-stu-id="10141-174">(Right) Only three partitions are needed when the dynamic range is medium.</span></span>

### <a name="orientation-of-the-light-and-the-camera"></a><span data-ttu-id="10141-175">Orientamento della luce e della fotocamera</span><span class="sxs-lookup"><span data-stu-id="10141-175">Orientation of the Light and the Camera</span></span>

<span data-ttu-id="10141-176">La matrice di proiezione di ogni Cascade si adatta perfettamente alla subfrustum corrispondente.</span><span class="sxs-lookup"><span data-stu-id="10141-176">Each cascade's projection matrix is fit tightly around its corresponding subfrustum.</span></span> <span data-ttu-id="10141-177">Nelle configurazioni in cui la fotocamera delle visualizzazioni e le direzioni di luce sono ortogonali, le propagazioni possono essere adeguate a una piccola sovrapposizione.</span><span class="sxs-lookup"><span data-stu-id="10141-177">In configurations where the view camera and the light directions are orthogonal, the cascades can be fit tightly with little overlap.</span></span> <span data-ttu-id="10141-178">La sovrapposizione diventa più grande come la luce e la videocamera della visualizzazione si sposta nell'allineamento parallelo (Figura 5).</span><span class="sxs-lookup"><span data-stu-id="10141-178">The overlap becomes larger as the light and the view camera move into parallel alignment (Figure 5).</span></span> <span data-ttu-id="10141-179">Quando la luce e la fotocamera da visualizzare sono quasi parallele, si tratta di un "duello frusta" ed è uno scenario molto complesso per la maggior parte degli algoritmi di shadowing.</span><span class="sxs-lookup"><span data-stu-id="10141-179">When the light and the view camera are nearly parallel, it is called a "dueling frusta," and is a very hard scenario for most shadowing algorithms.</span></span> <span data-ttu-id="10141-180">Non è insolito vincolare la luce e la fotocamera in modo che questo scenario non si verifichi.</span><span class="sxs-lookup"><span data-stu-id="10141-180">It is not uncommon to constrain the light and camera so that this scenario does not occur.</span></span> <span data-ttu-id="10141-181">CSM, tuttavia, offre prestazioni molto migliori rispetto a molti altri algoritmi in questo scenario.</span><span class="sxs-lookup"><span data-stu-id="10141-181">CSMs, however, perform much better than many other algorithms in this scenario.</span></span>

<span data-ttu-id="10141-182">**Figura 5. La sovrapposizione a catena aumenta quando la direzione della luce diventa parallela con la direzione della fotocamera**</span><span class="sxs-lookup"><span data-stu-id="10141-182">**Figure 5. Cascade overlap increases as light direction becomes parallel with camera direction**</span></span>

![la sovrapposizione a catena aumenta quando la direzione della luce diventa parallela con la direzione della fotocamera](images/cascade-overlap-increases-as-light-direction-becomes.jpg)

<span data-ttu-id="10141-184">Molte implementazioni di CSM usano frusta di dimensioni fisse.</span><span class="sxs-lookup"><span data-stu-id="10141-184">Many CSM implementations use fixed-size frusta.</span></span> <span data-ttu-id="10141-185">Il pixel shader può usare la profondità Z per indicizzare la matrice di propagazioni quando tronco è suddiviso in intervalli di dimensioni fisse.</span><span class="sxs-lookup"><span data-stu-id="10141-185">The pixel shader can use the Z-depth to index into the array of cascades when the frustum is split in fixed-size intervals.</span></span>

## <a name="calculating-a-view-frustum-bound"></a><span data-ttu-id="10141-186">Calcolo di un limite di View-Frustum</span><span class="sxs-lookup"><span data-stu-id="10141-186">Calculating a View-Frustum Bound</span></span>

<span data-ttu-id="10141-187">Una volta selezionati gli intervalli di tronco, i subfrusta vengono creati usando uno dei due: adatta alla scena e adatta a Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-187">Once the frustum intervals are selected, the subfrusta are created using one of two: fit to scene and fit to cascade.</span></span>

### <a name="fit-to-scene"></a><span data-ttu-id="10141-188">Adatta alla scena</span><span class="sxs-lookup"><span data-stu-id="10141-188">Fit to Scene</span></span>

<span data-ttu-id="10141-189">Tutti i frusta possono essere creati con lo stesso piano vicino.</span><span class="sxs-lookup"><span data-stu-id="10141-189">All of the frusta can be created with the same near plane.</span></span> <span data-ttu-id="10141-190">In questo modo si impone la sovrapposizione delle cascate.</span><span class="sxs-lookup"><span data-stu-id="10141-190">This forces the cascades to overlap.</span></span> <span data-ttu-id="10141-191">L'esempio CascadedShadowMaps11 chiama questa tecnica adatta alla scena.</span><span class="sxs-lookup"><span data-stu-id="10141-191">The CascadedShadowMaps11 sample calls this technique fit to scene.</span></span>

### <a name="fit-to-cascade"></a><span data-ttu-id="10141-192">Adatta a cascata</span><span class="sxs-lookup"><span data-stu-id="10141-192">Fit to Cascade</span></span>

<span data-ttu-id="10141-193">In alternativa, è possibile creare frusta con l'intervallo di partizione effettivo usato come piani vicini e lontani.</span><span class="sxs-lookup"><span data-stu-id="10141-193">Alternatively, frusta can be created with the actual partition interval being used as near and far planes.</span></span> <span data-ttu-id="10141-194">Ciò determina un adattamento più rigoroso, ma viene degenerato per adattarsi alla scena nel caso di duello frusta.</span><span class="sxs-lookup"><span data-stu-id="10141-194">This causes a tighter fit, but degenerates to fit to scene in the case of dueling frusta.</span></span> <span data-ttu-id="10141-195">Gli esempi di CascadedShadowMaps11 chiamano questa tecnica adatta a Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-195">The CascadedShadowMaps11 samples calls this technique fit to cascade.</span></span>

<span data-ttu-id="10141-196">Questi due metodi sono illustrati nella figura 6.</span><span class="sxs-lookup"><span data-stu-id="10141-196">These two methods are shown in Figure 6.</span></span> <span data-ttu-id="10141-197">Adatta alla riduzione della risoluzione degli sprechi.</span><span class="sxs-lookup"><span data-stu-id="10141-197">Fit to cascade wastes less resolution.</span></span> <span data-ttu-id="10141-198">Il problema con l'adattamento a Cascade è che la proiezione ortogonale cresce e si riduce in base all'orientamento della visualizzazione tronco.</span><span class="sxs-lookup"><span data-stu-id="10141-198">The problem with fit to cascade is that the orthographic projection grows and shrinks based on the orientation of the view frustum.</span></span> <span data-ttu-id="10141-199">La tecnica adatta alla scena riduce la proiezione ortogonale per la dimensione massima della visualizzazione tronco rimuovendo gli artefatti visualizzati quando si sposta la visualizzazione della fotocamera.</span><span class="sxs-lookup"><span data-stu-id="10141-199">The fit to scene technique pads the orthographic projection by the max size of the view frustum removing the artifacts that appear when the view-camera moves.</span></span> <span data-ttu-id="10141-200">[Tecniche comuni per migliorare le mappe di profondità ombreggiatura](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps) sono gli elementi visualizzati quando la luce si sposta nella sezione "spostamento della luce in incrementi di dimensioni Texel".</span><span class="sxs-lookup"><span data-stu-id="10141-200">[Common Techniques to Improve Shadow Depth Maps](/windows/desktop/DxTechArts/common-techniques-to-improve-shadow-depth-maps) addresses the artifacts that appear when the light moves in the section "Moving the light in texel sized increments."</span></span>

<span data-ttu-id="10141-201">**Figura 6. Adatta alla scena e adatta a Cascade**</span><span class="sxs-lookup"><span data-stu-id="10141-201">**Figure 6. Fit to scene vs. fit to cascade**</span></span>

![adatta alla scena e adatta a cascata](images/fit-to-scene-vs-fit-to-cascade.png)

## <a name="render-the-shadow-map"></a><span data-ttu-id="10141-203">Eseguire il rendering della mappa Shadow</span><span class="sxs-lookup"><span data-stu-id="10141-203">Render the Shadow Map</span></span>

<span data-ttu-id="10141-204">L'esempio CascadedShadowMaps11 esegue il rendering delle mappe Shadow in un unico buffer di grandi dimensioni.</span><span class="sxs-lookup"><span data-stu-id="10141-204">The CascadedShadowMaps11 sample renders the shadow maps into one large buffer.</span></span> <span data-ttu-id="10141-205">Questo perché PCF sulle matrici di trama è una funzionalità Direct3D 10,1.</span><span class="sxs-lookup"><span data-stu-id="10141-205">This is because PCF on texture arrays is a Direct3D 10.1 feature.</span></span> <span data-ttu-id="10141-206">Per ogni Cascade viene creato un viewport che copre la sezione del buffer di profondità corrispondente a tale Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-206">For every cascade, a viewport is created that covers the section of the depth buffer corresponding to that cascade.</span></span> <span data-ttu-id="10141-207">Un pixel shader null è associato perché è necessaria solo la profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-207">A null pixel shader is bound because only the depth is needed.</span></span> <span data-ttu-id="10141-208">Infine, il viewport e la matrice di ombreggiatura corretti vengono impostati per ogni propagazione, in quanto viene eseguito il rendering delle mappe di profondità una alla volta nel buffer di ombreggiatura principale.</span><span class="sxs-lookup"><span data-stu-id="10141-208">Finally, the correct viewport and shadow matrix are set for each cascade as the depth maps are rendered one at a time into the main shadow buffer.</span></span>

## <a name="render-the-scene"></a><span data-ttu-id="10141-209">Eseguire il rendering della scena</span><span class="sxs-lookup"><span data-stu-id="10141-209">Render the Scene</span></span>

<span data-ttu-id="10141-210">Il buffer contenente le ombreggiature è ora associato al pixel shader.</span><span class="sxs-lookup"><span data-stu-id="10141-210">The buffer containing the shadows is now bound to the pixel shader.</span></span> <span data-ttu-id="10141-211">Sono disponibili due metodi per la selezione di Cascade implementata nell'esempio CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="10141-211">There are two methods for selecting the cascade implemented in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="10141-212">Questi due metodi sono illustrati con il codice dello shader.</span><span class="sxs-lookup"><span data-stu-id="10141-212">These two methods are explained with shader code.</span></span>

### <a name="interval-based-cascade-selection"></a><span data-ttu-id="10141-213">Selezione a catena Interval-Based</span><span class="sxs-lookup"><span data-stu-id="10141-213">Interval-Based Cascade Selection</span></span>

<span data-ttu-id="10141-214">**Figura 7. Selezione a catena basata sull'intervallo**</span><span class="sxs-lookup"><span data-stu-id="10141-214">**Figure 7. Interval-based cascade selection**</span></span>

![selezione a catena basata sull'intervallo](images/interval-based-cascade-selection.jpg)

<span data-ttu-id="10141-216">Nella selezione basata sull'intervallo (Figura 7), il vertex shader calcola la posizione nello spazio globale del vertice.</span><span class="sxs-lookup"><span data-stu-id="10141-216">In interval-based selection (Figure 7), the vertex shader computes the position in world-space of the vertex.</span></span>


```C++
Output.vDepth = mul( Input.vPosition, m_mWorldView ).z;
```



<span data-ttu-id="10141-217">Il pixel shader riceve la profondità interpolata.</span><span class="sxs-lookup"><span data-stu-id="10141-217">The pixel shader receives the interpolated depth.</span></span>


```C++
fCurrentPixelDepth = Input.vDepth;
```



<span data-ttu-id="10141-218">La selezione a catena basata su intervallo usa un confronto vettoriale e un prodotto a virgola per determinare il cacader corretto.</span><span class="sxs-lookup"><span data-stu-id="10141-218">Interval-based cascade selection uses a vector comparison and a dot product to determine the correct cacade.</span></span> <span data-ttu-id="10141-219">Il \_ \_ flag di conteggio a cascata specifica il numero di Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-219">The CASCADE\_COUNT\_FLAG specifies the number of cascades.</span></span> <span data-ttu-id="10141-220">I \_ dati m fCascadeFrustumsEyeSpaceDepths \_ vincolano le partizioni tronco della vista.</span><span class="sxs-lookup"><span data-stu-id="10141-220">The m\_fCascadeFrustumsEyeSpaceDepths\_data constrains the view frustum partitions.</span></span> <span data-ttu-id="10141-221">Dopo il confronto, fComparison contiene un valore pari a 1, dove il pixel corrente è maggiore della barriera e un valore pari a 0 quando la catena corrente è minore.</span><span class="sxs-lookup"><span data-stu-id="10141-221">After the comparison, the fComparison contains a value of 1 where the current pixel is larger than the barrier, and a value of 0 when the current cascade is smaller.</span></span> <span data-ttu-id="10141-222">Un prodotto punto somma questi valori in un indice di matrice.</span><span class="sxs-lookup"><span data-stu-id="10141-222">A dot product sums these values into an array index.</span></span>


```C++
        float4 vCurrentPixelDepth = Input.vDepth;
        float4 fComparison = ( vCurrentPixelDepth > m_fCascadeFrustumsEyeSpaceDepths_data[0]);
        float fIndex = dot(
        float4( CASCADE_COUNT_FLAG > 0,
        CASCADE_COUNT_FLAG > 1,
        CASCADE_COUNT_FLAG > 2,
        CASCADE_COUNT_FLAG > 3)
        , fComparison );

        fIndex = min( fIndex, CASCADE_COUNT_FLAG );
        iCurrentCascadeIndex = (int)fIndex;
```



<span data-ttu-id="10141-223">Una volta selezionata la clausola CASCADE, la coordinata di trama deve essere trasformata in una sequenza corretta.</span><span class="sxs-lookup"><span data-stu-id="10141-223">Once the cascade is selected, the texture coordinate must be transformed to the correct cascade.</span></span>


```C++
vShadowTexCoord = mul( InterpolatedPosition, m_mShadow[iCascadeIndex] );
```



<span data-ttu-id="10141-224">Questa coordinata di trama viene quindi utilizzata per campionare la trama con la coordinata X e la coordinata Y.</span><span class="sxs-lookup"><span data-stu-id="10141-224">This texture coordinate is then used to sample the texture with the X-coordinate and the Y-coordinate.</span></span> <span data-ttu-id="10141-225">La coordinata Z viene utilizzata per eseguire il confronto finale della profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-225">The Z-coordinate is used to do the final depth comparison.</span></span>

### <a name="map-based-cascade-selection"></a><span data-ttu-id="10141-226">Selezione a catena Map-Based</span><span class="sxs-lookup"><span data-stu-id="10141-226">Map-Based Cascade Selection</span></span>

<span data-ttu-id="10141-227">Selezione basata su mappa (Figura 8) esegue il test sui quattro lati delle cascate per trovare la mappa più stretta che copre il pixel specifico.</span><span class="sxs-lookup"><span data-stu-id="10141-227">Map-based selection (Figure 8) tests against the four sides of the cascades to find the tightest map that covers the specific pixel.</span></span> <span data-ttu-id="10141-228">Invece di calcolare la posizione nello spazio globale, il vertex shader calcola la posizione dello spazio di visualizzazione per ogni Cascade.</span><span class="sxs-lookup"><span data-stu-id="10141-228">Instead of calculating the position in world space, the vertex shader calculates the view-space position for every cascade.</span></span> <span data-ttu-id="10141-229">Il pixel shader scorre le propagazioni per ridimensionare e spostare le coordinate di trama in modo da indicizzare la Cascade corrente.</span><span class="sxs-lookup"><span data-stu-id="10141-229">The pixel shader iterates over the cascades in order to scale and shift the texture coordinates so that they index the current cascade.</span></span> <span data-ttu-id="10141-230">La coordinata di trama viene quindi testata in base ai limiti della trama.</span><span class="sxs-lookup"><span data-stu-id="10141-230">The texture coordinate is then tested against the texture bounds.</span></span> <span data-ttu-id="10141-231">Quando i valori X e Y della coordinata di trama rientrano in un oggetto Cascade, vengono usati per campionare la trama.</span><span class="sxs-lookup"><span data-stu-id="10141-231">When the X and Y values of the texture coordinate fall inside a cascade, they are used to sample the texture.</span></span> <span data-ttu-id="10141-232">La coordinata Z viene utilizzata per eseguire il confronto finale della profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-232">The Z-coordinate is used to do the final depth comparison.</span></span>

<span data-ttu-id="10141-233">**Figura 8. Selezione a catena basata su mappa**</span><span class="sxs-lookup"><span data-stu-id="10141-233">**Figure 8. Map-based cascade selection**</span></span>

![selezione a catena basata su mappa](images/map-based-cascade-selection.jpg)

### <a name="interval-based-selection-vs-map-based-selection"></a><span data-ttu-id="10141-235">Selezione Interval-Based e selezione Map-Based</span><span class="sxs-lookup"><span data-stu-id="10141-235">Interval-Based Selection vs. Map-Based Selection</span></span>

<span data-ttu-id="10141-236">La selezione basata sull'intervallo è leggermente più veloce della selezione basata su mappa perché la selezione a catena può essere eseguita direttamente.</span><span class="sxs-lookup"><span data-stu-id="10141-236">Interval-based selection is slightly faster than map-based selection because the cascade selection can be done directly.</span></span> <span data-ttu-id="10141-237">La selezione basata su mappa deve intersecare la coordinata di trama con i limiti a cascata.</span><span class="sxs-lookup"><span data-stu-id="10141-237">Map-based selection must intersect the texture coordinate with the cascade bounds.</span></span>

<span data-ttu-id="10141-238">La selezione basata su mappa usa la cascata in modo più efficiente quando le mappe shadow non sono perfettamente allineate (vedere la figura 8).</span><span class="sxs-lookup"><span data-stu-id="10141-238">Map-based selection uses the cascade more efficiently when shadow maps do not align perfectly (see Figure 8).</span></span>

## <a name="blend-between-cascades"></a><span data-ttu-id="10141-239">Blend tra le cascate</span><span class="sxs-lookup"><span data-stu-id="10141-239">Blend between Cascades</span></span>

<span data-ttu-id="10141-240">VSMs (illustrato più avanti in questo articolo) e le tecniche di filtro, ad esempio PCF, possono essere usate con CSM a bassa risoluzione per produrre ombre morbide.</span><span class="sxs-lookup"><span data-stu-id="10141-240">VSMs (discussed later in this article) and filtering techniques such as PCF can be used with low-resolution CSMs to produce soft shadows.</span></span> <span data-ttu-id="10141-241">Sfortunatamente, in questo modo si ottiene una linea di giunzione visibile (Figura 9) tra i livelli Cascade, perché la risoluzione non corrisponde.</span><span class="sxs-lookup"><span data-stu-id="10141-241">Unfortunately, this results in a visible seam (Figure 9) between cascade layers because the resolution does not match.</span></span> <span data-ttu-id="10141-242">La soluzione consiste nel creare una banda tra le mappe Shadow in cui viene eseguito il test di ombreggiatura per entrambe le cascate.</span><span class="sxs-lookup"><span data-stu-id="10141-242">The solution is to create a band between shadow maps where the shadow test is performed for both cascades.</span></span> <span data-ttu-id="10141-243">Lo shader esegue quindi l'interpolazione lineare tra i due valori in base alla posizione del pixel nella banda di Blend.</span><span class="sxs-lookup"><span data-stu-id="10141-243">The shader then linearly interpolates between the two values based on the pixel's location in the blend band.</span></span> <span data-ttu-id="10141-244">Gli esempi CascadedShadowMaps11 e VarianceShadows11 forniscono un dispositivo di scorrimento GUI che può essere usato per aumentare e diminuire questa fascia di sfocatura.</span><span class="sxs-lookup"><span data-stu-id="10141-244">The samples CascadedShadowMaps11 and VarianceShadows11 provide a GUI slider that can be used to increase and decrease this blur band.</span></span> <span data-ttu-id="10141-245">Lo shader esegue un ramo dinamico in modo che la maggior parte dei pixel legga solo dalla Cascade corrente.</span><span class="sxs-lookup"><span data-stu-id="10141-245">The shader performs a dynamic branch so that the vast majority of pixels only read from the current cascade.</span></span>

<span data-ttu-id="10141-246">**Figura 9. Giunzioni a catena**</span><span class="sxs-lookup"><span data-stu-id="10141-246">**Figure 9. Cascade seams**</span></span>

![giunzioni a catena](images/cascade-seams.jpg)

<span data-ttu-id="10141-248">Sinistra È possibile osservare una Seam visibile in cui si sovrappongono le cascate.</span><span class="sxs-lookup"><span data-stu-id="10141-248">(Left) A visible seam can be seen where cascades overlap.</span></span> <span data-ttu-id="10141-249">Destra Quando si fondono le cascate tra, non viene eseguita alcuna giunzione.</span><span class="sxs-lookup"><span data-stu-id="10141-249">(Right) When the cascades are blended between, no seam occurs.</span></span>

## <a name="filtering-shadow-maps"></a><span data-ttu-id="10141-250">Filtro delle mappe Shadow</span><span class="sxs-lookup"><span data-stu-id="10141-250">Filtering Shadow Maps</span></span>

### <a name="pcf"></a><span data-ttu-id="10141-251">PCF</span><span class="sxs-lookup"><span data-stu-id="10141-251">PCF</span></span>

<span data-ttu-id="10141-252">Il filtro delle mappe Shadow normali non produce ombre morbide e sfocate.</span><span class="sxs-lookup"><span data-stu-id="10141-252">Filtering ordinary shadow maps does not produce soft, blurred shadows.</span></span> <span data-ttu-id="10141-253">L'hardware di filtro offusca i valori di profondità, quindi confronta i valori sfocati con lo spazio chiaro Texel.</span><span class="sxs-lookup"><span data-stu-id="10141-253">The filtering hardware blurs the depth values, and then compares those blurred values to the light space texel.</span></span> <span data-ttu-id="10141-254">Il bordo rigido risultante dal test superato/non superato è ancora presente.</span><span class="sxs-lookup"><span data-stu-id="10141-254">The hard edge resulting from the pass/fail test still exists.</span></span> <span data-ttu-id="10141-255">La sfocatura delle mappe Shadow serve solo per spostare erroneamente il bordo rigido.</span><span class="sxs-lookup"><span data-stu-id="10141-255">Blurring shadow maps only serves to erroneously move the hard edge.</span></span> <span data-ttu-id="10141-256">PCF Abilita l'applicazione di filtri alle mappe Shadow.</span><span class="sxs-lookup"><span data-stu-id="10141-256">PCF enables filtering on shadow maps.</span></span> <span data-ttu-id="10141-257">L'idea generale del PCF consiste nel calcolare una percentuale del pixel nell'ombreggiatura in base al numero di sottocampionamenti che superano il test di profondità sul numero totale di sottocampionati.</span><span class="sxs-lookup"><span data-stu-id="10141-257">The general idea of PCF is to calculate a percentage of the pixel in shadow based on the number of subsamples that pass the depth test over the total number of subsamples.</span></span>

<span data-ttu-id="10141-258">L'hardware Direct3D 10 e Direct3D 11 possono eseguire il PCF.</span><span class="sxs-lookup"><span data-stu-id="10141-258">Direct3D 10 and Direct3D 11 hardware can perform PCF.</span></span> <span data-ttu-id="10141-259">L'input per un campionatore PCF è costituito dalla coordinata di trama e da un valore di profondità di confronto.</span><span class="sxs-lookup"><span data-stu-id="10141-259">The input to a PCF sampler consists of the texture-coordinate and a comparison depth value.</span></span> <span data-ttu-id="10141-260">Per semplicità, il PCF viene spiegato con un filtro a quattro tocchi.</span><span class="sxs-lookup"><span data-stu-id="10141-260">For simplicity, PCF is explained with a four-tap filter.</span></span> <span data-ttu-id="10141-261">Il campionatore di trame legge la trama quattro volte, in modo analogo a un filtro standard.</span><span class="sxs-lookup"><span data-stu-id="10141-261">The texture sampler reads the texture four times, similar to a standard filter.</span></span> <span data-ttu-id="10141-262">Tuttavia, il risultato restituito è una percentuale dei pixel che ha superato il test di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-262">However, the returned result is a percentage of the pixels that passed the depth test.</span></span> <span data-ttu-id="10141-263">Nella figura 10 viene illustrato come un pixel che passa uno dei quattro test di profondità è pari al 25% nell'ombreggiatura.</span><span class="sxs-lookup"><span data-stu-id="10141-263">Figure 10 shows how a pixel that passes one of the four depth tests is 25 percent in shadow.</span></span> <span data-ttu-id="10141-264">Il valore effettivo restituito è un'interpolazione lineare basata sulle coordinate del sottotexel delle letture di trama per produrre una sfumatura smussata.</span><span class="sxs-lookup"><span data-stu-id="10141-264">The actual value returned is a linear interpolation based on the subtexel coordinates of the texture reads to produce a smooth gradient.</span></span> <span data-ttu-id="10141-265">Senza questa interpolazione lineare, il PCF a quattro tocchi potrà restituire solo cinque valori: {0,0, 0,25, 0,5, 0,75, 1,0}.</span><span class="sxs-lookup"><span data-stu-id="10141-265">Without this linear interpolation, the four-tap PCF would only be able to return five values: { 0.0, 0.25, 0.5, 0.75, 1.0 }.</span></span>

<span data-ttu-id="10141-266">**Figura 10. Immagine filtrata PCF con il 25% del pixel selezionato analizzato**</span><span class="sxs-lookup"><span data-stu-id="10141-266">**Figure 10. PCF filtered image, with 25 percent of the selected pixel covered**</span></span>

![immagine filtrata PCF con il 25% del pixel selezionato analizzato](images/pcf-filtered-image.png)

<span data-ttu-id="10141-268">È anche possibile eseguire il PCF senza supporto hardware o estendere il PCF ai kernel più grandi.</span><span class="sxs-lookup"><span data-stu-id="10141-268">It is also possible to do PCF without hardware support or extend PCF to larger kernels.</span></span> <span data-ttu-id="10141-269">Alcune tecniche si campionano anche con un kernel ponderato.</span><span class="sxs-lookup"><span data-stu-id="10141-269">Some techniques even sample with a weighted kernel.</span></span> <span data-ttu-id="10141-270">A tale scopo, creare un kernel, ad esempio un controllo gaussiana, per una griglia N × N.</span><span class="sxs-lookup"><span data-stu-id="10141-270">To do this, create a kernel (such as a Gaussian) for an N × N grid.</span></span> <span data-ttu-id="10141-271">I pesi devono essere aggiunti fino a 1.</span><span class="sxs-lookup"><span data-stu-id="10141-271">The weights must add up to 1.</span></span> <span data-ttu-id="10141-272">La trama viene quindi campionata N2 volte.</span><span class="sxs-lookup"><span data-stu-id="10141-272">The texture is then sampled N2 times.</span></span> <span data-ttu-id="10141-273">Ogni esempio viene ridimensionato in base ai pesi corrispondenti nel kernel.</span><span class="sxs-lookup"><span data-stu-id="10141-273">Each sample is scaled by the corresponding weights in the kernel.</span></span> <span data-ttu-id="10141-274">L'esempio CascadedShadowMaps11 usa questo approccio.</span><span class="sxs-lookup"><span data-stu-id="10141-274">The CascadedShadowMaps11 sample uses this approach.</span></span>

### <a name="depth-bias"></a><span data-ttu-id="10141-275">Distorsione profondità</span><span class="sxs-lookup"><span data-stu-id="10141-275">Depth Bias</span></span>

<span data-ttu-id="10141-276">La distorsione della profondità diventa ancora più importante quando vengono usati kernel PCF di grandi dimensioni.</span><span class="sxs-lookup"><span data-stu-id="10141-276">Depth bias becomes even more important when large PCF kernels are used.</span></span> <span data-ttu-id="10141-277">È valido solo per confrontare la profondità dello spazio chiaro di un pixel rispetto al pixel a cui viene eseguito il mapping nella mappa di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-277">It is only valid to compare a pixel's light-space depth against the pixel it maps to in the depth map.</span></span> <span data-ttu-id="10141-278">Gli elementi adiacenti della mappa di profondità fanno riferimento a una posizione diversa.</span><span class="sxs-lookup"><span data-stu-id="10141-278">The depth map texel's neighbors refer to a different position.</span></span> <span data-ttu-id="10141-279">Questa profondità è probabilmente simile, ma può essere molto diversa a seconda della scena.</span><span class="sxs-lookup"><span data-stu-id="10141-279">This depth is likely to be similar, but can be very different depending on the scene.</span></span> <span data-ttu-id="10141-280">Nella figura 11 sono evidenziati gli artefatti che si verificano.</span><span class="sxs-lookup"><span data-stu-id="10141-280">Figure 11 highlights the artifacts that occur.</span></span> <span data-ttu-id="10141-281">Una singola profondità viene confrontata con tre Texel adiacenti nella mappa Shadow.</span><span class="sxs-lookup"><span data-stu-id="10141-281">A single depth is compared to three neighboring texels in the shadow map.</span></span> <span data-ttu-id="10141-282">Uno dei test di profondità non riesce in modo errato perché la profondità non è correlata alla profondità di spazio chiaro calcolata della geometria corrente.</span><span class="sxs-lookup"><span data-stu-id="10141-282">One of the depth tests erroneously fails because its depth does not correlate to the computed light-space depth of the current geometry.</span></span> <span data-ttu-id="10141-283">La soluzione consigliata per questo problema consiste nell'usare un offset maggiore.</span><span class="sxs-lookup"><span data-stu-id="10141-283">The recommended solution to this problem is to use a larger offset.</span></span> <span data-ttu-id="10141-284">Troppo grande di un offset, tuttavia, può portare a Peter panning.</span><span class="sxs-lookup"><span data-stu-id="10141-284">Too large of an offset, however, can result in Peter Panning.</span></span> <span data-ttu-id="10141-285">Il calcolo di un piano vicino e di un piano molto vicino contribuisce a ridurre gli effetti dell'utilizzo di un offset.</span><span class="sxs-lookup"><span data-stu-id="10141-285">Calculating a tight near plane and far plane helps reduce the effects of using an offset.</span></span>

<span data-ttu-id="10141-286">**Figura 11. Ombreggiatura errata**</span><span class="sxs-lookup"><span data-stu-id="10141-286">**Figure 11. Erroneous self-shadowing**</span></span>

![ombreggiatura errata](images/erroneous-self-shadowing.png)

<span data-ttu-id="10141-288">I risultati con ombreggiatura errata dal confronto tra i pixel nella profondità dello spazio chiaro e i Texel nella mappa Shadow che non sono correlati.</span><span class="sxs-lookup"><span data-stu-id="10141-288">The erroneous self-shadowing results from comparing pixels in the light-space depth to the texels in the shadow map that do not correlate.</span></span> <span data-ttu-id="10141-289">La profondità nello spazio chiaro è correlata all'ombreggiatura di Texel 2 nella mappa di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-289">The depth in light-space correlates to shadow texel 2 in the depth map.</span></span> <span data-ttu-id="10141-290">Texel 1 è maggiore della profondità dello spazio chiaro mentre 2 è uguale e 3 è minore.</span><span class="sxs-lookup"><span data-stu-id="10141-290">Texel 1 is greater than the light-space depth while 2 is equal and 3 is less.</span></span> <span data-ttu-id="10141-291">Texels 2 e 3 superano il test di profondità, mentre Texel 1 ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="10141-291">Texels 2 and 3 pass the depth test, while Texel 1 fails.</span></span>

### <a name="calculating-a-per-texel-depth-bias-with-ddx-and-ddy-for-large-pcfs"></a><span data-ttu-id="10141-292">Calcolo di un Per-Texel bias di profondità con DDX e DDY per PCFs di grandi dimensioni</span><span class="sxs-lookup"><span data-stu-id="10141-292">Calculating a Per-Texel Depth Bias with DDX and DDY for Large PCFs</span></span>

<span data-ttu-id="10141-293">Il calcolo di una distorsione di profondità di Texel con **DDX** e **ddy** per PCFS di grandi dimensioni è una tecnica che calcola la distorsione della profondità corretta, supponendo che la superficie sia piana, per la mappa shadow di Texel.</span><span class="sxs-lookup"><span data-stu-id="10141-293">Calculating a per texel depth bias with **ddx** and **ddy** for large PCFs is a technique that calculates the correct depth bias—assuming the surface is planar—for the adjacent shadow map texel.</span></span>

<span data-ttu-id="10141-294">Questa tecnica consente di adattare la profondità di confronto a un piano usando le informazioni derivate.</span><span class="sxs-lookup"><span data-stu-id="10141-294">This technique fits the comparison depth to a plane using the derivative information.</span></span> <span data-ttu-id="10141-295">Poiché questa tecnica è complessa dal punto di vista del calcolo, è consigliabile utilizzarla solo quando una GPU dispone di cicli di calcolo da riservare.</span><span class="sxs-lookup"><span data-stu-id="10141-295">Because this technique is computationally complex, it should be used only when a GPU has compute cycles to spare.</span></span> <span data-ttu-id="10141-296">Quando si usano kernel di grandi dimensioni, può trattarsi dell'unica tecnica che consente di rimuovere gli artefatti di ombreggiatura automatica senza causare la Panoramica di Peter.</span><span class="sxs-lookup"><span data-stu-id="10141-296">When very large kernels are used, this may be the only technique that works to remove self-shadowing artifacts without causing Peter Panning.</span></span>

<span data-ttu-id="10141-297">Nella figura 12 viene evidenziato il problema.</span><span class="sxs-lookup"><span data-stu-id="10141-297">Figure 12 highlights the problem.</span></span> <span data-ttu-id="10141-298">La profondità nello spazio chiaro è nota per un Texel che viene confrontato.</span><span class="sxs-lookup"><span data-stu-id="10141-298">The depth in light-space is known for the one texel that is being compared.</span></span> <span data-ttu-id="10141-299">Le profondità dello spazio chiaro che corrispondono ai Texel adiacenti nella mappa di profondità sono sconosciute.</span><span class="sxs-lookup"><span data-stu-id="10141-299">The light-space depths that correspond to the neighboring texels in the depth map are unknown.</span></span>

<span data-ttu-id="10141-300">**Figura 12. Mappa della scena e della profondità**</span><span class="sxs-lookup"><span data-stu-id="10141-300">**Figure 12. Scene and depth map**</span></span>

![Mappa della scena e della profondità](images/scene-and-depth-map.png)

<span data-ttu-id="10141-302">La scena di cui è stato eseguito il rendering viene visualizzata a sinistra e la mappa di profondità con un blocco Texel di esempio viene visualizzata a destra.</span><span class="sxs-lookup"><span data-stu-id="10141-302">The rendered scene is shown at left, and the depth map with a sample texel block is shown at right.</span></span> <span data-ttu-id="10141-303">Il Texel dello spazio occhio viene mappato al pixel con etichetta D al centro del blocco.</span><span class="sxs-lookup"><span data-stu-id="10141-303">The eye-space texel maps to the pixel labeled D in the center of the block.</span></span> <span data-ttu-id="10141-304">Questo confronto è accurato.</span><span class="sxs-lookup"><span data-stu-id="10141-304">This comparison is accurate.</span></span> <span data-ttu-id="10141-305">Il livello di dettaglio corretto nello spazio degli occhi correlato ai pixel che l'elemento adiacente D è sconosciuto.</span><span class="sxs-lookup"><span data-stu-id="10141-305">The correct depth in eye space correlating to the pixels that neighbor D is unknown.</span></span> <span data-ttu-id="10141-306">È possibile eseguire il mapping dei Texel adiacenti allo spazio degli occhi solo se si presuppone che il pixel sia relativo allo stesso triangolo di D.</span><span class="sxs-lookup"><span data-stu-id="10141-306">Mapping the neighboring texels back to eye space is possible only if we assume the pixel pertains to the same triangle as D.</span></span>

<span data-ttu-id="10141-307">La profondità è nota per il Texel che è correlato alla posizione dello spazio chiaro.</span><span class="sxs-lookup"><span data-stu-id="10141-307">The depth is known for the texel that correlates with the light-space position.</span></span> <span data-ttu-id="10141-308">La profondità è sconosciuta per i Texel adiacenti nella mappa di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-308">The depth is unknown for the neighboring texels in the depth map.</span></span>

<span data-ttu-id="10141-309">A livello generale, questa tecnica usa le operazioni **DDX** e **ddy** HLSL per trovare il derivato della posizione di spazio chiaro.</span><span class="sxs-lookup"><span data-stu-id="10141-309">At a high level, this technique uses the **ddx** and **ddy** HLSL operations to find the derivative of the light-space position.</span></span> <span data-ttu-id="10141-310">Questo non è semplice perché le operazioni derivate restituiscono la sfumatura della profondità dello spazio chiaro rispetto allo spazio dello schermo.</span><span class="sxs-lookup"><span data-stu-id="10141-310">This is nontrivial because the derivative operations return the gradient of the light-space depth with respect to screen space.</span></span> <span data-ttu-id="10141-311">Per eseguire la conversione in una sfumatura della profondità dello spazio chiaro rispetto allo spazio chiaro, è necessario calcolare una matrice di conversione.</span><span class="sxs-lookup"><span data-stu-id="10141-311">To convert this to a gradient of the light-space depth with respect to light space, a conversion matrix must be calculated.</span></span>

### <a name="explanation-with-shader-code"></a><span data-ttu-id="10141-312">Spiegazione con il codice dello shader</span><span class="sxs-lookup"><span data-stu-id="10141-312">Explanation with Shader Code</span></span>

<span data-ttu-id="10141-313">I dettagli del resto dell'algoritmo vengono forniti come spiegazione del codice dello shader che esegue questa operazione.</span><span class="sxs-lookup"><span data-stu-id="10141-313">The details of the rest of the algorithm are given as an explanation of the shader code that performs this operation.</span></span> <span data-ttu-id="10141-314">Questo codice è disponibile nell'esempio CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="10141-314">This code can be found in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="10141-315">Nella figura 13 viene illustrato il mapping tra le coordinate della trama con spazio chiaro e la mappa di profondità e il modo in cui i derivati in X e Y possono essere utilizzati per creare una matrice di trasformazione.</span><span class="sxs-lookup"><span data-stu-id="10141-315">Figure 13 shows how the light-space texture coordinates map to the depth map and how the derivatives in X and Y can be used to create a transformation matrix.</span></span>

<span data-ttu-id="10141-316">**Figura 13. Schermo-spazio per la matrice di spazio chiaro**</span><span class="sxs-lookup"><span data-stu-id="10141-316">**Figure 13. Screen-space to light-space matrix**</span></span>

![schermo-spazio per la matrice di spazio chiaro](images/screen-space-to-light-space-matrix.png)

<span data-ttu-id="10141-318">Per creare questa matrice vengono usati i derivati della posizione di spazio chiaro in X e Y.</span><span class="sxs-lookup"><span data-stu-id="10141-318">The derivatives of the light-space position in X and Y are used to create this matrix.</span></span>

<span data-ttu-id="10141-319">Il primo passaggio consiste nel calcolare il derivato della posizione dello spazio di visualizzazione chiara.</span><span class="sxs-lookup"><span data-stu-id="10141-319">The first step is to calculate the derivative of the light-view-space position.</span></span>


```C++
          float3 vShadowTexDDX = ddx (vShadowMapTextureCoordViewSpace);
          float3 vShadowTexDDY = ddy (vShadowMapTextureCoordViewSpace);
```



<span data-ttu-id="10141-320">Le GPU di classe Direct3D 11 calcolano questi derivati eseguendo 2 × 2 Quad di pixel in parallelo e sottraendo le coordinate di trama dal vicino in X per **DDX** e dal router adiacente in Y per **ddy**.</span><span class="sxs-lookup"><span data-stu-id="10141-320">Direct3D 11 class GPUs calculate these derivatives by running 2 × 2 quad of pixels in parallel and subtracting the texture coordinates from the neighbor in X for **ddx** and from the neighbor in Y for **ddy**.</span></span> <span data-ttu-id="10141-321">Questi due derivati costituiscono le righe di una matrice 2 × 2.</span><span class="sxs-lookup"><span data-stu-id="10141-321">These two derivatives make up the rows of a 2 × 2 matrix.</span></span> <span data-ttu-id="10141-322">Nella forma corrente, questa matrice può essere usata per convertire i pixel adiacenti dello spazio dello schermo a pendii di spazio chiaro.</span><span class="sxs-lookup"><span data-stu-id="10141-322">In its current form, this matrix could be used to convert screen-space neighboring pixels to light-space slopes.</span></span> <span data-ttu-id="10141-323">Tuttavia, l'inverso di questa matrice è necessario.</span><span class="sxs-lookup"><span data-stu-id="10141-323">However, the inverse of this matrix is needed.</span></span> <span data-ttu-id="10141-324">Una matrice che trasforma i pixel adiacenti dello spazio su schermo è necessaria.</span><span class="sxs-lookup"><span data-stu-id="10141-324">A matrix that transforms light-space neighboring pixels to screen-space slopes is needed.</span></span>


```C++
          float2x2 matScreentoShadow = float2x2( vShadowTexDDX.xy, vShadowTexDDY.xy );
          float fInvDeterminant = 1.0f / fDeterminant;

          float2x2 matShadowToScreen = float2x2 (
          matScreentoShadow._22 * fInvDeterminant,
          matScreentoShadow._12 * -fInvDeterminant,
          matScreentoShadow._21 * -fInvDeterminant,
          matScreentoShadow._11 * fInvDeterminant );
```



<span data-ttu-id="10141-325">**Figura 14. Spazio leggero sullo schermo**</span><span class="sxs-lookup"><span data-stu-id="10141-325">**Figure 14. Light-space to screen-space**</span></span>

![spazio leggero sullo schermo](images/light-space-to-screen-space.png)

<span data-ttu-id="10141-327">Questa matrice viene quindi utilizzata per trasformare i due Texel sopra e a destra del Texel corrente.</span><span class="sxs-lookup"><span data-stu-id="10141-327">This matrix is then used to transform the two texels above and to the right of the current texel.</span></span> <span data-ttu-id="10141-328">Questi vicini sono rappresentati come offset dal Texel corrente.</span><span class="sxs-lookup"><span data-stu-id="10141-328">These neighbors are represented as an offset from the current texel.</span></span>


```C++
          float2 vRightShadowTexelLocation = float2( m_fTexelSize, 0.0f );
          float2 vUpShadowTexelLocation = float2( 0.0f, m_fTexelSize );
          float2 vRightTexelDepthRatio = mul( vRightShadowTexelLocation,
          matShadowToScreen );
          float2 vUpTexelDepthRatio = mul( vUpShadowTexelLocation,
          matShadowToScreen );
```



<span data-ttu-id="10141-329">Il rapporto creato dalla matrice viene infine moltiplicato per i derivati di profondità per calcolare gli offset di profondità per i pixel adiacenti.</span><span class="sxs-lookup"><span data-stu-id="10141-329">The ratio that the matrix creates is finally multiplied by the depth derivatives to calculate the depth offsets for the neighboring pixels.</span></span>


```C++
            float fUpTexelDepthDelta =
            vUpTexelDepthRatio.x * vShadowTexDDX.z
            + vUpTexelDepthRatio.y * vShadowTexDDY.z;
            float fRightTexelDepthDelta =
            vRightTexelDepthRatio.x * vShadowTexDDX.z
            + vRightTexelDepthRatio.y * vShadowTexDDY.z;
```



<span data-ttu-id="10141-330">Questi pesi possono ora essere usati in un ciclo PCF per aggiungere un offset alla posizione.</span><span class="sxs-lookup"><span data-stu-id="10141-330">These weights can now be used in a PCF loop to add an offset to the position.</span></span>


```C++
    for( int x = m_iPCFBlurForLoopStart; x < m_iPCFBlurForLoopEnd; ++x ) 
    {
        for( int y = m_iPCFBlurForLoopStart; y < m_iPCFBlurForLoopEnd; ++y )
            {
            if ( USE_DERIVATIVES_FOR_DEPTH_OFFSET_FLAG )
            {
            depthcompare += fRightTexelDepthDelta * ( (float) x ) +
            fUpTexelDepthDelta * ( (float) y );
            }
            // Compare the transformed pixel depth to the depth read
            // from the map.
            fPercentLit += g_txShadow.SampleCmpLevelZero( g_samShadow,
            float2(
            vShadowTexCoord.x + ( ( (float) x ) * m_fNativeTexelSizeInX ) ,
            vShadowTexCoord.y + ( ( (float) y ) * m_fTexelSize )
            ),
            depthcompare
            );
            }
     }
```



## <a name="pcf-and-csms"></a><span data-ttu-id="10141-331">PCF e CSM</span><span class="sxs-lookup"><span data-stu-id="10141-331">PCF and CSMs</span></span>

<span data-ttu-id="10141-332">Il PCF non funziona sulle matrici di trama in Direct3D 10.</span><span class="sxs-lookup"><span data-stu-id="10141-332">PCF does not work on texture arrays in Direct3D 10.</span></span> <span data-ttu-id="10141-333">Per usare PCF, tutte le cascate vengono archiviate in un unico Atlante di trama di grandi dimensioni.</span><span class="sxs-lookup"><span data-stu-id="10141-333">To use PCF, all of the cascades are stored in one large texture atlas.</span></span>

### <a name="derivative-based-offset"></a><span data-ttu-id="10141-334">Offset Derivative-Based</span><span class="sxs-lookup"><span data-stu-id="10141-334">Derivative-Based Offset</span></span>

<span data-ttu-id="10141-335">L'aggiunta degli offset basati su derivati per CSM presenta alcune problemi.</span><span class="sxs-lookup"><span data-stu-id="10141-335">Adding the derivative based offsets for CSMs presents some challenges.</span></span> <span data-ttu-id="10141-336">Ciò è dovuto a un calcolo derivato all'interno del controllo di flusso divergente.</span><span class="sxs-lookup"><span data-stu-id="10141-336">This is due to a derivative calculation within divergent flow control.</span></span> <span data-ttu-id="10141-337">Il problema si verifica a causa di una modalità fondamentale di funzionamento delle GPU.</span><span class="sxs-lookup"><span data-stu-id="10141-337">The problem occurs because of a fundamental way that GPUs operate.</span></span> <span data-ttu-id="10141-338">Le GPU Direct3D11 funzionano su 2 × 2 Quad di pixel.</span><span class="sxs-lookup"><span data-stu-id="10141-338">Direct3D11 GPUs operate on 2 × 2 quads of pixels.</span></span> <span data-ttu-id="10141-339">Per eseguire una derivata, le GPU in genere sottraggono la copia del pixel corrente di una variabile dalla copia del pixel adiacente della stessa variabile.</span><span class="sxs-lookup"><span data-stu-id="10141-339">To perform a derivative, GPUs generally subtract the current pixel's copy of a variable from the neighboring pixel's copy of that same variable.</span></span> <span data-ttu-id="10141-340">Il modo in cui questa situazione si verifica varia da GPU a GPU.</span><span class="sxs-lookup"><span data-stu-id="10141-340">How this happens varies from GPU to GPU.</span></span> <span data-ttu-id="10141-341">Le coordinate di trama sono determinate dalla selezione a catena basata su mapping o basata sull'intervallo.</span><span class="sxs-lookup"><span data-stu-id="10141-341">The texture coordinates are determined by map-based or interval-based cascade selection.</span></span> <span data-ttu-id="10141-342">Alcuni pixel in un quad pixel scelgono una catena diversa rispetto al resto dei pixel.</span><span class="sxs-lookup"><span data-stu-id="10141-342">Some pixels in a pixel quad choose a different cascade than the rest of the pixels.</span></span> <span data-ttu-id="10141-343">In questo modo si ottiene una giunzione visibile tra le mappe Shadow perché gli offset basati sulla derivazione sono ora completamente errati.</span><span class="sxs-lookup"><span data-stu-id="10141-343">This results in visible seams between shadow maps because the derivative-based offsets are now completely wrong.</span></span> <span data-ttu-id="10141-344">La soluzione consiste nell'eseguire il derivato dalle coordinate di trama dello spazio di visualizzazione chiara.</span><span class="sxs-lookup"><span data-stu-id="10141-344">The solution is to perform the derivative on light-view space texture coordinates.</span></span> <span data-ttu-id="10141-345">Queste coordinate sono le stesse per ogni catena.</span><span class="sxs-lookup"><span data-stu-id="10141-345">These coordinates are the same for every cascade.</span></span>

### <a name="padding-for-pcf-kernels"></a><span data-ttu-id="10141-346">Spaziatura interna per i kernel PCF</span><span class="sxs-lookup"><span data-stu-id="10141-346">Padding for PCF Kernels</span></span>

<span data-ttu-id="10141-347">Indice dei kernel PCF esterno a una partizione Cascade se il buffer ombreggiato non viene riempito.</span><span class="sxs-lookup"><span data-stu-id="10141-347">PCF kernels index outside of a cascade partition if the shadow buffer is not padded.</span></span> <span data-ttu-id="10141-348">La soluzione consiste nel riempire il bordo esterno della cascata di una metà della dimensione del kernel PCF.</span><span class="sxs-lookup"><span data-stu-id="10141-348">The solution is to pad the outer rim of the cascade by one-half the size of the PCF kernel.</span></span> <span data-ttu-id="10141-349">Questa operazione deve essere implementata nello shader che seleziona Cascade e nella matrice di proiezione che deve eseguire il rendering della dimensione a cascata sufficiente che il bordo venga mantenuto.</span><span class="sxs-lookup"><span data-stu-id="10141-349">This must be implemented in the shader that selects the cascade and in the projection matrix that must render the cascade large enough that the border is preserved.</span></span>

## <a name="variance-shadow-maps"></a><span data-ttu-id="10141-350">Mappe Shadow varianza</span><span class="sxs-lookup"><span data-stu-id="10141-350">Variance Shadow Maps</span></span>

<span data-ttu-id="10141-351">VSMs (per altre informazioni, vedere [mappe shadow di varianza](https://portal.acm.org/citation.cfm?doid=1111411.1111440) per Donnelly e Lauritzen).</span><span class="sxs-lookup"><span data-stu-id="10141-351">VSMs (see [Variance shadow maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440) by Donnelly and Lauritzen for more information) enable direct shadow map filtering.</span></span> <span data-ttu-id="10141-352">Quando si usa VSMs, è possibile usare tutte le potenzialità dell'hardware di filtro della trama.</span><span class="sxs-lookup"><span data-stu-id="10141-352">When using VSMs, all of the power of the texture-filtering hardware can be used.</span></span> <span data-ttu-id="10141-353">È possibile utilizzare il filtro trilineare e anisotropico (Figura 15).</span><span class="sxs-lookup"><span data-stu-id="10141-353">Trilinear and anisotropic (Figure 15) filtering can be used.</span></span> <span data-ttu-id="10141-354">Inoltre, VSMs può essere offuscato direttamente tramite convoluzione.</span><span class="sxs-lookup"><span data-stu-id="10141-354">Additionally, VSMs can be blurred directly through convolution.</span></span> <span data-ttu-id="10141-355">VSMs presentano alcuni svantaggi; è necessario archiviare due canali di dati di profondità (profondità e profondità al quadrato).</span><span class="sxs-lookup"><span data-stu-id="10141-355">VSMs do have some drawbacks; two channels of depth data must be stored (depth and depth squared).</span></span> <span data-ttu-id="10141-356">Quando le ombre si sovrappongono, l'emorragia chiara è comune.</span><span class="sxs-lookup"><span data-stu-id="10141-356">When shadows overlap, light-bleeding is common.</span></span> <span data-ttu-id="10141-357">Funzionano bene, tuttavia, con risoluzioni inferiori e possono essere combinate con CSM.</span><span class="sxs-lookup"><span data-stu-id="10141-357">They work well, however, with lower resolutions and can be combined with CSMs.</span></span>

<span data-ttu-id="10141-358">**Figura 15. Filtro anisotropico**</span><span class="sxs-lookup"><span data-stu-id="10141-358">**Figure 15. Anisotropic filtering**</span></span>

![filtro anisotropico](images/anisotropic-filtering.png)

### <a name="algorithm-details"></a><span data-ttu-id="10141-360">Informazioni sugli algoritmi</span><span class="sxs-lookup"><span data-stu-id="10141-360">Algorithm Details</span></span>

<span data-ttu-id="10141-361">VSMs funziona eseguendo il rendering della profondità e della profondità quadrata in una mappa Shadow a due canali.</span><span class="sxs-lookup"><span data-stu-id="10141-361">VSMs work by rendering the depth and the depth squared to a two-channel shadow map.</span></span> <span data-ttu-id="10141-362">Questa mappa Shadow a due canali può quindi essere sfocata e filtrata come una trama normale.</span><span class="sxs-lookup"><span data-stu-id="10141-362">This two-channel shadow map can then be blurred and filtered just like a normal texture.</span></span> <span data-ttu-id="10141-363">L'algoritmo usa quindi la disuguaglianza di Chebychev nel pixel shader per stimare la frazione dell'area pixel che supera il test di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-363">The algorithm then uses Chebychev's Inequality in the pixel shader to estimate the fraction of pixel area that would pass the depth test.</span></span>

<span data-ttu-id="10141-364">Il pixel shader recupera i valori di profondità e quadratini di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-364">The pixel shader fetches the depth and depth-squared values.</span></span>


```C++
        float  fAvgZ  = mapDepth.x; // Filtered z
        float  fAvgZ2 = mapDepth.y; // Filtered z-squared
```



<span data-ttu-id="10141-365">Viene eseguito il confronto di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-365">The depth comparison is performed.</span></span>


```C++
        if ( fDepth <= fAvgZ )
        {
        fPercentLit = 1;
        }
```



<span data-ttu-id="10141-366">Se il confronto di profondità ha esito negativo, si stima la percentuale del pixel illuminato.</span><span class="sxs-lookup"><span data-stu-id="10141-366">If the depth comparison fails, the percentage of the pixel that is lit is estimated.</span></span> <span data-ttu-id="10141-367">La varianza viene calcolata come media dei quadrati meno quadrati di media.</span><span class="sxs-lookup"><span data-stu-id="10141-367">Variance is calculated as average-of-squares minus square-of-average.</span></span>


```C++
        float variance = ( fAvgZ2 ) − ( fAvgZ * fAvgZ );
        variance = min( 1.0f, max( 0.0f, variance + 0.00001f ) );
```



<span data-ttu-id="10141-368">Il valore fPercentLit è stimato con la disuguaglianza di Chebychev.</span><span class="sxs-lookup"><span data-stu-id="10141-368">The fPercentLit value is estimated with Chebychev's Inequality.</span></span>


```C++
        float mean           = fAvgZ;
        float d              = fDepth - mean;
        float fPercentLit    = variance / ( variance + d*d );
```



## <a name="light-bleeding"></a><span data-ttu-id="10141-369">Sanguinamento chiaro</span><span class="sxs-lookup"><span data-stu-id="10141-369">Light Bleeding</span></span>

<span data-ttu-id="10141-370">Lo svantaggio più grande per VSMs è la perdita di luce (Figura 16).</span><span class="sxs-lookup"><span data-stu-id="10141-370">The biggest drawback to VSMs is light bleeding (Figure 16).</span></span> <span data-ttu-id="10141-371">Lo spurgo chiaro si verifica quando più cast di ombreggiatura si occludere a vicenda lungo i bordi.</span><span class="sxs-lookup"><span data-stu-id="10141-371">Light bleeding occurs when multiple shadow casters occlude each other along edges.</span></span> <span data-ttu-id="10141-372">VSMs ombreggiare i bordi delle ombreggiature in base a differenze di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-372">VSMs shade the edges of shadows based on depth disparities.</span></span> <span data-ttu-id="10141-373">Quando le ombre si sovrappongono le une alle altre, esiste una disparità di profondità al centro di un'area che deve essere ombreggiata.</span><span class="sxs-lookup"><span data-stu-id="10141-373">When shadows overlap each other, a depth disparity exists in the center of a region that should be shadowed.</span></span> <span data-ttu-id="10141-374">Si tratta di un problema relativo all'uso dell'algoritmo VSM.</span><span class="sxs-lookup"><span data-stu-id="10141-374">This is a problem with using the VSM algorithm.</span></span>

<span data-ttu-id="10141-375">**Figura 16. VSM Light Bleeding**</span><span class="sxs-lookup"><span data-stu-id="10141-375">**Figure 16. VSM light bleeding**</span></span>

![VSM Light Bleeding](images/vsm-light-bleeding.png)

<span data-ttu-id="10141-377">Una soluzione parziale al problema consiste nell'elevare il fPercentLit a una potenza.</span><span class="sxs-lookup"><span data-stu-id="10141-377">A partial solution to the problem is to raise the fPercentLit to a power.</span></span> <span data-ttu-id="10141-378">Questo ha l'effetto di smorzare la sfocatura, che può causare artefatti in cui la disparità della profondità è ridotta.</span><span class="sxs-lookup"><span data-stu-id="10141-378">This has the effect of dampening the blur, which can cause artifacts where depth disparity is small.</span></span> <span data-ttu-id="10141-379">In alcuni casi esiste un valore magico che attenua il problema.</span><span class="sxs-lookup"><span data-stu-id="10141-379">Sometimes there exists a magical value that alleviates the problem.</span></span>


```C++
fPercentLit = pow( p_max, MAGIC_NUMBER );
```



<span data-ttu-id="10141-380">Un'alternativa a elevare la percentuale di illuminazione a una potenza consiste nell'evitare configurazioni in cui si sovrappongono le ombreggiature.</span><span class="sxs-lookup"><span data-stu-id="10141-380">An alternative to raising the percent lit to a power is to avoid configurations where shadows overlap.</span></span> <span data-ttu-id="10141-381">Anche le configurazioni Shadow altamente ottimizzate presentano diversi vincoli su luce, fotocamera e geometria.</span><span class="sxs-lookup"><span data-stu-id="10141-381">Even highly tuned shadow configurations have several constraints on light, camera, and geometry.</span></span> <span data-ttu-id="10141-382">Il Bleeding chiaro viene inoltre ridotto utilizzando trame di risoluzione superiore.</span><span class="sxs-lookup"><span data-stu-id="10141-382">Light bleeding is also lessened by using higher resolution textures.</span></span>

<span data-ttu-id="10141-383">Le mappe shadow di varianza a più livelli (LVSMs) consentono di risolvere il problema a scapito della suddivisione del tronco in livelli perpendicolari alla luce.</span><span class="sxs-lookup"><span data-stu-id="10141-383">Layered variance shadow maps (LVSMs) solve the problem at the expense of breaking the frustum into layers that are perpendicular to the light.</span></span> <span data-ttu-id="10141-384">Il numero di mappe necessarie è molto grande quando vengono usate anche CSM.</span><span class="sxs-lookup"><span data-stu-id="10141-384">The number of maps required would be quite large when CSMs are also being used.</span></span>

<span data-ttu-id="10141-385">Inoltre, Andrew Lauritzen, co-autore del documento su VSMs e autore di un documento su LVSMs, ha discusso la combinazione di mappe Shadow esponenziali (ESMs) con VSMs per contrastare la fusione chiara in un [Forum di Beyond3D](https://forum.beyond3d.com/showthread.php?t=47427).</span><span class="sxs-lookup"><span data-stu-id="10141-385">Additionally, Andrew Lauritzen, co-author of the paper on VSMs, and author of a paper on LVSMs, discussed combining exponential shadow maps (ESMs) with VSMs to counteract light blending in a [Beyond3D Forum](https://forum.beyond3d.com/showthread.php?t=47427).</span></span>

## <a name="vsms-with-csms"></a><span data-ttu-id="10141-386">VSMs con CSM</span><span class="sxs-lookup"><span data-stu-id="10141-386">VSMs with CSMs</span></span>

<span data-ttu-id="10141-387">Il VarianceShadow11 di esempio combina VSMs e CSM.</span><span class="sxs-lookup"><span data-stu-id="10141-387">The sample VarianceShadow11 combines VSMs and CSMs.</span></span> <span data-ttu-id="10141-388">La combinazione è piuttosto semplice.</span><span class="sxs-lookup"><span data-stu-id="10141-388">The combination is fairly straightforward.</span></span> <span data-ttu-id="10141-389">L'esempio segue gli stessi passaggi dell'esempio CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="10141-389">The sample follows the same steps as the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="10141-390">Poiché il PCF non viene usato, le ombreggiature vengono sfocate in una convoluzione bidirezionale con due passaggi.</span><span class="sxs-lookup"><span data-stu-id="10141-390">Because PCF is not used, the shadows are blurred in a two-pass separable convolution.</span></span> <span data-ttu-id="10141-391">La mancata utilizzo di PCF consente inoltre all'esempio di utilizzare matrici di trama anziché un Atlante di trama.</span><span class="sxs-lookup"><span data-stu-id="10141-391">Not using PCF also enables the sample to use texture arrays instead of a texture atlas.</span></span> <span data-ttu-id="10141-392">Il PCF sulle matrici di trame è una funzionalità di Direct3D 10,1.</span><span class="sxs-lookup"><span data-stu-id="10141-392">PCF on texture arrays is a Direct3D 10.1 feature.</span></span>

### <a name="gradients-with-csms"></a><span data-ttu-id="10141-393">Gradienti con CSM</span><span class="sxs-lookup"><span data-stu-id="10141-393">Gradients with CSMs</span></span>

<span data-ttu-id="10141-394">L'uso di gradienti con CSM può produrre un Seam lungo il bordo tra due cascate, come illustrato nella figura 17.</span><span class="sxs-lookup"><span data-stu-id="10141-394">Using gradients with CSMs can produce a seam along the border between two cascades as seen in Figure 17.</span></span> <span data-ttu-id="10141-395">L'istruzione di esempio usa i derivati tra i pixel per calcolare le informazioni, ad esempio il livello mipmap, necessario per il filtro.</span><span class="sxs-lookup"><span data-stu-id="10141-395">The sample instruction uses derivatives between pixels to calculate information, such as the mipmap level, needed by the filter.</span></span> <span data-ttu-id="10141-396">Questo causa un problema in particolare per la selezione di mipmap o l'applicazione di filtri anisotropico.</span><span class="sxs-lookup"><span data-stu-id="10141-396">This causes a problem in particular for mipmap selection or anisotropic filtering.</span></span> <span data-ttu-id="10141-397">Quando i pixel in un quad accettano rami diversi nello shader, i derivati calcolati dall'hardware della GPU non sono validi.</span><span class="sxs-lookup"><span data-stu-id="10141-397">When pixels in a quad take different branches in the shader, the derivatives calculated by the GPU hardware are invalid.</span></span> <span data-ttu-id="10141-398">In questo modo si ottiene una cucitura irregolare lungo la mappa Shadow.</span><span class="sxs-lookup"><span data-stu-id="10141-398">This results in a jagged seam along the shadow map.</span></span>

<span data-ttu-id="10141-399">**Figura 17. Seam sui bordi a cascata a causa del filtro anisotropico con controllo di flusso divergente**</span><span class="sxs-lookup"><span data-stu-id="10141-399">**Figure 17. Seams on cascade borders due to anisotropic filtering with divergent flow control**</span></span>

![Seam sui bordi a cascata a causa del filtro anisotropico con controllo di flusso divergente](images/seams-on-cascade-borders-due-to-anisotropic.jpg)

<span data-ttu-id="10141-401">Questo problema viene risolto calcolando i derivati sulla posizione nello spazio di visualizzazione chiaro; la coordinata dello spazio di visualizzazione chiara non è specifica per la Cascade selezionata.</span><span class="sxs-lookup"><span data-stu-id="10141-401">This problem is solved by computing the derivatives on the position in light-view space; the light-view space coordinate is not specific to the selected cascade.</span></span> <span data-ttu-id="10141-402">I derivati calcolati possono essere ridimensionati in base alla parte della scala della matrice di proiezione e al livello di mipmap corretto.</span><span class="sxs-lookup"><span data-stu-id="10141-402">The computed derivatives can be scaled by the scale portion of the projection-texture matrix to the correct mipmap level.</span></span>


```C++
        float3 vShadowTexCoordDDX = ddx( vShadowMapTextureCoordViewSpace );
        vShadowTexCoordDDX *= m_vCascadeScale[iCascade].xyz;
        float3 vShadowTexCoordDDY = ddy( vShadowMapTextureCoordViewSpace );
        vShadowTexCoordDDY *= m_vCascadeScale[iCascade].xyz;

        mapDepth += g_txShadow.SampleGrad( g_samShadow, vShadowTexCoord.xyz,
        vShadowTexCoordDDX, vShadowTexCoordDDY );
```



## <a name="vsms-compared-to-standard-shadows-with-pcf"></a><span data-ttu-id="10141-403">VSMs rispetto alle ombreggiature standard con PCF</span><span class="sxs-lookup"><span data-stu-id="10141-403">VSMs Compared to Standard Shadows with PCF</span></span>

<span data-ttu-id="10141-404">Sia VSMs che PCF tentano di approssimare la frazione dell'area pixel che supera il test di profondità.</span><span class="sxs-lookup"><span data-stu-id="10141-404">Both VSMs and PCF attempt to approximate the fraction of pixel area that would pass the depth test.</span></span> <span data-ttu-id="10141-405">VSMs funzionano con i filtri hardware e possono essere confusi con i kernel separabili.</span><span class="sxs-lookup"><span data-stu-id="10141-405">VSMs work with filtering hardware and can be blurred with separable kernels.</span></span> <span data-ttu-id="10141-406">I kernel di convoluzione separabili sono molto più economici da implementare rispetto a un kernel completo.</span><span class="sxs-lookup"><span data-stu-id="10141-406">Separable convolution kernels are considerably cheaper to implement than a full kernel.</span></span> <span data-ttu-id="10141-407">Inoltre, VSMs confronta una profondità di spazio leggero rispetto a un valore nella mappa di profondità dello spazio chiaro.</span><span class="sxs-lookup"><span data-stu-id="10141-407">Additionally, VSMs compare one light-space depth against one value in the light-space depth map.</span></span> <span data-ttu-id="10141-408">Ciò significa che VSMs non ha gli stessi problemi di offset del PCF.</span><span class="sxs-lookup"><span data-stu-id="10141-408">This means that VSMs do not have the same offset problems as PCF.</span></span> <span data-ttu-id="10141-409">Tecnicamente, la VSMs è la profondità di campionamento in un'area più ampia, oltre a eseguire un'analisi statistica.</span><span class="sxs-lookup"><span data-stu-id="10141-409">Technically, VSMs are sampling depth over a greater area, as well as performing a statistical analysis.</span></span> <span data-ttu-id="10141-410">Questo è meno preciso del PCF.</span><span class="sxs-lookup"><span data-stu-id="10141-410">This is less precise than PCF.</span></span> <span data-ttu-id="10141-411">In pratica, VSMs esegue un ottimo processo di blending, con conseguente minore offset necessario.</span><span class="sxs-lookup"><span data-stu-id="10141-411">In practice, VSMs do a very good job of blending, which results in less offset being necessary.</span></span> <span data-ttu-id="10141-412">Come descritto in precedenza, il numero uno svantaggio di VSMs è il sanguinamento chiaro.</span><span class="sxs-lookup"><span data-stu-id="10141-412">As described above, the number one drawback to VSMs is light bleeding.</span></span>

<span data-ttu-id="10141-413">VSMs e PCF rappresentano un compromesso tra la potenza di calcolo GPU e la larghezza di banda della trama GPU.</span><span class="sxs-lookup"><span data-stu-id="10141-413">VSMs and PCF represent a trade-off between GPU compute power and GPU texture bandwidth.</span></span> <span data-ttu-id="10141-414">VSMs richiede un maggior numero di operazioni matematiche da eseguire per calcolare la varianza.</span><span class="sxs-lookup"><span data-stu-id="10141-414">VSMs require more math to be performed to calculate the variance.</span></span> <span data-ttu-id="10141-415">Il PCF richiede una larghezza di banda di memoria più trama.</span><span class="sxs-lookup"><span data-stu-id="10141-415">PCF requires more texture memory bandwidth.</span></span> <span data-ttu-id="10141-416">I kernel PCF di grandi dimensioni possono diventare rapidamente un collo di bottiglia con la larghezza di banda della trama.</span><span class="sxs-lookup"><span data-stu-id="10141-416">Large PCF kernels can quickly become bottlenecked by texture bandwidth.</span></span> <span data-ttu-id="10141-417">Con la crescita più rapida del calcolo della GPU rispetto alla larghezza di banda della GPU, VSMs sta diventando il più pratico dei due algoritmi.</span><span class="sxs-lookup"><span data-stu-id="10141-417">With GPU computation power growing more rapidly than GPU bandwidth, VSMs are becoming the more practical of the two algorithms.</span></span> <span data-ttu-id="10141-418">VSMs inoltre un aspetto migliore con le mappe Shadow a risoluzione inferiore a causa della fusione e del filtro.</span><span class="sxs-lookup"><span data-stu-id="10141-418">VSMs also look better with lower resolution shadow maps due to blending and filtering.</span></span>

## <a name="summary"></a><span data-ttu-id="10141-419">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="10141-419">Summary</span></span>

<span data-ttu-id="10141-420">CSM offrono una soluzione al problema di aliasing della prospettiva.</span><span class="sxs-lookup"><span data-stu-id="10141-420">CSMs offer a solution to the perspective aliasing problem.</span></span> <span data-ttu-id="10141-421">Esistono diverse configurazioni possibili per ottenere la fedeltà visiva necessaria per un titolo.</span><span class="sxs-lookup"><span data-stu-id="10141-421">There are several possible configurations to get the needed visual fidelity for a title.</span></span> <span data-ttu-id="10141-422">PCF e VSMs sono ampiamente usati e devono essere combinati con CSM per ridurre l'aliasing.</span><span class="sxs-lookup"><span data-stu-id="10141-422">PCF and VSMs are widely used and should be combined with CSMs to reduce aliasing.</span></span>

## <a name="references"></a><span data-ttu-id="10141-423">Riferimenti</span><span class="sxs-lookup"><span data-stu-id="10141-423">References</span></span>

<span data-ttu-id="10141-424">Donnelly, W. e Lauritzen, A. [varianza Maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span><span class="sxs-lookup"><span data-stu-id="10141-424">Donnelly, W. and Lauritzen, A. [Variance shadow maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span></span> <span data-ttu-id="10141-425">In SI3D '06: procedure del Simposio 2006 su grafica e giochi 3D interattivi.</span><span class="sxs-lookup"><span data-stu-id="10141-425">In SI3D '06: Proceedings of the 2006 symposium on Interactive 3D graphics and games.</span></span> <span data-ttu-id="10141-426">2006.</span><span class="sxs-lookup"><span data-stu-id="10141-426">2006.</span></span> <span data-ttu-id="10141-427">pp. 161 – 165.</span><span class="sxs-lookup"><span data-stu-id="10141-427">pp. 161–165.</span></span> <span data-ttu-id="10141-428">New York, NY, USA: ACM Press.</span><span class="sxs-lookup"><span data-stu-id="10141-428">New York, NY, USA: ACM Press.</span></span>

<span data-ttu-id="10141-429">Lauritzen, Andrew e McCool, Michael.</span><span class="sxs-lookup"><span data-stu-id="10141-429">Lauritzen, Andrew and McCool, Michael.</span></span> <span data-ttu-id="10141-430">[Mappe shadow di varianza](https://portal.acm.org/citation.cfm?id=1375714.1375739&coll=GUIDE&dl=GUIDE&CFID=45360327&CFTOKEN=34578992)a più livelli.</span><span class="sxs-lookup"><span data-stu-id="10141-430">[Layered variance shadow maps](https://portal.acm.org/citation.cfm?id=1375714.1375739&coll=GUIDE&dl=GUIDE&CFID=45360327&CFTOKEN=34578992).</span></span> <span data-ttu-id="10141-431">Procedure di interfaccia grafica 2008, 28-30, 2008, Windsor, Ontario, Canada.</span><span class="sxs-lookup"><span data-stu-id="10141-431">Proceedings of graphics interface 2008, May 28–30, 2008, Windsor, Ontario, Canada.</span></span>

<span data-ttu-id="10141-432">Engel, Woflgang F. sezione 4.</span><span class="sxs-lookup"><span data-stu-id="10141-432">Engel, Woflgang F. Section 4.</span></span> <span data-ttu-id="10141-433">Mappe Shadow a cascata.</span><span class="sxs-lookup"><span data-stu-id="10141-433">Cascaded Shadow Maps.</span></span> <span data-ttu-id="10141-434">ShaderX5, Advanced rendering Techniques, Wolfgang F. Engel, ed.</span><span class="sxs-lookup"><span data-stu-id="10141-434">ShaderX5 , Advanced Rendering Techniques, Wolfgang F. Engel, Ed.</span></span> <span data-ttu-id="10141-435">Charles River Media, Boston, Massachusetts.</span><span class="sxs-lookup"><span data-stu-id="10141-435">Charles River Media, Boston, Massachusetts.</span></span> <span data-ttu-id="10141-436">2006.</span><span class="sxs-lookup"><span data-stu-id="10141-436">2006.</span></span> <span data-ttu-id="10141-437">pp. 197 – 206.</span><span class="sxs-lookup"><span data-stu-id="10141-437">pp. 197–206.</span></span>

 

 