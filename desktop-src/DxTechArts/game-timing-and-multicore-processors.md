---
title: Temporizzazione dei giochi e processori multicore
description: Questo articolo suggerisce una soluzione più accurata e affidabile per ottenere intervalli di CPU ad alta risoluzione usando le API Windows QueryPerformanceCounter e QueryPerformanceFrequency.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9c5c511f558b59e94945e63c44db225f34ac2583
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/20/2020
ms.locfileid: "106300086"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="aea26-103">Temporizzazione dei giochi e processori multicore</span><span class="sxs-lookup"><span data-stu-id="aea26-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="aea26-104">Con le tecnologie di risparmio energia che diventano più comuni nei computer odierni, un metodo comunemente usato per ottenere intervalli di CPU ad alta risoluzione, l'istruzione RDTSC, potrebbe non funzionare più come previsto.</span><span class="sxs-lookup"><span data-stu-id="aea26-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="aea26-105">Questo articolo suggerisce una soluzione più accurata e affidabile per ottenere intervalli di CPU ad alta risoluzione usando le API Windows [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="aea26-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="aea26-106">Background</span><span class="sxs-lookup"><span data-stu-id="aea26-106">Background</span></span>](#background)
-   [<span data-ttu-id="aea26-107">Indicazioni</span><span class="sxs-lookup"><span data-stu-id="aea26-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="aea26-108">Compatibilità delle applicazioni</span><span class="sxs-lookup"><span data-stu-id="aea26-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="aea26-109">Sfondo</span><span class="sxs-lookup"><span data-stu-id="aea26-109">Background</span></span>

<span data-ttu-id="aea26-110">Dall'introduzione del set di istruzioni x86 P5, molti sviluppatori di giochi hanno usato il contatore Read Time Stamp, l'istruzione RDTSC, per eseguire tempi di risoluzione elevata.</span><span class="sxs-lookup"><span data-stu-id="aea26-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="aea26-111">I timer multimediali di Windows sono sufficientemente precisi per l'elaborazione audio e video, ma con tempi di fotogrammi di decine di millisecondi o minori, non hanno una risoluzione sufficiente per fornire informazioni sul tempo delta.</span><span class="sxs-lookup"><span data-stu-id="aea26-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="aea26-112">Molti giochi usano ancora un timer multimediale all'avvio per stabilire la frequenza della CPU e usano tale valore di frequenza per ridimensionare i risultati da RDTSC per ottenere il tempo esatto.</span><span class="sxs-lookup"><span data-stu-id="aea26-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="aea26-113">A causa delle limitazioni di RDTSC, l'API Windows espone il modo più corretto per accedere a questa funzionalità tramite le routine di [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="aea26-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="aea26-114">Questo utilizzo di RDTSC per la tempistica soffre di questi problemi fondamentali:</span><span class="sxs-lookup"><span data-stu-id="aea26-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="aea26-115">Valori discontinui.</span><span class="sxs-lookup"><span data-stu-id="aea26-115">Discontinuous values.</span></span> <span data-ttu-id="aea26-116">L'utilizzo diretto di RDTSC presuppone che il thread sia sempre in esecuzione nello stesso processore.</span><span class="sxs-lookup"><span data-stu-id="aea26-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="aea26-117">I sistemi multiprocessore e dual core non garantiscono la sincronizzazione dei contatori del ciclo tra i core.</span><span class="sxs-lookup"><span data-stu-id="aea26-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="aea26-118">Questa funzionalità è esacerbata in combinazione con moderne tecnologie di risparmio energia che inattivano e ripristinano diversi core in momenti diversi, il che comporta che i core non siano sincronizzati.</span><span class="sxs-lookup"><span data-stu-id="aea26-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="aea26-119">Per un'applicazione, ciò comporta in genere problemi di anomalie o potenziali arresti anomali quando il thread passa tra i processori e ottiene i valori di intervallo che comportano Delta di grandi dimensioni, Delta negativi o intervalli interrotti.</span><span class="sxs-lookup"><span data-stu-id="aea26-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="aea26-120">Disponibilità di hardware dedicato.</span><span class="sxs-lookup"><span data-stu-id="aea26-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="aea26-121">RDTSC blocca le informazioni di temporizzazione richieste dall'applicazione al contatore dei cicli del processore.</span><span class="sxs-lookup"><span data-stu-id="aea26-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="aea26-122">Per molti anni questo è stato il modo migliore per ottenere informazioni sugli intervalli a precisione elevata, ma le schede madri più recenti ora includono dispositivi temporizzati dedicati che forniscono informazioni sui tempi di risoluzione elevata senza gli svantaggi di RDTSC.</span><span class="sxs-lookup"><span data-stu-id="aea26-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="aea26-123">Variabilità della frequenza della CPU.</span><span class="sxs-lookup"><span data-stu-id="aea26-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="aea26-124">Il presupposto è spesso il fatto che la frequenza della CPU è fissa per la durata del programma.</span><span class="sxs-lookup"><span data-stu-id="aea26-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="aea26-125">Tuttavia, con le moderne tecnologie di risparmio energia, si tratta di un presupposto non corretto.</span><span class="sxs-lookup"><span data-stu-id="aea26-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="aea26-126">Sebbene inizialmente limitato a computer portatili e altri dispositivi mobili, la tecnologia che modifica la frequenza della CPU è in uso in molti PC desktop di fascia alta; la disabilitazione della funzione per mantenere una frequenza coerente non è generalmente accettabile per gli utenti.</span><span class="sxs-lookup"><span data-stu-id="aea26-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="aea26-127">Consigli</span><span class="sxs-lookup"><span data-stu-id="aea26-127">Recommendations</span></span>

<span data-ttu-id="aea26-128">Per i giochi sono necessarie informazioni temporali accurate, ma è anche necessario implementare il codice di temporizzazione in modo da evitare i problemi associati all'uso di RDTSC.</span><span class="sxs-lookup"><span data-stu-id="aea26-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="aea26-129">Quando si implementa la temporizzazione ad alta risoluzione, seguire questa procedura:</span><span class="sxs-lookup"><span data-stu-id="aea26-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="aea26-130">Usare [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) anziché RDTSC.</span><span class="sxs-lookup"><span data-stu-id="aea26-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="aea26-131">Queste API possono usare RDTSC, ma possono invece usare un dispositivo di temporizzazione sulla scheda madre o altri servizi di sistema che forniscono informazioni sui tempi di risoluzione elevata di alta qualità.</span><span class="sxs-lookup"><span data-stu-id="aea26-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="aea26-132">Mentre RDTSC è molto più veloce di **QueryPerformanceCounter**, poiché quest'ultima è una chiamata API, è un'API che può essere chiamata diverse centinaia di volte per fotogramma senza alcun effetto evidente.</span><span class="sxs-lookup"><span data-stu-id="aea26-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="aea26-133">Tuttavia, gli sviluppatori devono provare a fare in modo che i loro giochi chiamino **QueryPerformanceCounter** il minor possibile per evitare qualsiasi riduzione delle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="aea26-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="aea26-134">Quando si calcolano i Delta, i valori devono essere fissati per garantire che eventuali bug nei valori temporali non causino arresti anomali o calcoli instabili correlati al tempo.</span><span class="sxs-lookup"><span data-stu-id="aea26-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="aea26-135">L'intervallo del morsetto deve essere compreso tra 0 (per evitare valori Delta negativi) e un valore ragionevole in base al framerate minimo previsto.</span><span class="sxs-lookup"><span data-stu-id="aea26-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="aea26-136">È probabile che il blocco sia utile per qualsiasi operazione di debug dell'applicazione, ma tenere presente che se si esegue l'analisi delle prestazioni o si esegue il gioco in modalità non ottimizzata.</span><span class="sxs-lookup"><span data-stu-id="aea26-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="aea26-137">Calcola tutte le tempistiche in un singolo thread.</span><span class="sxs-lookup"><span data-stu-id="aea26-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="aea26-138">Calcolo dell'intervallo di tempo su più thread, ad esempio con ogni thread associato a un processore specifico, riduce notevolmente le prestazioni dei sistemi multicore.</span><span class="sxs-lookup"><span data-stu-id="aea26-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="aea26-139">Impostare il singolo thread in modo che rimanga in un singolo processore usando l'API Windows [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span><span class="sxs-lookup"><span data-stu-id="aea26-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="aea26-140">In genere, si tratta del thread del gioco principale.</span><span class="sxs-lookup"><span data-stu-id="aea26-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="aea26-141">Sebbene [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) e [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) in genere si modifichino per più processori, i bug nel BIOS o nei driver possono comportare la restituzione di valori diversi quando il thread passa da un processore a un altro.</span><span class="sxs-lookup"><span data-stu-id="aea26-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="aea26-142">Quindi, è preferibile che il thread venga mantenuto su un singolo processore.</span><span class="sxs-lookup"><span data-stu-id="aea26-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="aea26-143">Tutti gli altri thread dovrebbero funzionare senza raccogliere i propri dati del timer.</span><span class="sxs-lookup"><span data-stu-id="aea26-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="aea26-144">Non è consigliabile usare un thread di lavoro per calcolare la tempistica, perché questo diventerà un collo di bottiglia di sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="aea26-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="aea26-145">Al contrario, i thread di lavoro devono leggere i timestamp dal thread principale e, poiché i thread di lavoro leggono solo i timestamp, non è necessario usare sezioni critiche.</span><span class="sxs-lookup"><span data-stu-id="aea26-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="aea26-146">Chiamare [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) solo una volta, perché la frequenza non verrà modificata mentre il sistema è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="aea26-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="aea26-147">Compatibilità delle applicazioni</span><span class="sxs-lookup"><span data-stu-id="aea26-147">Application Compatibility</span></span>

<span data-ttu-id="aea26-148">Molti sviluppatori hanno ipotizzato il comportamento di RDTSC in molti anni, quindi è molto probabile che alcune applicazioni esistenti mostrino problemi quando vengono eseguite in un sistema con più processori o core a causa dell'implementazione temporizzata.</span><span class="sxs-lookup"><span data-stu-id="aea26-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="aea26-149">Questi problemi si manifesteranno in genere come glitch o movimenti lenti.</span><span class="sxs-lookup"><span data-stu-id="aea26-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="aea26-150">Non esiste un rimedio facile per le applicazioni che non sono a conoscenza del risparmio energia, ma esiste uno shim esistente per forzare l'esecuzione sempre di un'applicazione su un singolo processore in un sistema multiprocessore.</span><span class="sxs-lookup"><span data-stu-id="aea26-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="aea26-151">Per creare questo shim, scaricare Microsoft Application Compatibility Toolkit dalla pagina relativa alla [compatibilità delle applicazioni Windows](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span><span class="sxs-lookup"><span data-stu-id="aea26-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="aea26-152">Utilizzando Compatibility Administrator, parte del Toolkit, creare un database dell'applicazione e le correzioni associate.</span><span class="sxs-lookup"><span data-stu-id="aea26-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="aea26-153">Creare una nuova modalità di compatibilità per il database e selezionare la correzione per la compatibilità **SingleProcAffinity** per forzare l'esecuzione di tutti i thread dell'applicazione in un singolo processore/Core.</span><span class="sxs-lookup"><span data-stu-id="aea26-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="aea26-154">Utilizzando lo strumento da riga di comando Fixpack.exe (anche parte del Toolkit), è possibile convertire il database in un pacchetto installabile per l'installazione, il testing e la distribuzione.</span><span class="sxs-lookup"><span data-stu-id="aea26-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="aea26-155">Per istruzioni sull'uso di Compatibility Administrator, vedere la documentazione del Toolkit.</span><span class="sxs-lookup"><span data-stu-id="aea26-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="aea26-156">Per la sintassi per ed esempi sull'uso di Fixpack.exe, vedere la guida della riga di comando.</span><span class="sxs-lookup"><span data-stu-id="aea26-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="aea26-157">Per informazioni orientate ai clienti, vedere gli articoli della Knowledge base seguenti di guida e supporto tecnico Microsoft:</span><span class="sxs-lookup"><span data-stu-id="aea26-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="aea26-158">[Programmi che l'utente può eseguire in Windows Server 2003 e Windows XP](https://support.microsoft.com/kb/895980) (articolo 895980).</span><span class="sxs-lookup"><span data-stu-id="aea26-158">[Programs that user the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="aea26-159">Le [prestazioni del gioco potrebbero essere insufficienti in un computer basato su Windows XP che usa un processore dual-core](https://support.microsoft.com/kb/909944) (articolo 909944)</span><span class="sxs-lookup"><span data-stu-id="aea26-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 