---
description: Specifica operativa di accelerazione video DirectX IAMVideoAccelerator
ms.assetid: 25ee05d5-8554-4739-9122-e3c0255bf965
title: Specifica operativa di accelerazione video DirectX IAMVideoAccelerator
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3360e18e91197f2a15a36fb112f0419b6382e915
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/06/2021
ms.locfileid: "103965481"
---
# <a name="directx-video-acceleration-iamvideoaccelerator-operational-specification"></a>Specifica operativa di accelerazione video DirectX IAMVideoAccelerator

Il meccanismo preciso di funzionamento è il seguente:

1.  A ogni profilo in modalità limitata definito nel presente documento è associato un GUID di DirectX VA che può essere supportato da un pin di input downstream [**Ipin:: QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) e [**Ipin:: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) ed elencato in [**IAMVideoAccelerator:: GetVideoAcceleratorGUIDs**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids).
2.  Analogamente, ogni tipo di protocollo di crittografia per l'uso con DirectX VA deve avere un GUID di tipo protocollo di crittografia associato che può essere supportato da un pin di input downstream [**Ipin:: QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) e [**Ipin:: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) ed elencato in **IAMVideoAccelerator:: GetVideoAcceleratorGUIDs**. Il GUID "No Encryption" DXVA \_ non deve essere inviato in questo elenco, in quanto il supporto per esso è obbligatorio e pertanto implicito.
3.  Dopo la chiamata di [**Ipin:: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) per tentare una connessione al pin di input downstream, [**IAMVideoAcceleratorNotify:: GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) del decodificatore deve restituire un puntatore a una \_ struttura di dati DXVA connectMode contenente le informazioni sulla modalità di connessione per la connessione. [**IAMVideoAccelerator:: GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo) deve essere chiamato con \* pdwNumTypesCompBuffers = 16 e deve restituire informazioni sul buffer compresso in base alla convenzione che il numero di tipo di ogni buffer (come definito nella sezione 3,4 della specifica DirectX VA) può essere usato direttamente come indice in base zero nella matrice di strutture di dati **AMVACompBufferInfo** restituite. Questa operazione richiede che per tutti i tipi di buffer che non verranno utilizzati (incluso il tipo di buffer 0, poiché non esiste un utilizzo definito di tale tipo di buffer), il driver Accelerator fornirà le strutture di dati AMVACompBufferInfo con una forma di valori di parametro "fittizio", ad esempio dwNumCompBuffers = 0, dwWidthToCreate = 0, dwHeightToCreate = 0 e dwBytesToAllocate = 0.
4.  Le indicazioni della funzione DXVA e i buffer di dati associati vengono inviati tramite [**IAMVideoAccelerator:: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). La funzione DXVA è indicata nel parametro dwFunction della chiamata. Le uniche funzioni DXVA che sono rilevanti per l'inizializzazione sono DXVA \_ ConfigQueryOrReplyFunc e DXVA \_ EncryptProtocolFunc.
    -   Se dwFunction contiene un \_ CONFIGQUERYORREPLYFUNC DXVA, il puntatore lpPrivateInputData per passare i dati all'acceleratore in questa chiamata deve puntare a una struttura di dati di configurazione, il puntatore lpPrivateOutputData per la ricezione di informazioni dall'acceleratore deve puntare a un'area in cui è possibile collocare una struttura di dati di configurazione alternativa o duplicata, il puntatore pamvaBufferInfo per una matrice di AMVABUFFERINFO deve essere **null** e dwNumBuffers deve essere zero. Il valore HRESULT restituito contiene l' \_ indicazione s OK o s \_ false oppure e \_ non riesce o e \_ INVALIDARG o un'altra indicazione di errore HRESULT nel caso di un problema grave nell'esecuzione del protocollo, ad esempio un parametro di configurazione non valido. Tutte le chiamate a **IAMVideoAccelerator:: Execute** per tutti gli usi di DXVA \_ ConfigQueryOrReplyFunc devono precedere tutte le altre chiamate a **IAMVideoAccelerator:: Execute**.
    -   Se dwFunction contiene un \_ ENCRYPTPROTOCOLFUNC DXVA, il puntatore lpPrivateInputData per il passaggio dei dati all'acceleratore in questa chiamata deve puntare a una struttura di dati del protocollo di crittografia che inizia con DXVA \_ EncryptProtocolHeader, il puntatore lpPrivateOutputData per la ricezione di informazioni dall'acceleratore deve puntare a un'area in cui i dati da restituire, ad esempio un certificato, dal protocollo di crittografia (che inizierà con DXVA \_ EncryptProtocolHeader) possono essere inseriti, il puntatore pamvaBufferInfo per una matrice di AMVABUFFERINFO deve essere **null** e dwNumBuffers deve essere zero. Il valore HRESULT restituito contiene S OK fino a quando \_ il protocollo di crittografia funziona normalmente e contiene e \_ non riesce o e \_ INVALIDARG o un'altra indicazione di errore HRESULT nel caso di un problema grave nell'esecuzione del protocollo.

        Dopo l'inizializzazione dell'operazione nel modo precedente, l'operazione effettiva del decodificatore procede come segue:

5.  **IAMVideoAccelerator:: BeginFrame** deve essere chiamato prima di inviare qualsiasi bDXVA \_ Func con i parametri del buffer compressi che provocano Scritture in una superficie di destinazione non compressa. Lo scopo di [**IAMVideoAccelerator:: BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) in DirectX va è associare le aree di destinazione ai valori di indice e inviare una notifica al driver dell'acceleratore video dell'intento di avviare la scrittura di una superficie, in modo che il driver possa rispondere indicando se la superficie è pronta per la sovrascrittura. La struttura **AMVABeginFrameInfo** passata in **IAMVideoAccelerator:: BeginFrame** deve contenere un puntatore PINPUTDATA al parametro Single Word wBeginPictureIndex corrispondente all'indice del frame passato in **IAMVideoAccelerator:: BeginFrame** (e dwSizeInputData sarà 2). Si tratta dell'indice da usare in un buffer compresso per eseguire il comando di scrittura sull'area (ad esempio, da usare come wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex). Ogni chiamata a **IAMVideoAccelerator:: BeginFrame** deve essere abbinata a una chiamata corrispondente a [**IAMVideoAccelerator:: EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) come descritto di seguito. Se, ad esempio, un'immagine compressa deve essere decodificata e quindi alpha blended using front-end buffer-to-buffer blending con un'immagine grafica, è presente una chiamata a **IAMVideoAccelerator:: BeginFrame** prima di decodificare l'immagine compressa in una superficie specificata in wDecodedPictureIndex, quindi una chiamata a **IAMVideoAccelerator:: EndFrame** dopo aver passato tutti i buffer compressi usati per decodificare l'immagine, quindi una seconda chiamata a **IAMVideoAccelerator:: BeginFrame** prima di eseguire il comando della combinazione di fusione alfa della sorgente grafica con l'immagine decodificata in una superficie specificata in wBlendedDestinationIndex e quindi una seconda chiamata a **IAMVideoAccelerator:: EndFrame** dopo l'operazione di combinazione di Alpha Blend. Il puntatore pOutputData in AMVABeginFrameInfo deve essere **null** (e dwSizeOutputData deve essere "0"). Il valore HRESULT restituito da **IAMVideoAccelerator:: BeginFrame** deve essere:
    -   S \_ OK se la superficie non compressa è disponibile e pronta per l'uso.
    -   E \_ in sospeso se la superficie non compressa non è ancora disponibile per l'uso, ma diventerà disponibile a breve (se la superficie non compressa viene letta per la visualizzazione e la lettura/visualizzazione della superficie non è ancora stata completata).
    -   E \_ non riescono o e \_ INVALIDARG un'altra indicazione di errore solo se viene rilevato un errore di protocollo o formato dati, ad esempio un valore non corretto di dwSizeInputData o un POutputData non **null** .
6.  Le indicazioni della funzione DXVA e i buffer di dati associati vengono inviati tramite **IAMVideoAccelerator:: Execute**. \_Nella stessa chiamata a [**IAMVideoAccelerator:: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute)è possibile indicare più di un valore bDXVA Func. I \_ valori bDXVA Func verranno compressi nel parametro dwFunction della chiamata, con il primo comando Function negli otto MSBS, il comando successivo nei successivi otto bit e così via, con eventuali bit rimanenti con zeri. Il valore 0xFF per bDXVA \_ Func indica che bDXVA \_ Func è esteso a due o quattro byte. Se anche il secondo byte è 0xFF, questo indica che bDXVA \_ Func è esteso a quattro byte. Se i quattro bit superiori del terzo byte sono 0xF o 0x0, questo indica che bDXVA \_ Func contiene un DXVA \_ CONFIGQUERYORREPLYFUNC o DXVA \_ EncryptProtocolFunc. I comandi a più byte non devono indicare la continuazione oltre la fine di dwFunction. È necessario prestare attenzione al decodificatore per assicurarsi che non siano presenti dipendenze sequenziali tra \_ i diversi valori bDXVA Func specificati nella stessa chiamata a **IAMVideoAccelerator:: eseguire** e che tutte le potenziali race condition, ad esempio tra la decodifica delle immagini e la fusione di immagini secondarie, tra il caricamento dell'immagine secondaria e la fusione di immagini secondarie e così via, vengono impedite dalle chiamate appropriate a **IAMVideoAccelerator:: BeginFrame** e [**IAMVideoAccelerator:: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) prima delle chiamate successive a **IAMVideoAccelerator:: Execute**.
    -   Se dwFunction contiene un \_ CONFIGQUERYORREPLYFUNC DXVA, il puntatore lpPrivateInputData per passare i dati all'acceleratore in questa chiamata deve puntare a una struttura di dati di configurazione, il puntatore lpPrivateOutputData per la ricezione di informazioni dall'acceleratore deve puntare a un'area in cui è possibile collocare una struttura di dati di configurazione alternativa o duplicata, il puntatore pamvaBufferInfo per una matrice di AMVABUFFERINFO deve essere **null** e dwNumBuffers deve essere zero. Il valore HRESULT restituito contiene l' \_ indicazione s OK o s \_ false in risposta alla query oppure e \_ non riesce o e \_ INVALIDARG altre indicazioni di errore HRESULT nel caso di un problema grave nell'esecuzione del protocollo, ad esempio un invalid.configparametro uration. Tutte le chiamate a **IAMVideoAccelerator:: Execute** per tutti gli usi di DXVA \_ ConfigQueryOrReplyFunc devono precedere tutte le altre chiamate a **IAMVideoAccelerator:: Execute**.
    -   Se dwFunction contiene un \_ ENCRYPTPROTOCOLFUNC DXVA, il puntatore lpPrivateInputData per il passaggio dei dati all'acceleratore in questa chiamata deve puntare a una struttura di dati del protocollo di crittografia che inizia con DXVA \_ EncryptProtocolHeader, il puntatore lpPrivateOutputData per la ricezione di informazioni dall'acceleratore deve puntare a un'area in cui i dati da restituire, ad esempio un certificato, dal protocollo di crittografia (che inizierà con DXVA \_ EncryptProtocolHeader) possono essere inseriti, il puntatore pamvaBufferInfo per una matrice di AMVABUFFERINFO deve essere **null** e dwNumBuffers deve essere zero. Il valore HRESULT restituito contiene S OK fino a quando \_ il protocollo di crittografia funziona normalmente e contiene e \_ non riesce o e \_ INVALIDARG o un'altra indicazione di errore HRESULT nel caso di un problema grave nell'esecuzione del protocollo.
    -   Se dwFunction non contiene un DXVA \_ ConfigQueryOrReplyFunc o DXVA \_ EncryptProtocolFunc, il puntatore lpPrivateInputData per il passaggio dei dati all'acceleratore deve puntare a un elenco di descrizioni del buffer. Le prime quattro voci nella struttura dell'elenco di descrizioni del buffer per ogni buffer (dwTypeIndex, dwBufferIndex, dwDataOffset e dwDataSize) devono essere uguali a quelle nella struttura dei dati AMVABUFFERINFO per lo stesso buffer. Se bDXVA \_ Func è uguale a "1" viene specificato in dwFunction e bPicReadbackRequests è "1", il puntatore lpPrivateOutputData per la ricezione di informazioni dall'acceleratore deve puntare a un'area della memoria persistente, ad esempio un heap, da compilare con i dati macroblocco di lettura del tasto di scelta rapida (tali dati non sono garantiti fino a quando **IAMVideoAccelerator:: QueryRenderStatus** per la scrittura nello stesso buffer di parametri immagine indica \_ OK come descritto nell'elemento 10 riportato di seguito). In caso contrario, il puntatore lpPrivateOutputData per la ricezione di informazioni dall'acceleratore deve puntare a un singolo valore DWORD da impostare su uno dei valori indicati di seguito (particolarmente utile per la segnalazione degli errori Bitstream nell'operazione VLD all'esterno dell'host).

        | Valore | Descrizione                                     |
        |-------|-------------------------------------------------|
        | 0     | Esecuzione OK.                                   |
        | 1     | Si è verificato un problema minore nel formato dati.       |
        | 2     | Si è verificato un problema significativo nel formato dati. |
        | 3     | Si è verificato un problema grave nel formato dati.      |
        | 4     | Si è verificato un altro problema grave.               |

        

         

        Se viene indicato un tipo di problema "grave", il decodificatore software deve smettere di funzionare con le funzioni a meno che non sia possibile eseguire un'azione correttiva. Questi dati restituiti dall'acceleratore non devono essere letti dall'host fino al completamento del rendering del buffer per l'immagine, come può essere testato da [**IAMVideoAccelerator:: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus). Il valore HRESULT restituito contiene S OK fino a quando \_ l'operazione di interfaccia funziona normalmente e può restituire \_ \_ un errore o un INVALIDARG o un altro valore HRESULT di errore nel caso di un problema grave.

7.  Il buffer dei parametri di decodifica delle immagini deve essere tra i primi buffer inviati per la decodifica di ogni immagine quando si usa [**IAMVideoAccelerator:: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) con bDXVA \_ Func uguale a "1" e tutti i buffer per la decodifica di un'immagine in un bitstream verranno inviati prima di tutti i buffer per la decodifica delle immagini successive. Se viene inviato un buffer del comando di controllo macroblocco, viene inviato un buffer dei dati della differenza residua corrispondente (contenente i dati per lo stesso macroblocchi) con la stessa chiamata a **IAMVideoAccelerator:: Execute** .
8.  [**IAMVideoAccelerator:: EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) deve essere chiamato dopo l'invio di tutti i buffer compressi che comporteranno la creazione del contenuto di output in una superficie non compressa specificata, ovvero il risultato delle operazioni specificate per WDecodedPictureIndex, WDeblockedPictureIndex, WBlendedDestinationIndex o wPicResampleDestPicIndex. Lo scopo di questa chiamata a **IAMVideoAccelerator:: EndFrame** è notificare all'hardware del acceleratore video che tutti i dati necessari per l'operazione specificata sono stati inviati. Il puntatore ai dati da inviare a valle tramite **IAMVideoAccelerator:: EndFrame** deve puntare a una singola parola wEndPictureIndex che contiene l'indice del frame che sta terminando. Questo parametro deve corrispondere al valore wBeginPictureIndex specificato nella chiamata precedente a [**IAMVideoAccelerator:: BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) prima dell'invio dei buffer compressi pertinenti. Successivamente a una chiamata a **IAMVideoAccelerator:: EndFrame**, la superficie non compressa con indice wEndPictureIndex non verrà trovata nei WDecodedPictureIndex, WDeblockedPictureIndex, WBlendedDestinationIndex o wPicResampleDestPicIndex di un'immagine, fino a quando non viene eseguita un'altra chiamata a **IAMVideoAccelerator:: BeginFrame** per annunciare che questa situazione si verificherà ed è \_ stata restituita una funzione s OK. Tuttavia, l'indice della superficie di destinazione può verificarsi nei comandi di accesso in lettura successivi, ad esempio wForwardRefPictureIndex, wBackwardRefPictureIndex, wPicResampleSourcePicIndex o bRefPicSelect \[ i \] . Il valore HRESULT restituito da **IAMVideoAccelerator:: EndFrame** deve essere S \_ OK, a meno che non esista un tipo di formato dati o di errore di protocollo, nel qual caso può essere e \_ non superato oppure e \_ INVALIDARG o un'altra indicazione di errore.
9.  Nel caso della decodifica basata su campi (ad esempio, in un flusso di bit MPEG-2) non sarà presente un mapping uno-a-uno delle immagini funzionali del Bitstream alle superfici non compresse nell'interfaccia dell'acceleratore. Quando si decodifica le immagini del campo in un bitstream MPEG-2, saranno presenti due "immagini" decodificate per produrre una superficie di output completa non compressa. Nella definizione dell'interfaccia di DirectX VA ogni frame corrisponde a ogni uso di wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex. Sono pertanto necessarie due coppie di chiamate a **IAMVideoAccelerator:: BeginFrame** e **IAMVideoAccelerator:: EndFrame** per la decodifica delle immagini dei campi in superfici non compresse di output.
10. Una chiamata a [**IAMVideoAccelerator:: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) con dwFlags uguale a zero che si verifica talvolta dopo una chiamata a **IAMVideoAccelerator:: EndFrame** con un determinato wEndPictureIndex e controlla lo stato di un buffer inviato che conteneva WEndPictureIndex in WDecodedPictureIndex, WDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex restituirà un'indicazione S \_ OK se tutte le operazioni di scrittura dei dati nella superficie non compressa sono state completate e restituiranno e \_ in sospeso se l'operazione non è stata ancora completata. E \_ non riescono o e \_ INVALIDARG o è possibile che venga restituita un'altra indicazione di errore in caso di errore del protocollo.

## <a name="related-topics"></a>Argomenti correlati

<dl> <dt>

[Mapping dell'accelerazione video DirectX a IAMVideoAccelerator](mapping-directx-video-acceleration-to-iamvideoaccelerator.md)
</dt> </dl>

 

 



