---
description: Il flusso e i thread dell'applicazione
ms.assetid: 954f7abd-fe06-430a-b6f7-d60852826bc9
title: Il flusso e i thread dell'applicazione
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 432e613ff0322377c042e796d84ef7affdda99c2
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "104530246"
---
# <a name="the-streaming-and-application-threads"></a><span data-ttu-id="6810e-103">Il flusso e i thread dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="6810e-103">The Streaming and Application Threads</span></span>

<span data-ttu-id="6810e-104">Qualsiasi applicazione DirectShow contiene almeno due thread importanti: il thread dell'applicazione e uno o più thread di streaming.</span><span class="sxs-lookup"><span data-stu-id="6810e-104">Any DirectShow application contains at least two important threads: the application thread, and one or more streaming threads.</span></span> <span data-ttu-id="6810e-105">Gli esempi vengono distribuiti nei thread di streaming e le modifiche di stato avvengono nel thread dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="6810e-105">Samples are delivered on the streaming threads, and state changes happen on the application thread.</span></span> <span data-ttu-id="6810e-106">Il thread di streaming principale viene creato da un filtro di origine o di parser.</span><span class="sxs-lookup"><span data-stu-id="6810e-106">The main streaming thread is created by a source or parser filter.</span></span> <span data-ttu-id="6810e-107">Altri filtri possono creare thread di lavoro che forniscono esempi e sono considerati anche thread di streaming.</span><span class="sxs-lookup"><span data-stu-id="6810e-107">Other filters might create worker threads that deliver samples, and these are considered streaming threads as well.</span></span>

<span data-ttu-id="6810e-108">Alcuni metodi vengono chiamati sul thread dell'applicazione, mentre altri vengono chiamati su un thread di streaming.</span><span class="sxs-lookup"><span data-stu-id="6810e-108">Some methods are called on the application thread, while others are called on a streaming thread.</span></span> <span data-ttu-id="6810e-109">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="6810e-109">For example:</span></span>

-   <span data-ttu-id="6810e-110">Thread di streaming: [**IMemInputPin:: Receive**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receive), [**IMemInputPin:: ReceiveMultiple**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivemultiple), [**Ipin:: EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream), [**IMemAllocator:: GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer).</span><span class="sxs-lookup"><span data-stu-id="6810e-110">Streaming thread(s): [**IMemInputPin::Receive**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receive), [**IMemInputPin::ReceiveMultiple**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivemultiple), [**IPin::EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream), [**IMemAllocator::GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer).</span></span>
-   <span data-ttu-id="6810e-111">Thread applicazione: [**IMediaFilter::P ause**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-pause), [**IMediaFilter:: Run**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-run), [**IMediaFilter:: Stop**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-stop), [**IMediaSeeking:: sepositions**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-setpositions), [**Ipin:: BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush), [**Ipin:: EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush).</span><span class="sxs-lookup"><span data-stu-id="6810e-111">Application thread: [**IMediaFilter::Pause**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-pause), [**IMediaFilter::Run**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-run), [**IMediaFilter::Stop**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-stop), [**IMediaSeeking::SetPositions**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-setpositions), [**IPin::BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush), [**IPin::EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush).</span></span>
-   <span data-ttu-id="6810e-112">Eseguire una delle operazioni seguenti: [**Ipin:: NewSegment**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment).</span><span class="sxs-lookup"><span data-stu-id="6810e-112">Either: [**IPin::NewSegment**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment).</span></span>

<span data-ttu-id="6810e-113">Avere un thread di streaming separato consente ai dati di passare attraverso il grafo mentre il thread dell'applicazione è in attesa dell'input dell'utente.</span><span class="sxs-lookup"><span data-stu-id="6810e-113">Having a separate streaming thread allows data to flow through the graph while the application thread waits for user input.</span></span> <span data-ttu-id="6810e-114">Il pericolo di più thread, tuttavia, è che un filtro può creare risorse durante la sospensione (sul thread dell'applicazione), usarle all'interno di un metodo di flusso ed eliminarle quando si arresta (anche sul thread dell'applicazione).</span><span class="sxs-lookup"><span data-stu-id="6810e-114">The danger of multiple threads, however, is that a filter may create resources when it pauses (on the application thread), use them inside a streaming method, and destroy them when it stops (also on the application thread).</span></span> <span data-ttu-id="6810e-115">Se non si presta attenzione, il thread di streaming potrebbe provare a usare le risorse dopo che sono state eliminate definitivamente.</span><span class="sxs-lookup"><span data-stu-id="6810e-115">If you are not careful, the streaming thread might try to use the resources after they are destroyed.</span></span> <span data-ttu-id="6810e-116">La soluzione consiste nel proteggere le risorse usando sezioni critiche e sincronizzare i metodi di streaming con le modifiche di stato.</span><span class="sxs-lookup"><span data-stu-id="6810e-116">The solution is to protect resources using critical sections, and synchronize streaming methods with state changes.</span></span>

<span data-ttu-id="6810e-117">Per proteggere lo stato del filtro, un filtro necessita di una sezione critica.</span><span class="sxs-lookup"><span data-stu-id="6810e-117">A filter needs one critical section to protect the filter state.</span></span> <span data-ttu-id="6810e-118">La classe [**CBaseFilter**](cbasefilter.md) ha una variabile membro per questa sezione critica, [**CBaseFilter:: m \_ pLock**](cbasefilter-m-plock.md).</span><span class="sxs-lookup"><span data-stu-id="6810e-118">The [**CBaseFilter**](cbasefilter.md) class has a member variable for this critical section, [**CBaseFilter::m\_pLock**](cbasefilter-m-plock.md).</span></span> <span data-ttu-id="6810e-119">Questa sezione critica è denominata blocco del filtro.</span><span class="sxs-lookup"><span data-stu-id="6810e-119">This critical section is called the filter lock.</span></span> <span data-ttu-id="6810e-120">Ogni pin di input necessita inoltre di una sezione critica per proteggere le risorse usate dal thread di streaming.</span><span class="sxs-lookup"><span data-stu-id="6810e-120">Also, each input pin needs a critical section to protect resources used by the streaming thread.</span></span> <span data-ttu-id="6810e-121">Queste sezioni critiche sono denominate blocchi di streaming. è necessario dichiararli nella classe del pin derivato.</span><span class="sxs-lookup"><span data-stu-id="6810e-121">These critical sections are called streaming locks; you must declare them in your derived pin class.</span></span> <span data-ttu-id="6810e-122">È più semplice usare la classe [**CCritSec**](ccritsec.md) , che esegue il wrapping di un **oggetto \_ sezione critica** di Windows e può essere bloccata usando la classe [**CAutoLock**](cautolock.md) .</span><span class="sxs-lookup"><span data-stu-id="6810e-122">It is easiest to use the [**CCritSec**](ccritsec.md) class, which wraps a Windows **CRITICAL\_SECTION** object and can be locked using the [**CAutoLock**](cautolock.md) class.</span></span> <span data-ttu-id="6810e-123">La classe **CCritSec** fornisce anche alcune utili funzioni di debug.</span><span class="sxs-lookup"><span data-stu-id="6810e-123">The **CCritSec** class also provides some useful debugging functions.</span></span> <span data-ttu-id="6810e-124">Per ulteriori informazioni, vedere la [sezione critica funzioni di debug](critical-section-debugging-functions.md).</span><span class="sxs-lookup"><span data-stu-id="6810e-124">For more information, see [Critical Section Debugging Functions](critical-section-debugging-functions.md).</span></span>

<span data-ttu-id="6810e-125">Quando un filtro viene arrestato o scaricato, deve sincronizzare il thread dell'applicazione con il thread di streaming.</span><span class="sxs-lookup"><span data-stu-id="6810e-125">When a filter stops or flushes, it must synchronize the application thread with the streaming thread.</span></span> <span data-ttu-id="6810e-126">Per evitare il deadlock, è necessario prima sbloccare il thread di streaming, che potrebbe essere bloccato per diversi motivi:</span><span class="sxs-lookup"><span data-stu-id="6810e-126">To avoid deadlocking, it must first unblock the streaming thread, which might be blocked for several reasons:</span></span>

-   <span data-ttu-id="6810e-127">È in attesa di ottenere un esempio all'interno del metodo [**IMemAllocator:: GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer) , perché sono in uso tutti gli esempi dell'allocatore.</span><span class="sxs-lookup"><span data-stu-id="6810e-127">It is waiting to get a sample inside the [**IMemAllocator::GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer) method, because all of the allocator's samples are in use.</span></span>
-   <span data-ttu-id="6810e-128">È in attesa della restituzione di un altro filtro da un metodo di streaming, ad esempio **Receive**.</span><span class="sxs-lookup"><span data-stu-id="6810e-128">It is waiting for another filter to return from a streaming method, such as **Receive**.</span></span>
-   <span data-ttu-id="6810e-129">È in attesa all'interno di uno dei propri metodi di streaming, per rendere disponibile una risorsa.</span><span class="sxs-lookup"><span data-stu-id="6810e-129">It is waiting inside one of its own streaming methods, for some resource to become available.</span></span>
-   <span data-ttu-id="6810e-130">Si tratta di un filtro renderer in attesa dell'ora di presentazione dell'esempio successivo</span><span class="sxs-lookup"><span data-stu-id="6810e-130">It is a renderer filter waiting for the presentation time of the next sample</span></span>
-   <span data-ttu-id="6810e-131">Si tratta di un filtro renderer in attesa all'interno del metodo **Receive** mentre è in pausa.</span><span class="sxs-lookup"><span data-stu-id="6810e-131">It is a renderer filter waiting inside the **Receive** method while paused.</span></span>

<span data-ttu-id="6810e-132">Pertanto, quando il filtro viene arrestato o scaricato, deve eseguire le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="6810e-132">Therefore, when the filter stops or flushes, it must do the following:</span></span>

-   <span data-ttu-id="6810e-133">Rilasciare qualsiasi esempio che contiene per qualsiasi motivo.</span><span class="sxs-lookup"><span data-stu-id="6810e-133">Release any sample it is holding for any reason.</span></span> <span data-ttu-id="6810e-134">Questa operazione sblocca il metodo **GetBuffer** .</span><span class="sxs-lookup"><span data-stu-id="6810e-134">Doing so unblocks the **GetBuffer** method.</span></span>
-   <span data-ttu-id="6810e-135">Tornare da qualsiasi metodo di streaming il più rapidamente possibile.</span><span class="sxs-lookup"><span data-stu-id="6810e-135">Return from any streaming method as quickly as possible.</span></span> <span data-ttu-id="6810e-136">Se un metodo di streaming è in attesa di una risorsa, è necessario arrestare immediatamente l'attesa.</span><span class="sxs-lookup"><span data-stu-id="6810e-136">If a streaming method is waiting for a resource, it must stop waiting immediately.</span></span>
-   <span data-ttu-id="6810e-137">Avviare il rifiuto degli esempi nella **ricezione**, in modo che il thread di streaming non acceda ad altre risorse.</span><span class="sxs-lookup"><span data-stu-id="6810e-137">Start rejecting samples in **Receive**, so that the streaming thread does not access any more resources.</span></span> <span data-ttu-id="6810e-138">La classe [**CBaseInputPin**](cbaseinputpin.md) gestisce automaticamente questa operazione.</span><span class="sxs-lookup"><span data-stu-id="6810e-138">(The [**CBaseInputPin**](cbaseinputpin.md) class handles this automatically.)</span></span>
-   <span data-ttu-id="6810e-139">Il metodo **Stop** deve eseguire il commit di tutti gli allocatori del filtro.</span><span class="sxs-lookup"><span data-stu-id="6810e-139">The **Stop** method must decommit all of the filter's allocators.</span></span> <span data-ttu-id="6810e-140">La classe **CBaseInputPin** gestisce automaticamente questa operazione.</span><span class="sxs-lookup"><span data-stu-id="6810e-140">(The **CBaseInputPin** class handles this automatically.)</span></span>

<span data-ttu-id="6810e-141">Lo scaricamento e l'arresto di entrambi si verificano nel thread dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="6810e-141">Flushing and stopping both happen on the application thread.</span></span> <span data-ttu-id="6810e-142">Un filtro si interrompe in risposta al metodo [**IMediaControl:: Stop**](/windows/desktop/api/Control/nf-control-imediacontrol-stop) .</span><span class="sxs-lookup"><span data-stu-id="6810e-142">A filter stops in response to the [**IMediaControl::Stop**](/windows/desktop/api/Control/nf-control-imediacontrol-stop) method.</span></span> <span data-ttu-id="6810e-143">Filter Graph Manager rilascia il comando stop nell'ordine upstream, a partire dai renderer e procedendo a ritroso con i filtri di origine.</span><span class="sxs-lookup"><span data-stu-id="6810e-143">The Filter Graph Manager issues the stop command in upstream order, starting from the renderers and working backward to the source filters.</span></span> <span data-ttu-id="6810e-144">Il comando Stop si verifica completamente all'interno del metodo **CBaseFilter:: Stop** del filtro.</span><span class="sxs-lookup"><span data-stu-id="6810e-144">The stop command happens completely inside the filter's **CBaseFilter::Stop** method.</span></span> <span data-ttu-id="6810e-145">Quando il metodo viene restituito, il filtro deve trovarsi nello stato interrotto.</span><span class="sxs-lookup"><span data-stu-id="6810e-145">When the method returns, the filter should be in a stopped state.</span></span>

<span data-ttu-id="6810e-146">Lo scaricamento in genere si verifica a causa di un comando seek.</span><span class="sxs-lookup"><span data-stu-id="6810e-146">Flushing typically occurs because of a seek command.</span></span> <span data-ttu-id="6810e-147">Un comando di scaricamento viene avviato dal filtro di origine o del parser e viaggia a valle.</span><span class="sxs-lookup"><span data-stu-id="6810e-147">A flush command starts from the source or parser filter, and travels downstream.</span></span> <span data-ttu-id="6810e-148">Lo svuotamento avviene in due fasi: il metodo [**Ipin:: BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) informa un filtro per eliminare tutti i dati in sospeso e in arrivo. il metodo [**Ipin:: EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) segnala al filtro di accettare nuovamente i dati.</span><span class="sxs-lookup"><span data-stu-id="6810e-148">Flushing happens in two stages: The [**IPin::BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) method informs a filter to discard all pending and incoming data; the [**IPin::EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) method signals the filter to accept data again.</span></span> <span data-ttu-id="6810e-149">Lo svuotamento richiede due fasi perché la chiamata **BeginFlush** si trova nel thread dell'applicazione, durante il quale il thread di streaming continua a recapitare i dati.</span><span class="sxs-lookup"><span data-stu-id="6810e-149">Flushing requires two stages because the **BeginFlush** call is on the application thread, during which the streaming thread continues to deliver data.</span></span> <span data-ttu-id="6810e-150">Alcuni esempi possono pertanto arrivare dopo la chiamata a **BeginFlush** .</span><span class="sxs-lookup"><span data-stu-id="6810e-150">Therefore, some samples may arrive after the **BeginFlush** call.</span></span> <span data-ttu-id="6810e-151">Il filtro deve rimuovere questi.</span><span class="sxs-lookup"><span data-stu-id="6810e-151">The filter should discard these.</span></span> <span data-ttu-id="6810e-152">Tutti gli esempi che arrivano dopo la chiamata a **EndFlush** sono sicuramente nuovi e devono essere recapitati.</span><span class="sxs-lookup"><span data-stu-id="6810e-152">Any samples that arrive after the **EndFlush** call are guaranteed to be new, and should be delivered.</span></span>

<span data-ttu-id="6810e-153">Le sezioni seguenti contengono esempi di codice che illustrano come implementare i metodi di filtro più importanti, ad esempio **pause**, **Receive** e così via, in modo da evitare deadlock e race condition.</span><span class="sxs-lookup"><span data-stu-id="6810e-153">The sections that follow contain code samples showing how to implement the most important filter methods, such as **Pause**, **Receive**, and so forth, in ways that avoid deadlocks and race conditions.</span></span> <span data-ttu-id="6810e-154">Ogni filtro prevede tuttavia requisiti diversi, pertanto sarà necessario adattare questi esempi al filtro specifico.</span><span class="sxs-lookup"><span data-stu-id="6810e-154">Every filter has different requirements, however, so you will need to adapt these examples to your particular filter.</span></span>

> [!Note]  
> <span data-ttu-id="6810e-155">Le classi base [**CTransformFilter**](ctransformfilter.md) e [**CTransInPlaceFilter**](ctransinplacefilter.md) gestiscono molti dei problemi descritti in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="6810e-155">The [**CTransformFilter**](ctransformfilter.md) and [**CTransInPlaceFilter**](ctransinplacefilter.md) base classes handle many of the issues described in this article.</span></span> <span data-ttu-id="6810e-156">Se si sta scrivendo un filtro di trasformazione e il filtro non è in attesa di eventi all'interno di un metodo di flusso o se si tiene conto di campioni al di fuori della **ricezione**, queste classi di base dovrebbero essere sufficienti.</span><span class="sxs-lookup"><span data-stu-id="6810e-156">If you are writing a transform filter, and your filter does not wait on events inside a streaming method, or hold onto samples outside of **Receive**, then these base classes should be sufficient.</span></span>

 

 

 



