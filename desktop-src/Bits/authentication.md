---
title: Autenticazione (BITS)
description: BITS supporta l'autenticazione di base, l'autenticazione Passport e diversi schemi di autenticazione di richiesta/risposta.
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 5d970956676a3348dd4b8c4b420e044bd4714775
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 12/10/2020
ms.locfileid: "103963660"
---
# <a name="authentication-bits"></a><span data-ttu-id="e0be2-103">Autenticazione (BITS)</span><span class="sxs-lookup"><span data-stu-id="e0be2-103">Authentication (BITS)</span></span>

<span data-ttu-id="e0be2-104">BITS supporta l'autenticazione di base, l'autenticazione Passport e diversi schemi di autenticazione di richiesta/risposta.</span><span class="sxs-lookup"><span data-stu-id="e0be2-104">BITS supports Basic authentication, Passport authentication, and several challenge/response authentication schemes.</span></span> <span data-ttu-id="e0be2-105">Se il server o il proxy richiede l'autenticazione utente, usare la funzione [**IBackgroundCopyJob2:: Secredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) per specificare le credenziali dell'utente.</span><span class="sxs-lookup"><span data-stu-id="e0be2-105">If the server or proxy requires user authentication, use the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user's credentials.</span></span> <span data-ttu-id="e0be2-106">BITS USA [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) per proteggere le credenziali.</span><span class="sxs-lookup"><span data-stu-id="e0be2-106">BITS uses the [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) to protect the credentials.</span></span>

<span data-ttu-id="e0be2-107">Per impostare le credenziali per l'autenticazione di base, utilizzare la funzione [**Secredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) per specificare il nome utente e la password.</span><span class="sxs-lookup"><span data-stu-id="e0be2-107">To set credentials for Basic authentication use the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user name and password.</span></span> <span data-ttu-id="e0be2-108">È consigliabile usare l'autenticazione di base solo con i siti Web protetti con https://. in caso contrario, il nome utente e la password saranno visibili agli utenti.</span><span class="sxs-lookup"><span data-stu-id="e0be2-108">You should only use Basic authentication with https:// protected secure websites; otherwise the username and password will be visible to users.</span></span> 

<span data-ttu-id="e0be2-109">È possibile incorporare il nome utente e la password nell'URL.</span><span class="sxs-lookup"><span data-stu-id="e0be2-109">It's possible to embed the user name and password in the URL.</span></span> <span data-ttu-id="e0be2-110">Questa operazione non è considerata una procedura di sicurezza efficace ed è deprecata in RFC 3986 (sezione 3.2.1).</span><span class="sxs-lookup"><span data-stu-id="e0be2-110">This is not considered a good security practice, and is deprecated in RFC 3986 (section 3.2.1).</span></span>

<span data-ttu-id="e0be2-111">Per l'autenticazione [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) , BITS supporta solo le credenziali esplicite e non le credenziali implicite associate all'account.</span><span class="sxs-lookup"><span data-stu-id="e0be2-111">For [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) authentication, BITS supports explicit credentials only, not implicit credentials tied to the account.</span></span>

<span data-ttu-id="e0be2-112">Per l'autenticazione di tipo richiesta/risposta, BITS rappresenta l'utente e utilizza [Snego](../com/snego.md) per determinare l'autenticazione di tipo richiesta/risposta da utilizzare, ad esempio NTLM o il protocollo Kerberos.</span><span class="sxs-lookup"><span data-stu-id="e0be2-112">For challenge/response authentication, BITS impersonates the user and uses [Snego](../com/snego.md) to determine which challenge/response authentication to use, such as NTLM or the Kerberos protocol.</span></span> <span data-ttu-id="e0be2-113">Per un elenco di schemi di verifica/risposta supportati da BITS, [**vedere \_ \_ schema di autenticazione BG**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span><span class="sxs-lookup"><span data-stu-id="e0be2-113">For a list of challenge/response schemes that BITS supports, see [**BG\_AUTH\_SCHEME**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span></span>

<span data-ttu-id="e0be2-114">I processi BITS possono avere esito negativo se la directory virtuale nel server dispone di autenticazione anonima e di un altro schema di autenticazione abilitato e se gli ACL proteggono la directory virtuale o scaricano i file.</span><span class="sxs-lookup"><span data-stu-id="e0be2-114">BITS jobs can fail if the virtual directory on the server has anonymous authentication and another authentication scheme enabled and if ACLs protect the virtual directory or download files.</span></span> <span data-ttu-id="e0be2-115">Ad esempio, un processo ha esito negativo con "accesso negato" se per la directory virtuale è abilitata l'autenticazione anonima e integrata e il file contiene un ACL che consente solo a ben di leggere il file.</span><span class="sxs-lookup"><span data-stu-id="e0be2-115">For example, a job fails with "access denied" if the virtual directory has anonymous and integrated authentication enabled and the file contains an ACL that allows only Ben to read the file.</span></span> <span data-ttu-id="e0be2-116">Questo problema si verifica perché la directory virtuale consente l'accesso anonimo, quindi IIS non autentica in modo esplicito il ben (le credenziali di ben non vengono usate per accedere al file e l'accesso viene negato).</span><span class="sxs-lookup"><span data-stu-id="e0be2-116">This occurs because the virtual directory allows anonymous access, so IIS does not explicitly authenticate Ben (Ben's credentials are not used to access the file and access is denied).</span></span>

## <a name="using-implicit-credentials"></a><span data-ttu-id="e0be2-117">Uso di credenziali implicite</span><span class="sxs-lookup"><span data-stu-id="e0be2-117">Using implicit credentials</span></span>

<span data-ttu-id="e0be2-118">Per usare le credenziali implicite (di accesso) dell'utente per l'autenticazione NTLM o Kerberos, chiamare il metodo [**IBackgroundCopyJob2:: Secredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) e impostare i membri **username** e **password** della struttura di [**credenziali di \_ base \_ di BG**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) su **null**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-118">To use the user's implicit (logon) credentials for NTLM or Kerberos authentication, call the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method and set the **UserName** and **Password** members of the [**BG\_BASIC\_CREDENTIALS**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) structure to **NULL**.</span></span> <span data-ttu-id="e0be2-119">Se si specificano credenziali implicite per un proxy, BITS utilizzerà anche le credenziali implicite per l'autenticazione server, a meno che non si specifichino le credenziali esplicite del server.</span><span class="sxs-lookup"><span data-stu-id="e0be2-119">If you specify implicit credentials for a proxy, BITS will also use the implicit credentials for server authentication unless you specify explicit server credentials.</span></span>

<span data-ttu-id="e0be2-120">Per ulteriori informazioni sui servizi, vedere [account del servizio e BITS](service-accounts-and-bits.md).</span><span class="sxs-lookup"><span data-stu-id="e0be2-120">For additional information for services, see [Service Accounts and BITS](service-accounts-and-bits.md).</span></span>

<span data-ttu-id="e0be2-121">È anche possibile modificare il valore del registro di sistema **LMCompatibilityLevel** o **UseLMCompat** . Tuttavia, è necessario modificare questi valori solo se si dispone di un'applicazione esistente che non può essere modificata in modo da chiamare il metodo [**Secredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="e0be2-121">You could also change the **LMCompatibilityLevel** or **UseLMCompat** registry value; however, you should change these values only if you have an existing application that cannot be changed to call the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span>

<span data-ttu-id="e0be2-122">BITS utilizzerà le credenziali implicite per l'autenticazione se il valore del registro di sistema **LMCompatibilityLevel** è due o superiore e non è stato chiamato il metodo [**imcredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="e0be2-122">BITS will use implicit credentials for authentication if the **LMCompatibilityLevel** registry value is two or greater, and you have not called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span> <span data-ttu-id="e0be2-123">Il percorso completo del valore del registro di sistema **LMCompatibilityLevel** è **HKEY \_ Local \_ Machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **LSA** \\ **LMCompatibilityLevel**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-123">The full path to the **LMCompatibilityLevel** registry value is **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**LSA**\\**LmCompatibilityLevel**.</span></span>

<span data-ttu-id="e0be2-124">Si noti che la modifica del valore del registro di sistema **LMCompatibilityLevel** può influire su altre applicazioni e servizi in esecuzione nel computer.</span><span class="sxs-lookup"><span data-stu-id="e0be2-124">Note that changing the **LMCompatibilityLevel** registry value can affect other applications and services running on the computer.</span></span> <span data-ttu-id="e0be2-125">Per ulteriori informazioni sull'utilizzo del valore del registro di sistema **LMCompatibilityLevel** , vedere [KB147706](https://support.microsoft.com/kb/147706).</span><span class="sxs-lookup"><span data-stu-id="e0be2-125">For more information about using the **LMCompatibilityLevel** registry value, see [KB147706](https://support.microsoft.com/kb/147706).</span></span>

<span data-ttu-id="e0be2-126">Se l'impostazione del valore del registro di sistema **LMCompatibilityLevel** è un problema, è possibile creare il valore del registro di sistema **UseLMCompat** in **HKEY \_ Local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **bits**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-126">If setting the **LMCompatibilityLevel** registry value is an issue, you can create the **UseLMCompat** registry value under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows**\\**CurrentVersion**\\**BITS**.</span></span> <span data-ttu-id="e0be2-127">Il valore del registro di sistema è un valore DWORD.</span><span class="sxs-lookup"><span data-stu-id="e0be2-127">The registry value is a DWORD.</span></span> <span data-ttu-id="e0be2-128">La tabella seguente elenca i valori possibili per **UseLMCompat**:</span><span class="sxs-lookup"><span data-stu-id="e0be2-128">The following table lists the possible values for **UseLMCompat**:</span></span>

|<span data-ttu-id="e0be2-129">Valore</span><span class="sxs-lookup"><span data-stu-id="e0be2-129">Value</span></span>|<span data-ttu-id="e0be2-130">Descrizione</span><span class="sxs-lookup"><span data-stu-id="e0be2-130">Description</span></span>|
|-|-|
| <span data-ttu-id="e0be2-131">0</span><span class="sxs-lookup"><span data-stu-id="e0be2-131">0</span></span>     | <span data-ttu-id="e0be2-132">BITS invierà le credenziali implicite ogni volta che il server richiede le credenziali NTLM o Kerberos.</span><span class="sxs-lookup"><span data-stu-id="e0be2-132">BITS will send implicit credentials whenever the server prompts for NTLM or Kerberos credentials.</span></span>                                                                                           |
| <span data-ttu-id="e0be2-133">1</span><span class="sxs-lookup"><span data-stu-id="e0be2-133">1</span></span>     | <span data-ttu-id="e0be2-134">BITS invierà le credenziali implicite solo se il valore del registro di sistema **LMCompatibilityLevel** del computer client è maggiore o uguale a 2.</span><span class="sxs-lookup"><span data-stu-id="e0be2-134">BITS will send implicit credentials only if the client computer's **LMCompatibilityLevel** registry value is greater than or equal to 2.</span></span><br/>     |
| <span data-ttu-id="e0be2-135">2</span><span class="sxs-lookup"><span data-stu-id="e0be2-135">2</span></span>     | <span data-ttu-id="e0be2-136">BITS invierà le credenziali implicite solo se l'applicazione ha chiamato il metodo [**Secredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="e0be2-136">BITS will send implicit credentials only if the application called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span><br/> |

<span data-ttu-id="e0be2-137">BITS utilizzerà il valore predefinito "2" per il valore del registro di sistema **UseLMCompat** se il valore del registro di sistema non esiste.</span><span class="sxs-lookup"><span data-stu-id="e0be2-137">BITS will use a default value of "2" for the **UseLMCompat** registry value if the registry value does not exist.</span></span>

## <a name="using-certificates-for-clientserver-authentication"></a><span data-ttu-id="e0be2-138">Uso dei certificati per l'autenticazione client/server</span><span class="sxs-lookup"><span data-stu-id="e0be2-138">Using certificates for client/server authentication</span></span>

<span data-ttu-id="e0be2-139">Nella comunicazione protetta tra client e server, i client e i server possono usare i certificati digitali per l'autenticazione reciproca.</span><span class="sxs-lookup"><span data-stu-id="e0be2-139">In secure client/server communication, clients and servers can use digital certificates to mutually authenticate each other.</span></span> <span data-ttu-id="e0be2-140">BITS supporta automaticamente l'autenticazione server basata sui certificati per i trasporti HTTP protetti.</span><span class="sxs-lookup"><span data-stu-id="e0be2-140">BITS automatically supports certificate-based server authentication for secure HTTP transports.</span></span> <span data-ttu-id="e0be2-141">Per fornire BITS il certificato client necessario per l'autenticazione reciproca, chiamare il metodo [**IBackgroundCopyJobHttpOptions:: SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) o [**IBackgroundCopyJobHttpOptions:: SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) .</span><span class="sxs-lookup"><span data-stu-id="e0be2-141">To provide BITS the client certificate needed for mutual authentication, call either the [**IBackgroundCopyJobHttpOptions::SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or [**IBackgroundCopyJobHttpOptions::SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) method.</span></span>

<span data-ttu-id="e0be2-142">Quando un sito Web accetta ma non richiede un certificato client SSL e il processo BITS non specifica un certificato client, il processo avrà esito negativo e verrà eseguito l'errore con il certificato di **\_ \_ autenticazione client WinHTTP \_ \_ \_ necessario** (0x80072F0C).</span><span class="sxs-lookup"><span data-stu-id="e0be2-142">When a website accepts but does not require an SSL client certificate, and the BITS job does not specify a client certificate, the job will fail with **ERROR\_WINHTTP\_CLIENT\_AUTH\_CERT\_NEEDED** (0x80072f0c).</span></span>

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a><span data-ttu-id="e0be2-143">Come gestire scenari proxy autenticati che richiedono impostazioni specifiche dell'utente</span><span class="sxs-lookup"><span data-stu-id="e0be2-143">How to handle authenticated proxy scenarios that require user-specific settings</span></span>

<span data-ttu-id="e0be2-144">Se si utilizzano BITS in un ambiente che richiede l'autenticazione proxy mentre è in esecuzione come account senza credenziali NTLM o Kerberos utilizzabili nel dominio di rete del computer, è necessario eseguire passaggi aggiuntivi per l'autenticazione corretta utilizzando le credenziali di un altro account utente che dispone di credenziali nel dominio.</span><span class="sxs-lookup"><span data-stu-id="e0be2-144">If you are using BITS in an environment that requires proxy authentication while running as an account without usable NTLM or Kerberos credentials in the machine's network domain, you must take extra steps to authenticate properly by using the credentials of another user account that does have credentials on the domain.</span></span> <span data-ttu-id="e0be2-145">Si tratta di uno scenario tipico quando il codice BITS è in esecuzione come servizio di sistema, ad esempio LocalService, NetworkService o LocalSystem, in quanto questi account non dispongono di credenziali NTLM o Kerberos utilizzabili.</span><span class="sxs-lookup"><span data-stu-id="e0be2-145">This is a typical scenario when your BITS code is running as a system service such as LocalService, NetworkService, or LocalSystem, as those accounts do not have usable NTLM or Kerberos credentials.</span></span>

<span data-ttu-id="e0be2-146">La logica di rilevamento del proxy utilizzata in BITS esegue le operazioni seguenti quando si imposta un token helper di rete ( \_ rete token BG \_ ):</span><span class="sxs-lookup"><span data-stu-id="e0be2-146">The proxy detection logic used in BITS does the following when a network helper token (BG\_TOKEN\_NETWORK) is set:</span></span>

-   <span data-ttu-id="e0be2-147">Se [**Metodo ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) è stato chiamato con la **\_ \_ \_ \_ preconfigurazione di utilizzo del proxy del processo BG**, leggere le impostazioni del proxy di IE locale usando la rappresentazione del contesto del token del proprietario del processo tramite [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="e0be2-147">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**, then read local IE proxy settings using job owner token context impersonation via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="e0be2-148">A partire da Windows 10, versione 1809 (10,0; Compilazione 17763), per questo passaggio viene usata l'identità del token di supporto.</span><span class="sxs-lookup"><span data-stu-id="e0be2-148">Starting in Windows 10, version 1809 (10.0; Build 17763), the helper token identity is used for this step.</span></span>
-   <span data-ttu-id="e0be2-149">Se [**Metodo ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) è stato chiamato con il rilevamento automatico dell' **\_ utilizzo del proxy \_ \_ BG** o se le impostazioni di IE del caso di **utilizzo del \_ proxy del processo \_ \_ \_ BG** specificano il rilevamento automatico o un URL di configurazione automatica, eseguono il rilevamento automatico del proxy o il protocollo WPAD (Web Proxy AutoDiscovery Protocol), usando la rappresentazione del token helper tramite [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span><span class="sxs-lookup"><span data-stu-id="e0be2-149">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_PROXY\_USAGE\_AUTODETECT** or if the IE settings from the **BG\_JOB\_PROXY\_USAGE\_PRECONFIG** case specify auto-detect or an auto-config URL, then conduct auto-proxy detection, or Web Proxy Autodiscovery Protocol (WPAD), using helper token impersonation via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span></span>

<span data-ttu-id="e0be2-150">In seguito, la rappresentazione del token di supporto viene utilizzata per l'autenticazione del proxy o del server.</span><span class="sxs-lookup"><span data-stu-id="e0be2-150">After that, helper token impersonation is used for proxy or server authentication throughout.</span></span>

<span data-ttu-id="e0be2-151">A partire da Windows 10, versione 1809 (10,0; Compilazione 17763), lo scenario proxy autenticato con credenziali specifiche dell'utente è semplificato.</span><span class="sxs-lookup"><span data-stu-id="e0be2-151">Starting in Windows 10, version 1809 (10.0; Build 17763), the authenticated proxy scenario with user-specific credentials is simplified.</span></span>

1.  <span data-ttu-id="e0be2-152">Chiamare il metodo [**GetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) del processo BITS con lo **\_ schema di autenticazione BG \_ \_ Negotiate**, *username* impostato su **null**, *password* impostata su **null** e *target* impostato su **BG \_ auth \_ target \_ proxy**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-152">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="e0be2-153">In questo modo, le credenziali implicite dell'account utente vengono utilizzate per l'autenticazione NTLM e Kerberos con il proxy e il server.</span><span class="sxs-lookup"><span data-stu-id="e0be2-153">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
2.  <span data-ttu-id="e0be2-154">Chiamare [**Metodo ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con **la \_ \_ \_ \_ preconfigurazione di utilizzo del proxy del processo BG**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-154">Call [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**.</span></span>
3.  <span data-ttu-id="e0be2-155">QueryInterface per [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="e0be2-155">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
4.  <span data-ttu-id="e0be2-156">Rappresentare l'account utente in uso per le credenziali NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="e0be2-156">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
5.  <span data-ttu-id="e0be2-157">Chiamare [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="e0be2-157">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
6. <span data-ttu-id="e0be2-158">Chiamare [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) con **la \_ \_ rete di token BG**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-158">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
7. <span data-ttu-id="e0be2-159">Ripristinare la rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="e0be2-159">Revert impersonation.</span></span>
8. <span data-ttu-id="e0be2-160">Continua l'installazione del processo.</span><span class="sxs-lookup"><span data-stu-id="e0be2-160">Continue job setup.</span></span>
9. <span data-ttu-id="e0be2-161">Chiamare [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) per il processo.</span><span class="sxs-lookup"><span data-stu-id="e0be2-161">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>

<span data-ttu-id="e0be2-162">Prima di Windows 10, versione 1809 (10,0; Build 17763), l'identità utente corretta (l'identità del token di supporto) viene usata per il rilevamento del proxy basato sulla rete (WPAD) e per l'autenticazione proxy, ma il rilevamento effettivo delle impostazioni proxy locali (IE) viene sempre eseguito usando il token del proprietario del processo, anche quando viene configurato un token helper.</span><span class="sxs-lookup"><span data-stu-id="e0be2-162">Before Windows 10, version 1809 (10.0; Build 17763), the correct user identity (the helper token's identity) is used for network-based proxy detection (WPAD) and for proxy authentication, but the actual detection of local (IE) proxy settings is always done using the job owner's token, even when a helper token is configured.</span></span> <span data-ttu-id="e0be2-163">Per ovviare a questa lacuna, è possibile seguire questa procedura.</span><span class="sxs-lookup"><span data-stu-id="e0be2-163">To work around this shortcoming, you can follow these steps.</span></span>

1.  <span data-ttu-id="e0be2-164">Rappresentare l'account utente in uso per le credenziali NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="e0be2-164">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
2.  <span data-ttu-id="e0be2-165">Recuperare le impostazioni del proxy IE dell'account utente chiamando [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="e0be2-165">Retrieve the user account's IE proxy settings by calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span>
3.  <span data-ttu-id="e0be2-166">Ripristinare la rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="e0be2-166">Revert impersonation.</span></span>
4.  <span data-ttu-id="e0be2-167">Chiamare il metodo [**GetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) del processo BITS con lo **\_ schema di autenticazione BG \_ \_ Negotiate**, *username* impostato su **null**, *password* impostata su **null** e *target* impostato su **BG \_ auth \_ target \_ proxy**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-167">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="e0be2-168">In questo modo, le credenziali implicite dell'account utente vengono utilizzate per l'autenticazione NTLM e Kerberos con il proxy e il server.</span><span class="sxs-lookup"><span data-stu-id="e0be2-168">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
5.  <span data-ttu-id="e0be2-169">Se il passaggio 2 ha restituito le impostazioni proxy specifiche dell'utente (ad esempio, *lpszProxy* o *LpszProxyBypass* non sono **null**), impostare manualmente le impostazioni del processo corrispondenti, usando [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con l'impostazione di sostituzione dell'utilizzo del **proxy del \_ processo \_ \_ \_ BG** .</span><span class="sxs-lookup"><span data-stu-id="e0be2-169">If step 2 yielded any user-specific proxy settings (i.e. *lpszProxy* or *lpszProxyBypass* are not **NULL**), set the corresponding job settings manually, using [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with the **BG\_JOB\_PROXY\_USAGE\_OVERRIDE** setting.</span></span>
6.  <span data-ttu-id="e0be2-170">Se il passaggio 2 non produce impostazioni proxy specifiche per l'utente, chiamare [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) con **la \_ \_ \_ preconfigurazione di utilizzo del processo BG**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-170">If step 2 did not yield any user-specific proxy settings, call [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_USAGE\_PRECONFIG**.</span></span>
7.  <span data-ttu-id="e0be2-171">QueryInterface per [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="e0be2-171">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
8.  <span data-ttu-id="e0be2-172">Rappresenta nuovamente l'account utente.</span><span class="sxs-lookup"><span data-stu-id="e0be2-172">Impersonate the user account again.</span></span>
9.  <span data-ttu-id="e0be2-173">Chiamare [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="e0be2-173">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
10. <span data-ttu-id="e0be2-174">Chiamare [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) con **la \_ \_ rete di token BG**.</span><span class="sxs-lookup"><span data-stu-id="e0be2-174">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
11. <span data-ttu-id="e0be2-175">Ripristinare la rappresentazione.</span><span class="sxs-lookup"><span data-stu-id="e0be2-175">Revert impersonation.</span></span>
12. <span data-ttu-id="e0be2-176">Continua l'installazione del processo.</span><span class="sxs-lookup"><span data-stu-id="e0be2-176">Continue job setup.</span></span>
13. <span data-ttu-id="e0be2-177">Chiamare [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) per il processo.</span><span class="sxs-lookup"><span data-stu-id="e0be2-177">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>
