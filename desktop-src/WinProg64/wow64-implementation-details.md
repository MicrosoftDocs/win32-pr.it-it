---
title: Dettagli di implementazione di WOW64
description: L'emulatore WOW64 viene eseguito in modalità utente.
ms.assetid: 93daf9d0-dfdb-42c3-8c3d-397b21991e83
keywords:
- Programmazione Windows WOW64 a 64 bit, variabili di ambiente
- Programmazione Windows WOW64 a 64 bit, implementazione
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4c7d095369b883171e39bffd4dc629b7f80a7f39
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/20/2020
ms.locfileid: "104117938"
---
# <a name="wow64-implementation-details"></a><span data-ttu-id="e50c6-105">Dettagli di implementazione di WOW64</span><span class="sxs-lookup"><span data-stu-id="e50c6-105">WOW64 Implementation Details</span></span>

<span data-ttu-id="e50c6-106">L'emulatore WOW64 viene eseguito in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="e50c6-106">The WOW64 emulator runs in user mode.</span></span> <span data-ttu-id="e50c6-107">Fornisce un'interfaccia tra la versione a 32 bit di Ntdll.dll e il kernel del processore e intercetta le chiamate al kernel.</span><span class="sxs-lookup"><span data-stu-id="e50c6-107">It provides an interface between the 32-bit version of Ntdll.dll and the kernel of the processor, and it intercepts kernel calls.</span></span> <span data-ttu-id="e50c6-108">L'emulatore WOW64 è costituito dalle DLL seguenti:</span><span class="sxs-lookup"><span data-stu-id="e50c6-108">The WOW64 emulator consists of the following DLLs:</span></span>

-   <span data-ttu-id="e50c6-109">Wow64.dll fornisce l'infrastruttura di emulazione principale e i thunk per le funzioni del punto di ingresso Ntoskrnl.exe.</span><span class="sxs-lookup"><span data-stu-id="e50c6-109">Wow64.dll provides the core emulation infrastructure and the thunks for the Ntoskrnl.exe entry-point functions.</span></span>
-   <span data-ttu-id="e50c6-110">Wow64Win.dll fornisce i thunk per le funzioni del punto di ingresso Win32k.sys.</span><span class="sxs-lookup"><span data-stu-id="e50c6-110">Wow64Win.dll provides thunks for the Win32k.sys entry-point functions.</span></span>
-   <span data-ttu-id="e50c6-111">(solo x64) Wow64Cpu.dll fornisce supporto per l'esecuzione di programmi x86 in x64.</span><span class="sxs-lookup"><span data-stu-id="e50c6-111">(x64 only) Wow64Cpu.dll provides support for running x86 programs on x64.</span></span>
-   <span data-ttu-id="e50c6-112">(Solo Intel Itanium) IA32Exec. bin contiene l'emulatore software x86.</span><span class="sxs-lookup"><span data-stu-id="e50c6-112">(Intel Itanium only) IA32Exec.bin contains the x86 software emulator.</span></span>
-   <span data-ttu-id="e50c6-113">(Solo Intel Itanium) Wowia32x.dll fornisce l'interfaccia tra IA32Exec. bin e WOW64.</span><span class="sxs-lookup"><span data-stu-id="e50c6-113">(Intel Itanium only) Wowia32x.dll provides the interface between IA32Exec.bin and WOW64.</span></span>
-   <span data-ttu-id="e50c6-114">(Solo ARM64) xtajit.dll contiene l'emulatore software x86.</span><span class="sxs-lookup"><span data-stu-id="e50c6-114">(ARM64 only) xtajit.dll contains the x86 software emulator.</span></span>
-   <span data-ttu-id="e50c6-115">(Solo ARM64) wowarmw.dll fornisce supporto per l'esecuzione di programmi ARM32 in ARM64.</span><span class="sxs-lookup"><span data-stu-id="e50c6-115">(ARM64 only) wowarmw.dll provides support for running ARM32 programs on ARM64.</span></span>

<span data-ttu-id="e50c6-116">Queste dll, insieme alla versione a 64 bit di Ntdll.dll, sono gli unici file binari a 64 bit che possono essere caricati in un processo a 32 bit.</span><span class="sxs-lookup"><span data-stu-id="e50c6-116">These DLLs, along with the 64-bit version of Ntdll.dll, are the only 64-bit binaries that can be loaded into a 32-bit process.</span></span> <span data-ttu-id="e50c6-117">In Windows 10 su ARM, i file binari di CHPE (compilati Hybrid Portable Executable) possono essere caricati anche in un processo x86 a 32 bit.</span><span class="sxs-lookup"><span data-stu-id="e50c6-117">On Windows 10 on ARM, CHPE (Compiled Hybrid Portable Executable) binaries may also be loaded into an x86 32-bit process.</span></span>

<span data-ttu-id="e50c6-118">All'avvio Wow64.dll carica la versione x86 di Ntdll.dll (o la versione CHPE, se abilitata) ed esegue il codice di inizializzazione, che carica tutte le dll a 32 bit necessarie.</span><span class="sxs-lookup"><span data-stu-id="e50c6-118">At startup, Wow64.dll loads the x86 version of Ntdll.dll (or the CHPE version, if enabled) and runs its initialization code, which loads all necessary 32-bit DLLs.</span></span> <span data-ttu-id="e50c6-119">Quasi tutte le dll a 32 bit sono copie non modificate dei file binari di Windows a 32 bit, anche se alcune sono caricate come CHPE per motivi di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="e50c6-119">Almost all 32-bit DLLs are unmodified copies of 32-bit Windows binaries, though some are loaded as CHPE for performance reasons.</span></span> <span data-ttu-id="e50c6-120">Alcune di queste dll si comportano in modo diverso in WOW64 rispetto a quelle eseguite su Windows a 32 bit, in genere perché condividono memoria con componenti di sistema a 64 bit.</span><span class="sxs-lookup"><span data-stu-id="e50c6-120">Some of these DLLs are written to behave differently on WOW64 than they do on 32-bit Windows, usually because they share memory with 64-bit system components.</span></span> <span data-ttu-id="e50c6-121">Tutto lo spazio degli indirizzi in modalità utente superiore al limite di 32 bit è riservato dal sistema.</span><span class="sxs-lookup"><span data-stu-id="e50c6-121">All user-mode address space above the 32-bit limit is reserved by the system.</span></span> <span data-ttu-id="e50c6-122">Per altre informazioni, vedere [utilizzo delle prestazioni e della memoria in WOW64](performance-and-memory-consumption.md).</span><span class="sxs-lookup"><span data-stu-id="e50c6-122">For more information, see [Performance and Memory Consumption under WOW64](performance-and-memory-consumption.md).</span></span>

<span data-ttu-id="e50c6-123">Anziché utilizzare la sequenza di chiamate del servizio di sistema x86, i file binari a 32 bit che eseguono chiamate di sistema vengono ricompilati per l'utilizzo di una sequenza chiamante personalizzata.</span><span class="sxs-lookup"><span data-stu-id="e50c6-123">Instead of using the x86 system-service call sequence, 32-bit binaries that make system calls are rebuilt to use a custom calling sequence.</span></span> <span data-ttu-id="e50c6-124">Questa sequenza di chiamata è conveniente per l'intercettazione di WOW64 perché rimane interamente in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="e50c6-124">This calling sequence is inexpensive for WOW64 to intercept because it remains entirely in user mode.</span></span> <span data-ttu-id="e50c6-125">Quando viene rilevata la sequenza di chiamata personalizzata, la CPU WOW64 esegue la transizione alla modalità nativa a 64 bit e chiama Wow64.dll.</span><span class="sxs-lookup"><span data-stu-id="e50c6-125">When the custom calling sequence is detected, the WOW64 CPU transitions back to native 64-bit mode and calls into Wow64.dll.</span></span> <span data-ttu-id="e50c6-126">Il thunk viene eseguito in modalità utente per ridurre l'effetto sul kernel a 64 bit e per ridurre il rischio di un bug nel thunk che può causare un arresto anomalo della modalità kernel, il danneggiamento dei dati o un problema di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="e50c6-126">Thunking is done in user mode to reduce the impact on the 64-bit kernel and to reduce the risk of a bug in the thunk that might cause a kernel-mode crash, data corruption, or a security hole.</span></span> <span data-ttu-id="e50c6-127">I thunk estraggono gli argomenti dallo stack a 32 bit, li estendono a 64 bit, quindi effettuano la chiamata al sistema nativo.</span><span class="sxs-lookup"><span data-stu-id="e50c6-127">The thunks extract arguments from the 32-bit stack, extend them to 64 bits, then make the native system call.</span></span>

## <a name="environment-variables"></a><span data-ttu-id="e50c6-128">Variabili di ambiente</span><span class="sxs-lookup"><span data-stu-id="e50c6-128">Environment Variables</span></span>

<span data-ttu-id="e50c6-129">Quando un processo a 32 bit viene creato da un processo a 64 bit o quando un processo a 64 bit viene creato da un processo a 32 bit, WOW64 imposta le variabili di ambiente per il processo creato, come illustrato nella tabella seguente.</span><span class="sxs-lookup"><span data-stu-id="e50c6-129">When a 32-bit process is created by a 64-bit process, or when a 64-bit process is created by a 32-bit process, WOW64 sets the environment variables for the created process as shown in the following table.</span></span>



| <span data-ttu-id="e50c6-130">Processo</span><span class="sxs-lookup"><span data-stu-id="e50c6-130">Process</span></span>                   | <span data-ttu-id="e50c6-131">Variabili di ambiente</span><span class="sxs-lookup"><span data-stu-id="e50c6-131">Environment variables</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="e50c6-132">processo a 64 bit</span><span class="sxs-lookup"><span data-stu-id="e50c6-132">64-bit process</span></span><br/> | <span data-ttu-id="e50c6-133">Architettura del processore \_ = amd64 o \_ architettura del processore = IA64 o architettura del processore \_ = arm64</span><span class="sxs-lookup"><span data-stu-id="e50c6-133">PROCESSOR\_ARCHITECTURE=AMD64 or PROCESSOR\_ARCHITECTURE=IA64 or PROCESSOR\_ARCHITECTURE=ARM64</span></span><br/> <span data-ttu-id="e50c6-134">ProgramFiles =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e50c6-134">ProgramFiles=%ProgramFiles%</span></span><br/> <span data-ttu-id="e50c6-135">ProgramW6432 =% programmi%</span><span class="sxs-lookup"><span data-stu-id="e50c6-135">ProgramW6432=%ProgramFiles%</span></span><br/> <span data-ttu-id="e50c6-136">CommonProgramFiles =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e50c6-136">CommonProgramFiles=%CommonProgramFiles%</span></span><br/> <span data-ttu-id="e50c6-137">CommonProgramW6432 =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e50c6-137">CommonProgramW6432=%CommonProgramFiles%</span></span><br/> <span data-ttu-id="e50c6-138">**Windows server 2008, Windows Vista, Windows server 2003 e Windows XP:** Le variabili di ambiente ProgramW6432 e CommonProgramW6432 sono state aggiunte a partire da Windows 7 e Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="e50c6-138">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** The ProgramW6432 and CommonProgramW6432 environment variables were added starting with Windows 7 and Windows Server 2008 R2.</span></span> <br/> |
| <span data-ttu-id="e50c6-139">processo a 32 bit</span><span class="sxs-lookup"><span data-stu-id="e50c6-139">32-bit process</span></span><br/> | <span data-ttu-id="e50c6-140">Architettura del processore \_ = x86</span><span class="sxs-lookup"><span data-stu-id="e50c6-140">PROCESSOR\_ARCHITECTURE=x86</span></span><br/> <span data-ttu-id="e50c6-141">\_ARCHITEW6432 processore =% \_ Architettura processore%</span><span class="sxs-lookup"><span data-stu-id="e50c6-141">PROCESSOR\_ARCHITEW6432=%PROCESSOR\_ARCHITECTURE%</span></span><br/> <span data-ttu-id="e50c6-142">ProgramFiles =% ProgramFiles (x86)%</span><span class="sxs-lookup"><span data-stu-id="e50c6-142">ProgramFiles=%ProgramFiles(x86)%</span></span><br/> <span data-ttu-id="e50c6-143">ProgramW6432 =% programmi%</span><span class="sxs-lookup"><span data-stu-id="e50c6-143">ProgramW6432=%ProgramFiles%</span></span><br/> <span data-ttu-id="e50c6-144">CommonProgramFiles =% CommonProgramFiles (x86)%</span><span class="sxs-lookup"><span data-stu-id="e50c6-144">CommonProgramFiles=%CommonProgramFiles(x86)%</span></span><br/> <span data-ttu-id="e50c6-145">CommonProgramW6432 =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e50c6-145">CommonProgramW6432=%CommonProgramFiles%</span></span><br/>                                                                                                                                                                                                                  |



 

## <a name="global-hooks"></a><span data-ttu-id="e50c6-146">Hook globali</span><span class="sxs-lookup"><span data-stu-id="e50c6-146">Global Hooks</span></span>

<span data-ttu-id="e50c6-147">La funzione [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) può essere usata per inserire una dll in un altro processo se vengono soddisfatte le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="e50c6-147">The [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) function can be used to inject a DLL into another process if the following conditions are met:</span></span>

-   <span data-ttu-id="e50c6-148">Una DLL a 32 bit può essere inserita solo in un processo a 32 bit ed è possibile inserire una DLL a 64 bit solo in un processo a 64 bit.</span><span class="sxs-lookup"><span data-stu-id="e50c6-148">A 32-bit DLL can be injected only into a 32-bit process, and a 64-bit DLL can be injected only into a 64-bit process.</span></span> <span data-ttu-id="e50c6-149">Non è possibile inserire una DLL a 32 bit in un processo a 64 bit o viceversa.</span><span class="sxs-lookup"><span data-stu-id="e50c6-149">It is not possible to inject a 32-bit DLL into a 64-bit process or vice versa.</span></span>
-   <span data-ttu-id="e50c6-150">Le dll a 32 bit e a 64 bit devono avere nomi diversi.</span><span class="sxs-lookup"><span data-stu-id="e50c6-150">The 32-bit and 64-bit DLLs must have different names.</span></span>
-   <span data-ttu-id="e50c6-151">Le architetture della DLL e del processo devono corrispondere.</span><span class="sxs-lookup"><span data-stu-id="e50c6-151">The architectures of the DLL and the process must match.</span></span> <span data-ttu-id="e50c6-152">Ad esempio, non è possibile inserire una DLL x86 a 32 bit in un processo ARM a 32 bit.</span><span class="sxs-lookup"><span data-stu-id="e50c6-152">For instance, you cannot inject a 32-bit x86 DLL into a 32-bit ARM process.</span></span>

<span data-ttu-id="e50c6-153">Per ulteriori informazioni, vedere [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).</span><span class="sxs-lookup"><span data-stu-id="e50c6-153">For more information, see [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).</span></span>

<span data-ttu-id="e50c6-154">Tenere presente che il **\_ mouse WH**, **la \_ tastiera WH**, il **\_ \* Journal** di WH, la **\_ Shell di WH** e gli hook di basso livello possono essere chiamati sul thread che ha installato l'hook anziché sul thread che elabora l'hook.</span><span class="sxs-lookup"><span data-stu-id="e50c6-154">Be aware that the **WH\_MOUSE**, **WH\_KEYBOARD**, **WH\_JOURNAL\***, **WH\_SHELL**, and low-level hooks can be called on the thread that installed the hook rather than the thread processing the hook.</span></span> <span data-ttu-id="e50c6-155">Per questi hook, è possibile che vengano chiamati entrambi i Hook a 32 bit e a 64 bit se un hook a 32 bit precede un hook a 64 bit nella catena di hook.</span><span class="sxs-lookup"><span data-stu-id="e50c6-155">For these hooks, it is possible that both the 32-bit and 64-bit hooks will be called if a 32-bit hook is ahead of a 64-bit hook in the hook chain.</span></span> <span data-ttu-id="e50c6-156">Per ulteriori informazioni, vedere [utilizzo degli hook](../winmsg/using-hooks.md).</span><span class="sxs-lookup"><span data-stu-id="e50c6-156">For more information, see [Using Hooks](../winmsg/using-hooks.md).</span></span>

 

