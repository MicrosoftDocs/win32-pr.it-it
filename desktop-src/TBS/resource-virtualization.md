---
title: Virtualizzazione delle risorse
description: Virtualizzazione delle risorse
ms.assetid: ead0e99a-94da-4e80-bb68-d8f4b199173d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f340b1a1bddfb3fd591452e028c80403b9c7e02f
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 09/16/2019
ms.locfileid: "103711818"
---
# <a name="resource-virtualization"></a><span data-ttu-id="8fe27-103">Virtualizzazione delle risorse</span><span class="sxs-lookup"><span data-stu-id="8fe27-103">Resource Virtualization</span></span>

<span data-ttu-id="8fe27-104">La funzione principale di TBS consiste nel condividere in modo efficiente alcune risorse TPM limitate: chiavi, autorizzazioni e sessioni di trasporto.</span><span class="sxs-lookup"><span data-stu-id="8fe27-104">The primary function of the TBS is to efficiently share certain limited TPM resources: keys, authorization, and transport sessions.</span></span>

<span data-ttu-id="8fe27-105">Quando viene creata un'istanza di una di queste risorse, TBS crea un'istanza virtuale della risorsa e restituisce un handle a questa istanza virtuale nel flusso del comando risultante, anziché nell'istanza dell'handle effettiva restituita dal TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-105">When an instance of one of these resources is created, the TBS creates a virtual instance of the resource, and returns a handle to this virtual instance in the result command stream (rather than the actual handle instance returned by the TPM).</span></span> <span data-ttu-id="8fe27-106">TBS mantiene internamente un mapping tra l'handle virtuale e l'handle effettivo.</span><span class="sxs-lookup"><span data-stu-id="8fe27-106">The TBS maintains a mapping between the virtual handle and the actual handle internally.</span></span> <span data-ttu-id="8fe27-107">Se il TPM esaurisce lo spazio per conservare più risorse di un determinato tipo, le istanze esistenti della risorsa vengono salvate e eliminate in modo selettivo finché il TPM non è in grado di mantenere la nuova risorsa.</span><span class="sxs-lookup"><span data-stu-id="8fe27-107">If the TPM runs out of space to hold more resources of a given type, existing instances of the resource are selectively saved and evicted until the TPM can hold the new resource.</span></span> <span data-ttu-id="8fe27-108">Quando le risorse precedenti sono nuovamente obbligatorie, TBS carica i contesti salvati (salvando e rimuovendo altre risorse se necessario) prima di inviare il comando.</span><span class="sxs-lookup"><span data-stu-id="8fe27-108">When the old resources are required again, the TBS loads the saved contexts (saving and evicting other resources if necessary) before submitting the command.</span></span>

<span data-ttu-id="8fe27-109">Tutta la virtualizzazione in TBS viene eseguita per conto di un contesto specifico.</span><span class="sxs-lookup"><span data-stu-id="8fe27-109">All virtualization in the TBS is performed on behalf of a specific context.</span></span> <span data-ttu-id="8fe27-110">Ogni contesto può accedere solo alle risorse virtuali create in modo specifico per suo conto, nonché alle risorse fisiche sul TPM che corrispondono a tali risorse virtuali.</span><span class="sxs-lookup"><span data-stu-id="8fe27-110">Each context is only allowed to access virtual resources created specifically on its behalf, as well as the physical resources on the TPM that corresponds to those virtual resources.</span></span> <span data-ttu-id="8fe27-111">Per impostazione predefinita, il numero totale di tutte le risorse virtualizzate è limitato a 500.</span><span class="sxs-lookup"><span data-stu-id="8fe27-111">By default, the total number of all virtualized resources is limited to 500.</span></span> <span data-ttu-id="8fe27-112">Questo numero può essere modificato creando o modificando un valore **DWORD** del registro di sistema denominato **MaxResources** in **HKEY \_ Local \_ Machine** \\ **software** \\ **Microsoft** \\ **TPM**.</span><span class="sxs-lookup"><span data-stu-id="8fe27-112">This number can be altered by creating or modifying a **DWORD** registry value named **MaxResources** under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Tpm**.</span></span> <span data-ttu-id="8fe27-113">È possibile osservare l'utilizzo delle risorse TBS in tempo reale usando lo strumento Performance Monitor per tenere traccia del numero di risorse TBS.</span><span class="sxs-lookup"><span data-stu-id="8fe27-113">Real-time TBS resource usage can be observed by using the Performance Monitor tool to track the number of TBS resources.</span></span> <span data-ttu-id="8fe27-114">Questa restrizione è diventata obsoleta con Windows 8 e Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="8fe27-114">This restriction became obsolete with Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="8fe27-115">Risorse TPM limitate non virtualizzate da TBS (ad esempio, contatori e archivio NV) devono essere condivise in modo cooperativo tra gli stack di software.</span><span class="sxs-lookup"><span data-stu-id="8fe27-115">Limited TPM resources that are not virtualized by the TBS (such as counters and NV store) must be cooperatively shared among software stacks.</span></span>

> [!Note]  
> <span data-ttu-id="8fe27-116">Questa virtualizzazione dell'handle causa l'esito negativo dei comandi che includono handle di chiave nel calcolo di parametri di autorizzazione HMAC.</span><span class="sxs-lookup"><span data-stu-id="8fe27-116">This handle virtualization causes commands that include key handles in the calculation of HMAC authorization parameters to fail.</span></span> <span data-ttu-id="8fe27-117">Di conseguenza, molti comandi deprecati nella versione 1,2 del TPM non possono essere usati dal software applicativo nell'ambiente TBS.</span><span class="sxs-lookup"><span data-stu-id="8fe27-117">As a result, many commands deprecated in TPM version 1.2 cannot be used by application software in the TBS environment.</span></span>

 

## <a name="resource-limits"></a><span data-ttu-id="8fe27-118">Limiti delle risorse</span><span class="sxs-lookup"><span data-stu-id="8fe27-118">Resource Limits</span></span>

<span data-ttu-id="8fe27-119">Il TPM consente ai chiamanti di eseguire query sulle proprie funzionalità per determinare la quantità di spazio disponibile per determinati tipi di risorse.</span><span class="sxs-lookup"><span data-stu-id="8fe27-119">The TPM enables callers to query its capabilities to determine how much space is available for certain types of resources.</span></span> <span data-ttu-id="8fe27-120">Alcuni di questi limiti di risorse, ad esempio la quantità di spazio disponibile per chiavi, sessioni di autorizzazione e sessioni di trasporto, vengono efficacemente estesi da TBS attraverso la virtualizzazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-120">Some of these resource limits, such as the amount of space available for keys, authorization sessions, and transport sessions, are effectively extended by the TBS through virtualization.</span></span> <span data-ttu-id="8fe27-121">Le limitazioni di TBS, che sono controllate dall'impostazione del registro di sistema **MaxResources** , sono in genere molto più grandi delle limitazioni effettive dell'hardware TPM sottostante.</span><span class="sxs-lookup"><span data-stu-id="8fe27-121">TBS limitations, which are controlled by the **MaxResources** registry setting, are usually far larger than the actual limitations of the underlying TPM hardware.</span></span> <span data-ttu-id="8fe27-122">Non viene fornito alcun meccanismo per l'esecuzione di query sulle limitazioni di TBS separatamente rispetto ai limiti hardware del TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-122">No mechanism is supplied for querying TBS limitations separately from the TPM hardware limits.</span></span> <span data-ttu-id="8fe27-123">Questa limitazione di TBS è diventata obsoleta con Windows 8 e Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="8fe27-123">This TBS limitation became obsolete with Windows 8 and Windows Server 2012.</span></span>

## <a name="keys"></a><span data-ttu-id="8fe27-124">Chiavi</span><span class="sxs-lookup"><span data-stu-id="8fe27-124">Keys</span></span>

<span data-ttu-id="8fe27-125">TBS virtualizza gli handle chiave in modo che le chiavi possano essere scaricate in modo trasparente dal TPM quando non vengono usate e ricaricate nel TPM quando sono necessarie.</span><span class="sxs-lookup"><span data-stu-id="8fe27-125">The TBS virtualizes key handles so that keys can be transparently unloaded from the TPM when they are not being used and loaded back onto the TPM when they are needed.</span></span> <span data-ttu-id="8fe27-126">Quando viene creato un tasto, TBS associa un handle virtuale alla chiave caricata.</span><span class="sxs-lookup"><span data-stu-id="8fe27-126">When a key is created, the TBS associates a virtual handle with the loaded key.</span></span> <span data-ttu-id="8fe27-127">Lo stesso handle virtuale viene usato per la durata della risorsa.</span><span class="sxs-lookup"><span data-stu-id="8fe27-127">The same virtual handle is used for the lifetime of the resource.</span></span> <span data-ttu-id="8fe27-128">Gli handle di chiave virtuale sono validi solo nel contesto che li ha creati e le risorse associate non vengono mantenute oltre la durata del contesto.</span><span class="sxs-lookup"><span data-stu-id="8fe27-128">Virtual key handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the context.</span></span>

-   <span data-ttu-id="8fe27-129">Creazione di chiavi con TPM \_ LoadKey2</span><span class="sxs-lookup"><span data-stu-id="8fe27-129">Creating Keys with TPM\_LoadKey2</span></span>

    <span data-ttu-id="8fe27-130">Se viene creata una chiave usando il comando TPM \_ LoadKey2, TPM2 \_ CREATEPRIMARY, TPM2 \_ Load o TPM2 \_ LoadExternal, TBS sostituisce l'handle nel flusso di byte restituito con un handle di chiave virtuale di sua scelta.</span><span class="sxs-lookup"><span data-stu-id="8fe27-130">If a key is created by using the TPM\_LoadKey2, TPM2\_CreatePrimary, TPM2\_Load, or TPM2\_LoadExternal command, the TBS replaces the handle in the return byte stream with a virtual key handle of its choosing.</span></span> <span data-ttu-id="8fe27-131">Di conseguenza, TBS garantisce che ogni handle virtuale sia univoco.</span><span class="sxs-lookup"><span data-stu-id="8fe27-131">As a result, the TBS ensures that each virtual handle is unique.</span></span> <span data-ttu-id="8fe27-132">Se TBS rileva un conflitto (un evento estremamente improbabile), TBS Scarica la chiave dal TPM e informa il software chiamante.</span><span class="sxs-lookup"><span data-stu-id="8fe27-132">If the TBS detects a collision (an extremely unlikely event), the TBS unloads the key from the TPM and informs the calling software.</span></span> <span data-ttu-id="8fe27-133">Il software può quindi inviare nuovamente l'operazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-133">The software can then resubmit the operation.</span></span> <span data-ttu-id="8fe27-134">Questo processo può essere ripetuto fino a quando TBS non ottiene un handle di chiave univoco.</span><span class="sxs-lookup"><span data-stu-id="8fe27-134">This process can be repeated until the TBS gets a unique key handle.</span></span>

-   <span data-ttu-id="8fe27-135">Cancellazione di chiavi</span><span class="sxs-lookup"><span data-stu-id="8fe27-135">Clearing Keys</span></span>

    <span data-ttu-id="8fe27-136">TBS invalida l'handle di chiave virtuale quando riceve un \_ messaggio TPM FlushSpecific o TPM2 \_ FlushContext per tale handle virtuale dal contesto client.</span><span class="sxs-lookup"><span data-stu-id="8fe27-136">The TBS invalidates the virtual key handle when it receives a TPM\_FlushSpecific or TPM2\_FlushContext message for that virtual handle from the client context.</span></span> <span data-ttu-id="8fe27-137">Se la chiave è fisicamente presente nel TPM quando viene ricevuto il messaggio di scaricamento, TBS Scarica la chiave dal TPM in quel momento.</span><span class="sxs-lookup"><span data-stu-id="8fe27-137">If the key is physically present on the TPM when the flush message is received, the TBS flushes the key from the TPM at that time.</span></span>

-   <span data-ttu-id="8fe27-138">Rimozione temporanea di chiavi</span><span class="sxs-lookup"><span data-stu-id="8fe27-138">Temporarily Removing Keys</span></span>

    <span data-ttu-id="8fe27-139">Quando si rimuove una chiave dal TPM per creare spazio per un nuovo elemento, TBS esegue un \_ comando TPM SaveContext o TPM2 \_ ContextSave sulla chiave prima di rimuoverlo.</span><span class="sxs-lookup"><span data-stu-id="8fe27-139">When evicting a key from the TPM to make room for a new item, the TBS executes a TPM\_SaveContext or TPM2\_ContextSave command on the key before evicting it.</span></span>

-   <span data-ttu-id="8fe27-140">Ripristino di chiavi</span><span class="sxs-lookup"><span data-stu-id="8fe27-140">Restoring Keys</span></span>

    <span data-ttu-id="8fe27-141">Quando un comando che fa riferimento a una chiave caricata viene inviato a TBS, garantisce che la chiave sia fisicamente presente nel TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-141">When a command that references a loaded key is submitted to the TBS, it ensures that the key is physically present on the TPM.</span></span> <span data-ttu-id="8fe27-142">Se la chiave non è presente, TBS lo ripristina con una chiamata a TPM \_ LoadContext o TPM2 \_ ContextLoad.</span><span class="sxs-lookup"><span data-stu-id="8fe27-142">If the key is not present, the TBS restores it with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="8fe27-143">Se una chiave non può essere ripristinata nel TPM, TBS restituisce un HANDLE di chiave TPM \_ E \_ non valido \_ come risultato del TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-143">If a key cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_KEYHANDLE as the TPM result.</span></span>

<span data-ttu-id="8fe27-144">TBS sostituisce ogni handle virtuale associato a una chiave in un flusso di comandi con l'handle fisico della chiave caricata nel TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-144">The TBS replaces each virtual handle associated with a key in a command stream with the physical handle of the key loaded on the TPM.</span></span> <span data-ttu-id="8fe27-145">Se un comando viene inviato con un handle virtuale non riconosciuto da TBS nel contesto del chiamante, TBS formatta un flusso di errore per il chiamante con un HANDLE di tasti TPM \_ E non \_ valido \_ .</span><span class="sxs-lookup"><span data-stu-id="8fe27-145">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with TPM\_E\_INVALID\_KEYHANDLE.</span></span>

## <a name="authorization-sessions"></a><span data-ttu-id="8fe27-146">Sessioni di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="8fe27-146">Authorization Sessions</span></span>

<span data-ttu-id="8fe27-147">Le sessioni di autorizzazione vengono create chiamando TPM \_ OIAP, TPM \_ OSAP o TPM \_ DSAP.</span><span class="sxs-lookup"><span data-stu-id="8fe27-147">Authorization sessions are created by calling TPM\_OIAP, TPM\_OSAP, or TPM\_DSAP.</span></span> <span data-ttu-id="8fe27-148">In ogni caso, il flusso di byte restituito contiene l'handle del TPM fisico della sessione di autorizzazione appena creata.</span><span class="sxs-lookup"><span data-stu-id="8fe27-148">In each case, the return byte stream contains the physical TPM handle of the newly created authorization session.</span></span> <span data-ttu-id="8fe27-149">TBS sostituisce questo oggetto con un handle virtuale.</span><span class="sxs-lookup"><span data-stu-id="8fe27-149">The TBS replaces this with a virtual handle.</span></span> <span data-ttu-id="8fe27-150">Quando viene successivamente fatto riferimento alla sessione di autorizzazione, TBS sostituisce l'handle virtuale nel flusso di comandi con l'handle fisico della sessione di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-150">When the authorization session is subsequently referenced, the TBS replaces the virtual handle in the command stream with the physical handle of the authorization session.</span></span> <span data-ttu-id="8fe27-151">TBS garantisce che la durata della sessione di autorizzazione virtuale corrisponda a quella della sessione di autorizzazione fisica.</span><span class="sxs-lookup"><span data-stu-id="8fe27-151">The TBS ensures that the lifetime of the virtual authorization session matches that of the physical authorization session.</span></span> <span data-ttu-id="8fe27-152">Se un client tenta di usare un handle virtuale scaduto, TBS formatta un flusso di errore con errore \_ INVALIDAUTHHANDLE TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-152">If a client attempts to use an expired virtual handle, the TBS formats an error stream with error TPM\_INVALIDAUTHHANDLE.</span></span>

<span data-ttu-id="8fe27-153">Gli slot di sessione sono limitati e la TBS può esaurire gli slot esterni in cui salvare i contesti di sessione di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-153">Session slots are limited, and the TBS may run out of external slots in which to save authorization session contexts.</span></span> <span data-ttu-id="8fe27-154">In tal caso, TBS sceglie una sessione di autorizzazione da invalidare in modo che il nuovo contesto possa essere salvato correttamente.</span><span class="sxs-lookup"><span data-stu-id="8fe27-154">If this happens, the TBS chooses an authorization session to invalidate so that the new context can be successfully saved.</span></span> <span data-ttu-id="8fe27-155">Un'applicazione che tenta di utilizzare il contesto precedente dovrà creare nuovamente la sessione di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-155">An application that attempts to use the old context will need to re-create the authorization session.</span></span>

<span data-ttu-id="8fe27-156">TBS invalida la sessione di autorizzazione virtuale quando si verifica uno dei casi seguenti:</span><span class="sxs-lookup"><span data-stu-id="8fe27-156">The TBS invalidates the virtual authorization session when any of the following cases occur:</span></span>

-   <span data-ttu-id="8fe27-157">Il flag di utilizzo continuo associato alla sessione di autorizzazione nel flusso di comandi restituito dal TPM è **false**.</span><span class="sxs-lookup"><span data-stu-id="8fe27-157">The continue-use flag associated with the authorization session in the returned command stream from the TPM is **FALSE**.</span></span>
-   <span data-ttu-id="8fe27-158">Un comando che usa una sessione di autorizzazione ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="8fe27-158">A command that uses an authorization session fails.</span></span>
-   <span data-ttu-id="8fe27-159">Viene eseguito un comando che invalida la sessione di autorizzazione associata al comando (ad esempio TPM \_ CreateWrapKey).</span><span class="sxs-lookup"><span data-stu-id="8fe27-159">A command is executed that invalidates the authorization session associated with the command (such as TPM\_CreateWrapKey).</span></span>
-   <span data-ttu-id="8fe27-160">Una chiave associata a una sessione OSAP o DSAP viene eliminata dal TPM con una chiamata a TPM \_ FlushSpecific o TPM2 \_ FlushContext (indipendentemente dal fatto che il comando sia stato originato da TBS o con software di livello superiore).</span><span class="sxs-lookup"><span data-stu-id="8fe27-160">A key associated with an OSAP or DSAP session is evicted from the TPM with a call to TPM\_FlushSpecific or TPM2\_FlushContext (without regard to whether this command originated with the TBS or with higher-level software).</span></span>

    <span data-ttu-id="8fe27-161">TBS Risincronizza automaticamente le sessioni di autorizzazione dopo l'esecuzione corretta di determinati comandi non deterministici per assicurarsi che lo stato di TBS rimanga coerente con lo stato TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-161">The TBS will automatically resynchronize the authorization sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="8fe27-162">I comandi interessati sono:</span><span class="sxs-lookup"><span data-stu-id="8fe27-162">The affected commands are:</span></span>

    -   <span data-ttu-id="8fe27-163">\_Gestione del \_ delegato di \_ gestione del TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-163">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="8fe27-164">\_ \_ CreateOwnerDelegation delegato dell'ORD TPM \_</span><span class="sxs-lookup"><span data-stu-id="8fe27-164">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="8fe27-165">\_ \_ LoadOwnerDelegation delegato dell'ORD TPM \_</span><span class="sxs-lookup"><span data-stu-id="8fe27-165">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="8fe27-166">In ognuno dei casi seguenti la sessione di autorizzazione nel TPM viene scaricata automaticamente dal TPM:</span><span class="sxs-lookup"><span data-stu-id="8fe27-166">In each of the following cases the authorization session on the TPM is flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="8fe27-167">Creazione di sessioni di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="8fe27-167">Creating Authorization Sessions</span></span>

    <span data-ttu-id="8fe27-168">Gli handle della sessione di autorizzazione virtuale sono validi solo nel contesto che li ha creati e le risorse associate non vengono mantenute oltre la durata del contesto associato.</span><span class="sxs-lookup"><span data-stu-id="8fe27-168">Virtual authorization session handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="8fe27-169">Cancellazione delle sessioni di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="8fe27-169">Clearing Authorization Sessions</span></span>

    <span data-ttu-id="8fe27-170">TBS invalida la sessione di autorizzazione virtuale se riceve un \_ comando TPM FlushSpecific o TPM2 \_ FlushContext per l'handle virtuale dal contesto client.</span><span class="sxs-lookup"><span data-stu-id="8fe27-170">The TBS invalidates the virtual authorization session if it receives a TPM\_FlushSpecific or TPM2\_FlushContext command for the virtual handle from the client context.</span></span> <span data-ttu-id="8fe27-171">Se la sessione di autorizzazione è fisicamente presente nel TPM quando viene ricevuto il comando di scaricamento, TBS Scarica immediatamente la sessione fisica dal TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-171">If the authorization session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="8fe27-172">Rimozione temporanea di sessioni di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="8fe27-172">Temporarily Removing Authorization Sessions</span></span>

    <span data-ttu-id="8fe27-173">Quando si rimuove una sessione di autorizzazione dal TPM per creare spazio per una nuova entità, TBS esegue TPM \_ SaveContext o TPM2 \_ ContextSave in tale sessione di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-173">When evicting an authorization session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext or TPM2\_ContextSave on that authorization session.</span></span>

-   <span data-ttu-id="8fe27-174">Ripristino di sessioni di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="8fe27-174">Restoring Authorization Sessions</span></span>

    <span data-ttu-id="8fe27-175">Quando un comando TPM autorizzato viene inviato a TBS, la TBS garantisce che tutte le sessioni di autorizzazione virtuali a cui viene fatto riferimento nel comando siano fisicamente presenti sul TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-175">When an authorized TPM command is submitted to the TBS, the TBS ensures that all virtual authorization sessions referred to in the command are physically present on the TPM.</span></span> <span data-ttu-id="8fe27-176">Se una delle sessioni di autorizzazione non è presente, TBS le ripristina con una chiamata a TPM \_ LoadContext o TPM2 \_ ContextLoad.</span><span class="sxs-lookup"><span data-stu-id="8fe27-176">If any of the authorization sessions are not present, the TBS restores them with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="8fe27-177">Se una sessione di autorizzazione non può essere ripristinata nel TPM, TBS restituisce \_ un \_ handle non valido TPM e \_ come risultato del TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-177">If an authorization session cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_HANDLE as the TPM result.</span></span>

<span data-ttu-id="8fe27-178">TBS sostituisce ogni handle virtuale associato a una sessione di autorizzazione in un flusso di comandi con l'handle fisico della sessione di autorizzazione caricata nel TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-178">The TBS replaces each virtual handle associated with an authorization session in a command stream with the physical handle of the authorization session loaded on the TPM.</span></span>

<span data-ttu-id="8fe27-179">Se un comando viene inviato con un handle virtuale non riconosciuto da TBS nel contesto del chiamante, TBS formatta un flusso di errore per il chiamante con l'handle di errore TPM \_ E non \_ valido \_ .</span><span class="sxs-lookup"><span data-stu-id="8fe27-179">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with the error TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="transport-sessions"></a><span data-ttu-id="8fe27-180">Sessioni di trasporto</span><span class="sxs-lookup"><span data-stu-id="8fe27-180">Transport Sessions</span></span>

> [!Note]  
> <span data-ttu-id="8fe27-181">La gestione delle sessioni di trasporto, come descritto di seguito, è specifica di Windows Vista e Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="8fe27-181">The handling of transport sessions as described here is specific to Windows Vista and Windows Server 2008.</span></span>

 

<span data-ttu-id="8fe27-182">Le sessioni di trasporto sono un meccanismo fornito dal TPM che consente a uno stack software di crittografare i dati in un comando mentre passano tra il software e il TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-182">Transport sessions are a mechanism provided by the TPM that enables a software stack to encrypt data in a command as it passes between the software and the TPM.</span></span> <span data-ttu-id="8fe27-183">In questo modo si impedisce a un antagonista di intercettare i dati mentre passano sul bus hardware.</span><span class="sxs-lookup"><span data-stu-id="8fe27-183">This prevents an adversary from intercepting the data as it passes over the hardware bus.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="8fe27-184">Vengono crittografati solo i dati del payload.</span><span class="sxs-lookup"><span data-stu-id="8fe27-184">Only the payload data is encrypted.</span></span> <span data-ttu-id="8fe27-185">I comandi eseguiti possono comunque essere identificati.</span><span class="sxs-lookup"><span data-stu-id="8fe27-185">The commands being executed can still be identified.</span></span>

 

<span data-ttu-id="8fe27-186">Sfortunatamente, questo meccanismo impedisce anche a TBS di esaminare i dati del payload.</span><span class="sxs-lookup"><span data-stu-id="8fe27-186">Unfortunately, this mechanism also prevents the TBS from examining payload data.</span></span> <span data-ttu-id="8fe27-187">Nella maggior parte dei casi non si tratta di un problema perché TBS modifica solo gli handle, non i dati del payload.</span><span class="sxs-lookup"><span data-stu-id="8fe27-187">In most cases this is not an issue because the TBS only modifies handles, not payload data.</span></span> <span data-ttu-id="8fe27-188">Tuttavia, nel caso di LoadContext TPM \_ , l'handle di risorsa restituito viene coperto dalla crittografia.</span><span class="sxs-lookup"><span data-stu-id="8fe27-188">However, in the case of TPM\_LoadContext for instance, the returned resource handle is covered by the encryption.</span></span> <span data-ttu-id="8fe27-189">Pertanto, TBS impedisce ai tentativi di eseguire un' \_ operazione LOADCONTEXT TPM coperta da una sessione di trasporto.</span><span class="sxs-lookup"><span data-stu-id="8fe27-189">Therefore, the TBS prevents attempts to perform a TPM\_LoadContext operation covered by a transport session.</span></span>

<span data-ttu-id="8fe27-190">TBS blocca i comandi seguenti nella sessione di trasporto:</span><span class="sxs-lookup"><span data-stu-id="8fe27-190">The TBS blocks the following commands under transport session:</span></span>

-   <span data-ttu-id="8fe27-191">\_ESTABLISHTRANSPORT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-191">TPM\_EstablishTransport</span></span>
-   <span data-ttu-id="8fe27-192">\_EXECUTETRANSPORT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-192">TPM\_ExecuteTransport</span></span>
-   <span data-ttu-id="8fe27-193">\_Handle di terminazione TPM \_</span><span class="sxs-lookup"><span data-stu-id="8fe27-193">TPM\_Terminate\_Handle</span></span>
-   <span data-ttu-id="8fe27-194">\_LOADKEY TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-194">TPM\_LoadKey</span></span>
-   <span data-ttu-id="8fe27-195">\_EVICTKEY TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-195">TPM\_EvictKey</span></span>
-   <span data-ttu-id="8fe27-196">\_SAVEKEYCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-196">TPM\_SaveKeyContext</span></span>
-   <span data-ttu-id="8fe27-197">\_LOADKEYCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-197">TPM\_LoadKeyContext</span></span>
-   <span data-ttu-id="8fe27-198">\_SAVEAUTHCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-198">TPM\_SaveAuthContext</span></span>
-   <span data-ttu-id="8fe27-199">\_LOADAUTHCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-199">TPM\_LoadAuthContext</span></span>
-   <span data-ttu-id="8fe27-200">\_SAVECONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-200">TPM\_SaveContext</span></span>
-   <span data-ttu-id="8fe27-201">\_LOADCONTEXT TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-201">TPM\_LoadContext</span></span>
-   <span data-ttu-id="8fe27-202">\_FLUSHSPECIFIC TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-202">TPM\_FlushSpecific</span></span>

<span data-ttu-id="8fe27-203">Quando uno di questi comandi è coperto da una sessione di trasporto, TBS restituisce il \_ comando TPM E \_ Embedded non \_ \_ supportato come risultato del TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-203">When any one of these commands is covered by a transport session, the TBS returns TPM\_E\_EMBEDDED\_COMMAND\_UNSUPPORTED as the TPM result.</span></span>

<span data-ttu-id="8fe27-204">Gli handle di sessione di trasporto vengono virtualizzati in modo analogo agli handle di chiave e agli handle di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="8fe27-204">Transport session handles are virtualized in a manner similar to key handles and authorization handles.</span></span> <span data-ttu-id="8fe27-205">Nel TPM è disponibile un numero limitato di slot del contesto di sessione di trasporto salvati.</span><span class="sxs-lookup"><span data-stu-id="8fe27-205">There are a limited number of saved transport session context slots available on the TPM.</span></span>

<span data-ttu-id="8fe27-206">TBS invalida la sessione di trasporto virtuale se si verifica uno dei casi seguenti:</span><span class="sxs-lookup"><span data-stu-id="8fe27-206">The TBS invalidates the virtual transport session if any of the following cases occurs:</span></span>

-   <span data-ttu-id="8fe27-207">Il flag di utilizzo continuo associato alla sessione di trasporto nel flusso del comando restituito dal TPM è **false**.</span><span class="sxs-lookup"><span data-stu-id="8fe27-207">The continue-use flag associated with the transport session in the return command stream from the TPM is **FALSE**.</span></span>

    <span data-ttu-id="8fe27-208">Come per le sessioni di autorizzazione precedenti, TBS Risincronizza automaticamente le sessioni di trasporto dopo l'esecuzione corretta di determinati comandi non deterministici per garantire che lo stato di TBS rimanga coerente con lo stato del TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-208">As with authorization sessions above, the TBS will automatically resynchronize transport sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="8fe27-209">I comandi interessati sono:</span><span class="sxs-lookup"><span data-stu-id="8fe27-209">The affected commands are:</span></span>

    -   <span data-ttu-id="8fe27-210">\_Gestione del \_ delegato di \_ gestione del TPM</span><span class="sxs-lookup"><span data-stu-id="8fe27-210">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="8fe27-211">\_ \_ CreateOwnerDelegation delegato dell'ORD TPM \_</span><span class="sxs-lookup"><span data-stu-id="8fe27-211">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="8fe27-212">\_ \_ LoadOwnerDelegation delegato dell'ORD TPM \_</span><span class="sxs-lookup"><span data-stu-id="8fe27-212">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="8fe27-213">In ognuno di questi casi, la sessione di trasporto nel TPM verrà scaricata automaticamente dal TPM:</span><span class="sxs-lookup"><span data-stu-id="8fe27-213">In each of these cases, the transport session on the TPM will be flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="8fe27-214">Creazione di sessioni di trasporto</span><span class="sxs-lookup"><span data-stu-id="8fe27-214">Creating Transport Sessions</span></span>

    <span data-ttu-id="8fe27-215">TBS crea un handle virtuale per ogni sessione di trasporto creata da un client.</span><span class="sxs-lookup"><span data-stu-id="8fe27-215">The TBS creates a virtual handle for each transport session created by a client.</span></span> <span data-ttu-id="8fe27-216">Gli handle di trasporto virtuali sono validi solo nel contesto che li ha creati e le risorse associate non vengono mantenute oltre la durata del contesto associato.</span><span class="sxs-lookup"><span data-stu-id="8fe27-216">Virtual transport handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="8fe27-217">Cancellazione delle sessioni di trasporto</span><span class="sxs-lookup"><span data-stu-id="8fe27-217">Clearing Transport Sessions</span></span>

    <span data-ttu-id="8fe27-218">TBS invalida la sessione di trasporto virtuale se riceve un \_ comando TPM FlushSpecific per l'handle virtuale dal contesto client.</span><span class="sxs-lookup"><span data-stu-id="8fe27-218">The TBS invalidates the virtual transport session if it receives a TPM\_FlushSpecific command for the virtual handle from the client context.</span></span> <span data-ttu-id="8fe27-219">Se la sessione di trasporto è fisicamente presente nel TPM quando viene ricevuto il comando di scaricamento, TBS Scarica immediatamente la sessione fisica dal TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-219">If the transport session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="8fe27-220">Rimozione temporanea di sessioni di trasporto</span><span class="sxs-lookup"><span data-stu-id="8fe27-220">Temporarily Removing Transport Sessions</span></span>

    <span data-ttu-id="8fe27-221">Quando si rimuove una sessione di trasporto dal TPM per creare spazio per una nuova entità, TBS esegue \_ SAVECONTEXT TPM in tale sessione di trasporto.</span><span class="sxs-lookup"><span data-stu-id="8fe27-221">When evicting a transport session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext on that transport session.</span></span>

-   <span data-ttu-id="8fe27-222">Ripristino di sessioni di trasporto</span><span class="sxs-lookup"><span data-stu-id="8fe27-222">Restoring Transport Sessions</span></span>

    <span data-ttu-id="8fe27-223">Quando un \_ comando TPM ExecuteTransport viene inviato a TBS, TBS garantisce che la sessione di trasporto a cui viene fatto riferimento nel comando sia fisicamente presente sul TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-223">When a TPM\_ExecuteTransport command is submitted to the TBS, the TBS ensures that the transport session referred to in the command is physically present on the TPM.</span></span> <span data-ttu-id="8fe27-224">Se la sessione di trasporto non è presente, TBS lo ripristina con una chiamata a TPM \_ LoadContext.</span><span class="sxs-lookup"><span data-stu-id="8fe27-224">If the transport session is not present, the TBS restores it with a call to TPM\_LoadContext.</span></span>

<span data-ttu-id="8fe27-225">TBS sostituisce l'handle virtuale associato alla sessione di trasporto in un flusso di comandi con l'handle fisico della sessione di trasporto caricata nel TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-225">The TBS replaces the virtual handle associated with the transport session in a command stream with the physical handle of the transport session loaded on the TPM.</span></span> <span data-ttu-id="8fe27-226">Se un comando viene inviato con un handle virtuale non riconosciuto da TBS nel contesto del chiamante, TBS formatta un flusso di errore per il chiamante utilizzando un \_ handle TPM E non \_ valido \_ .</span><span class="sxs-lookup"><span data-stu-id="8fe27-226">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller by using TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="exclusive-transport-sessions"></a><span data-ttu-id="8fe27-227">Sessioni di trasporto esclusive</span><span class="sxs-lookup"><span data-stu-id="8fe27-227">Exclusive Transport Sessions</span></span>

<span data-ttu-id="8fe27-228">Le sessioni di trasporto con wrapper esclusivo consentono al software di primo livello di determinare se un altro software ha eseguito l'accesso al TPM durante una catena di comandi.</span><span class="sxs-lookup"><span data-stu-id="8fe27-228">Exclusive wrapped transport sessions are a way for top-level software to determine whether any other software has accessed the TPM during a chain of commands.</span></span> <span data-ttu-id="8fe27-229">Poiché non impediscono l'accesso al TPM da parte di altri software, forniscono solo al creatore della sessione di trasporto un metodo per determinare se si è verificato un altro accesso.</span><span class="sxs-lookup"><span data-stu-id="8fe27-229">They do not prevent other software from accessing the TPM, they just give the creator of the transport session a means of determining that some other access occurred.</span></span> <span data-ttu-id="8fe27-230">TBS non esegue operazioni specifiche per ostacolare le sessioni di trasporto esclusive, ma è incompatibile.</span><span class="sxs-lookup"><span data-stu-id="8fe27-230">The TBS does not do anything specific to hinder exclusive transport sessions, but it is somewhat incompatible with them.</span></span> <span data-ttu-id="8fe27-231">TBS tenta di duplicare il comportamento naturale del TPM grazie alla trasparenza, quindi non predilige i comandi dei contesti che stabiliscono una sessione di trasporto esclusiva.</span><span class="sxs-lookup"><span data-stu-id="8fe27-231">The TBS attempts to duplicate the natural behavior of the TPM by being transparent, so it does not favor commands from contexts that establish an exclusive transport session.</span></span> <span data-ttu-id="8fe27-232">Se, ad esempio, il client B invia un comando quando il client A si trova in una sessione di trasporto esclusiva, invalida la sessione di trasporto esclusiva del client A.</span><span class="sxs-lookup"><span data-stu-id="8fe27-232">For example, if client B submits a command when client A is in an exclusive transport session, then it will invalidate the exclusive transport session of client A.</span></span>

<span data-ttu-id="8fe27-233">I comandi avviati da TBS possono anche terminare la sessione di trasporto esclusivo.</span><span class="sxs-lookup"><span data-stu-id="8fe27-233">Commands initiated by TBS can also terminate the exclusive transport session.</span></span> <span data-ttu-id="8fe27-234">Questo errore si verifica quando il client A si trova in una sessione di trasporto esclusiva e un comando eseguito dal client A chiama una risorsa che non è fisicamente presente nel TPM.</span><span class="sxs-lookup"><span data-stu-id="8fe27-234">This happens when client A is in an exclusive transport session, and a command executed by client A calls for a resource that is not physically present in the TPM.</span></span> <span data-ttu-id="8fe27-235">Questa situazione attiva il gestore della virtualizzazione di TBS per eseguire un \_ comando TPM LoadContext per fornire tale risorsa, che termina la sessione di trasporto esclusiva del client a.</span><span class="sxs-lookup"><span data-stu-id="8fe27-235">This situation triggers the TBS virtualization manager to execute a TPM\_LoadContext command to supply that resource, which terminates the exclusive transport session of client A.</span></span>

 

 




