---
title: Architettura e componenti
description: Questo argomento descrive i componenti che costituiscono Microsoft DirectComposition.
ms.assetid: 7C79B330-41EA-4BA0-9103-BB5A0C3D4CE2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb2de495aa170560b1e7082cacf1893a8c94905a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/20/2020
ms.locfileid: "104047178"
---
# <a name="architecture-and-components"></a><span data-ttu-id="d057c-103">Architettura e componenti</span><span class="sxs-lookup"><span data-stu-id="d057c-103">Architecture and components</span></span>

> [!NOTE]
> <span data-ttu-id="d057c-104">Per le app in Windows 10, è consigliabile usare le API Windows. UI. Composition anziché DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="d057c-104">For apps on Windows 10, we recommend using Windows.UI.Composition APIs instead of DirectComposition.</span></span> <span data-ttu-id="d057c-105">Per altre informazioni, vedere [modernizzare l'app desktop usando il livello visivo](/windows/uwp/composition/visual-layer-in-desktop-apps).</span><span class="sxs-lookup"><span data-stu-id="d057c-105">For more info, see [Modernize your desktop app using the Visual layer](/windows/uwp/composition/visual-layer-in-desktop-apps).</span></span>

<span data-ttu-id="d057c-106">Questo argomento descrive i componenti che costituiscono Microsoft DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="d057c-106">This topic describes the components that make up Microsoft DirectComposition.</span></span> <span data-ttu-id="d057c-107">È costituito dalle seguenti sezioni.</span><span class="sxs-lookup"><span data-stu-id="d057c-107">It consists of the following sections.</span></span>

-   [<span data-ttu-id="d057c-108">Componenti software</span><span class="sxs-lookup"><span data-stu-id="d057c-108">Software components</span></span>](#software-components)
-   [<span data-ttu-id="d057c-109">Libreria di applicazioni</span><span class="sxs-lookup"><span data-stu-id="d057c-109">Application library</span></span>](#application-library)
-   [<span data-ttu-id="d057c-110">Motore di composizione</span><span class="sxs-lookup"><span data-stu-id="d057c-110">Composition engine</span></span>](#composition-engine)
-   [<span data-ttu-id="d057c-111">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="d057c-111">Related topics</span></span>](#related-topics)

## <a name="software-components"></a><span data-ttu-id="d057c-112">Componenti software</span><span class="sxs-lookup"><span data-stu-id="d057c-112">Software components</span></span>

<span data-ttu-id="d057c-113">DirectComposition è costituito dai componenti software principali seguenti.</span><span class="sxs-lookup"><span data-stu-id="d057c-113">DirectComposition consists of the following main software components.</span></span>

-   <span data-ttu-id="d057c-114">Una libreria di applicazioni in modalità utente (dcomp.dll) che implementa l'API pubblica basata su Component Object Model (COM).</span><span class="sxs-lookup"><span data-stu-id="d057c-114">A user-mode application library (dcomp.dll) that implements the Component Object Model (COM)-based public API.</span></span>
-   <span data-ttu-id="d057c-115">Un motore di composizione in modalità utente (dwmcore.dll) ospitato nel processo di Gestione finestre desktop (DWM) (dwm.exe) ed esegue l'effettiva composizione desktop.</span><span class="sxs-lookup"><span data-stu-id="d057c-115">A user-mode composition engine (dwmcore.dll) that is hosted in the Desktop Window Manager (DWM) process (dwm.exe), and performs the actual desktop composition.</span></span>
-   <span data-ttu-id="d057c-116">Un database di oggetti in modalità kernel (parte di win32k.sys) che esegue il marshalling dei comandi dall'applicazione al motore di composizione.</span><span class="sxs-lookup"><span data-stu-id="d057c-116">A kernel-mode object database (part of win32k.sys) that marshals commands from the application to the composition engine.</span></span>

<span data-ttu-id="d057c-117">Una singola istanza del motore di composizione gestisce gli alberi della composizione DirectComposition per tutte le applicazioni e l'albero di composizione DWM, che rappresenta l'intero desktop.</span><span class="sxs-lookup"><span data-stu-id="d057c-117">A single instance of the composition engine handles the DirectComposition composition trees for all applications and the DWM composition tree, which represents the entire desktop.</span></span> <span data-ttu-id="d057c-118">Viene creata un'istanza del database di oggetti in modalità kernel e del motore di composizione in modalità utente una volta per sessione, pertanto un computer Terminal Server con più utenti ha più istanze di entrambi i componenti.</span><span class="sxs-lookup"><span data-stu-id="d057c-118">Both the kernel-mode object database and the user-mode composition engine are instantiated once per session, so a Terminal Server machine with multiple users has multiple instances of both of those components.</span></span>

<span data-ttu-id="d057c-119">Il diagramma seguente illustra i componenti principali di DirectComposition e il modo in cui sono correlati tra loro.</span><span class="sxs-lookup"><span data-stu-id="d057c-119">The following diagram shows the main DirectComposition components and how they relate to one another.</span></span>

![architettura di primo livello di DirectComposition](images/directcomposition-top-level-architecture.png)

## <a name="application-library"></a><span data-ttu-id="d057c-121">Libreria di applicazioni</span><span class="sxs-lookup"><span data-stu-id="d057c-121">Application library</span></span>

<span data-ttu-id="d057c-122">La libreria di applicazioni DirectComposition è un'API pubblica basata su COM con un singolo punto di ingresso flat che viene esportato da dcomp.dll e restituisce un puntatore a interfaccia a un oggetto dispositivo.</span><span class="sxs-lookup"><span data-stu-id="d057c-122">The DirectComposition application library is a public COM-based API with a single flat entry-point that is exported from dcomp.dll and returns an interface pointer to a device object.</span></span> <span data-ttu-id="d057c-123">L'oggetto dispositivo, a sua volta, dispone di metodi per la creazione di tutti gli altri oggetti, ognuno dei quali è rappresentato da un puntatore a interfaccia.</span><span class="sxs-lookup"><span data-stu-id="d057c-123">The device object, in turn, has methods for creating all other objects, each of which is represented by an interface pointer.</span></span> <span data-ttu-id="d057c-124">Tutte le interfacce DirectComposition ereditano da e implementano completamente l'interfaccia [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="d057c-124">All DirectComposition interfaces inherit from and fully implement the [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="d057c-125">Tutti i metodi che accettano le interfacce DirectComposition controllano se l'interfaccia è implementata all'interno di dcomp.dll o se è implementata da un altro componente.</span><span class="sxs-lookup"><span data-stu-id="d057c-125">All methods that accept DirectComposition interfaces check whether the interface is implemented inside of dcomp.dll or whether it is implemented by another component.</span></span> <span data-ttu-id="d057c-126">Poiché DirectComposition non è estensibile, i metodi che accettano le interfacce come parametri restituiscono E \_ INVALIDARG se le interfacce non sono implementate in dcomp.dll.</span><span class="sxs-lookup"><span data-stu-id="d057c-126">Because DirectComposition is not extensible, methods that take interfaces as parameters return E\_INVALIDARG if the interfaces are not implemented in dcomp.dll.</span></span> <span data-ttu-id="d057c-127">L'API non richiede privilegi speciali. può essere chiamato da processi in esecuzione al livello di accesso più basso.</span><span class="sxs-lookup"><span data-stu-id="d057c-127">The API requires no special privileges; it can be called by processes running at the lowest level of access.</span></span> <span data-ttu-id="d057c-128">Tuttavia, poiché l'API non funziona nella sessione 0, non è adatta per i servizi.</span><span class="sxs-lookup"><span data-stu-id="d057c-128">However, because the API does not operate in session 0, it is not suitable for services.</span></span> <span data-ttu-id="d057c-129">In questi aspetti, l'API DirectComposition è simile ad altre API Microsoft DirectX, in particolare Direct2D, Microsoft Direct3D e Microsoft DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="d057c-129">In these respects, the DirectComposition API is similar to other Microsoft DirectX APIs, most notably Direct2D, Microsoft Direct3D, and Microsoft DirectWrite.</span></span>

<span data-ttu-id="d057c-130">Poiché il motore di composizione è progettato esclusivamente per l'esecuzione asincrona, le proprietà dell'oggetto nell'API DirectComposition sono di sola scrittura.</span><span class="sxs-lookup"><span data-stu-id="d057c-130">Because the composition engine is designed exclusively for asynchronous execution, object properties in the DirectComposition API are write-only.</span></span> <span data-ttu-id="d057c-131">Tutte le proprietà hanno metodi setter, ma non metodi Get.</span><span class="sxs-lookup"><span data-stu-id="d057c-131">All properties have setter methods, but not getter methods.</span></span> <span data-ttu-id="d057c-132">La lettura delle proprietà non solo comporta un utilizzo intensivo delle risorse, ma può anche essere imprecisa perché qualsiasi valore restituito dal motore di composizione può diventare immediatamente non valido.</span><span class="sxs-lookup"><span data-stu-id="d057c-132">Reading properties is not only resource intensive, but can also be inaccurate because any value that the composition engine returns can immediately become invalid.</span></span> <span data-ttu-id="d057c-133">Questo problema può verificarsi se, ad esempio, un'animazione indipendente viene associata alla proprietà che viene letta.</span><span class="sxs-lookup"><span data-stu-id="d057c-133">This can happen if, for example, an independent animation is bound to the property that is being read.</span></span>

<span data-ttu-id="d057c-134">L'API è thread-safe.</span><span class="sxs-lookup"><span data-stu-id="d057c-134">The API is thread-safe.</span></span> <span data-ttu-id="d057c-135">Un'applicazione può chiamare qualsiasi metodo da qualsiasi thread in qualsiasi momento.</span><span class="sxs-lookup"><span data-stu-id="d057c-135">An application can call any method from any thread at any time.</span></span> <span data-ttu-id="d057c-136">Tuttavia, poiché molti metodi API devono essere chiamati in una determinata sequenza, senza alcuna sincronizzazione, un'applicazione può riscontrare un comportamento imprevedibile a seconda della modalità di interfoliazione dei thread.</span><span class="sxs-lookup"><span data-stu-id="d057c-136">However, because many API methods must be called in a particular sequence, without any synchronization an application can experience unpredictable behavior depending on how the threads interleave.</span></span> <span data-ttu-id="d057c-137">Se, ad esempio, due thread modificano contemporaneamente la stessa proprietà dello stesso oggetto con valori diversi, l'applicazione non è in grado di stimare quale dei due valori sarà il valore finale della proprietà.</span><span class="sxs-lookup"><span data-stu-id="d057c-137">For example, if two threads change the same property of the same object to different values at the same time, the application cannot predict which of the two values will be the final value of the property.</span></span> <span data-ttu-id="d057c-138">Analogamente, se due thread chiamano [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) sullo stesso dispositivo, nessuno dei due thread ottiene un comportamento transazionale perché una chiamata al **commit** in un thread invierà il batch di tutti i comandi emessi da entrambi i thread, non solo quello che ha chiamato **commit**.</span><span class="sxs-lookup"><span data-stu-id="d057c-138">Similarly, if two threads call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) on the same device, neither thread gets truly transactional behavior because a call to **Commit** on one thread will submit the batch of all commands issued by both threads, not just the one that called **Commit**.</span></span>

<span data-ttu-id="d057c-139">Il sistema gestisce tutto lo stato interno per ogni oggetto dispositivo.</span><span class="sxs-lookup"><span data-stu-id="d057c-139">The system maintains all internal state per device object.</span></span> <span data-ttu-id="d057c-140">Se un'applicazione crea due o più oggetti dispositivo DirectComposition, l'applicazione può mantenere batch indipendenti e altro stato tra i due.</span><span class="sxs-lookup"><span data-stu-id="d057c-140">If an application creates two or more DirectComposition device objects, the application can maintain independent batches and other state between the two.</span></span>

<span data-ttu-id="d057c-141">Tutti gli oggetti DirectComposition hanno affinità oggetto dispositivo; gli oggetti creati da un particolare oggetto dispositivo possono essere usati solo con tale oggetto dispositivo e possono essere associati solo ad altri oggetti creati dallo stesso oggetto dispositivo.</span><span class="sxs-lookup"><span data-stu-id="d057c-141">All DirectComposition objects have device object affinity; objects created by a particular device object can be used only with that device object, and can be associated only with other objects created by the same device object.</span></span> <span data-ttu-id="d057c-142">In altre parole, ogni oggetto dispositivo è un'isola disgiunta separata di funzionalità.</span><span class="sxs-lookup"><span data-stu-id="d057c-142">In other words, each device object is a separate disjoint island of functionality.</span></span> <span data-ttu-id="d057c-143">L'unica eccezione è rappresentata dalla classe visiva, che consente la compilazione di alberi visivi in cui un oggetto visivo può appartenere a un oggetto dispositivo diverso rispetto al relativo elemento padre.</span><span class="sxs-lookup"><span data-stu-id="d057c-143">The one exception is the visual class, which permits the building of visual trees where a visual can belong to a different device object than its parent.</span></span> <span data-ttu-id="d057c-144">Questo consente scenari in cui un'applicazione e un controllo possono gestire un singolo albero di composizione senza che sia necessario condividere un singolo oggetto dispositivo DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="d057c-144">This enables scenarios where an application and a control can manage a single composition tree without also needing to share a single DirectComposition device object.</span></span>

## <a name="composition-engine"></a><span data-ttu-id="d057c-145">Motore di composizione</span><span class="sxs-lookup"><span data-stu-id="d057c-145">Composition engine</span></span>

<span data-ttu-id="d057c-146">Il motore di composizione DirectComposition viene eseguito su un processo dedicato, separato da qualsiasi processo dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d057c-146">The DirectComposition composition engine runs on a dedicated process, separate from any application process.</span></span> <span data-ttu-id="d057c-147">Un singolo processo di composizione, dwm.exe, supporta tutte le applicazioni in una sessione.</span><span class="sxs-lookup"><span data-stu-id="d057c-147">A single composition process, dwm.exe, supports every application in a session.</span></span> <span data-ttu-id="d057c-148">Ogni applicazione può creare due alberi visivi per ogni finestra di cui è proprietario.</span><span class="sxs-lookup"><span data-stu-id="d057c-148">Each application can create two visual trees for each window that it owns.</span></span> <span data-ttu-id="d057c-149">Tutti gli alberi vengono effettivamente implementati come sottoalberi di una struttura ad albero visuale più ampia che include anche le strutture di composizione di DWM.</span><span class="sxs-lookup"><span data-stu-id="d057c-149">All of the trees are actually implemented as subtrees of a larger visual tree that also encompasses the composition structures of DWM.</span></span> <span data-ttu-id="d057c-150">DWM crea una struttura ad albero visuale di grandi dimensioni per ogni desktop in una sessione.</span><span class="sxs-lookup"><span data-stu-id="d057c-150">The DWM constructs one large visual tree for each desktop in a session.</span></span> <span data-ttu-id="d057c-151">Ecco i vantaggi principali di questa architettura:</span><span class="sxs-lookup"><span data-stu-id="d057c-151">Here are the key advantages to this architecture:</span></span>

-   <span data-ttu-id="d057c-152">Il motore di composizione ha accesso a tutte le bitmap dell'applicazione e ad alberi visivi, che consente l'interoperabilità e la composizione della finestra tra processi.</span><span class="sxs-lookup"><span data-stu-id="d057c-152">The composition engine has access to all application bitmaps and visual trees, which enables cross-process window interoperability and composition.</span></span>
-   <span data-ttu-id="d057c-153">Il motore di composizione viene eseguito in un processo di sistema attendibile separato da qualsiasi processo dell'applicazione, consentendo alle applicazioni con diritti di accesso limitati di comporre in modo sicuro il contenuto protetto.</span><span class="sxs-lookup"><span data-stu-id="d057c-153">The composition engine runs in a trusted system process that is separate from any application process, enabling applications that have low access rights to securely compose protected content.</span></span>
-   <span data-ttu-id="d057c-154">Il motore di composizione può rilevare quando una particolare finestra è completamente nascosto ed evitare di sprecare risorse della CPU e della GPU (Graphics Processing Unit) che compongono la finestra.</span><span class="sxs-lookup"><span data-stu-id="d057c-154">The composition engine can detect when a particular window is fully occluded and avoid wasting CPU and graphics processing unit (GPU) resources composing for the window.</span></span>
-   <span data-ttu-id="d057c-155">Il motore di composizione può comporre direttamente sul buffer indietro, evitando la necessità di una copia aggiuntiva necessaria per i motori di composizione per processo.</span><span class="sxs-lookup"><span data-stu-id="d057c-155">The composition engine can compose directly to the screen back buffer, avoiding the need for an extra copy that is required for per-process composition engines.</span></span>
-   <span data-ttu-id="d057c-156">Tutte le applicazioni condividono un singolo dispositivo Direct3D per la composizione, che offre un notevole risparmio di memoria</span><span class="sxs-lookup"><span data-stu-id="d057c-156">All applications share a single Direct3D device for composition, which offers considerable memory savings</span></span>

<span data-ttu-id="d057c-157">La struttura ad albero visuale è una struttura mantenuta.</span><span class="sxs-lookup"><span data-stu-id="d057c-157">The visual tree is a retained structure.</span></span> <span data-ttu-id="d057c-158">L'API DirectComposition espone metodi per modificare la struttura in batch di modifiche elaborate atomicamente.</span><span class="sxs-lookup"><span data-stu-id="d057c-158">The DirectComposition API exposes methods to edit the structure in batches of changes that are processed atomically.</span></span> <span data-ttu-id="d057c-159">L'oggetto radice nell'API DirectComposition è l'oggetto dispositivo, che funge da Factory per tutti gli altri oggetti DirectComposition e contiene un metodo denominato [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span><span class="sxs-lookup"><span data-stu-id="d057c-159">The root object in the DirectComposition API is the device object, which serves as the factory for all other DirectComposition objects and contains a method called [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span></span> <span data-ttu-id="d057c-160">Il motore di composizione non riflette le modifiche apportate dall'applicazione alla struttura ad albero visuale fino a quando l'applicazione chiama **commit**. a questo punto tutte le modifiche apportate dall'ultimo **commit** vengono elaborate come una singola transazione.</span><span class="sxs-lookup"><span data-stu-id="d057c-160">The composition engine does not reflect any changes that the application makes to the visual tree until the application calls **Commit**, at which point all changes since the last **Commit** are processed as a single transaction.</span></span>

<span data-ttu-id="d057c-161">Il requisito per chiamare [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) è simile al concetto di "frame", ad eccezione del fatto che, poiché il motore di composizione viene eseguito in modo asincrono, può presentare più frame diversi tra le chiamate al **commit**.</span><span class="sxs-lookup"><span data-stu-id="d057c-161">The requirement to call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) is similar to the concept of a "frame" except that, because the composition engine runs asynchronously, it can present several different frames between calls to **Commit**.</span></span> <span data-ttu-id="d057c-162">In DirectComposition, un *frame* è una singola iterazione del motore di composizione e l'intervallo impiegato da un'applicazione tra due chiamate al **commit** viene chiamato *batch*.</span><span class="sxs-lookup"><span data-stu-id="d057c-162">In DirectComposition, a *frame* is a single iteration of the composition engine, and the interval spent by an application between two calls to **Commit** is called a *batch*.</span></span>

<span data-ttu-id="d057c-163">DirectComposition esegue il batch di tutte le chiamate dell'applicazione all'API DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="d057c-163">DirectComposition batches all application calls to the DirectComposition API.</span></span> <span data-ttu-id="d057c-164">Il database dell'oggetto kernel, implementato nel driver della sessione di win32k.sys, archivia tutte le informazioni sullo stato associate alle chiamate API.</span><span class="sxs-lookup"><span data-stu-id="d057c-164">The kernel object database, which is implemented in the win32k.sys session driver, stores all state information that is associated with the API calls.</span></span>

<span data-ttu-id="d057c-165">Il motore di composizione produce un frame per ogni vuoto verticale nella visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="d057c-165">The composition engine produces one frame for each vertical blank in the display.</span></span> <span data-ttu-id="d057c-166">Il frame viene avviato in uno spazio vuoto verticale e viene indirizzato al successivo vuoto verticale.</span><span class="sxs-lookup"><span data-stu-id="d057c-166">The frame is started at a vertical blank and targets the subsequent vertical blank.</span></span> <span data-ttu-id="d057c-167">All'avvio del frame, il motore di composizione preleva tutti i batch in sospeso e include i comandi in tale frame.</span><span class="sxs-lookup"><span data-stu-id="d057c-167">When the frame starts, the composition engine picks up all pending batches and includes their commands in that frame.</span></span> <span data-ttu-id="d057c-168">I batch vengono inseriti in una coda in sospeso quando l'applicazione chiama [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit)e la coda in sospeso viene scaricata in modo atomico all'inizio del frame.</span><span class="sxs-lookup"><span data-stu-id="d057c-168">Batches are placed in a pending queue when the application calls [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), and the pending queue is flushed atomically at the beginning of the frame.</span></span> <span data-ttu-id="d057c-169">Pertanto, è presente un singolo momento che contrassegna l'inizio di un frame.</span><span class="sxs-lookup"><span data-stu-id="d057c-169">Therefore, there is a single point in time that marks the beginning of a frame.</span></span> <span data-ttu-id="d057c-170">Tutti i batch inviati prima di questo punto vengono inclusi nel frame, mentre tutti i batch inviati dopo devono attendere fino all'elaborazione del frame successivo.</span><span class="sxs-lookup"><span data-stu-id="d057c-170">Any batches submitted before this point are included in the frame, while any batches submitted after must wait until the next frame to be processed.</span></span> <span data-ttu-id="d057c-171">Il ciclo di composizione completo è il seguente:</span><span class="sxs-lookup"><span data-stu-id="d057c-171">The full composition loop is as follows:</span></span>

1.  <span data-ttu-id="d057c-172">Stimare l'ora del successivo vuoto verticale.</span><span class="sxs-lookup"><span data-stu-id="d057c-172">Estimate the time of the next vertical blank.</span></span>
2.  <span data-ttu-id="d057c-173">Recuperare tutti i batch in sospeso.</span><span class="sxs-lookup"><span data-stu-id="d057c-173">Retrieve all pending batches.</span></span>
3.  <span data-ttu-id="d057c-174">Elaborare i batch recuperati.</span><span class="sxs-lookup"><span data-stu-id="d057c-174">Process the retrieved batches.</span></span>
4.  <span data-ttu-id="d057c-175">Aggiornare tutte le animazioni usando il tempo stimato nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="d057c-175">Update all animations using the time estimated in step 1.</span></span>
5.  <span data-ttu-id="d057c-176">Determinare le aree della schermata che devono essere ricomposte.</span><span class="sxs-lookup"><span data-stu-id="d057c-176">Determine the regions of the screen that need to be re-composed.</span></span>
6.  <span data-ttu-id="d057c-177">Comporre di nuovo le aree dirty.</span><span class="sxs-lookup"><span data-stu-id="d057c-177">Re-compose the dirty regions.</span></span>
7.  <span data-ttu-id="d057c-178">Presentare il frame capovolgendo i buffer indietro e anteriore per ogni schermata.</span><span class="sxs-lookup"><span data-stu-id="d057c-178">Present the frame by flipping the back and front buffers for each screen.</span></span>
8.  <span data-ttu-id="d057c-179">Se non è stata eseguita alcuna operazione di composizione e presentazione nei passaggi 6 e 7, attendere il commit di un batch.</span><span class="sxs-lookup"><span data-stu-id="d057c-179">If nothing was composed and presented in steps 6 and 7, wait for a batch to be committed.</span></span>
9.  <span data-ttu-id="d057c-180">Attendere il successivo vuoto verticale.</span><span class="sxs-lookup"><span data-stu-id="d057c-180">Wait for the next vertical blank.</span></span>

<span data-ttu-id="d057c-181">Se sono presenti più monitoraggi collegati a una singola scheda video, il motore di composizione utilizza lo spazio vuoto verticale del monitor primario per guidare il ciclo di composizione e impostare i tempi di campionamento dell'animazione.</span><span class="sxs-lookup"><span data-stu-id="d057c-181">If there are multiple monitors attached to a single video adapter, the composition engine uses the vertical blank of the primary monitor to drive the composition loop and set the animation sampling times.</span></span> <span data-ttu-id="d057c-182">Ogni monitoraggio è rappresentato da una catena di Flip a schermo intero separata; il motore di composizione ripete i passaggi 6 e 7 per ogni monitoraggio, in modo Round Robin, usando un singolo dispositivo Direct3D.</span><span class="sxs-lookup"><span data-stu-id="d057c-182">Each monitor is represented by a separate full-screen flip chain; the composition engine repeats steps 6 and 7 for each monitor, in a round-robin fashion, using a single Direct3D device.</span></span> <span data-ttu-id="d057c-183">Se sono presenti anche più schede video, il motore di composizione usa un dispositivo Direct3D separato per ogni scheda video nei passaggi 6 e 7.</span><span class="sxs-lookup"><span data-stu-id="d057c-183">If there are also multiple video adapters, the composition engine uses a separate Direct3D device for each video adapter in steps 6 and 7.</span></span>

<span data-ttu-id="d057c-184">I frame di composizione sono pianificati per iniziare sempre in uno spazio vuoto verticale, come illustrato nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="d057c-184">Composition frames are scheduled to always start at a vertical blank, as the following illustration shows.</span></span>

![pianificazione del frame di composizione](images/composition-frame-scheduling.png)

<span data-ttu-id="d057c-186">Se il motore di composizione non ha alcuna operazione da eseguire perché l'albero della composizione non è stato modificato, il thread di composizione rimane in attesa di un nuovo batch.</span><span class="sxs-lookup"><span data-stu-id="d057c-186">If the composition engine has no work to do because the composition tree has not changed, the composition thread sleeps while waiting for a new batch.</span></span> <span data-ttu-id="d057c-187">Quando viene inviato un nuovo batch, il thread di composizione viene riattivato, ma viene immediatamente riavviato per la sospensione fino al successivo vuoto verticale.</span><span class="sxs-lookup"><span data-stu-id="d057c-187">When a new batch is submitted, the composition thread wakes up but immediately goes back to sleep until the next vertical blank.</span></span> <span data-ttu-id="d057c-188">Questo comportamento garantisce l'ora di inizio e di fine del frame prevedibile per le applicazioni e per il motore di composizione.</span><span class="sxs-lookup"><span data-stu-id="d057c-188">This behavior ensures predictable frame start and end times for applications and for the composition engine.</span></span>

<span data-ttu-id="d057c-189">Il motore di composizione pubblica i tempi di presentazione del frame e la frequenza dei fotogrammi corrente.</span><span class="sxs-lookup"><span data-stu-id="d057c-189">The composition engine publishes the frame presentation times and the current frame rate.</span></span> <span data-ttu-id="d057c-190">La pubblicazione di queste informazioni consente alle applicazioni di stimare il tempo di presentazione per i propri batch, che a sua volta consente la sincronizzazione delle animazioni.</span><span class="sxs-lookup"><span data-stu-id="d057c-190">Publishing this information enables applications to estimate the presentation time for their own batches, which in turns enables animations to be synchronized.</span></span> <span data-ttu-id="d057c-191">In particolare, un'applicazione può usare una combinazione di statistiche di frame dal motore di composizione e un modello cronologico del tempo impiegato dal thread dell'interfaccia utente per generare un batch, per determinare il tempo di campionamento per le proprie animazioni.</span><span class="sxs-lookup"><span data-stu-id="d057c-191">In particular, an application can use a combination of frame statistics from the composition engine, and a historical model of how long its UI thread takes to produce a batch, to determine the sampling time for its own animations.</span></span>

<span data-ttu-id="d057c-192">Ad esempio, all'inizio del batch di applicazioni illustrato nella figura precedente, l'applicazione può eseguire una query sul motore di composizione per determinare l'ora di presentazione esatta del frame successivo.</span><span class="sxs-lookup"><span data-stu-id="d057c-192">For example, at the beginning of the application batch shown in the previous illustration, the application can query the composition engine to determine the exact presentation time of the next frame.</span></span> <span data-ttu-id="d057c-193">L'applicazione può quindi usare l'ora corrente, insieme alle informazioni sui batch precedenti che ha prodotto, per determinare se l'applicazione può completare il batch corrente prima del successivo vuoto verticale.</span><span class="sxs-lookup"><span data-stu-id="d057c-193">The application can then use the current time, along with information about previous batches that it has produced, to determine whether the application can complete the current batch before the next vertical blank.</span></span> <span data-ttu-id="d057c-194">Pertanto, l'applicazione utilizza l'ora di presentazione del frame come tempo di campionamento per le proprie animazioni.</span><span class="sxs-lookup"><span data-stu-id="d057c-194">Therefore, the application uses the frame presentation time as the sampling time for its own animations.</span></span> <span data-ttu-id="d057c-195">Se l'applicazione determina che è improbabile che il suo lavoro venga completato nello spazio vuoto verticale corrente, l'applicazione può usare l'ora del frame successiva come tempo di campionamento, usando le informazioni sulla frequenza dei fotogrammi restituite dal motore di composizione per calcolare tale tempo.</span><span class="sxs-lookup"><span data-stu-id="d057c-195">If the application determines that it is unlikely to complete its work in the current vertical blank, the application can use the subsequent frame time as the sampling time instead, using the frame rate information returned by the composition engine to compute that time.</span></span>

## <a name="related-topics"></a><span data-ttu-id="d057c-196">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="d057c-196">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="d057c-197">Concetti di DirectComposition</span><span class="sxs-lookup"><span data-stu-id="d057c-197">DirectComposition Concepts</span></span>](directcomposition-concepts.md)
</dt> </dl>

 

 