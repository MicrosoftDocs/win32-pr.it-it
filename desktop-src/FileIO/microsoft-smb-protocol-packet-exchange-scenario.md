---
description: Esempio di scambio di pacchetti di protocollo SMB Microsoft tra un client e un server.
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Scenario di scambio di pacchetti del protocollo SMB Microsoft
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104343191"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a><span data-ttu-id="4bb07-103">Scenario di scambio di pacchetti del protocollo SMB Microsoft</span><span class="sxs-lookup"><span data-stu-id="4bb07-103">Microsoft SMB Protocol Packet Exchange Scenario</span></span>

<span data-ttu-id="4bb07-104">Questo argomento fornisce un esempio di scambio di pacchetti di protocollo SMB Microsoft tra un client e un server.</span><span class="sxs-lookup"><span data-stu-id="4bb07-104">This topic gives an example of a Microsoft SMB Protocol packet exchange between a client and a server.</span></span> <span data-ttu-id="4bb07-105">I passaggi seguenti sono una panoramica del processo:</span><span class="sxs-lookup"><span data-stu-id="4bb07-105">The following steps are an overview of the process:</span></span>

1.  <span data-ttu-id="4bb07-106">Il client e il server stabiliscono una sessione NetBIOS.</span><span class="sxs-lookup"><span data-stu-id="4bb07-106">The client and server establish a NetBIOS session.</span></span>
2.  <span data-ttu-id="4bb07-107">Il client e il server negoziano il dialetto del protocollo SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="4bb07-107">The client and server negotiate the Microsoft SMB Protocol dialect.</span></span>
3.  <span data-ttu-id="4bb07-108">Il client accede al server.</span><span class="sxs-lookup"><span data-stu-id="4bb07-108">The client logs on to the server.</span></span>
4.  <span data-ttu-id="4bb07-109">Il client si connette a una condivisione sul server.</span><span class="sxs-lookup"><span data-stu-id="4bb07-109">The client connects to a share on the server.</span></span>
5.  <span data-ttu-id="4bb07-110">Il client apre un file nella condivisione.</span><span class="sxs-lookup"><span data-stu-id="4bb07-110">The client opens a file on the share.</span></span>
6.  <span data-ttu-id="4bb07-111">Il client legge dal file.</span><span class="sxs-lookup"><span data-stu-id="4bb07-111">The client reads from the file.</span></span>

<span data-ttu-id="4bb07-112">In primo luogo, una connessione TCP full-duplex viene stabilita dal client con il server.</span><span class="sxs-lookup"><span data-stu-id="4bb07-112">First, a full-duplex TCP connection is established by the client with the server.</span></span> <span data-ttu-id="4bb07-113">Quindi, il client compila e invia un pacchetto di richiesta di sessione NetBIOS sulla connessione TCP.</span><span class="sxs-lookup"><span data-stu-id="4bb07-113">Then the client builds and sends a NetBIOS session request packet over the TCP connection.</span></span> <span data-ttu-id="4bb07-114">Se il pacchetto è stato formattato correttamente, il server restituisce un pacchetto contenente un messaggio che conferma che la sessione è stata stabilita.</span><span class="sxs-lookup"><span data-stu-id="4bb07-114">If the packet was formatted correctly, the server then returns a packet that contains a message acknowledging that the session has been established.</span></span> <span data-ttu-id="4bb07-115">Al termine di questa operazione, il client invia al server i pacchetti del primo protocollo SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="4bb07-115">After this, the client sends the first Microsoft SMB Protocol packets to the server.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="4bb07-116">**Pacchetto 1: \_ negoziazione com \_ SMB**</span><span class="sxs-lookup"><span data-stu-id="4bb07-116">**Packet 1:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="4bb07-117">**Direzione:** Da client a server</span><span class="sxs-lookup"><span data-stu-id="4bb07-117">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4bb07-118">**Descrizione:** Il client richiede che il server negozi il sottolinguaggio del protocollo SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="4bb07-118">**Description:** The client requests that the server negotiate the Microsoft SMB Protocol dialect.</span></span> <span data-ttu-id="4bb07-119">Un elenco di stringhe che identificano i dialetti con cui il client può lavorare è incluso nel pacchetto.</span><span class="sxs-lookup"><span data-stu-id="4bb07-119">A list of strings identifying the dialects that the client can work with is included in the packet.</span></span><br/>                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="4bb07-120">**Pacchetto 2: \_ negoziazione com \_ SMB**</span><span class="sxs-lookup"><span data-stu-id="4bb07-120">**Packet 2:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="4bb07-121">**Direzione:** Da server a client</span><span class="sxs-lookup"><span data-stu-id="4bb07-121">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4bb07-122">**Descrizione:** Il server risponde alla richiesta del client di identificare il dialetto del protocollo SMB Microsoft che verrà usato nella sessione.</span><span class="sxs-lookup"><span data-stu-id="4bb07-122">**Description:** The server responds to the client's request to identify the Microsoft SMB Protocol dialect that is going to be used in the session.</span></span> <span data-ttu-id="4bb07-123">Il pacchetto restituito include anche una stringa casuale a 8 byte che verrà usata nel passaggio successivo per autenticare il client durante il processo di accesso.</span><span class="sxs-lookup"><span data-stu-id="4bb07-123">The returned packet also includes an 8-byte random string that will be used in the next step to authenticate the client during the logon process.</span></span><br/>                                                                                                                                                                                                                                   |
| <span data-ttu-id="4bb07-124">**Pacchetto 3: \_ configurazione della \_ sessione com SMB \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4bb07-124">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-125">**Direzione:** Da client a server</span><span class="sxs-lookup"><span data-stu-id="4bb07-125">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4bb07-126">**Descrizione:** Questo pacchetto include informazioni sulle funzionalità client, quindi questo pacchetto deve essere inviato anche se il server ha implementato solo la sicurezza a livello di condivisione.</span><span class="sxs-lookup"><span data-stu-id="4bb07-126">**Description:** This packet includes information about client capabilities, so this packet must be sent even if the server has implemented only share-level security.</span></span><br/> <span data-ttu-id="4bb07-127">**Pacchetto 3: \_ configurazione della \_ sessione com SMB \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4bb07-127">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-128">**Direzione:** Da server a client</span><span class="sxs-lookup"><span data-stu-id="4bb07-128">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4bb07-129">**Descrizione:** Se la richiesta di verifica/risposta viene accettata dal server, nel pacchetto restituito al client viene incluso un UID valido.</span><span class="sxs-lookup"><span data-stu-id="4bb07-129">**Description:** If the challenge/response is accepted by the server, a valid UID is included in the packet that is returned to the client.</span></span> <span data-ttu-id="4bb07-130">Se non viene accettato, il server restituirà un codice di errore in questo pacchetto e negherà l'accesso.</span><span class="sxs-lookup"><span data-stu-id="4bb07-130">If it is not accepted, the server will return an error code in this packet and deny access.</span></span><br/> |
| <span data-ttu-id="4bb07-131">**Pacchetto 4: \_ albero com \_ SMB \_ Connect \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4bb07-131">**Packet 4:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-132">**Direzione:** Da client a server</span><span class="sxs-lookup"><span data-stu-id="4bb07-132">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4bb07-133">**Descrizione:** Il client richiede l'accesso alla condivisione.</span><span class="sxs-lookup"><span data-stu-id="4bb07-133">**Description:** The client requests access to the share.</span></span> <span data-ttu-id="4bb07-134">Il pacchetto contiene il percorso della condivisione completamente specificato in formato UNC.</span><span class="sxs-lookup"><span data-stu-id="4bb07-134">The packet contains the fully specified path of the share in UNC format.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="4bb07-135">**Pacchetto 5: \_ albero com \_ SMB \_ Connect \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4bb07-135">**Packet 5:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-136">**Direzione:** Da server a client</span><span class="sxs-lookup"><span data-stu-id="4bb07-136">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4bb07-137">**Descrizione:** Se viene concesso l'accesso alla condivisione, il server restituisce l'ID di albero a 16 bit (TID) che corrisponde alla condivisione in questo pacchetto.</span><span class="sxs-lookup"><span data-stu-id="4bb07-137">**Description:** If access to the share is granted, then the server returns the 16-bit tree ID (TID) that corresponds to the share in this packet.</span></span> <span data-ttu-id="4bb07-138">Se la condivisione non esiste o l'utente non dispone di credenziali sufficienti per accedere alla condivisione, il server restituirà un codice di errore in questo pacchetto e negherà l'accesso alla condivisione.</span><span class="sxs-lookup"><span data-stu-id="4bb07-138">If the share does not exist or the user has insufficient credentials to access the share, the server will return an error code in this packet and deny access to the share.</span></span><br/>                                                                                                                                                                                                 |
| <span data-ttu-id="4bb07-139">**Pacchetto 6: SMB \_ com \_ aperto \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4bb07-139">**Packet 6:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-140">**Direzione:** Da client a server</span><span class="sxs-lookup"><span data-stu-id="4bb07-140">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4bb07-141">**Descrizione:** Il client richiede al server di aprire un file nella condivisione a cui si accede per conto del client.</span><span class="sxs-lookup"><span data-stu-id="4bb07-141">**Description:** The client requests the server to open a file on the accessed share on behalf of the client.</span></span> <span data-ttu-id="4bb07-142">Questo pacchetto contiene il nome del file da aprire.</span><span class="sxs-lookup"><span data-stu-id="4bb07-142">This packet contains the name of the file to be opened.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="4bb07-143">**Pacchetto 7: SMB \_ com \_ aperto \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4bb07-143">**Packet 7:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-144">**Direzione:** Da server a client</span><span class="sxs-lookup"><span data-stu-id="4bb07-144">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4bb07-145">**Descrizione:** Se viene concesso l'accesso al file, il server restituisce l'ID del file richiesto.</span><span class="sxs-lookup"><span data-stu-id="4bb07-145">**Description:** If access to the file is granted, then the server returns the file ID of the requested file.</span></span> <span data-ttu-id="4bb07-146">Se il file non esiste o l'utente non dispone di credenziali sufficienti per accedere al file, il server restituirà un codice di errore in questo pacchetto e negherà l'accesso al file.</span><span class="sxs-lookup"><span data-stu-id="4bb07-146">If the file does not exist or the user has insufficient credentials to access the file, the server will return an error code in this packet and deny access to the file.</span></span><br/>                                                                                                                                                                                                                                                  |
| <span data-ttu-id="4bb07-147">**Pacchetto 8: \_ ANDX di \_ lettura \_ com SMB**</span><span class="sxs-lookup"><span data-stu-id="4bb07-147">**Packet 8:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-148">**Direzione:** Da client a server</span><span class="sxs-lookup"><span data-stu-id="4bb07-148">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4bb07-149">**Descrizione:** Il client richiede al server di leggere i dati dal file aperto per conto del client e di restituire i dati al client.</span><span class="sxs-lookup"><span data-stu-id="4bb07-149">**Description:** The client requests the server to read data from the opened file on behalf of the client and return this data to the client.</span></span> <span data-ttu-id="4bb07-150">L'ID file ottenuto dal client quando il file è stato aperto è incluso in questo pacchetto per identificare il file aperto dal quale il server deve leggere i dati.</span><span class="sxs-lookup"><span data-stu-id="4bb07-150">The file ID that is obtained by the client when the file was opened is included in this packet in order to identify which opened file the server should read data from.</span></span><br/>                                                                                                                                                                                                                   |
| <span data-ttu-id="4bb07-151">**Pacchetto 9: \_ ANDX di \_ lettura \_ com SMB**</span><span class="sxs-lookup"><span data-stu-id="4bb07-151">**Packet 9:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="4bb07-152">**Direzione:** Da server a client</span><span class="sxs-lookup"><span data-stu-id="4bb07-152">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4bb07-153">**Descrizione:** Il server restituisce i dati dei file richiesti in questo pacchetto.</span><span class="sxs-lookup"><span data-stu-id="4bb07-153">**Description:** The server returns the requested file data in this packet.</span></span> <span data-ttu-id="4bb07-154">Un errore in questo caso è improbabile dato che è stato concesso l'accesso al server, alla condivisione e al file.</span><span class="sxs-lookup"><span data-stu-id="4bb07-154">An error here is unlikely given that access to the server, share, and file has been granted.</span></span> <span data-ttu-id="4bb07-155">Questo può verificarsi in alcune situazioni, tuttavia, ad esempio, se l'accesso a una condivisione viene modificato tra l'ora in cui il file viene aperto e l'ora in cui viene eseguita la lettura.</span><span class="sxs-lookup"><span data-stu-id="4bb07-155">It can happen in some situations, however: for example, if access to a share is changed between the time the file is opened and the time it is read from.</span></span><br/>                                                                                                                                                                                                      |



 

> [!Note]  
> <span data-ttu-id="4bb07-156">Se si implementa un CIFS che non supporta le notifiche delle modifiche, Windows non è in grado di mantenere un handle in attesa per la file system e la connessione SMB può scomparire senza preavviso.</span><span class="sxs-lookup"><span data-stu-id="4bb07-156">If you implement a CIFS that does not support change notifications, Windows cannot keep an outstanding handle to the file system, and the SMB connection can go away without notice.</span></span>

 

 

 




