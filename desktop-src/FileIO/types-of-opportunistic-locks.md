---
description: Descrive i blocchi opportunistici di livello 1, livello 2, batch e filtro.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Tipi di blocchi opportunistici
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "103884334"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="d47e5-103">Tipi di blocchi opportunistici</span><span class="sxs-lookup"><span data-stu-id="d47e5-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="d47e5-104">Le operazioni di blocco opportunistiche funzionano con quattro tipi di blocchi opportunistici: livello 1, livello 2, batch e filtro.</span><span class="sxs-lookup"><span data-stu-id="d47e5-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="d47e5-105">I *blocchi opportunistici esclusivi* sono i blocchi di livello 1, batch e filtro.</span><span class="sxs-lookup"><span data-stu-id="d47e5-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="d47e5-106">Se un thread ha un tipo di blocco esclusivo su un file, non può avere anche un blocco di livello 2 nello stesso file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="d47e5-107">Blocchi opportunistici di livello 1</span><span class="sxs-lookup"><span data-stu-id="d47e5-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="d47e5-108">Un blocco opportunistico di livello 1 su un file consente a un client di leggere in anticipo nel file e memorizzare nella cache sia i dati read-ahead che quelli di scrittura dal file in locale.</span><span class="sxs-lookup"><span data-stu-id="d47e5-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="d47e5-109">Fino a quando il client dispone di accesso esclusivo a un file, non vi sono pericoli per i dati coerenza nel fornire un blocco opportunistico di livello 1.</span><span class="sxs-lookup"><span data-stu-id="d47e5-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="d47e5-110">Il client può richiedere un blocco opportunistico di livello 1 dopo l'apertura di un file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="d47e5-111">Se il file non è aperto per nessun altro client (o nessun altro thread nello stesso client), il server può concedere il blocco opportunistico.</span><span class="sxs-lookup"><span data-stu-id="d47e5-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="d47e5-112">Il client può quindi memorizzare nella cache i dati di lettura e scrittura dal file in locale.</span><span class="sxs-lookup"><span data-stu-id="d47e5-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="d47e5-113">Se un altro client ha aperto il file, il server rifiuta il blocco opportunistico e il client non esegue la memorizzazione nella cache locale.</span><span class="sxs-lookup"><span data-stu-id="d47e5-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="d47e5-114">Il server può rifiutare il blocco opportunistico anche per altri motivi, ad esempio per non supportare i blocchi opportunistici.</span><span class="sxs-lookup"><span data-stu-id="d47e5-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="d47e5-115">Quando il server apre un file che ha già un blocco opportunistico di livello 1, il server esamina lo stato di condivisione del file prima di suddividere il blocco opportunistico di livello 1.</span><span class="sxs-lookup"><span data-stu-id="d47e5-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="d47e5-116">Se il server interrompe il blocco dopo questo esame, il momento in cui il client con il primo blocco impiega lo scaricamento della cache di scrittura è il momento in cui il client che richiede il file deve attendere.</span><span class="sxs-lookup"><span data-stu-id="d47e5-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="d47e5-117">Questo dispendio di tempo significa che i blocchi opportunistici di livello 1 devono essere evitati nei file aperti da molti client.</span><span class="sxs-lookup"><span data-stu-id="d47e5-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="d47e5-118">Tuttavia, poiché il server verifica lo stato di condivisione prima che interrompa il blocco, nel caso in cui il server neghi una richiesta aperta a causa di un conflitto di condivisione, il server non interrompe il blocco.</span><span class="sxs-lookup"><span data-stu-id="d47e5-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="d47e5-119">Se, ad esempio, è stato aperto un file, è stata negata la condivisione per le operazioni di scrittura e si è ottenuto un blocco di livello 1, il server rifiuta la richiesta di un altro client di aprire il file per la scrittura prima di esaminare il blocco sul file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="d47e5-120">In questo caso, il blocco opportunistico non è stato danneggiato.</span><span class="sxs-lookup"><span data-stu-id="d47e5-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="d47e5-121">Per un esempio di come funziona un blocco opportunistico di livello 1, vedere esempio di blocco opportunistico di livello 1.</span><span class="sxs-lookup"><span data-stu-id="d47e5-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="d47e5-122">Per ulteriori informazioni sull'arresto dei blocchi opportunistici, vedere la pagina relativa alla [suddivisione dei blocchi opportunistici](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="d47e5-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="d47e5-123">Blocchi opportunistici di livello 2</span><span class="sxs-lookup"><span data-stu-id="d47e5-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="d47e5-124">Un blocco opportunistico di livello 2 informa un client che sono presenti più client simultanei di un file e che nessuno lo ha ancora modificato.</span><span class="sxs-lookup"><span data-stu-id="d47e5-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="d47e5-125">Questo blocco consente al client di eseguire operazioni di lettura e ottenere attributi di file utilizzando informazioni locali memorizzate nella cache o Read-ahead, ma il client deve inviare al server tutte le altre richieste, ad esempio per le operazioni di scrittura.</span><span class="sxs-lookup"><span data-stu-id="d47e5-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="d47e5-126">L'applicazione deve usare il blocco opportunistico di livello 2 quando si prevede che altre applicazioni scrivano il file in modo casuale o leggano il file in modo casuale o sequenziale.</span><span class="sxs-lookup"><span data-stu-id="d47e5-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="d47e5-127">Un blocco opportunistico di livello 2 è molto simile a un blocco opportunistico di filtro.</span><span class="sxs-lookup"><span data-stu-id="d47e5-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="d47e5-128">Nella maggior parte dei casi, l'applicazione deve usare il blocco opportunistico di livello 2.</span><span class="sxs-lookup"><span data-stu-id="d47e5-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="d47e5-129">Usare il blocco del filtro solo se non si desidera che le operazioni di lettura per la lettura causino violazioni della modalità di condivisione nell'intervallo di tempo tra l'apertura del file e la ricezione del blocco da parte dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d47e5-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="d47e5-130">Per altre informazioni, vedere filtrare i blocchi opportunistici e la [risposta del server per aprire le richieste sui file bloccati](server-response-to-open-requests-on-locked-files.md).</span><span class="sxs-lookup"><span data-stu-id="d47e5-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="d47e5-131">Per ulteriori informazioni sull'arresto dei blocchi opportunistici, vedere la pagina relativa alla [suddivisione dei blocchi opportunistici](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="d47e5-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="d47e5-132">Blocchi opportunistici batch</span><span class="sxs-lookup"><span data-stu-id="d47e5-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="d47e5-133">Un blocco opportunistico batch manipola le aperture e le chiusure di file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="d47e5-134">Ad esempio, durante l'esecuzione di un file batch, il file batch può essere aperto e chiuso una volta per ogni riga del file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="d47e5-135">Un blocco opportunistico batch apre il file batch sul server e lo mantiene aperto.</span><span class="sxs-lookup"><span data-stu-id="d47e5-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="d47e5-136">Quando il processore del comando "apre" e "chiude" il file batch, il redirector di rete intercetta i comandi di apertura e chiusura.</span><span class="sxs-lookup"><span data-stu-id="d47e5-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="d47e5-137">Tutte le ricevute del server sono i comandi seek e Read.</span><span class="sxs-lookup"><span data-stu-id="d47e5-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="d47e5-138">Se anche il client sta leggendo in anticipo, il server riceve una particolare richiesta di lettura al massimo una volta.</span><span class="sxs-lookup"><span data-stu-id="d47e5-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="d47e5-139">Quando si apre un file che ha già un blocco opportunistico batch, il server verifica lo stato di condivisione del file dopo l'arresto del blocco.</span><span class="sxs-lookup"><span data-stu-id="d47e5-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="d47e5-140">Questo controllo fornisce al titolare del blocco la possibilità di completare lo scaricamento della cache e di chiudere l'handle di file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="d47e5-141">Un'operazione di apertura tentata durante il controllo di condivisione non determina l'esito negativo della verifica della condivisione se il titolare del blocco rilascia il blocco.</span><span class="sxs-lookup"><span data-stu-id="d47e5-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="d47e5-142">Per un esempio del funzionamento di un blocco opportunistico batch, vedere esempio di blocco opportunistico batch.</span><span class="sxs-lookup"><span data-stu-id="d47e5-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="d47e5-143">Per ulteriori informazioni sull'arresto dei blocchi opportunistici, vedere la pagina relativa alla [suddivisione dei blocchi opportunistici](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="d47e5-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="d47e5-144">Filtrare i blocchi opportunistici</span><span class="sxs-lookup"><span data-stu-id="d47e5-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="d47e5-145">Un blocco opportunistico di filtro blocca un file in modo che non possa essere aperto per l'accesso in scrittura o eliminazione.</span><span class="sxs-lookup"><span data-stu-id="d47e5-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="d47e5-146">Tutti i client devono essere in grado di condividere il file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-146">All clients must be able to share the file.</span></span> <span data-ttu-id="d47e5-147">I blocchi di filtro consentono alle applicazioni di eseguire operazioni di filtro non intrusive sui dati dei file (ad esempio, un compilatore che apre codice sorgente o un programma di catalogazione).</span><span class="sxs-lookup"><span data-stu-id="d47e5-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="d47e5-148">Un blocco opportunistico di filtro differisce da un blocco opportunistico di livello 2 in quanto consente di eseguire operazioni di lettura senza violazioni in modalità di condivisione nell'intervallo di tempo tra l'apertura del file e la ricezione del blocco da parte dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d47e5-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="d47e5-149">Il filtro di blocco opportunistico è il blocco migliore da usare quando è importante consentire ad altri client di leggere l'accesso.</span><span class="sxs-lookup"><span data-stu-id="d47e5-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="d47e5-150">In altri casi, l'applicazione deve usare un blocco opportunistico di livello 2.</span><span class="sxs-lookup"><span data-stu-id="d47e5-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="d47e5-151">Un blocco opportunistico di filtro differisce da un blocco opportunistico di batch in quanto non consente la gestione di più aperture e chiusure da parte del redirector di rete nel modo in cui viene utilizzato un blocco opportunistico batch.</span><span class="sxs-lookup"><span data-stu-id="d47e5-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="d47e5-152">L'applicazione deve richiedere un blocco opportunistico di filtro su un file in tre passaggi:</span><span class="sxs-lookup"><span data-stu-id="d47e5-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="d47e5-153">Utilizzare la funzione [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) per aprire un handle per il file con il parametro *desiredAccess* impostato su zero, che indica nessun accesso e il parametro *dwShareMode* impostato sul flag di **\_ \_ lettura della condivisione file** per consentire la condivisione per la lettura.</span><span class="sxs-lookup"><span data-stu-id="d47e5-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="d47e5-154">L'handle ottenuto a questo punto è denominato handle di blocco.</span><span class="sxs-lookup"><span data-stu-id="d47e5-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="d47e5-155">Richiedere un blocco su questo handle con il codice di controllo [**\_ \_ \_ blocco opportunistico del filtro richieste FSCTL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) .</span><span class="sxs-lookup"><span data-stu-id="d47e5-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="d47e5-156">Quando il blocco viene concesso, utilizzare [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) per aprire nuovamente il file con *desiredAccess* impostato sul flag **di \_ lettura generico** .</span><span class="sxs-lookup"><span data-stu-id="d47e5-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="d47e5-157">Impostare *dwShareMode* sul flag **di \_ \_ lettura della condivisione file** per consentire ad altri utenti di leggere il file mentre è aperto, il flag di **\_ \_ eliminazione della condivisione file** per consentire ad altri di contrassegnare il file per l'eliminazione mentre è aperto o entrambi.</span><span class="sxs-lookup"><span data-stu-id="d47e5-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="d47e5-158">L'handle ottenuto a questo punto è denominato handle di lettura.</span><span class="sxs-lookup"><span data-stu-id="d47e5-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="d47e5-159">Utilizzare l'handle di lettura per leggere o scrivere nel contenuto del file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="d47e5-160">Quando si apre un file che ha già un blocco opportunistico di filtro, il server interrompe il blocco e quindi controlla lo stato di condivisione del file.</span><span class="sxs-lookup"><span data-stu-id="d47e5-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="d47e5-161">Questo controllo fornisce al client che ha mantenuto il blocco opportunistico precedente la possibilità di abbandonare i dati memorizzati nella cache e di confermare l'interruzione.</span><span class="sxs-lookup"><span data-stu-id="d47e5-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="d47e5-162">Un'operazione di apertura tentata durante questo controllo di condivisione non determina l'esito negativo della verifica della condivisione se il blocco del primo blocco viene rilasciato.</span><span class="sxs-lookup"><span data-stu-id="d47e5-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="d47e5-163">Il file system include la sospensione dell'operazione di apertura fino a quando il proprietario del blocco non chiude sia l'handle di lettura che l'handle di blocco.</span><span class="sxs-lookup"><span data-stu-id="d47e5-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="d47e5-164">Al termine di questa operazione, la richiesta di apertura dell'altro client può continuare.</span><span class="sxs-lookup"><span data-stu-id="d47e5-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="d47e5-165">Per ulteriori informazioni sull'arresto dei blocchi opportunistici, vedere la pagina relativa alla [suddivisione dei blocchi opportunistici](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="d47e5-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
