---
description: Una chiamata di procedura asincrona (APC) è una funzione che viene eseguita in modo asincrono nel contesto di un thread specifico.
ms.assetid: 0197d78e-a4dc-414b-88ba-c5ec5f2ed614
title: Chiamate di procedure asincrone
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dd95e9afd663e2a462335b3c47bfe99462b449e7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "103967999"
---
# <a name="asynchronous-procedure-calls"></a><span data-ttu-id="acc5e-103">Chiamate di procedure asincrone</span><span class="sxs-lookup"><span data-stu-id="acc5e-103">Asynchronous Procedure Calls</span></span>

<span data-ttu-id="acc5e-104">Una *chiamata di procedura asincrona* (APC) è una funzione che viene eseguita in modo asincrono nel contesto di un thread specifico.</span><span class="sxs-lookup"><span data-stu-id="acc5e-104">An *asynchronous procedure call* (APC) is a function that executes asynchronously in the context of a particular thread.</span></span> <span data-ttu-id="acc5e-105">Quando un APC viene accodato a un thread, il sistema emette un interrupt software.</span><span class="sxs-lookup"><span data-stu-id="acc5e-105">When an APC is queued to a thread, the system issues a software interrupt.</span></span> <span data-ttu-id="acc5e-106">La volta successiva che il thread viene pianificato, verrà eseguita la funzione APC.</span><span class="sxs-lookup"><span data-stu-id="acc5e-106">The next time the thread is scheduled, it will run the APC function.</span></span> <span data-ttu-id="acc5e-107">Un APC generato dal sistema viene definito APC in *modalità kernel*.</span><span class="sxs-lookup"><span data-stu-id="acc5e-107">An APC generated by the system is called a *kernel-mode APC*.</span></span> <span data-ttu-id="acc5e-108">Un APC generato da un'applicazione viene definito *APC in modalità utente*.</span><span class="sxs-lookup"><span data-stu-id="acc5e-108">An APC generated by an application is called a *user-mode APC*.</span></span> <span data-ttu-id="acc5e-109">Un thread deve essere in uno stato di avviso per eseguire un'APC in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="acc5e-109">A thread must be in an alertable state to run a user-mode APC.</span></span>

<span data-ttu-id="acc5e-110">Ogni thread ha una propria coda APC.</span><span class="sxs-lookup"><span data-stu-id="acc5e-110">Each thread has its own APC queue.</span></span> <span data-ttu-id="acc5e-111">Un'applicazione Accoda un APC a un thread chiamando la funzione [**QueueUserAPC**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc) .</span><span class="sxs-lookup"><span data-stu-id="acc5e-111">An application queues an APC to a thread by calling the [**QueueUserAPC**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc) function.</span></span> <span data-ttu-id="acc5e-112">Il thread chiamante specifica l'indirizzo di una funzione APC nella chiamata a **QueueUserAPC**.</span><span class="sxs-lookup"><span data-stu-id="acc5e-112">The calling thread specifies the address of an APC function in the call to **QueueUserAPC**.</span></span> <span data-ttu-id="acc5e-113">L'accodamento di un APC è una richiesta per il thread per chiamare la funzione APC.</span><span class="sxs-lookup"><span data-stu-id="acc5e-113">The queuing of an APC is a request for the thread to call the APC function.</span></span>

<span data-ttu-id="acc5e-114">Quando un APC in modalità utente viene accodato, il thread in cui viene accodato non viene indirizzato per chiamare la funzione APC a meno che non si trovi in uno stato di avviso.</span><span class="sxs-lookup"><span data-stu-id="acc5e-114">When a user-mode APC is queued, the thread to which it is queued is not directed to call the APC function unless it is in an alertable state.</span></span> <span data-ttu-id="acc5e-115">Un thread entra in uno stato di avviso quando chiama la funzione [**SleepEx**](/windows/win32/api/synchapi/nf-synchapi-sleepex), [**SignalObjectAndWait**](/windows/win32/api/synchapi/nf-synchapi-signalobjectandwait), [**MsgWaitForMultipleObjectsEx**](/windows/desktop/api/Winuser/nf-winuser-msgwaitformultipleobjectsex), [**WaitForMultipleObjectsEx**](/windows/win32/api/winuser/nf-winuser-msgwaitformultipleobjectsex)o [**WaitForSingleObjectEx**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobjectex) .</span><span class="sxs-lookup"><span data-stu-id="acc5e-115">A thread enters an alertable state when it calls the [**SleepEx**](/windows/win32/api/synchapi/nf-synchapi-sleepex), [**SignalObjectAndWait**](/windows/win32/api/synchapi/nf-synchapi-signalobjectandwait), [**MsgWaitForMultipleObjectsEx**](/windows/desktop/api/Winuser/nf-winuser-msgwaitformultipleobjectsex), [**WaitForMultipleObjectsEx**](/windows/win32/api/winuser/nf-winuser-msgwaitformultipleobjectsex), or [**WaitForSingleObjectEx**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobjectex) function.</span></span> <span data-ttu-id="acc5e-116">Se l'attesa viene soddisfatta prima che l'APC venga accodato, il thread non è più in uno stato di attesa di avviso, quindi la funzione APC non verrà eseguita.</span><span class="sxs-lookup"><span data-stu-id="acc5e-116">If the wait is satisfied before the APC is queued, the thread is no longer in an alertable wait state so the APC function will not be executed.</span></span> <span data-ttu-id="acc5e-117">Tuttavia, l'APC viene ancora accodato, quindi la funzione APC viene eseguita quando il thread chiama un'altra funzione di attesa di avviso.</span><span class="sxs-lookup"><span data-stu-id="acc5e-117">However, the APC is still queued, so the APC function will be executed when the thread calls another alertable wait function.</span></span>

<span data-ttu-id="acc5e-118">Le funzioni [**ReadFileEx**](/windows/win32/api/fileapi/nf-fileapi-readfileex), [**SetWaitableTimer**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimer), [**SetWaitableTimerEx**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimerex)e [**WriteFileEx**](/windows/win32/api/fileapi/nf-fileapi-writefileex) vengono implementate usando un APC come meccanismo di callback della notifica di completamento.</span><span class="sxs-lookup"><span data-stu-id="acc5e-118">The [**ReadFileEx**](/windows/win32/api/fileapi/nf-fileapi-readfileex), [**SetWaitableTimer**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimer), [**SetWaitableTimerEx**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimerex), and [**WriteFileEx**](/windows/win32/api/fileapi/nf-fileapi-writefileex) functions are implemented using an APC as the completion notification callback mechanism.</span></span>

<span data-ttu-id="acc5e-119">Se si usa un [pool di thread](../procthread/thread-pools.md), si noti che APC non funziona, oltre ad altri meccanismi di segnalazione, perché il sistema controlla la durata dei thread del pool di thread, quindi è possibile che un thread venga terminato prima che la notifica venga recapitata.</span><span class="sxs-lookup"><span data-stu-id="acc5e-119">If you are using a [thread pool](../procthread/thread-pools.md), note that APCs do not work as well as other signaling mechanisms because the system controls the lifetime of thread pool threads, so it is possible for a thread to be terminated before the notification is delivered.</span></span> <span data-ttu-id="acc5e-120">Anziché usare un meccanismo di segnalazione basato su APC, ad esempio il parametro *pfnCompletionRoutine* di [**SetWaitableTimer**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimer) o [**SetWaitableTimerEx**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimerex), usare un oggetto waitable, ad esempio un timer creato con [**CreateThreadpoolTimer**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpooltimer).</span><span class="sxs-lookup"><span data-stu-id="acc5e-120">Instead of using an APC-based signaling mechanism such as the *pfnCompletionRoutine* parameter of [**SetWaitableTimer**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimer) or [**SetWaitableTimerEx**](/windows/win32/api/synchapi/nf-synchapi-setwaitabletimerex), use a waitable object such as a timer created with [**CreateThreadpoolTimer**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpooltimer).</span></span> <span data-ttu-id="acc5e-121">Per I/O, usare un oggetto di completamento I/O creato con [**CreateThreadpoolIo**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpoolio) o una struttura [**sovrapposta**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) basata su *hEvent* in cui l'evento può essere passato alla funzione [**SetThreadpoolWait**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-setthreadpoolwait) .</span><span class="sxs-lookup"><span data-stu-id="acc5e-121">For I/O, use an I/O completion object created with [**CreateThreadpoolIo**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpoolio) or an *hEvent*-based [**OVERLAPPED**](/windows/win32/api/minwinbase/ns-minwinbase-overlapped) structure where the event can be passed to the [**SetThreadpoolWait**](/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-setthreadpoolwait) function.</span></span>

## <a name="synchronization-internals"></a><span data-ttu-id="acc5e-122">Elementi interni di sincronizzazione</span><span class="sxs-lookup"><span data-stu-id="acc5e-122">Synchronization Internals</span></span>

<span data-ttu-id="acc5e-123">Quando viene eseguita una richiesta di I/O, viene allocata una struttura per rappresentare la richiesta.</span><span class="sxs-lookup"><span data-stu-id="acc5e-123">When an I/O request is issued, a structure is allocated to represent the request.</span></span> <span data-ttu-id="acc5e-124">Questa struttura è chiamata pacchetto di richiesta di I/O (IRP).</span><span class="sxs-lookup"><span data-stu-id="acc5e-124">This structure is called an I/O request packet (IRP).</span></span> <span data-ttu-id="acc5e-125">Con l'I/O sincrono, il thread compila l'IRP, lo invia allo stack del dispositivo e attende che il pacchetto IRP venga completato.</span><span class="sxs-lookup"><span data-stu-id="acc5e-125">With synchronous I/O, the thread builds the IRP, sends it to the device stack, and waits in the kernel for the IRP to complete.</span></span> <span data-ttu-id="acc5e-126">Con l'I/O asincrono, il thread compila l'IRP e lo invia allo stack del dispositivo.</span><span class="sxs-lookup"><span data-stu-id="acc5e-126">With asynchronous I/O, the thread builds the IRP and sends it to the device stack.</span></span> <span data-ttu-id="acc5e-127">Lo stack potrebbe completare immediatamente il pacchetto IRP oppure potrebbe restituire uno stato in sospeso che indica che la richiesta è in corso.</span><span class="sxs-lookup"><span data-stu-id="acc5e-127">The stack might complete the IRP immediately, or it might return a pending status indicating that the request is in progress.</span></span> <span data-ttu-id="acc5e-128">In questo caso, l'oggetto IRP è ancora associato al thread, quindi verrà annullato se il thread termina o chiama una funzione come [**CancelIo**](/windows/win32/api/ioapiset/nf-ioapiset-cancelio).</span><span class="sxs-lookup"><span data-stu-id="acc5e-128">When this happens, the IRP is still associated with the thread, so it will be canceled if the thread terminates or calls a function such as [**CancelIo**](/windows/win32/api/ioapiset/nf-ioapiset-cancelio).</span></span> <span data-ttu-id="acc5e-129">Nel frattempo, il thread può continuare a eseguire altre attività mentre lo stack del dispositivo continua a elaborare l'IRP.</span><span class="sxs-lookup"><span data-stu-id="acc5e-129">In the meantime, the thread can continue to perform other tasks while the device stack continues to process the IRP.</span></span>

<span data-ttu-id="acc5e-130">Esistono diversi modi in cui il sistema può indicare che l'IRP è stato completato:</span><span class="sxs-lookup"><span data-stu-id="acc5e-130">There are several ways that the system can indicate that the IRP has completed:</span></span>

-   <span data-ttu-id="acc5e-131">Aggiornare la struttura sovrapposta con il risultato dell'operazione in modo che il thread possa eseguire il polling per determinare se l'operazione è stata completata.</span><span class="sxs-lookup"><span data-stu-id="acc5e-131">Update the overlapped structure with the result of the operation so the thread can poll to determine whether the operation has completed.</span></span>
-   <span data-ttu-id="acc5e-132">Segnala l'evento nella struttura sovrapposta in modo che un thread possa essere sincronizzato nell'evento e venga riattivato al completamento dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="acc5e-132">Signal the event in the overlapped structure so a thread can synchronize on the event and be woken when the operation completes.</span></span>
-   <span data-ttu-id="acc5e-133">Accodare l'oggetto IRP all'APC in sospeso del thread in modo che il thread esegua la routine APC quando entra in uno stato di attesa di avviso e restituisca l'operazione di attesa con uno stato che indica che ha eseguito una o più routine APC.</span><span class="sxs-lookup"><span data-stu-id="acc5e-133">Queue the IRP to the thread's pending APC so that the thread will execute the APC routine when it enters an alertable wait state and return from the wait operation with a status indicating that it executed one or more APC routines.</span></span>
-   <span data-ttu-id="acc5e-134">Accodare l'oggetto IRP a una porta di completamento I/O, in cui verrà eseguito dal thread successivo che attende la porta di completamento.</span><span class="sxs-lookup"><span data-stu-id="acc5e-134">Queue the IRP to an I/O completion port, where it will be executed by the next thread that waits on the completion port.</span></span>

<span data-ttu-id="acc5e-135">I thread che attendono una porta di completamento di I/O non attendono uno stato di avviso.</span><span class="sxs-lookup"><span data-stu-id="acc5e-135">Threads that wait on an I/O completion port do not wait in an alertable state.</span></span> <span data-ttu-id="acc5e-136">Pertanto, se i thread rilasciano IRP impostati per il completamento come APC al thread, tali completamenti IPC non verranno eseguiti in modo tempestivo; si verificheranno solo se il thread preleva una richiesta dalla porta di completamento I/O e quindi si verifica l'immissione di un'attesa di avviso.</span><span class="sxs-lookup"><span data-stu-id="acc5e-136">Therefore, if those threads issue IRPs that are set to complete as APCs to the thread, those IPC completions will not occur in a timely manner; they will occur only if the thread picks up a request from the I/O completion port and then happens to enter an alertable wait.</span></span>

## <a name="related-topics"></a><span data-ttu-id="acc5e-137">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="acc5e-137">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="acc5e-138">Uso di un timer waitable con una chiamata di procedura asincrona</span><span class="sxs-lookup"><span data-stu-id="acc5e-138">Using a Waitable Timer with an Asynchronous Procedure Call</span></span>](using-a-waitable-timer-with-an-asynchronous-procedure-call.md)
</dt> </dl>

 

 
