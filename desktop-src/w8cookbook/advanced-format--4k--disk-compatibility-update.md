---
title: Aggiornamento della compatibilità del disco con formato avanzato (4K)
description: Aggiornamento della compatibilità del disco con formato avanzato (4K)
ms.assetid: 2C9EB0CF-D27B-457A-8FE6-24824BCC084C
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fbad505575c4479bd750f09ccd83bc4da4c39667
ms.sourcegitcommit: 78b64f3865e64768b5319d4f010032ee68924a98
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/13/2021
ms.locfileid: "107314974"
---
# <a name="advanced-format-4k-disk-compatibility-update"></a><span data-ttu-id="0767e-103">Aggiornamento della compatibilità del disco con formato avanzato (4K)</span><span class="sxs-lookup"><span data-stu-id="0767e-103">Advanced format (4K) disk compatibility update</span></span>

## <a name="platforms"></a><span data-ttu-id="0767e-104">Piattaforme</span><span class="sxs-lookup"><span data-stu-id="0767e-104">Platforms</span></span>

<span data-ttu-id="0767e-105">**Client**   di   Windows XP, Windows Vista, Windows 7, Windows 7 SP1, Windows 8</span><span class="sxs-lookup"><span data-stu-id="0767e-105">**Clients**   Windows XP, Windows Vista, Windows 7, Windows 7 SP1, Windows 8</span></span>  
<span data-ttu-id="0767e-106">**Server**   di   Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2008 R2 SP1, Windows Server 2012, Windows Server 2012 R2, Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="0767e-106">**Servers**   Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2008 R2 SP1, Windows Server 2012, Windows Server 2012 R2, Windows Server 2016</span></span>  


## <a name="description"></a><span data-ttu-id="0767e-107">Descrizione</span><span class="sxs-lookup"><span data-stu-id="0767e-107">Description</span></span>

<span data-ttu-id="0767e-108">Questo articolo è una versione aggiornata dell'articolo intitolato aggiornamento della compatibilità del disco 512e (512-byte Emulation), rilasciato per Windows 7 SP1 e Windows Server 2008 R2 SP1.</span><span class="sxs-lookup"><span data-stu-id="0767e-108">This article is an updated version of the article titled  512-byte Emulation (512e) Disk Compatibility Update  which was released for Windows 7 SP1 and Windows Server 2008 R2 SP1.</span></span> <span data-ttu-id="0767e-109">Questo aggiornamento contiene informazioni molto nuove, alcune delle quali si applicano solo a Windows 8 e Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="0767e-109">This update contains much new info, some of which is applicable only to Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="0767e-110">Le densità di area geospaziale sono sempre più annuali e, con il recente avvento di dischi da 3 TB, i meccanismi di correzione degli errori utilizzati per gestire la riduzione del rapporto tra segnale e rumore sono diventati inefficienti. ovvero, è necessaria una maggiore quantità di overhead per garantire che il supporto sia utilizzabile.</span><span class="sxs-lookup"><span data-stu-id="0767e-110">Areal densities are increasing yearly, and with the recent advent of 3 TB disks, the error correction mechanisms used to deal with the decreasing signal-to-noise-ratio (SNR) are becoming space inefficient; that is, an increased amount of overhead is required to ensure the media is usable.</span></span> <span data-ttu-id="0767e-111">Una delle soluzioni del settore di archiviazione per migliorare questo meccanismo di correzione degli errori consiste nell'introdurre un formato multimediale fisico diverso che includa dimensioni del settore fisico più grandi.</span><span class="sxs-lookup"><span data-stu-id="0767e-111">One of the storage industry solutions for improving this error correction mechanism is to introduce a different physical media format that includes a larger physical sector size.</span></span> <span data-ttu-id="0767e-112">Questo nuovo formato multimediale fisico è denominato formato avanzato.</span><span class="sxs-lookup"><span data-stu-id="0767e-112">This new physical media format is called Advanced Format.</span></span> <span data-ttu-id="0767e-113">Pertanto, non è più sicuro creare presupposti relativi alle dimensioni del settore dei dispositivi di archiviazione moderni e gli sviluppatori dovranno studiare i presupposti sottostanti il codice per determinare se vi sia un effetto.</span><span class="sxs-lookup"><span data-stu-id="0767e-113">Therefore, it is no longer safe to make any assumptions regarding the sector size of modern storage devices, and developers will need to study the assumptions underlying their code to determine if there is an impact.</span></span>

<span data-ttu-id="0767e-114">In questo argomento viene illustrato l'effetto dei dispositivi di archiviazione in formato avanzato sul software, vengono illustrate le app che possono essere supportate da questo tipo di supporto e viene illustrata l'infrastruttura introdotta da Microsoft con Windows Vista, Windows 7 e Windows 8 per consentire agli sviluppatori di supportare questi tipi di dispositivi.</span><span class="sxs-lookup"><span data-stu-id="0767e-114">This topic introduces the effect of Advanced Format storage devices on software, discusses what apps can do to help support this type of media, and discusses the infrastructure that Microsoft introduced with Windows Vista, Windows 7, and Windows 8 to enable developers to support these types of devices.</span></span> <span data-ttu-id="0767e-115">Sebbene il materiale presentato in questo argomento fornisca linee guida per migliorare la compatibilità con i dischi in formato avanzato, le informazioni si applicano in genere a tutti i sistemi con dischi di formato avanzati che eseguono Windows Vista, Windows 7 e Windows 8.</span><span class="sxs-lookup"><span data-stu-id="0767e-115">While the material presented in this topic provides guidelines for improving compatibility with Advanced Format disks, the info applies generally to all systems with Advanced Format disks running Windows Vista, Windows 7, and Windows 8.</span></span>

<span data-ttu-id="0767e-116">**Riepilogo delle nuove funzionalità correlate ai settori di grandi dimensioni**</span><span class="sxs-lookup"><span data-stu-id="0767e-116">**Summary of new large sector related features**</span></span>

<span data-ttu-id="0767e-117">Nell'elenco seguente sono riepilogate le nuove funzionalità fornite come parte di Windows 8 e Windows Server 2012 per migliorare l'esperienza dei clienti e degli sviluppatori con dischi di settore di grandi dimensioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-117">The below list summarizes the new features delivered as part of Windows 8 and Windows Server 2012 to help improve customer and developer experience with large sector disks.</span></span> <span data-ttu-id="0767e-118">Seguono una descrizione più dettagliata di ogni elemento.</span><span class="sxs-lookup"><span data-stu-id="0767e-118">More detailed description for each item follow.</span></span>

-   <span data-ttu-id="0767e-119">Si basa sul supporto di Windows 7 SP1 per i dischi 4K con emulazione (512e) e offre il supporto completo della posta in arrivo per i dischi con dimensioni di settore 4K senza emulazione (4K nativo).</span><span class="sxs-lookup"><span data-stu-id="0767e-119">Builds upon the Windows 7 SP1 support for 4K disks with emulation (512e), and provides full inbox support for disks with 4K sector size without emulation (4K Native).</span></span> <span data-ttu-id="0767e-120">Alcune app e scenari supportati includono:</span><span class="sxs-lookup"><span data-stu-id="0767e-120">Some supported apps and scenarios include:</span></span>
    -   <span data-ttu-id="0767e-121">Possibilità di installare Windows e di eseguire l'avvio da un disco del settore 4K senza emulazione (disco nativo 4K)</span><span class="sxs-lookup"><span data-stu-id="0767e-121">Ability to install Windows to and boot from a 4K sector disk without emulation (4K Native Disk)</span></span>
    -   <span data-ttu-id="0767e-122">VHD e nuovo formato di file VHDX</span><span class="sxs-lookup"><span data-stu-id="0767e-122">VHD and new VHDX file format</span></span>
    -   <span data-ttu-id="0767e-123">Supporto completo per HyperV</span><span class="sxs-lookup"><span data-stu-id="0767e-123">Full HyperV support</span></span>
    -   <span data-ttu-id="0767e-124">Windows backup</span><span class="sxs-lookup"><span data-stu-id="0767e-124">Windows backup</span></span>
    -   <span data-ttu-id="0767e-125">Supporto completo in NT file system (NTFS)</span><span class="sxs-lookup"><span data-stu-id="0767e-125">Full support in the NT file system (NTFS)</span></span>
    -   <span data-ttu-id="0767e-126">Supporto completo con nuovi pool e spazi di archiviazione (SSP)</span><span class="sxs-lookup"><span data-stu-id="0767e-126">Full support with new Storage Spaces and Pools (SSP)</span></span>
    -   <span data-ttu-id="0767e-127">Supporto completo con Windows Defender</span><span class="sxs-lookup"><span data-stu-id="0767e-127">Full support with Windows Defender</span></span>
-   <span data-ttu-id="0767e-128">Fornisce una nuova API per eseguire una query per le dimensioni del settore fisico (FileFsSectorSizeInformation):</span><span class="sxs-lookup"><span data-stu-id="0767e-128">Provides a new API to query for physical sector size (FileFsSectorSizeInformation):</span></span>
    -   <span data-ttu-id="0767e-129">Disponibile per i volumi di rete</span><span class="sxs-lookup"><span data-stu-id="0767e-129">Available for network volumes</span></span>
    -   <span data-ttu-id="0767e-130">Può essere emesso per qualsiasi handle di file</span><span class="sxs-lookup"><span data-stu-id="0767e-130">Can be issued to any file handle</span></span>
    -   <span data-ttu-id="0767e-131">Disponibile per le app senza privilegi</span><span class="sxs-lookup"><span data-stu-id="0767e-131">Available for unprivileged apps</span></span>
    -   <span data-ttu-id="0767e-132">Modello di utilizzo più amichevole</span><span class="sxs-lookup"><span data-stu-id="0767e-132">Friendlier usage model</span></span>
-   <span data-ttu-id="0767e-133">Include l'utilità della riga di comando fsutil avanzata per eseguire query per le dimensioni logiche e fisiche del volume con le informazioni di allineamento (la versione di base dell'utilità senza informazioni di allineamento è disponibile per Windows 7 con Microsoft KB 982018 e Windows Server 2008 R2 con Microsoft KB 982018)</span><span class="sxs-lookup"><span data-stu-id="0767e-133">Includes enhanced  fsutil  command line utility to query for logical and physical sector size of volume with alignment info (basic version of utility without alignment info is available for Windows 7 with Microsoft KB 982018 and Windows Server 2008 R2 with Microsoft KB 982018)</span></span>

<span data-ttu-id="0767e-134">**Introduzione ai dischi con formato avanzato (4K)**</span><span class="sxs-lookup"><span data-stu-id="0767e-134">**Introduction to advanced format (4K) disks**</span></span>

<span data-ttu-id="0767e-135">Uno dei problemi relativi all'introduzione di questa modifica nel formato multimediale è il rischio di introdurre problemi di compatibilità con il software e l'hardware esistenti.</span><span class="sxs-lookup"><span data-stu-id="0767e-135">One of the problems of introducing this change in the media format is the potential for introducing compatibility issues with existing software and hardware.</span></span> <span data-ttu-id="0767e-136">Come soluzione di compatibilità temporanea, il settore dell'archiviazione introduce inizialmente i dischi che emulano un normale disco del settore a 512 byte, ma che rendono disponibili informazioni sulle reali dimensioni del settore mediante i comandi ATA e SCSI standard.</span><span class="sxs-lookup"><span data-stu-id="0767e-136">As a temporary compatibility solution, the storage industry is initially introducing disks that emulate a regular 512-byte sector disk, but make available info about the true sector size through standard ATA and SCSI commands.</span></span> <span data-ttu-id="0767e-137">In seguito a questa emulazione, in pratica sono presenti due dimensioni di settore:</span><span class="sxs-lookup"><span data-stu-id="0767e-137">As a result of this emulation, there are, in essence, two sector sizes:</span></span>

<span data-ttu-id="0767e-138">**Settore logico:** Unità utilizzata per l'indirizzamento dei blocchi logici per il supporto.</span><span class="sxs-lookup"><span data-stu-id="0767e-138">**Logical sector:** The unit that is used for logical block addressing for the media.</span></span> <span data-ttu-id="0767e-139">Possiamo anche considerarlo come la più piccola unità di scrittura che la risorsa di archiviazione può accettare.</span><span class="sxs-lookup"><span data-stu-id="0767e-139">We can also think of it as the smallest unit of write that the storage can accept.</span></span> <span data-ttu-id="0767e-140">Si tratta dell'emulazione.</span><span class="sxs-lookup"><span data-stu-id="0767e-140">This is the  emulation.</span></span>   
<span data-ttu-id="0767e-141">**Settore fisico:** Unità per la quale vengono completate le operazioni di lettura e scrittura nel dispositivo in un'unica operazione.</span><span class="sxs-lookup"><span data-stu-id="0767e-141">**Physical sector:** The unit for which read and write operations to the device are completed in a single operation.</span></span> <span data-ttu-id="0767e-142">Si tratta dell'unità di scrittura atomica.</span><span class="sxs-lookup"><span data-stu-id="0767e-142">This is the unit of atomic write.</span></span>  
 <span data-ttu-id="0767e-143">La maggior parte delle API Windows correnti, ad esempio la \_ geometria del disco IOCTL \_ Get Drive, \_ \_ restituirà le dimensioni del settore logico, ma le dimensioni del settore fisico possono essere recuperate tramite il codice di controllo della proprietà della <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property"> \_ query di archiviazione \_ \_ IOCTL</a> , con le informazioni rilevanti contenute nel campo BytesPerPhysicalSector della struttura del <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor"> \_ \_ \_ descrittore di allineamento dell'accesso di archiviazione</a> .</span><span class="sxs-lookup"><span data-stu-id="0767e-143">Most current Windows APIs, such as IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY will return the logical sector size, but the physical sector size can be retrieved through the <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property">IOCTL\_STORAGE\_QUERY\_PROPERTY</a> control code, with the relevant info contained in the BytesPerPhysicalSector field in the <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor">STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR</a> structure.</span></span> <span data-ttu-id="0767e-144">Questo argomento verrà descritto più dettagliatamente più avanti in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="0767e-144">This is discussed in more detail later in the article.</span></span>

<span data-ttu-id="0767e-145">**Tipi iniziali di supporti per settori di grandi dimensioni**</span><span class="sxs-lookup"><span data-stu-id="0767e-145">**Initial types of large sector media**</span></span>

<span data-ttu-id="0767e-146">Il settore dell'archiviazione sta dilagando rapidamente nel tentativo di passare a questo nuovo tipo di archiviazione avanzata per i supporti con dimensioni di settore fisico di 4 KB.</span><span class="sxs-lookup"><span data-stu-id="0767e-146">The storage industry is quickly ramping up efforts to transition to this new Advanced Format type of storage for media having a 4 KB physical sector size.</span></span> <span data-ttu-id="0767e-147">Due tipi di supporti verranno rilasciati sul mercato:</span><span class="sxs-lookup"><span data-stu-id="0767e-147">Two types of media will be released to the market:</span></span>

<span data-ttu-id="0767e-148">**4 KB nativi:** Questo supporto non dispone di un livello di emulazione ed espone direttamente 4 KB come dimensioni del settore logico e fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-148">**4 KB native:** This media has no emulation layer and directly exposes 4 KB as its logical and physical sector size.</span></span> <span data-ttu-id="0767e-149">Il problema generale del nuovo tipo di supporto è che la maggior parte delle applicazioni e dei sistemi operativi non eseguono query e allineano le operazioni di I/o alle dimensioni del settore fisico, causando operazioni di I/o non riuscite impreviste.</span><span class="sxs-lookup"><span data-stu-id="0767e-149">The overall issue with this new type of media is that the majority of apps and operating systems do not query for and align I/Os to the physical sector size, which can result in unexpected failed I/Os.</span></span>  
<span data-ttu-id="0767e-150">**emulazione a 512 byte (512e):** Questo supporto ha un livello di emulazione, come illustrato nella sezione precedente, ed espone 512 byte come dimensioni del settore logico (analogamente a un normale disco), ma rende disponibili le informazioni sulle dimensioni del settore fisico (4 KB).</span><span class="sxs-lookup"><span data-stu-id="0767e-150">**512-byte emulation (512e):** This media has an emulation layer as discussed in the previous section and exposes 512-bytes as its logical sector size (similar to a regular disk today), but makes its physical sector size info (4 KB) available.</span></span> <span data-ttu-id="0767e-151">Il problema generale del nuovo tipo di supporto è che la maggior parte dei sistemi operativi e delle app non comprende l'esistenza delle dimensioni del settore fisico, il che può comportare un certo numero di problemi, come verrà illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="0767e-151">The overall issue with this new type of media is that the majority of app and operating systems do not understand the existence of the physical sector size, which can result in a number of issues as will be discussed below.</span></span>  
<span data-ttu-id="0767e-152">**Supporto generale di Windows per supporti di settore di grandi dimensioni**</span><span class="sxs-lookup"><span data-stu-id="0767e-152">**Overall Windows support for large sector media**</span></span>

<span data-ttu-id="0767e-153">Questa tabella documenta i criteri ufficiali di supporto Microsoft per diversi supporti e le relative dimensioni di settore segnalate.</span><span class="sxs-lookup"><span data-stu-id="0767e-153">This table documents the official Microsoft support policy for various media and their resulting reported sector sizes.</span></span> <span data-ttu-id="0767e-154">Per informazioni dettagliate, vedere questo [articolo della Knowledge Knowledge](https://support.microsoft.com/kb/2510009) .</span><span class="sxs-lookup"><span data-stu-id="0767e-154">See this [KB article](https://support.microsoft.com/kb/2510009) for details.</span></span>



| <span data-ttu-id="0767e-155">Nomi comuni</span><span class="sxs-lookup"><span data-stu-id="0767e-155">Common Names</span></span>                                  | <span data-ttu-id="0767e-156">Dimensioni del settore logico segnalate</span><span class="sxs-lookup"><span data-stu-id="0767e-156">Reported Logical Sector Size</span></span> | <span data-ttu-id="0767e-157">Dimensioni del settore fisico segnalate</span><span class="sxs-lookup"><span data-stu-id="0767e-157">Reported Physical Sector Size</span></span> | <span data-ttu-id="0767e-158">Versione di Windows con supporto</span><span class="sxs-lookup"><span data-stu-id="0767e-158">Windows Version with Support</span></span>                                                                                                                                                                                                                                                                             |
|-----------------------------------------------|------------------------------|-------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="0767e-159">512 byte nativi, 512N</span><span class="sxs-lookup"><span data-stu-id="0767e-159">512-byte Native, 512n</span></span>                         | <span data-ttu-id="0767e-160">512 byte</span><span class="sxs-lookup"><span data-stu-id="0767e-160">512 bytes</span></span>                    | <span data-ttu-id="0767e-161">512 byte</span><span class="sxs-lookup"><span data-stu-id="0767e-161">512 bytes</span></span>                     | <span data-ttu-id="0767e-162">Tutte le versioni di Windows</span><span class="sxs-lookup"><span data-stu-id="0767e-162">All Windows versions</span></span>                                                                                                                                                                                                                                                                                     |
| <span data-ttu-id="0767e-163">Formato avanzato, 512e, AF, emulazione a 512 byte</span><span class="sxs-lookup"><span data-stu-id="0767e-163">Advanced Format, 512e, AF, 512-byte Emulation</span></span> | <span data-ttu-id="0767e-164">512 byte</span><span class="sxs-lookup"><span data-stu-id="0767e-164">512 bytes</span></span>                    | <span data-ttu-id="0767e-165">4 KB</span><span class="sxs-lookup"><span data-stu-id="0767e-165">4 KB</span></span>                          | <span data-ttu-id="0767e-166">Windows Vista w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="0767e-166">Windows Vista w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="0767e-167">Windows Server 2008 \* w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="0767e-167">Windows Server 2008\* w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="0767e-168">Windows 7 w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="0767e-168">Windows 7 w/ MS KB 982018</span></span> <br/> <span data-ttu-id="0767e-169">Windows Server 2008 R2 \* w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="0767e-169">Windows Server 2008 R2\* w/ MS KB 982018</span></span> <br/> <span data-ttu-id="0767e-170">Tutte le versioni di Windows da Windows 7 SP1 e versioni successive.</span><span class="sxs-lookup"><span data-stu-id="0767e-170">All Windows versions from Windows 7 SP1 and beyond.</span></span> <br/> <span data-ttu-id="0767e-171">Tutte le versioni del server da Server 2008 R2 SP1 e versioni successive.</span><span class="sxs-lookup"><span data-stu-id="0767e-171">All Server versions from Server 2008 R2 SP1 and beyond.</span></span> <br/> <br/> <span data-ttu-id="0767e-172">\*Ad eccezione di Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="0767e-172">\*Except for Hyper-V.</span></span> <span data-ttu-id="0767e-173">Vedere la sezione ["requisiti di supporto dell'applicazione per unità di grandi dimensioni"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) .</span><span class="sxs-lookup"><span data-stu-id="0767e-173">See the ["Application support requirements for large-sector drives"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) section.</span></span> |
| <span data-ttu-id="0767e-174">Formato avanzato, AF, 4K nativo, 4Kn</span><span class="sxs-lookup"><span data-stu-id="0767e-174">Advance Format, AF, 4K Native, 4Kn</span></span>            | <span data-ttu-id="0767e-175">4 KB</span><span class="sxs-lookup"><span data-stu-id="0767e-175">4 KB</span></span>                         | <span data-ttu-id="0767e-176">4 KB</span><span class="sxs-lookup"><span data-stu-id="0767e-176">4 KB</span></span>                          | <span data-ttu-id="0767e-177">Tutte le versioni di Windows da Windows 8 e versioni successive</span><span class="sxs-lookup"><span data-stu-id="0767e-177">All Windows versions from Windows 8 and beyond</span></span> <br/> <span data-ttu-id="0767e-178">Tutte le versioni server di Windows Server 2012 e versioni successive</span><span class="sxs-lookup"><span data-stu-id="0767e-178">All Server versions from Windows Server 2012 and beyond</span></span> <br/>                                                                                                                                                                                                                                                      |
| <span data-ttu-id="0767e-179">Altro</span><span class="sxs-lookup"><span data-stu-id="0767e-179">Other</span></span>                                         | <span data-ttu-id="0767e-180">Non 4 KB o 512 byte</span><span class="sxs-lookup"><span data-stu-id="0767e-180">Not 4 KB or 512 bytes</span></span>        | <span data-ttu-id="0767e-181">Non 4 KB o 512 byte</span><span class="sxs-lookup"><span data-stu-id="0767e-181">Not 4 KB or 512 bytes</span></span>         | <span data-ttu-id="0767e-182">Non supportato</span><span class="sxs-lookup"><span data-stu-id="0767e-182">Not supported</span></span>                                                                                                                                                                                                                                                                                            |



 

> [!Note]  
> <span data-ttu-id="0767e-183">Sebbene non venga sottolineato nella tabella precedente, Windows XP, Windows Server 2003 e Windows Server 2003 R2 non supportano i supporti 512e o 4Kn.</span><span class="sxs-lookup"><span data-stu-id="0767e-183">While not stressed in the preceding table, Windows XP, Windows Server 2003, and Windows Server 2003 R2 do not support 512e or 4Kn media.</span></span> <span data-ttu-id="0767e-184">Sebbene il sistema possa avviarsi e funzionare in modo minimo, potrebbero verificarsi scenari sconosciuti di problemi di funzionalità, perdita di dati o prestazioni ottimali.</span><span class="sxs-lookup"><span data-stu-id="0767e-184">While the system may boot up and be able to operate minimally, there may be unknown scenarios of functionality issues, data loss, or sub-optimal performance.</span></span> <span data-ttu-id="0767e-185">Pertanto, Microsoft consiglia vivamente di utilizzare i supporti 512e con Windows XP o altri prodotti basati sulla codebase di Windows XP (ad esempio Windows Home Server 1,0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003 e Windows Small Business Server 2003 R2).</span><span class="sxs-lookup"><span data-stu-id="0767e-185">Thus, Microsoft strongly cautions against using 512e media with Windows XP or other products based on the Windows XP codebase (such as Windows Home Server 1.0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003, and Windows Small Business Server 2003 R2).</span></span>

 

## <a name="how-emulation-works-read-modify-write-rmw"></a><span data-ttu-id="0767e-186">Funzionamento dell'emulazione: lettura-modifica-scrittura (RMW)</span><span class="sxs-lookup"><span data-stu-id="0767e-186">How emulation works: read-modify-write (RMW)</span></span>

<span data-ttu-id="0767e-187">Un supporto di archiviazione ha una determinata unità all'interno della quale è possibile modificare il supporto fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-187">A storage medium has a certain unit within which the physical medium can be modified.</span></span> <span data-ttu-id="0767e-188">Ovvero, i supporti possono essere scritti o riscritti solo in unità delle dimensioni del settore fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-188">That is, the media can only be written, or rewritten, in units of the physical sector size.</span></span> <span data-ttu-id="0767e-189">Pertanto, le Scritture non eseguite a questo livello di unità richiederebbero passaggi aggiuntivi, che verranno esaminati nell'esempio riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="0767e-189">Thus, writes that are not performed at this unit level would require additional steps, which we will walk through the example below.</span></span>

<span data-ttu-id="0767e-190">In questo scenario, un'app deve aggiornare il contenuto di un record Datastor che si trova all'interno di un settore logico a 512 byte.</span><span class="sxs-lookup"><span data-stu-id="0767e-190">In this scenario, an app needs to update the contents of a Datastor record located within a 512-byte logical sector.</span></span> <span data-ttu-id="0767e-191">Questo diagramma illustra i passaggi necessari per completare la scrittura del dispositivo di archiviazione:</span><span class="sxs-lookup"><span data-stu-id="0767e-191">This diagram illustrates the steps necessary for the storage device to complete the write:</span></span>

![passaggi per un dispositivo di archiviazione per completare una scrittura](images/512ermwsteps.png)

<span data-ttu-id="0767e-193">Come illustrato sopra, questo processo implica alcune operazioni eseguite dal dispositivo di archiviazione che possono causare una perdita di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-193">As illustrated above, this process involves some work by the storage device that can result in a performance loss.</span></span> <span data-ttu-id="0767e-194">Per evitare questo lavoro aggiuntivo, è necessario aggiornare le app a:</span><span class="sxs-lookup"><span data-stu-id="0767e-194">To avoid this additional work, apps must be updated to:</span></span>

-   <span data-ttu-id="0767e-195">Query per le dimensioni del settore fisico</span><span class="sxs-lookup"><span data-stu-id="0767e-195">Query for the physical sector size</span></span>
-   <span data-ttu-id="0767e-196">Verificare che le Scritture siano allineate alle dimensioni del settore fisico indicate</span><span class="sxs-lookup"><span data-stu-id="0767e-196">Ensure writes are aligned to that reported physical sector size</span></span>

<span data-ttu-id="0767e-197">Sebbene sia inizialmente possibile che si verifichi un problema di prestazioni, è possibile che si verifichino problemi più gravi.</span><span class="sxs-lookup"><span data-stu-id="0767e-197">While this may initially appear to be only a performance issue, there can be more serious issue.</span></span> <span data-ttu-id="0767e-198">Questa operazione verrà illustrata nella sezione successiva.</span><span class="sxs-lookup"><span data-stu-id="0767e-198">Let s discuss this in the next section.</span></span>

<span data-ttu-id="0767e-199">**Resilienza: il costo nascosto di lettura-modifica-scrittura**</span><span class="sxs-lookup"><span data-stu-id="0767e-199">**Resiliency: the hidden cost of read-modify-write**</span></span>

<span data-ttu-id="0767e-200">La resilienza esprime la capacità di un'app di ripristinare lo stato tra le sessioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-200">Resiliency speaks of the ability of an app to recover state between sessions.</span></span> <span data-ttu-id="0767e-201">Abbiamo visto cosa è necessario affinché un dispositivo di archiviazione 512e esegua un settore a 512 byte per scrivere il ciclo di lettura-modifica-scrittura.</span><span class="sxs-lookup"><span data-stu-id="0767e-201">We have seen what is necessary for a 512e storage device to perform a 512-byte sector write   the Read-Modify-Write cycle.</span></span> <span data-ttu-id="0767e-202">Si osservi che cosa accadrebbe se il processo di sovrascrittura del precedente settore fisico sul supporto venisse interrotto.</span><span class="sxs-lookup"><span data-stu-id="0767e-202">Let s look at what would happen if the process of overwriting the previous physical sector on the media was interrupted.</span></span> <span data-ttu-id="0767e-203">Quali sono le conseguenze?</span><span class="sxs-lookup"><span data-stu-id="0767e-203">What would be the consequences?</span></span>

-   <span data-ttu-id="0767e-204">Poiché la maggior parte delle unità disco rigido si aggiorna sul posto, il settore fisico, ovvero la parte del supporto in cui si trovava il settore fisico, potrebbe essere stato danneggiato con informazioni incomplete a causa di una sovrascrittura parziale.</span><span class="sxs-lookup"><span data-stu-id="0767e-204">Because most hard disk drives update in place, the physical sector   that is, the portion of the media where the physical sector was located   could have been corrupted with incomplete info due to a partial overwrite.</span></span> <span data-ttu-id="0767e-205">In altre parole, è possibile considerarlo come potenzialmente perso per tutti gli 8 settori logici (che il settore fisico contiene logicamente).</span><span class="sxs-lookup"><span data-stu-id="0767e-205">Put another way, you can think of it as potentially having lost all 8 logical sectors (which the physical sector logically contains).</span></span>
-   <span data-ttu-id="0767e-206">Sebbene la maggior parte delle app con un archivio dati sia progettata con la possibilità di eseguire il recupero da errori dei supporti, la perdita di otto settori o un altro modo, la perdita di otto record di commit, può potenzialmente rendere impossibile il ripristino normale dell'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="0767e-206">While most apps with a data store are designed with the capability to recover from media errors, the loss of eight sectors, or put another way, the loss of eight commit records, can potentially make it impossible for the data store to recover gracefully.</span></span> <span data-ttu-id="0767e-207">Un amministratore potrebbe dover ripristinare manualmente il database da un backup o potrebbe anche dover eseguire una ricompilazione lunga.</span><span class="sxs-lookup"><span data-stu-id="0767e-207">An administrator may need to manually restore the database from a backup or may even need to perform a lengthy rebuild.</span></span>
-   <span data-ttu-id="0767e-208">Un altro aspetto importante è che l'azione di un'altra app che causa un ciclo di lettura/modifica-scrittura può causare la perdita dei dati anche se l'app non è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="0767e-208">One more important impact is that the act of another app causing a Read-Modify-Write cycle can potentially cause your data to be lost   even if your app is not running!</span></span> <span data-ttu-id="0767e-209">Questo è semplicemente dovuto al fatto che i dati e gli altri dati dell'app potrebbero trovarsi all'interno dello stesso settore fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-209">This is simply because your data and the other app s data could be located within the same physical sector.</span></span>

<span data-ttu-id="0767e-210">Tenendo presente questo aspetto, è importante che il software dell'app rivaluti le ipotesi prese nel codice e sia a conoscenza della distinzione delle dimensioni del settore fisico logico, insieme ad alcuni scenari di clienti interessanti illustrati più avanti in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="0767e-210">With this in mind, it is important that app software reevaluate any assumptions taken in the code, and be aware of the logical-physical sector size distinction, along with some interesting customer scenarios discussed later in this article.</span></span>

<span data-ttu-id="0767e-211">**Operazione corretta (evitando la lettura-modifica-scrittura)**</span><span class="sxs-lookup"><span data-stu-id="0767e-211">**Doing the right thing (avoiding read-modify-write)**</span></span>

<span data-ttu-id="0767e-212">Sebbene alcuni fornitori di archiviazione possano introdurre alcuni livelli di mitigazione all'interno di determinati dispositivi di archiviazione 512e per provare a semplificare i problemi di prestazioni e resilienza del ciclo di lettura-modifica-scrittura, è possibile che la mitigazione sia sufficiente per la gestione in termini di carico di lavoro.</span><span class="sxs-lookup"><span data-stu-id="0767e-212">While some storage vendors may be introducing some levels of mitigation within certain 512e storage devices to try to ease the performance and resiliency issues of the Read-Modify-Write cycle, there is only so much any mitigation can handle in terms of workload.</span></span> <span data-ttu-id="0767e-213">Di conseguenza, le app non devono basarsi su questa mitigazione come soluzione a lungo termine.</span><span class="sxs-lookup"><span data-stu-id="0767e-213">As such, apps should not rely on this mitigation as a long-term solution.</span></span> <span data-ttu-id="0767e-214">Inoltre, non vi è alcuna garanzia che tutte le classi di dischi rilevino questa mitigazione, né la garanzia che la mitigazione sia ben progettata.</span><span class="sxs-lookup"><span data-stu-id="0767e-214">Moreover, there is no guarantee that all classes of disks will have this mitigation in place, nor is there a guarantee that the mitigation is well-designed.</span></span>

<span data-ttu-id="0767e-215">La soluzione non è la mitigazione nell'unità, ma per progettare le app in modo da eseguire il set corretto di elementi per supportare questo tipo di supporto.</span><span class="sxs-lookup"><span data-stu-id="0767e-215">The solution to this is not in-drive mitigation, but to design apps to do the right set of things to help support this type of media.</span></span> <span data-ttu-id="0767e-216">Questa sezione illustra gli scenari comuni in cui le app possono avere problemi con dischi di settore di grandi dimensioni e suggerisce un viale di analisi per provare a risolvere ogni problema.</span><span class="sxs-lookup"><span data-stu-id="0767e-216">This section discusses common scenarios where apps may have issues with large sector disks, and suggests an avenue of investigation to try and resolve each issue.</span></span>

<span data-ttu-id="0767e-217">**Problema 1: la partizione non è allineata a un limite di settore fisico**</span><span class="sxs-lookup"><span data-stu-id="0767e-217">**Issue 1: the partition is not aligned to a physical sector boundary**</span></span>

<span data-ttu-id="0767e-218">Quando l'amministratore o l'utente partiziona il disco, è possibile che la prima partizione non sia stata creata in un limite allineato.</span><span class="sxs-lookup"><span data-stu-id="0767e-218">When the administrator/user partitions the disk, the first partition may not have been created on an aligned boundary.</span></span> <span data-ttu-id="0767e-219">In questo modo tutte le scritture successive diventeranno non allineate ai limiti del settore fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-219">This may cause all subsequent writes to become unaligned to physical sector boundaries.</span></span> <span data-ttu-id="0767e-220">A partire da Windows Vista SP1 e Windows Server 2008, la prima partizione viene posizionata al primo 1024 KB del disco (per i dischi da 4 GB o più grandi, in caso contrario l'allineamento è 64 KB) allineato a un limite del settore fisico da 4 KB.</span><span class="sxs-lookup"><span data-stu-id="0767e-220">As of Windows Vista SP1 and Windows Server 2008, the first partition is placed at the first 1024 KB of the disk (for disks 4GB or larger, otherwise the alignment is 64 KB) that is aligned to a 4 KB physical sector boundary.</span></span> <span data-ttu-id="0767e-221">Tuttavia, dato il partizionamento predefinito in Windows XP, un'utilità di partizionamento di terze parti o un utilizzo errato delle API Windows, le partizioni create potrebbero non essere allineate a un limite di settore fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-221">However, given the default partitioning in Windows XP, a 3rd party partitioning utility or incorrect usage of Windows APIs, created partitions may not be aligned to a physical sector boundary.</span></span> <span data-ttu-id="0767e-222">Gli sviluppatori dovranno assicurarsi che vengano usate le API corrette per garantire l'allineamento.</span><span class="sxs-lookup"><span data-stu-id="0767e-222">Developers will need to ensure that the correct APIs are used to help ensure alignment.</span></span> <span data-ttu-id="0767e-223">Le API consigliate per garantire l'allineamento della partizione sono descritte di seguito.</span><span class="sxs-lookup"><span data-stu-id="0767e-223">The recommended APIs to help ensure partition alignment are outlined below.</span></span>

<span data-ttu-id="0767e-224">Le API IVdsPack:: CreateVolume e IVdsPack2:: CreateVolume2 non utilizzano il parametro di allineamento specificato quando viene creato un nuovo volume, ma utilizzano invece il valore predefinito di allineamento per il sistema operativo (precedente a Windows Vista SP1 utilizzerà 63 byte e post Windows Vista SP1 utilizzerà i valori predefiniti indicati in precedenza).</span><span class="sxs-lookup"><span data-stu-id="0767e-224">The IVdsPack::CreateVolume and IVdsPack2::CreateVolume2 APIs do not use the specified alignment parameter when a new volume is created, but rather use the alignment value default for the operating system (Pre-Windows Vista SP1 will use 63 bytes, and post Windows Vista SP1 will use the defaults stated above).</span></span> <span data-ttu-id="0767e-225">Usare invece le API IVdsCreatePartitionEx:: CreatePartitionEx o IVdsAdvancedDisk:: CreatePartition che usano il parametro di allineamento specificato per le app che devono creare partizioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-225">Instead, use the IVdsCreatePartitionEx::CreatePartitionEx or IVdsAdvancedDisk::CreatePartition APIs that use the specified alignment parameter for those apps that need to create partitions.</span></span>

<span data-ttu-id="0767e-226">Il modo migliore per garantire che l'allineamento sia corretto consiste nell'eseguire questa operazione direttamente quando si crea inizialmente la partizione.</span><span class="sxs-lookup"><span data-stu-id="0767e-226">The best way to help ensure that alignment is correct is to do it right when initially creating the partition.</span></span> <span data-ttu-id="0767e-227">In caso contrario, l'applicazione deve tenere conto dell'allineamento quando si eseguono le Scritture o all'inizializzazione, che può essere un processo molto complesso.</span><span class="sxs-lookup"><span data-stu-id="0767e-227">Otherwise your app will need to take alignment into account when performing writes or at initialization   which can be a very complex process.</span></span>

<span data-ttu-id="0767e-228">**Problema 2: le scritture senza buffer non sono allineate alle dimensioni del settore fisico**</span><span class="sxs-lookup"><span data-stu-id="0767e-228">**Issue 2: unbuffered writes not aligned to physical sector size**</span></span>

<span data-ttu-id="0767e-229">Il problema più semplice è che le scritture senza buffer non sono allineate alle dimensioni del settore fisico del supporto di archiviazione indicato.</span><span class="sxs-lookup"><span data-stu-id="0767e-229">The simplest issue is that unbuffered writes are not aligned to the reported physical sector size of the storage media.</span></span> <span data-ttu-id="0767e-230">Le scritture memorizzate nel buffer, d'altra parte, sono allineate alle dimensioni della pagina 4 KB, ovvero le dimensioni del settore fisico della prima generazione di supporti di settore di grandi dimensioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-230">Buffered writes, on the other hand, are aligned to the page size   4 KB   which coincidently is the physical sector size of the first generation of large sector media.</span></span> <span data-ttu-id="0767e-231">Tuttavia, la maggior parte delle app con un archivio dati eseguono scritture senza buffer e pertanto dovranno assicurarsi che tali scritture vengano eseguite in unità di dimensioni del settore fisico.</span><span class="sxs-lookup"><span data-stu-id="0767e-231">However, most apps with a data store perform unbuffered writes, and thus will need to ensure these writes are performed in units of the physical sector size.</span></span>

<span data-ttu-id="0767e-232">Alcuni esempi di scenari in cui l'I/O dell'app risultante non è allineato:</span><span class="sxs-lookup"><span data-stu-id="0767e-232">Some examples of scenarios where the resulting app I/O is unaligned:</span></span>

<span data-ttu-id="0767e-233">**I record di commit vengono riempiti in settori a 512 byte:** Le app con un archivio dati in genere hanno una forma di record di commit che mantiene le informazioni sulle modifiche dei metadati o gestisce la struttura dell'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="0767e-233">**Commit records are padded to 512-byte sectors:** Apps with a data store typically have some form of commit record that either maintains info about metadata changes or maintains the structure of the data store.</span></span> <span data-ttu-id="0767e-234">Per garantire che la perdita di un settore non influisca su più record, questo record di commit viene in genere rivestito a dimensioni di settore.</span><span class="sxs-lookup"><span data-stu-id="0767e-234">In order to ensure that the loss of a sector does not affect multiple records, this commit record is typically padded out to a sector size.</span></span> <span data-ttu-id="0767e-235">Con un disco con una dimensione di settore fisico più grande, l'app dovrà eseguire una query per le dimensioni del settore fisico, come illustrato nella sezione precedente, e verificare che ogni record di commit venga riempito a tale dimensione.</span><span class="sxs-lookup"><span data-stu-id="0767e-235">With a disk with a larger physical sector size, the app will need to query for the physical sector size as shown in the prior section, and ensure each commit record is padded to that size.</span></span> <span data-ttu-id="0767e-236">Con un disco 4K, questo assicura che le operazioni di I/o non abbiano esito negativo.</span><span class="sxs-lookup"><span data-stu-id="0767e-236">With a 4K disk, this ensures I/Os do not fail.</span></span> <span data-ttu-id="0767e-237">Con un disco 512e, non solo questa operazione consente di evitare il ciclo di lettura-modifica-scrittura, per garantire che in caso di perdita di un settore fisico venga perso solo un record di commit.</span><span class="sxs-lookup"><span data-stu-id="0767e-237">With a 512e disk, not only does this avoid the Read-Modify-Write cycle, it helps ensure that if a physical sector was lost, only one Commit Record would be lost.</span></span>  
<span data-ttu-id="0767e-238">**I file di log vengono scritti in blocchi non allineati:** Le operazioni di I/O senza buffer vengono in genere utilizzate per l'aggiornamento o l'aggiunta a un file di log.</span><span class="sxs-lookup"><span data-stu-id="0767e-238">**Log files are written to in unaligned chunks:** Unbuffered I/O is typically used when updating or appending to a log file.</span></span> <span data-ttu-id="0767e-239">Le app possono passare all'I/O memorizzato nel buffer oppure inserire internamente gli aggiornamenti dei log in unità di dimensioni del settore fisico per evitare I/o non riusciti o attivare una lettura-modifica-scrittura.</span><span class="sxs-lookup"><span data-stu-id="0767e-239">Apps can either switch to buffered I/O, or internally buffer the log updates to units of the physical sector size to avoid failed I/Os or triggering a Read-Modify-Write.</span></span>  
 <span data-ttu-id="0767e-240">Per determinare se l'app emette I/O senza buffer, assicurarsi di includere il flag di FILE \_ \_ nessun \_ flag di buffer nel parametro *dwFlagsAndAttributes* quando si chiama la funzione CreateFile.</span><span class="sxs-lookup"><span data-stu-id="0767e-240">To help determine if your app issues unbuffered I/O, make sure to include the FILE\_FLAG\_NO\_BUFFERING flag in the *dwFlagsAndAttributes* parameter when you are call the CreateFile function.</span></span>

<span data-ttu-id="0767e-241">Inoltre, se si stanno attualmente allineando le Scritture alle dimensioni del settore, le dimensioni del settore sono molto probabilmente solo le dimensioni del settore logico, perché la maggior parte delle API esistenti che eseguono query per le dimensioni del settore del supporto eseguono solo query sull'unità di indirizzamento, ovvero le dimensioni del settore logico.</span><span class="sxs-lookup"><span data-stu-id="0767e-241">Moreover, if you are currently aligning the writes to the sector size, this sector size is most likely just the logical sector size, as most existing APIs that query for the sector size of the media just query the unit of addressing   that is, the logical sector size.</span></span> <span data-ttu-id="0767e-242">Le dimensioni di settore di interesse sono le dimensioni del settore fisico, ovvero l'unità reale di atomicità.</span><span class="sxs-lookup"><span data-stu-id="0767e-242">The sector size of interest here is the physical sector size, which is the real unit of atomicity.</span></span> <span data-ttu-id="0767e-243">Di seguito sono riportati alcuni esempi di API che recuperano le dimensioni del settore logico:</span><span class="sxs-lookup"><span data-stu-id="0767e-243">Some examples of APIs that retrieve the logical sector size are:</span></span>

-   <span data-ttu-id="0767e-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span><span class="sxs-lookup"><span data-stu-id="0767e-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span></span>
-   <span data-ttu-id="0767e-245">FileFsVolumeInformation</span><span class="sxs-lookup"><span data-stu-id="0767e-245">FileFsVolumeInformation</span></span>
-   <span data-ttu-id="0767e-246">\_geometria del disco IOCTL ottenere l' \_ \_ unità \_ geometrica, il \_ disco IOCTL \_ get \_ drive \_ Geometry \_ es</span><span class="sxs-lookup"><span data-stu-id="0767e-246">IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY, IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY\_EX</span></span>
-   <span data-ttu-id="0767e-247">IVdsDisk:: GetProperties, IVdsDisk3:: GetProperties2</span><span class="sxs-lookup"><span data-stu-id="0767e-247">IVdsDisk::GetProperties, IVdsDisk3::GetProperties2</span></span>

<span data-ttu-id="0767e-248">Ecco come è possibile eseguire una query per le dimensioni del settore fisico:</span><span class="sxs-lookup"><span data-stu-id="0767e-248">Here s how you can query for the physical sector size:</span></span>

<span data-ttu-id="0767e-249">**Metodo preferito per Windows 8**</span><span class="sxs-lookup"><span data-stu-id="0767e-249">**Preferred method for Windows 8**</span></span>

<span data-ttu-id="0767e-250">Con Windows 8, Microsoft ha introdotto una nuova API che consente agli sviluppatori di integrare facilmente il supporto 4K all'interno delle proprie app.</span><span class="sxs-lookup"><span data-stu-id="0767e-250">With Windows 8, Microsoft has introduced a new API that enables developers to easily integrate 4K support within their apps.</span></span> <span data-ttu-id="0767e-251">Questa nuova API supporta un numero ancora maggiore di scenari rispetto al metodo legacy per Windows Vista e Windows 7 descritto di seguito.</span><span class="sxs-lookup"><span data-stu-id="0767e-251">This new API supports even greater numbers of scenarios than the legacy method for Windows Vista and Windows 7 discussed below.</span></span> <span data-ttu-id="0767e-252">Questa API Abilita questi scenari di chiamata:</span><span class="sxs-lookup"><span data-stu-id="0767e-252">This API enables these calling scenarios:</span></span>

-   <span data-ttu-id="0767e-253">Chiamata da un'app senza privilegi</span><span class="sxs-lookup"><span data-stu-id="0767e-253">Calling from an unprivileged app</span></span>
-   <span data-ttu-id="0767e-254">Chiamata a qualsiasi handle di file valido</span><span class="sxs-lookup"><span data-stu-id="0767e-254">Calling to any valid file handle</span></span>
-   <span data-ttu-id="0767e-255">Chiamata a un handle di file su un volume remoto tramite SMB2</span><span class="sxs-lookup"><span data-stu-id="0767e-255">Calling to a file handle on a remote volume over SMB2</span></span>
-   <span data-ttu-id="0767e-256">Modello di programmazione semplificato</span><span class="sxs-lookup"><span data-stu-id="0767e-256">Simplified programming model</span></span>

<span data-ttu-id="0767e-257">L'API è sotto forma di una nuova classe info, FileFsSectorSizeInformation, con le informazioni relative alle dimensioni del settore FS del FILE di struttura associate \_ \_ \_ \_ , definite come segue:</span><span class="sxs-lookup"><span data-stu-id="0767e-257">The API is in the form of a new info class, FileFsSectorSizeInformation, with associated structure FILE\_FS\_SECTOR\_SIZE\_INFORMATION, defined as follows:</span></span>


```
typedef struct _FILE_FS_SECTOR_SIZE_INFORMATION {  
    ULONG LogicalBytesPerSector;  
    ULONG PhysicalBytesPerSectorForAtomicity;  
    ULONG PhysicalBytesPerSectorForPerformance;  
    ULONG FileSystemEffectivePhysicalBytesPerSectorForAtomicity;  
    ULONG Flags;  
    ULONG ByteOffsetForSectorAlignment;  
    ULONG ByteOffsetForPartitionAlignment;  
} FILE_FS_SECTOR_SIZE_INFORMATION, *PFILE_FS_SECTOR_SIZE_INFORMATION;
```



<span data-ttu-id="0767e-258">**Metodo legacy per Windows 7 e Windows Vista**</span><span class="sxs-lookup"><span data-stu-id="0767e-258">**Legacy method for Windows 7 and Windows Vista**</span></span>

<span data-ttu-id="0767e-259">Windows Vista e Windows Server 2008 hanno introdotto le API per eseguire una query per le dimensioni del settore fisico del dispositivo di archiviazione collegato per i controller di archiviazione basati su AHCI.</span><span class="sxs-lookup"><span data-stu-id="0767e-259">Windows Vista and Windows Server 2008 introduced APIs to query for the physical sector size of the attached storage device for AHCI-based storage controllers.</span></span> <span data-ttu-id="0767e-260">Con Windows 7 e Windows Server 2008 R2, a partire da SP1 (o Microsoft Knowledge Base 982018), questo supporto viene esteso ai controller di archiviazione basati su Storport.</span><span class="sxs-lookup"><span data-stu-id="0767e-260">With Windows 7 and Windows Server 2008 R2, as of SP1 (or Microsoft Knowledge Base 982018), this support is extended to Storport-based storage controllers.</span></span> <span data-ttu-id="0767e-261">Microsoft ha fornito un [esempio di codice](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) su MSDN con informazioni dettagliate sul modo in cui un'app può eseguire query per le dimensioni del settore fisico del volume.</span><span class="sxs-lookup"><span data-stu-id="0767e-261">Microsoft has provided a [code sample](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) on MSDN detailing how an app can query for the physical sector size of the volume.</span></span>

<span data-ttu-id="0767e-262">Mentre l'esempio di codice precedente consente di ottenere le dimensioni del settore fisico del volume, è necessario eseguire un controllo di integrità di base delle dimensioni del settore fisico segnalato prima di utilizzarlo, in quanto è stato rilevato che alcuni driver non restituiscono dati formattati correttamente:</span><span class="sxs-lookup"><span data-stu-id="0767e-262">While the code sample above allows you to get the physical sector size of the volume, you should do some basic sanity checking of the reported physical sector size before using it, as it has been observed that some drivers may not return correctly formatted data:</span></span>

-   <span data-ttu-id="0767e-263">Verificare che le dimensioni del settore fisico segnalato siano >= le dimensioni del settore logico indicate. in caso contrario, l'app deve usare una dimensione del settore fisico uguale alla dimensione del settore logico indicata.</span><span class="sxs-lookup"><span data-stu-id="0767e-263">Make sure that the reported physical sector size is >= the reported logical sector size; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="0767e-264">Assicurarsi che le dimensioni del settore fisico segnalato siano una potenza di due; in caso contrario, l'app deve usare una dimensione del settore fisico uguale alla dimensione del settore logico indicata.</span><span class="sxs-lookup"><span data-stu-id="0767e-264">Make sure that the reported physical sector size is a power of two; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="0767e-265">Se le dimensioni del settore fisico sono un valore di potenza di due tra 512 byte e 4 KB, è consigliabile utilizzare una dimensione di settore fisico arrotondata per difetto alle dimensioni del settore logico indicate.</span><span class="sxs-lookup"><span data-stu-id="0767e-265">If the physical sector size is a power-of-two value between 512-bytes and 4 KB, you should consider using a physical sector size rounded down to the reported logical sector size</span></span>
-   <span data-ttu-id="0767e-266">Se le dimensioni del settore fisico sono un valore di potenza di due maggiore di 4 KB, è necessario valutare la capacità dell'app di gestire questo scenario prima di usare tale valore. in caso contrario, è consigliabile utilizzare una dimensione di settore fisico arrotondata a 4 KB</span><span class="sxs-lookup"><span data-stu-id="0767e-266">If the physical sector size is a power-of-two value greater than 4 KB, you should evaluate your app s ability to handle this scenario before using that value; otherwise, you should consider using a physical sector size rounded down to 4 KB</span></span>

<span data-ttu-id="0767e-267">L'uso di questo IOCTL per ottenere le dimensioni del settore fisico presenta diverse limitazioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-267">Using this IOCTL to get the physical sector size does have several limitations.</span></span> <span data-ttu-id="0767e-268">È</span><span class="sxs-lookup"><span data-stu-id="0767e-268">It:</span></span>

-   <span data-ttu-id="0767e-269">Richiede privilegi elevati. Se l'app non è in esecuzione con privilegi, potrebbe essere necessario scrivere un'applicazione di servizio Windows come indicato in precedenza</span><span class="sxs-lookup"><span data-stu-id="0767e-269">Requires elevated privilege; if your app is not running with privilege, you may need to write a Windows Service Application as noted above</span></span>
-   <span data-ttu-id="0767e-270">Non supporta i volumi SMB; potrebbe anche essere necessario scrivere un'applicazione di servizio Windows per supportare le query sulle dimensioni del settore fisico su questi volumi</span><span class="sxs-lookup"><span data-stu-id="0767e-270">Does not support SMB volumes; you may also need to write a Windows Service Application to support physical sector size querying on these volumes</span></span>
-   <span data-ttu-id="0767e-271">Non può essere emesso per alcun handle di file (è necessario emettere IOCTL per un handle del volume)</span><span class="sxs-lookup"><span data-stu-id="0767e-271">Cannot be issued to any file handle (the IOCTL must be issued to a Volume Handle)</span></span>

<span data-ttu-id="0767e-272">**Problema 3: formati di file basati su settori a 512 byte**</span><span class="sxs-lookup"><span data-stu-id="0767e-272">**Issue 3: file formats relying on 512-byte sectors**</span></span>

<span data-ttu-id="0767e-273">Per alcune app con formati di file standard, ad esempio VHD 1,0, questi file possono essere hardcoded per presupporre una dimensione di settore a 512 byte.</span><span class="sxs-lookup"><span data-stu-id="0767e-273">Some apps with standard file formats (such as VHD 1.0) may have these files hard-coded to assume a 512-byte sector size.</span></span> <span data-ttu-id="0767e-274">Pertanto, gli aggiornamenti e le Scritture in questo file comporteranno un ciclo di lettura-modifica-scrittura sul dispositivo che potrebbe causare problemi di prestazioni e resilienza per i clienti.</span><span class="sxs-lookup"><span data-stu-id="0767e-274">Thus, updates and writes to this file would result in a Read-Modify-Write cycle on the device  which will potentially result in performance and resiliency issues for your customers.</span></span> <span data-ttu-id="0767e-275">Esistono tuttavia modi per consentire a un'app di fornire supporto per l'utilizzo di questo tipo di supporto, ad esempio:</span><span class="sxs-lookup"><span data-stu-id="0767e-275">However, there are ways for an app to provide support for operating on this type of media, for example:</span></span>

-   <span data-ttu-id="0767e-276">Usare la memorizzazione nel buffer per assicurarsi che le Scritture vengano eseguite in unità della dimensione del settore fisico</span><span class="sxs-lookup"><span data-stu-id="0767e-276">Use buffering to ensure that writes are performed in units of the physical sector size</span></span>
-   <span data-ttu-id="0767e-277">Implementare una lettura-modifica-scrittura interna che consente di garantire che gli aggiornamenti vengano eseguiti in unità della dimensione del settore fisico indicata.</span><span class="sxs-lookup"><span data-stu-id="0767e-277">Implement an internal Read-Modify-Write that can help ensure that updates are performed in units of the reported physical sector size</span></span>
-   <span data-ttu-id="0767e-278">Se possibile, riempie i record in un settore fisico, in modo che la spaziatura interna venga interpretata come spazio vuoto</span><span class="sxs-lookup"><span data-stu-id="0767e-278">If possible, pad records out to a physical sector, in such a way that the padding would be interpreted as empty space</span></span>
-   <span data-ttu-id="0767e-279">Provare a riprogettare una versione della struttura di dati dell'app con supporto per settori di grandi dimensioni</span><span class="sxs-lookup"><span data-stu-id="0767e-279">Consider redesigning a version of the app data structure with support for larger sectors</span></span>

<span data-ttu-id="0767e-280">**Problema 4: le dimensioni del settore fisico indicate possono cambiare tra le sessioni**</span><span class="sxs-lookup"><span data-stu-id="0767e-280">**Issue 4: the reported physical sector size can change between sessions**</span></span>

<span data-ttu-id="0767e-281">Esistono molti scenari in cui le dimensioni del settore fisico segnalato dell'archiviazione sottostante che ospita Datastor possono cambiare.</span><span class="sxs-lookup"><span data-stu-id="0767e-281">There are many scenarios where the reported physical sector size of the underlying storage that hosts the Datastor may change.</span></span> <span data-ttu-id="0767e-282">Il più comune di questi si verifica quando si esegue la migrazione di Datastor a un altro volume o anche attraverso la rete.</span><span class="sxs-lookup"><span data-stu-id="0767e-282">The most common of these is when you migrate the Datastor to another volume, or even across the network.</span></span> <span data-ttu-id="0767e-283">Una modifica nelle dimensioni del settore fisico segnalate può essere un evento imprevisto per molte app e potenzialmente può causare la mancata inizializzazione di alcune app.</span><span class="sxs-lookup"><span data-stu-id="0767e-283">A change in the reported physical sector size may be an unexpected event for many apps and potentially can result in some apps failing to re-initialize.</span></span>

<span data-ttu-id="0767e-284">Questo non è lo scenario più semplice da supportare ed è indicato come consultivo.</span><span class="sxs-lookup"><span data-stu-id="0767e-284">This is not the easiest scenario to support, and is mentioned here as an advisory.</span></span> <span data-ttu-id="0767e-285">È necessario prendere in considerazione i requisiti di mobilità dei clienti e modificare di conseguenza il supporto per garantire che i clienti non vengano compromessi con i supporti di 4K nativi o 512e.</span><span class="sxs-lookup"><span data-stu-id="0767e-285">You should consider the mobility requirements of your customers and adjust your support accordingly to help ensure customers are not negatively impacted by using 4K native or 512e media.</span></span>

<span data-ttu-id="0767e-286">**Come un utente può recuperare le dimensioni del settore logico e fisico per un volume**</span><span class="sxs-lookup"><span data-stu-id="0767e-286">**How a user can retrieve the logical and physical sector size for a volume**</span></span>

<span data-ttu-id="0767e-287">In-box con Windows è un'utilità che consente di visualizzare le informazioni sulle dimensioni del settore per un volume.</span><span class="sxs-lookup"><span data-stu-id="0767e-287">In-box with Windows is a utility to display the sector size info for a volume.</span></span> <span data-ttu-id="0767e-288">Le versioni di Windows con fsutil supportato sono:</span><span class="sxs-lookup"><span data-stu-id="0767e-288">Versions of Windows with supported  fsutil  are:</span></span>

-   <span data-ttu-id="0767e-289">Windows 8</span><span class="sxs-lookup"><span data-stu-id="0767e-289">Windows 8</span></span>
-   <span data-ttu-id="0767e-290">Windows Server 2012</span><span class="sxs-lookup"><span data-stu-id="0767e-290">Windows Server 2012</span></span>
-   <span data-ttu-id="0767e-291">Windows 7 SP1 con Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="0767e-291">Windows 7 SP1 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="0767e-292">Windows 7 con Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="0767e-292">Windows 7 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="0767e-293">Windows Server 2008 R2 SP1 con Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="0767e-293">Windows Server 2008 R2 SP1 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="0767e-294">Windows Server 2008 R2 con Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="0767e-294">Windows Server 2008 R2 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="0767e-295">Windows Vista con Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="0767e-295">Windows Vista with Microsoft KB 2553708</span></span>
-   <span data-ttu-id="0767e-296">Windows Server 2008 con Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="0767e-296">Windows Server 2008 with Microsoft KB 2553708</span></span>

<span data-ttu-id="0767e-297">Per ottenere le informazioni sulle dimensioni del settore, chiamare l'utilità come indicato di seguito da un prompt dei comandi con privilegi elevati:</span><span class="sxs-lookup"><span data-stu-id="0767e-297">To get the sector size info, call the utility as follows from an elevated command prompt:</span></span>


```
fsutil fsinfo ntfsinfo <drive letter>
```



<span data-ttu-id="0767e-298">Un disco di settore 4K con emulazione a 512 byte ha il campo byte per settore impostato su 512 e il campo byte per settore fisico è impostato su 4096 come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="0767e-298">A 4K Sector Disk with 512-byte Emulation has the  Bytes Per Sector  field set to 512 and the  Bytes Per Physical Sector  field set to 4096 as follows:</span></span>

![byte per settore e per settore fisico di un disco del settore 4K con emulazione a 512 byte](images/4ksectordiskwith512emulation.png)

<span data-ttu-id="0767e-300">Un disco nativo 4K presenta i byte per settore e i byte per ogni campo di settore fisico entrambi impostati su 4096 come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="0767e-300">A 4K Native Disk has the  Bytes Per Sector  and  Bytes Per Physical Sector  fields both set to 4096 as follows:</span></span>

![byte per settore e per settore fisico di un disco nativo 4K](images/4knativedisk.png)

> [!Note]  
> <span data-ttu-id="0767e-302">Se il campo byte per settore fisico non è supportato, il driver di archiviazione non supporta la \_ \_ proprietà query di archiviazione IOCTL \_ oppure si è verificato un errore durante il recupero delle informazioni.</span><span class="sxs-lookup"><span data-stu-id="0767e-302">If the  Byte Per Physical Sector  field displays  Not Supported  then either the storage driver does not support IOCTL\_STORAGE\_QUERY\_PROPERTY, or there was an error in retrieving the info.</span></span>

 

## <a name="resources"></a><span data-ttu-id="0767e-303">Risorse</span><span class="sxs-lookup"><span data-stu-id="0767e-303">Resources</span></span>

-   [<span data-ttu-id="0767e-304">Dichiarazione del supporto generale di Windows</span><span class="sxs-lookup"><span data-stu-id="0767e-304">Windows General Support Statement</span></span>](https://support.microsoft.com/kb/2510009)
-   [<span data-ttu-id="0767e-305">Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="0767e-305">Microsoft KB 982018</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="0767e-306">Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="0767e-306">Microsoft KB 2553708</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="0767e-307">Hotfix per Windows 7 e Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="0767e-307">Hotfix for Windows 7 and Windows Server 2008 R2</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="0767e-308">Hotfix per Windows Vista e Windows Server 2008</span><span class="sxs-lookup"><span data-stu-id="0767e-308">Hotfix for Windows Vista and Windows Server 2008</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="0767e-309">Istruzione di supporto HyperV</span><span class="sxs-lookup"><span data-stu-id="0767e-309">HyperV Support Statement</span></span>](https://support.microsoft.com/kb/2515143)
-   [<span data-ttu-id="0767e-310">Informazioni generali sul codice di \_ \_ controllo delle proprietà di query di archiviazione IOCTL \_</span><span class="sxs-lookup"><span data-stu-id="0767e-310">General information about the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property)
-   [<span data-ttu-id="0767e-311">\_ \_ \_ Codice controllo proprietà query archiviazione IOCTL</span><span class="sxs-lookup"><span data-stu-id="0767e-311">IOCTL\_STORAGE\_QUERY\_PROPERTY Control Code</span></span>](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property)
-   [<span data-ttu-id="0767e-312">Informazioni generali sulla struttura del \_ \_ descrittore di allineamento dell'accesso di archiviazione \_</span><span class="sxs-lookup"><span data-stu-id="0767e-312">General information about the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure</span></span>](/windows-hardware/drivers/ddi/ntddstor/ns-ntddstor-_storage_access_alignment_descriptor)
-   [<span data-ttu-id="0767e-313">Descrizione della terminologia standard utilizzata per descrivere gli aggiornamenti software Microsoft</span><span class="sxs-lookup"><span data-stu-id="0767e-313">Description of the standard terminology used to describe Microsoft software updates</span></span>](https://support.microsoft.com/kb/824684/)
-   [<span data-ttu-id="0767e-314">Esempio di codice WDK con informazioni dettagliate su come estrarre le informazioni di allineamento dell'accesso di archiviazione segnalate dalla struttura del descrittore di accesso alla risorsa di archiviazione \_ \_ \_ quando si effettua una chiamata al \_ codice di controllo delle proprietà della query di archiviazione IOCTL \_ \_</span><span class="sxs-lookup"><span data-stu-id="0767e-314">WDK sample code with details for how to extract the reported storage access alignment info from the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure when making a call to the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows/win32/api/winioctl/ns-winioctl-storage_access_alignment_descriptor)
-   <span data-ttu-id="0767e-315">[Informazioni generali sulle opzioni di Command-Line di ImageX](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span><span class="sxs-lookup"><span data-stu-id="0767e-315">[General information about ImageX Command-Line Options](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span></span>
-   [<span data-ttu-id="0767e-316">Requisiti del driver del chipset Intel per supportare unità di settore a 4 KB</span><span class="sxs-lookup"><span data-stu-id="0767e-316">Intel Chipset driver requirements to support 4 KB Sector Drives</span></span>](https://www.intel.com/support/chipsets/imsm/sb/CS-031502.htm)

 

