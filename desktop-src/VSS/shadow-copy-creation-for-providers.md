---
description: Creazione di copie shadow per i provider
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: Creazione di copie shadow per i provider
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "104049844"
---
# <a name="shadow-copy-creation-for-providers"></a><span data-ttu-id="c58c2-103">Creazione di copie shadow per i provider</span><span class="sxs-lookup"><span data-stu-id="c58c2-103">Shadow Copy Creation for Providers</span></span>

## <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="c58c2-104">Processo di creazione della copia shadow</span><span class="sxs-lookup"><span data-stu-id="c58c2-104">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="c58c2-105">Un richiedente è l'applicazione che avvia la richiesta di creazione di una copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-105">A requester is the application that initiates the request to create a shadow copy.</span></span> <span data-ttu-id="c58c2-106">In genere, il richiedente è un'applicazione di backup.</span><span class="sxs-lookup"><span data-stu-id="c58c2-106">Typically the requester is a backup application.</span></span> <span data-ttu-id="c58c2-107">Se necessario, il servizio Copia Shadow del volume chiamerà i provider necessari.</span><span class="sxs-lookup"><span data-stu-id="c58c2-107">As necessary, VSS will call the providers involved.</span></span> <span data-ttu-id="c58c2-108">La maggior parte dei provider è interessata a tre richieste specifiche del richiedente.</span><span class="sxs-lookup"><span data-stu-id="c58c2-108">Most providers are interested in three specific requests from the requester.</span></span>

1.  <span data-ttu-id="c58c2-109">Il richiedente avvia l'attività di creazione copia shadow con una chiamata a [**IVssBackupComponents:: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="c58c2-109">The requester begins the shadow copy creation activity with a call to [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span> <span data-ttu-id="c58c2-110">Viene generato un **GUID** di tipo **VSS \_ ID** che identifica in modo univoco il set di copie shadow specifico, ovvero SnapshotSetId.</span><span class="sxs-lookup"><span data-stu-id="c58c2-110">This generates a **GUID** of type **VSS\_ID** that uniquely identifies this specific shadow copy set - the SnapshotSetId.</span></span> <span data-ttu-id="c58c2-111">Il provider non è associato a questo passaggio, ma la SnapshotSetId viene utilizzata estensivamente in tutti i passaggi successivi.</span><span class="sxs-lookup"><span data-stu-id="c58c2-111">The provider is not involved in this step, but the SnapshotSetId is used extensively in all subsequent steps.</span></span>
2.  <span data-ttu-id="c58c2-112">Per ogni volume che si desidera includere in questo set di copie shadow, il richiedente chiama [**IVssBackupComponents:: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="c58c2-112">For each volume it wishes to include in this shadow copy set, the requester calls [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="c58c2-113">VSS determina quale provider verrà utilizzato per eseguire la copia shadow del volume.</span><span class="sxs-lookup"><span data-stu-id="c58c2-113">VSS determines which provider will be used to shadow copy the volume.</span></span>
    -   <span data-ttu-id="c58c2-114">Più provider possono partecipare a un set di copie shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-114">Multiple providers may participate in a shadow copy set.</span></span> <span data-ttu-id="c58c2-115">Se, ad esempio, il volume di sistema e un volume di dati fanno parte dello stesso set di copie shadow, il provider di sistema può fungere da provider di copia shadow per il volume di sistema, mentre un provider hardware può fungere da provider di copia shadow per il volume di dati.</span><span class="sxs-lookup"><span data-stu-id="c58c2-115">For example, if the system volume and a data volume are part of the same shadow copy set, the system provider may serve as the shadow copy provider for the system volume while a hardware provider may serve as the shadow copy provider for the data volume.</span></span> <span data-ttu-id="c58c2-116">Entrambi i provider fanno parte dello stesso set di copie shadow e l'utente si aspetta la stessa coerenza temporizzata in entrambi i volumi.</span><span class="sxs-lookup"><span data-stu-id="c58c2-116">Both providers would be part of the same shadow copy set and the user would expect the same point-in-time consistency across both volumes.</span></span>
    -   <span data-ttu-id="c58c2-117">Per selezionare un provider hardware, il provider hardware deve essere in grado di supportare tutti i LUN che contribuiscono al volume specificato.</span><span class="sxs-lookup"><span data-stu-id="c58c2-117">For a hardware provider to be selected, the hardware provider must be able to support all LUNs contributing to the specified volume.</span></span>
    -   <span data-ttu-id="c58c2-118">A tutti i provider registrati viene data la possibilità di indicare il supporto per un determinato volume durante la creazione della copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-118">All registered providers are given the opportunity to indicate support for a given volume during shadow copy creation.</span></span> <span data-ttu-id="c58c2-119">Se più provider indicano il supporto, il servizio Copia Shadow del volume utilizzerà per impostazione predefinita i provider hardware, i provider software e infine il provider di sistema (se nessun altro provider indica il supporto per tale volume).</span><span class="sxs-lookup"><span data-stu-id="c58c2-119">If more than one provider indicates support, VSS will first default to hardware providers, then software providers, and finally the system provider (if no other provider indicates support for that volume).</span></span>
    -   <span data-ttu-id="c58c2-120">Un richiedente può eseguire l'override di questo ordine predefinito indicando in modo esplicito il provider necessario per creare la copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-120">A requester may override this default order by explicitly indicating the provider it requires to create the shadow copy.</span></span>
    -   <span data-ttu-id="c58c2-121">Se sono presenti più provider hardware che supportano un determinato volume, non vi è alcuna garanzia sull'ordine in cui verranno chiamati i provider hardware.</span><span class="sxs-lookup"><span data-stu-id="c58c2-121">If there are multiple hardware providers that support a given volume, there is no guarantee to the order in which the hardware providers will be called.</span></span>
3.  <span data-ttu-id="c58c2-122">Dopo una o più chiamate a [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), il richiedente può richiedere la creazione della copia shadow usando il metodo [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-122">After one or more calls to [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), the requester can ask for the shadow copy to be created by using the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method.</span></span> <span data-ttu-id="c58c2-123">VSS usa quindi il sistema per creare la copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-123">VSS then works with the system to create the shadow copy.</span></span> <span data-ttu-id="c58c2-124">Il metodo **DoSnapshotSet** esegue questa operazione in modo asincrono e il richiedente può eseguire il polling o attendere il completamento del processo di creazione della copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-124">The **DoSnapshotSet** method performs this work asynchronously, and the requester can either poll or wait for the shadow copy creation process to complete.</span></span>

<span data-ttu-id="c58c2-125">Questo diagramma illustra le interazioni tra il richiedente, il servizio VSS, il supporto del kernel VSS, gli eventuali writer VSS interessati ed eventuali provider hardware VSS.</span><span class="sxs-lookup"><span data-stu-id="c58c2-125">This diagram shows the interactions between the requester, the VSS service, the VSS kernel support, any VSS writers involved, and any VSS hardware providers.</span></span> <span data-ttu-id="c58c2-126">Per una descrizione dettagliata di queste interazioni, vedere [il processo di creazione della copia shadow](the-shadow-copy-creation-process.md) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-126">See [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md) for a detailed description of these interactions.</span></span>

![interazioni tra richiedente, componenti di backup, writer e provider](images/vssimpl.png)

<span data-ttu-id="c58c2-128">Al termine del processo di creazione della copia shadow, il richiedente può determinare se la creazione della copia shadow ha avuto esito positivo e, in caso contrario, determinare l'origine dell'errore.</span><span class="sxs-lookup"><span data-stu-id="c58c2-128">When the shadow copy creation process is complete, the requester can determine if the shadow copy creation was successful, and if not, determine the source of the failure.</span></span>

<span data-ttu-id="c58c2-129">L'intervallo di tempo tra il blocco e lo sblocco delle applicazioni writer deve essere ridotto a icona.</span><span class="sxs-lookup"><span data-stu-id="c58c2-129">The time interval between the freeze and thaw of the writer applications must be minimized.</span></span> <span data-ttu-id="c58c2-130">Il provider deve avviare in modo asincrono tutte le operazioni di preparazione correlate alla copia shadow, ad esempio un provider hardware che usa Plex a partire dalla sincronizzazione, nel metodo [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) e quindi attendere i completamenti nel metodo [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-130">Provider must asynchronously start all preparation work related to the shadow copy (such as a hardware provider that uses plexes starting the synchronization) in the [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) method, and then wait for the completions in the [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) method.</span></span>

<span data-ttu-id="c58c2-131">Sono presenti più finestre di limite di tempo che i provider devono seguire.</span><span class="sxs-lookup"><span data-stu-id="c58c2-131">There are multiple timing limit windows that providers must follow.</span></span> <span data-ttu-id="c58c2-132">Di conseguenza, i provider correttamente eseguiranno tutte le operazioni di elaborazione non necessarie prima di [**IVssProviderCreateSnapshotSet::P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) e dopo [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="c58c2-132">As a result, well-behaved providers will perform all unnecessary processing before [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) and after [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span></span>

<span data-ttu-id="c58c2-133">Il set di copie shadow viene corretto quando viene chiamato [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-133">The shadow copy set is fixed when [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) is called.</span></span> <span data-ttu-id="c58c2-134">Non è possibile aggiungere volumi aggiuntivi in un secondo momento perché i volumi aggiuntivi non condividono lo stesso punto nel tempo.</span><span class="sxs-lookup"><span data-stu-id="c58c2-134">Additional volumes cannot be added later because the additional volumes would not share the same point-in-time.</span></span>

<span data-ttu-id="c58c2-135">È previsto un limite di 64 volumi nel set di copie shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-135">There is a limit of 64 volumes in the shadow copy set.</span></span> <span data-ttu-id="c58c2-136">Un volume specifico può essere mappato a un intero LUN, una parte di un LUN o parti di più lun.</span><span class="sxs-lookup"><span data-stu-id="c58c2-136">A specific volume may map to an entire LUN, a portion of a LUN, or portions of multiple LUNs.</span></span> <span data-ttu-id="c58c2-137">La maggior parte delle configurazioni avrà un volume per LUN, sebbene sia possibile un mapping arbitrario.</span><span class="sxs-lookup"><span data-stu-id="c58c2-137">Most configurations will have one volume per LUN, although arbitrary mappings are possible.</span></span>

<span data-ttu-id="c58c2-138">Non esiste alcun limite al numero di set di copie shadow o al numero di set di copie shadow di un volume originale.</span><span class="sxs-lookup"><span data-stu-id="c58c2-138">There is no limit on the number of shadow copy sets or the number of shadow copy sets of an original volume.</span></span> <span data-ttu-id="c58c2-139">Un provider può definire limiti specifici o limitare dinamicamente in base alle risorse hardware disponibili.</span><span class="sxs-lookup"><span data-stu-id="c58c2-139">A provider may define specific limits, or dynamically limit based on hardware resources available.</span></span>

### <a name="point-in-time-for-writerless-applications"></a><span data-ttu-id="c58c2-140">Temporizzazione per le applicazioni con Writer</span><span class="sxs-lookup"><span data-stu-id="c58c2-140">Point-in-time for Writerless Applications</span></span>

<span data-ttu-id="c58c2-141">VSS include un supporto speciale che definisce il punto nel tempo comune per tutti i volumi in un set di copie shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-141">VSS includes special support that defines the point-in-time that is common for all volumes in a shadow copy set.</span></span> <span data-ttu-id="c58c2-142">I provider hardware non devono direttamente interfacciarsi con queste tecnologie kernel, perché vengono richiamati come parte della normale elaborazione del commit della copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-142">Hardware providers do not need to directly interface with these kernel technologies, since they are invoked as part of the normal shadow copy commit processing.</span></span> <span data-ttu-id="c58c2-143">Tuttavia, è utile comprendere i meccanismi utilizzati perché spiega la definizione di "temporizzazione" per le applicazioni senza Writer (applicazioni che non hanno esposto un'interfaccia VSS Writer e pertanto non partecipano al processo di creazione della copia shadow del volume).</span><span class="sxs-lookup"><span data-stu-id="c58c2-143">However, it is useful to understand the mechanisms used because it explains the definition of 'point-in-time' for writerless applications (applications that have not exposed a VSS Writer interface and therefore do not participate in the volume shadow copy creation process.)</span></span>

<span data-ttu-id="c58c2-144">Questo supporto del kernel VSS per il punto nel tempo comune viene distribuito tra il driver VolSnap.sys, i file System e VSS.</span><span class="sxs-lookup"><span data-stu-id="c58c2-144">This VSS kernel support for common point-in-time is distributed between the VolSnap.sys driver, the file systems, and VSS.</span></span>

1.  <span data-ttu-id="c58c2-145">Prima che venga richiamato il supporto del kernel VSS, VSS ha già:</span><span class="sxs-lookup"><span data-stu-id="c58c2-145">Before the VSS kernel support is invoked, VSS has already:</span></span>
    1.  <span data-ttu-id="c58c2-146">Determinare quali volumi devono essere interessati nella copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-146">Determined which volumes are to be involved in the shadow copy.</span></span>
    2.  <span data-ttu-id="c58c2-147">Determinazione del provider da utilizzare per ogni volume.</span><span class="sxs-lookup"><span data-stu-id="c58c2-147">Determined which provider is to be used on each volume.</span></span>
    3.  <span data-ttu-id="c58c2-148">Applicazioni bloccate che accettano messaggi di blocco/sblocco.</span><span class="sxs-lookup"><span data-stu-id="c58c2-148">Frozen applications that are accepting freeze/thaw messages.</span></span>
    4.  <span data-ttu-id="c58c2-149">Preparare i provider per la copia shadow chiamando i metodi [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-149">Prepared the providers for the shadow copy by calling the [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) methods.</span></span> <span data-ttu-id="c58c2-150">Tutti i provider sono ora in attesa di eseguire la creazione effettiva della copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-150">All providers are now waiting to do the actual shadow copy creation.</span></span>
2.  <span data-ttu-id="c58c2-151">Viene quindi creato il punto nel tempo.</span><span class="sxs-lookup"><span data-stu-id="c58c2-151">The point-in-time is then created.</span></span> <span data-ttu-id="c58c2-152">VSS Scarica contemporaneamente i file System in tutti i volumi di cui viene eseguita la copia shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-152">VSS concurrently flushes the file systems on all of the volumes that are to be shadow copied.</span></span>
    1.  <span data-ttu-id="c58c2-153">VSS emette un \_ comando IOCTL \_ VolSnap \_ per lo scaricamento e \_ \_ il controllo delle Scritture in ogni volume che Scarica i file System.</span><span class="sxs-lookup"><span data-stu-id="c58c2-153">VSS issues an IOCTL\_VOLSNAP\_FLUSH\_AND\_HOLD\_WRITES control command on each volume that flushes the file systems.</span></span> <span data-ttu-id="c58c2-154">Che IOCTL viene passato allo stack di archiviazione per VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="c58c2-154">That IOCTL is passed down the storage stack to VolSnap.sys.</span></span> <span data-ttu-id="c58c2-155">VolSnap.sys quindi include tutti i IRP di scrittura fino al passaggio 4 seguente.</span><span class="sxs-lookup"><span data-stu-id="c58c2-155">VolSnap.sys then holds all write IRPs until step 4 below.</span></span> <span data-ttu-id="c58c2-156">Qualsiasi file system (ad esempio RAW) senza supporto per questo nuovo comando IOCTL passa il comando IOCTL sconosciuto, dove viene nuovamente mantenuto da VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="c58c2-156">Any file system (such as RAW) without support for this new IOCTL passes the unknown IOCTL down—where it is again held by VolSnap.sys.</span></span> <span data-ttu-id="c58c2-157">Nei volumi NTFS viene eseguito il commit anche del log NTFS.</span><span class="sxs-lookup"><span data-stu-id="c58c2-157">On NTFS volumes, the flush also commits the NTFS log.</span></span>
    2.  <span data-ttu-id="c58c2-158">Questa operazione sospende tutte le attività dei metadati NTFS/FAT; il commit dei metadati del file system è stato eseguito in modo corretto.</span><span class="sxs-lookup"><span data-stu-id="c58c2-158">This suspends all NTFS/FAT metadata activity; the file system metadata is cleanly committed.</span></span>
    3.  <span data-ttu-id="c58c2-159">Istante copia shadow: VolSnap.sys causa la coda di tutti i IRP di scrittura successivi in tutti i volumi che devono essere replicati.</span><span class="sxs-lookup"><span data-stu-id="c58c2-159">The shadow copy instant: VolSnap.sys causes all subsequent write IRPs to be queued on all of the volumes that are to be shadow copied.</span></span>
    4.  <span data-ttu-id="c58c2-160">VolSnap.sys attende il completamento di tutte le Scritture in sospeso sui volumi copiati Shadow.</span><span class="sxs-lookup"><span data-stu-id="c58c2-160">VolSnap.sys waits for all pending writes on the shadow copied volumes to complete.</span></span> <span data-ttu-id="c58c2-161">I volumi sono ora tranquilli per quanto riguarda le Scritture e sono stati tranquilli esattamente nello stesso momento in ogni volume.</span><span class="sxs-lookup"><span data-stu-id="c58c2-161">The volumes are now quiescent with respect to writes, and were quiescent at exactly the same moment on each volume.</span></span> <span data-ttu-id="c58c2-162">Non sono previste garanzie per le Scritture nelle sezioni con mapping utente o nelle scritture eseguite tra (a) e (b) nei file System che non implementano il IOCTL di scaricamento (ad esempio, RAW).</span><span class="sxs-lookup"><span data-stu-id="c58c2-162">There are no guarantees about writes to user mapped sections or writes issued between (a) and (b) on file systems that do not implement the flush IOCTL (e.g. RAW).</span></span>
3.  <span data-ttu-id="c58c2-163">VSS indica a ogni provider di eseguire la copia shadow chiamando il metodo [**IVssProviderCreateSnapshotSet:: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-163">VSS instructs each provider to take in the shadow copy by calling the [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="c58c2-164">I provider devono disporre di tutti i preparativi, in modo che si tratta di un'operazione rapida.</span><span class="sxs-lookup"><span data-stu-id="c58c2-164">The providers should have all preparation done so that this is a quick operation.</span></span>

    <span data-ttu-id="c58c2-165">Si noti che il sistema di I/O è insufficiente solo durante l'esecuzione di questi metodi [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="c58c2-165">Note that the I/O system is quiescent only while these [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods are executing.</span></span> <span data-ttu-id="c58c2-166">Se un provider esegue una sincronizzazione dei LUN di origine e copia shadow, è necessario completare la sincronizzazione prima di restituire il metodo **CommitSnapshots** del provider.</span><span class="sxs-lookup"><span data-stu-id="c58c2-166">If a provider performs any synchronization of the source and shadow copy LUNs, this synchronization must be completed before the provider's **CommitSnapshots** method returns.</span></span> <span data-ttu-id="c58c2-167">Non può essere eseguita in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="c58c2-167">It cannot be performed asynchronously.</span></span>

4.  <span data-ttu-id="c58c2-168">Subito dopo la restituzione del metodo [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) dell'ultimo provider, VSS rilascia tutti i IRP di scrittura in sospeso (inclusi i IRP che bloccavano i file System al termine dei percorsi di commit) richiamando un altro oggetto IRP passato a VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="c58c2-168">Immediately after the last provider's [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) method returns, VSS releases all pending write IRPs (including the IRPs that were blocking the file systems at the conclusion of their commit paths) by invoking another IRP passed to VolSnap.sys.</span></span>
5.  <span data-ttu-id="c58c2-169">Se il processo di copia shadow ha avuto esito positivo, VSS Now:</span><span class="sxs-lookup"><span data-stu-id="c58c2-169">If the shadow copy process was successful, then VSS now:</span></span>
    1.  <span data-ttu-id="c58c2-170">Chiama [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) per i provider necessari.</span><span class="sxs-lookup"><span data-stu-id="c58c2-170">Calls [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) for the providers involved.</span></span>
    2.  <span data-ttu-id="c58c2-171">Chiama [**CVssWriter:: Onscongelate**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) per i writer necessari.</span><span class="sxs-lookup"><span data-stu-id="c58c2-171">Calls [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) for the writers involved.</span></span>
    3.  <span data-ttu-id="c58c2-172">Informa il richiedente che il processo di copia shadow è stato completato.</span><span class="sxs-lookup"><span data-stu-id="c58c2-172">Informs the requester that the shadow copy process has completed.</span></span>

<span data-ttu-id="c58c2-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) sono tutti critici per il tempo.</span><span class="sxs-lookup"><span data-stu-id="c58c2-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), to [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) are all time critical.</span></span> <span data-ttu-id="c58c2-174">Tutte le I/O dalle applicazioni con Writer sono bloccate da **PreCommitSnapshots** a **PostCommitSnapshots**; eventuali ritardi influiscono sulla disponibilità dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c58c2-174">All I/O from applications with writers is frozen from **PreCommitSnapshots** to **PostCommitSnapshots**; any delays affect application availability.</span></span> <span data-ttu-id="c58c2-175">Tutte le I/o di file, incluse le I/O dell'applicazione non writer, vengono sospese durante **CommitSnapshots**.</span><span class="sxs-lookup"><span data-stu-id="c58c2-175">All file I/O, including writerless application I/O, is suspended during **CommitSnapshots**.</span></span>

<span data-ttu-id="c58c2-176">I provider devono completare tutto il lavoro critico per il tempo prima di tornare da [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span><span class="sxs-lookup"><span data-stu-id="c58c2-176">Providers should complete all time-critical work prior to returning from [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span></span>

-   <span data-ttu-id="c58c2-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) deve essere restituito entro pochi secondi.</span><span class="sxs-lookup"><span data-stu-id="c58c2-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) should be returned within seconds.</span></span> <span data-ttu-id="c58c2-178">La fase **CommitSnapshots** si trova all'interno della finestra di svuotamento e di attesa.</span><span class="sxs-lookup"><span data-stu-id="c58c2-178">The **CommitSnapshots** phase is located within the Flush and Hold window.</span></span> <span data-ttu-id="c58c2-179">Il supporto del kernel VSS Annulla lo scaricamento e la conservazione che contiene l'i/O se la versione successiva non viene ricevuta entro 10 secondi e il processo di creazione della copia shadow non riuscirà.</span><span class="sxs-lookup"><span data-stu-id="c58c2-179">VSS kernel support will cancel the Flush and Hold that is holding the I/O if the subsequent release is not received within 10 seconds, and VSS will fail the shadow copy creation process.</span></span> <span data-ttu-id="c58c2-180">Altre attività verranno eseguite nel sistema, pertanto un provider non deve basarsi su un totale di 10 secondi.</span><span class="sxs-lookup"><span data-stu-id="c58c2-180">Other activities will be happening on the system, so a provider should not rely on having the full 10 seconds.</span></span> <span data-ttu-id="c58c2-181">Il provider non deve chiamare le API Win32 durante il commit. il numero di Scritture e il blocco imprevisto.</span><span class="sxs-lookup"><span data-stu-id="c58c2-181">The provider should not call Win32 APIs during commit as many will result in unexpected writes and block.</span></span> <span data-ttu-id="c58c2-182">Se il provider richiede più di alcuni secondi per completare la chiamata, esiste una probabilità elevata che questa operazione avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="c58c2-182">If the provider takes more than a few seconds to complete the call, there is a high probability that this will fail.</span></span>
-   <span data-ttu-id="c58c2-183">La sequenza completa da [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) al ritorno di [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) viene mappata alla finestra tra i writer che ricevono gli eventi di blocco e di sblocco.</span><span class="sxs-lookup"><span data-stu-id="c58c2-183">The full sequence from [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) to the return of [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) maps to the window between writers receiving the Freeze and Thaw events.</span></span> <span data-ttu-id="c58c2-184">Il valore predefinito del writer per questa finestra è 60 secondi, ma un writer può eseguire l'override di questo valore con un timeout minore.</span><span class="sxs-lookup"><span data-stu-id="c58c2-184">The writer default for this window is 60 seconds, but a writer may override this value with a smaller timeout.</span></span> <span data-ttu-id="c58c2-185">Ad esempio, il writer di Microsoft Exchange Server imposta il timeout su 20 secondi.</span><span class="sxs-lookup"><span data-stu-id="c58c2-185">For example, the Microsoft Exchange Server writer changes the timeout to 20 seconds.</span></span> <span data-ttu-id="c58c2-186">I provider non devono spendere più di un secondo o due in questo metodo.</span><span class="sxs-lookup"><span data-stu-id="c58c2-186">Providers should not spend more than a second or two in this method.</span></span>

<span data-ttu-id="c58c2-187">Durante [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) il provider deve evitare i/O di file non di paging; tali I/O hanno una probabilità molto elevata di deadlock.</span><span class="sxs-lookup"><span data-stu-id="c58c2-187">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) the provider must avoid any non-paging file I/O; such I/O has a very high probability of deadlocking.</span></span> <span data-ttu-id="c58c2-188">In particolare, il provider non deve scrivere in modo sincrono alcun registro di traccia o di debug.</span><span class="sxs-lookup"><span data-stu-id="c58c2-188">In particular, the provider should not synchronously write any debug or trace logs.</span></span>

 

 



