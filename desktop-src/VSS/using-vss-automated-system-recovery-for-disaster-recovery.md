---
description: Un'applicazione di backup e ripristino VSS che esegue il ripristino di emergenza (detto anche ripristino bare metal) può utilizzare il writer di ripristino automatico del sistema (ASR) insieme a Ambiente preinstallazione di Windows (Windows PE) per eseguire il backup e il ripristino di volumi critici e di altri componenti dello stato del sistema di avvio. L'applicazione di backup viene implementata come richiedente VSS.
ms.assetid: 13adfd79-f26a-4385-9b59-129d06fa72eb
title: Uso del ripristino automatico del sistema VSS per il ripristino di emergenza
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1e31ef8ba223f40928e2422fa92240656f94592d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "106307181"
---
# <a name="using-vss-automated-system-recovery-for-disaster-recovery"></a><span data-ttu-id="5f4c7-104">Uso del ripristino automatico del sistema VSS per il ripristino di emergenza</span><span class="sxs-lookup"><span data-stu-id="5f4c7-104">Using VSS Automated System Recovery for Disaster Recovery</span></span>

<span data-ttu-id="5f4c7-105">Un'applicazione di backup e ripristino VSS che esegue il ripristino di emergenza (detto anche ripristino bare metal) può utilizzare il writer di ripristino automatico del sistema (ASR) insieme a Ambiente preinstallazione di Windows (Windows PE) per eseguire il backup e il ripristino di volumi critici e di altri componenti dello stato del sistema di avvio.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-105">A VSS backup-and-recovery application that performs disaster recovery (also called bare-metal recovery) can use the Automated System Recovery (ASR) writer together with Windows Preinstallation Environment (Windows PE) to back up and restore critical volumes and other components of the bootable system state.</span></span> <span data-ttu-id="5f4c7-106">L'applicazione di backup viene implementata come richiedente VSS.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-106">The backup application is implemented as a VSS requester.</span></span>

<span data-ttu-id="5f4c7-107">**Nota**  Per le applicazioni che usano ASR è necessario concedere in licenza Windows PE.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-107">**Note**  Applications that use ASR must license Windows PE.</span></span>

<span data-ttu-id="5f4c7-108">**Windows Server 2003 e Windows XP:** ASR non è implementato come VSS writer.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-108">**Windows Server 2003 and Windows XP:** ASR is not implemented as a VSS writer.</span></span>

<span data-ttu-id="5f4c7-109">Per informazioni sugli strumenti di traccia che è possibile usare con ASR, vedere [uso degli strumenti di traccia con le applicazioni VSS ASR](using-tracing-tools-with-vss-asr-applications.md).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-109">For information about tracing tools that you can use with ASR, see [Using Tracing Tools with VSS ASR Applications](using-tracing-tools-with-vss-asr-applications.md).</span></span>

<span data-ttu-id="5f4c7-110">**Contenuto dell'articolo:**</span><span class="sxs-lookup"><span data-stu-id="5f4c7-110">**In this article:**</span></span>

-   [<span data-ttu-id="5f4c7-111">Panoramica delle attività della fase di backup</span><span class="sxs-lookup"><span data-stu-id="5f4c7-111">Overview of Backup Phase Tasks</span></span>](#overview-of-backup-phase-tasks)
-   [<span data-ttu-id="5f4c7-112">Scelta dei componenti critici di cui eseguire il backup</span><span class="sxs-lookup"><span data-stu-id="5f4c7-112">Choosing Which Critical Components to Back Up</span></span>](#choosing-which-critical-components-to-back-up)
-   [<span data-ttu-id="5f4c7-113">Panoramica delle attività della fase di ripristino</span><span class="sxs-lookup"><span data-stu-id="5f4c7-113">Overview of Restore Phase Tasks</span></span>](#overview-of-restore-phase-tasks)
-   [<span data-ttu-id="5f4c7-114">Esclusione di tutti i dischi per un volume</span><span class="sxs-lookup"><span data-stu-id="5f4c7-114">Excluding All Disks for a Volume</span></span>](#excluding-all-disks-for-a-volume)

## <a name="overview-of-backup-phase-tasks"></a><span data-ttu-id="5f4c7-115">Panoramica delle attività della fase di backup</span><span class="sxs-lookup"><span data-stu-id="5f4c7-115">Overview of Backup Phase Tasks</span></span>

<span data-ttu-id="5f4c7-116">Al momento del backup, il richiedente esegue i passaggi seguenti.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-116">At backup time, the requester performs the following steps.</span></span>

> [!Note]  
> <span data-ttu-id="5f4c7-117">Tutti i passaggi sono necessari se non diversamente specificato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-117">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="5f4c7-118">Chiamare la funzione [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) per creare un'istanza dell'interfaccia [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) e chiamare il metodo [**IVssBackupComponents:: InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) per inizializzare l'istanza di per la gestione di un backup.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-118">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) method to initialize the instance to manage a backup.</span></span>
2.  <span data-ttu-id="5f4c7-119">Chiamare [**IVssBackupComponents:: secontext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) per impostare il contesto per l'operazione di copia shadow.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-119">Call [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) to set the context for the shadow copy operation.</span></span>
3.  <span data-ttu-id="5f4c7-120">Chiamare [**IVssBackupComponents:: SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) per configurare il backup.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-120">Call [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) to configure the backup.</span></span> <span data-ttu-id="5f4c7-121">Impostare il parametro *bBackupBootableSystemState* su **true** per indicare che il backup includerà uno stato del sistema di avvio.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-121">Set the *bBackupBootableSystemState* parameter to **true** to indicate that the backup will include a bootable system state.</span></span>
4.  <span data-ttu-id="5f4c7-122">Scegliere i componenti critici nel documento di metadati del writer di ASR writer per eseguire il backup e chiamare [**IVssBackupComponents:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) per ognuno di essi.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-122">Choose which critical components in the ASR writer's Writer Metadata Document to back up and call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) for each of them.</span></span>
5.  <span data-ttu-id="5f4c7-123">Chiamare [**IVssBackupComponents:: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) per creare un nuovo set di copie shadow vuoto.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-123">Call [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create a new, empty shadow copy set.</span></span>
6.  <span data-ttu-id="5f4c7-124">Chiamare [**IVssBackupComponents:: GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) per avviare il contatto asincrono con i writer.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-124">Call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) to initiate asynchronous contact with writers.</span></span>
7.  <span data-ttu-id="5f4c7-125">Chiamare [**IVssBackupComponents:: GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) per recuperare il documento di metadati writer del writer ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-125">Call [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) to retrieve the ASR writer's Writer Metadata Document.</span></span> <span data-ttu-id="5f4c7-126">L'ID writer per il writer ASR è BE000CBE-11FE-4426-9C58-531AA6355FC4 e la stringa del nome writer è "ASR writer".</span><span class="sxs-lookup"><span data-stu-id="5f4c7-126">The writer ID for the ASR writer is BE000CBE-11FE-4426-9C58-531AA6355FC4, and the writer name string is "ASR Writer".</span></span>
8.  <span data-ttu-id="5f4c7-127">Chiamare [**IVssExamineWriterMetadata:: saveasxml**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) per salvare una copia del documento di metadati del writer del writer ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-127">Call [**IVssExamineWriterMetadata::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) to save a copy of the ASR writer's Writer Metadata Document.</span></span>
9.  <span data-ttu-id="5f4c7-128">Chiamare [**IVssBackupComponents:: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) per ogni volume che può partecipare alle copie shadow per aggiungere il volume al set di copie shadow.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-128">Call [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) for each volume that can participate in shadow copies to add the volume to the shadow copy set.</span></span>
10. <span data-ttu-id="5f4c7-129">Chiamare [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) per notificare ai writer la preparazione per un'operazione di backup.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-129">Call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) to notify writers to prepare for a backup operation.</span></span>
11. <span data-ttu-id="5f4c7-130">Chiamare [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) e [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (o [**IVssBackupComponentsEx3:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) per verificare lo stato del writer ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-130">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (or [**IVssBackupComponentsEx3::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) to verify the status of the ASR writer.</span></span>
12. <span data-ttu-id="5f4c7-131">A questo punto, è possibile eseguire una query per i messaggi di errore impostati dal writer nel metodo [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-131">At this point, you can query for failure messages that were set by the writer in its [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method.</span></span> <span data-ttu-id="5f4c7-132">Per un esempio di codice in cui viene illustrato come visualizzare questi messaggi, vedere [**IVssComponentEx:: GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-132">For example code that shows how to view these messages, see [**IVssComponentEx::GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span></span>
13. <span data-ttu-id="5f4c7-133">Chiamare [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) per creare una copia shadow del volume.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-133">Call [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) to create a volume shadow copy.</span></span>
14. <span data-ttu-id="5f4c7-134">Chiamare [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) e [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) per verificare lo stato del writer ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-134">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) to verify the status of the ASR writer.</span></span>
15. <span data-ttu-id="5f4c7-135">Eseguire il backup dei dati.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-135">Back up the data.</span></span>
16. <span data-ttu-id="5f4c7-136">Indica se l'operazione di backup ha avuto esito positivo chiamando [**IVssBackupComponents:: SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-136">Indicate whether the backup operation succeeded by calling [**IVssBackupComponents::SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span></span>
17. <span data-ttu-id="5f4c7-137">Chiamare [**IVssBackupComponents:: BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) per indicare che l'operazione di backup è stata completata.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-137">Call [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) to indicate that the backup operation has completed.</span></span>
18. <span data-ttu-id="5f4c7-138">Chiamare [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) e [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-138">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span></span> <span data-ttu-id="5f4c7-139">La memoria dello stato della sessione del writer è una risorsa limitata e i writer devono riutilizzare gli Stati della sessione.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-139">The writer session state memory is a limited resource, and writers must eventually reuse session states.</span></span> <span data-ttu-id="5f4c7-140">Questo passaggio contrassegna lo stato della sessione di backup del writer come completato e notifica a VSS che questo slot della sessione di backup può essere riutilizzato da un'operazione di backup successiva.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-140">This step marks the writer’s backup session state as completed and notifies VSS that this backup session slot can be reused by a subsequent backup operation.</span></span>
    > [!Note]  
    > <span data-ttu-id="5f4c7-141">Questa operazione è necessaria solo in Windows Server 2008 con Service Pack 2 (SP2) e versioni precedenti.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-141">This is only necessary on Windows Server 2008 with Service Pack 2 (SP2) and earlier.</span></span>

     

19. <span data-ttu-id="5f4c7-142">Chiamare [**IVssBackupComponents:: saveasxml**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) per salvare una copia del documento dei componenti di backup del richiedente.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-142">Call [**IVssBackupComponents::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) to save a copy of the requester's Backup Components Document.</span></span> <span data-ttu-id="5f4c7-143">Le informazioni nel documento componenti di backup vengono utilizzate in fase di ripristino quando il richiedente chiama il metodo [**IVssBackupComponents:: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-143">The information in the Backup Components Document is used at restore time when the requester calls the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method.</span></span>

## <a name="choosing-which-critical-components-to-back-up"></a><span data-ttu-id="5f4c7-144">Scelta dei componenti critici di cui eseguire il backup</span><span class="sxs-lookup"><span data-stu-id="5f4c7-144">Choosing Which Critical Components to Back Up</span></span>

<span data-ttu-id="5f4c7-145">Nella fase di inizializzazione del backup, il writer ASR segnala i tipi di componenti seguenti nel documento di metadati del writer:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-145">In the backup initialization phase, the ASR writer reports the following types of components in its Writer Metadata Document:</span></span>

-   <span data-ttu-id="5f4c7-146">Volumi critici, ad esempio i volumi di avvio, di sistema e di ambiente ripristino Windows (Windows RE) e la partizione RE di Windows associata all'istanza di Windows Vista o Windows Server 2008 attualmente in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-146">Critical volumes, such as the boot, system, and Windows Recovery Environment (Windows RE) volumes and the Windows RE partition that is associated with the instance of Windows Vista or Windows Server 2008 that is currently running.</span></span> <span data-ttu-id="5f4c7-147">Un volume è un *volume critico* se contiene informazioni sullo stato del sistema.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-147">A volume is a *critical volume* if it contains system state information.</span></span> <span data-ttu-id="5f4c7-148">I volumi di avvio e di sistema vengono inclusi automaticamente.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-148">The boot and system volumes are included automatically.</span></span> <span data-ttu-id="5f4c7-149">Il richiedente deve includere tutti i volumi contenenti componenti critici del sistema segnalati da writer, ad esempio i volumi che contengono la Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-149">The requester must include all volumes that contain system-critical components reported by writers, such as the volumes that contain the Active Directory.</span></span> <span data-ttu-id="5f4c7-150">I componenti critici del sistema sono contrassegnati come "non selezionabili per il backup".</span><span class="sxs-lookup"><span data-stu-id="5f4c7-150">System-critical components are marked as "not selectable for backup."</span></span> <span data-ttu-id="5f4c7-151">In VSS "non selezionabile" significa "non facoltativo".</span><span class="sxs-lookup"><span data-stu-id="5f4c7-151">In VSS, "not selectable" means "not optional."</span></span> <span data-ttu-id="5f4c7-152">Pertanto, il richiedente deve eseguire il backup come parte dello stato del sistema.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-152">Thus, the requester is required to back them up as part of system state.</span></span> <span data-ttu-id="5f4c7-153">Per ulteriori informazioni, vedere [backup e ripristino dello stato del sistema](locating-additional-system-files.md).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-153">For more information, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span> <span data-ttu-id="5f4c7-154">I componenti per i quali \_ \_ non è impostato il flag di stato del sistema VSS CF non \_ sono critici per il \_ sistema.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-154">Components for which the VSS\_CF\_NOT\_SYSTEM\_STATE flag is set are not system-critical.</span></span>
    > [!Note]  
    > <span data-ttu-id="5f4c7-155">Il componente ASR è un componente critico del sistema segnalato dal writer di ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-155">The ASR component is a system-critical component that is reported by the ASR writer.</span></span>

     

-   <span data-ttu-id="5f4c7-156">Dischi.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-156">Disks.</span></span> <span data-ttu-id="5f4c7-157">Ogni disco fisso del computer viene esposto come componente in ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-157">Every fixed disk on the computer is exposed as a component in ASR.</span></span> <span data-ttu-id="5f4c7-158">Se un disco non è stato escluso durante il backup, verrà assegnato durante il ripristino e potrà essere ricreato e formattato nuovamente.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-158">If a disk was not excluded during backup, it will be assigned during restore and can be re-created and reformatted.</span></span> <span data-ttu-id="5f4c7-159">Si noti che durante il ripristino, il richiedente può comunque creare nuovamente un disco che è stato escluso durante il backup chiamando il metodo [**IVssBackupComponents:: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-159">Note that during restore, the requester can still re-create a disk that was excluded during backup by calling the [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) method.</span></span> <span data-ttu-id="5f4c7-160">Se si seleziona un disco in un pacchetto di disco dinamico, è necessario selezionare anche tutti gli altri dischi del pacchetto.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-160">If one disk in a dynamic disk pack is selected, all other disks in that pack must also be selected.</span></span> <span data-ttu-id="5f4c7-161">Se viene selezionato un volume perché è un volume critico, ovvero un volume che contiene informazioni sullo stato del sistema, è necessario selezionare anche ogni disco che contiene un extent per tale volume.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-161">If a volume is selected because it is a critical volume (that is, a volume that contains system state information), every disk that contains an extent for that volume must also be selected.</span></span> <span data-ttu-id="5f4c7-162">Per trovare gli extent per un volume, usare il codice IOCTL volume del volume del disco di controllo degli [**\_ \_ \_ \_ \_ extent**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-162">To find the extents for a volume, use the [**IOCTL\_VOLUME\_GET\_VOLUME\_DISK\_EXTENTS**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) control code.</span></span>

    > [!Note]  
    > <span data-ttu-id="5f4c7-163">Durante il backup, il richiedente deve includere tutti i dischi fissi.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-163">During backup, the requester should include all fixed disks.</span></span> <span data-ttu-id="5f4c7-164">Se il disco che contiene il set di backup del richiedente è un disco locale, questo disco deve essere incluso.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-164">If the disk that contains the requester's backup set is a local disk, this disk should be included.</span></span> <span data-ttu-id="5f4c7-165">Durante il ripristino, il richiedente deve escludere il disco che contiene il set di backup del richiedente per impedirne la sovrascrittura.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-165">During restore, the requester must exclude the disk that contains the requester's backup set to prevent it from being overwritten.</span></span>

     

    <span data-ttu-id="5f4c7-166">In un ambiente di clustering, ASR non ricrea il layout dei dischi condivisi del cluster.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-166">In a clustering environment, ASR does not re-create the layout of the cluster's shared disks.</span></span> <span data-ttu-id="5f4c7-167">I dischi devono essere ripristinati online dopo il ripristino del sistema operativo nel ripristino di Windows.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-167">Those disks should be restored online after the operating system is restored in the Windows RE.</span></span>

-   <span data-ttu-id="5f4c7-168">Archivio dati configurazione di avvio (BCD).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-168">Boot Configuration Data (BCD) store.</span></span> <span data-ttu-id="5f4c7-169">Questo componente specifica il percorso della directory che contiene l'archivio BCD.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-169">This component specifies the path of the directory that contains the BCD store.</span></span> <span data-ttu-id="5f4c7-170">Il richiedente deve specificare questo componente ed eseguire il backup di tutti i file nella directory dell'archivio BCD.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-170">The requester must specify this component and back up all of the files in the BCD store directory.</span></span> <span data-ttu-id="5f4c7-171">Per ulteriori informazioni sull'archivio BCD, vedere [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-171">For more information about the BCD store, see [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span></span>
    > [!Note]  
    > <span data-ttu-id="5f4c7-172">Nei computer che utilizzano l'interfaccia EFI (Extended Firmware Interface), la partizione di sistema EFI (ESP) è sempre nascosta e non può essere inclusa in una copia shadow del volume.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-172">On computers that use the Extended Firmware Interface (EFI), the EFI System Partition (ESP) is always hidden and cannot be included in a volume shadow copy.</span></span> <span data-ttu-id="5f4c7-173">Il richiedente deve eseguire il backup del contenuto di questa partizione.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-173">The requester must back up the contents of this partition.</span></span> <span data-ttu-id="5f4c7-174">Poiché questa partizione non può essere inclusa in una copia shadow del volume, il backup può essere eseguito solo dal volume Live, non dalla copia shadow.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-174">Because this partition cannot be included in a volume shadow copy, the backup can only be performed from the live volume, not from the shadow copy.</span></span> <span data-ttu-id="5f4c7-175">Per ulteriori informazioni su EFI e ESP, vedere [la](/windows-hardware/drivers/bringup/)pagina relativa alla guida.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-175">For more information about EFI and ESP, see [Bring up guide](/windows-hardware/drivers/bringup/).</span></span>

<span data-ttu-id="5f4c7-176">I nomi dei componenti utilizzano i formati seguenti:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-176">The component names use the following formats:</span></span>

-   <span data-ttu-id="5f4c7-177">Per i componenti del disco, il formato è</span><span class="sxs-lookup"><span data-stu-id="5f4c7-177">For disk components, the format is</span></span>

    <COMPONENT logicalPath="Disks" componentName="harddisk*n*" componentType="filegroup" />

    <span data-ttu-id="5f4c7-178">dove *n* è il numero del disco.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-178">where *n* is the disk number.</span></span> <span data-ttu-id="5f4c7-179">Viene registrato solo il numero del disco.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-179">Only the disk number is recorded.</span></span> <span data-ttu-id="5f4c7-180">Per ottenere il numero del disco, usare il codice di controllo del [**\_ numero di dispositivo IOCTL storage \_ get \_ \_**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-180">To get the disk number, use the [**IOCTL\_STORAGE\_GET\_DEVICE\_NUMBER**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) control code.</span></span>

-   <span data-ttu-id="5f4c7-181">Per i componenti del volume, il formato è</span><span class="sxs-lookup"><span data-stu-id="5f4c7-181">For volume components, the format is</span></span>

    <COMPONENT logicalPath="Volumes" componentName="Volume{*GUID*}" componentType="filegroup" />

    <span data-ttu-id="5f4c7-182">dove *GUID* è il GUID del volume.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-182">where *GUID* is the volume GUID.</span></span>

-   <span data-ttu-id="5f4c7-183">Per il componente archivio BCD, il formato è</span><span class="sxs-lookup"><span data-stu-id="5f4c7-183">For the BCD store component, the format is</span></span>

    <COMPONENT logicalPath="BCD" componentName="BCD" componentType="filegroup" componentCaption = "This is the path to the boot BCD store and the boot managers...All the files in this directory need to be backed up...">

    <span data-ttu-id="5f4c7-184">Se la partizione di sistema ha un nome di GUID del volume, questo componente è selezionabile.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-184">If the system partition has a volume GUID name, this component is selectable.</span></span> <span data-ttu-id="5f4c7-185">In caso contrario, non è selezionabile.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-185">Otherwise, it is not selectable.</span></span>

    > [!Note]  
    > <span data-ttu-id="5f4c7-186">ASR aggiunge i file al gruppo di file del componente archivio BCD come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-186">ASR adds the files to the BCD store component's file group as follows:</span></span>
    >
    > -   <span data-ttu-id="5f4c7-187">Per i dischi EFI, ASR aggiunge</span><span class="sxs-lookup"><span data-stu-id="5f4c7-187">For EFI disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="5f4c7-188">*SystemPartitionPath* \\ \\Avvio Microsoft \\ EFI \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="5f4c7-188">*SystemPartitionPath*\\EFI\\Microsoft\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="5f4c7-189">dove *SystemPartitionPath* è il percorso della partizione di sistema.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-189">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="5f4c7-190">Per i dischi GPT, ASR aggiunge</span><span class="sxs-lookup"><span data-stu-id="5f4c7-190">For GPT disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="5f4c7-191">*SystemPartitionPath* \\ Eseguire l'avvio \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="5f4c7-191">*SystemPartitionPath*\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="5f4c7-192">dove *SystemPartitionPath* è il percorso della partizione di sistema.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-192">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="5f4c7-193">Il percorso della partizione di sistema si trova nella seguente chiave del registro di sistema: **HKEY \_ Local \_ computer** \\ **System** \\ **Setup** \\ **SYSTEMPARTITION**</span><span class="sxs-lookup"><span data-stu-id="5f4c7-193">The system partition path can be found under the following registry key: **HKEY\_LOCAL\_MACHINE**\\**System**\\**Setup**\\**SystemPartition**</span></span>

     

<span data-ttu-id="5f4c7-194">Durante il ripristino, è necessario ripristinare tutti i componenti contrassegnati come volumi critici.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-194">On restore, all components that are marked as critical volumes must be restored.</span></span> <span data-ttu-id="5f4c7-195">Se non è possibile ripristinare uno o più volumi critici, l'operazione di ripristino avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-195">If one or more critical volumes cannot be restored, the restore operation fails.</span></span>

<span data-ttu-id="5f4c7-196">Nella fase di [**preripristino**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) della sequenza di ripristino i dischi che non sono stati esclusi durante il backup vengono creati nuovamente e riformattati per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-196">In the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) phase of the restore sequence, disks that were not excluded during backup are re-created and reformatted by default.</span></span> <span data-ttu-id="5f4c7-197">Tuttavia, non vengono ricreate o riformattate se soddisfano le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-197">However, they are not re-created or reformatted if they meet the following conditions:</span></span>

-   <span data-ttu-id="5f4c7-198">Un disco di base non viene ricreato se il layout del disco è intatto o se sono state apportate modifiche aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-198">A basic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="5f4c7-199">Il layout del disco è intatto se vengono soddisfatte le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-199">The disk layout is intact if the following conditions are true:</span></span>
    -   <span data-ttu-id="5f4c7-200">La firma del disco, lo stile del disco (GPT o MBR), le dimensioni del settore logico e l'offset iniziale del volume non vengono modificati.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-200">The disk signature, disk style (GPT or MBR), logical sector size, and volume start offset are not changed.</span></span>
    -   <span data-ttu-id="5f4c7-201">La dimensione del volume non viene ridotta.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-201">The volume size is not decreased.</span></span>
    -   <span data-ttu-id="5f4c7-202">Per i dischi GPT, l'identificatore di partizione non viene modificato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-202">For GPT disks, the partition identifier is not changed.</span></span>
-   <span data-ttu-id="5f4c7-203">Se il layout del disco è intatto o se sono state apportate modifiche aggiuntive, un disco dinamico non viene ricreato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-203">A dynamic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="5f4c7-204">Affinché un disco dinamico sia intatto, è necessario che siano soddisfatte tutte le condizioni per un disco di base.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-204">For a dynamic disk to be intact, all of the conditions for a basic disk must be met.</span></span> <span data-ttu-id="5f4c7-205">Inoltre, l'intera struttura del volume del pacchetto del disco deve essere intatta.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-205">In addition, the entire disk pack's volume structure must be intact.</span></span> <span data-ttu-id="5f4c7-206">La struttura del volume del pacchetto del disco è intatta se soddisfa le condizioni seguenti, che si applicano ai dischi MBR e GPT:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-206">The disk pack's volume structure is intact if it meets the following conditions, which apply to both MBR and GPT disks:</span></span>
    -   <span data-ttu-id="5f4c7-207">Il numero di volumi disponibili nel pacchetto fisico durante il ripristino deve essere maggiore o uguale al numero di volumi specificati nei metadati del writer ASR durante il backup.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-207">The number of volumes that are available in the physical pack during restore must be greater than or equal to the number of volumes that were specified in the ASR writer metadata during backup.</span></span>
    -   <span data-ttu-id="5f4c7-208">Il numero di [*Plex*](../vds/virtual-disk-service-glossary-all.md) per volume deve essere invariato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-208">The number of [*plexes*](../vds/virtual-disk-service-glossary-all.md) per volume must be unchanged.</span></span>
    -   <span data-ttu-id="5f4c7-209">Il numero di [*membri*](../vds/virtual-disk-service-glossary-all.md) deve essere invariato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-209">The number of [*members*](../vds/virtual-disk-service-glossary-all.md) must be unchanged.</span></span>
    -   <span data-ttu-id="5f4c7-210">Il numero di extent del disco fisico deve essere maggiore del numero di extent del disco specificati nei metadati del writer ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-210">The number of physical disk extents must be greater than the number of disk extents specified in the ASR writer metadata.</span></span>
    -   <span data-ttu-id="5f4c7-211">Un pacchetto intatto rimane intatto quando vengono aggiunti volumi aggiuntivi o se un volume nel pacchetto viene esteso, ad esempio da un volume semplice a un volume con spanning.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-211">An intact pack remains intact when additional volumes are added, or if a volume in the pack is extended (for example, from a simple volume to a spanned volume).</span></span>
        > [!Note]  
        > <span data-ttu-id="5f4c7-212">Se viene eseguito il mirroring di un volume semplice, il pacchetto non è intatto e verrà ricreato per garantire che il BCD e lo stato del volume di avvio rimangano coerenti dopo il ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-212">If a simple volume is mirrored, the pack is not intact and will be re-created to ensure that the BCD and boot volume state remain consistent after restore.</span></span> <span data-ttu-id="5f4c7-213">Se i volumi vengono eliminati, il pacchetto viene ricreato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-213">If volumes are deleted, the pack is re-created.</span></span>

         
-   <span data-ttu-id="5f4c7-214">Se la struttura del volume del pacchetto del disco dinamico è intatta ed è stata apportata solo una modifica aggiuntiva, i dischi nel pacchetto non vengono ricreati.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-214">If the dynamic disk pack's volume structure is intact and only additive changes have been made to it, the disks in the pack are not re-created.</span></span>

    <span data-ttu-id="5f4c7-215">**Windows Vista:** I dischi dinamici vengono sempre ricreati.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-215">**Windows Vista:** Dynamic disks are always re-created.</span></span> <span data-ttu-id="5f4c7-216">Si noti che questo comportamento è stato modificato con Windows Server 2008 e Windows Vista con Service Pack 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-216">Note that this behavior has changed with Windows Server 2008 and Windows Vista with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="5f4c7-217">In qualsiasi momento prima dell'inizio della fase di ripristino, il richiedente può specificare che i dischi devono essere formattati in modo rapido impostando la chiave del registro di sistema **HKEY \_ Local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-217">At any time before the beginning of the restore phase, the requester can specify that the disks should be quick-formatted by setting the **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key.</span></span> <span data-ttu-id="5f4c7-218">In questa chiave è presente un valore denominato **QuickFormat** con il tipo di dati reg \_ DWORD.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-218">Under this key, there is a value named **QuickFormat** with the data type REG\_DWORD.</span></span> <span data-ttu-id="5f4c7-219">Se questo valore non esiste, è necessario crearlo.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-219">If this value does not exist, you should create it.</span></span> <span data-ttu-id="5f4c7-220">Impostare i dati del valore **QuickFormat** su 1 per la formattazione rapida oppure su 0 per la formattazione lenta.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-220">Set the data of the **QuickFormat** value to 1 for quick formatting or 0 for slow formatting.</span></span>

<span data-ttu-id="5f4c7-221">Se il valore **QuickFormat** non esiste, i dischi verranno formattati lentamente.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-221">If the **QuickFormat** value does not exist, the disks will be slow-formatted.</span></span>

<span data-ttu-id="5f4c7-222">La formattazione rapida è notevolmente più veloce rispetto alla formattazione lenta (detta anche formattazione completa).</span><span class="sxs-lookup"><span data-stu-id="5f4c7-222">Quick formatting is significantly faster than slow formatting (also called full formatting).</span></span> <span data-ttu-id="5f4c7-223">Tuttavia, la formattazione rapida non verifica ogni settore nel volume.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-223">However, quick formatting does not verify each sector on the volume.</span></span>

## <a name="overview-of-restore-phase-tasks"></a><span data-ttu-id="5f4c7-224">Panoramica delle attività della fase di ripristino</span><span class="sxs-lookup"><span data-stu-id="5f4c7-224">Overview of Restore Phase Tasks</span></span>

<span data-ttu-id="5f4c7-225">Al momento del ripristino, il richiedente esegue i passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="5f4c7-225">At restore time, the requester performs the following steps:</span></span>

> [!Note]  
> <span data-ttu-id="5f4c7-226">Tutti i passaggi sono necessari se non diversamente specificato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-226">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="5f4c7-227">Chiamare la funzione [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) per creare un'istanza dell'interfaccia [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) e chiamare il metodo [**IVssBackupComponents:: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) per inizializzare l'istanza per il ripristino caricando il documento relativo ai componenti di backup del richiedente nell'istanza di.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-227">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method to initialize the instance for restore by loading the requester's Backup Components Document into the instance.</span></span>
2.  <span data-ttu-id="5f4c7-228">\[Questo passaggio è necessario solo se il richiedente deve modificare se è specificato "IncludeDisk" o "ExcludeDisk" per uno o più dischi. \] Chiamare [**IVssBackupComponents:: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) per impostare le opzioni di ripristino per i componenti del writer ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-228">\[This step is required only if the requester needs to change whether "IncludeDisk" or "ExcludeDisk" is specified for one or more disks.\] Call [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to set the restore options for the ASR writer components.</span></span> <span data-ttu-id="5f4c7-229">Il writer di ASR supporta le opzioni seguenti: "IncludeDisk" consente al richiedente di includere un disco nel sistema di destinazione da considerare per il ripristino, anche se non è stato selezionato durante la fase di backup.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-229">The ASR writer supports the following options: "IncludeDisk" allows the requester to include a disk on the target system to be considered for restore, even if it was not selected during the backup phase.</span></span> <span data-ttu-id="5f4c7-230">"ExcludeDisk" consente al richiedente di impedire la nuova creazione di un disco nel sistema di destinazione.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-230">"ExcludeDisk" allows the requester to prevent a disk on the target system from being re-created.</span></span> <span data-ttu-id="5f4c7-231">Si noti che se si specifica "ExcludeDisk" per un disco che contiene un volume critico, la chiamata successiva a [**IVssBackupComponents::P il ripristino**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-231">Note that if "ExcludeDisk" is specified for a disk that contains a critical volume, the subsequent call to [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) will fail.</span></span>

    <span data-ttu-id="5f4c7-232">Nell'esempio seguente viene illustrato come utilizzare [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) per impedire la ricreazione del disco 0 e del disco 1 e l'inserimento di driver di terze parti nel volume di avvio ripristinato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-232">The following example shows how to use [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to prevent disk 0 and disk 1 from being re-created and inject third-party drivers into the restored boot volume.</span></span>

    <span data-ttu-id="5f4c7-233">**Windows server 2008, Windows Vista, Windows server 2003 e Windows XP:** L'inserimento di driver di terze parti non è supportato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-233">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Injection of third-party drivers is not supported.</span></span>

    <span data-ttu-id="5f4c7-234">Nell'esempio si presuppone che il puntatore [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , m \_ pBackupComponents, sia valido.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-234">The example assumes that the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) pointer, m\_pBackupComponents, is valid.</span></span>

    ```C++
        m_pBackupComponents->SetRestoreOptions(
            AsrWriterId,
            VSS_CT_FILEGROUP,
            NULL,
            TEXT("ASR"),
            TEXT("\"ExcludeDisk\"=\"0\", \"ExcludeDisk\"=\"1\" "),
            TEXT("\"InjectDrivers\"=\"1\" ")
            );
    ```

    

    <span data-ttu-id="5f4c7-235">Per escludere tutti i dischi per un volume specificato, vedere gli argomenti seguenti "esclusione di tutti i dischi per un volume".</span><span class="sxs-lookup"><span data-stu-id="5f4c7-235">To exclude all disks for a specified volume, see the following "Excluding All Disks for a Volume."</span></span>

3.  <span data-ttu-id="5f4c7-236">Chiamare [**IVssBackupComponents::P Rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) per notificare al writer di ASR di prepararsi per un'operazione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-236">Call [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) to notify the ASR writer to prepare for a restore operation.</span></span> <span data-ttu-id="5f4c7-237">Chiamare [**IVssAsync:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) il numero di volte necessario fino a quando il valore di stato restituito nel parametro *pHrResult* non è un oggetto asincrono di VSS in \_ \_ \_ sospeso.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-237">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>
4.  <span data-ttu-id="5f4c7-238">Ripristinare i dati.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-238">Restore the data.</span></span> <span data-ttu-id="5f4c7-239">Nella fase di ripristino, ASR riconfigura il percorso GUID del volume ( \\ \\ ? \\ Volume {GUID}) per ogni volume in modo che corrisponda al percorso GUID del volume utilizzato durante la fase di backup.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-239">In the restore phase, ASR reconfigures the volume GUID path (\\\\?\\Volume{GUID}) for each volume to match the volume GUID path that was used during the backup phase.</span></span> <span data-ttu-id="5f4c7-240">Tuttavia, le lettere di unità non vengono mantenute, perché ciò provocherebbe conflitti con le lettere di unità assegnate automaticamente nell'ambiente di ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-240">However, drive letters are not preserved, because this would cause collisions with the drive letters that are automatically assigned in the recovery environment.</span></span> <span data-ttu-id="5f4c7-241">Pertanto, quando si ripristinano i dati, il richiedente deve usare i percorsi GUID del volume, non le lettere di unità, per accedere ai volumi.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-241">Thus, when restoring data, the requester must use volume GUID paths, not drive letters, to access the volumes.</span></span>
5.  <span data-ttu-id="5f4c7-242">Impostare la  \\  \\ chiave del registro di sistema HKLM Software **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** per indicare il set di volumi che sono stati ripristinati o riformattati.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-242">Set the **HKLM**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key to indicate the set of volumes that have been restored or reformatted.</span></span>

    <span data-ttu-id="5f4c7-243">In questa chiave è presente un valore denominato **RestoredVolumes** con il tipo di dati reg \_ \_ multisz.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-243">Under this key, there is a value named **RestoredVolumes** with the data type REG\_MULTI\_SZ.</span></span> <span data-ttu-id="5f4c7-244">Se questo valore non esiste, è necessario crearlo.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-244">If this value does not exist, you should create it.</span></span> <span data-ttu-id="5f4c7-245">Con questo valore, il richiedente deve creare una voce del GUID del volume per ogni volume che è stato ripristinato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-245">Under this value, your requester should create a volume GUID entry for each volume that has been restored.</span></span> <span data-ttu-id="5f4c7-246">Il formato di questa voce deve essere il seguente: \\ \\ ? \\ Volume {78618c8f-aefd-11da-a898-806e6f6e6963}.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-246">This entry should be in the following format: \\\\?\\Volume{78618c8f-aefd-11da-a898-806e6f6e6963}.</span></span> <span data-ttu-id="5f4c7-247">Ogni volta che viene eseguito un ripristino bare metal, ASR imposta il valore **RestoredVolumes** sul set di volumi ripristinati da ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-247">Each time a bare-metal recovery is performed, ASR sets the **RestoredVolumes** value to the set of volumes that ASR restored.</span></span> <span data-ttu-id="5f4c7-248">Se il richiedente ha ripristinato volumi aggiuntivi, deve impostare questo valore sull'Unione del set di volumi che il richiedente ha ripristinato e il set di volumi ripristinati da ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-248">If the requester restored additional volumes, it should set this value to the union of the set of volumes that the requester restored and the set of volumes that ASR restored.</span></span> <span data-ttu-id="5f4c7-249">Se il richiedente non ha usato ASR, deve sostituire l'elenco di volumi.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-249">If the requester did not use ASR, it should replace the list of volumes.</span></span>

    <span data-ttu-id="5f4c7-250">È inoltre necessario creare un valore denominato **LastInstance** con il tipo di dati reg \_ SZ.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-250">You should also create a value named **LastInstance** with the data type REG\_SZ.</span></span> <span data-ttu-id="5f4c7-251">Questa chiave deve contenere un cookie casuale che identifica in modo univoco l'operazione di ripristino corrente.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-251">This key should contain a random cookie that uniquely identifies the current restore operation.</span></span> <span data-ttu-id="5f4c7-252">Un cookie di questo tipo può essere creato usando le funzioni [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) e [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-252">Such a cookie can be created by using the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) and [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) functions.</span></span> <span data-ttu-id="5f4c7-253">Ogni volta che viene eseguito un ripristino bare metal, ASR Reimposta questo valore del registro di sistema per notificare ai richiedenti e alle applicazioni di backup non VSS che si è verificato il ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-253">Each time a bare-metal recovery is performed, ASR resets this registry value to notify requesters and non-VSS backup applications that the recovery has occurred.</span></span>

6.  <span data-ttu-id="5f4c7-254">Chiamare [**IVssBackupComponents::P ostrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) per indicare la fine dell'operazione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-254">Call [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) to indicate the end of the restore operation.</span></span> <span data-ttu-id="5f4c7-255">Chiamare [**IVssAsync:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) il numero di volte necessario fino a quando il valore di stato restituito nel parametro *pHrResult* non è un oggetto asincrono di VSS in \_ \_ \_ sospeso.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-255">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>

<span data-ttu-id="5f4c7-256">Nella fase di ripristino, ASR può creare o rimuovere partizioni per ripristinare lo stato precedente del computer.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-256">In the restore phase, ASR may create or remove partitions to restore the computer to its previous state.</span></span> <span data-ttu-id="5f4c7-257">I richiedenti non devono tentare di eseguire il mapping dei numeri di disco dalla fase di backup alla fase di ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-257">Requesters must not attempt to map disk numbers from the backup phase to the restore phase.</span></span>

<span data-ttu-id="5f4c7-258">Durante il ripristino, il richiedente deve escludere il disco che contiene il set di backup del richiedente.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-258">On restore, the requester must exclude the disk that contains the requester's backup set.</span></span> <span data-ttu-id="5f4c7-259">In caso contrario, il set di backup può essere sovrascritto dall'operazione di ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-259">Otherwise, the backup set can be overwritten by the restore operation.</span></span>

<span data-ttu-id="5f4c7-260">Durante il ripristino, un disco viene escluso se non è stato selezionato come componente durante il backup o se è esplicitamente escluso chiamando [**IVssBackupComponents:: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) con l'opzione "ExcludeDisk" durante il ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-260">On restore, a disk is excluded if it was not selected as a component during backup, or if it is explicitly excluded by calling [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) with the "ExcludeDisk" option during restore.</span></span>

<span data-ttu-id="5f4c7-261">È importante tenere presente che durante il ripristino di emergenza di WinPE è presente la funzionalità del writer ASR, ma non sono disponibili altri writer e il servizio VSS non è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-261">It is important to note that during WinPE disaster recovery, ASR writer functionality is present, but no other writers are available, and the VSS service is not running.</span></span> <span data-ttu-id="5f4c7-262">Al termine del ripristino di emergenza di WinPE, il computer è stato riavviato e il sistema operativo Windows è in esecuzione normalmente, il servizio VSS può essere avviato e il richiedente può eseguire qualsiasi operazione di ripristino aggiuntiva che richiede la partecipazione di writer diversi dal writer di ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-262">After WinPE disaster recovery has completed, the computer has restarted, and the Windows operating system is running normally, the VSS service can be started, and the requester can perform any additional restore operations that require participation of writers other than the ASR writer.</span></span>

<span data-ttu-id="5f4c7-263">Se durante la sessione di ripristino l'applicazione di backup rileva che gli ID univoci del volume rimangono invariati e pertanto tutti i volumi dal momento del backup sono presenti e intatti in WinPE, l'applicazione di backup può continuare a ripristinare solo il contenuto dei volumi, senza coinvolgere ASR.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-263">If during the restore session the backup application detects that the volume unique IDs are unchanged, and therefore all volumes from the time of the backup are present and intact in WinPE, the backup application can proceed to restore only the contents of the volumes, without involving ASR.</span></span> <span data-ttu-id="5f4c7-264">In questo caso, l'applicazione di backup deve indicare che il computer è stato ripristinato impostando la seguente chiave del registro di sistema nel sistema operativo ripristinato: **HKEY \_ Local \_ Machine** \\ **software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession**</span><span class="sxs-lookup"><span data-stu-id="5f4c7-264">In this case, the backup application should indicate that the computer was restored by setting the following registry key in the restored operating system: **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession**</span></span>

<span data-ttu-id="5f4c7-265">In questa chiave specificare **LastInstance** per il nome del valore, reg \_ SZ per il tipo di valore e un cookie casuale, ad esempio un GUID creato dalla funzione [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) , per i dati del valore.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-265">Under this key, specify **LastInstance** for the value name, REG\_SZ for the value type, and a random cookie (such as a GUID created by the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) function) for the value data.</span></span>

<span data-ttu-id="5f4c7-266">Se durante la sessione di ripristino l'applicazione di backup rileva che uno o più volumi sono stati modificati o mancanti, l'applicazione di backup deve usare ASR per eseguire il ripristino.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-266">If during the restore session the backup application detects that one or more volumes are changed or missing, the backup application should use ASR to perform the restore.</span></span> <span data-ttu-id="5f4c7-267">ASR ricreerà i volumi esattamente come si trovavano al momento del backup e imposterà la chiave del registro di sistema **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="5f4c7-267">ASR will re-create the volumes exactly the way they were at the time of the backup and set the **RestoreSession** registry key.</span></span>

## <a name="excluding-all-disks-for-a-volume"></a><span data-ttu-id="5f4c7-268">Esclusione di tutti i dischi per un volume</span><span class="sxs-lookup"><span data-stu-id="5f4c7-268">Excluding All Disks for a Volume</span></span>

<span data-ttu-id="5f4c7-269">Nell'esempio seguente viene illustrato come escludere tutti i dischi per un volume specificato.</span><span class="sxs-lookup"><span data-stu-id="5f4c7-269">The following example shows how to exclude all disks for a specified volume.</span></span>


```C++
HRESULT BuildRestoreOptionString
(
    const WCHAR             *pwszVolumeNamePath,
    CMyString               *pstrExclusionList
)
{
    HANDLE                  hVolume           = INVALID_HANDLE_VALUE;
    DWORD                   cbSize            = 0;
    VOLUME_DISK_EXTENTS     * pExtents        = NULL;
    DISK_EXTENT             * pExtent         = NULL;
    ULONG                   i                 = 0;
    BOOL                    fIoRet            = FALSE;
    WCHAR                   wszDest[MAX_PATH] = L"";
    CMyString               strVolumeName;
    CMyString               strRestoreOption;

    // Open a handle to the volume device.
    strVolumeName.Set( pwszVolumeNamePath );
    // If the volume name contains a trailing backslash, remove it.
    strVolumeName.UnTrailing( L'\\' );
    hVolume = ::CreateFile(strVolumeName, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, NULL, 0);
    // Check whether the call to CreateFile succeeded.

    // Get the list of disks used by this volume.
    cbSize = sizeof(VOLUME_DISK_EXTENTS);
    pExtents = (VOLUME_DISK_EXTENTS *)::CoTaskMemAlloc(cbSize);

    ::ZeroMemory(pExtents, cbSize);

    fIoRet = ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
    if ( !fIoRet && GetLastError() == ERROR_MORE_DATA )
    {
        // Allocate more memory.
        cbSize = FIELD_OFFSET(VOLUME_DISK_EXTENTS, Extents) + pExtents->NumberOfDiskExtents * sizeof(DISK_EXTENT);
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;

        pExtents = (VOLUME_DISK_EXTENTS *) ::CoTaskMemAlloc(cbSize);
        // Check whether CoTaskMemAlloc returned an out-of-memory error.
        ::ZeroMemory(pExtents, cbSize);

        // Now the buffer should be big enough.
        ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
        // Check whether the IOCTL succeeded.
    }
    // Check for errors; note that the IOCTL can fail for a reason other than insufficient memory.

    // For each disk, mark it to be excluded in the Restore Option string.
    for (i = 0; i < pExtents->NumberOfDiskExtents; i++)
    {
        pExtent = &pExtents->Extents[i];

        *wszDest = L'\0';
        StringCchPrintf(wszDest, MAX_PATH, L"\"ExcludeDisk\"=\"%d\", ", pExtent->DiskNumber); // check errors

        strRestoreOption.Append(wszDest);
        // Check for an out-of-memory error.
    }

    // Remove the trailing comma.
    strRestoreOption.TrimRight();
    strRestoreOption.UnTrailing(',');

    // Set the output parameter.
    strRestoreOption.Transfer( pstrExclusionList );

Exit:
    if( pExtents )
    {
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;
    }

    if( hVolume != INVALID_HANDLE_VALUE )
    {
        ::CloseHandle(hVolume);
        hVolume = INVALID_HANDLE_VALUE;
    }

    return ( hr );
}

```



 

 
