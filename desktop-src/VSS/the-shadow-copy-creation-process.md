---
description: Processo di creazione della copia shadow
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Processo di creazione della copia shadow
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dae0d0cff8e4afdbecb5c61a934be1a9c9b731cbdbee8778afd714f6802ca2ae
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/11/2021
ms.locfileid: "119056359"
---
# <a name="the-shadow-copy-creation-process"></a>Processo di creazione della copia shadow

Di seguito è riportata una descrizione dettagliata del ruolo del provider hardware nella creazione di un set di copie shadow. Per un diagramma di questo processo, vedere [Creazione di copie shadow per i provider.](shadow-copy-creation-for-providers.md)

1.  Quando il richiedente aggiunge ogni volume al set di copie shadow, vss determina i LUN associati. Ad esempio, un volume con spanning può essere composto da più LUN. VSS crea un'informazione [**LUN VDS \_ \_ iniziale**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) usando le informazioni sul dispositivo fisico per ogni LUN.
2.  VSS chiama [**AreLunsSupported per**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) determinare se il provider supporta una copia shadow per tale LUN. Il provider hardware usa le [**informazioni LUN VDS \_ \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) per determinare se i LUN sono supportati. Questa determinazione deve essere totale o nulla. Lo stesso provider di hardware deve supportare tutti i LUN che contribuiscono a un volume specifico. Nell'esempio di volume con spanning, il provider non può indicare che supporta solo uno dei LUN che costituiscono il volume.
3.  Per ogni volume nel set di copie shadow, VSS chiama [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) con la stessa matrice di strutture DI INFORMAZIONI [**\_ LUN \_ VDS.**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) All'interno di una singola chiamata, tutti i LUN nell'array sono univoci, ma lo stesso LUN può apparire in una chiamata successiva ogni volta che lo stesso LUN contribuisce a più volumi. Il provider deve gestire correttamente la distinzione tra maiuscole e minuscole.
4.  Immediatamente dopo [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), VSS imposta i flag di sola lettura, nascosto, senza lettera di unità e copia shadow in tutti i LUN interessati. I flag vengono implementati usando settori nascosti su dischi MBR o bit specifici del sistema operativo nella voce di intestazione della partizione nei dischi GPT. I flag causeranno la visualizzazione di tutti i volumi nei dischi interessati nei computer riceventi come di sola lettura e nascosti. Si noti che in questa fase non è stato eseguito il commit dei LUN copiati in modo che, in caso di arresto anomalo del sistema, i flag verranno cancellati e il LUN originale non verrà interessato. Ovvero, tutti i volumi nel LUN originale verranno trattati come di consueto e manteneranno le assegnazioni originali delle lettere di unità, le cartelle montate e lo stato di lettura/scrittura.
    > [!Note]  
    > I provider non devono tentare di modificare alcun flag LUN.

     

5.  In [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)viene eseguito il commit dei LUN della copia shadow. **CommitSnapshots** deve essere restituito entro pochi secondi o l'intero processo di creazione della copia shadow avrà probabilmente esito negativo.
6.  Dopo [**CommitSnapshots,**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)VSS cancella i flag in tutti i LUN originali coinvolti nella copia shadow. Poiché a questo punto è stato eseguito il commit dei LUN della copia shadow, i LUN della copia shadow mantengono questi flag.
7.  Dopo [**IVssProviderCreateSnapshotSet::P ostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), VSS cancella i flag LUN (impostati dopo [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots)**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)e notifica ai writer di eseguire lo thaw. VSS chiama quindi i metodi [**IVssProviderCreateSnapshotSet::P reFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) e [**IVssProviderCreateSnapshotSet::P ostFinalCommitSnapshots.**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots)
8.  VSS recupera una matrice di strutture di informazioni [**\_ LUN \_ VDS,**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) una per ogni LUN della copia shadow appena creata, chiamando [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). Il provider deve fornire informazioni sufficienti per consentire al Servizio Copia Shadow del volume e al provider di identificare le copie shadow in qualsiasi momento successivo e in qualsiasi sistema connesso al sottosistema. Al momento, i LUN della copia shadow non dovrebbero essere accessibili a questo computer. Il provider deve usare un meccanismo diverso dalla semplice lettura delle informazioni dal LUN.
9.  Per le copie shadow trasportabili, vss aggiunge quanto segue al documento dei componenti di backup che descrive il set di copie shadow:
    1.  Matrice LUN [**VDS \_ LUN \_ INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) originale.
    2.  Nuova matrice di informazioni LUN [**VDS \_ della \_**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) copia shadow.
    3.  Extent del disco per ogni volume nel set di copie shadow.
10. Per le copie shadow di importazione automatica, viene avviato il processo di importazione. In [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)il provider riceverà le informazioni [**\_ LUN \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generate in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) al momento della creazione. Durante **LocateLuns,** il provider deve rendere visibili al sistema i LUN delle copie shadow. Il provider non deve causare una nuova analisi del bus. VsS causerà la nuova analisi e l'enumerazione per consentire l'individuazioni dei LUN da parte del PNP e la modalità online dei volumi.
11. VSS chiama [**IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) per i dischi appena arrivati nel sistema. VSS usa la matrice di informazioni [**LUN VDS \_ \_ della**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) copia shadow da **FillInLunInfo,** confrontandolo con le informazioni **\_ LUN \_ VDS** generate durante la creazione in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e gli extent del disco per ogni volume nel set di copie shadow per identificare i LUN della copia shadow appena arrivati.
12. A questo punto, tutti i volumi contenuti nei LUN delle copie shadow vengono montati in modalità nascosta e di sola lettura e il Servizio Copia Shadow del volume ha un mapping dal volume originale al volume della copia shadow.

Poiché un singolo LUN può contenere parti di più volumi, il set di LUN della copia shadow può includere volumi "aggiuntivi". Questi volumi non fanno parte del set di copie shadow e non devono essere usati perché non sono garantiti per essere coerenti.

Dopo l'importazione, è possibile accedere alla copia shadow tramite [**il metodo IVssBackupComponents::Query.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) Una copia shadow può anche essere esposta come lettera di unità, cartella montata o condivisione usando [**IVssBackupComponents::ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Un set di copie shadow può anche essere convertito in un LUN normale usando il [**metodo IVssBackupComponents::BreakSnapshotSet.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) Da qui le applicazioni di gestione possono usare le API di gestione del disco appropriate per gestire ulteriormente il LUN, ad esempio la modifica degli attributi di lettura/scrittura.

### <a name="transportable-shadow-copies-on-a-san"></a>Copie shadow trasportabili in una rete SAN

A partire da Windows Server 2003, Datacenter Edition e Windows Server 2003, edizione Enterprise, vss abilita i set di copie shadow trasportabili in una rete SAN. Dal punto di vista di un provider in grado di trasportare LUN tra host, esiste una piccola o nessuna differenza tra un set di copie shadow non trasportabile e un set di copie shadow trasportabili.

**Windows Server 2003, edizione Standard, Windows Server 2003, Web Edition e Windows XP:** I set di copie shadow trasportabili non sono supportati. Tutte le edizioni di Windows Server 2003 con Service Pack 1 (SP1) supportano set di copie shadow trasportabili.

I set di copie shadow trasportabili devono essere creati con l'attributo **\_ \_ \_ TRANSPORTABLE ATTR DI VSS VOLSNAP** aggiunto al contesto della copia shadow descritto dall'enumerazione [**\_ VSS \_ VOLUME SNAPSHOT \_ \_ ATTRIBUTES.**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) Tutti i volumi nel set devono essere trasportabili. La restituzione dell'esito positivo da [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)indica che il provider non solo supporta il LUN, ma anche che può trasportarlo. La creazione di un set di copie shadow trasportabili termina quando vss registra le informazioni LUN nel documento dei componenti di backup. Un set di copie shadow può essere importato una sola volta dopo la creazione iniziale.

Nel computer ricevente il richiedente importa il set di copie shadow. Il [**metodo IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) usa il documento dei componenti di backup che descrive il set di copie shadow come input. L'importazione procede nel modo seguente:

1.  VSS costruisce una matrice di strutture di informazioni [**\_ LUN \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) della copia shadow dal documento dei componenti di backup.
2.  Quando VSS chiama [**IVssHardwareSnapshotProvider::LocateLuns,**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)la matrice di strutture di informazioni [**\_ LUN \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generate in [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) verrà passata al provider. Durante l'elaborazione di questo metodo, il provider deve rendere visibili al sistema i LUN della copia shadow. Il provider non deve causare una nuova analisi del bus. VsS attiverà la nuova analisi e l'enumerazione per consentire l'individuazioni dei LUN da parte del PNP e la modalità online dei volumi.
3.  VSS chiama [**IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) per i dischi appena arrivati nel sistema. VSS usa la matrice LUN della copia shadow di strutture di informazioni [**\_ \_ LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) da **FillInLunInfo,** confrontandolo con le informazioni LUN VDS generate durante la creazione del set di copie shadow in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e gli extent del disco per ogni volume nel set di copie shadow per identificare i **\_ LUN \_** della copia shadow appena arrivati.
4.  A questo punto, tutti i volumi contenuti nei LUN trasportati vengono montati nascosti e di sola lettura e il Servizio Copia Shadow del volume ha un mapping dal volume originale al volume della copia shadow.

Sia per il singolo computer che per il caso trasportabile, la sequenza è simile a partire dal punto in cui [**viene chiamato GetTargetLuns.**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) Per l'importazione automatica, la procedura viene completata direttamente dopo la creazione.

 

 
