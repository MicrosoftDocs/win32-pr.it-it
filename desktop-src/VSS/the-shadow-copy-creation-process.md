---
description: Processo di creazione della copia shadow
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Processo di creazione della copia shadow
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "103751599"
---
# <a name="the-shadow-copy-creation-process"></a>Processo di creazione della copia shadow

Di seguito è riportata una descrizione dettagliata del ruolo del provider hardware nella creazione di un set di copie shadow. Per un diagramma di questo processo, vedere [creazione di copie shadow per i provider](shadow-copy-creation-for-providers.md).

1.  Quando il richiedente aggiunge ogni volume al set di copie shadow, VSS determina i LUN associati. Ad esempio, un volume con spanning potrebbe essere composto da più lun. VSS crea [**\_ \_ le informazioni iniziali del LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) usando le informazioni sul dispositivo fisico per ogni lun.
2.  VSS chiama [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) per determinare se il provider supporta una copia shadow per il lun. Il provider hardware utilizza le [**\_ \_ informazioni del LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) per determinare se i LUN sono supportati. Questa determinazione deve essere costituita solo da un valore qualsiasi, ovvero lo stesso provider hardware deve supportare tutti i LUN che contribuiscono a un volume specifico. Nell'esempio relativo al volume con spanning, il provider non può indicare che supporta solo uno dei LUN che comprendono il volume.
3.  Per ogni volume nel set di copie shadow, VSS chiama [**IVssHardwareSnapshotProvider:: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) con la stessa matrice di strutture di [**\_ \_ informazioni lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) . All'interno di una singola chiamata, tutti i LUN nella matrice sono univoci, ma lo stesso LUN può essere visualizzato in una chiamata successiva ogni volta che lo stesso LUN contribuisce a più volumi. Il provider deve gestire correttamente tale caso.
4.  Subito dopo [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), il servizio Copia Shadow del volume imposta i flag di sola lettura, nascosti, nessuna lettera di unità e copia shadow su tutti i LUN interessati. I flag vengono implementati usando settori nascosti nei dischi MBR o BITS specifici del sistema operativo nella voce di intestazione della partizione nei dischi GPT. I flag comporteranno la superficie di tutti i volumi sui dischi interessati nei computer riceventi come di sola lettura e nascosti. Si noti che in questa fase non è stato eseguito il commit dei lun copiati in Shadow, quindi, in caso di arresto anomalo del sistema, i flag verranno cancellati e il LUN originale non sarà interessato. Ovvero tutti i volumi nel LUN originale verranno considerati normali, mantenendo le assegnazioni di lettera di unità, le cartelle montate e lo stato di lettura/scrittura originali.
    > [!Note]  
    > I provider non devono tentare di modificare i flag LUN.

     

5.  In [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), viene eseguito il commit dei lun delle copie shadow. **CommitSnapshots** deve essere restituito entro pochi secondi o l'intero processo di creazione della copia shadow avrà probabilmente esito negativo.
6.  Dopo [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS Cancella i flag su tutti i LUN originali necessari per la copia shadow. Poiché è stato eseguito il commit dei lun delle copie shadow, i LUN della copia shadow mantengono questi flag.
7.  Dopo [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), VSS Cancella i flag lun (impostati dopo [**IVssProviderCreateSnapshotSet:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) e invia una notifica ai writer per sbloccarli. VSS chiama quindi i metodi [**IVssProviderCreateSnapshotSet::P refinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) e [**IVssProviderCreateSnapshotSet::P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) del provider.
8.  VSS recupera una matrice di strutture di [**\_ \_ informazioni lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , una per ogni LUN di copia shadow appena creato, chiamando [**IVssHardwareSnapshotProvider:: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). Il provider deve fornire informazioni sufficienti per consentire a VSS e al provider di identificare le copie shadow in un secondo momento e in qualsiasi sistema connesso al sottosistema. Al momento, i LUN delle copie shadow non devono essere accessibili a questo computer. il provider deve usare un meccanismo diverso da semplicemente leggendo le informazioni del LUN.
9.  Per le copie shadow trasportabili, VSS aggiunge quanto segue al documento componenti di backup che descrive il set di copie shadow:
    1.  Matrice di [**\_ \_ informazioni lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) lun originale.
    2.  La nuova matrice di [**\_ \_ informazioni lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) di copia shadow.
    3.  Extent del disco per ogni volume nel set di copie shadow.
10. Per le copie shadow di importazione automatica, inizia il processo di importazione. In [**IVssHardwareSnapshotProvider:: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)al provider verranno fornite le [**\_ \_ informazioni relative al lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generate in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) al momento della creazione. Durante **LocateLuns**, il provider deve rendere visibili al sistema tali LUN di copia shadow. Il provider non deve causare una ripetizione dell'analisi del bus. VSS determinerà la ripetizione dell'analisi e l'enumerazione per consentire l'individuazione dei LUN da parte di PNP e i volumi da portare online.
11. VSS chiama [**IVssHardwareSnapshotProvider:: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) per i dischi appena arrivati nel sistema. VSS usa la matrice di [**\_ \_ informazioni**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) del LUN VDS di copia shadow da **FillInLunInfo**, confrontandolo con **le \_ \_ informazioni relative al lun VDS** generate durante la creazione in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e gli extent del disco per ogni volume nel set di copie shadow per identificare i LUN delle copie shadow appena raggiunte.
12. A questo punto, tutti i volumi contenuti nei lun delle copie shadow sono montati nascosti e di sola lettura e VSS dispone di un mapping dal volume originale al volume di copia shadow.

Poiché un singolo LUN può contenere parti di più volumi, il set di lun delle copie shadow può includere volumi "aggiuntivi". Questi volumi non fanno parte del set di copie shadow e non devono essere usati perché non sono necessariamente coerenti.

Dopo l'importazione, è possibile accedere alla copia shadow tramite il metodo [**IVssBackupComponents:: query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) . Una copia shadow può essere esposta anche come lettera di unità, cartella montata o condivisione usando [**IVssBackupComponents:: ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Un set di copie shadow può anche essere convertito in un LUN normale usando il metodo [**IVssBackupComponents:: BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) . Le applicazioni di gestione possono usare le API di gestione del disco appropriate per gestire ulteriormente il LUN, ad esempio la modifica degli attributi di lettura/scrittura.

### <a name="transportable-shadow-copies-on-a-san"></a>Copie shadow trasportabili in una rete SAN

A partire da Windows Server 2003, Datacenter Edition e Windows Server 2003, Enterprise Edition, VSS consente i set di copie shadow trasportabili in una rete SAN. Dal punto di vista di un provider in grado di trasportare i LUN tra gli host, non esiste una differenza minima tra un set non transportabile e una copia shadow trasportabile.

**Windows server 2003, Standard Edition, Windows server 2003, Web Edition e Windows XP:** I set di copie shadow trasportabili non sono supportati. Tutte le edizioni di Windows Server 2003 con Service Pack 1 (SP1) supportano set di copie shadow trasportabili.

I set di copie shadow trasportabili devono essere creati con l'attributo **\_ \_ \_ Transportable VSS VolSnap attr** aggiunto al contesto della copia shadow descritto dall'enumerazione [**\_ VSS \_ volume \_ snapshot \_ Attributes**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) . Tutti i volumi nel set devono essere trasportabili. Restituendo esito positivo da [**IVssHardwareSnapshotProvider:: AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), il provider indica che non solo supporta il lun, ma anche che può trasportare il lun. La creazione di un set di copie shadow trasportabili si conclude quando VSS registra le informazioni LUN nel documento componenti di backup. Un set di copie shadow può essere importato solo una volta dopo la creazione iniziale.

Nel computer ricevente, il richiedente importa il set di copie shadow. Il metodo [**IVssBackupComponents:: ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) usa il documento relativo ai componenti di backup che descrive il set di copie shadow come input. Importazione di procedimenti per:

1.  VSS crea una matrice di strutture di [**informazioni del \_ lun \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) della copia shadow dal documento dei componenti di backup.
2.  Quando VSS chiama [**IVssHardwareSnapshotProvider:: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), la matrice di strutture di [**\_ \_ informazioni lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generate in [**IVssHardwareSnapshotProvider:: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) verrà passata al provider. Durante l'elaborazione di questo metodo, il provider deve rendere visibili al sistema tali LUN di copia shadow. Il provider non deve causare una ripetizione dell'analisi del bus. VSS attiverà la ripetizione dell'analisi e l'enumerazione per consentire l'individuazione dei LUN da parte di PNP e i volumi da riportare online.
3.  VSS chiama [**IVssHardwareSnapshotProvider:: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) per i dischi appena arrivati nel sistema. VSS usa la matrice di LUN copia shadow delle strutture di [**\_ \_ informazioni lun VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) da **FillInLunInfo**, confrontandolo con **le \_ \_ informazioni relative al lun VDS** generate durante la creazione del set di copie shadow in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) e gli extent del disco per ogni volume nel set di copie shadow per identificare i LUN delle copie shadow appena raggiunte.
4.  A questo punto, tutti i volumi contenuti nei lun trasportati vengono montati come nascosti e in sola lettura e VSS dispone di un mapping dal volume originale al volume di copia shadow.

Sia per il singolo computer che per il caso trasportabile, la sequenza è simile a partire dal punto in cui viene chiamato [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) . Per l'importazione automatica, i passaggi vengono eseguiti direttamente dopo la creazione.

 

 
