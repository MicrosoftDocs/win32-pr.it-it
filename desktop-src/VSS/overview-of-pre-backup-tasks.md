---
description: Le attività di pre-backup in VSS sono incentrate sulla creazione di una copia shadow dei volumi contenenti i dati per il backup.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Panoramica delle attività di pre-backup
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 709345b8aa0421699efe26ad2901cc497b7d4ac0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "106310688"
---
# <a name="overview-of-pre-backup-tasks"></a>Panoramica delle attività di pre-backup

Le attività di pre-backup in VSS sono incentrate sulla creazione di una copia shadow dei volumi contenenti i dati per il backup. L'applicazione di backup salverà i dati della copia shadow, non del volume effettivo. Per ulteriori informazioni, vedere [Cenni preliminari sull'elaborazione di un backup in VSS](overview-of-processing-a-backup-under-vss.md).

I richiedenti in genere attendono che i writer siano pronti per il backup e creino la copia shadow. Il writer deve determinare se è necessario partecipare al backup e, in caso contrario, configurarne i file e in modo che sia pronto per il backup e la copia shadow. Nella tabella seguente viene illustrata la sequenza di azioni ed eventi necessari per preparare un'operazione di backup.



| Azione del richiedente                                                                                                                                                                                                                                                                                                            | Evento                                                                      | Azione del writer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Il richiedente può impostare le opzioni di backup (vedere [**IVssBackupComponents:: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))                                                                                                                                                                                          | nessuno                                                                       | nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Supportare operazioni di backup incrementali e differenziali esaminando tutti gli indicatori di backup archiviati (vedere [**IVssComponent:: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents:: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))                                               | nessuno                                                                       | nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Inviare una notifica ai writer per preparare un'operazione di backup usando [ **IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | Le preparazioni del writer includono determinare se è necessario eseguire il backup dei file, se il writer parteciperà al blocco della copia shadow, nonché creare metadati specifici del writer (vedere [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter:: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) [**, IVssComponent,**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) [**IVssComponent:: GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter:: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent:: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)e [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp). |
| Il richiedente attende la configurazione dei writer per il backup mediante [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync). Deve inoltre verificare lo stato del writer (vedere [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))     | nessuno                                                                       | nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Il richiedente richiede una copia shadow usando [ **IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | nessuno                                                                       | nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| nessuno                                                                                                                                                                                                                                                                                                                        | [*PrepareForSnapshot*](vssgloss-p.md) | [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): inserire il writer in uno stato pronto per la copia shadow.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| nessuno                                                                                                                                                                                                                                                                                                                        | [*Freeze*](vssgloss-f.md)                      | [**CVssWriter:: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): installazione finale prima della copia shadow.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| nessuno                                                                                                                                                                                                                                                                                                                        | [*Sblocca*](vssgloss-t.md)                          | [**CVssWriter:: Onscongelate**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): è possibile riprendere il normale funzionamento (incluse le operazioni di I/O).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| nessuno                                                                                                                                                                                                                                                                                                                        | [*PostSnapshot*](vssgloss-p.md)          | [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): pulizia finale dei preparativi per le copie shadow. Vedere [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) e [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Il richiedente attende il completamento della copia shadow con: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), deve anche verificare lo stato del writer (vedere [**IVssBackupComponents:: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents:: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | nessuno                                                                       | nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Attività di pre-backup del richiedente

Inoltre, prima di creare un evento [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , un richiedente può impostare anche le opzioni di backup per i singoli writer usando [**IVssBackupComponents:: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) a seconda delle specifiche di ogni writer e se un richiedente ne è a conoscenza.

Per supportare le operazioni incrementali e differenziali, i richiedenti possono a questo punto scegliere di esaminare i componenti per i timestamp dell'operazione di backup precedente (usando [**IVssComponent:: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) e di usare tali informazioni per impostare un timestamp precedente affinché un writer possa elaborare (usando [**IVssBackupComponents:: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)). Per ulteriori informazioni, vedere [backup incrementali e differenziali](incremental-and-differential-backups.md) .

Un richiedente può ora indirizzare i writer del sistema a completare preparazioni di pre-backup e gestire la creazione di una copia shadow.

Innanzitutto, il richiedente genera un evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) chiamando [**IVssBackupComponents::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

Dopo che tutti i writer partecipanti hanno restituito la gestione dell'evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (che un richiedente determina usando l'istanza dell'interfaccia [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) restituita da **PrepareForBackup**), il richiedente può avviare la copia shadow chiamando [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), che, durante l'avanzamento, genererà gli eventi [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*scongelate*](vssgloss-t.md)e [*PostSnapshot*](vssgloss-p.md) per la gestione dei writer.

In alcuni casi è possibile che un richiedente non debba creare una copia shadow. In particolare, ogni [*set di file*](vssgloss-f.md) gestito da uno dei componenti di un determinato writer dispone di una maschera di backup per la specifica dei file, indicata da un operatore OR bit per bit di valori del [**\_ \_ \_ \_ tipo di backup delle specifiche del file VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) , impostato durante l'evento di [*Identificazione*](vssgloss-i.md) . Questa maschera specifica, tra le altre cose, se un set di file richiede la copia shadow del sistema prima che venga eseguito il backup.

Se non è necessario eseguire il backup di alcun set di file in alcun volume, è necessario che sia presente una copia shadow, quindi non è necessario chiamare [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .

## <a name="writer-pre-backup-tasks"></a>Attività di pre-backup del writer

Quando si gestisce l'evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , VSS chiama il metodo [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) di ogni writer, un metodo virtuale, che per impostazione predefinita restituisce semplicemente true.

I writer possono eseguire l'override di questa implementazione predefinita e utilizzare la gestione per trovare informazioni sul backup imminente e intraprendere un'azione.

Un writer può determinare le informazioni sul tipo di operazione di backup contemplate mediante i metodi seguenti:

1.  [**CVssWriter:: GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**CVssWriter:: IsBootableStateBackedUp**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**CVssWriter:: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Un writer determina se i file gestiti saranno interessati dalla copia shadow usando [**CVssWriter:: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).

Più importante, quando VSS chiama il metodo [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , passa un'istanza dell'interfaccia [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , che consente l'accesso diretto tramite l'interfaccia [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) a quelli dei componenti [*inclusi in modo esplicito*](vssgloss-e.md) nel documento relativo ai componenti di backup del richiedente. Il writer ha utilizzato le istanze dell'interfaccia **IVssComponent** che definiscono i set di componenti per ottenere l'accesso al componente *incluso in modo implicito* (vedere [selezione e utilizzo delle proprietà del componente](selectability-and-working-with-component-properties.md)).

Durante la gestione dell'evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , i writer utilizzano l'interfaccia [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) per eseguire operazioni Component-by-Component (o set di componenti per set di componenti), tra cui:

1.  Aggiunta di [*file parziali*](vssgloss-p.md) (se supportati) chiamando [**IVssComponent:: AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Impostazione di tutti i metadati privati che dovranno essere gestiti dal writer per il ripristino.
3.  Se il writer supporta i backup incrementali e differenziali (vedere [backup incrementali e differenziali](incremental-and-differential-backups.md)), eseguire le operazioni seguenti:
    -   Verifica degli indicatori di data e ora di backup precedenti chiamando [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Aggiunta di eventuali [*file differenziati*](vssgloss-d.md) necessari chiamando [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Se il writer supporta lo schema del **\_ \_ timestamp** del servizio Copia Shadow del volume, aggiunge le stringhe di timestamp nel formato del writer usando [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Avvio di operazioni asincrone molto dispendiose in termini di tempo, ad esempio la sincronizzazione dei dati su più dischi. In questo modo il writer continuerà a funzionare durante l'elaborazione dell'operazione, inclusa la gestione di altri eventi VSS. Queste operazioni devono terminare prima dell'evento [*Freeze*](vssgloss-f.md) .

La chiamata del richiedente a [**IVssBackupComponents::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) avvia la copia shadow e genera gli eventi seguenti per la gestione dei writer:

-   [*PrepareForSnapshot*](vssgloss-p.md)
-   [*Freeze*](vssgloss-f.md)
-   [*Sblocca*](vssgloss-t.md)
-   [*PostSnapshot*](vssgloss-p.md)

Tre dei gestori del writer ([**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter:: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)e [**CVssWriter:: onscongelate**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)) sono metodi virtuali puri e ogni writer deve implementarli anziché basarsi sulle impostazioni predefinite. A seconda delle esigenze di un writer, possono essere codificati come metodi fittizi, restituendo semplicemente **true**.

Poiché in genere è presente un intervallo di tempo ridotto tra l'emissione di un evento di [*blocco*](vssgloss-f.md) e l'emissione di un evento di [*sblocco*](vssgloss-t.md) , la maggior parte dei principali lavori di preparazione per la copia shadow, ad esempio l'arresto dei processi, la creazione di file temporanei o lo svuotamento delle code di I/O, verrebbe gestita in [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).

Il modo in cui un writer può utilizzare [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) per gestire le operazioni di i/O prima che la creazione di una copia shadow dipenda fortemente dalla propria architettura del writer.

È consigliabile che i writer che possono contenere tutte le Scritture e mantengano i dati in uno stato coerente assoluto prima del [*blocco*](vssgloss-f.md).

Se il writer non è in grado di bloccare le operazioni di I/O, è necessario eseguire le operazioni per creare un'origine stabile per il backup e per ridurre il tempo di recupero per una copia shadow. Ad esempio l'accodamento delle richieste di I/O in ingresso o la generazione di un set duplicato di file in un [*percorso alternativo*](vssgloss-a.md) da usare come origine di un backup.

Il metodo [**CVssWriter:: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) esegue attività semplici e brevi, ad esempio la verifica che lo stato di i/O di [**CVssWriter:: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) è stato corretto e che tutte le attività asincrone avviate da [**CVssWriter:: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) siano state completate. Questo metodo è l'ultima possibilità di un writer di veto a una copia shadow in caso di problemi (vedere [errori e veto del writer](writer-errors-and-vetoes.md)).

È in genere possibile che un writer riprenda l'operazione normale dopo un evento di [*sblocco*](vssgloss-t.md) : una copia shadow potrebbe non essere immediatamente pronta per il backup dopo il ripristino, ma un writer dovrebbe essere in grado di riprendere il normale funzionamento. Di conseguenza, in genere [**CVssWriter:: Onscongelate**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) viene usato dai writer per tornare a uno stato di pre-blocco. Tuttavia, tutti i file temporanei creati per supportare la copia shadow devono essere lasciati sul posto fino all'evento [*PostSnapshot*](vssgloss-p.md) . In genere, è necessario utilizzare [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) per questo tipo di pulizia. Poiché molte applicazioni non richiedono questo tipo di pulizia, **CVssWriter:: OnPostSnapshot** è un metodo virtuale con un'implementazione predefinita che restituisce semplicemente **true**. Se viene eseguito un backup incrementale o differenziale, il writer può chiamare [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) e [**IVssComponent:: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Per ulteriori informazioni, vedere [ruolo di writer nel backup di archivi complessi](writer-role-in-backing-up-complex-stores.md). Un altro metodo che può essere chiamato in questo momento è [**IVssComponent:: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).

 

 




