---
description: Le attività di pre-backup in VSS sono incentrate sulla creazione di una copia shadow dei volumi contenenti dati per il backup.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Panoramica delle attività di pre-backup
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af8dd6ea99215d486b8be7d07d30bcbdb5258548078fd642028dd6a93ca42796
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/11/2021
ms.locfileid: "119511741"
---
# <a name="overview-of-pre-backup-tasks"></a>Panoramica delle attività di pre-backup

Le attività di pre-backup in VSS sono incentrate sulla creazione di una copia shadow dei volumi contenenti dati per il backup. L'applicazione di backup salverà i dati della copia shadow, non del volume effettivo. Per altre informazioni, vedere [Panoramica dell'elaborazione di un backup in VSS.](overview-of-processing-a-backup-under-vss.md)

I richiedenti in genere attendono che i writer si preparino per il backup e la creazione della copia shadow. Il writer deve determinare se deve partecipare al backup e, in caso contrario, configurarne i file e se stesso in modo che siano pronti per il backup e la copia shadow. Nella tabella seguente viene illustrata la sequenza di azioni ed eventi necessari per preparare un'operazione di backup.



| Azione del richiedente                                                                                                                                                                                                                                                                                                            | Event                                                                      | Azione writer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Il richiedente può impostare le opzioni di backup (vedere [**IVssBackupComponents::SetBackupOptions)**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions)                                                                                                                                                                                          | Nessuno                                                                       | Nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Supportare operazioni di backup incrementali e differenziali esaminando eventuali indicatori di backup archiviati (vedere [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))                                               | Nessuno                                                                       | Nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Notificare ai writer di preparare un'operazione di backup [ **usando IVssBackupComponents::P repareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | Le operazioni di preparazione del writer includono la determinazione dell'esecuzione del backup dei file. indica se il writer parteciperà al blocco della copia shadow, nonché alla creazione di metadati specifici del writer (vedere [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter::IsPathAffected,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected) [**IVssWriterComponents,**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent::GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent::SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)e [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp). |
| Il richiedente attende la configurazione dei writer per il backup [**tramite IVssAsync.**](/windows/desktop/api/Vss/nn-vss-ivssasync) Deve anche verificare lo stato del writer (vedere [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))     | Nessuno                                                                       | Nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Il richiedente richiede una copia shadow [ **usando IVssBackupComponents::D oSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | Nessuno                                                                       | Nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Nessuno                                                                                                                                                                                                                                                                                                                        | [*PrepareForSnapshot*](vssgloss-p.md) | [**CVssWriter::OnPrepareSnapshot:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)consente di inserire il writer in uno stato pronto per la copia shadow.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Nessuno                                                                                                                                                                                                                                                                                                                        | [*Freeze*](vssgloss-f.md)                      | [**CVssWriter::OnFreeze:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)configurazione finale prima della copia shadow.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Nessuno                                                                                                                                                                                                                                                                                                                        | [*Disgelo*](vssgloss-t.md)                          | [**CVssWriter::OnThaw:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)il normale funzionamento (incluso l'I/O) può riprendere.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Nessuno                                                                                                                                                                                                                                                                                                                        | [*PostSnapshot*](vssgloss-p.md)          | [**CVssWriter::OnPostSnapshot:**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot)pulizia finale delle operazioni di preparazione della copia shadow. Vedere [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) e [**IVssComponent::SetBackupStamp.**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp)<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Il richiedente attende il completamento della copia shadow usando: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), deve anche verificare lo stato del writer (vedere [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | Nessuno                                                                       | Nessuno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Attività di pre-backup del richiedente

Inoltre, prima di creare un evento [**IVssBackupComponents::P repareForBackup,**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) un richiedente può anche impostare opzioni di backup per singoli writer usando [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) a seconda delle specifiche di ogni writer e del fatto che un richiedente ne sia a conoscenza.

Per supportare operazioni incrementali e differenziali, i richiedenti possono a questo punto scegliere di esaminare i componenti per i timestamp dell'operazione di backup precedente (usando [**IVssComponent::GetBackupStamp)**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)e usare tali informazioni per impostare un timestamp precedente per un writer da elaborare (usando [**IVssBackupComponents::SetPreviousBackupStamp).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp) Per [altre informazioni, vedere Backup incrementali](incremental-and-differential-backups.md) e differenziali.

Un richiedente può ora indirizzare i writer del sistema per completare le preparazioni di pre-backup e per gestire la creazione di una copia shadow.

In primo luogo, il richiedente genera un evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) chiamando [**IVssBackupComponents::P repareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

Dopo che tutti i writer partecipanti sono tornati dalla gestione dell'evento [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (che un richiedente determina usando l'istanza dell'interfaccia [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) restituita da **PrepareForBackup),** il richiedente può avviare la copia shadow chiamando [**IVssBackupComponents::D oSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), che, con l'avanzamento, genererà gli eventi [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md)e [*PostSnapshot*](vssgloss-p.md) che gli autori dobranno gestire.

In alcuni casi un richiedente potrebbe non dover creare una copia shadow. In particolare, ogni [*set*](vssgloss-f.md) di file gestito da uno dei componenti di un determinato writer ha una maschera di backup della specifica file (indicata da un'operazione OR bit per bit di valori [**VSS \_ FILE SPEC BACKUP \_ \_ \_ TYPE)**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) impostata durante l'evento [*Identify.*](vssgloss-i.md) Questa maschera specifica, tra le altre cose, se un set di file richiede la copia shadow del sistema prima dell'esecuzione del backup.

Se nessun set di file di cui eseguire il backup in alcun volume richiede una copia shadow, non è necessario chiamare [**IVssBackupComponents::D oSnapshotSet.**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)

## <a name="writer-pre-backup-tasks"></a>Attività di pre-backup del writer

Quando si gestisce [**l'evento PrepareForBackup,**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) VSS chiamerà il metodo [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) di ogni writer, un metodo virtuale, che per impostazione predefinita restituisce semplicemente true.

I writer possono eseguire l'override di questa implementazione predefinita e usare la gestione per trovare informazioni sul backup imminente ed eseguire un'azione.

Un writer può determinare informazioni sul tipo di operazione di backup eseguita utilizzando i metodi seguenti:

1.  [**CVssWriter::GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**CVssWriter::IsBootableStateBackedUp**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Un writer determina se i file gestiti saranno coinvolti nella copia shadow usando [**CVssWriter::IsPathAffected.**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected)

Ancora più importante, quando VSS chiama il metodo [**CVssWriter::OnPrepareBackup,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) passa un'istanza [**dell'interfaccia IVssWriterComponents,**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) che consente l'accesso diretto tramite l'interfaccia [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) a quelli dei relativi componenti inclusi [*in*](vssgloss-e.md) modo esplicito nel documento dei componenti di backup del richiedente. Il writer ha usato le istanze **dell'interfaccia IVssComponent** che definiscono i set di componenti per ottenere l'accesso al componente incluso *in modo implicito* (vedere Selezionabilità e uso [delle proprietà del componente).](selectability-and-working-with-component-properties.md)

Durante la gestione dell'evento [**PrepareForBackup,**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) i writer usano l'interfaccia [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) per eseguire operazioni component-by-component (o component set by component set), tra cui:

1.  Aggiunta [*di file parziali*](vssgloss-p.md) (se supportati) chiamando [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Impostazione di metadati privati necessari al writer per gestire il ripristino.
3.  Se il writer supporta backup incrementali e differenziali (vedere Backup incrementali e [differenziali),](incremental-and-differential-backups.md)eseguire le operazioni seguenti:
    -   Verifica dei timestamp di backup precedenti chiamando [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Aggiunta di [*tutti i file differenze*](vssgloss-d.md) necessari chiamando [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Se il writer supporta lo schema **\_ \_ TIMESTAMPED di VSS BS,** aggiungere stringhe timestamp di backup nel formato del writer usando [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Avvio di operazioni asincrone molto dispendiose in termini di tempo, ad esempio la sincronizzazione dei dati tra più dischi. In questo modo il writer continuerà a funzionare durante l'elaborazione dell'operazione, inclusa la gestione di altri eventi vss. Queste operazioni devono terminare prima [*dell'evento Freeze.*](vssgloss-f.md)

La chiamata del richiedente a [**IVssBackupComponents::D oSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) avvia la copia shadow e genera gli eventi seguenti che i writer possono gestire:

-   [*PrepareForSnapshot*](vssgloss-p.md)
-   [*Freeze*](vssgloss-f.md)
-   [*Disgelo*](vssgloss-t.md)
-   [*PostSnapshot*](vssgloss-p.md)

Tre dei gestori del writer,[**CVssWriter::OnPrepareSnapshot,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)e [**CVssWriter::OnThaw,**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)sono metodi virtuali puri e ogni writer deve implementarli anziché basarsi sulle impostazioni predefinite. A seconda delle esigenze di un writer, possono essere codificati come metodi fittizi, semplicemente restituisce **TRUE.**

Poiché è in genere presente un intervallo di tempo ridotto tra il rilascio di un evento [*Freeze*](vssgloss-f.md) e il rilascio di un evento [*Thaw,*](vssgloss-t.md) la maggior parte delle operazioni principali nella preparazione della copia shadow, ad esempio l'arresto dei processi, la creazione di file temporanei o lo svuotamento delle code di I/O, viene gestita in [**CVssWriter::OnPrepareSnapshot.**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)

Il modo in cui un writer può usare [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) per gestire l'I/O prima della creazione di una copia shadow dipende in modo molto dipendente dall'architettura del writer.

I writer che possono permettersi di conservare tutte le scritture e mantenere i dati in uno stato coerente assoluto prima di [*Freeze*](vssgloss-f.md)devono eseguire questa operazione.

Se il writer non è in grado di bloccare l'I/O, deve eseguire azioni per creare un'origine stabile per il backup e ridurre il tempo di recupero per una copia shadow. Ad esempio, l'accodamento delle richieste di I/O in ingresso [](vssgloss-a.md) o la generazione di un set duplicato di file in un percorso alternativo da usare come origine di un backup.

Il metodo [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) esegue attività semplici e brevi, ad esempio la verifica che [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) ha lasciato l'I/O corretto e che tutte le attività asincrone avviate da [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) siano state completate. Questo metodo è l'ultima possibilità di un writer di veto a una copia shadow in caso di problemi (vedere Errori del writer [e veti).](writer-errors-and-vetoes.md)

È in genere possibile che un writer riprendi il normale funzionamento in seguito a un evento [*Thaw:*](vssgloss-t.md) una copia shadow potrebbe non essere immediatamente pronta per il backup dopo il thaw, ma un writer dovrebbe essere in grado di riprendere il normale funzionamento. Pertanto, in [**genere CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) viene usato dai writer per tornare a uno stato di pre-blocco. Tuttavia, tutti i file temporanei creati per supportare la copia shadow devono essere lasciati fino [*all'evento PostSnapshot.*](vssgloss-p.md) In genere, per questo tipo di pulizia si usa [**CVssWriter::OnPostSnapshot.**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) Poiché molte applicazioni non richiedono questo tipo di pulizia, **CVssWriter::OnPostSnapshot** è un metodo virtuale con un'implementazione predefinita che restituisce **semplicemente TRUE.** Se viene eseguito un backup incrementale o differenziale, il writer può chiamare [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) e [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Per altre informazioni, vedere [Ruolo writer nel backup di archivi complessi.](writer-role-in-backing-up-complex-stores.md) Un altro metodo che può essere chiamato in questo momento [**è IVssComponent::AddDifferencedFilesByLastModifyTime.**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime)

 

 




