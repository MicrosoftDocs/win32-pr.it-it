---
description: Quando un programma di controllo del servizio richiede l'esecuzione di un nuovo servizio, gestione controllo servizi avvia il servizio e invia una richiesta di avvio al dispatcher del controllo.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: Funzione ServiceMain del servizio
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "103968383"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="9aece-103">Funzione ServiceMain del servizio</span><span class="sxs-lookup"><span data-stu-id="9aece-103">Service ServiceMain Function</span></span>

<span data-ttu-id="9aece-104">Quando un programma di controllo del servizio richiede l'esecuzione di un nuovo servizio, gestione controllo servizi avvia il servizio e invia una richiesta di avvio al dispatcher del controllo.</span><span class="sxs-lookup"><span data-stu-id="9aece-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="9aece-105">Il dispatcher del controllo Crea un nuovo thread per eseguire la funzione [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) per il servizio.</span><span class="sxs-lookup"><span data-stu-id="9aece-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="9aece-106">Per un esempio, vedere [scrittura di una funzione ServiceMain](writing-a-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="9aece-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="9aece-107">La funzione [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) deve eseguire le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="9aece-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="9aece-108">Inizializzare tutte le variabili globali.</span><span class="sxs-lookup"><span data-stu-id="9aece-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="9aece-109">Chiamare immediatamente la funzione [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) per registrare una funzione di [**gestione**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) per gestire le richieste di controllo per il servizio.</span><span class="sxs-lookup"><span data-stu-id="9aece-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="9aece-110">Il valore restituito di **RegisterServiceCtrlHandler** è un *handle dello stato del servizio* che verrà utilizzato nelle chiamate per notificare al SCM lo stato del servizio.</span><span class="sxs-lookup"><span data-stu-id="9aece-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="9aece-111">Eseguire l'inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="9aece-111">Perform initialization.</span></span> <span data-ttu-id="9aece-112">Se il tempo di esecuzione del codice di inizializzazione dovrebbe essere molto breve (meno di un secondo), l'inizializzazione può essere eseguita direttamente in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span><span class="sxs-lookup"><span data-stu-id="9aece-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="9aece-113">Se è previsto che il tempo di inizializzazione sia superiore a un secondo, il servizio deve utilizzare una delle tecniche di inizializzazione seguenti:</span><span class="sxs-lookup"><span data-stu-id="9aece-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="9aece-114">Chiamare la funzione [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) per segnalare che il servizio \_ è in esecuzione, ma non accetta alcun controllo fino al completamento dell'inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="9aece-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="9aece-115">Il servizio esegue questa operazione chiamando **SetServiceStatus** con **DWCURRENTSTATE** impostato su Service \_ Running e **dwControlsAccepted** impostato su 0 nella struttura [**\_ dello stato del servizio**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="9aece-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="9aece-116">Ciò garantisce che SCM non invierà le richieste di controllo al servizio prima che sia pronto e libera la gestione SCM per la gestione di altri servizi.</span><span class="sxs-lookup"><span data-stu-id="9aece-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="9aece-117">Questo approccio all'inizializzazione è consigliato per le prestazioni, in particolare per i servizi di avvio automatico.</span><span class="sxs-lookup"><span data-stu-id="9aece-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="9aece-118">Avvio del servizio report \_ \_ in sospeso, non accetta alcun controllo e specifica un hint di attesa.</span><span class="sxs-lookup"><span data-stu-id="9aece-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="9aece-119">Se il codice di inizializzazione del servizio esegue attività che richiedono più tempo del valore iniziale del suggerimento di attesa, il codice deve chiamare periodicamente la funzione [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) (possibilmente con un hint di attesa modificato) per indicare che l'avanzamento viene eseguito.</span><span class="sxs-lookup"><span data-stu-id="9aece-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="9aece-120">Assicurarsi di chiamare **SetServiceStatus** solo se l'inizializzazione sta procedendo.</span><span class="sxs-lookup"><span data-stu-id="9aece-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="9aece-121">In caso contrario, SCM può attendere che il servizio entri nello \_ stato di esecuzione del servizio presumendo che il servizio stia eseguendo lo stato di avanzamento e impedisce l'avvio di altri servizi.</span><span class="sxs-lookup"><span data-stu-id="9aece-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="9aece-122">Non chiamare **SetServiceStatus** da un thread separato a meno che non si sia certi che il thread che esegue l'inizializzazione stia effettivamente facendo progressi.</span><span class="sxs-lookup"><span data-stu-id="9aece-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="9aece-123">Un servizio che utilizza questo approccio può inoltre specificare un valore del punto di controllo e incrementare il valore periodicamente durante un'inizializzazione prolungata.</span><span class="sxs-lookup"><span data-stu-id="9aece-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="9aece-124">Il programma che ha avviato il servizio può chiamare [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) o [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) per ottenere il valore del punto di controllo più recente da SCM e usare il valore per segnalare l'avanzamento incrementale all'utente.</span><span class="sxs-lookup"><span data-stu-id="9aece-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="9aece-125">Al termine dell'inizializzazione, chiamare [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) per impostare lo stato del servizio sul servizio \_ in esecuzione e specificare i controlli che il servizio è pronto ad accettare.</span><span class="sxs-lookup"><span data-stu-id="9aece-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="9aece-126">Per un elenco di controlli, vedere la [**struttura \_ dello stato del servizio**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="9aece-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="9aece-127">Eseguire le attività del servizio oppure, se non sono presenti attività in sospeso, restituire il controllo al chiamante.</span><span class="sxs-lookup"><span data-stu-id="9aece-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="9aece-128">Qualsiasi modifica apportata allo stato del servizio garantisce una chiamata a [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) per segnalare nuove informazioni sullo stato.</span><span class="sxs-lookup"><span data-stu-id="9aece-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="9aece-129">Se si verifica un errore durante l'inizializzazione o l'esecuzione del servizio, il servizio deve chiamare [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) per impostare lo stato del servizio sull'arresto del servizio in \_ \_ sospeso se la pulizia sarà lunga.</span><span class="sxs-lookup"><span data-stu-id="9aece-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="9aece-130">Al termine della pulizia, chiamare **SetServiceStatus** per impostare lo stato del servizio su servizio \_ interrotto dall'ultimo thread per terminare.</span><span class="sxs-lookup"><span data-stu-id="9aece-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="9aece-131">Assicurarsi di impostare i membri **dwServiceSpecificExitCode** e **dwWin32ExitCode** della struttura [**\_ dello stato del servizio**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) per identificare l'errore.</span><span class="sxs-lookup"><span data-stu-id="9aece-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="9aece-132">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="9aece-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9aece-133">Scrittura di una funzione ServiceMain</span><span class="sxs-lookup"><span data-stu-id="9aece-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
