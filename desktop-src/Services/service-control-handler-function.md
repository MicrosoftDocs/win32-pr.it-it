---
description: Ogni servizio dispone di un gestore di controllo, la funzione di gestione, che viene richiamata dal dispatcher del controllo quando il processo del servizio riceve una richiesta di controllo da un programma di controllo del servizio.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Funzione Handler di controllo dei servizi
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "106306535"
---
# <a name="service-control-handler-function"></a><span data-ttu-id="ed2b1-103">Funzione Handler di controllo dei servizi</span><span class="sxs-lookup"><span data-stu-id="ed2b1-103">Service Control Handler Function</span></span>

<span data-ttu-id="ed2b1-104">Ogni servizio dispone di un gestore di controllo, la funzione di [**gestione**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , che viene richiamata dal dispatcher del controllo quando il processo del servizio riceve una richiesta di controllo da un programma di controllo del servizio.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-104">Each service has a control handler, the [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function, that is invoked by the control dispatcher when the service process receives a control request from a service control program.</span></span> <span data-ttu-id="ed2b1-105">Pertanto, questa funzione viene eseguita nel contesto del dispatcher del controllo.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-105">Therefore, this function executes in the context of the control dispatcher.</span></span> <span data-ttu-id="ed2b1-106">Per un esempio, vedere [scrittura di una funzione di gestione del controllo](writing-a-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="ed2b1-106">For an example, see [Writing a Control Handler Function](writing-a-control-handler-function.md).</span></span>

<span data-ttu-id="ed2b1-107">Un servizio chiama la funzione [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) o [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) per registrare la funzione del gestore di controllo del servizio.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-107">A service calls the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) or [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) function to register its service control handler function.</span></span>

<span data-ttu-id="ed2b1-108">Quando viene richiamato il gestore di controllo del servizio, il servizio deve chiamare la funzione [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) per segnalare lo stato a SCM solo se la gestione del codice di controllo causa la modifica dello stato del servizio.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-108">When the service control handler is invoked, the service must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report its status to the SCM only if handling the control code causes the service status to change.</span></span> <span data-ttu-id="ed2b1-109">Se la gestione del codice di controllo non comporta la modifica dello stato del servizio, non è necessario chiamare **SetServiceStatus**.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-109">If handling the control code does not cause the service status to change, it is not necessary to call **SetServiceStatus**.</span></span>

<span data-ttu-id="ed2b1-110">Un programma di controllo del servizio può inviare richieste di controllo tramite la funzione [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-110">A service control program can send control requests using the [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) function.</span></span> <span data-ttu-id="ed2b1-111">Tutti i servizi devono accettare ed elaborare il codice di controllo per **\_ \_ interrogare** il controllo del servizio.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-111">All services must accept and process the **SERVICE\_CONTROL\_INTERROGATE** control code.</span></span> <span data-ttu-id="ed2b1-112">È possibile abilitare o disabilitare l'accettazione degli altri codici di controllo chiamando [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="ed2b1-112">You can enable or disable acceptance of the other control codes by calling [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="ed2b1-113">Per ricevere il codice di controllo **\_ \_ DEVICEEVENT del controllo del servizio** , è necessario chiamare la funzione [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-113">To receive the **SERVICE\_CONTROL\_DEVICEEVENT** control code, you must call the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span> <span data-ttu-id="ed2b1-114">I servizi possono anche gestire ulteriori codici di controllo definiti dall'utente.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-114">Services can also handle additional user-defined control codes.</span></span>

<span data-ttu-id="ed2b1-115">Se un servizio accetta il codice di controllo dell' **\_ \_ arresto del controllo del servizio** , deve arrestarsi alla ricezione, passando allo stato di arresto del servizio **\_ \_ in sospeso** o **\_ arrestato** .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-115">If a service accepts the **SERVICE\_CONTROL\_STOP** control code, it must stop upon receipt, going to either the **SERVICE\_STOP\_PENDING** or **SERVICE\_STOPPED** state.</span></span> <span data-ttu-id="ed2b1-116">Al termine dell'invio del codice di controllo da parte di SCM, i codici di controllo non vengono inviati.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-116">After the SCM sends this control code, it will not send other control codes.</span></span>

<span data-ttu-id="ed2b1-117">**Windows XP:** Se il servizio **non restituisce alcun \_ errore** e continua a essere eseguito, continua a ricevere i codici di controllo.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-117">**Windows XP:** If the service returns **NO\_ERROR** and continues to run, it continues to receive control codes.</span></span> <span data-ttu-id="ed2b1-118">Questo comportamento è stato modificato a partire da Windows Server 2003 e Windows XP con Service Pack 2 (SP2).</span><span class="sxs-lookup"><span data-stu-id="ed2b1-118">This behavior changed starting with Windows Server 2003 and Windows XP with Service Pack 2 (SP2).</span></span>

<span data-ttu-id="ed2b1-119">Il gestore di controllo deve restituire entro 30 secondi oppure l'oggetto SCM restituisce un errore.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-119">The control handler must return within 30 seconds, or the SCM returns an error.</span></span> <span data-ttu-id="ed2b1-120">Se un servizio deve eseguire un'elaborazione lunga quando il servizio esegue il gestore di controllo, deve creare un thread secondario per eseguire l'elaborazione lunga e quindi tornare dal gestore del controllo.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-120">If a service must do lengthy processing when the service is executing the control handler, it should create a secondary thread to perform the lengthy processing, and then return from the control handler.</span></span> <span data-ttu-id="ed2b1-121">In questo modo si impedisce al servizio di bloccare il dispatcher del controllo.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-121">This prevents the service from tying up the control dispatcher.</span></span> <span data-ttu-id="ed2b1-122">Ad esempio, quando si gestisce la richiesta di arresto per un servizio che richiede molto tempo, creare un altro thread per gestire il processo di arresto.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-122">For example, when handling the stop request for a service that takes a long time, create another thread to handle the stop process.</span></span> <span data-ttu-id="ed2b1-123">Il gestore di controllo deve semplicemente chiamare [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) con il messaggio di **arresto del servizio \_ \_ in sospeso** e restituire.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-123">The control handler should simply call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_STOP\_PENDING** message and return.</span></span>

<span data-ttu-id="ed2b1-124">Quando l'utente arresta il sistema, tutti i gestori di controllo che hanno chiamato [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) con il servizio accettano il codice di controllo **\_ \_ preshutdown** ricevono il codice di controllo della **\_ \_ prechiusura del controllo del servizio** .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-124">When the user shuts down the system, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_PRESHUTDOWN** control code receive the **SERVICE\_CONTROL\_PRESHUTDOWN** control code.</span></span> <span data-ttu-id="ed2b1-125">Gestione controllo servizi attende fino a quando il servizio non viene arrestato o il valore di timeout di prespegnimento specificato scade (questo valore può essere impostato con la funzione [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) ).</span><span class="sxs-lookup"><span data-stu-id="ed2b1-125">The service control manager waits until the service stops or the specified preshutdown time-out value expires (this value can be set with the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) function).</span></span> <span data-ttu-id="ed2b1-126">Questo codice di controllo deve essere usato solo in circostanze particolari, perché un servizio che gestisce questa notifica blocca l'arresto del sistema fino a quando il servizio non viene arrestato o scade l'intervallo di timeout di prechiusura.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-126">This control code should be used only in special circumstances, because a service that handles this notification blocks system shutdown until the service stops or the preshutdown time-out interval expires.</span></span>

<span data-ttu-id="ed2b1-127">Una volta completate le notifiche di prechiusura, tutti i gestori di controllo che hanno chiamato [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) con il servizio accettano il codice di controllo di **\_ \_ arresto** per ricevere il codice di controllo dell' **arresto del \_ controllo \_ del servizio** .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-127">After the preshutdown notifications have been completed, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_SHUTDOWN** control code receive the **SERVICE\_CONTROL\_SHUTDOWN** control code.</span></span> <span data-ttu-id="ed2b1-128">Viene inviata una notifica nell'ordine in cui sono visualizzate nel database dei servizi installati.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-128">They are notified in the order that they appear in the database of installed services.</span></span> <span data-ttu-id="ed2b1-129">Per impostazione predefinita, un servizio ha circa 20 secondi per eseguire attività di pulizia prima che il sistema venga arrestato.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-129">By default, a service has approximately 20 seconds to perform cleanup tasks before the system shuts down.</span></span> <span data-ttu-id="ed2b1-130">Al termine di questo periodo di tempo, l'arresto del sistema continua indipendentemente dal fatto che l'arresto del servizio sia stato completato.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-130">After this time expires, system shutdown proceeds regardless of whether service shutdown is complete.</span></span> <span data-ttu-id="ed2b1-131">Si noti che se il sistema viene lasciato nello stato di arresto (non riavviato o spento), il servizio continua a essere eseguito.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-131">Note that if the system is left in the shutdown state (not restarted or powered down), the service continues to run.</span></span>

<span data-ttu-id="ed2b1-132">Se il servizio richiede più tempo per la pulizia, invia i messaggi di stato di **arresto \_ in sospeso** , insieme a un hint di attesa, in modo che il controller di servizio conosca il tempo di attesa prima di segnalare al sistema che l'arresto del servizio è stato completato.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-132">If the service requires more time to cleanup, it sends **STOP\_PENDING** status messages, along with a wait hint, so the service controller knows how long to wait before reporting to the system that service shutdown is complete.</span></span> <span data-ttu-id="ed2b1-133">Tuttavia, per impedire l'arresto di un servizio, è previsto un limite al tempo di attesa del controller di servizio.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-133">However, to prevent a service from stopping shutdown, there is a limit to how long the service controller waits.</span></span> <span data-ttu-id="ed2b1-134">Se il servizio viene arrestato tramite lo snap-in servizi, il limite è di 125 secondi o 125.000 millisecondi.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-134">If the service is being shut down through the Services snap-in, the limit is 125 seconds, or 125,000 milliseconds.</span></span> <span data-ttu-id="ed2b1-135">Se il sistema operativo viene riavviato, il limite di tempo viene specificato nel valore **WaitToKillServiceTimeout** (in millisecondi) della chiave del registro di sistema seguente:</span><span class="sxs-lookup"><span data-stu-id="ed2b1-135">If the operating system is rebooting, the time limit is specified in the **WaitToKillServiceTimeout** value (in milliseconds) of the following registry key:</span></span>

<span data-ttu-id="ed2b1-136">**\_ \_ \\ Controllo CurrentControlSet del sistema del computer \\ locale \\ HKEY**</span><span class="sxs-lookup"><span data-stu-id="ed2b1-136">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control**</span></span>

> [!IMPORTANT]
> <span data-ttu-id="ed2b1-137">Un servizio non deve tentare di aumentare il limite di tempo modificando questo valore.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-137">A service should not attempt to increase the time limit by modifying this value.</span></span> <span data-ttu-id="ed2b1-138">Se è necessario impostare **WaitToKillServiceTimeout** manualmente, il valore deve essere in millisecondi.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-138">If you do need to set **WaitToKillServiceTimeout** by hand, the value should be in milliseconds.</span></span>

<span data-ttu-id="ed2b1-139">I clienti richiedono un arresto rapido del sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-139">Customers require fast shutdown of the operating system.</span></span> <span data-ttu-id="ed2b1-140">Se, ad esempio, un computer in cui è in esecuzione la potenza di UPS non è in grado di completare l'arresto prima dell'esaurimento della potenza, i dati possono andare persi.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-140">For example, if a computer running on UPS power cannot complete shutdown before the UPS runs out of power, data can be lost.</span></span> <span data-ttu-id="ed2b1-141">I servizi devono pertanto completare le attività di pulizia nel minor tempo possibile.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-141">Therefore, services should complete their cleanup tasks as quickly as possible.</span></span> <span data-ttu-id="ed2b1-142">È consigliabile ridurre al minimo i dati non salvati salvando i dati a intervalli regolari, tenendo traccia dei dati salvati su disco e salvando solo i dati non salvati in caso di arresto.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-142">It is a good practice to minimize unsaved data by saving data on a regular basis, keeping track of the data that is saved to disk, and only saving your unsaved data on shutdown.</span></span> <span data-ttu-id="ed2b1-143">Poiché il computer è in fase di arresto, non dedicare tempo a rilasciare la memoria allocata o altre risorse di sistema.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-143">Because the computer is being shut down, do not spend time releasing allocated memory or other system resources.</span></span> <span data-ttu-id="ed2b1-144">Se è necessario inviare una notifica a un server che si sta uscendo, ridurre al minimo il tempo trascorso in attesa di una risposta, perché i problemi di rete potrebbero ritardare l'arresto del servizio.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-144">If you need to notify a server that you are exiting, minimize the time spent waiting for a reply, because network problems could delay the shutdown of your service.</span></span>

<span data-ttu-id="ed2b1-145">Si noti che durante l'arresto del servizio, per impostazione predefinita, SCM non prende in considerazione le dipendenze.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-145">Note that during service shutdown, by default, the SCM does not take dependencies into consideration.</span></span> <span data-ttu-id="ed2b1-146">SCM enumera l'elenco dei servizi in esecuzione e invia il comando **di \_ \_ arresto del controllo del servizio** .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-146">The SCM enumerates the list of running services and sends the **SERVICE\_CONTROL\_SHUTDOWN** command.</span></span> <span data-ttu-id="ed2b1-147">Pertanto, un servizio potrebbe non riuscire perché è già stato arrestato un altro servizio da cui dipende.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-147">Therefore, a service may fail because another service it depends on has already stopped.</span></span>

<span data-ttu-id="ed2b1-148">Per impostare l'ordine di arresto dei servizi manualmente, creare un valore di registro multistringa contenente i nomi dei servizi nell'ordine in cui devono essere arrestati e assegnarlo al valore **PreshutdownOrder** della chiave di controllo, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="ed2b1-148">To set the shutdown order of services manually, create a multistring registry value that contains the service names in the order in which they should be shut down and assign it to the Control key's **PreshutdownOrder** value, as follows:</span></span>

<span data-ttu-id="ed2b1-149">**HKEY \_ Local \_ computer \\ System \\ CurrentControlSet \\ Control \\ PreshutdownOrder = "Shutdown Order"**</span><span class="sxs-lookup"><span data-stu-id="ed2b1-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\PreshutdownOrder="Shutdown Order"**</span></span>

<span data-ttu-id="ed2b1-150">Per impostare l'ordine di arresto dei servizi dipendenti dall'applicazione, usare la funzione [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) .</span><span class="sxs-lookup"><span data-stu-id="ed2b1-150">To set the shutdown order of dependent services from your application, use the [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function.</span></span> <span data-ttu-id="ed2b1-151">Il controllo SCM usa questa funzione per assegnare alla priorità 0x1E0 del gestore.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-151">The SCM uses this function to give its handler 0x1E0 priority.</span></span> <span data-ttu-id="ed2b1-152">SCM Invia notifiche **di \_ \_ arresto del controllo del servizio** quando viene chiamato il gestore di controllo e attende la chiusura dei servizi prima di restituire il relativo gestore di controllo.</span><span class="sxs-lookup"><span data-stu-id="ed2b1-152">The SCM sends **SERVICE\_CONTROL\_SHUTDOWN** notifications when its control handler is called and waits for the services to exit before returning from its control handler.</span></span>

## <a name="related-topics"></a><span data-ttu-id="ed2b1-153">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="ed2b1-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="ed2b1-154">Scrittura di una funzione del gestore di controllo</span><span class="sxs-lookup"><span data-stu-id="ed2b1-154">Writing a Control Handler Function</span></span>](writing-a-control-handler-function.md)
</dt> </dl>

 

 
