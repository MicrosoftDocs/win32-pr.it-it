---
description: Informazioni sulla protezione dei servizi in modalità utente (AM) anti-malware e su come è possibile scegliere di includere questa funzionalità nel servizio anti-malware.
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: Protezione dei servizi anti-malware
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2021
ms.locfileid: "104058223"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="50c2d-103">Protezione dei servizi anti-malware</span><span class="sxs-lookup"><span data-stu-id="50c2d-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="50c2d-104">In Windows 8.1 è stato introdotto un nuovo concetto di servizi protetti per la protezione di servizi anti-malware, che rappresentano una frequente destinazione di attacchi da malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="50c2d-105">Informazioni sulla protezione dei servizi in modalità utente (AM) anti-malware e su come è possibile scegliere di includere questa funzionalità nel servizio anti-malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="50c2d-106">Queste informazioni si applicano ai sistemi operativi seguenti e ai relativi successori:</span><span class="sxs-lookup"><span data-stu-id="50c2d-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="50c2d-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="50c2d-107">Windows 8.1</span></span>
-   <span data-ttu-id="50c2d-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="50c2d-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="50c2d-109">I riferimenti e le risorse descritti sono elencati alla fine di questo argomento.</span><span class="sxs-lookup"><span data-stu-id="50c2d-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="50c2d-110">Introduzione</span><span class="sxs-lookup"><span data-stu-id="50c2d-110">Introduction</span></span>

<span data-ttu-id="50c2d-111">La maggior parte delle soluzioni anti-malware include un servizio in modalità utente che esegue operazioni specializzate per rilevare e rimuovere malware dal sistema.</span><span class="sxs-lookup"><span data-stu-id="50c2d-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="50c2d-112">Questo servizio in modalità utente è inoltre spesso responsabile del download delle definizioni di virus e delle firme più recenti.</span><span class="sxs-lookup"><span data-stu-id="50c2d-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="50c2d-113">Questo servizio in modalità utente diventa una destinazione frequente di malware perché è il singolo punto di errore di disabilitare la protezione in un sistema.</span><span class="sxs-lookup"><span data-stu-id="50c2d-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="50c2d-114">Per difendersi dagli attacchi al servizio in modalità utente, i fornitori di software antimalware devono aggiungere una grande quantità di funzionalità e euristica ai propri software.</span><span class="sxs-lookup"><span data-stu-id="50c2d-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="50c2d-115">Tuttavia, tali tecniche non sono completamente infallibili e tendono a essere soggette a errori perché devono identificare le funzionalità eseguite da Windows sul proprio servizio e abilitare selettivamente tale funzionalità.</span><span class="sxs-lookup"><span data-stu-id="50c2d-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="50c2d-116">In Windows 8.1, è stato introdotto un nuovo concetto di servizio protetto per consentire l'avvio di servizi in modalità utente anti-malware come servizio protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="50c2d-117">Quando il servizio viene avviato come protetto, Windows utilizza l'integrità del codice per consentire il caricamento del codice attendibile solo nel servizio protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="50c2d-118">Windows protegge inoltre questi processi dall'inserimento del codice e da altri attacchi dei processi amministrativi.</span><span class="sxs-lookup"><span data-stu-id="50c2d-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="50c2d-119">Questo documento descrive il modo in cui un fornitore anti-malware con un driver anti-malware di avvio anticipato (ELAM) può acconsentire esplicitamente a questa funzionalità e avviare il servizio antimalware come servizio protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="50c2d-120">Processo protetto dal sistema</span><span class="sxs-lookup"><span data-stu-id="50c2d-120">System protected process</span></span>

<span data-ttu-id="50c2d-121">A partire da Windows 8.1, nel kernel è stato messo a punto un nuovo modello di sicurezza per una migliore difesa da attacchi dannosi ai componenti critici del sistema.</span><span class="sxs-lookup"><span data-stu-id="50c2d-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="50c2d-122">Questo nuovo modello di sicurezza estende l'infrastruttura di processo protetta le versioni precedenti di Windows usate per scenari specifici, ad esempio la riproduzione di contenuto DRM, in un modello di uso generico che può essere usato da fornitori antimalware di terze parti.</span><span class="sxs-lookup"><span data-stu-id="50c2d-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="50c2d-123">L'infrastruttura del processo protetto consente il caricamento di codice con firma attendibile e ha una difesa incorporata contro gli attacchi intrusivi nel codice.</span><span class="sxs-lookup"><span data-stu-id="50c2d-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="50c2d-124">Per ulteriori informazioni sui processi protetti, vedere [processi protetti in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) .</span><span class="sxs-lookup"><span data-stu-id="50c2d-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="50c2d-125">Il nuovo modello di sicurezza usa una variante leggermente diversa dell'infrastruttura del processo di protezione, denominata processo protetto dal sistema, che è più adatto per questa funzionalità, in quanto mantiene il contenuto DRM separato.</span><span class="sxs-lookup"><span data-stu-id="50c2d-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="50c2d-126">A ogni processo protetto dal sistema è associato un livello o un attributo, che indica i criteri di firma del codice firmato consentito per il caricamento nel processo.</span><span class="sxs-lookup"><span data-stu-id="50c2d-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="50c2d-127">Dopo che i servizi anti-malware hanno optato per la modalità del servizio protetto, è consentito il caricamento in tale processo solo del codice firmato da Windows o del codice firmato con i certificati del fornitore anti-malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="50c2d-128">Analogamente, altri livelli di processo protetti hanno criteri di codice diversi applicati da Windows.</span><span class="sxs-lookup"><span data-stu-id="50c2d-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="50c2d-129">Requisiti</span><span class="sxs-lookup"><span data-stu-id="50c2d-129">Requirements</span></span>

<span data-ttu-id="50c2d-130">Per l'esecuzione di un servizio in modalità utente anti-malware come servizio protetto, il fornitore anti-malware deve avere un driver ELAM installato nel computer Windows.</span><span class="sxs-lookup"><span data-stu-id="50c2d-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="50c2d-131">Oltre ai requisiti di certificazione esistenti per i driver ELAM, il driver deve avere una sezione di risorse incorporata contenente le informazioni dei certificati usati per firmare i file binari del servizio in modalità utente.</span><span class="sxs-lookup"><span data-stu-id="50c2d-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="50c2d-132">In Windows 8.1, la catena di certificazione deve essere una radice nota come determinato dalla verifica del driver oppure deve essere incluso il certificato radice.</span><span class="sxs-lookup"><span data-stu-id="50c2d-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="50c2d-133">Durante il processo di avvio, questa sezione delle risorse verrà estratta dal driver ELAM per convalidare le informazioni sul certificato e registrare il servizio anti-malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="50c2d-134">Il servizio anti-malware può essere registrato anche durante il processo di installazione del software anti-malware chiamando un'API speciale, come descritto più avanti in questo documento.</span><span class="sxs-lookup"><span data-stu-id="50c2d-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="50c2d-135">Dopo che la sezione delle risorse è stata estratta correttamente dal driver ELAM e il servizio in modalità utente è registrato, il servizio può essere avviato come servizio protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="50c2d-136">Dopo che il servizio è stato avviato come protetto, altri processi non protetti nel sistema non saranno in grado di inserire thread e non saranno autorizzati a scrivere nella memoria virtuale del processo protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="50c2d-137">Inoltre, qualsiasi dll non Windows che viene caricata nel processo protetto deve essere firmata con un certificato appropriato.</span><span class="sxs-lookup"><span data-stu-id="50c2d-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="50c2d-138">Per altre informazioni sui driver ELAM, vedere [antimalware ad esecuzione anticipata](/windows/desktop/w8cookbook/secured-boot) .</span><span class="sxs-lookup"><span data-stu-id="50c2d-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="50c2d-139">Requisiti per la firma di servizi anti-malware</span><span class="sxs-lookup"><span data-stu-id="50c2d-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="50c2d-140">Il servizio in modalità utente che deve essere avviato come protetto deve essere firmato con certificati validi.</span><span class="sxs-lookup"><span data-stu-id="50c2d-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="50c2d-141">Il file EXE del servizio deve essere firmato con hash di pagina e tutte le dll non Windows caricate nel servizio devono essere firmate anche con gli stessi certificati.</span><span class="sxs-lookup"><span data-stu-id="50c2d-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="50c2d-142">L'hash di questi certificati deve essere aggiunto al file di risorse, che verrà collegato al driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="50c2d-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="50c2d-143">È necessario usare gli hash di pagine o file SHA256, anche se i certificati possono continuare a essere SHA1.</span><span class="sxs-lookup"><span data-stu-id="50c2d-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="50c2d-144">Firma primaria (scelta consigliata)</span><span class="sxs-lookup"><span data-stu-id="50c2d-144">Primary signature (recommended)</span></span>

<span data-ttu-id="50c2d-145">È consigliabile che i fornitori anti-malware usino il certificato Authenticode esistente per firmare i file binari del servizio antimalware e che l'hash di questo certificato Authenticode venga incluso nella sezione Resource per indicare il certificato usato per firmare i file binari del servizio.</span><span class="sxs-lookup"><span data-stu-id="50c2d-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="50c2d-146">Se si aggiorna questo certificato, è necessario rilasciare una versione più recente del driver ELAM con gli hash del certificato aggiornati.</span><span class="sxs-lookup"><span data-stu-id="50c2d-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="50c2d-147">Firma secondaria (facoltativo)</span><span class="sxs-lookup"><span data-stu-id="50c2d-147">Secondary signature (optional)</span></span>

<span data-ttu-id="50c2d-148">I fornitori anti-malware hanno la possibilità di configurare un'autorità di certificazione privata e di usare certificati da questa autorità di certificazione per firmare il codice dei binari del servizio antimalware come firma secondaria.</span><span class="sxs-lookup"><span data-stu-id="50c2d-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="50c2d-149">Il vantaggio principale dell'utilizzo della CA privata è che consente ai fornitori di creare certificati con una proprietà EKU specializzata, che può essere utilizzata per distinguere più prodotti dallo stesso fornitore.</span><span class="sxs-lookup"><span data-stu-id="50c2d-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="50c2d-150">Riduce inoltre la necessità di aggiornare il driver ELAM a causa della scadenza del certificato, perché i certificati della CA privata hanno in genere date di scadenza più lunghe.</span><span class="sxs-lookup"><span data-stu-id="50c2d-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="50c2d-151">Si noti che se i file binari del servizio sono firmati con i certificati dell'autorità di certificazione privata, i file binari devono essere anch ' essi firmati a doppio con i certificati Authenticode esistenti.</span><span class="sxs-lookup"><span data-stu-id="50c2d-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="50c2d-152">Se i file binari non sono firmati da un'autorità di certificazione attendibile nota, ad esempio VeriSign, l'utente del computer non ha alcuna confidenza nei file binari perché non può considerare attendibile la CA privata.</span><span class="sxs-lookup"><span data-stu-id="50c2d-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="50c2d-153">La firma duale dei file binari con il certificato Authenticode esistente consente inoltre l'esecuzione dei file binari nei sistemi operativi di livello inferiore.</span><span class="sxs-lookup"><span data-stu-id="50c2d-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="50c2d-154">Per ulteriori informazioni su come configurare e installare l'autorità di certificazione, vedere la pagina [relativa alla configurazione di un'autorità](/previous-versions/windows/desktop/ms755466(v=vs.85)) di [certificazione e all'installazione dell'](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))autorità di certificazione.</span><span class="sxs-lookup"><span data-stu-id="50c2d-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="50c2d-155">Per la compatibilità con Windows Vista o Windows XP (o Windows 7 senza patch SHA2), è possibile usare l'opzione "/As" quando si firmano i file binari con [SignTool.exe](/windows/desktop/SecCrypto/signtool) con gli hash di file o di pagina SHA256.</span><span class="sxs-lookup"><span data-stu-id="50c2d-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="50c2d-156">Verrà aggiunta la firma come firma secondaria al file.</span><span class="sxs-lookup"><span data-stu-id="50c2d-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="50c2d-157">SHA1 firma prima il file, poiché Windows XP, Windows Vista e Windows 7 vedranno solo la prima firma.</span><span class="sxs-lookup"><span data-stu-id="50c2d-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="50c2d-158">Requisiti di firma DLL</span><span class="sxs-lookup"><span data-stu-id="50c2d-158">DLL signing requirements</span></span>

<span data-ttu-id="50c2d-159">Come indicato in precedenza, tutte le dll non Windows che vengono caricate nel servizio protetto devono essere firmate con lo stesso certificato usato per firmare il servizio anti-malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="50c2d-160">Firma del catalogo</span><span class="sxs-lookup"><span data-stu-id="50c2d-160">Catalog Signing</span></span>

<span data-ttu-id="50c2d-161">I fornitori anti-malware possono includere pacchetti sviluppati da altre società senza aggiornare le firme binarie.</span><span class="sxs-lookup"><span data-stu-id="50c2d-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="50c2d-162">Questa operazione può essere eseguita includendo i file binari in un catalogo firmato con il certificato Authenticode, eseguiti seguendo questa procedura:</span><span class="sxs-lookup"><span data-stu-id="50c2d-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="50c2d-163">Generare un catalogo con [MakeCat](/windows/desktop/SecCrypto/makecat)</span><span class="sxs-lookup"><span data-stu-id="50c2d-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="50c2d-164">Aggiungere tutti i file binari senza una firma appropriata al catalogo</span><span class="sxs-lookup"><span data-stu-id="50c2d-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="50c2d-165">Firmare il catalogo con il certificato Authenticode, come per qualsiasi altro file binario</span><span class="sxs-lookup"><span data-stu-id="50c2d-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="50c2d-166">Utilizzare la funzione [Aggiungi catalogo](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) per includere il catalogo con l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="50c2d-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="50c2d-167">Quando l'integrità del codice viene eseguita tra i pacchetti senza una firma appropriata, viene eseguita la ricerca di un catalogo con una firma approvata.</span><span class="sxs-lookup"><span data-stu-id="50c2d-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="50c2d-168">Questo catalogo verrà trovato purché questi passaggi vengano seguiti e installati con l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="50c2d-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="50c2d-169">Informazioni sul file di risorse</span><span class="sxs-lookup"><span data-stu-id="50c2d-169">Resource file info</span></span>

<span data-ttu-id="50c2d-170">È necessario creare un file di risorse e collegarlo al driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="50c2d-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="50c2d-171">L'hash del certificato, insieme ad altre informazioni sul certificato, deve essere aggiunto al file di risorse.</span><span class="sxs-lookup"><span data-stu-id="50c2d-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="50c2d-172">La sezione Resource deve trovarsi nel layout seguente affinché il sistema estragga correttamente le risorse dall'immagine binaria e convalidi le informazioni sul certificato incorporato.</span><span class="sxs-lookup"><span data-stu-id="50c2d-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="50c2d-173">Per altre informazioni sul file di risorse definito dall'utente, vedere [risorsa definita dall'](/windows/desktop/menurc/user-defined-resource)utente.</span><span class="sxs-lookup"><span data-stu-id="50c2d-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="50c2d-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="50c2d-174">CertHash</span></span>

<span data-ttu-id="50c2d-175">Hash del certificato usato per firmare il servizio anti-malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="50c2d-176">Per ottenere l'hash, è possibile usare lo strumento CertMgr.exe, fornito nel Windows SDK.</span><span class="sxs-lookup"><span data-stu-id="50c2d-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="50c2d-177">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="50c2d-177">For example:</span></span>

![hash del certificato del servizio protetto anti-malware (certHash)](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="50c2d-179">Algoritmo</span><span class="sxs-lookup"><span data-stu-id="50c2d-179">Algorithm</span></span>

<span data-ttu-id="50c2d-180">Il valore dell'algoritmo rappresenta l'algoritmo del certificato.</span><span class="sxs-lookup"><span data-stu-id="50c2d-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="50c2d-181">Sono supportati i valori dell'algoritmo seguenti:</span><span class="sxs-lookup"><span data-stu-id="50c2d-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="50c2d-182">0x8004-SHA1</span><span class="sxs-lookup"><span data-stu-id="50c2d-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="50c2d-183">0x800c-SHA256</span><span class="sxs-lookup"><span data-stu-id="50c2d-183">0x800c – SHA256</span></span>  
<span data-ttu-id="50c2d-184">0X800d-SHA384</span><span class="sxs-lookup"><span data-stu-id="50c2d-184">0X800d – SHA384</span></span>  
<span data-ttu-id="50c2d-185">0x800e-SHA512</span><span class="sxs-lookup"><span data-stu-id="50c2d-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="50c2d-186">Ricordarsi di includere il valore dell'algoritmo, come illustrato in precedenza, e non il nome effettivo dell'algoritmo.</span><span class="sxs-lookup"><span data-stu-id="50c2d-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="50c2d-187">Ad esempio, se il certificato è basato sull'algoritmo SHA256, includere 0x800c nella sezione delle risorse.</span><span class="sxs-lookup"><span data-stu-id="50c2d-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="50c2d-188">EKU</span><span class="sxs-lookup"><span data-stu-id="50c2d-188">EKU</span></span>

<span data-ttu-id="50c2d-189">L'oggetto EKU rappresenta una singola proprietà di utilizzo chiavi avanzato (EKU) di un certificato.</span><span class="sxs-lookup"><span data-stu-id="50c2d-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="50c2d-190">Questa opzione è facoltativa ed è \\ necessario specificare "0" Se al certificato non è associato alcun EKU. Nel caso in cui siano presenti più prodotti e servizi di un singolo fornitore antimalware in esecuzione nello stesso sistema, il fornitore antimalware può utilizzare la proprietà EKU del certificato della CA privata per distinguere un servizio da un altro.</span><span class="sxs-lookup"><span data-stu-id="50c2d-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="50c2d-191">Ad esempio, se nel sistema sono in esecuzione due servizi dello stesso fornitore antimalware e firmati dalla stessa autorità di certificazione, il servizio che deve essere avviato come protetto può essere firmato con un certificato emesso dalla CA che contiene uno speciale EKU.</span><span class="sxs-lookup"><span data-stu-id="50c2d-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="50c2d-192">Questo EKU deve essere aggiunto alla sezione delle risorse.</span><span class="sxs-lookup"><span data-stu-id="50c2d-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="50c2d-193">L'EKU viene quindi registrato dal sistema e associato all'hash del certificato per la convalida e l'avvio del servizio come protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="50c2d-194">Si noti che la catena di certificati deve includere l'EKU per la firma del codice (1.3.6.1.5.5.7.3.3), ma questo EKU non deve essere incluso nella sezione delle risorse del driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="50c2d-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="50c2d-195">Se le informazioni EKU sono incluse nelle informazioni sui certificati per il driver ELAM, è necessario usare lo stesso EKU per la firma dei file binari.</span><span class="sxs-lookup"><span data-stu-id="50c2d-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="50c2d-196">Conteggio</span><span class="sxs-lookup"><span data-stu-id="50c2d-196">Count</span></span>

<span data-ttu-id="50c2d-197">Se il file binario del servizio anti-malware è firmato con il certificato Authenticode e con il certificato della CA privata, è necessario aggiungere solo le informazioni sul certificato della CA privata nella sezione Resource.</span><span class="sxs-lookup"><span data-stu-id="50c2d-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="50c2d-198">Avvio dei servizi anti-malware come protetti</span><span class="sxs-lookup"><span data-stu-id="50c2d-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="50c2d-199">Registrazione del servizio</span><span class="sxs-lookup"><span data-stu-id="50c2d-199">Registering the service</span></span>

<span data-ttu-id="50c2d-200">Il servizio anti-malware deve essere registrato con il sistema prima di poter essere avviato come protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="50c2d-201">Durante l'installazione del software antimalware, il programma di installazione può installare il driver ELAM e riavviare il sistema per registrare automaticamente il servizio.</span><span class="sxs-lookup"><span data-stu-id="50c2d-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="50c2d-202">Il sistema registrerà il servizio in fase di avvio estraendo le informazioni sul certificato dal file di risorse citato nel driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="50c2d-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="50c2d-203">Durante la fase di installazione, si consiglia vivamente di riavviare il sistema per consentire il caricamento del driver ELAM e la convalida dello stato del sistema.</span><span class="sxs-lookup"><span data-stu-id="50c2d-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="50c2d-204">Tuttavia, per i casi in cui è necessario evitare il riavvio, Windows espone anche un meccanismo per il programma di installazione antimalware per registrare il servizio come protetto mediante un'API.</span><span class="sxs-lookup"><span data-stu-id="50c2d-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="50c2d-205">Registrazione del servizio senza riavviare il sistema</span><span class="sxs-lookup"><span data-stu-id="50c2d-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="50c2d-206">Durante l'installazione, un programma di installazione del software antimalware può chiamare l'API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) e fornire un handle al file del driver Elam.</span><span class="sxs-lookup"><span data-stu-id="50c2d-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="50c2d-207">Il sistema apre il driver ELAM, chiama le routine interne per verificare che il driver ELAM sia firmato correttamente ed estrae le informazioni del certificato dalla sezione delle risorse associata al driver ELAM.</span><span class="sxs-lookup"><span data-stu-id="50c2d-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="50c2d-208">Per la sintassi della funzione, vedere [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span><span class="sxs-lookup"><span data-stu-id="50c2d-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="50c2d-209">Esempio di codice:</span><span class="sxs-lookup"><span data-stu-id="50c2d-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="50c2d-210">Avvio del servizio come protetto</span><span class="sxs-lookup"><span data-stu-id="50c2d-210">Starting the service as protected</span></span>

<span data-ttu-id="50c2d-211">Il programma di installazione può seguire questa procedura per creare, configurare e avviare il servizio come protetto:</span><span class="sxs-lookup"><span data-stu-id="50c2d-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="50c2d-212">Chiamare l'API [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) per creare un oggetto servizio e aggiungerlo al database di gestione controllo servizi (SCM).</span><span class="sxs-lookup"><span data-stu-id="50c2d-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="50c2d-213">Chiamare l'API [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) per impostare il descrittore di sicurezza dell'oggetto servizio creato nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="50c2d-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="50c2d-214">Chiamare l'API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) per contrassegnare il servizio come protetto, specificando il nuovo valore di enumerazione protetto di avvio della configurazione del **servizio \_ \_ \_** , che è stato aggiunto in Winsvc. h (a partire da Windows 8.1).</span><span class="sxs-lookup"><span data-stu-id="50c2d-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="50c2d-215">Esempio di codice:</span><span class="sxs-lookup"><span data-stu-id="50c2d-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="50c2d-216">Chiamare l'API [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) per avviare il servizio.</span><span class="sxs-lookup"><span data-stu-id="50c2d-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="50c2d-217">Quando si avvia il servizio come protetto, SCM verifica il sottosistema di integrità del codice (CI) per convalidare le informazioni del certificato.</span><span class="sxs-lookup"><span data-stu-id="50c2d-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="50c2d-218">Dopo aver convalidato le informazioni sul certificato da CI, SCM avvia il servizio come protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="50c2d-219">Si noti che questo passaggio ha esito negativo se il servizio non è stato registrato chiamando l'API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) .</span><span class="sxs-lookup"><span data-stu-id="50c2d-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="50c2d-220">Se il servizio è stato configurato per l'avvio automatico durante la fase di avvio del sistema, è possibile evitare questo passaggio e riavviare semplicemente il sistema.</span><span class="sxs-lookup"><span data-stu-id="50c2d-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="50c2d-221">Durante un riavvio, il sistema registra automaticamente il servizio (se il driver ELAM viene avviato correttamente) e avvia il servizio in modalità protetta.</span><span class="sxs-lookup"><span data-stu-id="50c2d-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="50c2d-222">Avvio di un processo figlio come protetto</span><span class="sxs-lookup"><span data-stu-id="50c2d-222">Launching a child process as protected</span></span>

<span data-ttu-id="50c2d-223">Il nuovo modello di sicurezza consente inoltre ai servizi protetti da anti-malware di avviare i processi figlio come protetti.</span><span class="sxs-lookup"><span data-stu-id="50c2d-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="50c2d-224">Questi processi figlio verranno eseguiti allo stesso livello di protezione del servizio padre e i file binari devono essere firmati con lo stesso certificato registrato tramite la sezione delle risorse ELAM.</span><span class="sxs-lookup"><span data-stu-id="50c2d-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="50c2d-225">Per consentire al servizio protetto anti-malware di avviare il processo figlio come protetto, è stata esposta una nuova chiave di attributo esteso, il **livello di protezione dell' \_ \_ attributo proc \_ \_ thread**, che deve essere usato con l'API [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) .</span><span class="sxs-lookup"><span data-stu-id="50c2d-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="50c2d-226">Un puntatore al valore dell'attributo del **livello di protezione \_ \_ stesso** deve essere passato nell'API **UpdateProcThreadAttribute** .</span><span class="sxs-lookup"><span data-stu-id="50c2d-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="50c2d-227">Note:</span><span class="sxs-lookup"><span data-stu-id="50c2d-227">Notes:</span></span>

-   <span data-ttu-id="50c2d-228">Per usare questo nuovo attributo, il servizio deve anche specificare **Crea \_ \_ processo protetto** nel parametro dei flag di creazione del processo della chiamata [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) .</span><span class="sxs-lookup"><span data-stu-id="50c2d-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="50c2d-229">È necessario che i file binari del servizio siano firmati usando l'opzione/AC per includere il certificato incrociato per concatenarlo a un'autorità di certificazione nota.</span><span class="sxs-lookup"><span data-stu-id="50c2d-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="50c2d-230">Il certificato autofirmato senza concatenamento corretto a una CA radice nota non funzionerà.</span><span class="sxs-lookup"><span data-stu-id="50c2d-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="50c2d-231">Esempio di codice:</span><span class="sxs-lookup"><span data-stu-id="50c2d-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="50c2d-232">Aggiornamenti e manutenzione</span><span class="sxs-lookup"><span data-stu-id="50c2d-232">Updates and servicing</span></span>

<span data-ttu-id="50c2d-233">Quando il servizio anti-malware viene avviato come protetto, altri processi non protetti (e persino gli amministratori) non sono in grado di arrestare il servizio.</span><span class="sxs-lookup"><span data-stu-id="50c2d-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="50c2d-234">Nel caso di aggiornamenti per i file binari del servizio, il servizio anti-malware deve ricevere un callback dal programma di installazione per arrestarsi in modo da poter essere servito.</span><span class="sxs-lookup"><span data-stu-id="50c2d-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="50c2d-235">Dopo l'arresto del servizio, il programma di installazione antimalware può eseguire gli aggiornamenti e quindi seguire i passaggi descritti in precedenza nelle sezioni [registrazione del servizio](https://www.bing.com/search?q=Registering+the+service) e [avvio del servizio come protette](#starting-the-service-as-protected) per registrare il certificato e avviare il servizio come protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="50c2d-236">Si noti che il servizio deve garantire che solo i chiamanti attendibili possano arrestare il servizio.</span><span class="sxs-lookup"><span data-stu-id="50c2d-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="50c2d-237">Consentire a chiamanti non attendibili di eseguire questa operazione vanifica lo scopo di proteggere il servizio.</span><span class="sxs-lookup"><span data-stu-id="50c2d-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="50c2d-238">Annullamento della registrazione del servizio</span><span class="sxs-lookup"><span data-stu-id="50c2d-238">Unregistering the service</span></span>

<span data-ttu-id="50c2d-239">Quando si disinstalla un servizio protetto, il servizio deve contrassegnarsi come non protetto chiamando l'API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) .</span><span class="sxs-lookup"><span data-stu-id="50c2d-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="50c2d-240">Si noti che poiché il sistema non consente alcun processo non protetto per modificare la configurazione di un servizio protetto, la chiamata a [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) deve essere eseguita dal servizio protetto stesso.</span><span class="sxs-lookup"><span data-stu-id="50c2d-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="50c2d-241">Dopo che il servizio è stato riconfigurato per l'esecuzione come non protetto, il programma di disinstallazione può adottare semplicemente i passaggi appropriati per rimuovere il software anti-malware dal sistema.</span><span class="sxs-lookup"><span data-stu-id="50c2d-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="50c2d-242">Debug di un servizio protetto da malware</span><span class="sxs-lookup"><span data-stu-id="50c2d-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="50c2d-243">Come parte del modello di sicurezza del processo protetto, altri processi non protetti non sono in grado di inserire thread o scrivere nella memoria virtuale del processo protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="50c2d-244">Tuttavia è consentito un debugger del kernel (KD) per il debug di processi protetti da anti-malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="50c2d-245">KD può essere usato anche per verificare se il servizio anti-malware è in esecuzione come protetto o meno:</span><span class="sxs-lookup"><span data-stu-id="50c2d-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="50c2d-246">Se il valore del membro del *tipo* è 0y0001, il servizio viene eseguito come protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="50c2d-247">Inoltre, nel servizio protetto da malware sono consentiti solo i comandi SC seguenti:</span><span class="sxs-lookup"><span data-stu-id="50c2d-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="50c2d-248">Se il debugger è collegato, utilizzare il seguente flag nel registro di sistema per interrompere il debugger quando i file binari senza segno (o con firma non appropriata) vengono caricati nel servizio protetto da malware.</span><span class="sxs-lookup"><span data-stu-id="50c2d-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="50c2d-249">Impostare il valore su **00000400** per interrompere il debugger quando la convalida della firma ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="50c2d-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="50c2d-250">Limitazioni del processo protetto:</span><span class="sxs-lookup"><span data-stu-id="50c2d-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="50c2d-251">I processi con interfaccia utente o GUI non possono essere protetti a causa del modo in cui il kernel blocca un processo in memoria e non consente le Scritture.</span><span class="sxs-lookup"><span data-stu-id="50c2d-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="50c2d-252">Prima di Windows 10, versione 1703 (Creators Update), i processi protetti non possono usare i protocolli di comunicazione TLS o SSL a causa delle limitazioni della condivisione dei certificati tra l'autorità di protezione locale (LSA) e un processo protetto.</span><span class="sxs-lookup"><span data-stu-id="50c2d-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="50c2d-253">Risorse</span><span class="sxs-lookup"><span data-stu-id="50c2d-253">Resources</span></span>

<span data-ttu-id="50c2d-254">Per altre info, vedi:</span><span class="sxs-lookup"><span data-stu-id="50c2d-254">For more info, see:</span></span>

-   [<span data-ttu-id="50c2d-255">Antimalware ad esecuzione anticipata</span><span class="sxs-lookup"><span data-stu-id="50c2d-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="50c2d-256">[Processi protetti in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="50c2d-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="50c2d-257">[Configurazione di un'autorità di certificazione](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="50c2d-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="50c2d-258">[Installare l'Autorità di certificazione](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="50c2d-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="50c2d-259">Risorsa definita dall'utente</span><span class="sxs-lookup"><span data-stu-id="50c2d-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="50c2d-260">Questo articolo fa riferimento a queste funzioni API Windows:</span><span class="sxs-lookup"><span data-stu-id="50c2d-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="50c2d-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="50c2d-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="50c2d-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="50c2d-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="50c2d-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="50c2d-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="50c2d-264">**InitializeProcThreadAttributeList**</span><span class="sxs-lookup"><span data-stu-id="50c2d-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="50c2d-265">**InstallELAMCertificateInfo**</span><span class="sxs-lookup"><span data-stu-id="50c2d-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="50c2d-266">**SetServiceObjectSecurity**</span><span class="sxs-lookup"><span data-stu-id="50c2d-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="50c2d-267">**StartService**</span><span class="sxs-lookup"><span data-stu-id="50c2d-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="50c2d-268">**UpdateProcThreadAttribute**</span><span class="sxs-lookup"><span data-stu-id="50c2d-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
