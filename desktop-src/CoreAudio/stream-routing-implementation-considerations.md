---
description: In Windows 7, le API della piattaforma di alto livello che usano le API audio principali, ad esempio Media Foundation, DirectSound e Wave, implementano la funzionalità di routing dei flussi gestendo il passaggio da un dispositivo esistente a un nuovo endpoint audio predefinito.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Considerazioni sull'implementazione del routing del flusso
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27dc1f7e3fe56d6b421ca59f528ab1a65d2261a9
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2021
ms.locfileid: "103966175"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="72f46-103">Considerazioni sull'implementazione del routing del flusso</span><span class="sxs-lookup"><span data-stu-id="72f46-103">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="72f46-104">In Windows 7, le API della piattaforma di alto livello che usano le API audio principali, ad esempio Media Foundation, DirectSound e Wave, implementano la funzionalità di routing dei flussi gestendo il passaggio da un dispositivo esistente a un nuovo endpoint audio predefinito.</span><span class="sxs-lookup"><span data-stu-id="72f46-104">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="72f46-105">Le applicazioni multimediali che usano queste API usano il comportamento di routing del flusso senza apportare alcuna modifica all'origine.</span><span class="sxs-lookup"><span data-stu-id="72f46-105">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="72f46-106">I client WASAPI diretti possono usare le notifiche inviate dai componenti audio principali e implementare la funzionalità di routing dei flussi.</span><span class="sxs-lookup"><span data-stu-id="72f46-106">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="72f46-107">I client WASAPI diretti (le applicazioni multimediali che usano direttamente WASAPI) ricevono nuove notifiche di sessione audio e dispositivo inviate dai componenti audio di base.</span><span class="sxs-lookup"><span data-stu-id="72f46-107">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="72f46-108">Il comportamento della funzionalità di routing del flusso è definito dal modo in cui l'applicazione gestisce queste notifiche.</span><span class="sxs-lookup"><span data-stu-id="72f46-108">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="72f46-109">L'API MMDevice e la sessione audio inviano notifiche sulle modifiche dello stato del dispositivo e sulle modifiche di sessione ai client WASAPI sotto forma di callback.</span><span class="sxs-lookup"><span data-stu-id="72f46-109">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="72f46-110">Per ottenere queste notifiche, il client deve registrare l'implementazione di [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="72f46-110">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="72f46-111">Per ulteriori informazioni, vedere [notifiche rilevanti per il routing del flusso](relevant-device-notifications-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="72f46-111">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="72f46-112">Nello scenario dell'auricolare USB descritto in [routing del flusso](stream-routing.md), un'applicazione sta riproducendo un flusso audio e USA MMDEVICEAPI e WASAPI per eseguire il rendering del flusso sul dispositivo di rendering predefinito, **speaker**.</span><span class="sxs-lookup"><span data-stu-id="72f46-112">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="72f46-113">Quando viene modificato il dispositivo predefinito, l'applicazione riceve una notifica [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) .</span><span class="sxs-lookup"><span data-stu-id="72f46-113">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="72f46-114">L'applicazione riceve anche le notifiche [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) che indicano che l'utente ha rimosso il dispositivo dell'endpoint audio o che il formato del flusso è stato modificato per il dispositivo a cui è connessa la sessione audio.</span><span class="sxs-lookup"><span data-stu-id="72f46-114">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="72f46-115">Al momento della ricezione delle notifiche, l'applicazione interrompe lo streaming all'endpoint speaker e riapre il flusso per il rendering sull'endpoint predefinito corrente, ovvero l'auricolare.</span><span class="sxs-lookup"><span data-stu-id="72f46-115">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagramma del flusso di dati per le notifiche del dispositivo.](images/stream-routing.gif)

<span data-ttu-id="72f46-117">In risposta a tali notifiche, il client potrebbe riaprire il flusso sul nuovo dispositivo predefinito nel nuovo formato selezionato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="72f46-117">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="72f46-118">Gestione flussi</span><span class="sxs-lookup"><span data-stu-id="72f46-118">Stream Managment</span></span>

<span data-ttu-id="72f46-119">Nell'elenco seguente vengono riepilogati i passaggi che un client WASAPI deve eseguire per fornire la funzionalità di cambio del flusso.</span><span class="sxs-lookup"><span data-stu-id="72f46-119">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="72f46-120">Attendere la notifica di [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) pertinente.</span><span class="sxs-lookup"><span data-stu-id="72f46-120">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="72f46-121">Se il dispositivo è il dispositivo predefinito, viene ricevuta la notifica [**IMMNotificationClient:: OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) .</span><span class="sxs-lookup"><span data-stu-id="72f46-121">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="72f46-122">Se è disponibile un nuovo dispositivo, ottenere un riferimento all'endpoint del nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="72f46-122">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="72f46-123">Chiamare [**IMMDeviceEnumerator:: GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) per il nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="72f46-123">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="72f46-124">Se il nuovo dispositivo non è il dispositivo predefinito, è possibile recuperare il dispositivo chiamando [**IMMDeviceEnumerator:: GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="72f46-124">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="72f46-125">Per altre informazioni, vedere [ottenere l'endpoint del dispositivo per il routing del flusso](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="72f46-125">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="72f46-126">Attendere la [**IAudioSessionEvents:: OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) con il valore Reason.</span><span class="sxs-lookup"><span data-stu-id="72f46-126">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="72f46-127">Poiché tutte queste operazioni sono asincrono, l'ordine in cui l'applicazione riceve le notifiche di modifica del dispositivo e disconnessione della sessione Impossibile essere stimate.</span><span class="sxs-lookup"><span data-stu-id="72f46-127">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="72f46-128">L'applicazione deve implementare la gestione delle notifiche per ricevere queste notifiche in qualsiasi ordine.</span><span class="sxs-lookup"><span data-stu-id="72f46-128">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="72f46-129">Tuttavia, in genere, l'applicazione riceve il valore **AudioSessionDisconnect** prima della notifica di modifica predefinita del dispositivo.</span><span class="sxs-lookup"><span data-stu-id="72f46-129">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="72f46-130">Valutare il valore del motivo e determinare se il flusso deve essere trasferito a un altro endpoint audio o se il flusso deve essere reinizializzato con un nuovo formato.</span><span class="sxs-lookup"><span data-stu-id="72f46-130">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="72f46-131">Arrestare lo streaming al dispositivo predefinito precedente se il motivo indica che il flusso deve essere reindirizzato al nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="72f46-131">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="72f46-132">Eseguire i calcoli di mapping della posizione.</span><span class="sxs-lookup"><span data-stu-id="72f46-132">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="72f46-133">Aprire il flusso sul nuovo dispositivo e trasferire tutte le informazioni sullo stato.</span><span class="sxs-lookup"><span data-stu-id="72f46-133">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="72f46-134">Riprendere lo streaming sul nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="72f46-134">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="72f46-135">Gestire la partenza del dispositivo predefinito precedente.</span><span class="sxs-lookup"><span data-stu-id="72f46-135">Handle the departure of the old default device.</span></span>

<span data-ttu-id="72f46-136">Per far sembrare trasparente l'operazione di cambio del flusso, è necessario eseguire il più rapidamente possibile.</span><span class="sxs-lookup"><span data-stu-id="72f46-136">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="72f46-137">Ciò dipende dalle prestazioni dei componenti interessati dalla ripetizione dell'avvio del flusso nel nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="72f46-137">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="72f46-138">Considerazioni sul mapping delle posizioni</span><span class="sxs-lookup"><span data-stu-id="72f46-138">Position Mapping Considerations</span></span>

<span data-ttu-id="72f46-139">Quando l'applicazione ottiene le notifiche [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , può indirizzare i flussi esistenti al nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="72f46-139">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="72f46-140">Quando un flusso audio esistente viene interrotto e aperto nel nuovo dispositivo, il rendering sul nuovo dispositivo deve iniziare in corrispondenza della posizione in cui il flusso è stato interrotto sul dispositivo precedente.</span><span class="sxs-lookup"><span data-stu-id="72f46-140">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="72f46-141">A tale scopo, l'applicazione deve disporre dell'ultima posizione nota del dispositivo, per calcolare la posizione iniziale nel nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="72f46-141">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="72f46-142">Questa posizione, ad esempio, può essere usata come offset Delta per il mapping della posizione successiva.</span><span class="sxs-lookup"><span data-stu-id="72f46-142">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="72f46-143">Quando viene avviato il rendering del flusso, la nuova posizione del dispositivo può essere rimappata alla posizione del dispositivo memorizzata nella cache.</span><span class="sxs-lookup"><span data-stu-id="72f46-143">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="72f46-144">I passaggi seguenti riepilogano il processo di creazione di una transizione di flusso senza problemi.</span><span class="sxs-lookup"><span data-stu-id="72f46-144">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="72f46-145">Memorizzare nella cache l'ultima posizione del dispositivo del flusso sul dispositivo precedente.</span><span class="sxs-lookup"><span data-stu-id="72f46-145">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="72f46-146">Arrestare il flusso del dispositivo precedente.</span><span class="sxs-lookup"><span data-stu-id="72f46-146">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="72f46-147">Eseguire il mapping dei calcoli per ottenere la nuova posizione.</span><span class="sxs-lookup"><span data-stu-id="72f46-147">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="72f46-148">Avviare il rendering del flusso nel nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="72f46-148">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="72f46-149">Rilascia il flusso precedente.</span><span class="sxs-lookup"><span data-stu-id="72f46-149">Release the old stream.</span></span>

<span data-ttu-id="72f46-150">Durante la transizione, l'applicazione deve assicurarsi che l'orologio non ottenga la sincronizzazione, ottenendo flussi audio e video non sincronizzati.</span><span class="sxs-lookup"><span data-stu-id="72f46-150">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="72f46-151">Questo problema può verificarsi se gli esempi video continuano a essere sottoposte a rendering mentre il flusso audio viene indirizzato al nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="72f46-151">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="72f46-152">L'applicazione deve memorizzare nella cache la posizione di clock per il calcolo di nuovo mapping e assicurarsi che non venga eseguito il rendering degli esempi video fino a quando il flusso audio non viene riaperto sul nuovo dispositivo, in modo che quando il clip riprende il rendering, i flussi audio e video sono sincronizzati.</span><span class="sxs-lookup"><span data-stu-id="72f46-152">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="72f46-153">In alcuni casi, in cui il tempo di presentazione per il rendering dei fotogrammi video è basato sul clock audio, è sufficiente arrestare il flusso audio fino al completamento del cambio di flusso e non è necessaria alcuna implementazione di mapping di posizione per il flusso video per la sincronizzazione del video audio.</span><span class="sxs-lookup"><span data-stu-id="72f46-153">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="72f46-154">Se durante il rendering, [**IAudioRenderClient:: GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) restituisce un errore perché il dispositivo precedente viene perso, l'applicazione non deve arrestare il flusso precedente perché l'operazione di streaming è già terminata.</span><span class="sxs-lookup"><span data-stu-id="72f46-154">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="72f46-155">Per informazioni sulla gestione di questo errore, vedere [recupero da un errore di Invalid-Device](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="72f46-155">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="72f46-156">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="72f46-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="72f46-157">Informazioni sull'API MMDevice</span><span class="sxs-lookup"><span data-stu-id="72f46-157">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="72f46-158">Informazioni su WASAPI</span><span class="sxs-lookup"><span data-stu-id="72f46-158">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="72f46-159">Routing del flusso</span><span class="sxs-lookup"><span data-stu-id="72f46-159">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



