---
description: Informazioni sulle considerazioni sull'implementazione per il routing di flusso. Le API implementano il routing di flusso gestendo il passaggio del flusso a un nuovo endpoint audio predefinito.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Considerazioni sull'implementazione del routing di flusso
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62bd753fe027c92ffac9f5a41cea589b600d7f26
ms.sourcegitcommit: 51ef825fb48f15e1aa30e8795988f10dc2b2155c
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/14/2021
ms.locfileid: "112068037"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="fb574-104">Considerazioni sull'implementazione del routing di flusso</span><span class="sxs-lookup"><span data-stu-id="fb574-104">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="fb574-105">In Windows 7 le API della piattaforma di alto livello che usano LE API audio di base, ad esempio le API Media Foundation, DirectSound e Wave, implementano la funzionalità di routing del flusso gestendo il passaggio del flusso da un dispositivo esistente a un nuovo endpoint audio predefinito.</span><span class="sxs-lookup"><span data-stu-id="fb574-105">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="fb574-106">Le applicazioni multimediali che usano queste API usano il comportamento di routing del flusso senza alcuna modifica all'origine.</span><span class="sxs-lookup"><span data-stu-id="fb574-106">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="fb574-107">I client WASAPI diretti possono usare le notifiche inviate dai componenti Audio core e implementare la funzionalità di routing del flusso.</span><span class="sxs-lookup"><span data-stu-id="fb574-107">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="fb574-108">I client WASAPI diretti (applicazioni multimediali che usano direttamente WASAPI) ricevono nuove notifiche di sessione audio e dispositivo inviate dai componenti Core Audio.</span><span class="sxs-lookup"><span data-stu-id="fb574-108">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="fb574-109">Il comportamento della funzionalità di routing del flusso è definito dal modo in cui l'applicazione gestisce queste notifiche.</span><span class="sxs-lookup"><span data-stu-id="fb574-109">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="fb574-110">L'API MMDevice e la sessione audio inviano notifiche relative alle modifiche dello stato del dispositivo e alle modifiche della sessione ai client WASAPI sotto forma di callback.</span><span class="sxs-lookup"><span data-stu-id="fb574-110">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="fb574-111">Per ottenere queste notifiche, il client deve registrare l'implementazione di [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="fb574-111">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="fb574-112">Per altre informazioni, vedere [Notifiche rilevanti per il routing di flusso.](relevant-device-notifications-for-stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="fb574-112">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="fb574-113">Nello scenario di visore USB descritto in [Routing](stream-routing.md)di flusso, un'applicazione sta riproducendo un flusso audio e usa MMDeviceAPI e WASAPI per eseguire il rendering del flusso nel dispositivo di rendering predefinito, **Speaker**.</span><span class="sxs-lookup"><span data-stu-id="fb574-113">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="fb574-114">Quando il dispositivo predefinito viene modificato, l'applicazione riceve una [**notifica IMMNotificationClient.**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient)</span><span class="sxs-lookup"><span data-stu-id="fb574-114">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="fb574-115">L'applicazione riceve anche notifiche [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) che indicano che l'utente ha rimosso il dispositivo endpoint audio o che il formato del flusso è stato modificato per il dispositivo a cui è connessa la sessione audio.</span><span class="sxs-lookup"><span data-stu-id="fb574-115">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="fb574-116">Alla ricezione delle notifiche, l'applicazione interrompe lo streaming all'endpoint del parlante e riapre il flusso per il rendering nell'endpoint predefinito corrente, il visore.</span><span class="sxs-lookup"><span data-stu-id="fb574-116">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagramma del flusso di dati per le notifiche dei dispositivi.](images/stream-routing.gif)

<span data-ttu-id="fb574-118">In risposta a tali notifiche, il client potrebbe riaprire il flusso nel nuovo dispositivo predefinito nel nuovo formato selezionato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="fb574-118">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="fb574-119">Stream Managment</span><span class="sxs-lookup"><span data-stu-id="fb574-119">Stream Managment</span></span>

<span data-ttu-id="fb574-120">L'elenco seguente riepiloga i passaggi che un client WASAPI deve eseguire per fornire la funzionalità di cambio di flusso.</span><span class="sxs-lookup"><span data-stu-id="fb574-120">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="fb574-121">Attendere la notifica [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) pertinente.</span><span class="sxs-lookup"><span data-stu-id="fb574-121">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="fb574-122">Se il dispositivo è il dispositivo predefinito, viene ricevuta la [**notifica IMMNotificationClient::OnDefaultDeviceChanged.**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged)</span><span class="sxs-lookup"><span data-stu-id="fb574-122">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="fb574-123">Se è disponibile un nuovo dispositivo, ottenere un riferimento all'endpoint del nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="fb574-123">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="fb574-124">Chiamare [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) per il nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="fb574-124">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="fb574-125">Se il nuovo dispositivo non è il dispositivo predefinito, è possibile recuperare il dispositivo chiamando [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="fb574-125">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="fb574-126">Per altre informazioni, vedere [Recupero dell'endpoint del dispositivo per il routing di flusso.](getting-the-default-device-endpoint-for-stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="fb574-126">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="fb574-127">Attendere che [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) con il valore del motivo.</span><span class="sxs-lookup"><span data-stu-id="fb574-127">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="fb574-128">Poiché tutte queste operazioni sono asychronous, l'ordine in cui l'applicazione riceve notifiche di cambio dispositivo e disconnessione sessione non può essere stimata.</span><span class="sxs-lookup"><span data-stu-id="fb574-128">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="fb574-129">L'applicazione deve implementare la gestione delle notifiche per ricevere queste notifiche in qualsiasi ordine.</span><span class="sxs-lookup"><span data-stu-id="fb574-129">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="fb574-130">Tuttavia, in genere, l'applicazione riceve il **valore AudioSessionDisconnect** prima della notifica di modifica del dispositivo predefinita.</span><span class="sxs-lookup"><span data-stu-id="fb574-130">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="fb574-131">Valutare il valore del motivo e determinare se il flusso deve essere trasferito a un altro endpoint audio o se il flusso deve essere reinizializzato con un nuovo formato.</span><span class="sxs-lookup"><span data-stu-id="fb574-131">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="fb574-132">Interrompere lo streaming al dispositivo predefinito precedente se il motivo indica che il flusso deve essere nuovamente instradato al nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="fb574-132">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="fb574-133">Eseguire calcoli di mapping delle posizioni.</span><span class="sxs-lookup"><span data-stu-id="fb574-133">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="fb574-134">Aprire il flusso nel nuovo dispositivo e trasferire tutte le informazioni sullo stato.</span><span class="sxs-lookup"><span data-stu-id="fb574-134">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="fb574-135">Riprendere lo streaming nel nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="fb574-135">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="fb574-136">Gestire la partenza del dispositivo predefinito precedente.</span><span class="sxs-lookup"><span data-stu-id="fb574-136">Handle the departure of the old default device.</span></span>

<span data-ttu-id="fb574-137">Per rendere l'operazione di commutazione del flusso facile, è necessario eseguire il più rapidamente possibile.</span><span class="sxs-lookup"><span data-stu-id="fb574-137">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="fb574-138">Ciò dipende dalle prestazioni dei componenti coinvolti nella reinizializzazione del flusso nel nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="fb574-138">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="fb574-139">Considerazioni sul mapping delle posizioni</span><span class="sxs-lookup"><span data-stu-id="fb574-139">Position Mapping Considerations</span></span>

<span data-ttu-id="fb574-140">Quando l'applicazione riceve le notifiche [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) e [**IAudioSessionEvents,**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) può instradare i flussi esistenti al nuovo dispositivo predefinito.</span><span class="sxs-lookup"><span data-stu-id="fb574-140">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="fb574-141">Quando un flusso audio esistente viene interrotto e aperto nel nuovo dispositivo, il rendering nel nuovo dispositivo deve iniziare dalla posizione in cui il flusso è stato arrestato nel dispositivo precedente.</span><span class="sxs-lookup"><span data-stu-id="fb574-141">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="fb574-142">A tale scopo, l'applicazione deve avere l'ultima posizione del dispositivo nota, per calcolare la posizione iniziale nel nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="fb574-142">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="fb574-143">Ad esempio, questa posizione può essere usata come offset differenziale per il successivo mapping della posizione.</span><span class="sxs-lookup"><span data-stu-id="fb574-143">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="fb574-144">Quando il flusso avvia il rendering, è possibile modificare il mapping della nuova posizione del dispositivo alla posizione del dispositivo memorizzata nella cache.</span><span class="sxs-lookup"><span data-stu-id="fb574-144">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="fb574-145">I passaggi seguenti riepilogano il processo di transizione di un flusso facile.</span><span class="sxs-lookup"><span data-stu-id="fb574-145">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="fb574-146">Memorizzare nella cache l'ultima posizione del dispositivo del flusso nel dispositivo precedente.</span><span class="sxs-lookup"><span data-stu-id="fb574-146">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="fb574-147">Arrestare il flusso nel dispositivo precedente.</span><span class="sxs-lookup"><span data-stu-id="fb574-147">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="fb574-148">Eseguire calcoli di nuovo mapping per ottenere la nuova posizione.</span><span class="sxs-lookup"><span data-stu-id="fb574-148">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="fb574-149">Avviare il rendering del flusso nel nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="fb574-149">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="fb574-150">Rilasciare il flusso precedente.</span><span class="sxs-lookup"><span data-stu-id="fb574-150">Release the old stream.</span></span>

<span data-ttu-id="fb574-151">Durante la transizione, l'applicazione deve garantire che l'orologio non eserciti la sincronizzazione, determinando flussi audio e video non sincronizzati.</span><span class="sxs-lookup"><span data-stu-id="fb574-151">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="fb574-152">Ciò può verificarsi se il rendering degli esempi video continua mentre il flusso audio viene instradato al nuovo dispositivo.</span><span class="sxs-lookup"><span data-stu-id="fb574-152">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="fb574-153">L'applicazione deve memorizzare nella cache la posizione dell'orologio per il calcolo del nuovo mapping e assicurarsi che il rendering degli esempi video non sia eseguito fino alla riapertura del flusso audio nel nuovo dispositivo, in modo che quando il clip riprende il rendering, i flussi audio e video siano sincronizzati.</span><span class="sxs-lookup"><span data-stu-id="fb574-153">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="fb574-154">In alcuni casi, in cui il tempo di presentazione per il rendering dei fotogrammi video è basato sull'orologio audio, è sufficiente arrestare il flusso audio fino al completamento del passaggio del flusso e non sono necessarie altre implementazioni del mapping della posizione per il flusso video per la sincronizzazione video audio.</span><span class="sxs-lookup"><span data-stu-id="fb574-154">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="fb574-155">Se durante il rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) restituisce un errore perché il dispositivo precedente viene perso, l'applicazione non deve arrestare il flusso precedente perché l'operazione di streaming è già terminata.</span><span class="sxs-lookup"><span data-stu-id="fb574-155">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="fb574-156">Per informazioni sulla gestione di questo errore, vedere [Ripristino da un](recovering-from-an-invalid-device-error.md)errore Invalid-Device errore .</span><span class="sxs-lookup"><span data-stu-id="fb574-156">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="fb574-157">Argomenti correlati</span><span class="sxs-lookup"><span data-stu-id="fb574-157">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="fb574-158">Informazioni sull'API MMDevice</span><span class="sxs-lookup"><span data-stu-id="fb574-158">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="fb574-159">Informazioni su WASAPI</span><span class="sxs-lookup"><span data-stu-id="fb574-159">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="fb574-160">Routing di flusso</span><span class="sxs-lookup"><span data-stu-id="fb574-160">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



